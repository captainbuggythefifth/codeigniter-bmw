<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	
	<title>nanoRep Widget</title>
	
	<!-- includes -->
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
// nanoRep Base Object

//////////////////////////////////////////////////////////////////////////
// initializing namespace
function initializeNS(_namespace)
{
    var _split = _namespace.split(".");
    var obj, parent = window;
    for (var i = 0; i < _split.length; ++i)
    {
        obj = parent[_split[i]];
        if (typeof (obj) === 'undefined' || !obj) parent[_split[i]] = obj = {};
        parent = obj;
    }
    return obj;
}
function isNSexists(_namespace)
{
    var _split = _namespace.split(".");
    var obj = window;
    for (var i = 0; i < _split.length; ++i)
    {
        obj = obj[_split[i]];
        if (typeof (obj) === 'undefined' || !obj) return false;
    }
    return true;
}
ISQ = initializeNS('ISQ');
nanoRep = ISQ;
ISQ.version = "3.14.1.3";

//////////////////////////////////////////////////////////////////////////
// debug levels:
// 0 = disabled
// 1 = regular (for qa mode)
// 2 = + with extended alerts&debug info
// 3 = + with memory profiler
var debugLevel = 0;


// including ALLOY
if (!Alloy)
{
    'use strict';

var Alloy = (function alloy_wrapper()
{
    // creating ALLOY namespace
    var Alloy =
    {
        runningMode: 0 // production: 0, qa:1, dev:2, debug:3
        , version: "0.41"
    };
    var $internals = {}; // alloy internal namespaces
    var exports = []; // compiler export

    // injecting plugin
    Alloy.inject = function(func, context)
    {
        func.apply(context || window, [$internals]);
    }
    exports['Alloy.inject'] = Alloy.inject;
    
    //////////////////////////////////////////////////////////////////////////
// checks if part of the string equals another string
String.prototype.equals = function (string, startingIndex, ignoreCase)
{
    if (!startingIndex) startingIndex = 0;
    if (startingIndex + string.length > this.length) return false;

    var ndx = 0;
    var max = startingIndex + string.length;
    for (var i = startingIndex; i < max; ++i, ++ndx)
    {
        var c1 = this.charCodeAt(i);
        var c2 = string.charCodeAt(ndx);
        if (c1 == c2) continue;
        if (!ignoreCase) return false;
        // lower case
        if (c1 > 90) c1 -= 32; // (90 is capital Z, 32 is the diff between upper and lower case)
        if (c2 > 90) c2 -= 32; // (90 is capital Z, 32 is the diff between upper and lower case)
        if (c1 != c2) return false;
    }
    return true;
}
String.prototype.startsWith = function (sub)
{
    if (this.length < sub.length) return false;
    for (var i = 0; i < sub.length; ++i)
    {
        if (this.charAt(i) !== sub.charAt(i)) return false;
    }
    return true;
};
String.prototype.endsWith = function (sub)
{
    if (this.length < sub.length) return false;
    var subNdx = sub.length - 1;
    for (var i = this.length - 1; i > this.length - 1 - sub.length; --i)
    {
        if (sub.charAt(subNdx--) !== this.charAt(i)) return false;
    }
    return true;
};
String.prototype.contains = function (txt)
{
	return this.indexOf(txt) !== -1;
};
String.prototype.contains_ci = function(txt)
{
	if (txt.length > this.length) return false;

    var max = this.length - txt.length + 1;
    for(var i=0;i<max;++i)
    {
		var j;
		for(j=0;j<txt.length;++j, ++i)
		{
			var c1 = this.charCodeAt(i);
			var t1 = txt.charCodeAt(j);
			if (c1 === t1) continue;

			// to lower case
			if (c1 > 96 && c1 < 123)
				c1 -= 32;
			// to lower case
			if (t1 > 96 && t1 < 123)
				t1 -= 32;

			// not equals, breaking loop
			if (c1 !== t1) break;
		}
		if (j === txt.length) return true;
    }

    return false;
}
String.prototype.Trim = function (sub)
{
    if (sub)
    {
        var startAt = this.startsWith_repeat(sub);
        if (startAt < this.length)
        {
            var endAt = this.endsWith_repeat(sub);

            if (startAt != 0 || endAt != this.length - 1)
                return this.substring(startAt, endAt + 1);
            else
                return this.toString();
        }
        else return "";
    }
    else
    {
        // removing from start
        var index = 0;
        var endIndex = this.length;
        for (; /\s/.test(this.charAt(index)) && index < endIndex; ++index) { };

        // empty string
        if (index == endIndex) return "";

        // removing from end
        for (; /\s/.test(this.charAt(endIndex - 1)) ; --endIndex) { };

        if (index == 0 && endIndex == this.length) return this + ""; // new string
        return this.substring(index, endIndex);
    }
};
String.prototype.startsWith_repeat = function (sub)
{
    if (this.length < sub.length) return 0;
    var x = 0;
    var i = 0;
    for (; i < this.length; i++)
    {
        if (this.charAt(i) != sub.charAt(x))
        {
            i -= x;
            break;
        }
        if (x == sub.length - 1)
            x = 0;
        else
            x++;
    }
    return i;
}

String.prototype.endsWith_repeat = function (sub)
{
    if (this.length < sub.length) return this.length;
    var x = sub.length - 1;
    var i = this.length - 1;

    for (; i > 0; i--)
    {
        if (this.charAt(i) != sub.charAt(x))
        {
            i += x;
            break;
        }
        if (x == 0)
            x = sub.length - 1;
        else
            x--;
    }
    return i;
}


//////////////////////////////////////////////////////////////////////////
// Array
/*
if (!Array.prototype.indexOf)
{
    Array.prototype.indexOf = function(what, fromIndex)
    {
        if (this === null) return -1; // this is null
        var l = this.length;
        if (!l) return -1; // empty array
        fromIndex = (+fromIndex | 0) || 0; // fromIndex may be a string

        // going over all items
        while (l-- !== fromIndex)
            if (this[l] === what) return l;
        return -1;
    }
}

if (!Array.prototype.contains)
{
    Array.prototype.contains = function(what)
    {
        return this.indexOf(what) !== -1;
    }
}
*/
;
    ///////////////////////////////////////////////////////////////////////////////////////////////////
Alloy.Base = function Class(){};
// method responsible of executing each base's constructor
Alloy.Base.polymorphismCtor = function (scope, args)
{
     // recursively invoking all base's ctors
     if (this.mBase !== null && typeof(this.mBase.prototype.polymorphismCtor) === 'function')
     {
          this.initBase.apply(this, args);
          this.mBase.prototype.polymorphismCtor(scope, args);
     }

    // invoking my constructor
	if (this.ctor !== this.mBase.prototype.ctor)
 		this.ctor.apply(scope, args);
};
// extending method
Alloy.Base.extend = function (obj)
{
    // derived c'tor - calling base c'tor and then calling its c'tor
    var derived = function ()
    {
        // enforcing abstraction
        if (typeof (obj) === 'object' && obj.abstractClass && this instanceof derived) throw ("Trying to create an instance of an abstract class");

        // making sure derived has implemented all base's abstract methods
        if (this.mBase !== null && typeof (this.mBase.abstractClass) === 'object')
        {
            for (var m in this.mBase.abstractClass)
            {
                //if (this.mBase.abstractClass[m] === null || typeof(this.mBase.abstractClass[m]) === 'undefined') continue;
                if (typeof (this[m]) !== 'function') throw ("un-implemented abstract method: " + m);
            }
        }

        this.polymorphismCtor(this, arguments);

        // updating creation array (class name)
        if (Alloy.runningMode > 2) profiler.registerObjectCreation(this);
    }

    // copying static
    for (var n in obj)
    {
        switch (n)
        {
            case "name":
            case "prototype":
            case "abstractClass":
                continue;
        }
        derived[n] = obj[n];
    }

    //	copying prototype
    for (var n in this.prototype)
    {
        derived.prototype[n] = this.prototype[n];
    }

    // copying 'prototype' from object
    if (obj._prototype) for (var n in obj._prototype)
    {
        derived.prototype[n] = obj._prototype[n];
    }

    // creating abstract object
    // which holds all abstract methods
    // copying base's abstract methods
    if (typeof (obj) === 'object' && obj.abstractClass) derived.abstractClass = {};

    // copying polymorphism ctor
    derived.prototype.polymorphismCtor = Alloy.Base.polymorphismCtor;
    // copying extend ability
    derived.extend = this.extend;
    // setting base
    derived.prototype.mBase = this;

    // setting derived class name
    if (typeof (obj) !== 'object' || typeof (obj.name) !== 'string') throw ("Class name is missing (ctorObject.name)");
    var className = obj.name.replace(/^\s+|\s+$/g, "")
    if (!className) throw ("Invalid class name");
    derived.prototype.__className__ = derived.__className__ = className;

    return derived;
};
Alloy.Base.__className__ = "Base Class";
Alloy.Base.prototype.__className__ = "Base Class";
// object's base
Alloy.Base.prototype.mBase = null;
// is disposed
Alloy.Base.prototype.mIsDisposed = false;
// object's ctor
Alloy.Base.prototype.ctor = function(){};
// object's dtor
Alloy.Base.prototype.dtor = function ()
{
     delete this.mBase;
};
Alloy.Base.prototype.initBase = function ()
{
};
Alloy.Base.prototype.isDisposed = function ()
{
     return this.mIsDisposed;
};
Alloy.Base.prototype.executeBaseMethod = function (methodName, args)
{
     if (!this.mBase) throw ("Alloy.Base.prototype.executeBaseMethod: no base!");
     this.mBase.prototype[methodName].apply(this, args || []);
};
Alloy.Base.prototype.dispose = function ()
{
     if (this.mIsDisposed) return false;

     // updating flag
     this.mIsDisposed = true;

     // running dtor
     var result = this.dtor.apply(this, arguments);
     // if dispose was canceled
     if (result === false)
     {
          this.mIsDisposed = false;
          return false;
     }


     // updating profiler
     if (Alloy.runningMode > 2) profiler.registerObjectDisposal(this);

     // running dtor in base
     var current = this.mBase;
     while (current !== null)
     {
          current.prototype.dtor.apply(this, arguments);
          current = current.prototype.mBase;
     }

     // running an overall dispose which deletes everything
     // in the object
     this.__dispose__();

     return true;
};
 Alloy.Base.prototype.__dispose__ = function ()
 {
     for (var i in this)
     {
         try
         {
             switch (i)
             {
                 case "mBase":
                 case "__dispose__":
                 case "polymorphismCtor":
                 case "extend":
                 case "__className__":
                     continue;
                     break;
             }
             if (typeof (this[i]) === 'undefined' || this[i] === null) continue;
             if (typeof (this[i]) !== 'function' && typeof (this[i]) !== 'object') continue;
             if (typeof (this[i].dispose) === 'function') this[i].dispose();

             if (this[i] instanceof Array)
             {
                 for (var j in this[i])
                 {
                     if (this[i][j] && typeof (this[i][j].dispose) === 'function') this[i][j].dispose();
                 }
             }
             delete this[i];
         }
         catch (e)
         {
             if (Alloy.runningMode > 1) alert("base::__dispose__: error disposing:" + i);
         }
     }
 };

// method that checks if an object's derived of a base
Alloy.Base.prototype.isDerivedOf = function (base, dontCountInstanceOfBase)
{
     dontCountInstanceOfBase = dontCountInstanceOfBase === true;

     if (dontCountInstanceOfBase && this.__className__ === base.__className__) return false;
     if (this.__className__ === base.__className__) return true;

     var result = false;
     var current = this.mBase;
     while (current !== null && !result)
     {
          if (base.__className__ === current.__className__) result = true;

          current = current.prototype.mBase;
     }

     return result;
};
Alloy.Base.isDerivedOf = function (_object, base)
{
     if (_object === null) return false;
     if (typeof(_object) !== 'object' || typeof(_object.isDerivedOf) !== 'function') return false;
     return _object.isDerivedOf(base);
};
;
    /**************************************
Event CLASS
**************************************/
Alloy.Event = Alloy.Base.extend({ name: "Event" });
Alloy.Event.prototype.ctor = function ()
{
    this.mCount = 0;
}
Alloy.Event.prototype.dtor = function ()
{
    /// deleting handlers ///
    if (this.handlers !== null)
    {
        var l = this.handlers.length;
        for (var i = 0; i < l; ++i)
        {
            if (this.handlers[i] !== null) this.handlers[i].dispose();
        }
        delete this.handlers;
    }
    this.handlers = null;
}

///////// VARIABLES
Alloy.Event.prototype.handlers = null;
Alloy.Event.prototype.mCount = 0;
Alloy.Event.prototype.mRemovedHandler = false;

///////// METHODS
Alloy.Event.prototype.dispatch = function ()
{
    if (this.isDisposed()) return;
    if (this.handlers === null) return;

    //// applying all handlers ////
    var l = this.handlers.length;
    for (var i = 0; i < l; ++i)
    {
        // there's a chance that this object (event) is disposed
        // by one of the handlers
        if (this.isDisposed()) return;

        // invoking handler
        var handler = this.handlers[i];
        try
        {
            if (!handler) continue; // handler was removed
            if (handler.isDisposed()) // handler was disposed but not removed
            {
                this.mRemovedHandler = true;
                this.handlers[i] = null;
            }
            else // handler is valid, executing
                handler.handle.apply(handler, arguments);
        }
        catch (e)
        {
            if (Alloy.runningMode) throw (e);
        }
    }

    // there's a chance that this object (event) is disposed
    // by one of its handlers
    if (this.isDisposed()) return;

    //// cleaning 'disposed' handlers ////
    if (this.mRemovedHandler) this.cleanDisposedHandlers();
}

Alloy.Event.prototype.cleanDisposedHandlers = function ()
{
    if (!this.mRemovedHandler) return;
    var l = this.handlers.length;
    for (var i = 0; i < l; ++i)
    {
        if (this.handlers[i] === null)
        {
            this.handlers.splice(i, 1);
            --i;
            --l;
        }
    }
    this.mRemovedHandler = false; // setting flag
}
Alloy.Event.prototype.clear = function ()
{
    if (!this.handlers) return;
    var l = this.handlers.length;
    for (var i = 0; i < l; ++i) // disposing all handlers
        this.handlers[i].dispose();
    this.handlers = null;
}
Alloy.Event.prototype.addHandlerObject = function (handlerObj)
{
    if (this.isDisposed()) return;
    if (this.handlers === null) this.handlers = new Array();

    /// verifying the handler doesn't exist already
    var l = this.handlers.length;
    for (var i = 0; i < l; ++i)
    {
        var handle = this.handlers[i];
        if (handle !== null && handle.func === handlerObj.func && handle.context === handlerObj.context) return;
    }

    // adding the handler
    this.handlers.push(handlerObj);
    ++this.mCount;

    // cleaning disposed handlers
    this.cleanDisposedHandlers();

    return handlerObj;
}

Alloy.Event.prototype.addHandler = function (func, context)
{
    if (this.isDisposed()) return;
    if (this.handlers === null) this.handlers = new Array();

    /// verifying the handler doesn't exist already
    var l = this.handlers.length;
    for (var i = 0; i < l; ++i)
    {
        var handle = this.handlers[i];
        if (handle !== null && handle.func === func && handle.context === context) return;
    }

    // adding the handler
    var handler = new Alloy.Handler(func, context);
    this.handlers.push(handler);
    ++this.mCount;
    func = null;
    context = null;

    // cleaning disposed handlers
    this.cleanDisposedHandlers();

    return handler;
}

Alloy.Event.prototype.removeHandlerObject = function (handler)
{
    if (this.handlers === null) return;
    var l = this.handlers.length;
    var handleObject = null;
    var i;
    for (i = 0; i < l; ++i)
    {
        if (this.handlers[i] === handler)
        {
            --this.mCount;
            this.handlers[i] = null;
            break;
        }
    }
    this.mRemovedHandler = true; // raising flag
    handler.dispose();
}

Alloy.Event.prototype.removeHandler = function (func, context)
{
    if (this.handlers === null) return;

    context = context || null;
    var l = this.handlers.length;
    var handleObject = null;
    var i;
    for (i = 0; (i < l && handleObject === null) ; ++i)
    {
        if (this.handlers[i] !== null && this.handlers[i].func === func && this.handlers[i].context === context)
        {
            handleObject = this.handlers[i];
            this.handlers[i] = null;
            --this.mCount;
            break;
        }
    }
    this.mRemovedHandler = true;  // raising flag
    if (handleObject !== null) handleObject.dispose();

    func = null;
    context = null;
}

//remove all handerls
Alloy.Event.prototype.removeAllHandlers = function ()
{
    //if now handlers exit
    if (this.handlers === null) return;

    //set handlers object to null; (removes all handlers);
    this.handlers = null;
}

Alloy.Event.prototype.count = function ()
{
    return this.mCount;
}

///////////////////////////////////////
/**************************************
Handler Class
**************************************/
///////////////////////////////////////
Alloy.Handler = Alloy.Base.extend({ name: "Alloy.Handler" });
Alloy.Handler.toHandler = function (func)
{
    if (Alloy.Base.isDerivedOf(func, Alloy.Handler)) return func;
    return new Alloy.Handler(func);
}
Alloy.Handler.prototype.ctor = function (func, context)
{
    func = func || null;
    context = context || null;

    if (typeof (func) !== 'function')
    {
        //if (Alloy.runningMode > 1) debugger;
        throw ('Error creating event handler: no function is passed');
    }

    this.func = func;
    this.context = context;

    return this;
}
Alloy.Handler.prototype.dtor = function ()
{
    delete this.func;
    delete this.context;
    this.func = null;
    this.context = null;
}
Alloy.Handler.prototype.handle = function ()
{
    //if (!this.func && Alloy.runningMode) debugger;
    return this.func.apply(this.context, arguments);
}
Alloy.Handler.prototype.handleArgumentArray = function ()
{
    if (arguments.length === 0) throw ("invalid use of Alloy.Handler.handleArgumentArray");
    if (typeof (arguments[0].length) !== 'number') throw ("invalid array in Alloy.Handler.handleArgumentArray");
    return this.func.apply(this.context, arguments[0] instanceof Array ? arguments[0] : [arguments[0]]);
}
Alloy.Handler.prototype.func = null;
Alloy.Handler.prototype.context = null;

/**************************************
Timer Class
**************************************/
Alloy.Timer = Alloy.Base.extend({ name: "Alloy.Timer" });
Alloy.Timer.prototype.ctor = function (handler, disposeAfterElapsed)
{
    if (!Alloy.Base.isDerivedOf(handler, Alloy.Handler)) throw ("Alloy.Timer.ctor: invalid handler");
    this.mHandler = handler;

    // to dispose after timer elapsed
    this.mDisposeAfterTimerElapsed = disposeAfterElapsed !== false;

    this.mParams = new Array();
    if (arguments.length <= 2) return;

    for (var i = 2; i < arguments.length; ++i)
        this.mParams.push(arguments[i]);
}
Alloy.Timer.prototype.dtor = function ()
{
    this.start = null;
    if (this.mTimer)
    {
        clearTimeout(this.mTimer);
        this.mTimer = null;
    }
}
Alloy.Timer.prototype.start = function (interval)
{
    if (typeof (interval) !== 'number') throw ("Timer interval illegal");

    // saving params
    if (arguments.length > 1)
    {
        this.mParams = new Array();
        for (var i = 1; i < arguments.length; ++i)
            this.mParams.push(arguments[i]);
    }

    // running timeout
    var thisObject = this;
    this.mTimer = setTimeout(function ()
    {
        if (thisObject.mTimer === null) return;
        thisObject.timerElapsed.apply(thisObject, new Array());
    }, interval);
}
Alloy.Timer.prototype.timerElapsed = function ()
{
    this.mHandler.handleArgumentArray(this.mParams);
    if (this.mDisposeAfterTimerElapsed) this.dispose(); // disposing
}
Alloy.Timer.prototype.cancel = function ()
{
    if (this.mTimer === null) return;
    clearTimeout(this.mTimer);
    this.mTimer = null;
}

Alloy.Timer.prototype.isRunning = function ()
{
    return this.mTimer !== null;
}

Alloy.Timer.prototype.mDisposeAfterTimerElapsed = true;
Alloy.Timer.prototype.mTimer = null;
Alloy.Timer.prototype.mHandler = null;
Alloy.Timer.prototype.mParams = null;
;
    $internals.Utils =
{
    clone: function Alloy_clone(obj, deep)
    {
        var target;
        if (obj === null) return null;
        if (obj instanceof Array) // array
        {
            target = new Array(obj.length);
            var l = obj.length;
            while (l--)
            {
                if (deep)
                    target[l] = Alloy.clone(obj[l], true);
                else
                    target[l] = obj[l];
            }
            return target;
        }
        else if (typeof (obj) == 'object') // object
        {
            target = {};
            for (var i in obj)
            {
                if (deep)
                    target[i] = Alloy.clone(obj[i], true);
                else
                    target[i] = obj[i];
            }
            return target;
        }
        else // simple type
            return obj;
    }
    , compare: function Alloy_compare(obj1, obj2)
    {
        if (typeof (obj1) != typeof (obj2)) return false;

        if (obj1 instanceof Array) // array
        {
            if (!(obj2 instanceof Array)) return false;

            var l = obj1.length;
            if (obj2.length != l) return false;

            while (l--)
                if (!this.compare(obj1[l], obj2[l])) return false;
            return true;
        }
        else if (typeof (obj1) == 'object') // object
        {
            for (var l in obj1)
                if (!this.compare(obj1[l], obj2[l])) return false;
            return true;
        }
        else // simple type
            return obj1 == obj2;
    }
    , compareArrays: function (arr1, arr2)
    {
        if (!arr1)
        {
            if (!arr2) return true;
            return false;
        }
        if (!arr2) return false;

        var l = arr1.length;
        if (l !== arr2.length) return false;

        while (l--)
            if (arr1[l] !== arr2[l]) return false;

        return true;
    }
    , inArray: function Alloy_inArray(arr, val, length)
    {
        var l = length || arr.length;
        while (l--)
        {
            if (arr[l] === val) return true;
        }
        return false;
    }
    , insertUniqueToArray: function Alloy_insertUniqueToArray(arr, val)
    {
        var l = arr.length
        while (l--)
        {
            if (arr[l] === val) return;
        }
        arr.push(val);
    }
    , priorToIE9: (function Alloy_priorToIE9()
    {
        var _index;
        if ((_index = navigator.appVersion.indexOf("MSIE ")) !== -1)
        {
            _index += 5;
            var c = navigator.appVersion.charAt(_index);
            return c == '8' || c == '7' || c == '6';
        }
        return false;
    })()
    , priorToIE11: (function priorToIE11()
    {
        var _index;
        return navigator.appVersion.indexOf("MSIE ") !== -1;
    })()
    , removeElement: function Alloy_removeElement(element)
    {
        element.parentNode.removeChild(element);
    }
    , replaceDomElement: function replaceDomElement(target, source)
    {
        var p = source.parentNode;
        if (!p) return target;
        //p.insertBefore(target, source);
        //p.removeChild(source);
        p.replaceChild(target, source);

        return target;
    }
    , copyAttributes: function alloy_copyAttributes(source, target, override)
    {
        var attrLen = source.attributes.length;
        if (source.attributes) while (attrLen--)
            {
            var attrib = source.attributes[attrLen];
            if (!override && target.getAttribute(attrib.name)) continue;
            target.setAttribute(attrib.name, attrib.value);
        }
    }
    , eval: function alloy_eval(str)
    {
        try
        {
            return eval(str);
        }
        catch (e)
        {
            return null;
        }

    }

    , compileCSS: function Alloy_compileCSS(styleContent)
    {
        var styleNode = document.createElement('style');
        styleNode.type = "text/css";
        document.getElementsByTagName('head')[0].appendChild(styleNode);

        if ($internals.Utils.priorToIE11 && styleNode.styleSheet)
        {
            styleNode.styleSheet.cssText = styleContent;
        }
        else
        {
            var styleTextNode = document.createTextNode(styleContent);
            styleNode.appendChild(styleTextNode);
        }
        return styleNode;
    }

    , isNSexists: function (_namespace)
    {
        var _split = _namespace.split(".");
        var obj = window;
        for (var i = 0; i < _split.length; ++i)
        {
            obj = obj[_split[i]];
            if (typeof (obj) === 'undefined' || !obj) return false;
        }
        return true;
    }
};

// public interface
Alloy.contains = $internals.Utils.inArray;
Alloy.insertUnique = $internals.Utils.insertUniqueToArray;
Alloy.clone = $internals.Utils.clone;
Alloy.compare = $internals.Utils.compare;;
    exports['Alloy.$di'] = Alloy.$di = (function Alloy_DI()
{
    var ALREADY_DOWNLOADED = {};
    var cache = {};
    var downloadFile = function Alloy_di_downloadFile(path, handler)
    {
        Alloy.ajax({
            url: path
            , method: "GET"
            , timeout: 5000
            , handler: function (status, text)
            {
                handler(status, text, path);
            }
        });
    }

    var refactorScriptToTemplate = window.myReplace = function(text)
    {
        var lastPos = 0;
        var ndx = text.indexOf("<script ", lastPos); // searching for <script
        if (ndx == -1) return text;
        var newText = new Array(5); // minimum size

        while (ndx != -1)
        {
            // inserting diff
            newText.push(text.substring(lastPos, ndx));

            // end of <script >
            var endNdx = text.indexOf(">", ndx);
            if (endNdx === -1) return text; // invalid text

            // searching for alloy-tag
            var tagNdx = text.indexOf(" alloy-tag=", ndx);

            // alloy-tag is inside <script> tag
            if (tagNdx > ndx && tagNdx < endNdx)
            {
                newText.push("<div ie-hack='1' ");
                lastPos = ndx + "<script ".length;

                // searching for the correct <\/script>
                var scriptEndNdx = endNdx;
                var scriptStNdx = endNdx;
                do
                {
                    // searching for the next <script> CLOSING TAG
					var tmpNdx;
					do
					{
						tmpNdx = text.indexOf("/script>", scriptEndNdx);
						if (tmpNdx === -1) return text; // invalid text
						// if that's a closing script, breaking
						if (text.charAt(--tmpNdx) == '<')  break;
						else scriptEndNdx = tmpNdx + 5;
						
					} while (true);
					
					// checking to see wether another <script> tag is between the found closing tag and the one above
                    var inlineScriptNdx = text.indexOf("<script", scriptStNdx);
                    if (inlineScriptNdx !== -1 && inlineScriptNdx < tmpNdx)
                    {
                        scriptStNdx = inlineScriptNdx += 4;
                        scriptEndNdx = tmpNdx + 10; // "<\/script>".length
                    }
                    else
                    {
                        // inserting diff
                        newText.push(text.substring(lastPos, tmpNdx));
                        newText.push("<\/div>");
                        lastPos = tmpNdx + 10; // "<\/script>".length
                        break;
                    }
                } while (true);
            }
            ndx = text.indexOf("<script ", lastPos);
        }

        // adding the end
        newText.push(text.substring(lastPos));


        return newText.join('');
    }

    var compileHTML = function compileHTML(templateName, text)
    {
        if (!text) return "File is empty";

        // IE8, refactoring code (replacing <script alloy-tag=> with <alloy-template alloy-tag=>).
        if ($internals.Utils.priorToIE9) text = refactorScriptToTemplate(text);

        // creating DIV to process text
        var div = document.createElement("div");
        div.innerHTML = text;

        try
        {
            // going over all div childNodes to try and find
            // template nodes
            var processed = false;
            var error = null;
            for (var i = 0; i < div.childNodes.length; ++i)
            {
                var cn = div.childNodes[i];
                if (cn.nodeName === "ALLOY-TEMPLATE") // given template
                {
                    processed = true;
                    var x = cn.getAttribute("alloy-tag");
                    if (!x) continue;
                    $internals.Templates.set(x, cn.innerHTML);
                }
                // script tag
                else if (cn.nodeName === "SCRIPT")
                {
                    processed = true;
                    var x = cn.getAttribute("type");
                    if (x === "text/alloy") // alloy template
                    {
                        x = cn.getAttribute("alloy-tag");
                        if (!x) continue;
                        $internals.Templates.set(x, cn.innerHTML);
                    }
                    else
                    {
                        error = compileScript(cn.innerHTML);
                    }
                }
				// div (template) in IE8
				else if ($internals.Utils.priorToIE9 && cn.nodeName === "DIV" && cn.getAttribute("ie-hack") === '1')
				{
					processed = true;
                    var x = cn.getAttribute("alloy-tag");
                    if (!x) continue;
                    $internals.Templates.set(x, cn.innerHTML);
				}
                else if (cn.nodeName === "STYLE")
                {
                    processed = true;
                    $internals.Utils.compileCSS(text);
                }
            }

            // didn't find any templates or scopes.
            // assuming file contains only 1 template
            if (templateName && !processed) $internals.Templates.set(templateName, text);

            return error;
        }
        catch (e) { return "Failed processing HTML file: " + e; }
    }
    var compileScript = function compileScript(script)
    {
        try
        {
            // first: trying to add as <script> tag (fastest)
            var scriptTag = document.createElement('script');
            scriptTag.type = 'text/javascript';
            scriptTag.charset = 'utf-8';
            scriptTag.id = 'testing';
            scriptTag.defer = true;
            scriptTag.async = true;
            scriptTag.text = script;
            document.getElementsByTagName('head')[0].appendChild(scriptTag);
            return null;
        }
        catch (e)
        {
            try
            {
                // trying to eval
                eval(script);
                return null;
            }
            catch(e)
            {
                try
                {
                    // try to (eval)
                    eval("("  + script + ")");
                    return null;
                }
                catch(e)
                {
                    return e;
                }
            }
        }
    }

    /// getting multiple files, and firing 1 handler when it's ready
    /* ["path","path","path","path","path", ...]
    */
    return function Alloy_$di(arr, handler)
    {
        // received array
        var resultArr = new Array(arr.length);
        var totalReceived = 0;
        var fileHandler = function (index, status, text, path)
        {
            // inserting file to array
            resultArr[index] = {status: status, text:text, path:path};

            // not all files received
            if (++totalReceived !== arr.length) return;

            // ALL files are here. processing
            for (var i = 0; i < arr.length; ++i)
            {
                var arrItem = resultArr[i];
                var path = arr[i];

                // file was already downloaded
                if (arrItem.text === ALREADY_DOWNLOADED)
                {
                    arrItem.status = true;
                }
                // request failed
                else if (arrItem.status !== Alloy.Com.SUCCESS)
                {
                    arrItem.status = false;
                    arrItem.error = "Request failed";
                }
                // scripts
                else if (path.endsWith(".js"))
                {
                    arrItem.error = compileScript(arrItem.text);
                    if (!arrItem.error) arrItem.status = true;
                    else arrItem.status = false;
                }
                // styles
                else if (path.endsWith(".css"))
                {
                    $internals.Utils.compileCSS(arrItem.text);
                    arrItem.status = true;
                }
                // templates and etc.
                else
                {
                    arrItem.error = compileHTML(arrItem.name, arrItem.text);
                    if (!arrItem.error) arrItem.status = true;
                    else arrItem.status = false;
                }

                // removing text
                arrItem.text = null; 
                // pointing out file was downloaded
                if (arrItem.status) cache[arrItem.path] = ALREADY_DOWNLOADED;
            }

            handler(resultArr);
        };


        // processed files
        var generatedHandler;
        for (var i = 0; i < arr.length; ++i)
        {
            generatedHandler = (function (i) { return function (status, text, path) { fileHandler(i, status, text, path) } })(i);

            // IF file was already downloaded
            var cacheValue = cache[arr[i]];
            if (cacheValue)
                generatedHandler(Alloy.Com.SUCCESS, cacheValue);
            // need to download file
            else
                downloadFile(arr[i], generatedHandler);
        }
    };
})();;
    $internals.Templates = (function Alloy_initTemplates()
{
    var handleTemplate = function handleTemplate(name, html)
    {
        // trimming
        var pos = 0;
        while (pos < html.length)
        {
            var c = html.charCodeAt(pos);
            if (c == 9 || c == 32 || c == 10 || c == 13)
            {
                ++pos;
                continue;
            }
            break;
        }
        var endPos = html.length;
        while (endPos > pos)
        {
            var c = html.charCodeAt(endPos - 1);
            if (c == 9 || c == 32 || c == 10 || c == 13)
            {
                --endPos;
                continue;
            }
            break;
        }

        // creating document fragment
        var div = document.createElement("div");
        div.innerHTML = html.substring(pos, endPos);
        var fragment = document.createDocumentFragment();
        var l = div.childNodes.length;
        for (var j = 0; j < l; ++j) fragment.appendChild(div.firstChild);

        // if we need to add custom tags
        if (recursiveFunc)
        {
            document.createElement(name);
            document.createElement(name.toUpperCase());
            document.createElement(name.toLowerCase());
            recursiveFunc(fragment);
        }

        // adding to dictionary
        templates[name.toUpperCase()] = fragment;
    }


    var recursiveFunc = null;
    if ($internals.Utils.priorToIE9)
    {
        recursiveFunc = function recursiveFunc_(dom)
        {
            if (dom.nodeName.charAt(0) == '#') return;

            // creating relevant dom elements
            document.createElement(dom.nodeName);
            document.createElement(dom.nodeName.toLowerCase());
            document.createElement(dom.nodeName.toUpperCase());
            if (dom.tagName)
            {
                document.createElement(dom.tagName);
                document.createElement(dom.tagName.toLowerCase());
                document.createElement(dom.tagName.toUpperCase());
            }

            // iterating children
            var l = dom.childNodes.length;
            while (l--) recursiveFunc_(dom.childNodes[l]);
        }

        // special
        //document.createElement("ALLOY-EMBEDDED-DATA"); 
        document.createElement("alloy-embedded-data");
        document.createElement("alloy-template");
        //document.createElement("ALLOY-TEMPLATE");
    }

    // alloy-embedded-data should appear on screen
    $internals.Utils.compileCSS("alloy-embedded-data {display:none}");
    $internals.Utils.compileCSS("ALLOY-EMBEDDED-DATA {display:none}");
    

    // building templates
    var templates = {};
    var scripts = document.getElementsByTagName('script');
    for (var i = 0 ; i < scripts.length; i++)
    {
        if (scripts[i].getAttribute("type") != 'text/alloy') continue;
        var tag = scripts[i].getAttribute("alloy-tag");

        handleTemplate(tag, scripts[i].innerHTML);
        $internals.Utils.removeElement(scripts[i--]); // removing from DOM
    }

    return {
        get: function getTemplate(domElement)
        {
            var templateName;
			// getting template name
			if (typeof(domElement) === 'string')
			{
				templateName = domElement.toUpperCase();
			}
			else
			{
				templateName = domElement.attributes ? domElement.getAttribute("alloy-template") : null;
				if (!templateName) templateName = domElement.tagName;
				if (!templateName) return null;
				templateName = templateName.toUpperCase();
			}

            // taking from templates
            return templates[templateName];
        }
        , set: function(tag, html)
        {
            handleTemplate(tag, html);
        }
        , exists: function(tag)
        {
            return templates[tag.toUpperCase()] !== undefined;
        }
    };

})();

// public interface
Alloy.injectTemplate = $internals.Templates.set;;
    var lastId = 0;
/////////////////////////////////////////////////////////////////////////////////
/// MODEL TRIE NODE
var ModelTrieNode = $internals.ModelTrieNode = function ModelTrieNode(word, parent, type)
{
    this.word = word;
    this.parent = parent;
    this.id = ++lastId;
    this.type = type || 0;
}
ModelTrieNode.prototype.toHtml = function(builder)
{
    if (!builder) builder = [];
    var value = typeof (this.modelValue) === 'object' ? 'object' : this.modelValue;
    builder.push("<span>" + this.word + "=" + value + " (" + this.id + ")" + "<span>");
    if (this.nodes) for(var i=0;i<this.nodes.length;++i)
    {
        builder.push("<div style='padding:5px 45px'>");
        this.nodes[i].toHtml(builder);
        builder.push("</div>");
    }
    return builder;
}
ModelTrieNode.prototype.tryCreateNode = function (word)
{
    // adding to trie
    var parsedValue = parseInt(word, 10);
    var key;
    if (isNaN(parsedValue)) key = word;
    else key = parsedValue;

    // searching in hash
    if (this.nodesHash)
    {
        var index = this.nodesHash[key];
        if (index || index === 0) return this.nodes[index];
    }
    else // creating arrays
    {
        this.nodesHash = {};
        this.nodes = [];
    }
    
    // creating new node
    var newNode = new ModelTrieNode(key, this, 0);
    this.nodesHash[key] = this.nodes.length;
    this.nodes.push(newNode);
    return newNode;
}
ModelTrieNode.prototype.createLoopIterationNode = function(id)
{
    var node = this.tryCreateNode(id);
    node.type = 2; // loop
    return node;
}
ModelTrieNode.prototype.createFixedValueNode = function(value)
{
    var key = "$$" + (this.nodes ? this.nodes.length : 0);
    if (!this.nodesHash)
    {
        this.nodesHash = {};
        this.nodes = [];
    }

    // creating new node
    var newNode = new ModelTrieNode(key, this, 1);
    newNode.modelValue = value;
    this.nodesHash[key] = this.nodes.length;
    this.nodes.push(newNode);
    return newNode;
}
ModelTrieNode.prototype.addDependency = function(domPointer, expression)
{
    if (!this.dependents) this.dependents = [];
    this.dependents.push({domPointer: domPointer, expression: expression});
}
ModelTrieNode.prototype.addDependentScope = function (scope)
{
    if (!this.dependentScopes) this.dependentScopes = [];
    this.dependentScopes.push(scope);
}
ModelTrieNode.prototype.addPriorNode = function(node)
{
    if (!this.priorUpdateNodes) this.priorUpdateNodes = [];
    this.priorUpdateNodes.push(node);
}
ModelTrieNode.prototype.id = -1; // node id (for debugging)
ModelTrieNode.prototype.type = 0; // 0: scope dependent, 1: fixed value, 2: loop content
ModelTrieNode.prototype.word = null; // node word (path)
ModelTrieNode.prototype.parent = null; // node's parent
ModelTrieNode.prototype.generation = 0; // update generation
ModelTrieNode.prototype.nodes = null; // child nodes array, to easily iterate
ModelTrieNode.prototype.nodesHash = null; // child nodes hash, to find if child exists o(1)
ModelTrieNode.prototype.dependents = null; // dependents array
ModelTrieNode.prototype.modelValue = null; // node value
ModelTrieNode.prototype.dependentScopes = null; // dependent scopes array
ModelTrieNode.prototype.pendingUpdateNodes = null; // nodes that waits for this node to finish
ModelTrieNode.prototype.priorUpdateNodes = null; // trienode that must be updated before current


/////////////////////////////////////////////////////////////////////////////////
/// ACTIVE LOOP
var ActiveLoop = $internals.ActiveLoop = function ActiveLoop(loopContent, trieNode, parent, index)
{
    this.loopContent = loopContent;
    this.trieNode = trieNode;
    this.parent = parent;
    this.index = index;
    if (!this.parent)
        this.depth = 1;
    else
        this.depth = this.parent.depth+ 1;
}
ActiveLoop.prototype.loopContent = null;
ActiveLoop.prototype.depth = -1;
ActiveLoop.prototype.index = -1;
ActiveLoop.prototype.trieNode = null;
ActiveLoop.prototype.parent = null;

/////////////////////////////////////////////////////////////////////////////////
/// DOM POINTER
var DomPointer = $internals.DomPointer = function DomPointer(element, attribute, contentInfo)
{
    this.element = element;
    this.attribute = attribute;
    this.contentInfo = contentInfo;
    this.id = ++lastId;

    //DEBUG
    //if (this.element.nodeName.charAt(0) !== '#') this.element.setAttribute("alloy-id", this.id);
}
DomPointer.prototype.addDependent = function(modelNode, expression)
{
    if (!this.dependents) this.dependents = [];
    this.dependents.push({ modelNode: modelNode, expression: expression });
}
DomPointer.prototype.element = null;
DomPointer.prototype.attribute = null;
DomPointer.prototype.contentInfo = null;
DomPointer.prototype.id = -1;
DomPointer.prototype.updateCycle = 0;
DomPointer.prototype.dependents = null;

/////////////////////////////////////////////////////////////////////////////////
// LOOP Content
var LoopContent = $internals.LoopContent = function LoopContent()
{
    this.id = ++lastId;
    this.collectionName = { start: -1, end: -1 };
};
LoopContent.prototype.filter = null;
LoopContent.prototype.id = null;
LoopContent.prototype.sorter = null;
LoopContent.prototype.elementName = null;
LoopContent.prototype.collectionName = null;
LoopContent.prototype.limit = null;
LoopContent.prototype.thisIndex = -1;
LoopContent.prototype.parentLoop = null;
LoopContent.prototype.iterator = null;
LoopContent.prototype.count = 0;

// Text Content
var TextContent = $internals.TextContent = function TextContent(value)
{
    this.value = value;
};
TextContent.prototype.value = null;

/////////////////////////////////////////////////////////////////////////////////
/// Expression
var Expression = $internals.Expression = function Expression(type, index) { if (type) { this.type = type; } if (index !== undefined) { this.index = index;} };
Expression.prototype.index = null;
Expression.prototype.type = null;
Expression.prototype.compiled = null;

/////////////////////////////////////////////////////////////////////////////////
/// This OBJECT
var This = $internals.This = function This(trieNode, parentIndex)
{
    this.trieNode = trieNode;
    this.parentIndex = parentIndex;
}
This.prototype.trieNode = null;
This.prototype.parentIndex = -1;

//////////////////////////////////////////////////////////////////////
///// Loop sorter
function Sorter(sortValue, dir)
{
    this.dir = dir;
    this.sortValue = sortValue;

    // creating merge sort
    this.mergeSort = new Alloy.MergeSort();

    // creating merge sort for string
    this.mergeSortString = new Alloy.MergeSort_String();
    // overriding method
    if (sortValue)
        this.mergeSortString.$comparer = function MergeSort_$comparer(a, b)
        {
            return Alloy.MergeSort_String.strCmp(a[sortValue], b[sortValue]);
        }
    else
        this.mergeSortString.$comparer = function MergeSort_$comparer(a, b)
        {
            return Alloy.MergeSort_String.strCmp(a, b);
        }
}
$internals.Sorter = Sorter;
// STATIC
Sorter.map = [];
Sorter.getSorter = function Sorter_getSorter(sortValue, dir)
{
    var key = sortValue + "_" + dir;
    var sorter = Sorter.map[key];
    if (!sorter) sorter = Sorter.map[key] = new Sorter(sortValue, dir);
    return sorter;
}
// INTERNAL
Sorter.prototype.sort = function Sorter_sort(collection)
{
    // no collection or nothing to sort
    if (!collection || collection.length < 2) return collection;

    // string merge
    if ((this.sortValue && typeof (collection[0][this.sortValue]) == 'string')
        || typeof (collection[0]) === 'string')
        this.mergeSortString.sort(collection, this.dir !== 'asc');
    else
        this.mergeSort.sort(collection, this.dir !== 'asc');

    return collection;
}
Sorter.prototype.sortValue = null;
Sorter.prototype.dir = null;
Sorter.prototype.mergeSort = null;
Sorter.prototype.mergeSortString = null;

;
    $internals.Parsers = {
    
    //////////////////////////////////////////////
    // MEMORY RE-USED OBJECTS
    __parseTextReusedObject: null
    ,__evalLoopFilterBuilder: null
    ,__getAlloyTextObjects: null
    , __getAlloyCompiledObjects: null
    , __refCount: 0
    ,initMemoryObjects: function ()
    {
        if (++this.__refCount !== 1) return;

        this.__parseTextReusedObject = { html: null, results: null, resultsLength: 0 };
        this.__getAlloyTextObjects = [];
        this.__getAlloyCompiledObjects = [];
    }

    , createCompiledObject: function()
    {
        return { value: null, textResultsCount: 0, textResults: [], compiled: null };
    }

    , createTextObject: function ()
    {
        return { value: null, modelNode: null, varName: null };
    }

    ,clearMemoryObjects: function()
    {
        if (--this.__refCount !== 0) return;

        this.__parseTextReusedObject = null;
        this.__evalLoopFilterBuilder = null;
        this.__getAlloyTextObjects = null;
        this.__getAlloyCompiledObjects = null;
    }

    //////////////////////////////////////////////
    // ARRAYS
    ,variableCharacters: (function ()
    {
        var arr = [];
        // A-Z
        for (var i = 65; i <= 90; ++i)
            arr[i] = 1;
        // a-z
        for (var i = 97; i <= 122; ++i)
            arr[i] = 1;
        // 0-9
        for (var i = 48; i <= 57; ++i)
            arr[i] = 1;

        // $
        arr[36] = 1;
        // _
        arr[95] = 1;

        return arr;
    })()

    ,tokenStartCharacters: (function ()
    {
        var arr = [];
        // A-Z
        for (var i = 65; i <= 90; ++i)
            arr[i] = 1;
        // a-z
        for (var i = 97; i <= 122; ++i)
            arr[i] = 1;
        // $ VALUE
        arr[36] = 1;

        return arr;
    })()

    ,variableCharacters_fullPath: (function ()
    {
        var arr = [];
        // A-Z
        for (var i = 65; i <= 90; ++i)
            arr[i] = 1;
        // a-z
        for (var i = 97; i <= 122; ++i)
            arr[i] = 1;
        // 0-9
        for (var i = 48; i <= 57; ++i)
            arr[i] = 1;
        // _
        arr[95] = 1;
        //.
        arr[46] = 1;
        // $
        arr[36] = 1;

        return arr;
    })()

    , safeWords: (function ()
    {
        var arr = [];
        arr['switch'] = 1;
        arr['in'] = 1;
        arr['for'] = 1;
        arr['return'] = 1;
        arr['window'] = 1;
        arr['true'] = 1;
        arr['false'] = 1;
        arr['eval'] = 1;
        arr['if'] = 1;
        arr['else'] = 1;

        return arr;
    })()

    //////////////////////////////////////////////
    // getting value between {{ }} according to scope
    // the function returns dependencyTrieNode OR [dependencyTrieNodes] 
    , getAlloyValue: function getAlloyValue(value, valueStart, valueEnd, scope, thisIndex, memoryObjectIndex)
    {
        memoryObjectIndex = memoryObjectIndex || 0;

        var result = this.getAlloyValue_text(memoryObjectIndex, value, valueStart, valueEnd, scope, thisIndex);
        if (result)
        {
            var compiledObject = this.getReturnedCompiledValue(memoryObjectIndex);
            compiledObject.value = result.value;
            compiledObject.compiled = null;
            compiledObject.textResultsCount = 1;

            // adding nodes
            if (0 === compiledObject.textResults.length)
                compiledObject.textResults.push(result);
            else
                compiledObject.textResults[0] = result;

            return compiledObject;
        }
        else
        {
            return this.getAlloyValue_compiled(memoryObjectIndex, value, valueStart, valueEnd, scope, thisIndex);
        }
    }
    , getReturnedTextValue: function(objectIndex)
    {
        // creating a new text object if needed
        if (this.__getAlloyTextObjects.length === objectIndex)
            this.__getAlloyTextObjects.push(this.createTextObject());
        return this.__getAlloyTextObjects[objectIndex];
    }
    , getReturnedCompiledValue: function (objectIndex)
    {
        // creating a new text object if needed
        if (this.__getAlloyCompiledObjects.length === objectIndex)
            this.__getAlloyCompiledObjects.push(this.createCompiledObject());
        return this.__getAlloyCompiledObjects[objectIndex];
    }
    , getAlloyValue_text: function getAlloyValue_text(memoryObjectIndex, value, valueStart, valueEnd, scope, thisIndex)
    {
        var pos = valueStart;
        
        // trimming
        for (; pos < valueEnd && value.charAt(pos) === ' '; ++pos) { }
        for (; valueEnd >= valueStart && value.charAt(valueEnd - 1) === ' '; --valueEnd) { }

        var prevPos = pos;
        var stack_this = scope.$stack.$this;
        thisIndex = thisIndex === undefined ? stack_this.length - 1 : thisIndex;
        var This;
        var firstSegment = true, inIterator=false;
        var stringEnd = valueEnd + 1;
        var unknownValue, c;
        var tmpIndex, tmpNode, tmpPos, activeLoop;
        
        
        var modelTrieNode = scope.$dependencies;
        var obj; //stack_this[thisIndex].trieNode.modelValue; // default is 'this'

        for (; pos !== stringEnd; ++pos)
        {
            // 
            if (pos !== valueEnd)
            {
                c = value.charCodeAt(pos);

                // illegal character
                if (!$internals.Parsers.variableCharacters_fullPath[c]) return false;
            }

            // reached '.' or end of value
            if (c === 46 || pos === valueEnd)
            {
                // first . we see, trying to fit known objects
                if (firstSegment)
                {
                    var loopCount = scope.$stack.$activeLoops.count;
                    firstSegment = false;
                    if(value === '$phase')
                    {
                        obj = scope.$phase;
                        modelTrieNode = scope.$dependencies.tryCreateNode("$phase");
                        modelTrieNode.modelValue = obj;
                    }
                    else if (value.equals("this", prevPos))
                    {
                        obj = stack_this[thisIndex].trieNode.modelValue;
                        modelTrieNode = stack_this[thisIndex].trieNode; // updating path
                        modelTrieNode.modelValue = obj;
                    }
                    else if (value.equals("embedded", prevPos))
                    {
                        modelTrieNode = modelTrieNode.tryCreateNode("$embedded"); // updating path
                        obj = scope.$embedded;
                        modelTrieNode.modelValue = obj;
                    }
                    else if (value.equals("model", prevPos))
                    {
                        modelTrieNode = modelTrieNode.tryCreateNode("$model"); // updating path
                        obj = scope.$model; // scope's model
                    }
                    else if (value.equals("scope", prevPos))
                    {
                        modelTrieNode = modelTrieNode.tryCreateNode("$model"); // updating path
                        obj = scope.$model; // scope's model
                    }
                    else if (value.equals("window", prevPos))
                    {
                        obj = window;
                        modelTrieNode = scope.$dependencies.createFixedValueNode(obj);
                    }
                    else if (value.equals("$parent", prevPos))
                    {
                        var parentIndex = thisIndex ? stack_this[thisIndex].parentIndex : 0;
                        modelTrieNode = stack_this[parentIndex].trieNode; // updating path
                        obj = modelTrieNode.modelValue;
                    }
                    else if (value.equals("$iterator", prevPos))
                    {
                        inIterator = true;
                        obj = undefined;
                        modelTrieNode = null;
                    }
                    else // unknown
                    {
                        unknownValue = value.substring(prevPos, pos);

                        // searching in active loop
                        if (loopCount !== 0)
                        {
                            do
                            {
                                activeLoop = scope.$stack.$activeLoops.array[loopCount];

                                // loop item
                                if (activeLoop.loopContent.elementName === unknownValue)
                                {
                                    modelTrieNode = activeLoop.trieNode;
                                    obj = modelTrieNode.modelValue;
                                    break;
                                }
                                // loop iterator name
                                else if (activeLoop.loopContent.iterator === unknownValue)
                                {
                                    obj = activeLoop.index;
                                    modelTrieNode = scope.$dependencies.createFixedValueNode(obj);
                                    break;
                                }

                                // going up
                                if (--loopCount === 0) break;

                            } while (true);
                        }

                        // searching in this
                        if (obj === undefined)
                        {
                            This = stack_this[thisIndex].trieNode; // taking self object
                            obj = This.modelValue[unknownValue]; // taking value from model
                            modelTrieNode = This.tryCreateNode(unknownValue); // updating path

                            // 
                            modelTrieNode.modelValue = obj;
                        }
                    }
                }
                else
                {
                    // in iterator parsing
                    if (inIterator)
                    {
                        activeLoop = scope.$stack.$activeLoops.array[loopCount];

                        // previous item
                        if (value.equals("back", prevPos))
                        {
                            // if NOT the first item in iteration
                            if (loopCount && activeLoop.index)
                            {
                                tmpNode = activeLoop.trieNode.parent;
                                tmpIndex = tmpNode.nodesHash[activeLoop.index - 1];
                                modelTrieNode = tmpNode.nodes[tmpIndex];
                                obj = modelTrieNode.modelValue;
                            }
                        }
                        // current index
                        else if (value.equals("index", prevPos))
                        {
                            if (loopCount)
                            {
                                obj = activeLoop.index;
                                modelTrieNode = scope.$dependencies.createFixedValueNode(obj);
                            }
                        }
                        // current
                        else if (value.equals("current", prevPos))
                        {
                            if (loopCount)
                            {
                                modelTrieNode = activeLoop.trieNode;
                                obj = modelTrieNode.modelValue;
                            }
                        }
                        // depth
                        else if (value.equals("depth", prevPos))
                        {
                            if (loopCount)
                            {
                                obj = loopCount;
                                modelTrieNode = scope.$dependencies.createFixedValueNode(obj);
                            }
                        }
                        // count
                        else if (value.equals("count", prevPos))
                        {
                            if (loopCount)
                            {
                                modelTrieNode = activeLoop.loopContent.countNode;
                                obj = modelTrieNode.modelValue;
                            }
                        }

                        // removing inIterator flag
                        inIterator = false;
                    }
                    // regular object
                    else
                    {
                        unknownValue = value.substring(prevPos, pos);
                        if (obj) obj = obj[unknownValue];
                        if (modelTrieNode)
                        {
                            // fixed value
                            if (modelTrieNode.type === 1)
                                modelTrieNode = modelTrieNode.createFixedValueNode(obj); // updating path
                            else // normal, loop
                            {
                                modelTrieNode = modelTrieNode.tryCreateNode(unknownValue); // updating path
                                modelTrieNode.modelValue = obj; // setting object value
                            }
                        }
                    }
                }

                // skipping '.'
                prevPos = pos + 1;
            }
        }


        // no trie node.. using $temp
        if (modelTrieNode === null)
            modelTrieNode = scope.$dependencies.createFixedValueNode(undefined);

        // setting params
        var returnObject = this.getReturnedTextValue(memoryObjectIndex);
        returnObject.value = obj;
        returnObject.modelNode = modelTrieNode;

        return returnObject;
    }

    , getAlloyValue_compiled: function getAlloyValue_compiled(memoryObjectIndex, value, valueStart, valueEnd, scope, thisIndex)
    {
        // checking if already processed
        var term = value.substring(valueStart, valueEnd);
        var compiledObject = scope.$compiledEval[term];
        if (!compiledObject)
        {
            compiledObject = {};
            var str = ["0, (function(vars){return "];
            compiledObject.vars = $internals.Parsers.parseExpression(term, str); // getting arguments
            str.push(";})");

            compiledObject.func = $internals.Utils.eval(str.join(''));
            scope.$compiledEval[term] = compiledObject;
        }
        
        // getting arguments
        var result;
        var varArgument = {};
        var vars = compiledObject.vars;
        var returnCompiledObject = this.getReturnedCompiledValue(memoryObjectIndex);
        returnCompiledObject.textResultsCount = 0;
        if (vars)
        {
            var l = vars.length;
            while (l--)
            {
                result = $internals.Parsers.getAlloyValue_text(memoryObjectIndex, vars[l], 0, vars[l].length, scope, thisIndex);
                if (!result) throw ('Alloy: unable to get value = ' + vars[l]);
                result.varName = vars[l]; // adding argument name
                
                // adding to vars
                varArgument[vars[l]] = result.value;

                // adding to result object
                if (returnCompiledObject.textResultsCount === returnCompiledObject.textResults.length)
                    returnCompiledObject.textResults.push($internals.Utils.clone(result, false));
                else
                    returnCompiledObject.textResults[returnCompiledObject.textResultsCount] = $internals.Utils.clone(result, false);
                returnCompiledObject.textResultsCount++;
            }
        }

        // setting values
        returnCompiledObject.value = compiledObject.func(varArgument);
        returnCompiledObject.compiled = compiledObject.func;
        return returnCompiledObject;
    }

    // parsing loop statement
    // e.g: item in items | where item.name > 2 | sortAsc name
    , parseLoopStatement: function parseLoopStatement(value)
    {
        var pos = 0;
        var nextPos;

        var loopContent = new LoopContent();

        // parse element and collection
        for (; value.charAt(pos) === ' '; ++pos) { } // skip whitespace
        for (nextPos = pos + 1; value.charAt(nextPos) !== ' ' ; ++nextPos) { } // get element end pos
        loopContent.elementName = value.substring(pos, nextPos);

        for (pos = nextPos + 1; value.charAt(pos) === ' '; ++pos) { } // skip whitespace - find 'in' element start
        if (!value.equals("in ", pos)) throw "invalid syntax";

        for (pos += 3; value.charAt(pos) === ' '; ++pos) { } // skip whitespace - find collection name
        for (nextPos = pos; nextPos < value.length && value.charAt(nextPos) !== ' ' && value.charAt(nextPos) !== '|'; ++nextPos) { } // find collection end (space or pipe)
        loopContent.collectionName.start = pos;
        loopContent.collectionName.end = nextPos;

        pos = nextPos;
        for (; pos < value.length && value.charAt(pos) === ' '; ++pos) { } // skip whitespace
        
        // FINISHED - no filter or sorting
        if (pos === value.length) return loopContent;

        do
        {
            // verify pipe closing of previous segment
            if (value.charAt(pos) !== '|') throw "invalid syntax";
            ++pos;

            for (; value.charAt(pos) === ' '; ++pos) { }; // skip whitespace

            // find syntax word to indicate type of segment
            for (nextPos = pos + 1; nextPos < value.length && value.charAt(nextPos) !== ' '; ++nextPos) { }
            var segmentType = value.substring(pos, nextPos);

            for (pos = nextPos + 1; pos < value.length && value.charAt(pos) === ' '; ++pos) { } // skip whitespace
            // find segment end -- double pipe checking to allow logical OR operator
            for (nextPos = pos + 1; nextPos < value.length ; ++nextPos)
            {
                if (value.charAt(nextPos) === '|' )
                {
                    if ( value.charAt(nextPos + 1) === '|') 
                    {
                        ++nextPos; // skip logical OR
                        continue;
                    }
                    break;
                }
            } // find collection end (space or pipe)
            var trimmedEndPos;
            for (trimmedEndPos = nextPos; trimmedEndPos < value.length && value.charAt(trimmedEndPos - 1) === ' '; --trimmedEndPos) { } // trimming spaces at end of value
            
            if (segmentType === "WHERE")
            {
                loopContent.filter = value.substring(pos, trimmedEndPos);
            }
            else if (segmentType === "ITERATOR")
            {
                loopContent.iterator = value.substring(pos, trimmedEndPos);
            }
            else if (segmentType === "SORTASC")
            {
                loopContent.sorter = Sorter.getSorter(value.length > pos ? value.substring(pos, trimmedEndPos) : null, "asc");
            }
            else if (segmentType === "SORTDESC")
            {
                loopContent.sorter = Sorter.getSorter(value.length > pos ? value.substring(pos, trimmedEndPos) : null, "desc");
            }
            else if (segmentType === "LIMIT")
            {
                loopContent.limit = { start: pos, end: trimmedEndPos };
            }
            pos = nextPos;

        } while (pos < value.length);

        return loopContent;
    }

    , parseText: function parseText(html, scope, thisIndex, preDefinedValues)
    {
        // parsing content
        if (!html) return html;
        
        this.__parseTextReusedObject.resultsLength = 0; // resetting array length
        var builder = null;
        var startIndex = 0;
        var lastEndPos = 0;
        
        while (startIndex < html.length)
        {
            startIndex = html.indexOf("{{", lastEndPos);
            if (startIndex === -1)
            {
                if (!builder) break;  // nothing to replace
                builder.push(html.substring(lastEndPos));
                break;
            }

            // adding string in between signatures
            if (!builder) builder = [];

            builder.push(html.substring(lastEndPos, startIndex));

            // search for end signature
            lastEndPos = html.indexOf("}}", startIndex);
            if (lastEndPos === -1)
            {
                builder.push(html.substring(startIndex));
                break;
            }
            if (html.charAt(lastEndPos + 2) === '}')
                ++lastEndPos;

            // inserting predefined values
            if (preDefinedValues)
            {
                var value = preDefinedValues[this.__parseTextReusedObject.resultsLength];
                // eval function
                if (value !== undefined && value.compiled) value = value.compiled(value.vars);
                // inserting to builder
                builder.push(value); 
            }
            // getting value
            else
            {
                // getting alloy value (using this.__getAlloyCompiledObjects at the end)
                var parseInfo = $internals.Parsers.getAlloyValue(html, startIndex + 2, lastEndPos, scope, thisIndex, this.__parseTextReusedObject.resultsLength);

                // adding value to builder
                builder.push(parseInfo.value);
            }
            ++this.__parseTextReusedObject.resultsLength; // updating value index

            lastEndPos += 2; // skipping end signature for next loop;
        }

        if (!builder) this.__parseTextReusedObject.html = html;
        else this.__parseTextReusedObject.html = builder.join(''); // joining new HTML

        // using the array
        this.__parseTextReusedObject.results = this.__getAlloyCompiledObjects;

        return this.__parseTextReusedObject;
    }

    // parsing eval expression
    , parseExpression: function parseExpression(expression, builder, fixedVars)
    {
        var usedValues = [];
        var skipLocalVariables = [];
        var state = 0; //
        var c, quoteChar, token;
        var tokenStart = 0, chainStart = 0, firstChainTokenEnd;
        var lastInsertEndPos = 0;;
        var i = 0, len = expression.length;
        var inReferenceChain = false;
        do
        {
            switch (state)
            {
                case 0: //waitForToken
                    for (; i < len; i++)
                    {
                        c = expression.charCodeAt(i);
                        if (c === 123)  // detect { to indicate scope depth
                        {
                            skipLocalVariables.push(null); // add a placeholder to indicate a scope started (padding between local variables)
                            continue;
                        }
                        if (c === 125)  // detect } to indicate scope depth
                        {
                            while (skipLocalVariables.pop() !== null) { }; // pop all local variables until a scope padding is found
                            continue;
                        }
                        // detect A-Z CHARACTER to indicate token start
                        if ($internals.Parsers.tokenStartCharacters[c])
                        {
                            tokenStart = i;
                            state = 1; break; // inToken State
                        }
                        if (c > 47 && c < 58)
                        { // detect a number - NUMERIC LITERAL START
                            ++i;
                            state = 6; break; //numericLiteral
                        }
                        if (c === 34 || c === 39)
                        {  // detect a qupte - STRING LITERAL START
                            ++i;
                            quoteChar = c;
                            state = 5; break; // stringliteral State
                        }
                    }
                    break;
                case 1: // inToken State
                    for (; i < len; i++)
                    {
                        c = expression.charCodeAt(i);
                        // detect end of token (non alphanumeric) 
                        if (!$internals.Parsers.variableCharacters[c])
                        {
                            // if not currently in a reference chain - ADD TOKEN REFERENCE
                            if (!inReferenceChain)
                            {
                                // checking if token is a known variable (we can technically skip this)
                                var token = expression.substring(tokenStart, i);
                                // if token is a reserved word indicating next token is not a possible variable (only if token is delimited by a space)
                                if (c === 32 && (token === "new" || token === "function" || token === "var"))
                                {
                                    ++i; state = 2; break; // inDeclaration state
                                }
                                // add token if found in variables table and is not overridden in local scope
                                if (!$internals.Parsers.safeWords[token] && !$internals.Utils.inArray(skipLocalVariables, token))
                                {
                                    builder.push(expression.substring(lastInsertEndPos, tokenStart), "vars['");
                                    lastInsertEndPos = tokenStart; // next time insert from current token (including)
                                }
                            }
                            
                            // if period '.' - detect reference chains
                            switch (c)
                            {
                                case 46: // period .

                                    // chain has started
                                    if (!inReferenceChain)
                                    {
                                        chainStart = tokenStart;
                                        firstChainTokenEnd = i;
                                        inReferenceChain = true;
                                    }

                                    tokenStart = ++i; // new token
                                    //state = 0; // waitForToken
                                    break;
                                default:
                                    if (inReferenceChain) // during chain
                                    {
                                        // if first chain token is a fixed var, keeping it
                                        if (fixedVars && (token = expression.substring(chainStart, firstChainTokenEnd))
                                            && $internals.Utils.inArray(fixedVars, token))
                                        {
                                            builder.push(token);
                                            builder.push("']");
                                            builder.push(expression.substring(firstChainTokenEnd, i));

                                            lastInsertEndPos = i;

                                            // inserting to used values
                                            $internals.Utils.insertUniqueToArray(usedValues, token);
                                        }
                                        else
                                        {
                                            // setting tokenEndIndex
                                            // if c is '(', tokenEndIndex should be chain's previous member
                                            // else, tokenEndIndex is i
                                            var tokenEndIndex = c === 40 ? tokenStart - 1 : i;

                                            token = expression.substring(chainStart, tokenEndIndex);
                                            if (!token.startsWith("window."))
                                            {
                                                builder.push(token);
                                                builder.push("']");
                                                lastInsertEndPos = tokenEndIndex;

                                                // inserting to used values
                                                $internals.Utils.insertUniqueToArray(usedValues, token);
                                            }
                                        }
                                    }
                                    else if (!$internals.Parsers.safeWords[token] && !$internals.Utils.inArray(skipLocalVariables, token))
                                    {
                                        // adding token to builder
                                        builder.push(token);
                                        builder.push("']");
                                        lastInsertEndPos = i;

                                        // inserting to used values
                                        $internals.Utils.insertUniqueToArray(usedValues, token);
                                    }
                                    inReferenceChain = false; // Omer : is this true? reference chain only after period? 

                                    // ' single quote, "" double quote
                                    if (c === 39 || c === 34)
                                    {
                                        quoteChar = c;
                                        state = 5;  // stringliteral State
                                    }
                                    else // change state: wait for next token
                                        state = 0; // waitForToken

                                    break;
                            }
                            break; // state change
                        }
                    }
                    break;
                case 5: // stringliteral State
                    var inEscateSequence = false;
                    for (; i < len; i++)
                    {
                        if (inEscateSequence)
                        {
                            inEscateSequence = false;
                            continue;
                        }
                        c = expression.charCodeAt(i);
                        if (c === 92) inEscateSequence = true; // detect \ for escape sequence
                        if (c === quoteChar) // detect closing string literal quote (single or double)
                        {
                            ++i; state = 0; break; // waitForToken
                        }
                    }
                    break;
                case 6: // NUMERIC LITEAL
                    var inEscateSequence = false;
                    for (; i < len; i++)
                    {
                        c = expression.charCodeAt(i);
                        if ((c > 57 || c < 48) && c !== 46) // allow numbers and period
                        {
                            ++i; state = 0; break; // waitForToken
                        }
                    }
                    break;
                case 2: // // inDeclaration state
                    // skip whitespaces until token
                    for (; i < len && expression.charCodeAt(i) === 32; i++) { };
                    tokenStart = i;
                    for (; i < len; i++)
                    {
                        c = expression.charCodeAt(i);
                        if (!((c > 96 && c < 123) || // lower alpha (a-z)
                                (c > 64 && c < 91) || // upper alpha (A-Z)
                                (c > 47 && c < 58))) // numeric (0-9)
                        {
                            var token = expression.substring(tokenStart, i);
                            skipLocalVariables.push(token); // add a placeholder to indicate a scope started (padding between local variables)
                            state = 0; break; // waitForToken
                            // not skipping character - allow IDLE state to handle scope '{' and other special characters
                        }
                    }
                    break;
            }
        } while (i < len);

        // process a token at the end of the input string
        if (state === 1) // inToken State
        {
            if (!inReferenceChain)
            {
                token = expression.substring(tokenStart, i);
                if (!$internals.Parsers.safeWords[token])
                {
                    if (!$internals.Utils.inArray(skipLocalVariables, token))
                    {
                        builder.push(expression.substring(lastInsertEndPos, tokenStart), "vars['");
                        builder.push(token);
                        builder.push("']");
                        lastInsertEndPos = i; // next time insert from current token (including)
                        $internals.Utils.insertUniqueToArray(usedValues, token);
                    }
                }
            }
            else
            {
                // inserting diff. (not sure we need it)
                if (lastInsertEndPos !== chainStart) { builder.push(expression.substring(lastInsertEndPos, chainStart)); }

                // if first chain token is a fixed var, keeping it
                if (fixedVars && (token = expression.substring(chainStart, firstChainTokenEnd))
                    && $internals.Utils.inArray(fixedVars, token))
                {
                    builder.push(token);
                    builder.push("']");
                    builder.push(expression.substring(firstChainTokenEnd, i));
                    lastInsertEndPos = i;
                }
                else
                {
                    token = expression.substring(chainStart, i);
                    if (!token.startsWith("window."))
                    {
                        // inserting token
                        builder.push(token);
                        builder.push("']");
                        lastInsertEndPos = i;
                    }
                    else // 
                        lastInsertEndPos = chainStart;
                }
                
                if (!$internals.Parsers.safeWords[token] && !token.startsWith("window")) $internals.Utils.insertUniqueToArray(usedValues, token);
            }
        }

        if (lastInsertEndPos !== len)
            builder.push(expression.substring(lastInsertEndPos, len));

        return usedValues;
    }
};;
    $internals.Binder = (function()
{
    //////////////////////////////////////////////////////////////////
    // Internals (private static methods)
    function bindLoop(loopStatement, domElement, scope, thisIndex)
    {
        // creating comment
        var comment = document.createComment(loopStatement);
        $internals.Utils.replaceDomElement(comment, domElement);

        var loopContent = $internals.Parsers.parseLoopStatement(loopStatement);
        var getLoopCollectionResult, collection;

        // collection
        if (loopContent.collectionName.start !== -1)
        {
            getLoopCollectionResult = $internals.Parsers.getAlloyValue(loopStatement, loopContent.collectionName.start, loopContent.collectionName.end, scope, thisIndex);
            collection = getLoopCollectionResult.value;
        }

        // creating dom pointer
        var ex;
        var domPointer = new DomPointer(domElement, null, loopContent);

        // adding dependency in collection
        var modelNode = getLoopCollectionResult.textResults[0].modelNode.createLoopIterationNode(loopContent.id);
        modelNode.addDependency(domPointer, new Expression('loop'));

        // setting loopContent values
        loopContent.thisIndex = thisIndex;
        loopContent.parentLoop = scope.$stack.$activeLoops.array[scope.$stack.$activeLoops.count];
        loopContent.repeatedElement = domElement;
        loopContent.commentElement = comment;

        // depending on parent loop's update
        if (loopContent.parentLoop)
            modelNode.addPriorNode(loopContent.parentLoop.trieNode);

        // limit
        if (loopContent.limit)
        {
            var firstChar = loopStatement.charCodeAt(loopContent.limit.start);
            if (firstChar >= 48 && firstChar <= 57) // is a number
                loopContent.limit = loopStatement.substring(loopContent.limit.start, loopContent.limit.end) | 0; // 32-bit number
            else
            {
                // adding dependency (currently supporting 1 simple-value only)
                var getInfo = $internals.Parsers.getAlloyValue(loopStatement, loopContent.limit.start, loopContent.limit.end, scope, thisIndex);
                if (getInfo.value !== undefined)
                {
                    // setting limit
                    loopContent.limit = getInfo.value;

                    var alloyValueObject = getInfo.textResults[0];
                    // creating expression
                    var exp = new Expression('loop-limit');
                    if (getInfo.compiled)
                    {
                        exp.compiled = getInfo.compiled;
                        exp.varName = alloyValueObject.varName;
                    }

                    // adding dependency
                    alloyValueObject.modelNode.addDependency(domPointer, exp);

                    // this modelNode must be updated BEFORE loop's
                    modelNode.addPriorNode(alloyValueObject.modelNode);
                }
            }
        }

        // preparing filter
        if (loopContent.filter)
        {
            getLoopFilter(loopContent, modelNode, scope, thisIndex);
            compileLoopFilterVars(loopContent.filter, scope);
        }

        // setting initial value
            modelNode.modelValue = collection = $internals.Utils.clone(collection, false);

        // looping
        scope.$stack.$activeLoops.count++;
        if (collection && collection.length)
        {
            var processedItems = prepareLoopArray(collection, loopContent, modelNode);

            // building UI
            for (var i = 0; i < processedItems; ++i)
                loopItem(scope, loopContent, modelNode, collection[i], i);
        }

        // resetting pointer
        scope.$stack.$activeLoops.count--;
    }


    function loopItem(scope, loopContent, collectionDependencyNode, collectionItem, index)
    {
        // creating dependency node
        var childDependencyNode = collectionDependencyNode.tryCreateNode(index);
        childDependencyNode.modelValue = collectionItem;

        // setting current loop node
        var parentLoop = scope.$stack.$activeLoops.array[scope.$stack.$activeLoops.count - 1];
        var activeLoop = new ActiveLoop(loopContent, childDependencyNode, parentLoop, index);
        if (scope.$stack.$activeLoops.array.length === scope.$stack.$activeLoops.count)
            scope.$stack.$activeLoops.array.push(activeLoop);
        else
            scope.$stack.$activeLoops.array[scope.$stack.$activeLoops.count] = activeLoop;

        // looping over repeated items
        var clonedElement = loopContent.repeatedElement.cloneNode(true);
        loopContent.commentElement.parentNode.insertBefore(clonedElement, loopContent.commentElement);
        clonedElement = main(clonedElement, scope, loopContent.thisIndex);

        // adding dependency between childNode and dom elements
        childDependencyNode.addDependency(new DomPointer(clonedElement),  new Expression('ui-item'));
    }

    function prepareLoopArray(collection, loopContent, loopModelNode)
    {
            var l = collection.length;
            var processedItems = 0;
            var collectionItem;
            var skippedElements = 0;

        // first iteration - filtering items
        var elementName = loopContent.elementName;
            for (var i = 0; i < l; ++i)
            {
                collectionItem = collection[i];

                // moving item
                if (skippedElements) collection[i - skippedElements] = collectionItem;

                // filtering
                if (loopContent.filter)
                {
                    // setting 'collection item' vars
                    loopContent.filter.compiledVars[0][elementName] = collectionItem;

                    // filtering func
                    if (!loopContent.filter.func.apply(null, loopContent.filter.compiledVars))
                    {
                        ++skippedElements;
                        continue;
                    }
                }

                // limit
                ++processedItems;
                if (loopContent.limit && processedItems === loopContent.limit) break;
            }

        // shrinking array
        if (processedItems !== collection.length)
            collection = collection.slice(0, processedItems);

        // updating count
        if (!loopContent.countNode)
            loopContent.countNode = loopModelNode.createFixedValueNode(processedItems);
        else
            loopContent.countNode.modelValue = processedItems;

        // sorting?
        if (loopContent.sorter)
            loopModelNode.modelValue = collection = loopContent.sorter.sort(collection);

        //
        return processedItems;
    }


    function optionItem(selectElement, optionsTrieNode, index, collectionItem, selected)
    {
        var opt = document.createElement("option"); // creating element
        if (typeof (collectionItem) === 'object') // object
        {
            opt.innerHTML = collectionItem.html || collectionItem.text || collectionItem.value; // html
            opt.value = collectionItem.value || collectionItem.text || collectionItem.html; // value
            if (selected == collectionItem.value) opt.selected = true; // setting selected
        }
        else // regular value
        {
            opt.innerHTML = opt.value = collectionItem;
            if (selected == collectionItem) opt.selected = true; // setting selected
        }

        // dependency of items
        var trieNode = optionsTrieNode.tryCreateNode(index);
        trieNode.addDependency(new DomPointer(opt), new Expression('ui-item'));

        // inserting into dom
        selectElement.appendChild(opt);
    }
    function attributes(domElement, scope, thisIndex)
    {
        var attributesCount = domElement.attributes.length;
        if (!attributesCount) return;
        var attrib, i, modelNode, events, ex, getValueResult, alloyValueObject;

        // image: replacing 'alloy-src' with 'src'
        if (domElement.nodeName === "IMG")
        {
            attrib = domElement.getAttribute("alloy-src");
            if (attrib)
            {
                domElement.setAttribute("src", "{{" + attrib + "}}");
                domElement.removeAttribute("alloy-src");
            }
        }

        // fixing onclick
        //if (domElement.nodeName === "A" && !domElement.getAttribute("onclick"))
        //    domElement.setAttribute("onclick", "return false;");

        while (attributesCount--)
        {
            attrib = domElement.attributes[attributesCount];
            if (!attrib) continue; // attribute 'alloy-src' might have been removed so count may not be accurate
            switch (attrib.name)
            {
                case "alloy-phase":
                    var phase = attrib.value;
                    if (scope.$phase !== null && scope.$phase !== phase)
                        domElement.style.display = 'none';
                    else
                    {
                        if (domElement.style.removeProperty)
                            domElement.style.removeProperty('display');
                        else if (domElement.style.removeAttribute)
                            domElement.style.removeAttribute('display');
                        else
                            domElement.style.display = '';
                    }

                    // creating node + dependency
                    modelNode = scope.$dependencies.tryCreateNode("$phase");
                    modelNode.modelValue = scope.$phase;
                    modelNode.addDependency(new DomPointer(domElement, attrib), new Expression('phase'));

                    break;
                case "alloy-if":
                    if (!attrib.value) break;
                    getValueResult = $internals.Parsers.getAlloyValue(attrib.value, 0, attrib.value.length, scope, thisIndex);

                    var domPointer = new DomPointer(domElement, attrib);
                    var ll = getValueResult.textResultsCount;
                    while (ll--)
                    {
                        alloyValueObject = getValueResult.textResults[ll];

                        // creating expression
                        var exp = new Expression();
                        exp.type = 'if';
                        exp.index = 0;
                        if (getValueResult.compiled)
                        {
                            exp.compiled = getValueResult.compiled;
                            exp.varName = alloyValueObject.varName;
                        }

                        // adding dependency
                        domPointer.addDependent(alloyValueObject.modelNode, exp);
                        alloyValueObject.modelNode.addDependency(domPointer, exp);
                    }

                    if (!getValueResult.value)
                    {
                        domElement.style.display = 'none';
                    }
                    else
                    {
                        if (domElement.style.removeProperty)
                            domElement.style.removeProperty('display');
                        else if (domElement.style.removeAttribute)
                            domElement.style.removeAttribute('display');
                        else
                            domElement.style.display = '';
                    }

                    break;
                case "alloy-bind-html":
                	// parsing value
                    getValueResult = bindText(domElement, attrib, attrib.value,scope, thisIndex)
                    if (getValueResult !== null) domElement.innerHTML = getValueResult;
                	break;
                // ALL OTHER ATTRIBUTES
                default:
                    var attribName = attrib.name;
                    if (attribName.startsWith("alloy-"))
                    {
                        // DOM EVENTS
                        if (attribName.equals("bind-event-", "alloy-".length))
                        {
                            var evName = attribName.substring("alloy-bind-event-".length);
                            if (!evName) break;
                            var attribValue = attrib.value;
                            // invalid syntax
                            if (!attribValue.contains("(") && attribValue.contains(")"))
                            {
                                console.log("Alloy.bind-event: invalid syntax. missing (): " + attribValue);
                                break;
                            }

                            // getting bindData
                            var bindData = getBindEventData(evName, attribValue, scope, scope, thisIndex);
                            if (!bindData) break;

                            // creating event handler
                            var eventHandler = (function eventFunc_creator(_scope, _thisIndex, _element, _bindData)
                            {
                                return function eventHandler(e)
                                {
                                    var scope = _scope;
                                    var element = _element;
                                    var bindData = _bindData;
                                    var thisIndex = _thisIndex;

                                    // adding variables
                                    var params = [];
                                    var evParamIndex = bindData.vars.length;
                                    while (evParamIndex--)
                                    {
                                        var varInfo = bindData.vars[evParamIndex];
                                        if (evParamIndex)
                                        {
                                            // event
                                            if (varInfo.name === 'e' || varInfo.name === 'event')
                                                params[varInfo.name] = e;
                                            // parent 'this'
                                            else if (varInfo.name === '$parent')
                                            {
                                                var parentIndex = thisIndex ? _scope.$stack.$this[thisIndex].parentIndex : 0;
                                                //console.log("this index:" + thisIndex + ", parent:" + parentIndex);
                                                params[varInfo.name] = _scope.$stack.$this[parentIndex].trieNode.modelValue;
                                            }
                                            else if (varInfo.name === "$domElement")
                                                params[varInfo.name] = element;
                                            else
                                                params[varInfo.name] = varInfo.modelTrieNode.modelValue;
                                        }
                                        else
                                            params[varInfo.name] = function () { scope[varInfo.name].apply(scope, arguments); }
                                    }

                                    // firing event
                                    var res = bindData.func(params);

                                    // handling event result
                                    if (res === undefined)
                                    {
                                        // if link doesn't change the page, we return false
                                        // to prevent 'beforeUnload' event to be fired.
                                        var tar = element.getAttribute("target");
                                        if (tar && tar !== "_self" && tar !== "self") return false;

                                        var href = element.getAttribute("href");
                                        if (!href) return false;
                                        if (href.startsWith("#")) return false;
                                        if (href.startsWith("javascript:")) return false;
                                    }
                                }

                            })(scope, thisIndex, domElement, bindData);

                            // registering to event
                            if (window.addEventListener)
                                domElement.addEventListener(evName, eventHandler);
                            else
                                domElement.attachEvent("on" + evName, eventHandler);

                            // adding to event (to dispose later)
                            scope.$registeredDomEvents.push({ name: evName, element: domElement, func: eventHandler });
                        }
                        // SCOPE EVENTS (PARENT SCOPE IS REGISTERING)
                        else if (attribName.equals("bind-scope-event-", "alloy-".length))
                        {
                            var parentScope = scope.$parent;
                            if (!parentScope) break;
                            var evName = attribName.substring("alloy-bind-scope-event-".length);
                            if (!evName) break;
                            var attribValue = attrib.value;

                            // invalid syntax
                            if (!attribValue.contains("(") && attribValue.contains(")"))
                            {
                                console.log("Alloy.bind-event: invalid syntax. missing (): " + attribValue);
                                break;
                            }

                            // getting bindData
                            var bindData = getBindEventData(evName, attribValue, scope, parentScope, thisIndex);
                            if (!bindData) break;

                            // registering event
                            scope.regiesterHandler(evName, function ()
                            {
                                // this == temp object (bottom of this method)
                                var mthis = this;

                                var params = [];
                                params[0] = arguments; // event params
                                var customParams = params[1] = []; // custom params

                                // adding variables
                                var evParamIndex = bindData.vars.length;
                                while (evParamIndex--)
                                {
                                    var varInfo = bindData.vars[evParamIndex];
                                    if (evParamIndex)
                                        params[varInfo.name] = varInfo.modelTrieNode.modelValue;
                                    else
                                        params[varInfo.name] = function () { mthis.scope.$parent[varInfo.name].apply(mthis.scope.$parent, params); }
                                }
                                customParams['scope'] = this.scope;

                                // firing event
                                bindData.func(params);

                            }, {scope: scope, bindData: bindData});
                        }
                        // skipping un-handled attributes
                        else break;
                    }

                    // parsing value
                    getValueResult = bindText(domElement, attrib, attrib.value,scope, thisIndex)
                    if (getValueResult !== null) attrib.value = getValueResult;
                    break;
            }
        }

        // internal events (2 way binding)
        var eventFunc, $this;
        switch (domElement.tagName)
        {
            case "SELECT":
                var optionsDomPointer, optionsCollection, optionsTrieNode, selectedValueTrieNode;

                // getting options
                attrib = domElement.getAttribute("alloy-options");
                if (!attrib) break;

                //////////////////////////////////////////////////////////////////////////////////////////
                ////////// BUILDING OPTIONS

                getValueResult = $internals.Parsers.getAlloyValue(attrib, 0, attrib.length, scope, thisIndex);
                if (getValueResult.compiled) throw ("Alloy options must be plain value: " + attrib);

                // adding dependency
                optionsTrieNode = getValueResult.textResults[0].modelNode.createLoopIterationNode(++lastId);
                optionsDomPointer = new DomPointer(domElement, null, new Expression('options'));
                optionsTrieNode.addDependency(optionsDomPointer, optionsDomPointer.contentInfo);

                // no collection
                optionsCollection = getValueResult.value;
                domElement.innerHTML = ""; // resetting children

                if (optionsCollection)
                {
                    // creating children
                    var collectionLen = optionsCollection.length;
                    for (var i = 0; i < collectionLen; ++i)
                        optionItem(domElement, optionsTrieNode, i, optionsCollection[i]);

                    //////////////////////////////////////////////////////////////////////////////////////////
                    ////////// SELECTED VALUE
                    attrib = domElement.getAttribute("alloy-options-selected");

                    if (attrib)
                    {
                        if (attrib.startsWith('{{') && attrib.endsWith('}}'))
                        {
                            getValueResult = $internals.Parsers.getAlloyValue(attrib, 2, attrib.length - 2, scope, thisIndex);
                            attrib = getValueResult.value;

                            // setting dependency
                            modelNode = getValueResult.textResults[0].modelNode;
                            modelNode.addDependency(optionsDomPointer, new Expression('options-selected'));

                            optionsDomPointer.contentInfo.value = -1;

                            // options node is dependent
                            optionsTrieNode.addPriorNode(modelNode);

                            // optionsTrieNode now points to selected value
                            selectedValueTrieNode = modelNode;
                        }

                        // marking selected option
                        var collectionLen = optionsCollection.length;
                        var selectedOption;
                        while (collectionLen--)
                        {
                            // option.value is string
                            if (domElement.childNodes[collectionLen].value != attrib) continue;
                            selectedOption = domElement.childNodes[collectionLen];
                            selectedOption.selected = true;

                            optionsDomPointer.contentInfo.value = domElement.childNodes[collectionLen].value;
                        }

                        // adding value to options contentInfo
                        //optionsDomPointer.contentInfo.value = collectionLen;
                    }
                }

                //////////////////////////////////////////////////////////////////////////////////////////
                ////////// REGISTERING EVENT
				var that = domElement;
                eventFunc = function (e)
                {
                    // updating pointers
                    var value = that[that.selectedIndex].value;
                    optionsDomPointer.contentInfo.value = value;

                    if (selectedValueTrieNode)
                    {
                        //selectedValueTrieNode.modelValue = value;
                        updateModelValue(scope, selectedValueTrieNode, value);
					}
                }

                // registering to event
                if (window.addEventListener)
                    domElement.addEventListener("change", eventFunc);
                else
                    domElement.attachEvent("onchange", eventFunc);
                break;
			case "TEXTAREA":
            case "INPUT":
                var t = domElement.type.toLowerCase();
                if (!domElement.getAttribute("alloy-this")) break; // only handling cases were explicitly given 'this'

                // setting UI
                $this = scope.$stack.$this[thisIndex];
				var that = domElement;

                // add dependency (for model -> UI updates)
                var ex = new Expression(t, 0);
                $this.trieNode.addDependency(new DomPointer(domElement, null, ex), ex);

                switch(t)
                {
                    case "checkbox":
                        domElement.checked = domElement.defaultChecked = $this.trieNode.modelValue === true;

                        // registering DOM events (for UI -> model updates)
                        eventFunc = function (e)
                        {
                            // updating model
                            updateModelValue(scope, $this.trieNode, that.checked);
                        }
                        if (window.addEventListener)
                            domElement.addEventListener("click", eventFunc);
                        else
                            domElement.attachEvent("onclick", eventFunc);

                        break;
                    case "radio":
                        domElement.checked = domElement.defaultChecked = ($this.trieNode.modelValue === domElement.value) || ($this.trieNode.modelValue + "" === domElement.value);
                        // registering DOM events (for UI -> model updates)
                        eventFunc = function (e)
                        {
                            // updating model
                            updateModelValue(scope, $this.trieNode, that.value);
                        }

                        if (window.addEventListener)
                            domElement.addEventListener("click", eventFunc);
                        else
                            domElement.attachEvent("onclick", eventFunc);

                        break;
                    case "text":
					default:
                        eventFunc = function (e)
                        {
                        	var newVal = that.value;
                        	if (newVal === that.lastValue) return;
                        	that.lastValue = newVal;

                        	// GETTING CHARACTER POSITION
  							var iCaretPos = 0;

                            //IE support
                            if (document.selection)
                            {
                            	// To get cursor position, get empty selection range
							    var oSel = document.selection.createRange();

							    // Move selection start to 0 position
							    oSel.moveStart('character', -that.value.length);

							    // The caret position is selection length
							    iCaretPos = oSel.text.length;
                            }
                            // FIREFOX
                            else if (typeof(that.selectionStart) === 'number')
                            {
                            	iCaretPos = that.selectionStart;
                            }

                            // updating model
                            updateModelValue(scope, $this.trieNode, newVal);

                            // setting character position
                            if (document.selection)
                            {
                            	// To get cursor position, get empty selection range
							    var oSel = document.selection.createRange();
							    // Move selection start to 0 position
							    oSel.moveStart('character', iCaretPos);
							}
							else if (typeof(that.selectionStart) === 'number')
							{
								that.selectionStart = iCaretPos;
								that.selectionEnd = iCaretPos;
							}
                        }

                        domElement.value = $this.trieNode.modelValue; // setting value
                        domElement.lastValue = $this.trieNode.modelValue;
                        if (window.addEventListener)
                            domElement.addEventListener("keyup", eventFunc);
                        else
                            domElement.attachEvent("onkeyup", eventFunc);
                        break;
                }
                break;
        }
    };

    function getLoopFilter(loopContent, loopTrieNode, scope, thisIndex)
    {
        loopContent.filter;
        var compiledObject = {};
        var str = ["0, (function(vars){return "];
        compiledObject.vars = $internals.Parsers.parseExpression(loopContent.filter, str, [loopContent.elementName]); // getting arguments
        str.push(";})");
        compiledObject.func = $internals.Utils.eval(str.join(''));

        // getting parameters
        var evParamIndex = compiledObject.vars.length;
        while (evParamIndex--)
        {
            var paramResult = $internals.Parsers.getAlloyValue(compiledObject.vars[evParamIndex], 0, compiledObject.vars[evParamIndex].length, scope, thisIndex);
            compiledObject.vars[evParamIndex] = {
                name: compiledObject.vars[evParamIndex],
                modelTrieNode: paramResult.textResults[0].modelNode
            };

            // adding dependency
            if (compiledObject.vars[evParamIndex].name !== loopContent.elementName)
                loopTrieNode.addPriorNode(compiledObject.vars[evParamIndex].modelTrieNode);
        }

        loopContent.filter = compiledObject;
    }

    function compileLoopFilterVars(filterObject, scope)
    {
        // creating object
        if (!filterObject.compiledVars) filterObject.compiledVars = [{}];

        // looping over vars and creating relevant object
        var evParamIndex = filterObject.vars.length;
        while (evParamIndex--)
        {
            var paramRes = filterObject.vars[evParamIndex];
            filterObject.compiledVars[0][paramRes.name] = paramRes.modelTrieNode.modelValue;
        }
        filterObject.compiledVars[0]['scope'] = scope;
    }

    function getBindEventData(eventName, eventHandler, dataScope, functionScope, thisIndex)
    {
        // parsing request and vars
        var compiledObject = {};
        var str = ["0, (function(vars){return "];
        compiledObject.vars = $internals.Parsers.parseExpression(eventHandler, str); // getting arguments
        str.push(";})");
        compiledObject.func = $internals.Utils.eval(str.join(''));

        /*
        var compiledObject = {};
        var str = ["function tempEvalFunction(vars){return "];
        compiledObject.vars = $internals.Parsers.parseExpression(eventHandler, str); // getting arguments
        str.push(";}");

        try
        {
            // first: trying to add as <script> tag (fastest)
            var scriptTag = document.createElement('script');
            scriptTag.type = 'text/javascript';
            scriptTag.charset = 'utf-8';
            scriptTag.id = 'testing';
            scriptTag.defer = true;
            scriptTag.async = true;
            scriptTag.text = str.join('');
            document.getElementsByTagName('head')[0].appendChild(scriptTag);

            compiledObject.func = window.tempEvalFunction;
            window.tempEvalFunction = null;
        }
        catch (e)
        {
        	// trying to eval
            eval(str.join(''));
        }
		*/


        // first vars is ALWAYS function name.
        // Thus, verifying there's a method
        if (typeof(functionScope[compiledObject.vars[0]]) !== 'function')
        {
            console.log("Alloy.bind-event: missing method '" + compiledObject.vars[0] + "' as registered for " + eventName + " event");
            return null;
        }

        // getting parameters
        var evParamIndex = compiledObject.vars.length;
        while (evParamIndex--)
        {
            if (evParamIndex)
            {
                var paramResult = $internals.Parsers.getAlloyValue(compiledObject.vars[evParamIndex], 0, compiledObject.vars[evParamIndex].length, dataScope, thisIndex);
                compiledObject.vars[evParamIndex] = {
                    name: compiledObject.vars[evParamIndex],
                    modelTrieNode: paramResult.textResults[0].modelNode
                };
            }
            else
            {
                compiledObject.vars[evParamIndex] = {
                    name: compiledObject.vars[evParamIndex]
                };
            }
        }

        return compiledObject;
    }

    function updateModelValue(scope, modelTrieNode, value)
    {
        // updating model value (from parent)
        var parentNode = modelTrieNode.parent;
        parentNode.modelValue[modelTrieNode.word] = value;

        // updating
        scope.update();
    }

    function bindText(element, attrib, value, scope, selfIndex)
    {
        if (!value) return null;

        // parsing text
        var parseResult = $internals.Parsers.parseText(value, scope, selfIndex);
        if (parseResult.html === value) return null; // nothing has changed

        // creating dom pointer
        var domPointer = new DomPointer(element, attrib, value);

        // adding to modelTrieNode
        var l = parseResult.resultsLength;
        var parsedItem, alloyValueObject;
        while (l--)
        {
            parsedItem = parseResult.results[l]; // this.__getAlloyCompiledObject
            var ll = parsedItem.textResultsCount;
            while (ll--)
            {
                alloyValueObject = parsedItem.textResults[ll];

                // creating expression
                var exp = new Expression();
                exp.type = 'text';
                exp.index = l;
                if (parsedItem.compiled)
                {
                    exp.compiled = parsedItem.compiled;
                    exp.varName = alloyValueObject.varName;
                }

                // adding dependency
                domPointer.addDependent(alloyValueObject.modelNode, exp);
                alloyValueObject.modelNode.addDependency(domPointer, exp);
            }
        }

        return parseResult.html;
    }

    function main(domElement, scope, thisIndex)
    {
        var mainStack = new Array(20);
        var stackLastIndex = 0;
        var stackItem;

        // stack variables
        var newScope, $This, template, childIndex, templateSrc;
        var pendingLoad = null;

        // inserting first item
        mainStack[0] = new Array(4); // #0 - domElement, #1 - thisIndex, #2 - handled, #3 - childIndex
        mainStack[0][0] = domElement;
        mainStack[0][1] = thisIndex;
        mainStack[0][2] = false;
        mainStack[0][3] = 0;

        do
        {
            // taking item
            stackItem = mainStack[stackLastIndex];

            // copying variables
            domElement = stackItem[0];
            thisIndex = stackItem[1];
            childIndex = stackItem[3];

            // setting variables
            template = null;
            templateSrc = null;
            newScope = null;

            ///////////////////////////////////////////////////////////////////////////
            // handling dom element
            if (!stackItem[2])
            {
                stackItem[2] = true; // marking as handled

                while (true) // to allow breaking
                {
                    // skipping comments
                    if (domElement.nodeName === '#comment') break;

                    // parsing #text nodes
                    if (domElement.nodeName === "#text")
                    {
                        var bindResult = bindText(domElement, null, domElement.nodeValue, scope, thisIndex)
                        if (bindResult !== null) domElement.nodeValue = bindResult;
                        break;
                    }

                    // processing attributes with special behaviour
                    if (domElement.attributes.length)
                    {
                        // loop statement
                        var loopStatement = domElement.getAttribute("alloy-loop");
                        if (loopStatement)
                        {
                            // removing attribute
                            domElement.removeAttribute("alloy-loop");

                            // we need to update parent's childIndex as children may be added in the loop
                            var childNodesToProcess;
                            var previousStackItem = mainStack[stackLastIndex - 1];
                            if (stackLastIndex !== 0)
                                // children left to process = totalChildren - processedChildren
                                childNodesToProcess = previousStackItem[0].childNodes.length - previousStackItem[3];

                            // loop
                            bindLoop(loopStatement, domElement, scope, thisIndex);

                            // to avoid handling child nodes
                            stackItem[3] = childIndex = domElement.childNodes.length;

                            // updating parent's childIndex
                            if (stackLastIndex !== 0)
                                previousStackItem[3] = previousStackItem[0].childNodes.length - childNodesToProcess;

                            break;
                        }

                        // getting 'this'
                        var newThis = domElement.getAttribute("alloy-this");
                        if (newThis)
                        {
                            var getValueResult = $internals.Parsers.getAlloyValue(newThis, 0, newThis.length, scope, thisIndex);
                            if (getValueResult.compiled) throw ("Invalid alloy-this: " + newThis + ". It must be a simple value");
                            if (getValueResult.value !== undefined)
                            {
                                // adding new This
                                var $this = scope.$stack.$this;
                                $this.push(new This(getValueResult.textResults[0].modelNode, thisIndex));
                                stackItem[1] = thisIndex = $this.length - 1;
                            }
                        }

                        // alloy-src (downloading source)
                        if (domElement.nodeName !== "IMG") templateSrc = domElement.getAttribute("alloy-src");

                        // alloy-scope
                        newScope = domElement.getAttribute("alloy-scope");
                        if (newScope && newScope !== "binded")
                        {
                            newScope = window[newScope] || null;
                            if (newScope) newScope = new newScope(scope.$stack.$this[thisIndex].trieNode.modelValue);
                        }
                    }

                    // handling template
                    if (domElement.tagName) template = $internals.Templates.get(domElement);
                    if (template)
                    {
                        // static scope?
                        if (!newScope)
                        {
                            newScope = getScopeClass(domElement.tagName, scope, thisIndex);

                            // static binding to element ID
                            if (!newScope && domElement.id) newScope = getScopeClass('#' + domElement.id, scope, thisIndex);
                        }

                        // not a new scope, template is handled here
                        if (!newScope || newScope === "binded")
                        {
                            newScope = false; // setting correct state

                            //////////////////////////////////////////////////////////////////////////
                            // creating final dom (also called template dom as we use the template as our dom)

                            // duplicating template
                            var templateDom = template.cloneNode(true);

                            // building this template instance (merging overrides)
                            // comparing domElement's childNodes with template's
                            templateRefactoring(templateDom, domElement.childNodes, 0);

                            // finding first child to process (skipping
                            var firstChild = templateDom.firstChild;
                            while (firstChild.nodeName == '#comment')
                                firstChild = firstChild.nextSibling;
                            while (true)
                            {
                                // <element>
                                if (firstChild.nodeName.charAt(0) !== '#') break;

                                // trimming to make sure child is text and not just whitespaces
                                var tmpNodeValue = firstChild.nodeValue;
                                var tmpPos =0;
                                for(;tmpPos<tmpNodeValue.length;++tmpPos)
                                {
                                    var c = tmpNodeValue.charCodeAt(tmpPos);
                                    if (c == 9 || c == 32 || c == 10 || c == 13) continue;
                                    break;
                                }
                                // if all is whitespace
                                if (tmpPos == tmpNodeValue.length) firstChild = firstChild.nextSibling;
                                else break;
                            }

                            // copying attributes
                            if (firstChild.nodeName.charAt(0) !== '#')
                                $internals.Utils.copyAttributes(domElement, firstChild, true);

                            // replacing element @ parent
                            $internals.Utils.replaceDomElement(templateDom, domElement);
                            stackItem[0] = domElement = firstChild;

                            // template is a textnode, reprocessing
                            if (firstChild.nodeName === "#text") continue;
                        }
                    }
                    // we need to download source
                    else if (templateSrc)
                    {
                        domElement.removeAttribute("alloy-src");

                        if (!pendingLoad) pendingLoad = [];
                        pendingLoad.push(stackItem, templateSrc); // inserting stackItem and template source

                        // downloading file
                        //console.log("downloading: " + templateSrc);
                        /*
                        Alloy.$di([{ type: "meta", path: templateSrc }], function ()
                        {
                            laterProcess
                        });
                        */
                    }

                    //////////////////////////////////////////////////////////////////
                    // new scope
                    if (newScope)
                    {
                        // setting false to dynamic scope
                        domElement.setAttribute("alloy-scope", "binded");

                        // binding model
                        $This = scope.$stack.$this[thisIndex];

                        // adding dependency
                        $This.trieNode.addDependentScope(newScope);

                        // we need to update parent's childIndex as children may be added in the loop
                        var childNodesToProcess;
                        var previousStackItem = mainStack[stackLastIndex - 1];
                        if (stackLastIndex !== 0)
                            // children left to process = totalChildren - processedChildren
                            childNodesToProcess = previousStackItem[0].childNodes.length - previousStackItem[3];

                        // adding to collection, ...
                        newScope.$parent = scope;
                        newScope.$name = domElement.tagName;
                        scope.$childScopes.push(newScope);

                        // getting scope name
                        var scopeName = domElement.getAttribute("alloy-scope-name");
                        if (scopeName)
                        {
                            if (!scope.$childScopesByName) scope.$childScopesByName = [];
                            scope.$childScopesByName[scopeName] = newScope;
                        }

                        // binding
                        scope.childScopeCreated(newScope, domElement);
                        stackItem[0] = domElement = newScope.bind(domElement);

                        // to avoid handling child nodes
                        stackItem[3] = childIndex = domElement.childNodes.length;

                        // updating parent's childIndex
                        if (stackLastIndex !== 0)
                            previousStackItem[3] = previousStackItem[0].childNodes.length - childNodesToProcess;

                        break;
                    }

                    //////////////////////////////////////////////////////////////////
                    // attributes
                    attributes(domElement, scope, thisIndex);

                    break;

                } // closing while(true)
            } // closing dom handling

            ///////////////////////////////////////////////////////////////////////////
            // CHILDREN

            // no more children
            if (childIndex === domElement.childNodes.length)
            {
                stackLastIndex--;

                //mainStack[stackLastIndex--] = null;
            }
            else // adding next child
            {
                var childNode = domElement.childNodes[childIndex];
                stackItem[3]++;

                // getting child stack item
                var childStackItem;
                if (++stackLastIndex > mainStack.length)
                {
                    childStackItem = new Array(4);
                    mainStack.push(childStackItem);
                }
                else
                {
                    childStackItem = mainStack[stackLastIndex];
                    if (!childStackItem) childStackItem = mainStack[stackLastIndex] = new Array(4);
                }

                // updating it
                childStackItem[0] = childNode;
                childStackItem[1] = thisIndex;
                childStackItem[2] = false;
                childStackItem[3] = 0;
            }

        } while (stackLastIndex !== -1);

        return mainStack[0][0]; // returning element
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Helpers
    function templateRefactoring(templateNode, instanceChildNodes, instanceChildIndex)
    {
        var templateChildNodes = templateNode.childNodes
            , templateLength = templateChildNodes.length
            , tempChildNode
            , instanceLength = instanceChildNodes.length
            , childNode
            , cIndex
            , placeholder;

        while (templateLength--)
        {
            tempChildNode = templateChildNodes[templateLength];
            if (!tempChildNode.tagName) continue; // skipping textnodes, comments, etc

            // taking placeholder
            placeholder = tempChildNode.getAttribute("alloy-placeholder-id");
            if (placeholder)
            {
                // searching for relevant placeholder
                for (cIndex = instanceChildIndex; cIndex < instanceLength; ++cIndex)
                {
                    childNode = instanceChildNodes[cIndex];
                    if (!childNode.tagName) continue; // skipping textnodes, comments, etc

                    // if found a match
                    if (childNode.getAttribute("alloy-placeholder-id") === placeholder)
                    {
                        childNode.removeAttribute("alloy-placeholder-id"); // removing attribute

                        // copying attributes from currentElement to domElement
                        //$internals.Utils.copyAttributes(templateChildNode, domChildNode);

                        // replacing DOM elements
                        $internals.Utils.replaceDomElement(childNode, tempChildNode);

                        // updating index
                        instanceChildIndex = cIndex;
                        break;
                    }
                }
            }
            else // going to its children
            {
                templateRefactoring(tempChildNode, instanceChildNodes, instanceChildIndex);
            }
        }
    }
    function getScopeClass(tagName, scope, thisIndex)
    {
        if (scope.$tagToScopeClass)
        {
            var model = scope.$stack.$this[thisIndex].trieNode.modelValue;

            // checking in scope
            var tmpScope = scope.$tagToScopeClass[tagName];
            if (tmpScope) return new tmpScope(model);
        }


        // checking in global binding
        tmpScope = Alloy.Scope.$staticBinding[tagName];
        if (tmpScope) return new tmpScope(model);

    };
    function evalEmbeddedData(domElement, scope)
    {
        var embeddedDataName;
        try
        {
            // getting name to
            embeddedDataName = domElement.getAttribute("alloy-data-target") || null;
            // evaluating
            var evalued = eval("(" + domElement.innerHTML + ")");

            // adding to embedded data
            if (!embeddedDataName) scope.$embedded = evalued;
            else scope.$embedded[embeddedDataName] = evalued;
        }
        catch (e)
        {
            throw ("Alloy.bind() - error evaluating embedded-data: " + domElement.innerHTML);
        }

        // replacing with comment
        var comment = document.createComment(domElement.innerHTML);
        $internals.Utils.replaceDomElement(comment, domElement);
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // Builder static
    function clearMemory(scope)
    {
        scope.$stack.$activeLoops = null;
        scope.$compiledEval = null;
        $internals.Parsers.clearMemoryObjects();
    }

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // INTERFACE
    return {
        bind: function bind(domElement, scope)
        {
            ////////////////////////////////////////////////////////////////////
            // searching for alloy-embedded-data (needed for 'beforeBind' event)
            var l = domElement.childNodes.length;
            for (var i = 0; i < l; ++i)
            {
                var d = domElement.childNodes[i];
                if (d.nodeName.charAt(0) == '#') continue;
                if (d.nodeName === "ALLOY-EMBEDDED-DATA" || d.nodeName === "alloy-embedded-data")
                    evalEmbeddedData(d, scope);
                break;
            }

            // before bind event
            scope.beforeBind();

            // creating objects
            scope.$dependencies = new ModelTrieNode();
            scope.$compiledEval = {};
            scope.$registeredDomEvents = [];
            scope.$updateCycle = 0;

            // creating stack object
            scope.$childScopes = [];
            var modelDepNode = scope.$dependencies.tryCreateNode("$model");
            modelDepNode.modelValue = scope.$model;
            scope.$stack = {
                // array of models
                $this: [new This(modelDepNode, -1)]
                // holding active loop item
                , $activeLoops: {array: [null], count: 0}
            };
            $internals.Parsers.initMemoryObjects();

            // bind
            var p = domElement.parentNode;
            var nextSibling = domElement.nextSibling;
            $internals.Utils.removeElement(domElement);
            scope.$domElement = main(domElement, scope, 0);
            if (nextSibling)
                p.insertBefore(scope.$domElement, nextSibling);
            else
                p.appendChild(scope.$domElement);

            // clearing memory
            clearMemory(scope);

            // after bind event (set timeout so that DOM finish processing)
            setTimeout(function () { scope.afterBind(scope.$domElement); }, 0);

            return scope.$domElement;
        }
        , update: function update(scope)
        {
            if (!scope.$domElement) return;
            if (scope.$updating) return;

            // before update handler
            scope.beforeUpdate();

            scope.$updating = true;
            scope.window = window;
            scope.$stack.$activeLoops = { array: [null], count: 0 };
            scope.$compiledEval = {};
            $internals.Parsers.initMemoryObjects();

            // updating 'scope.$model' self
            var stack = new Array(20); // estimating value
            stack[0] = new Array(5); // #0 - modelNode, #1 - model, #2 - childIndex, #3 - pendingNodes index, #4 - priorNodes index
            stack[0][0] = scope.$dependencies;
            stack[0][1] = scope;
            stack[0][2] = 0;
            stack[0][3] = 0;
            stack[0][4] = -1;

            var stackLastIndex = 0;
            var updateCycle = ++scope.$updateCycle;
            var postLoopUpdate = []; // all keys to update
            var postLoopUpdateIndices = {}; // hashtable to take keys faster
            var l, arrayItem, domPointer, arr;

            do
            {
                var item = stack[stackLastIndex];
                var modelTrieNode = item[0];
                var model = item[1];

                // if node has prior nodes
                if (item[4] !== -1)
                {
                    arr = modelTrieNode.priorUpdateNodes;
                    l = item[4];
                    do
                    {
                        arrayItem = arr[l];
                        if (arrayItem.generation === updateCycle) continue;

                        // adding node to prior Node array
                        if (!arrayItem.pendingUpdateNodes) arrayItem.pendingUpdateNodes = [];
                        arrayItem.pendingUpdateNodes.push({ node: modelTrieNode, model: model });

                        break; // breaking loop

                    } while (--l !== -1);

                    item[4] = l; // updating prior index
                }

                // if model wasn't processed in this cycle
                if (item[4] === -1 && modelTrieNode.generation !== updateCycle)
                {
                    // fixed value
                    if (modelTrieNode.type === 1) model = modelTrieNode.modelValue;

                    // if it has dependent
                    if (modelTrieNode.dependentScopes || modelTrieNode.dependents)
                    {
                        var valueChanged;
                        if (modelTrieNode.type === 1)
                            valueChanged = true;
                        else if (model instanceof Array)
                            valueChanged = !$internals.Utils.compareArrays(model, modelTrieNode.modelValue); // shallow copy diff
                        else
                            valueChanged = model !== modelTrieNode.modelValue;

                        var expression, postUpdateObj, evalObj;
                        arr = modelTrieNode.dependentScopes;

                        // updating scope models
                        if (valueChanged && arr)
                        {
                            l = arr.length;
                            while (l--) arr[l].setModel(model);
                        }

                        // updating dom objects
                        arr = modelTrieNode.dependents;
                        if (arr)
                        {
                            l = arr.length;
                            while (l--)
                            {
                                arrayItem = arr[l];
                                domPointer = arrayItem.domPointer;
                                expression = arrayItem.expression;

                                switch(expression.type)
                                {
                                    case "if":
                                    case "text":
                                        // if value wasn't changed AND domPointer doesn't need to change
                                        if (!valueChanged && domPointer.updateCycle != updateCycle) break;

                                        postUpdateObj = postLoopUpdateIndices[domPointer.id];
                                        if (!postUpdateObj) // creating object
                                        {
                                            // adding to hash
                                            postUpdateObj = postLoopUpdateIndices[domPointer.id] = { domPointer: domPointer, values: [] };
                                            // adding to array
                                            postLoopUpdate.push(postUpdateObj);
                                            // updating update cycle
                                            domPointer.updateCycle = updateCycle;

                                            // going over other expressions
                                            if (domPointer.dependents)
                                            {
                                                var dpd = domPointer.dependents;
                                                var dpdl = domPointer.dependents.length;
                                                var dpdi;

                                                while (dpdl--)
                                                {
                                                    dpdi = dpd[dpdl];
                                                    if (dpdi.modelNode === modelTrieNode) continue;

                                                    // node was NOT processed in this update cycle yet
                                                    if (dpdi.modelNode.generation !== updateCycle) continue;

                                                    // eval
                                                    if (dpdi.expression.compiled)
                                                    {
                                                        evalObj = postUpdateObj.values[dpdi.expression.index];
                                                        if (!evalObj) evalObj = postUpdateObj.values[dpdi.expression.index] = { compiled: dpdi.expression.compiled, vars: {} };
                                                        evalObj.vars[dpdi.expression.varName] = dpdi.modelNode.modelValue;
                                                    }
                                                    // model
                                                    else
                                                        postUpdateObj.values[dpdi.expression.index] = dpdi.modelNode.modelValue;
                                                }
                                            }
                                        }

                                        // eval
                                        if (expression.compiled)
                                        {
                                            evalObj = postUpdateObj.values[expression.index];
                                            if (!evalObj) evalObj = postUpdateObj.values[expression.index] = {compiled: expression.compiled, vars: {}};
                                            evalObj.vars[expression.varName] = model;
                                        }
                                        // model
                                        else
                                            postUpdateObj.values[expression.index] = model;
                                        break;
                                    case "loop-limit":
                                        if (!valueChanged) break;
                                        domPointer.contentInfo.limit = model; // updating loops limit
                                        break;
                                    case "loop":
                                        var processedItems = 0;
                                        var loopContent = domPointer.contentInfo;
                                        var ll, collectionItem;

                                        // if there's a collection
                                        if (model)
                                        {
                                            // sorting (and updating model)
                                            item[1] = model = $internals.Utils.clone(model);

                                            // taking care of parent loop
                                            if (loopContent.parentLoop)
                                            {
                                                var d = scope.$stack.$activeLoops.count = loopContent.parentLoop.depth + 1;
                                                var activeLoop = loopContent.parentLoop;
                                                while (--d)
                                                {
                                                    if (scope.$stack.$activeLoops.array.length === d)
                                                        scope.$stack.$activeLoops.array.push(activeLoop);
                                                    else
                                                        scope.$stack.$activeLoops.array[d] = activeLoop;

                                                    activeLoop = activeLoop.parent;
                                                }
                                            }
                                            else
                                                scope.$stack.$activeLoops.count = 1;

                                            // iterating collection
                                            ll = model.length;
                                            var skippedElements = 0;
                                            var elementName = loopContent.elementName;
                                            if (loopContent.filter) compileLoopFilterVars(loopContent.filter, scope);

                                            // preparing array
                                            var processedItems = prepareLoopArray(model, loopContent, modelTrieNode);

                                            // building UI
                                            for (var i = 0; i < processedItems; ++i)
                                                {
                                                // adding necessary item (by checking if trie has childnode with that index)
                                                if (!modelTrieNode.nodesHash || modelTrieNode.nodesHash[i] === undefined)
                                                {
                                                    loopItem(scope, loopContent, modelTrieNode, model[i], i);
                                                    valueChanged = true;
                                                }
                                            }
                                        }

                                        ///////////////////////////////////////////
                                        // removing UI items

                                        var tmpIndex, toRemoveArr, nodeToRemove;

                                        // TODO - unregister events

                                        if (modelTrieNode.nodes)
                                        {
                                            var tmpIndex = 0,
                                                newNodes = undefined,
                                                newHash = undefined;

                                            // checking if we need to remove items
                                            var lll = modelTrieNode.nodes.length;
                                            while (lll--)
                                            {
                                                nodeToRemove = modelTrieNode.nodes[lll];
                                                if (typeof (nodeToRemove.word) === 'number' && nodeToRemove.word >= processedItems) break;
                                            }
                                            if (lll !== -1)
                                            {
                                                valueChanged = true; // marking object as changed

                                                newNodes = new Array(modelTrieNode.nodes.length);
                                                newHash = {};

                                                for (lll = 0; lll < modelTrieNode.nodes.length; ++lll)
                                                {
                                                    nodeToRemove = modelTrieNode.nodes[lll];
                                                    // node is legit
                                                    if (typeof (nodeToRemove.word) !== 'number' || nodeToRemove.word < processedItems)
                                                    {
                                                        newNodes[tmpIndex] = nodeToRemove;
                                                        newHash[nodeToRemove.word] = tmpIndex++;
                                                    }
                                                    // node is to be removed
                                                    else
                                                    {
                                                        // disposing scopes
                                                        toRemoveArr = nodeToRemove.dependentScopes;
                                                        if (toRemoveArr)
                                                        {
                                                            ll = toRemoveArr.length;
                                                            while (ll--) toRemoveArr[ll].dispose(); // disposing scopes
                                                        }

                                                        // disposing ui
                                                        toRemoveArr = nodeToRemove.dependents;
                                                        if (toRemoveArr)
                                                        {
                                                            ll = toRemoveArr.length;
                                                            while (ll--)
                                                            {
                                                                // only removing 'ui-item' elements
                                                                if (toRemoveArr[ll].expression.type !== 'ui-item') continue;
                                                                $internals.Utils.removeElement(toRemoveArr[ll].domPointer.element);
                                                            }
                                                        }
                                                    }
                                                }
                                            }

                                            // setting newNodes
                                            if (lll !== -1 && modelTrieNode.nodes && tmpIndex !== modelTrieNode.nodes.length)
                                            {
                                                valueChanged = true; // marking object as changed
                                                modelTrieNode.nodesHash = newHash;
                                                modelTrieNode.nodes = newNodes;
                                                modelTrieNode.nodes.splice(tmpIndex, modelTrieNode.nodes.length - tmpIndex);
                                            }
                                        }
                                        break;
                                    case "options-selected":
                                        if (!valueChanged) break;
                                        domPointer.contentInfo.value = model; // updating selected value
                                        break;
                                    case "options":
                                        // if there's a collection
                                        if (model)
                                        {
                                            // iterating collection
                                            ll = model.length;
                                            for (var i = 0; i < ll; ++i)
                                            {
                                                var pos = modelTrieNode.nodesHash ? modelTrieNode.nodesHash[i] : undefined;

                                                // adding necessary item (by checking if trie has childnode with that index)
                                                if (pos === undefined)
                                                    optionItem(domPointer.element, modelTrieNode, i, model[i], expression.value);
                                                else if (expression.value == model[i] || expression.value == model[i].value) // setting selected
                                                    modelTrieNode.nodes[pos].dependents[0].domPointer.element.selected = true;
                                            }
                                        }

                                        // removing from UI and TRIE
                                        if ((!model && modelTrieNode.modelValue) // if now there's no collection, but there was previously
                                            || (modelTrieNode.modelValue && modelTrieNode.nodes && model.length < modelTrieNode.nodes.length)) // there was an array and processed items is SMALLER than what was before
                                        {
                                            var tmpIndex = model.length;
                                            var depIndex = modelTrieNode.nodesHash[tmpIndex];
                                            while (!isNaN(depIndex))
                                            {
                                                delete modelTrieNode.nodesHash[tmpIndex]; // removing from hash
                                                var nodeToRemove = modelTrieNode.nodes[depIndex];
                                                var toRemoveArr = nodeToRemove.dependentScopes;

                                                // disposing scopes
                                                if (toRemoveArr)
                                                {
                                                    ll = toRemoveArr.length;
                                                    while (ll--) toRemoveArr[ll].dispose(); // disposing scopes
                                                }
                                                // disposing ui
                                                //TODO - unbind events. to do so, will need to redesign the way we save events
                                                toRemoveArr = nodeToRemove.dependents;
                                                if (toRemoveArr)
                                                {
                                                    ll = toRemoveArr.length;
                                                    while (ll--)
                                                    {
                                                        // only removing 'ui-item' elements
                                                        if (toRemoveArr[ll].expression.type !== 'ui-item') continue;
                                                        $internals.Utils.removeElement(toRemoveArr[ll].domPointer.element);
                                                    }
                                                }
                                                depIndex = modelTrieNode.nodesHash[++tmpIndex];
                                            }

                                            // removing all childnodes from trie
                                            if (tmpIndex) modelTrieNode.nodes.splice(processedItems, tmpIndex);
                                        }

                                        break;
                                    case "checkbox":
                                        if (!valueChanged) break;
                                        domPointer.element.checked = domPointer.element.defaultChecked = model;
                                        break;
                                    case "phase":
                                        var phase = domPointer.attribute.value;
                                        if (scope.$phase !== null && scope.$phase !== phase)
                                            domPointer.element.style.display = 'none';
                                        else
                                        {
                                            if (domPointer.element.style.removeProperty)
                                                domPointer.element.style.removeProperty('display');
                                            else if (domPointer.element.style.removeAttribute)
                                                domPointer.element.style.removeAttribute('display');
                                            else
                                                domPointer.element.style.display = '';
                                        }
                                        break;
                                    default:

                                        break;
                                }
                            }
                        }

                        // saving new value
                        if (valueChanged) modelTrieNode.modelValue = model;
                    }
                    else // saving model value
                        modelTrieNode.modelValue = model;


                    // updating generation
                    modelTrieNode.generation = updateCycle;
                }

                ////////////////////////////////////////////////////////////////////////////////////////////////////////
                // deciding how to proceed in stack


                var nextNode = null, nextNodeValue;
                if (item[4] !== -1) // cannot process this node
                {
                    // moving backwards in stack
                    stackLastIndex--;
                }
                // if (not in root node) && there's no model value, but there are childnodes - removing them
                //else if (stackLastIndex && !modelTrieNode.modelValue && modelTrieNode.nodes && modelTrieNode.nodes.length)
                //{
                //    debugger;
                //}
                // no children to process, checking pending nodes
                else if (!modelTrieNode.nodes || item[2] == modelTrieNode.nodes.length)
                {
                    // no more pending nodes
                    if (!modelTrieNode.pendingUpdateNodes || item[3] === modelTrieNode.pendingUpdateNodes.length)
                    {
                        stackLastIndex--;
                        modelTrieNode.pendingUpdateNodes = null; // resetting pending update nodes
                    }
                    else // processing next pending update
                    {
                        nextNode = modelTrieNode.pendingUpdateNodes[item[3]].node;
                        nextNodeValue = modelTrieNode.pendingUpdateNodes[item[3]].model;
                        item[3]++;
                    }
                }
                // processing next child
                else
                {
                    nextNode = modelTrieNode.nodes[item[2]++];
                    if (nextNode.type === 2) { nextNodeValue = model; } // next node is a loop, keeping model
                    // other cases
                    else if (model) nextNodeValue = model[nextNode.word];
                }

                if (nextNode)
                {
                    var tmpArr;
                    if (stack.length === ++stackLastIndex)
                    {
                        tmpArr = new Array(5);
                        stack.push(tmpArr);
                    }
                    else
                    {
                        tmpArr = stack[stackLastIndex];
                        if (!tmpArr) tmpArr = stack[stackLastIndex] = new Array(4);
                    }

                    // setting values to child array
                    tmpArr[0] = nextNode;
                    tmpArr[1] = nextNodeValue;
                    tmpArr[2] = 0;
                    tmpArr[3] = 0;
                    tmpArr[4] = nextNode.priorUpdateNodes ? nextNode.priorUpdateNodes.length - 1 : -1;
                }

            } while (stackLastIndex !== -1);


            //////////////////////////////////////////////////////////////////
            // POST LOOP UPDATE
            var l = postLoopUpdate.length;
            var result, p;
            while (l--)
            {
                arrayItem = postLoopUpdate[l];
                domPointer = arrayItem.domPointer;

                // dom pointer may have been removed from DOM
                try
                {
                    p = domPointer.element.parentNode;
                    if (!p || !p.offsetParent)
                    {
                        while (p && p !== document.body) p = p.parentNode;
                        if (!p) continue; // element was removed from DOM
                    }
                }
                catch (e) // in case IE8 disposes the element
                {
                    continue;
                }


                // if
                if (domPointer.contentInfo === undefined)
                {
                    var firstValue = arrayItem.values[0];
                    if (firstValue.compiled) result = firstValue.compiled(firstValue.vars);
                    else result = firstValue;

                    if (!result)
                        domPointer.element.style.display = 'none';
                    else
                    {
                        if (domPointer.element.style.removeProperty)
                            domPointer.element.style.removeProperty('display');
                        else if (domPointer.element.style.removeAttribute)
                            domPointer.element.style.removeAttribute('display');
                        else
                            domPointer.element.style.display = '';
                    }
                }
                // text
                else if (typeof (domPointer.contentInfo) === 'string')
                {
                    //console.log(domPointer.id);
                    result = $internals.Parsers.parseText(domPointer.contentInfo, scope, 0, arrayItem.values);
                    if (domPointer.attribute)
                    {
                    	if (domPointer.attribute.name === "alloy-bind-html")
                    		domPointer.element.innerHTML = result.html;
                    	else
                    		domPointer.attribute.value = result.html;
                    }
                    else domPointer.element.nodeValue = result.html;
                }
                // inputs
                else if (domPointer.contentInfo instanceof Expression)
                {
                    if (domPointer.element.nodeName === "INPUT")
						domPointer.element.value = arrayItem.values[0];
                }
            }

            // clearing memory
            clearMemory(scope);


            /////////////////////////////////
            // updating children scopes:

            stack = scope.$childScopes;
            l = stack.length;
            var disposedChildren = 0;
            for(var i=0;i<l;++i)
            {
                if (stack[i].isDisposed()) ++disposedChildren;
                else $internals.Binder.update(stack[i]);
            }

            // if some were disposed, removing from list
            if (disposedChildren)
            {
                ll = l-disposedChildren;
                stack = new Array(ll);

                for(var i=0;i<l;++i)
                {
                    if (stack[i].isDisposed()) continue;
                    stack[--ll] = stack[i];
                }
                scope.$childScopes = stack;
            }

            // after update handler
            scope.afterUpdate();

            scope.$updating = false;
        }
        , dispose: function dispose(scope)
        {
            // removing html
            scope.$domElement.innerHTML = "";

            // disconnecting from parent
            scope.$parent = null;

            // disposing child scopes
            for (var i = 1; i < scope.$childScopes.length; ++i)
                scope.$childScopes[i].dispose();

            // adding to event (to dispose later)
            var evnts = scope.$registeredDomEvents;
            var l = evnts.length;
            while (l--)
            {
                // registering to event
                if (window.removeEventListener)
                    evnts[l].element.removeEventListener(evnts[l].name, evnts[l].func);
                else
                    evnts[l].element.detachEvent("on" + evnts[l].name, evnts[l].func);
            }
        }
    };
})();
;
    //////////////////////////////////////////////////////////////////
// Scope object
exports['Alloy.Scope'] = Alloy.Scope = Alloy.Base.extend({ name: "Scope" });

// static
Alloy.Scope.$staticBinding = {};
Alloy.Scope.bindGlobalStaticScope = function (tagName, scope)
{
    Alloy.Scope.$staticBinding[tagName.toUpperCase()] = scope;
}

// ctor / dtor
Alloy.Scope.prototype.ctor = function (model)
{
    this.$embedded = {};
    this.$model = model || {};
    this.$events = {};
}
Alloy.Scope.prototype.dtor = function ()
{
    // disposing things related to Binder
    $internals.Binder.dispose(this);
}

// internal methods

// methods
Alloy.Scope.prototype.getChildScope = function(childName)
{
    if (!this.$childScopesByName) return;
    return this.$childScopesByName[childName];
}
Alloy.Scope.prototype.setScopeClass = function (tagName, scope)
{
    if (!this.$tagToScopeClass) this.$tagToScopeClass = {};
    this.$tagToScopeClass[tagName.toUpperCase()] = scope;
}
Alloy.Scope.prototype.setModel = function (obj)
{
    var prev = this.$model;
    this.$model = obj;
    this.onModelChanged(prev);
    this.update();
}
Alloy.Scope.prototype.setModelProperty = function (obj, model)
{
    model = model || this.$model;
    for (var i in obj)
        model[i] = obj[i];
    this.update();
}
Alloy.Scope.prototype.childScopeCreated = function (childScope, domElement) { }
Alloy.Scope.prototype.beforeBind = function () { }
Alloy.Scope.prototype.afterBind = function (domElement) { }
Alloy.Scope.prototype.beforeUpdate = function () { }
Alloy.Scope.prototype.afterUpdate = function () { }
Alloy.Scope.prototype.onModelChanged = function (previousModel) { }
Alloy.Scope.prototype.setPhase = function (phase)
{
    this.$phase = phase;
    this.update();
}
Alloy.Scope.prototype.bind = function Alloy_Scope_Bind(domElement, template)
{
    // !!!!! Assuming all static scopes were binded !!!!!!!

    // getting dom element
    if (typeof (domElement) == 'string')
    {
        if (domElement.startsWith('#'))
            domElement = document.getElementById(domElement.substring(1));
        else
            domElement = document.querySelector(domElement);
    }
    if (!domElement) throw (this.__className__ + ".bind() - invalid domElement");

    // setting custom template
    if (template) domElement.setAttribute("alloy-template", template);

    // binding
    return $internals.Binder.bind(domElement, this);
}
Alloy.Scope.prototype.update = function Alloy_Scope_Update()
{
    $internals.Binder.update(this);
}

//create event.
Alloy.Scope.prototype.createEvent = function (event_name)
{
    //check name is given.
    if (!event_name) throw 'Event name is not provided.';
    event_name = event_name.toLowerCase();

    //check that the event is not already exists
    if (this.$events[event_name] != null) throw event_name + ' Event is already exists.';

    //create the new event.
    this.$events[event_name] = new Alloy.Event();
}

//register new handler for event.
Alloy.Scope.prototype.registerHandler = function (event_name, callback, context)
{
    if (this.isDisposed()) throw 'Cannot register to a disposed object event'; // events were unregistered on dispose

    //check name is given.
    if (!event_name) throw 'Event name is not provided.';
    event_name = event_name.toLowerCase();

    //check that the event is not already exists
    if (this.$events[event_name] == null) throw event_name + " Event dosen't exists.";

    // context is null if context is not provided
    if (typeof context == 'undefined') context = null;

    //check if callback is given.
    if (!callback) throw "Callback is not provided.";

    //register new handler
    this.$events[event_name].addHandler(callback, context);
}
Alloy.Scope.prototype.regiesterHandler = Alloy.Scope.prototype.registerHandler;

//remove event handler
Alloy.Scope.prototype.unregisterHandler = function (event_name, callback, context)
{
    if (this.isDisposed()) return; // events were unregistered on dispose

    //check name is given.
    if (!event_name) throw 'Event name is not provided';
    event_name = event_name.toLowerCase();

    //check that the event is not already exists
    if (this.$events[event_name] == null) throw event_name + " Event dosen't exists";

    //check if callback is given.
    if (!callback) throw "Callback is not provided.";

    //remove handler
    this.$events[event_name].removeHandler(callback, context);
}

// dispatch event
Alloy.Scope.prototype.dispatchEvent = function (event_name, params)
{
    if (this.isDisposed()) return;

    //check name is given.
    if (!event_name) throw this.__className__ + '.dispatch(): Event name is not provided';
    event_name = event_name.toLowerCase();

    //check that the event is not already exists
    var event = this.$events[event_name];
    if (event == null) throw this.__className__ + '.dispatch(): ' + event_name + " Event dosen't exists";

    if (!(params instanceof Array)) params = [params];

    //remove handler
    event.dispatch.apply(event, params);
}

// members
Alloy.Scope.prototype.$model = null;
Alloy.Scope.prototype.$embedded = null;

// "internal" members
Alloy.Scope.prototype.$tagToScopeClass = null;
Alloy.Scope.prototype.$domElement = null;
Alloy.Scope.prototype.$stack = null;
Alloy.Scope.prototype.$childScopes = null;
Alloy.Scope.prototype.$childScopesByName = null;
Alloy.Scope.prototype.$name = null;
Alloy.Scope.prototype.$parent = null;
Alloy.Scope.prototype.$phase = null;
Alloy.Scope.prototype.$updating = false;
Alloy.Scope.prototype.$events = null;
Alloy.Scope.prototype.$dependencies = null;
Alloy.Scope.prototype.$compiledEval = null;
Alloy.Scope.prototype.$registeredDomEvents = null;
Alloy.Scope.prototype.$updateCycle = 0;
;
    Alloy.MergeSort = Alloy.Base.extend({ name: "MergeSort" });
Alloy.MergeSort.prototype.sort = function MergeSort_sort(array, desc)
{
    this.$sort(array, 0, array.length, desc);
}
Alloy.MergeSort.prototype.$sort = function MergeSort_$sort(array, begin, end, desc)
{
    var size = end - begin;
    if (size < 2) return;

    var begin_right = begin + Math.floor(size / 2);

    this.$sort(array, begin, begin_right, desc);
    this.$sort(array, begin_right, end, desc);
    if (desc)
        this.$merge_desc(array, begin, begin_right, end);
    else
        this.$merge_asc(array, begin, begin_right, end);
}
Alloy.MergeSort.prototype.$merge_asc = function(array, begin, begin_right, end)
{
    var lastIndex = end - 1;
    for (; begin < begin_right; ++begin)
    {
        // if right item is bigger than left (in comparison -1 means left > right)
        if (this.$comparer(array[begin], array[begin_right]) === -1)
        {
            var v = array[begin];
            array[begin] = array[begin_right];
            if (begin_right === lastIndex)
            {
                array[begin_right] = v;
            }
            else
            {
                // finding insert position
                var targetIndex = this.$binaryIndexOf_asc(array, v, begin_right, lastIndex);
                
                // bubbling all
                var startingIndex = begin_right;
                for (; startingIndex < targetIndex; ++startingIndex)
                    array[startingIndex] = array[startingIndex + 1];
                array[targetIndex] = v;
            }
        }
    }
}
Alloy.MergeSort.prototype.$merge_desc = function(array, begin, begin_right, end)
{
    var lastIndex = end - 1;
    for (; begin < begin_right; ++begin)
    {
        // if right item is bigger than left (in comparison +1 means left < right)
        if (this.$comparer(array[begin], array[begin_right]) === 1)
        {
            var v = array[begin];
            array[begin] = array[begin_right];
            if (begin_right === lastIndex)
            {
                array[begin_right] = v;
            }
            else
            {
                // finding insert position
                var targetIndex = this.$binaryIndexOf_desc(array, v, begin_right, lastIndex);

                // bubbling all
                var startingIndex = begin_right;
                for (; startingIndex < targetIndex; ++startingIndex)
                    array[startingIndex] = array[startingIndex + 1];
                array[targetIndex] = v;
            }
        }
    }
}
Alloy.MergeSort.prototype.$comparer = function MergeSort_$comparer(a, b)
{
    if (a > b) return -1;
    else if (a < b) return 1;
    return 0;
}
Alloy.MergeSort.prototype.$binaryIndexOf_asc = function MergeSort_$binaryIndexOf(array, element, minIndex, maxIndex)
{
    minIndex = minIndex || 0;
    maxIndex = maxIndex || array.length - 1;

    // normal loop
    if (maxIndex - minIndex < 10)
    {
        for(;minIndex<=maxIndex;++minIndex)
        {
            var cmp = this.$comparer(element, array[minIndex]);
            switch (cmp)
            {
                case 0:
                    return minIndex;
                case 1: // array[minIndex] > element
                    return minIndex - 1;
            }
        }
        return maxIndex;
    }

    var currentIndex;
    var currentElement;
    var resultIndex;

    while (minIndex <= maxIndex)
    {
        resultIndex = currentIndex = (minIndex + maxIndex) / 2 | 0;
        currentElement = array[currentIndex];
        var cmp = this.$comparer(element, currentElement);

        // if element > current Element
        if (cmp == -1)
            minIndex = currentIndex + 1;
        else if (cmp == 1)
            maxIndex = currentIndex - 1;
        else
            return currentIndex;
    }
    return maxIndex;
}
Alloy.MergeSort.prototype.$binaryIndexOf_desc = function MergeSort_$binaryIndexOf(array, element, minIndex, maxIndex)
{
    minIndex = minIndex || 0;
    maxIndex = maxIndex || array.length - 1;

    // normal loop
    if (maxIndex - minIndex < 10)
    {
        for (; minIndex <= maxIndex; ++minIndex)
        {
            var cmp = this.$comparer(element, array[minIndex]);
            switch (cmp)
            {
                case 0:
                    return minIndex;
                case -1: // array[minIndex] < element
                    return minIndex - 1;
            }
        }
        return maxIndex;
    }

    var currentIndex;
    var currentElement;
    var resultIndex;

    while (minIndex <= maxIndex)
    {
        resultIndex = currentIndex = (minIndex + maxIndex) / 2 | 0;
        currentElement = array[currentIndex];
        var cmp = this.$comparer(element, currentElement);

        // if element > current Element
        if (cmp == 1)
            minIndex = currentIndex + 1;
        else if (cmp == -1)
            maxIndex = currentIndex - 1;
        else
            return currentIndex;
    }
    return maxIndex;
}
/////////////////////////////////////////////////////////////////////////////
// string comparer
Alloy.MergeSort_String = Alloy.MergeSort.extend({ name: "MergeSort_String" });
Alloy.MergeSort_String.prototype.$comparer = function MergeSort_$comparer(a, b)
{
    return Alloy.MergeSort_String.strCmp(a, b);
}
Alloy.MergeSort_String.strCmp = function strCmp(a, b)
{
    var min = a.length < b.length ? a.length : b.length;
    for (var i = 0; i < min; ++i)
    {
        var c1 = a.charCodeAt(i);
        var c2 = b.charCodeAt(i);
        if (c1 == c2) continue;

        // lower case
        if (c1 > 90) c1 -= 32; // (90 is capital Z, 32 is the diff between upper and lower case)
        if (c2 > 90) c2 -= 32; // (90 is capital Z, 32 is the diff between upper and lower case)

        if (c1 > c2) return -1;  // a is bigger
        else if (c1 < c2) return 1; // b is bigger
    }

    if (a.length == b.length) return 0;
    else if (a.length > b.length) return -1; // a is bigger
    else return 1; // b is bigger
};
    $internals.Com = Alloy.Com =
{
    SUCCESS: 200
    ,FAIL: 400
    ,TIMEOUT: 500
    ,enumMethod: { GET: 'GET', POST: 'POST' }
    , cbId: new Date().getTime() % 1000
};



Alloy.ajax = function(info)
{
    // info: {url, method, headers, timeout, data, handler}

    // creating object
    var xmlhttp = null;
    if (typeof (XMLHttpRequest) === 'function' || typeof (XMLHttpRequest) === 'object')
        xmlhttp = new XMLHttpRequest();
    else
        throw "Cannot create ajax object";

    // openning request
    if (info.method == $internals.Com.enumMethod.GET && info.data) info.url += "?" + info.data;
    xmlhttp.open(info.method, info.url, true);

    // headers
    if (info.headers) for (var n in info.headers) xmlhttp.setRequestHeader(n, info.headers[n]);

    // registering success
    xmlhttp.onreadystatechange = function ()
    {
        switch (this.readyState)
        {
            case 4:
                ready($internals.Com.SUCCESS);
                break;
        }
    };
    xmlhttp.onerror = function ()
    {
        ready($internals.Com.FAIL);
    }
    xmlhttp.onload = function ()
    {
        ready($internals.Com.SUCCESS);
    };

    //////////////////////////////////////////////////////////////////////////
    var ready = function (status)
    {
        if (!running) return;
        clearTimeout(timer);
        running = false;

        // status
        var tmpStatus = -1;
        try
        {
            var tmpStatus = xmlhttp.status;
            if (!tmpStatus) tmpStatus = 400;
        }
        catch (e)
        {
            if (timeout) tmpStatus = -1;
            else tmpStatus = 400;
        }

        var text = "";
        switch (tmpStatus)
        {
            case 200:
                status = $internals.Com.SUCCESS;
                text = xmlhttp.responseText || "";
                break;
            case 400:
            case 403:
            case 404:
                status = $internals.Com.FAIL;
                break;
            default:
                if (timeout) status = $internals.Com.TIMEOUT;
                else status = $internals.Com.FAIL;
                break;
        }

        // firing handler
        info.handler(status, text);
    };
    var timer = setTimeout(function ()
    {
        if (!running) return; // already handled
        timeout = true;
        xmlhttp.abort();

        /// when 'aborting' a request in OPERA browser,
        /// sometimes it closes the request with an empty 200 response && sometimes it doesn't close the request (didn't find the logical explanation).
        /// if the request was closed with an empty 200 (and the response was handled), not calling directly to 'handleResponse()'
        if (running) ready($internals.Com.TIMEOUT);

    }, (info.timeout || 10000));

    var running = true;
    var timeout = false;

    // sending the request
    if (info.method === $internals.Com.enumMethod.POST)
        xmlhttp.send(info.data);
    else
        xmlhttp.send(null); // firefox 3.0 requires 'null'
}



var activeRequests = {};
Alloy.jsonp = function(obj)
{
    var functionName = "_jspcb" + (Alloy.Com.cbId++);
    if (obj.cb) functionName = obj.cb;

    // if rquests exits, cancelling it
    if (activeRequests[functionName])
    {
    	console.log('removed!');
    	// removing element from DOM
    	var elem = activeRequests[functionName];
        var pn = elem.parentNode;
        if (pn) pn.removeChild(elem);
    }


    window[functionName] = function (jsonResponse)
    {
        // clearing timeout
        clearTimeout(timer);
        // firing handler
        if (Alloy.Base.isDerivedOf(obj.handler, Alloy.Handler))
            obj.handler.handle($internals.Com.SUCCESS, jsonResponse, obj);
        else
            obj.handler($internals.Com.SUCCESS, jsonResponse, obj);

        // deleting reference
        try
        {
            delete window[functionName];
        }
        catch (e)
        {
            window[functionName] = undefined;
        }

        // removing element from DOM
        var pn = elem.parentNode;
        if (pn) pn.removeChild(elem);
        delete activeRequests[functionName];

        // repeat?
        if (typeof(obj.repeat) === 'number' && obj.repeat)
            setTimeout(function () { obj.repeat = 0; Alloy.jsonp(obj); }, obj.repeat);
        else if (obj.handler.dispose)
            obj.handler.dispose();
    }

    // building params
    var sb = [];
    sb.push(obj.url);
    if (obj.url.contains("?")) sb.push("&");
    else sb.push("?");
    sb.push(obj.callback_arg || "cb");
    sb.push("=");
    sb.push(functionName);
    if (obj.params) for (var parm in obj.params)
        {
        if (obj.params[parm] == null) continue; // skipping null params
        sb.push('&');
        sb.push(encodeURIComponent(parm));
        sb.push('=');
        sb.push(encodeURIComponent(obj.params[parm]));
    }

    // sending request
    var elem = document.createElement("script");
    elem.type = 'text/javascript';
    elem.async = true;
    elem.defer = true;
    elem.src = sb.join('');
	elem.onload = function()
    {
    	clearTimeout(timer); // script was loaded
    }
    elem.onreadystatechange = function()
    {
    	if (this.readyState !== 'complete' && this.readyState !== 'loaded') return;
    	clearTimeout(timer); // script was loaded
    }
    activeRequests[functionName] = elem;
    document.getElementsByTagName("head")[0].appendChild(elem);

    // setting timeout
    var timeout = function ()
    {
        // removing elem from dom
        var pn = elem.parentNode;
        if (pn) pn.removeChild(elem);
        delete activeRequests[functionName];

        window[functionName] = function () { };
        // firing handler
        if (Alloy.Base.isDerivedOf(obj.handler, Alloy.Handler))
            obj.handler.handle($internals.Com.TIMEOUT, null, obj);
        else
            obj.handler($internals.Com.TIMEOUT, null, obj);

        // repeat?
        if (typeof (obj.repeat) === 'number' && obj.repeat)
            setTimeout(function () { obj.repeat = 0; Alloy.jsonp(obj); }, obj.repeat);
        else if (obj.handler.dispose)
            obj.handler.dispose();
    }
    var timer = setTimeout(timeout, obj.timeout || 10000);
}
;
    Alloy.Plugins = (function ()
{
    var knownPlugins = {};

    return {
        register: function(name, obj)
        {
            var plugin = knownPlugins[name];
            if (plugin) throw name + " plugin was created already";

            // adding to plugins
            knownPlugins[name] = obj;

            // creating the init function
            obj.init();
        }
        , get: function(name, argsString)
        {
            var plugin = knownPlugins[name];
            if (!plugin) return;

            // parsing arguments


            // calling method
            plugin.onCall();
        }
    }

})()
;


    // loading unittests
    if (Alloy.runningMode !== 0)
    {
        Alloy.$di(["/common/alloy/alloy.unitest.js"], function () { if (arguments[0][0].status) { Alloy.UnitTest.run(); } });
    }
    // loading profiler
    if (Alloy.runningMode === 3)
    {
        Alloy.$di(["/common/alloy/alloy.profiler.js"], function () { });
    }


    // exporting (for closure compiler)
    var objectPointers = [];
    for(var i in exports)
    {
        var splt = i.split('.');
        var ndx = 1;
        var obj = Alloy; // always starting with Alloy
        while (ndx !== splt.length)
        {
            var tmp = splt[ndx++];
            if (ndx === splt.length) // last point, taking pointer
            {
                obj[tmp] = exports[i];
                objectPointers[tmp] = exports[i];
            }
            else
            {
                obj = objectPointers[tmp];
            }
        }
    }


    return Alloy;
})();
window['Alloy'] = Alloy;


;
}

// setting references
Alloy.runningMode = debugLevel;
ISQ.Base = Alloy.Base;
ISQ.Event = Alloy.Event;
ISQ.Handler = Alloy.Handler;
ISQ.Timer = Alloy.Timer;</script><style type="text/css">alloy-embedded-data {display:none}</style><style type="text/css">ALLOY-EMBEDDED-DATA {display:none}</style>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
// Extensions

///////////////////////////////////////////
/////////// [DATE] ///////////
///////////////////////////////////////////
Date.prototype.ToString = function (format, uiLocalization, UTC)
{
    format = format + "";
    UTC = UTC || false;
    var output = new Array();
    var part;
    for (var i = 0; i < format.length; ++i)
    {
        var c = format.charAt(i);
        // parsing part
        if (c === '%' && i !== format.length - 1)
        {
            part = format.charAt(++i);
            switch (part)
            {
                case 'd':
                    var day = UTC ? this.getUTCDate() : this.getDate();
                    if (day < 10) day = "0" + day;
                    output.push(day);
                    break;
                case 'm':
                    var mo = "";
                    if (format.charAt(i + 1) === "m") // %mm (month name)
                    {
                        ++i;
                        mo = UTC ? this.getUTCMonth() : this.getMonth() + 1;
                        switch (mo)
                        {
                            case 1:
                                if (uiLocalization)
                                    mo = uiLocalization["jan"];
                                else
                                    mo = "Jan";
                                break;
                            case 2:
                                if (uiLocalization)
                                    mo = uiLocalization["feb"];
                                else
                                    mo = "Feb";
                                break;
                            case 3:
                                if (uiLocalization)
                                    mo = uiLocalization["mar"];
                                else
                                    mo = "Mar";
                                break;
                            case 4:
                                if (uiLocalization)
                                    mo = uiLocalization["apr"];
                                else
                                    mo = "Apr";
                                break;
                            case 5:
                                if (uiLocalization)
                                    mo = uiLocalization["may"];
                                else
                                    mo = "May";
                                break;
                            case 6:
                                if (uiLocalization)
                                    mo = uiLocalization["jun"];
                                else
                                    mo = "Jun";
                                break;
                            case 7:
                                if (uiLocalization)
                                    mo = uiLocalization["jul"];
                                else
                                    mo = "Jul";
                                break;
                            case 8:
                                if (uiLocalization)
                                    mo = uiLocalization["aug"];
                                else
                                    mo = "Aug";
                                break;
                            case 9:
                                if (uiLocalization)
                                    mo = uiLocalization["sep"];
                                else
                                    mo = "Sep";
                                break;
                            case 10:
                                if (uiLocalization)
                                    mo = uiLocalization["oct"];
                                else
                                    mo = "Oct";
                                break;
                            case 11:
                                if (uiLocalization)
                                    mo = uiLocalization["nov"];
                                else
                                    mo = "Nov";
                                break;
                            case 12:
                                if (uiLocalization)
                                    mo = uiLocalization["dec"];
                                else
                                    mo = "Dec";
                                break;
                        }
                    }
                    else
                    {
                        mo = UTC ? this.getUTCMonth() : this.getMonth() + 1;
                        if (mo < 10) mo = "0" + mo;
                    }
                    output.push(mo);
                    break;
                case 'y':
                    var year = this.getYear();
                    // adding 1900 to the year to all non IE browsers, IE9/10, and Opera version >= 10.52
                    if ((ISQ.Http.browser.app !== 'ie' || ISQ.Http.browser.isIE9 || ISQ.Http.browser.isIE10 || ISQ.Http.browser.isIE11) && (!ISQ.Http.browser.isOpera || ISQ.Http.browser.full >= "opera10.52")) year += 1900;
                    output.push(year);
                    break;
                case 'Y':
                    var year = this.getYear();
                    // adding 1900 to the year to all non IE browsers, IE9/10, and Opera version >= 10.52
                    if ((ISQ.Http.browser.app !== 'ie' || ISQ.Http.browser.isIE9 || ISQ.Http.browser.isIE10 || ISQ.Http.browser.isIE11) && (!ISQ.Http.browser.isOpera || ISQ.Http.browser.full >= "opera10.52")) year += 1900;
                    if(year)
                        output.push(year.toString().substr(2, 2));
                    break;
                case 'H':
                    var ho = UTC ? this.getUTCHours() : this.getHours();
                    if (ho < 10) ho = "0" + ho;
                    output.push(ho);
                    break;
                case 'M':
                    var mi = UTC ? this.getUTCMinutes() : this.getMinutes();
                    if (mi < 10) mi = "0" + mi;
                    output.push(mi);
                    break;
                case 'S':
                    var so = UTC ? this.getUTCSeconds() : this.getSeconds();
                    if (so < 10) so = "0" + so;
                    output.push(so);
                    break;
                case "t":
                    var so = UTC ? this.getUTCMilliseconds() : this.getMilliseconds();
                    if (so < 10) so = "0" + so;
                    output.push(so);
                    break;
                default:
                    output.push(format.charAt(i - 1));
                    output.push(format.charAt(i));
                    break;
            }
        }
        else
        {
            output.push(c);
        }
    }
    return output.join('');
};


///////////////////////////////////////////
/////////// [STRING] ///////////
///////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
// checks if part of the string equals another string
String.prototype.equals = function (string, startingIndex, ignoreCase)
{
    if (!startingIndex) startingIndex = 0;
    if (startingIndex + string.length > this.length) return false;

    var ndx = 0;
    var max = startingIndex + string.length;
    for (var i = startingIndex; i < max; ++i, ++ndx)
    {
        var c1 = this.charCodeAt(i);
        var c2 = string.charCodeAt(ndx);
        if (c1 === c2) continue;
        if (!ignoreCase) return false;
        // lower case
        if (c1 > 90) c1 -= 32; // (90 is capital Z, 32 is the diff between upper and lower case)
        if (c2 > 90) c2 -= 32; // (90 is capital Z, 32 is the diff between upper and lower case)
        if (c1 !== c2) return false;
    }
    return true;
}
String.prototype.startsWith = function (sub)
{
    if (this.length < sub.length) return false;
    for (var i = 0; i < sub.length; ++i)
    {
        if (this.charAt(i) !== sub.charAt(i)) return false;
    }
    return true;
};
String.prototype.endsWith = function (sub)
{
    if (this.length < sub.length) return false;
    var subNdx = sub.length - 1;
    for (var i = this.length - 1; i > this.length - 1 - sub.length; --i)
    {
        if (sub.charAt(subNdx--) !== this.charAt(i)) return false;
    }
    return true;
};
String.prototype.contains = function (txt)
{
    return this.indexOf(txt) !== -1;
};
String.prototype.Trim = function (sub)
{
    if (sub)
    {
        var startAt = this.startsWith_repeat(sub);
        if (startAt < this.length)
        {
            var endAt = this.endsWith_repeat(sub);

            if (startAt != 0 || endAt != this.length - 1)
                return this.substring(startAt, endAt + 1);
            else
                return this.toString();
        }
        else return "";
    }
    else
    {
        // removing from start
        var index = 0;
        var endIndex = this.length;
        for (; /\s/.test(this.charAt(index)) && index < endIndex; ++index) { };

        // empty string
        if (index == endIndex) return "";

        // removing from end
        for (; /\s/.test(this.charAt(endIndex - 1)) ; --endIndex) { };

        if (index == 0 && endIndex == this.length) return this + ""; // new string
        return this.substring(index, endIndex);
    }
};
String.prototype.startsWith_repeat = function (sub)
{
    if (this.length < sub.length) return 0;
    var x = 0;
    var i = 0;
    for (; i < this.length; i++)
    {
        if (this.charAt(i) != sub.charAt(x))
        {
            i -= x;
            break;
        }
        if (x == sub.length - 1)
            x = 0;
        else
            x++;
    }
    return i;
}

String.prototype.endsWith_repeat = function (sub)
{
    if (this.length < sub.length) return this.length;
    var x = sub.length - 1;
    var i = this.length - 1;

    for (; i > 0; i--)
    {
        if (this.charAt(i) != sub.charAt(x))
        {
            i += x;
            break;
        }
        if (x == 0)
            x = sub.length - 1;
        else
            x--;
    }
    return i;
}
//////////////////////////////////////////////////////////////////////////
// string - the text to search in. searches BACKWARDS
// txt - the text to search for
// start - the char index the text where search starts. default: the last char of the string
String.prototype.LastIndexOf = function (txt, start)
{
    if (this.length === 0 || txt === null) return -1;
    if (txt.length > this.length) return -1;
    if (isNaN(start)) start = this.length - txt.length;

    var found = false;
    for (var i = start; i >= 0; --i)
    {
        found = true;
        for (var wordNdx = 0; wordNdx < txt.length; ++wordNdx)
        {
            if (this.charAt(i + wordNdx) !== txt.charAt(wordNdx))
            {
                found = false;
                break;
            }
        }
        if (found) return i;
    }

    return -1;
}
//////////////////////////////////////////////////////////////////////////
// string - the text to search in. searches BACKWARDS
// char - the char to find
String.prototype.LastIndexOf_char = function (chr, start)
{
	start = start || this.length - 1;
	for (var i = start; i >= 0; --i)
        if (this.charAt(i) === chr) return i;
    return -1;
}

//////////////////////////////////////////////////////////////////////////
// sets the char at the given index
String.prototype.setCharAt = function (index, chr)
{
    if (index > this.length - 1) return str;
    return this.substr(0, index) + chr + this.substr(index + 1);
}

//////////////////////////////////////////////////////////////////////////
// counts an appearance of a char
String.prototype.countCharAppearances = function (chr)
{
    var count = 0;
    for (var i = 0; i < this.length; ++i)
    {
        if (this.charAt(i) == chr) ++count;
    }
    return count;
}

//////////////////////////////////////////////////////////////////////////
// checks if part of the string equals another string
String.prototype.indexOfAny = function (strings, startingIndex)
{
    var firstIndex = this.length;
    for (var i = 0; i < strings.length; ++i)
    {
        var pos = this.indexOf(strings[i], startingIndex);
        if (pos != -1 && pos < firstIndex) firstIndex = pos;
    }
    if (firstIndex == this.length) return -1;
    return firstIndex;
}


//////////////////////////////////////////////////////////////////////////
// replaces all occurrences and adjacent occurrences of chr with 1 occurrence of newChr
String.prototype.replaceMultipleOccurancesWithOne = function (chr, newChr)
{
    var ndx = this.indexOf(chr);
    if (ndx === -1) return this.toString();
    var sb = [];
    var lastNdx = ndx;
    var tmpChar;
    for (var i = 0; i < this.length; ++i)
    {
        tmpChar = this.charAt(i);
        if (tmpChar !== chr)
        {
            sb.push(tmpChar);
        }
        else
        {
            if (lastNdx != i - 1) // non adjacent occurrence
                sb.push(newChr);
            lastNdx = i;
        }
    }
    return sb.join('');
}

//////////////////////////////////////////////////////////////////////////
// usage example: data -> [{from:"a", to: "b"}, {from:"c", to: "d"}]
String.prototype.replacer = function (data)
{
    var sb = null;
    for (var i = 0; i < this.length; ++i)
    {
        var j;
        for (j = 0; j < data.length; ++j)
        {
            
            if (this.charAt(i) === data[j].from)
            {
                if (!sb)
                {
                    sb = [];
                    sb.push(this.substring(0, i));
                }
                if (data[j].to) sb.push(data[j].to);
                break;
            }
        }
        if (j === data.length && sb) sb.push(this.charAt(i));
    }
    if (sb)
        return sb.join('');
    else
        return this;
}

//////////////////////////////////////////////////////////////////////////
String.prototype.escaper = function ()
{
    return this.replacer(String.escapeData);
}
String.escapeData = [
    {
        from: '\r',
        to: '\\r'
    },
    {
        from: '\n',
        to: '\\n'
    },
    {
        from: '\t',
        to: '\\t'
    },
    {
        from: "'",
        to: "\'"
    },
    {
        from: '"',
        to: '\\"'
    },
    {
        from: '\\',
        to: '\\\\'
    }
];

//////////////////////////////////////////////////////////////////////////
String.prototype.replaceAll = function (str1, str2, ignore)
{
    if (typeof (ignore) === 'undefined') ignore = true;
    return this.replace(new RegExp(str1.replace(/([\/\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g, "\\$&"), (ignore ? "gi" : "g")), (typeof (str2) == "string") ? str2.replace(/\$/g, "$$$$") : str2);
}
// uppercase only the first letter
String.prototype.firstLetterUpperCase = function ()
{
    return this.charAt(0).toUpperCase() + this.slice(1);
}


//////////////////////////////////////////////
//// QUERY SELECTOR POLYFILL (IE7-)
if (!document.querySelectorAll)
{
    document.querySelectorAll = function (selectors)
    {
        var style = document.createElement('style'), elements = [], element;
        document.documentElement.firstChild.appendChild(style);
        document._qsa = [];

        style.styleSheet.cssText = selectors + '{x-qsa:expression(document._qsa && document._qsa.push(this))}';
        window.scrollBy(0, 0);
        style.parentNode.removeChild(style);

        while (document._qsa.length)
        {
            element = document._qsa.shift();
            element.style.removeAttribute('x-qsa');
            elements.push(element);
        }
        document._qsa = null;
        return elements;
    };
}
if (!document.querySelector)
{
    document.querySelector = function (selectors)
    {
        var elements = document.querySelectorAll(selectors);
        return (elements.length) ? elements[0] : null;
    };
}</script>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
ISQ.Tools = initializeNS('ISQ.Tools');
ISQ.Tools.stateEnum = { KEY: 5, VALUE: 6 };


//#region Converters
ISQ.Tools.stringToPairArray = function (string, keyDelimiter, valueDelimiter, toLowerCaseKey, toLowerCaseValue)
{
    var l = string.length;
    if (l === 0) return null;

    var result = new Array();

    toLowerCaseKey = toLowerCaseKey !== false;
    toLowerCaseValue = toLowerCaseValue !== false;

    var state = ISQ.Tools.stateEnum.KEY;
    var lastKey = '';
    var collected = new Array();
    var ndx = 0;
    while (ndx < l)
    {
        switch (state) // 1 = key, 2 = value
        {
            case ISQ.Tools.stateEnum.KEY:
                if (string.charAt(ndx) !== keyDelimiter)
                {
                    collected.push(string.charAt(ndx));
                }
                else
                {
                    state = ISQ.Tools.stateEnum.VALUE;
                    lastKey = ISQ.Tools.getStringValue(collected, toLowerCaseKey);
                    collected = new Array();
                }
                break;
            case ISQ.Tools.stateEnum.VALUE:
                if (string.charAt(ndx) !== valueDelimiter)
                {
                    collected.push(string.charAt(ndx));
                }
                else
                {
                    state = ISQ.Tools.stateEnum.KEY;
                    result[lastKey] = ISQ.Tools.getStringValue(collected, toLowerCaseValue);
                    collected = new Array();
                }
                break;
        }
        ++ndx;
    }
    // saving last value (if wasn't saved)
    if (state === ISQ.Tools.stateEnum.VALUE) result[lastKey] = ISQ.Tools.getStringValue(collected);

    // returning result
    return result;
}
ISQ.Tools.getStringValue = function (collectedArr, lowerCase)
{
    lowerCase = lowerCase === true;
    var value = unescape(collectedArr.join('').toString()).Trim();
    if (lowerCase) value = value.toLowerCase();
    return value;
}
ISQ.Tools.getNumber = function (str, isNaN_defaultValue)
{
    var type = typeof (str);
    if (typeof (str) === 'number') return str;
    if (typeof (str) !== 'string') str = str.toString();

    var num;
    if (str.contains("."))
        num = parseFloat(str);
    else
        num = parseInt(str);

    if (isNaN(num)) return typeof (isNaN_defaultValue) === 'number' ? isNaN_defaultValue : NaN;
    return num;
}
ISQ.Tools.verifyNumber = function (str)
{
    var num = ISQ.Tools.getNumber(str);
    if (isNaN(num)) throw ("ISQ.Tools.verifyNumber: given value is not a number");
}
ISQ.Tools.getEnumValue = function (Enum, value)
{
    if (typeof (Enum) !== 'object' || value === null) return null;

    for (var enumValue in Enum)
    {
        if (Enum[enumValue] == value) return enumValue;
    }

    return null;
};

// input ex.: rgb(255,155,30,0) where the last 0 is the opacity
ISQ.Tools.getOpacityFromRGBA = function (str)
{
    if (str === "transparent") return 0;
    var ndx = str.LastIndexOf(",");
    if (ndx === -1) throw ("ISQ.Tools.getOpacityFromRGBA(): Invalid string");
    if (str.countCharAppearances(",") === 2) return 100; // no specific opacity, returning default 100
    str = str.substring(ndx + 1);
    return parseInt(str);
};

ISQ.Tools.RGBtoHex = function (R, G, B)
{
    return ISQ.Tools.toHex(R) + ISQ.Tools.toHex(G) + ISQ.Tools.toHex(B);
};
ISQ.Tools.RGBtoHex2 = function (rgb)
{
    rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    return "#" + ISQ.Tools.toHex(rgb[1]) + ISQ.Tools.toHex(rgb[2]) + ISQ.Tools.toHex(rgb[3]);
};
ISQ.Tools.toHex = function (N)
{
    if (typeof (N) === 'string') N = parseInt(N);
    if (typeof (N) !== 'number' || N === 0) return "00";

    N = Math.max(0, N);
    N = Math.min(N, 255);
    N = Math.round(N);

    return "0123456789ABCDEF".charAt((N - N % 16) / 16) + "0123456789ABCDEF".charAt(N % 16);
};
ISQ.Tools.hexToRGB = function (hex)
{
    var res = { r: -1, g: -1, b: -1 };

    hex = (hex.charAt(0) == "#") ? hex.substring(1) : hex;
    res.r = parseInt(hex.substring(0, 2), 16);
    res.g = parseInt(hex.substring(2, 4), 16);
    res.b = parseInt(hex.substring(4, 6), 16);
    return res;
};
ISQ.Tools.getPrettyNumber = function (num, decimalPoints, formatStorageSize, kForThousands)
{
    // EXPLANATION ABOUT DECIMAL POINTS IN SECTION B

    // no need for thousand separator
    num = parseFloat(num);
    if (isNaN(num)) return num;

    //////////////////////////////////////////////////////////////////////////
    // SECTION A: metric prefix (K, M)
    var suffix = "";
    if (formatStorageSize)
    {
        if (num >= 1073741824) //Giga
        {
            num = num / 1073741824;
            suffix = "GB";
        }
        else if (num >= 1048576) //Mega
        {
            num = num / 1048576;
            suffix = "MB";
        }
        else if (num >= 1024) //Kilo
        {
            num = num / 1024;
            suffix = "KB";
        }
        else
        {
            suffix = "B";
        }
        //         return (num / 1000000).toFixed(1) + 'M';
        //         if (num > 1048576)
        //             return (num / 1000000).toFixed(1) + 'M';
        //         if (num > 1000)
        //             return (num / 1000).toFixed(1) + 'K';
    }
    else if (kForThousands && num >= 1000)
    {
        num = num / 1000;
        suffix = "K";
    }

    //////////////////////////////////////////////////////////////////////////
    // SECTION B: handling decimal points
    if (isNaN(decimalPoints) && decimalPoints !== true && decimalPoints !== false)
        decimalPoints = true;  // default: adaptive
    switch (decimalPoints)
    {
        case false:
            // leaving number as is
            break;
        case 0:
            // trimming decimal points
            num = parseInt(num);
            break;
        case true: // adaptive
            if (Math.abs(num) < 10)
                decimalPoints = 2;
            else if (Math.abs(num) < 100)
                decimalPoints = 1;
            else
                decimalPoints = 0;

            num = num.toFixed(decimalPoints); // applying decimal points
            break;
        default: // specified decimal points
            num = num.toFixed(decimalPoints);
            break;
    }

    // removing all-zero decimal points
    if (num % 1 === 0) num = parseInt(num);


    // splitting number to decimal points and digit
    // and removing unnecessary decimal points
    var str = num + "";
    var decimalPointsSTR = null;
    var ndx = str.indexOf(".");
    if (ndx !== -1)
    {
        decimalPointsSTR = str.substr(ndx);
        var zeroStreak = -1;
        for (var i = 0; i < decimalPointsSTR.length; ++i)
        {
            if (decimalPointsSTR.charAt(i) === '0')
            {
                if (zeroStreak == -1) zeroStreak = i;
            }
            else
            {
                zeroStreak = -1;
            }
        }
        if (zeroStreak != -1) decimalPointsSTR = decimalPointsSTR.substr(0, zeroStreak);
        // ALL decimal points was removed
        if (decimalPointsSTR.length === 1) decimalPointsSTR = null;

        // 
        str = str.substr(0, ndx);
    }

    //////////////////////////////////////////////////////////////////////////
    // SECTION C: adding thousands separator
    num = parseInt(str);
    if ((num / 1000) >= 1)
    {
        var answer = new Array(str.length + Math.floor((str.length - 1) / 3));
        var newNdx = answer.length;
        var count = 0;
        for (var i = str.length - 1; i > -1; --i)
        {
            if (i < str.length - 1 && count % 3 === 0)
            {
                answer[newNdx--] = ",";
            }
            answer[newNdx--] = str.charAt(i);
            ++count;
        }
    }
    else
    {
        answer = [];
        answer.push(num);
    }

    //////////////////////////////////////////////////////////////////////////
    // SECTION D: adding DP and suffix
    // adding decimal points
    if (decimalPointsSTR !== '') answer.push(decimalPointsSTR);
    // adding suffix
    if (suffix) answer.push(suffix);

    return answer.join('');
}
//////////////////////////////////////////////////////////////////////////
// formats percentage with the right amount of decimal places
ISQ.Tools.formatPercentage = function (val)
{
    var result;
    var absValue = Math.abs(val);

    // k for thousands
    if (absValue > 1000)
        result = (val / 1000).toFixed(0) + 'K ';
    else if (absValue < 1)
        result = val.toFixed(2);
    else if (absValue < 10)
        result = val.toFixed(1);
    else
        result = val.toFixed(0);

    return result + "%";
}
ISQ.Tools.toArray = function (obj)
{
    if (obj instanceof Array) return obj;

    var a = new Array();
    if (typeof (obj.length) !== 'number')
        a.push(obj);
    else
    {
        var i;
        // maybe hash
        if (obj.length === 0)
        {
            for (i in obj)
                a[i] = obj[i];
        }
        else
        {
            if (obj.length > 10000)
            {
                _debug().insertText("Error converting object to an array. Object length: " + obj.length);
                return new Array();
            }
            for (i = 0; i < obj.length; ++i)
            {
                a[i] = obj[i];
            }
        }
    }

    return a;
}

ISQ.Tools.getDateTicks = function (dateString, format, hours, minutes, seconds)
{
    dateString = dateString.Trim();
    if (dateString === "") return -1;

    var day, month, year;
    var ndx = format.indexOf("dd");
    day = dateString.substr(ndx, 2);
    if (isNaN(day)) return -1;

    ndx = format.indexOf("mm");
    month = dateString.substr(ndx, 2);
    if (isNaN(month)) return -1;

    ndx = format.indexOf("yyyy");
    if (ndx === -1) ndx = format.indexOf("yy");
    year = dateString.substr(ndx, 4);
    if (isNaN(year)) return -1;

    // add hours, minutes and seconds if provided, or the values of now
    var now = new Date();
    hours = typeof (hours) == 'undefined' ? now.getHours() : hours;
    minutes = typeof (minutes) == 'undefined' ? now.getMinutes() : minutes;
    seconds = typeof (seconds) == 'undefined' ? now.getSeconds() : seconds;

    var D = new Date(year, month - 1, day, hours, minutes, seconds);
    return Date.UTC(D.getUTCFullYear(), D.getUTCMonth(), D.getUTCDate(), D.getUTCHours(),
    D.getUTCMinutes(), D.getUTCSeconds());
}

//////////////////////////////////////////////////////////////////////////
// converts numeric ip to string
ISQ.Tools.getIPString = function (num)
{
    var inverted = false; //IP numeric value might have been inverted due to server bug
    if (num < 0)
    {
        num = -num;
        inverted = true;
    }

    var result = new Array();
    if (inverted)
        result.push(256 - (num % 256));
    else
        result.push(num % 256);

    for (var i = 2; i >= 0; i--)
    {
        num = Math.floor(num / 256);
        result.push(".");
        if (inverted)
            result.push(255 - (num % 256));
        else
            result.push(num % 256);
    }
    return result.join('');
}
//////////////////////////////////////////////////////////////////////////
// converts string to numberic ip, returns null if invalid
ISQ.Tools.getIPNum = function (ipStr)
{
	var match = ipStr.match(/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/);
	if (match)
	{
		var ip = 0, octet;
		for (var i = 1; i <= 4; i++)
		{
			octet = parseInt(match[i]);
			if (octet < 0 || octet > 255) return null;
			
			ip = ip * 256 + octet;
		}
		return ip;
	}
	return null;
}
//////////////////////////////////////////////////////////////////////////
// checks if ip ranges are valid
ISQ.Tools.isIPsValid = function (ips)
{
	if (typeof ips === "string")
	{
		if (ips.length == 0) return true;
		ips = ips.split(',');
	}
	else if (typeof ips !== "array")
		return false;
	
	for (var i = 0; i < ips.length; i++) 
	{
		var range = ips[i].split('-');
		if (range.length == 1)
		{
			if (ISQ.Tools.getIPNum(range[0]) == null) return false;
		}
		else if (range.length == 2)
		{
			var ip = ISQ.Tools.getIPNum(range[0]);
			if (ip == null) return false;
			
			var ip2 = ISQ.Tools.getIPNum(range[1]);
			if (ip2 == null || ip > ip2) return false;
		}
		else
			return false;
	}
	return true;
};
//ISQInclude='/common/tools-js/getContentType.js';

//#region clickOutsideElements

//////////////////////////////////////////////////////////////////////////
// used to register and unregister body Onclick event that triggers a handler if 
// the mouse was clicked outside the given array of elements
// id: unique identifier of caller (mandatory)
// toAttach: true to attach event, false to detach the handler will NOT execute 
// elements: mandatory when toAttach=true. array of elements that if mouse was clicked on,
//           (mandatory when toAttach=true)
// handler:  a handler to the function to execute when mouse was clicked outside the 
//           elements (mandatory when toAttach=true)
ISQ.Tools.addRemoveClickOutsideElementsListener = function (id, toAttach, elements, handler)
{
    // prepare static flag
    if (!ISQ.Tools.clickOutsideListeners) ISQ.Tools.clickOutsideListeners = new Array();

    // register body onclick event
    if (toAttach)
    {
        if (!id) throw ("ISQ.Tools.addRemoveClickOutsideElementsListener: invalid id");
        if (!ISQ.Base.isDerivedOf(handler, ISQ.Handler)) throw ("ISQ.Tools.addRemoveClickOutsideElementsListener: invalid handler");

        if (!ISQ.Tools.clickOutsideListeners[id]) ISQ.Tools.clickOutsideListeners[id] = {};

        // unregister old event if required
        if (ISQ.Tools.clickOutsideListeners[id].registered)
        {
            if (document.removeEventListener)
            {
                document.removeEventListener('click', ISQ.Tools.clickOutsideListeners[id].func, true);
                if (ISQ.Http.browser.isTablet)
                    document.removeEventListener('touchstart', ISQ.Tools.clickOutsideListeners[id].func, true);
            }
            else if (document.detachEvent)
                document.detachEvent('onclick', ISQ.Tools.clickOutsideListeners[id].func)
        }

        // prepare static function
        ISQ.Tools.clickOutsideListeners[id].func = function (event4ff)
        {
            if (ISQ.Tools.clickOutsideListeners[id].ignoreNextClick)
            {
                ISQ.Tools.clickOutsideListeners[id].ignoreNextClick = false;
                return;
            }

            if (ISQ.Tools.clickOutsideElements(event4ff, elements))
                handler.handle(event4ff);
        };

        // register events
        ISQ.Tools.clickOutsideListeners[id].registered = true;
        if (document.addEventListener)
        {
            document.addEventListener('click', ISQ.Tools.clickOutsideListeners[id].func, true);
            if (ISQ.Http.browser.isTablet)
                document.addEventListener('touchstart', ISQ.Tools.clickOutsideListeners[id].func, true);
        }
        else if (document.attachEvent)
            document.attachEvent('onclick', ISQ.Tools.clickOutsideListeners[id].func);
    }
    else if (ISQ.Tools.clickOutsideListeners[id] && ISQ.Tools.clickOutsideListeners[id].registered)
    {
        ISQ.Tools.clickOutsideListeners[id].registered = false;

        // unregister event
        if (document.removeEventListener)
        {
            document.removeEventListener('click', ISQ.Tools.clickOutsideListeners[id].func, true);
            if (ISQ.Http.browser.isTablet)
                document.removeEventListener('touchstart', ISQ.Tools.clickOutsideListeners[id].func, true);
        }
        else if (document.detachEvent)
            document.detachEvent('onclick', ISQ.Tools.clickOutsideListeners[id].func);
    }
}
// firing mouse events for safari #9445
ISQ.Tools.fireMouseEvents = function (obj, evt)
{
    if (document.createEvent)
    {
        var eventObj = document.createEvent('MouseEvents');
        eventObj.initEvent(evt, true, false);
        obj.dispatchEvent(eventObj);
    }
    else if (document.createEventObject)
    {
        obj.fireEvent('on' + evt);
    }
}

// returns true if the mouse was clicked outside each of elements in the array, false otherwise
ISQ.Tools.clickOutsideElements = function (event4ff, elements)
{
    if (!elements || !(elements instanceof Array)) return false;

    var _e = ISQ.Html.getDomEvent(event4ff);
    while (_e.target !== document.body && _e.target !== null)
    {
        for (var i in elements)
        {
            if (_e.target == elements[i]) return false;
        }
        _e.target = _e.target.parentNode;
    }

    if (_e.target !== document.body && _e.target !== null) return false;

    return true;
}

// ignores the next click event
ISQ.Tools.ignoreNextClickOutsideElementsEvent = function (id)
{
    if (!ISQ.Tools.clickOutsideListeners[id]) return;
    ISQ.Tools.clickOutsideListeners[id].ignoreNextClick = true;
}

//#endregion;

/********************************************************
///////////////////// [ Data ] //////////////////////////
********************************************************/
ISQ.Data = initializeNS('ISQ.Data');

//#region validators

ISQ.Data.getEmailAddress = function (text)
{
    var emailPat = /[\w-_\&.]+\@[\w-_]+\.+[\w-_.]+/g;

    var res = text.match(emailPat);
    if (res === null || res.length === 0) return null;

    // filtering out illegal email addresses
    var wrongCharRegexp = new RegExp();
    wrongCharRegexp.compile("[~!#$%^&*()=`\'\"\\/><?\[\]{}|]", "g");
    var finalRes = new Array();
    for (var i = 0; i < res.length; ++i)
    {
        if (res[i].search(wrongCharRegexp) === -1) finalRes.push(res[i]);
    }

    return finalRes;
}
ISQ.Data.checkString = function (string, type)
{
    var result = true;
    var pattern;
    switch (type)
    {
        case 'email':
            if (string.contains("..")) return false;
            if (string.contains(".@") || string.contains("@.")) return false;
            var emailPat = /^[\w-_\&\+.]+\@([\w-_]+\.){1,}[\w-_]+$/;
            var wrongCharRegexp = new RegExp("[~!#$%^&*()='\'\"\\/><?\[\]{}|]", "g");
            return (string.search(wrongCharRegexp) === -1) && (string.match(emailPat)) && (string !== '');
            break;
        case 'number':
            var numPattern = /^[-]?[0-9]+\.?[0-9]?$/;
            return numPattern.test(string);
            break;
        case 'phone':  // check for numbers like 1-800-333-444#553 (extension) +972 ... (972) 123.123... [972] 123 123 123 972-123-123-123x666
            var numPattern = /^\+?[0-9\s(-)-\[\].\ ]*[#x]?[0-9\s]*?$/;
            return numPattern.test(string);
            break;

        case 'username':
            pattern = new RegExp(".+@.+");
            return (pattern.test(string));
            break;
        case 'url':
            //             var pattern = new RegExp('^(https?:\/\/)?' + // protocol
            //               '((([a-z\d]([a-z\d-]*[a-z\d])*)\.)+[a-z]{2,}|' + // domain name
            //               '((\d{1,3}\.){3}\d{1,3}))' + // OR ip (v4) address
            //               '(\:\d+)?(\/[-a-z\d%_.~+]*)*' + // port and path
            //               '(\\?[;&a-z\d%_.~+=-]*)?' + // query string
            //               '(\#[-a-z\d_]*)?$', 'i'); // fragment locater    

            pattern = new RegExp("^https?://([a-zA-Z0-9]+\.){1,}[a-zA-Z0-9]+");
            return (pattern.test(string));
            break;
    }
    return result;
}
ISQ.Data.validateRangeInputs = function (from, to, inputToChange, dateFormat)
{
    var fromValue = from.value.Trim();
    if (!fromValue) return;
    var toValue = to.value.Trim();
    if (!toValue) return;

    // getting ticks
    var dateFrom = ISQ.Tools.getDateTicks(fromValue, dateFormat);
    var dateTo = ISQ.Tools.getDateTicks(toValue, dateFormat);

    // invalid range
    if (dateFrom > dateTo)
    {
        if (inputToChange === from)
            from.value = toValue;
        else
            to.value = fromValue;
    }
}


// forces the input to accept only numeric values
ISQ.Tools.forceNumericValue = function (input, maxLength)
{
    if (maxLength) input.setAttribute('maxLength', maxLength);

    $(document).ready(function ()
    {
        $(input).keydown(function (event)
        {
            // Allow: backspace, delete, tab and escape
            if (event.keyCode == 46 || event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 27 ||
            // Allow: Ctrl+A, home, end, left, right
                (event.keyCode == 65 && event.ctrlKey === true) || (event.keyCode >= 35 && event.keyCode <= 39))
            {
                return;
            }
            else
            {
                // Ensure that it is a number and stop the keypress
                if (event.shiftKey || (event.keyCode < 48 || event.keyCode > 57) && (event.keyCode < 96 || event.keyCode > 105))
                {
                    event.preventDefault();
                }
            }
        });
    });
}


//#endregion;

//#region Infrastructure
// overwrites with extension over src
ISQ.Tools.extend = function (deep, target)
{
    target = target || {};
    deep = deep === true;
    var length = arguments.length;
    var options = null;
    for (var i = 2; i < length; i++)
    {
        // not dealing with undefined
        options = arguments[i];
        if (typeof (options) === 'undefined' || options === null) continue;
        for (var name in options)
        {
            var src = target[name], copy = options[name];

            // Prevent never-ending loop
            if (target === copy) continue;

            if (typeof (copy) === 'undefined') continue;

            // Recurse if we're merging object values
            if (deep && copy !== null && typeof (copy) === "object" && !copy.nodeType)
            {
                if (typeof (copy.isDerivedOf) !== 'function' || !copy.isDerivedOf(ISQ.Base))
                    target[name] = ISQ.Tools.extend(true, src || (copy.length != null ? [] : {}), copy);
                else
                    target[name] = copy;
            }
            // copying value
            else if (copy !== undefined)
            {
                target[name] = copy;
            }
        }
    }

    // Return the modified object
    return target;
}

ISQ.Tools.addArrayToGC = function (gc, arr)
{
    gc.add(
    {
        dispose: function ()
        {
            for (var nd in arr)
            {
                arr[nd].dispose();
                arr[nd] = null;
            }
            arr = null;
        }
    });
}

//#endregion;

// blinks an element for validation (highlights on and off)
ISQ.Tools.blinkElement = function (element, times, on, highlightedClassname)
{
    if (on)
    {
        ISQ.CSS.addClass(element, highlightedClassname);
        times--;
    }
    else
    {
        ISQ.CSS.removeClass(element, highlightedClassname);
    }

    if (times) setTimeout(function () { ISQ.Tools.blinkElement(element, times, !on, highlightedClassname) }, 150);
}

// blinks an element - toggles on/off
ISQ.Tools.toggleBlinkElement = function (element, highlightedClassname, timeout)
{
    if (element.blinkInterval)
    {
        clearInterval(element.blinkInterval);
        ISQ.CSS.removeClass(element, highlightedClassname);
        delete element.blinkInterval;
        return;
    }

    element.blinkInterval = setInterval(function ()
    {
        if (element.blinkOn)
        {
            element.blinkOn = false;
            ISQ.CSS.removeClass(element, highlightedClassname);
        }
        else
        {
            element.blinkOn = true;
            ISQ.CSS.addClass(element, highlightedClassname);
        }
    }, timeout || 800);
};
// #region auto ellipsis (NOT EFFICIENT)
// returns the text with ellipsis by attempting to fit it into the specified width
// width is in px.
// element is the html element in which the text will be displayed
// ellipsis element which holds desired text and ellipsis procedure can be done on it
// cssIdentifier: the css identifier (eg. .someClass) from which to copy the text's style in case JQuery isn't present
ISQ.Data.autoEllipseText = function (text, width, element, ellipsisElement, elementContainsText, cssIdentifier)
{
    var textWidth;
    var ellipseDone = false;
    cssIdentifier = cssIdentifier || null;

    // ellipsis element is given
    if (ellipsisElement)
    {
        textWidth = ellipsisElement.offsetWidth;
    }
    // ellipsis element is not given, using default one
    else
    {
        textWidth = ISQ.Data.checkTextWidth(text, element);
        ellipsisElement = ISQ.Html._('ellipsisDiv');
    }

    // set text and measure its width
    var originalText = text;
    if (textWidth > width)
    {
        ellipseDone = true;
        ellipsisElement.innerHTML = '';
        var start = 0, end = text.length, middle;
        var previousMiddle = end;
        // adjust text length to fit required width
        do
        {
            middle = start + Math.floor((end - start) / 2);
            // make sure middle is not in the middle of a tag
            var inTag = false;
            var i;

            for (i = end; i > 0 && (i > middle || inTag); --i)
            {
                if (text.charAt(i) === '>') inTag = true;
                else if (text.charAt(i) === '<') inTag = false;
            }

            middle = i;

            ellipsisElement.innerHTML = text.substr(0, middle) + '...';

            if (ellipsisElement.offsetWidth < width) // text is too short
                start = middle;
            else // text is too long
                end = middle
            if (previousMiddle === middle) break;
            previousMiddle = middle;
        } while ((end - start) > 1)

        // if it's still too long, drop one character
        if (ellipsisElement.offsetWidth > width || previousMiddle == middle)
        {
            text = text.substr(0, middle - 1) + '...';
        }
        else
        {
            // the resulting text
            text = ellipsisElement.innerHTML;
        }
    }
    // no ellipsis is needed
    // and container contains the text
    else if (elementContainsText)
    {
        return;
    }

    // set the elements inner html and tooltip, if required
    if (element)
    {
        element.innerHTML = text;
        if (ellipseDone) element.setAttribute('title', originalText);
    }
    else
    {
        return text;
    }
}

/**
 * ellipse text using css textOverflow.
 * @param text the text to add to the element.
 * @param element the element to add the ellipse.
 * @param maxWidth the max width for the element.
 * @returns the text
 */
ISQ.Data.autoCssEllipseText = function(text,element,maxWidth)
{

    //if element is given add text to innerHTML with Tooltip.
    if(element)
    {

        element.innerHTML = text;


        var textWIdth = ISQ.Data.checkTextWidth(text, element);

        if(textWIdth > maxWidth)
        {
            ISQ.Console.Common.createTooltip(element, text, '.plainTooltip');
            element.style.maxWidth = maxWidth + "px";
            element.style.whiteSpace = "nowrap";
            element.style.overflow = "hidden";
            element.style.textOverflow = "ellipsis";
        }
    }

    return text;
}



//////////////////////////////////////////////////////////////////////////
// text: desired text
// styleElement: an element holds style attributes of the desired text
ISQ.Data.checkTextWidth = function (text, styleElement)
{
    var inDiv = ISQ.Html._('ellipsisDiv');

    // create temp div that measures text's width
    if (!inDiv)
    {
        inDiv = createDiv(null, "position:fixed;white-space:nowrap;top:0px;left:0px;z-index:-5;visibility:hidden");
        inDiv.id = 'ellipsisDiv';

     	// workaround IE9 bug that returns offsetWidth=0 unless the div is redrawn
    	document.body.insertBefore(inDiv, document.body.firstChild);
    }
    else
    {
        clearNode(inDiv);
    }

    // setting styles
    ISQ.Data.copyElementFontStyle(styleElement, inDiv);
    inDiv.innerHTML = text;

    // returning width
    return inDiv.offsetWidth;
};
ISQ.Data.copyElementFontStyle = function (srcElement, targetElement)
{
    if (!targetElement || !srcElement) return;

    // workaround IE9 bug (#5923)
    var oldOverflow = null;
    if (ISQ.Http.browser.isIE9 && document.body.style.overflow)
    {
        oldOverflow = document.body.style.overflow;
        document.body.style.overflow = 'hidden';
    }

    // setting font style to be the same as styleElement
    targetElement.style.fontSize = ISQ.CSS.getElementStyle(srcElement, 'font-size');
    targetElement.style.fontWeight = ISQ.CSS.getElementStyle(srcElement, 'font-weight');
    targetElement.style.fontFamily = ISQ.CSS.getElementStyle(srcElement, 'font-family');
    targetElement.style.fontStyle = ISQ.CSS.getElementStyle(srcElement, 'font-style');
    targetElement.style.textDecoration = ISQ.CSS.getElementStyle(srcElement, 'text-decoration');
    //targetElement.style.color = ISQ.CSS.getElementStyle(srcElement, 'color');

    if (oldOverflow) document.body.style.overflow = oldOverflow;
};


// #endregion
;
ISQ.Data = initializeNS("ISQ.Data");
//#region Utilities
ISQ.Data.indexOfArray = function (arr, obj)
{
    var i = arr.length;
    while (i--)
        if (arr[i] == obj) return i;
    return -1;
}
ISQ.Data.inArray = function (arr, obj)
{
    return ISQ.Data.indexOfArray(arr, obj) !== -1;
}
ISQ.Data.isObjectEmpty = function (obj)
{
    for (var i in obj)
        return false;
    return true;
}

// on ie8 if items are unddefined the object is empty.
ISQ.Data.isObjectEmptyIE8 = function (obj)
{
    for(var i in obj)
    {
        if(obj[i] === undefined) continue;
        return false;
    }

    return true;
}

ISQ.Data.parseJson = function (json)
{
    try
    {
        // Try to use native function
        if (window.JSON && JSON.parse) return JSON.parse(json);
        // Check if the data are safe and eval them
        var t = json.replace(/"(\\.|[^"\\])*"/g, '');
        if (!/[^,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]/.test(t)) return eval('(' + json + ')');
    } catch (e) {}
}

ISQ.Data.jsonToString = function (json, stringBuilder, internalUse)
{
    // trying to use native method
    if (!internalUse && !window.Prototype) // Prototype has their own implementation of JSON.stringify which mishandles Arrays
    {
        try
        {
            return JSON.stringify(json);
        }
        catch (e) { }
    }

    //////////////////////////////////////////////////////////////////////////
    if (!stringBuilder) stringBuilder = new Array();

    if (json instanceof Array)
    {
        stringBuilder.push("[");
        for (var i = 0; i < json.length; ++i)
        {
            if (i !== 0) stringBuilder.push(",");
            ISQ.Data.jsonToString(json[i], stringBuilder, true);
        }
        stringBuilder.push("]");
    }
    else if (json === null)
    {
        stringBuilder.push("null");
    }
    else if (typeof (json) === 'object')
    {
        stringBuilder.push("{");
        var first = true;
        for (var i in json)
        {
            if (!first) stringBuilder.push(",");
            first = false;
            stringBuilder.push("\"");
            stringBuilder.push(i);
            stringBuilder.push("\"");
            stringBuilder.push(":");
            ISQ.Data.jsonToString(json[i], stringBuilder, true);
        }
        stringBuilder.push("}");
    }
    else if (typeof (json) === 'string')
    {
        stringBuilder.push("\"");
        stringBuilder.push(json.escaper());
        stringBuilder.push("\"");
    }
    else
    {
        stringBuilder.push(json);
    }

    if (!internalUse)
        return stringBuilder.join('');
}
;
//ISQInclude='/common/tools-js/ie7dropdown.js';

//////////////////////////////////////////////////////////////////////////
// matches credit card numbers in the string and replaces each digit
// in the pattern with the replacement char (eg. a 16 digit number will be replaced by 16 *'s)
ISQ.Data.blockCreditCardNumbers = function (string, replacement)
{
    // regex from http://www.regular-expressions.info/creditcard.html
    var regex = /(?:4[0-9]{12}(?:[0-9]{3})?|5[1-5][0-9]{14}|6(?:011|5[0-9][0-9])[0-9]{12}|3[47][0-9]{13}|3(?:0[0-5]|[68][0-9])[0-9]{11}|(?:2131|1800|35\d{3})\d{11})/g;

    // strip spaces and dashes
    var stripped = string.replace(/ /g, '').replace(/-/g, '').replace(/\n/g, '').replace(/\r/g, '').replace(/\./g, '');
    var strippedReplaced = stripped;

    // match with regex
    var matches = stripped.match(regex);
    if (!matches || matches.length == 0) return string;

    // iterate results
    for (var i = 0; i < matches.length; ++i)
    {
        var match = matches[i];

        var stars = new Array();
        for (var j = 0; j < match.length; ++j)
        {
            stars.push(replacement);
        }

        // replace matches in strippedReplaced 
        strippedReplaced = strippedReplaced.replace(match, stars.join(''));
    }

    var strippedIndex = 0;
    for (var i = 0; i < string.length; ++i)
    {
        if (string.charAt(i) == ' ' || string.charAt(i) == '-') continue;
        if (stripped.charAt(strippedIndex) != strippedReplaced.charAt(strippedIndex))
        {
            string = string.setCharAt(i, replacement);
        }
        strippedIndex++;
    }

    return string;
}

;
//ISQInclude='/common/tools-js/twitter.js';
//ISQInclude='/common/tools-js/postDataUsingFrame.js';
//ISQInclude='/common/tools-js/emailParser.js';

//#region HTML encoders / decoders
ISQ.Data.htmlEncode = function (text)
{
    var decoyElement = createElement("div");
    decoyElement.innerHTML = text;
    if (typeof (decoyElement.innerText) !== 'undefined')
        return decoyElement.innerText.Trim();
    else if (typeof (decoyElement.textContent) !== 'undefined')
        return decoyElement.textContent.Trim();
    return decoyElement.innerHTML.Trim();
}
ISQ.Data.htmlDecode = function (text)
{
    var decoyElement = createElement("div");
    decoyElement.innerHTML = text;
    return decoyElement.innerHTML.Trim();
}
ISQ.Data.getTextFromHtml = function (html)
{
    var decoyElement = createElement("div");
    decoyElement.innerHTML = html;
    return ($(decoyElement).text()).Trim();
}
ISQ.Data.stripHtml = function (content, specificTag, keepLineBreaks)
{
    var tagStartPos = 0, tagEndPos = -1, lastPos = 0;
    var builder = new Array();
    var tag;
    specificTag = specificTag || ''; // allow stripping just 1 specific tag, eg.: iframe

    tagStartPos = content.indexOf('<' + specificTag, tagStartPos);
    while (tagStartPos > -1)
    {
        // add data until tag start
        builder.push(content.substr(lastPos, tagStartPos - lastPos));
        // search for tag end
        tagEndPos = content.indexOf('>', tagStartPos);
        lastPos = tagStartPos + 1;
        if (tagEndPos != -1)
        {
            // check tag name
            tag = content.substr(tagStartPos + 1, tagEndPos - tagStartPos - 1).toLowerCase();
            if (tag.startsWith("br") || tag.startsWith("p"))
            {
                if (keepLineBreaks)
                    builder.push('<br/>');
                else
                    builder.push('\n ');
            }
            // advance
            lastPos = tagEndPos + 1;
        }
        else
            builder.push('<');

        tagStartPos = content.indexOf('<', lastPos);
    }
    // if last search failed to find an closing for a tag,
    // if (tagEndPos == -1) lastPos--;
    if (lastPos != content.length)
        builder.push(content.substr(lastPos, content.length - lastPos));

    return builder.join('');
};

ISQ.Data.unHTML = function (txt)
{
    if (!txt) return '';
    txt = txt.replace(/\</g, "&lt;");
    txt = txt.replace(/\>/g, "&gt;");
    txt = txt.replace(/&lt;wbr\/&gt;/g, "<wbr/>");
    return txt;
};

ISQ.Data.toHTML = function (txt)
{
    if (!txt) return '';
    txt = txt.replace(/&lt;/g, "<");
    txt = txt.replace(/&gt;/g, ">");
    return txt;
};

ISQ.Data.escapeJS = function (txt)
{
    if (!txt) return '';
    txt = txt.replace(/\'/g, "\\'");
    return txt;
};

ISQ.Data.processHTMLstring = function (txt, options)
{
    /*
    options: {
    wordBreak: true // add <wbr/>
    questionTagFunction: func, // if encountered
    questionTagCustomParams: object //
    decodeEntities: true,  // for e.g.: replaces &#39; with '
    allowLinksInSameWindow: false, // allows link's target to be opened in the same window
    doNotProcessScriptTag: false,
    namedAnchorFunction: func, // optional. onclick handler for named anchors in the text
    url: string // base url for relative links
    }
    returnValue:
    {
    text: the processed html string
    script: aggregates script text (if 'doNotProcessScriptTag' is false)
    }
    */

    options = options || {};

    var result = { text: '', script: '' };
    if (!txt) return result;

    var startIndex = txt.indexOf("<");
    if (startIndex === -1) // html tag not found
    {
        if (options.decodeEntities) // decode html
            txt = ISQ.Data.htmlEncode(txt);

        if (options.wordBreak) // adding work break tags
            result.text = ISQ.Data.breakWords(txt);
        else
            result.text = txt;

        return result;
    }

    var endIndex = -1;
    var lastEndIndex = 0;
    var lastStartIndex = -1;
    var returnedText = new Array();
    var returnedScript = null;
    var tmpText;
    do
    {
        // saving text so far //
        if (lastEndIndex !== startIndex)
        {
            tmpText = txt.substring(lastEndIndex, startIndex);
            if (options.decodeEntities) // decode html
                tmpText = ISQ.Data.htmlEncode(tmpText);

            if (options.wordBreak)
                ISQ.Data.breakWords(tmpText, returnedText, true);
            else
                returnedText.push(tmpText);
        }

        // saving last start index //
        lastStartIndex = startIndex;

        // closing '>'
        endIndex = txt.indexOf(">", startIndex + 1);
        // there is no closing for opening tag e.g. <a......
        if (endIndex === -1) break;

        //////////////////////////////////////////////////////////////////////////
        // in <a> tag, we set target=_blank/_top to make sure
        // links are not opened in widget iframe
        var htmlTag = "";
        var tagStart = txt.charAt(startIndex + 1);
        var htmlTagProcessed = false;
        // #region adding target _blank to A tag
        // <A> tag
        if (txt.charAt(startIndex + 2) === " " && (tagStart === "A" || tagStart === "a"))
        {
            htmlTagProcessed = true;
            endIndex = txt.indexOf("</a>", startIndex);
            if (endIndex === -1)
            {
                endIndex = txt.indexOf("</A>", startIndex);
                if (endIndex === -1) break;
            }
            endIndex += 4;

            var stringTag = txt.substring(startIndex, endIndex);
            var tempDiv = createDiv(null);
            tempDiv.innerHTML = stringTag;
            var htmlAnchor = tempDiv.firstChild;
            if (tempDiv.parentNode != null) tempDiv.parentNode.removeChild(tempDiv);
            tempDiv = null;

            if (htmlAnchor.nodeName !== "A") break;

            // nanorep answer link
            var answerId = htmlAnchor.getAttribute("nanoreplinkid");
            if (answerId && options.questionTagFunction)
            {
                // questionTagFunction(stringBuilder, answerId, link-innerHTML, html-tag-string, customParam)
                options.questionTagFunction(returnedText, answerId, htmlAnchor.innerHTML, stringTag, options.questionTagCustomParams || null);
            }
            // regular link or no-question tag handler
            else
            {
                // processing url
                var href = htmlAnchor.getAttribute('href');
                if (href && href != 'javascript:void(0)' && href.charAt(0) != '#' && options.allowLinksInSameWindow !== true)
                {
                    //////////////////////////////////////////////////////////////////////////
                    // setting relative link (if given link isn't an absolute one)
                    var absoluteNdx;
                    if (options.url && !href.startsWith("\\") && ((absoluteNdx = href.indexOf(":/")) === -1) && ((absoluteNdx = href.indexOf(":\\")) === -1) && !href.startsWith("mailto:"))
                    {
                        // relative link to domain root
                        if (href.startsWith('/'))
                        {
                            var slashNdx = 0;
                            if (options.url.startsWith("https://"))
                                slashNdx += 8;
                            else if (options.url.startsWith("http://"))
                                slashNdx += 7;

                            var domain = options.url.substring(0, options.url.indexOf('/', slashNdx));

                            href = domain + href;
                        }
                        // relative link to current url
                        else
                        {
                            // removing
                            var ndx1 = options.url.indexOf("?");
                            var ndx2 = options.url.indexOf("#");
                            var endNdx;
                            if (ndx1 === -1) // no '?
                            {
                                if (ndx2 === -1) // no '#'
                                    endNdx = options.url.length - 1;
                                else // there's '#'
                                    endNdx = ndx2;
                            }
                            else // there's '?'
                            {
                                if (ndx2 === -1) // no '#'
                                    endNdx = ndx1;
                                else // there's '?' and '#'
                                    endNdx = Math.min(ndx1, ndx2);
                            }

                            //getting folder
                            var url = options.url.substring(0, options.url.LastIndexOf('/', endNdx) + 1);
                            href = url + href;
                        }

                        htmlAnchor.setAttribute("href", href);
                    }


                    //////////////////////////////////////////////////////////////////////////
                    // setting target to _blank
                    var anchorTarget = htmlAnchor.getAttribute("target");
                    switch (anchorTarget)
                    {
                        case "blank":
                        case "top":
                        case "_blank":
                        case "_top":
                        case "_parent":
                        case "parent":
                            break;
                        default:
                            htmlAnchor.setAttribute("target", "_blank");
                            break;
                    }
                }
                else if (href && href.charAt(0) == '#' && options.namedAnchorFunction)
                {
                    // when clicking a named anchor inside the widget it may cause the body to scroll up (#9258)
                    htmlAnchor.setAttribute('onclick', 'return ' + options.namedAnchorFunction + '(this.hash)');
                }
                htmlTag = elementToString(htmlAnchor, ISQ.Data.processHTMLstring(htmlAnchor.innerHTML, options).text);
            }
        }
        // #endregion
        //////////////////////////////////////////////////////////////////////////
        // in <table> tag, we replace width property
        // #region removing width from table
        // <TABLE> tag #9543
        else if (txt.equals("table ", startIndex + 1) || txt.equals("table>", startIndex + 1))
        {
            var tmpEndIndex = txt.indexOf("</table>", startIndex);
            if (tmpEndIndex === -1)
            {
                tmpEndIndex = txt.indexOf("</TABLE>", startIndex);
            }
            if (tmpEndIndex != -1)
            {
                tmpEndIndex += 8;
                var stringTag = txt.substring(startIndex, tmpEndIndex);
                var tempDiv = createDiv(null);
                tempDiv.innerHTML = stringTag;
                var htmlTable = tempDiv.firstChild;
                if (tempDiv.parentNode != null) tempDiv.parentNode.removeChild(tempDiv);
                tempDiv = null;

                if (htmlTable.nodeName !== "TABLE") break;
                htmlTagProcessed = true;
                endIndex = tmpEndIndex; // saving end index

                for (var row in htmlTable.rows)
                {
                    var tr = htmlTable.rows[row];
                    for (var td in tr.childNodes)
                    {
                        var childTds = tr.cells.length;
                        if (tr.childNodes[td].nodeName != "TD") continue;
                        tr.childNodes[td].setAttribute("width", 100 / childTds + "%");
                        tr.childNodes[td].style.width = 100 / childTds + "%";
                    }
                }
                var width = htmlTable.getAttribute("width");
                htmlTable.setAttribute("width", "100%");
                htmlTable.style.width = "100%";
                htmlTable.style.tableLayout = "fixed";

                htmlTag = elementToString(htmlTable, ISQ.Data.processHTMLstring(htmlTable.innerHTML, options).text);
            }
        }
        //#endregion
        // #region script handling (if options.doNotProcessScriptTag)
        else if (txt.equals("script ", startIndex + 1) || txt.equals("script>", startIndex + 1) && options.doNotProcessScriptTag !== true)
        {
            var endTag = txt.indexOf(">", startIndex + 6);
            if (endTag === -1) break; // illegal flow

            var endScriptTag = txt.indexOf("</", endTag);
            if (endScriptTag === -1) break; // illegal flow

            // appending script
            if (returnedScript === null) returnedScript = new Array();
            returnedScript.push(txt.substring(endTag + 1, endScriptTag));
            returnedScript.push(";");

            // jumping to end of /script>
            var tempEndIndex = txt.indexOf(">", endScriptTag + 2);
            if (tempEndIndex !== -1)
            {
                endIndex = ++tempEndIndex;
                htmlTagProcessed = true;
            }
        }
        //#endregion

        // if HTML wasn't processed yet, adding it to string
        if (!htmlTagProcessed) htmlTag = txt.substring(startIndex, ++endIndex);

        // saving <tag.... > //
        returnedText.push(htmlTag);
        lastEndIndex = endIndex;
        startIndex = txt.indexOf("<", lastEndIndex);
    }
    while (startIndex !== -1);

    // ">" //
    if (endIndex === -1)
    {
        tmpText = txt.substring(lastStartIndex);
        if (options.decodeEntities) // decode html
            tmpText = ISQ.Data.htmlEncode(tmpText);

        if (options.wordBreak)
            ISQ.Data.breakWords(tmpText, returnedText, true);
        else
            returnedText.push(tmpText);
    }
    else
    {
        tmpText = txt.substring(lastEndIndex);
        if (options.decodeEntities) // decode html
            tmpText = ISQ.Data.htmlEncode(tmpText);

        if (options.wordBreak)
            ISQ.Data.breakWords(tmpText, returnedText, true);
        else
            returnedText.push(tmpText);
    }


    result.text = returnedText.join('');
    if (returnedScript) result.script = returnedScript.join('');

    return result;
};


//// input: txt= answer summary from server by xml protocol
//// output: html represents the summary (with line breaks, <code> and <question>)
ISQ.Data.getDBAnswerAsHtml = function (txt, skipWordBreak, questionTagFunction, questionTagCustomParams, namedAnchorFunction, referer)
{
    try
    {
        return ISQ.Data.processHTMLstring(txt,
        {
            wordBreak: skipWordBreak !== true,
            questionTagFunction: questionTagFunction,
            questionTagCustomParams: questionTagCustomParams, //
            namedAnchorFunction: namedAnchorFunction,
            decodeEntities: false,
            url: referer
        });
    }
    catch (e)
    {
        if (typeof (_debug) === 'function') _debug().insertText("ISQ.Data.getDBAnswerAsHtml exception: " + txt);
        return { text: '', error: e };
    }
};


//////////////////////////////////////////////////////////////////////////
// creates a <a href=...></a> object from the parameters
ISQ.Data.createLink = function (str, url, target, cssClass, breakWords, unHTML, addHttp)
{
    if (!str || !url) return '';

    if (breakWords && unHTML) str = ISQ.Data.unHTML(ISQ.Data.breakWords(str));
    else if (breakWords) str = ISQ.Data.breakWords(str);
    else if (unHTML) str = ISQ.Data.unHTML(str);

    // add http if needed
    if (addHttp && !url.startsWith("http://") && !url.startsWith("https://"))
        url = "http://" + url;

    // build
    var link = new Array();
    link.push('<a href="');
    link.push(url);
    if (target)
    {
        link.push('" target="');
        link.push(target);
    }
    if (cssClass)
    {
        link.push('" class="');
        link.push(cssClass);
    }
    link.push('">');
    link.push(str);
    link.push('</a>');

    return link.join('');
}



//////////////////////////////////////////////////////////////////////////
// replaces any url in the string with <a href=...></a>
ISQ.Data.parseURL = function (str, target)
{
if (!str) return '';

return str.replace(/[A-Za-z]+:\/\/[A-Za-z0-9-_]+\.[A-Za-z0-9-_:%&\?\/.=]+/, function (url)
{
    return ISQ.Data.createLink(url, url, target);
});
};


//////////////////////////////////////////////////////////////////////////
// adding word-break tags to long words.
// skipping html entities
ISQ.Data.breakWords = function (txt, stringBuilderArray, useShyInIE8)
{
    // no text
    if (!txt)
    {
        if (stringBuilderArray) return;
        return "";
    }

    // creating splitter object
    var splitter = new ISQ.Data.EntityParser(txt);

    var obj = {};
    var newText;
    if (stringBuilderArray)
        newText = stringBuilderArray;
    else
        newText = new Array();

    while (splitter.getNextSegment(obj))
    {
        // adding 'word-break' tags to segment
        ISQ.Data.breakWords_internal(obj.segment, newText, useShyInIE8);

        // adding entity
        if (obj.entity) newText.push(obj.entity);
    }

    splitter.dispose();

    // a string builder array was given, returning
    if (stringBuilderArray) return;

    // returning the built string
    return newText.join('');
}
//////////////////////////////////////////////////////////////////////////
// INTERNAL: adding word-break tags to long words.
ISQ.Data.breakWords_internal = function (txt, stringBuilderArray, useShyInIE8)
{
    if (!txt || !stringBuilderArray) return;

    var wbTag = "<wbr/>";
    if (ISQ.Http.browser.full.startsWith("safari3")
        || ISQ.Http.browser.isOpera
        || ISQ.Http.browser.isIE8
        || ISQ.Http.browser.isIE9
        || ISQ.Http.browser.isIE10)
        wbTag = "&#8203;";

    // using &shy; tag in ie8 to workaround disappearing text bug
    if (useShyInIE8 && ISQ.Http.browser.isIE8)
        wbTag = "&shy;";

    var l = txt.length;
    var wordLength = 0;
    var lastCopiedIndex = -1;
    var currentWordLong = false;
    var i = 0;
    for (i = 0; i < l; ++i)
    {
        if (txt.charAt(i) === " ")
        {
            // resetting word length //
            wordLength = 0;
        }
        else if (wordLength >= 20 && wordLength % 2 === 0)
        {

            // copying string until now //
            stringBuilderArray.push(txt.substring(lastCopiedIndex + 1, i + 1));
            lastCopiedIndex = i;

            stringBuilderArray.push(wbTag);

            // 	counter //
            ++wordLength;
        }
        else
        {
            // 	counter //
            ++wordLength;
        }
    }

    // copying the rest of the string //
    stringBuilderArray.push(txt.substring(lastCopiedIndex + 1));
}


//////////////////////////////////////////////////////////////////////////
// Entity parser
ISQ.Data.EntityParser = ISQ.Base.extend({ name: "ISQ.Data.EntityParser" })
ISQ.Data.EntityParser.prototype.ctor = function (txt)
{
    if (!txt) throw ("ISQ.Data.EntityParser: no txt");
    this.mOriginalText = txt;
    //this.mText = "";
    this.mIndex = 0;
}
ISQ.Data.EntityParser.prototype.dtor = function ()
{

}
//////////////////////////////////////////////////////////////////////////
// return true if returning the next segment.
// will return false if reached end of string
ISQ.Data.EntityParser.prototype.getNextSegment = function (obj)
{
    // reached end of text
    if (this.mIndex == this.mOriginalText.length) return false;

    // getting next index
    var ndx = this.mOriginalText.indexOf("&", this.mIndex);
    var endNdx = this.mOriginalText.indexOf(";", ndx);

    // setting text
    //obj.text = this.mText;

    //////////////////////////////////////////////////////////////////////////
    // no entity found, skipping until end of string
    if (ndx === -1 || endNdx === -1 || endNdx - ndx > 8)
    {
        obj.entity = null;
        obj.segment = this.mOriginalText.substring(this.mIndex);
        this.mIndex = this.mOriginalText.length;
    }

    //////////////////////////////////////////////////////////////////////////
    // entity found!
    else if (ndx !== -1)
    {
        // setting entity
        obj.entity = this.mOriginalText.substring(ndx, ++endNdx);

        // setting segment
        var segment = this.mOriginalText.substring(this.mIndex, ndx);
        //this.mText += segment;
        obj.segment = segment;

        // updating index
        this.mIndex = endNdx;
    }

    return true;
}

//escaping xml unsafe chars from string
ISQ.Data.escapeXml = function(unsafe) {
	return unsafe.replace(/[<>&'"]/g, function (c) {
		switch (c) {
			case '<': return '&lt;';
			case '>': return '&gt;';
			case '&': return '&amp;';
			case '\'': return '&apos;';
			case '"': return '&quot;';
		}
	});
}

ISQ.Data.EntityParser.prototype.mOriginalText;
ISQ.Data.EntityParser.prototype.mLastEntityFound = null;
ISQ.Data.EntityParser.prototype.mAlteredText;
ISQ.Data.EntityParser.prototype.mIndex = 0;
ISQ.Data.EntityParser.prototype.mNextIndex = -1;

;
//ISQInclude='/common/tools-js/textDirection.js';
//ISQInclude='/common/tools-js/xml.js';

//#region FileLoader
ISQ.Tools.FileLoader = initializeNS('ISQ.Tools.FileLoader');
ISQ.Tools.FileLoader.ajaxPool = null;
ISQ.Tools.FileLoader.getAjaxPool = function ()
{
    // return a single Ajax.Pool instance
    if (ISQ.Tools.FileLoader.ajaxPool === null)
    {
        var connections = (ISQ.Http.browser.isIE6 || ISQ.Http.browser.isIE7) ? 1 : 2;
        ISQ.Tools.FileLoader.ajaxPool = new Ajax.Pool('/kb', connections, Ajax.methodEnum.GET, Ajax.typeEnum.ASYNC, 10000);
        ISQ.Tools.FileLoader.ajaxPool.incomingResponseEvent.addHandler(ISQ.Tools.FileLoader.loadResponse);

        // registering pool into GC
        if (typeof ('sessionGC') === 'function') sessionGC().add(ISQ.Tools.FileLoader.ajaxPool);
    }

    return ISQ.Tools.FileLoader.ajaxPool;
}
ISQ.Tools.FileLoader.load = function (src, handler, tag, splitInHeader)
{
    if (handler && !ISQ.Base.isDerivedOf(handler, ISQ.Handler)) handler = new ISQ.Handler(handler);

    var responseHandler = function (text)
    {
        // appending file to dom
        try
        {
            // removing parameters
            var simpleUrl = src;
            var ndx = src.indexOf("?");
            if (ndx != -1) simpleUrl = src.substring(0, ndx);
            else if ((ndx = src.indexOf("#")) != -1) simpleUrl = src.substring(0, ndx);

            if (simpleUrl.endsWith(".css"))
                ISQ.CSS.addNewStyle(text, "fileloaderStyleSheet", splitInHeader);
            else if (simpleUrl.endsWith(".js"))
            {
                try
		        {
		            // first: trying to add as <script> tag (fastest)
		            var scriptTag = document.createElement('script');
		            scriptTag.type = 'text/javascript';
		            scriptTag.charset = 'utf-8';
		            scriptTag.id = 'testing';
		            scriptTag.defer = true;
		            scriptTag.async = true;
		            scriptTag.text = text;
		            document.getElementsByTagName('head')[0].appendChild(scriptTag);
		        }
		        catch (e)
		        {
		        	// trying to eval
	                eval(text);
		        }
            }
        }
        catch (ex)
        {
            _debug().insertText("ISQ.Tools.FileLoader.loadResponse: Error loading file ( " + response.request.mUrl + ").\n" + ex);
        }

        // handler
        if (handler) handler.handle(tag, text);
    }

    //////////////////////////////////////////////////////////////////////////
    // tiny ajax
    if (typeof (ISQ.Com) !== 'undefined' && typeof (ISQ.Com.TinyAjax) !== 'undefined')
    {
        ISQ.Com.TinyAjax.create(
        {
            url: src,
            method: ISQ.Com.TinyAjax.enumMethod.GET,
            timeout: 5000,
            handler: function (status, text)
            {
                if (status != ISQ.Com.TinyAjax.enumStatus.OK) return;
                responseHandler(text);
            }
        });
    }
    else
    {
        //////////////////////////////////////////////////////////////////////////
        // ajax pool
        var request = new Ajax.Request(src, Ajax.methodEnum.GET, Ajax.typeEnum.ASYNC);
        request.disableProcessJson = true;
        request.incomingResponseEvent.addHandler(function (response)
        {
            if (response.type !== Ajax.responseTypeEnum.OK) return;
            responseHandler(response.text);
            setTimeout(function () { request.dispose(); }, 0);
        });
        request.send();
    }
}
//#endregion
;

//////////////////////////////////////////////////////////////////////////
// appends a new script tag to the document head
ISQ.Tools.appendScript = function (url, callback)
{
    var s = document.createElement("script");
    s.type = 'text/javascript';
    s.async = true;
    s.defer = true;

    if (url instanceof Array)
        url = url.join('');

    if (callback)
    {
        var func = function ()
        {
            if (ISQ.Base.isDerivedOf(callback, ISQ.Handler))
                callback.handle();
            else
                callback();
        }

        // most browsers
        if (ISQ.Http.browser.app !== "ie" || ISQ.Http.browser.isIE11)
            s.onload = func;
        else
        {
            // ie
            s.onreadystatechange = function ()
            {
                if (this.readyState !== 'complete' && this.readyState !== 'loaded') return;
                func();
            }
        }
    }

    s.src = url;
    document.getElementsByTagName("head")[0].appendChild(s);

    return s;
};
//ISQInclude = '/common/tools-js/time.js';


/********************************************************
//////////////////// [ Base64 ] /////////////////////////
********************************************************/
//#region Base64
ISQ.Tools.Base64 =
{
    // private property
    _keyStr: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",

    // public method for encoding
    encode: function (input)
    {
        var output = "";
        var chr1, chr2, chr3, enc1, enc2, enc3, enc4;
        var i = 0;

        //input = ISQ.Tools.Base64._utf8_encode(input);

        while (i < input.length)
        {

            chr1 = input.charCodeAt(i++);
            chr2 = input.charCodeAt(i++);
            chr3 = input.charCodeAt(i++);

            enc1 = chr1 >> 2;
            enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
            enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);
            enc4 = chr3 & 63;

            if (isNaN(chr2))
            {
                enc3 = enc4 = 64;
            } else if (isNaN(chr3))
            {
                enc4 = 64;
            }

            output = output +
			this._keyStr.charAt(enc1) + this._keyStr.charAt(enc2) +
			this._keyStr.charAt(enc3) + this._keyStr.charAt(enc4);

        }

        return output;
    },

    // public method for decoding
    decode: function (input)
    {
        var output = "";
        var chr1, chr2, chr3;
        var enc1, enc2, enc3, enc4;
        var i = 0;

        input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");

        while (i < input.length)
        {

            enc1 = this._keyStr.indexOf(input.charAt(i++));
            enc2 = this._keyStr.indexOf(input.charAt(i++));
            enc3 = this._keyStr.indexOf(input.charAt(i++));
            enc4 = this._keyStr.indexOf(input.charAt(i++));

            chr1 = (enc1 << 2) | (enc2 >> 4);
            chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);
            chr3 = ((enc3 & 3) << 6) | enc4;

            output = output + String.fromCharCode(chr1);

            if (enc3 != 64)
            {
                output = output + String.fromCharCode(chr2);
            }
            if (enc4 != 64)
            {
                output = output + String.fromCharCode(chr3);
            }

        }

        //output = ISQ.Tools.Base64._utf8_decode(output);

        return output;

    },

    // private method for UTF-8 encoding
    _utf8_encode: function (string)
    {
        string = string.replace(/\r\n/g, "\n");
        var utftext = "";

        for (var n = 0; n < string.length; n++)
        {

            var c = string.charCodeAt(n);

            if (c < 128)
            {
                utftext += String.fromCharCode(c);
            }
            else if ((c > 127) && (c < 2048))
            {
                utftext += String.fromCharCode((c >> 6) | 192);
                utftext += String.fromCharCode((c & 63) | 128);
            }
            else
            {
                utftext += String.fromCharCode((c >> 12) | 224);
                utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                utftext += String.fromCharCode((c & 63) | 128);
            }

        }

        return utftext;
    },

    // private method for UTF-8 decoding
    _utf8_decode: function (utftext)
    {
        var string = "";
        var i = 0;
        var c = c1 = c2 = 0;

        while (i < utftext.length)
        {

            c = utftext.charCodeAt(i);

            if (c < 128)
            {
                string += String.fromCharCode(c);
                i++;
            }
            else if ((c > 191) && (c < 224))
            {
                c2 = utftext.charCodeAt(i + 1);
                string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));
                i += 2;
            }
            else
            {
                c2 = utftext.charCodeAt(i + 1);
                c3 = utftext.charCodeAt(i + 2);
                string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));
                i += 3;
            }

        }

        return string;
    },

    encodeString: function (txt)
    {
        if (!txt) return '';
        var hasUtfChars = false;
        for (var i = 0; i < txt.length && !hasUtfChars; ++i)
        {
            if (txt.charCodeAt(i) > 127) hasUtfChars = true;
        }

        var result;
        if (hasUtfChars) txt = ISQ.Tools.Base64._utf8_encode(txt);
        return ISQ.Tools.Base64.encode(txt);
    },

    decodeString: function (encodedString)
    {
        var result = ISQ.Tools.Base64.decode(encodedString);
        var hasUtfChars = false;
        for (var i = 0; i < result.length && !hasUtfChars; ++i)
        {
            if (result.charCodeAt(i) > 127) hasUtfChars = true;
        }
        if (hasUtfChars) result = ISQ.Tools.Base64._utf8_decode(result);
        return result;
    }
}


ISQ.Data.getURLencodedString = function (input)
{
    if (!input) return "";
    return escape(ISQ.Tools.Base64._utf8_encode(input));
}
ISQ.Data.getURLdecodedString = function (input)
{
    if (!input) return "";
    return ISQ.Tools.Base64._utf8_decode(unescape(input));
};
//ISQInclude='/common/tools-js/convertScripts.js';

/********************************************************
//////////////////// [ ARRAY ] //////////////////////////
********************************************************/
//#region Array

//////////////////////////////////////////////////////////////////////////
// input: 2 string arrays
// output: true if equal
ISQ.Tools.compareArrays_flat = function (arr1, arr2, secondTime)
{
    if (arr1 === arr2) return true;
    if (!arr1 && !arr2) return true;
    if (!arr1 || !arr2) return false;
    if (arr1.length !== arr2.length) return false;

    for (var i = 0; i < arr1.length; ++i)
        if (arr1[i] !== arr2[i]) return false;
return true;
}
//////////////////////////////////////////////////////////////////////////
// input: 2 string arrays
// output: true if equal
ISQ.Tools.compareArrays = function (arr1, arr2, secondTime)
{
    if (arr1 === arr2) return true;
    if (!arr1 && !arr2) return true;
    if (!arr1 || !arr2) return false;

    if (arr1.length !== arr2.length) return false;
    for (var i in arr1)
    {
        var str = arr1[i];
        var found = false;
        for (var j in arr2)
        {
            if (arr2[j] === str)
            {
                found = true;
                break;
            }
        }
        if (!found) return false;
    }

    if (secondTime) return true;

    // now run again, comparing arr2 with arr1. if we don't do this, then compareArrays([1,1], [2,1]) returns true!    
    return ISQ.Tools.compareArrays(arr2, arr1, true);
}

ISQ.Tools.reverseArray = function (arr)
{
    var loopMax = arr.length;
    for (var i = 0; i < arr.length; ++i)
    {
        var ndx = 0;
        for (var j = 1; j < loopMax; ++j)
        {
            var temp = arr[ndx];
            arr[ndx] = arr[j]
            arr[j] = temp;
            ++ndx;
        }
        --loopMax;
    }
}

ISQ.Tools.disposeArray = function (arr)
{
    if (!arr) return;

    for (var i = 0; i < arr.length; ++i)
    {
        if (!arr[i]) continue;
        if (arr[i] instanceof Array) { ISQ.Tools.disposeArray(arr[i]); continue; }
        if (typeof (arr[i].dispose) === 'function') arr[i].dispose();
        arr[i] = null;
        delete arr[i];
    }
}

// returns true if the item (string) is a member in the csv list
ISQ.Tools.isInCSVList = function (list, item)
{
    if (typeof (list) !== 'string' || typeof (item) !== 'string') return false;
    if (!list || !item) return false;

    item = item.Trim();
    list = list.Trim();

    var idx = list.indexOf(item);
    if (idx == -1) return false;

    if (idx > 0 && list[idx - 1] != ',') return false;
    if (idx + item.length < list.length && list[idx + item.length] != ',') return false;

    return true;
}

//#endregion;
//////////////////////////////////////////////////////////////////////////
// returns a uniform representation of given langCode 
// (the representation known by our server)
ISQ.Tools.getUniformLanguageCode = function (langCode)
{
    if (!langCode) return null;
    var unifromCode = ISQ.Tools.UniformLanguageCode[langCode];
    if (unifromCode) return unifromCode;
    return langCode;
}

ISQ.Tools.UniformLanguageCode =
{
    'he': 'iw',
    'zh-CHS': 'zh',
    'zh-CHT': 'zh',
    'zh-CN': 'zh'
}

//////////////////////////////////////////////////////////////////////////
// is language rtl
ISQ.Tools.isLanguageRTL = function (langCode)
{
    langCode = ISQ.Tools.getUniformLanguageCode(langCode);
    switch (langCode)
    {
        case 'iw':
        case 'ar':
        case 'yi':
        case 'ur':
            return true;
    }
    return false;
}


ISQ.Tools.Languages =
{
    //    'aa': 'Afar',
    //    'ab': 'Abkhaz',
    //    'ae': 'Avestan',
    //    'af': 'Afrikaans',
    //    'ak': 'Akan',
    //    'am': 'Amharic',
    //    'an': 'Aragonese',
    'ar': 'Arabic',
    //    'as': 'Assamese',
    //    'av': 'Avaric',
    //    'ay': 'Aymara',
    //    'az': 'Azerbaijani',
    //    'ba': 'Bashkir',
    //    'be': 'Belarusian',
    'bg': 'Bulgarian',
    //    'bh': 'Bihari',
    //    'bi': 'Bislama',
    //    'bm': 'Bambara',
    //    'bn': 'Bengali',
    //    'bo': 'Tibetan Standard, Tibetan, Central',
    //    'br': 'Breton',
    //    'bs': 'Bosnian',
    //    'ca': 'Catalan; Valencian',
    //    'ce': 'Chechen',
    //    'ch': 'Chamorro',
    //    'co': 'Corsican',
    //    'cr': 'Cree',
    'cs': 'Czech',
    //    'cu': 'Old Church Slavonic, Church Slavic, Church Slavonic, Old Bulgarian, Old Slavonic',
    //    'cv': 'Chuvash',
    //    'cy': 'Welsh',
    'da': 'Danish',
    'de': 'German',
    //'dv': 'Divehi; Dhivehi; Maldivian;',
    //'dz': 'Dzongkha',
    //'ee': 'Ewe',
    'el': 'Greek, Modern',
    'en': 'English',
    //'eo': 'Esperanto',
    'es': 'Spanish',
    'et': 'Estonian',
    //'eu': 'Basque',
    //'fa': 'Persian',
    //'ff': 'Fula; Fulah; Pulaar; Pular',
    'fi': 'Finnish',
    //'fj': 'Fijian',
    //'fo': 'Faroese',
    'fr': 'French',
    //    'fy': 'Western Frisian',
    //    'ga': 'Irish',
    //    'gd': 'Scottish Gaelic; Gaelic',
    //    'gl': 'Galician',
    //    'gn': 'Guaran',
    //    'gu': 'Gujarati',
    //    'gv': 'Manx',
    //    'ha': 'Hausa',
    //'he': 'Hebrew',
    'hi': 'Hindi', // only in google
    //    'ho': 'Hiri Motu',
    //    'hr': 'Croatian',
    //'ht': 'Haitian; Haitian Creole',
    'hu': 'Hungarian',
    //'hy': 'Armenian',
    //'hz': 'Herero',
    //'ia': 'Interlingua',
    'id': 'Indonesian',
    //'ie': 'Interlingue',
    //    'ig': 'Igbo',
    //    'ii': 'Nuosu',
    //    'ik': 'Inupiaq',
    //    'io': 'Ido',
    //    'is': 'Icelandic',
    'it': 'Italian',
    //'iu': 'Inuktitut',
    'iw': 'Hebrew',
    'ja': 'Japanese',
    //'jv': 'Javanese (jv)',
    //    'ka': 'Georgian',
    //    'kg': 'Kongo',
    //    'ki': 'Kikuyu, Gikuyu',
    //    'kj': 'Kwanyama, Kuanyama',
    //    'kk': 'Kazakh',
    //    'kl': 'Kalaallisut, Greenlandic',
    //    'km': 'Khmer',
    //    'kn': 'Kannada',
    'ko': 'Korean',
    //    'kr': 'Kanuri',
    //    'ks': 'Kashmiri',
    //    'ku': 'Kurdish',
    //    'kv': 'Komi',
    //    'kw': 'Cornish',
    //    'ky': 'Kirghiz, Kyrgyz',
    //    'la': 'Latin',
    //    'lb': 'Luxembourgish, Letzeburgesch',
    //    'lg': 'Luganda',
    //    'li': 'Limburgish, Limburgan, Limburger',
    //    'ln': 'Lingala',
    //    'lo': 'Lao',
    'lt': 'Lithuanian',
    //    'lu': 'Luba-Katanga',
    'lv': 'Latvian',
    //    'mg': 'Malagasy',
    //    'mh': 'Marshallese',
    //    'mi': 'Maori',
    //    'mk': 'Macedonian',
    //    'ml': 'Malayalam',
    //    'mn': 'Mongolian',
    //    'mr': 'Marathi ',
    //    'ms': 'Malay',
    //    'mt': 'Maltese',
    //    'my': 'Burmese',
    //    'na': 'Nauru',
    //    'nb': 'Norwegian Bokmyl',
    //    'nd': 'North Ndebele',
    //    'ne': 'Nepali',
    //    'ng': 'Ndonga',
    'nl': 'Dutch',
    //    'nn': 'Norwegian Nynorsk',
    'no': 'Norwegian',
    //    'nr': 'South Ndebele',
    //    'nv': 'Navajo, Navaho',
    //    'ny': 'Chichewa; Chewa; Nyanja',
    //    'oc': 'Occitan',
    //    'oj': 'Ojibwe, Ojibwa',
    //    'om': 'Oromo',
    //    'or': 'Oriya',
    //    'os': 'Ossetian, Ossetic',
    //    'pa': 'Panjabi, Punjabi',
    //    'pi': 'Pali',
    'pl': 'Polish',
    //'ps': 'Pashto, Pushto',
    'pt': 'Portuguese',
    //'qu': 'Quechua',
    //'rm': 'Romansh',
    //'rn': 'Kirundi',
    'ro': 'Romanian, Moldavian, Moldovan',
    'ru': 'Russian',
    //'rw': 'Kinyarwanda',
    //    'sa': 'Sanskrit',
    //    'sc': 'Sardinian',
    //    'sd': 'Sindhi',
    //    'se': 'Northern Sami',
    //    'sg': 'Sango',
    //    'si': 'Sinhala, Sinhalese',
    'sk': 'Slovak',
    'sl': 'Slovene',
    //    'sm': 'Samoan',
    //    'sn': 'Shona',
    //    'so': 'Somali',
    //    'sq': 'Albanian',
    //    'sr': 'Serbian',
    //    'ss': 'Swati',
    //    'st': 'Southern Sotho',
    //    'su': 'Sundanese',
    'sv': 'Swedish',
    //    'sw': 'Swahili',
    //    'ta': 'Tamil',
    //    'te': 'Telugu',
    //    'tg': 'Tajik',
    'th': 'Thai',
    //    'ti': 'Tigrinya',
    //    'tk': 'Turkmen',
    //    'tl': 'Tagalog',
    //    'tn': 'Tswana',
    //    'to': 'Tonga (Tonga Islands)',
    'tr': 'Turkish',
    //    'ts': 'Tsonga',
    //    'tt': 'Tatar',
    //    'tw': 'Twi',
    //    'ty': 'Tahitian',
    //    'ug': 'Uighur, Uyghur',
    'uk': 'Ukrainian',
    //    'ur': 'Urdu',
    //    'uz': 'Uzbek',
    //    've': 'Venda',
    'vi': 'Vietnamese',
    //    'vo': 'Volapk',
    //    'wa': 'Walloon',
    //    'wo': 'Wolof',
    //    'xh': 'Xhosa',
    'yi': 'Yiddish',
    //    'yo': 'Yoruba',
    //    'za': 'Zhuang, Chuang',
    'zh': 'Chinese'
    //    'zh-CHS': chinese simplfied,
    //    'zh-CHT': chinese traditional,
    //    'zu': 'Zulu'
};

ISQ.Tools.LanguageSynonym =
{
    'zh-CHS': 'Chinese',
    'zh-CHT': 'Chinese',
    'zh-CN': 'Chinese',
    'he': 'Hebrew'
}

//////////////////////////////////////////////////////////////////////////
// returns the language name by its two letter representation
ISQ.Tools.getLanguageName = function (langCode)
{
    var lang = ISQ.Tools.Languages[langCode];
    if (!lang) lang = ISQ.Tools.LanguageSynonym[langCode];
    if (!lang) return null;
    return lang;
}
;
//ISQInclude='/common/tools-js/language-lib2.js';
/********************************************************
///////////////////// [ HTML ] //////////////////////////
********************************************************/
ISQ.Tools.pagerSeperator = '<page_separator/>';



//////////////////////////////////////////////////////////////////////////
// returns a random 7 digit number
ISQ.Data.uniqueId = function ()
{
    return Math.floor(Math.random() * 10000000);
};
ISQ.Data.nowMili = new Date().getTime();
ISQ.Data.dayInMs = 24 * 60 * 60 * 1000;



//#region HTML

ISQ.Tools.HTML = initializeNS('ISQ.Tools.HTML');

// opens a popup window in the center of the screen
ISQ.Tools.HTML.openPopup = function (url, name, width, height, scrolling)
{
    var left = (screen.width / 2) - (width / 2);
    var top = (screen.height / 2) - (height / 2);
    var scrollbars = scrolling || 'no';
    return window.open(url, name, 'toolbar=no, location=no, directories=no, status=no, menubar=no, scrollbars=' + scrollbars + ', resizable=no, copyhistory=no, width=' + width + ', height=' + height + ', top=' + top + ', left=' + left);
}

//#endregion

ISQ.Data.decodeEntities = function (text)
{
    if (typeof (jQuery) === 'function')
        return $("<div/>").html(text).text();

    try
    {
        if (!ISQ.Data.entityDecoderElement)
            ISQ.Data.entityDecoderElement = createElement("textarea", document.body, "display:none;visibility:hidden;position:absolute;top:100px;left:13px;");
        ISQ.Data.entityDecoderElement.innerHTML = ISQ.Data.unHTML(text);
        return ISQ.Data.entityDecoderElement.value;
    }
    catch (ex) // #2767: only happens in IE8 in compatibility mode
    {
        return text;
    }
}

//////////////////////////////////////////////////////////////////////////
// parses article's context (id,string,id,string...) to an array which key=id, value=string
ISQ.Data.parseArticleContext = function (stringValue, returnOnlyContext)
{
    result = new Array();
    var ndx = 0, inContext = false, lastNdx = 0, foundId;
    while (ndx < stringValue.length)
    {
        ndx = stringValue.indexOf(",", lastNdx);
        if (ndx === -1) ndx = stringValue.length;
        inContext = !inContext;
        if (inContext) // found id
        {
            foundId = stringValue.substring(lastNdx, ndx++);
        }
        else // found name
        {
            if (!returnOnlyContext)
                result[foundId] = stringValue.substring(lastNdx, ndx++);
            else
                result.push(stringValue.substring(lastNdx, ndx++));
        }
        lastNdx = ndx;
    }
    return result;
};


ISQ.Tools = initializeNS('ISQ.Tools');

ISQ.Tools.setSelectionRange = function (element, selStart, selEnd)
{
    if (element.setSelectionRange)
    {
        element.setSelectionRange(selStart, selEnd);
        return;
    }
    if (element.createTextRange)
    {
        var range = element.createTextRange();
        range.collapse(true);
        range.moveEnd('character', selEnd);
        range.moveStart('character', selStart);
        range.select();
    }
}

ISQ.Tools.createEditableDateInput = function ()
{
    var inputDateContainer = $('<div class="input-date-container">')

    inputDateContainer.on('click', function (e)
    {
        if (e.target.nodeName != "INPUT")
        {
            $(dInput).focus();
        }
    });


    //Date input 
    var dInput = createInput('text');
    ISQ.Tools.forceNumericValue(dInput, 2);

    $(dInput).keydown(function (e)
    {
        //RIGHT arrow button
        if (e.keyCode == 39)
        {
            return;
        }
        var val = this.value;

        if (val.length == 2 && this.cursor > 2)
        {
            //If value is bigger than max day, set it to "1"
            if (val > 31)
            {
                this.cursor = 0;
                ISQ.Tools.setSelectionRange(this, 0, 0);
                this.value = '01';
            } else
            {
                try { $(mInput).focus(); } catch (e) { }
            }
        }

        if (e.keyCode == 13)
        {
            inputDateContainer.trigger('change', getValue());
            return;
        }

        var val = this.value;
        if (isNumberKey(e.keyCode))
        {
            var num = getNumberFromChartCode(e.keyCode);

            if (this.cursor == 0)
            {
                this.value = num + this.value.substr(-1);
                this.cursor++;

                setTimeout(function ()
                {
                    ISQ.Tools.setSelectionRange(this, 1, 2);
                } .bind(this), 20)

            }
            else if (this.cursor == 1)
            {
                this.value = this.value.substr(0, 1) + num;
                this.cursor++;
                ISQ.Tools.setSelectionRange(this, 2, 2);
                //Maybe focus?
                
                $(mInput).focus();
            }
        }

        if (e.keyCode == 39)
        {
            if (this.cursor <= 1)
            {
                this.cursor++;
                ISQ.Tools.setSelectionRange(this, this.cursor, this.cursor);
            } else
            {
                $(mInput).focus();
                e.preventDefault();
            }
            e.preventDefault();
        }
    });

    $(dInput).keydown(function (e)
    {
       
    })

    $(dInput).click(function ()
    {
        try { $(this).focus(); } catch (e) { };
    });

    $(dInput).focus(function ()
    {
        try
        {
            ISQ.Tools.setSelectionRange(this, 0, 2);
            this.cursor = 0;
        } catch (e) { };
    });

    $(dInput).blur(function ()
    {
        if (this.value > 31)
            this.value = '31';
            
       if (this.value == '00')
            this.value = '01';

        if (this.value.length == 1)
            this.value = '0' + this.value;

        inputDateContainer.trigger('change', getValue());

    });

    //month input 
    var mInput = createInput('text');
    ISQ.Tools.forceNumericValue(mInput, 2);
    $(mInput).keydown(function (e)
    {

        if (e.keyCode == 39)
        {
            return;
        }

        var val = this.value;
            
        if (val.length == 2 && this.cursor > 2)
        {
            if (val > 12)
            {
                this.cursor = 0;
                ISQ.Tools.setSelectionRange(this, 0, 0);
                this.value = '01'
            } else
            {
                try { $(yInput).focus(); } catch (e) { }
            }
        }

        if (e.keyCode == 13)
        {
            inputDateContainer.trigger('change', getValue());
            return;
        }

        var val = this.value;
        if (isNumberKey(e.keyCode))
        {
            var num = getNumberFromChartCode(e.keyCode);
            if (this.cursor == 0)
            {
                this.value = num + this.value.substr(-1);
                this.cursor++;
                setTimeout(function ()
                {
                    ISQ.Tools.setSelectionRange(this, 1, 2);
                } .bind(this), 20)

            }
            else if (this.cursor == 1)
            {
                this.value = this.value.substr(0, 1) + num;
                this.cursor++;
                ISQ.Tools.setSelectionRange(this, 2, 2);
                //Maybe focus year?
                try { $(yInput).focus(); } catch (e) { }
            }
        }

        if (e.keyCode == 39)
        {
            if (this.cursor <= 1)
            {
                this.cursor++;
                ISQ.Tools.setSelectionRange(this, this.cursor, this.cursor);
            } else
            {
                try { $(yInput).focus(); } catch (e) { }
            }
            e.preventDefault();
        }

        if (e.keyCode == 37)
        {
            if (this.cursor > 0)
            {
                this.cursor--;
                ISQ.Tools.setSelectionRange(this, this.cursor, this.cursor);
            } else
            {
                try { $(dInput).focus(); } catch (e) { }
            }
            e.preventDefault();
        }

    });

    $(mInput).keydown(function (e)
    {
       
    })

    $(mInput).click(function ()
    {
        try { $(this).focus(); } catch (e) { }
    });

    $(mInput).focus(function (e)
    {
        setTimeout(function ()
        {
            try
            {
                ISQ.Tools.setSelectionRange(this, 0, 2);
                this.cursor = 0;
            } catch (e) { }
        } .bind(this), 0)
    });

    $(mInput).blur(function ()
    {
        if (this.value > 12)
            this.value = '12';
            
        if (this.value == '00')
            this.value = '01';

        if (this.value.length == 1)
            this.value = '0' + this.value;

        inputDateContainer.trigger('change', getValue());
    });

    //Year input 
    var yInput = createInput('text', null, null, null, null, '.year');
    ISQ.Tools.forceNumericValue(yInput, 4);

    $(yInput).keydown(function (e)
    {
        if (e.keyCode == 13)
        {
            inputDateContainer.trigger('change', getValue());
            return;
        }


        var val = this.value;
        if (isNumberKey(e.keyCode))
        {
            var num = getNumberFromChartCode(e.keyCode);
            if (this.cursor == 0)
            {
                this.value = num + this.value.substr(1);
                this.cursor++;
                setTimeout(function ()
                {
                    ISQ.Tools.setSelectionRange(this, 1, 4);
                } .bind(this), 20)
            }
            else if (this.cursor < 4)
            {
                this.value = this.value.substr(0, this.cursor) + num + this.value.substr(this.cursor + 1);
                //this.setSelectionRange( this.cursor,  this.cursor);
                this.cursor++;

                if (this.cursor == 4 && toDateInput)
                {
                    try { toDateInput.find('input:first').focus(); } catch (e) { }
                    e.preventDefault();
                } else
                {
                    setTimeout(function ()
                    {
                        ISQ.Tools.setSelectionRange(this, this.cursor, 4);
                    } .bind(this), 20)
                }
                
                if (this.value == '0000')
                {
                    this.value = new Date().getFullYear();
                }

            }
        }

        if (e.keyCode == 37)
        {
            if (this.cursor > 0)
            {
                this.cursor--;
                ISQ.Tools.setSelectionRange(this, this.cursor, this.cursor);
            } else
            {
                try { $(mInput).focus(); } catch (e) { }
            }
            e.preventDefault();
        }

        if (e.keyCode == 39)
        {
            if (this.cursor <= 3)
            {
                this.cursor++;
                ISQ.Tools.setSelectionRange(this, this.cursor, this.cursor);
            } else
            {
                if (toDateInput)
                {
                    try { toDateInput.find('input:first').focus(); } catch (e) { }
                    e.preventDefault();
                }
                //$(yInput).focus();
            }
            e.preventDefault();
        }

        if (toDateInput && e.keyCode == 9)
        {
            try { toDateInput.find('input:first').eq(0).focus(); } catch (e) { }
            e.preventDefault();
        }
    })

    $(yInput).blur(function ()
    {
        var val = $(this).val();
        if (val.length < 4)
        {
            $(this).val(new Date().getFullYear())
            this.cursor = 0;
            ISQ.Tools.setSelectionRange(this, 0, 0);
        }
        
        if(val == '0000')
        {
            this.value = new Date().getFullYear();
        }

        inputDateContainer.trigger('change', getValue());

    });

    $(yInput).click(function ()
    {
        try { $(this).focus(); } catch (e) { }
    });

    $(yInput).focus(function ()
    {
        setTimeout(function ()
        {
            try
            {
                ISQ.Tools.setSelectionRange(this, 0, 4);
                this.cursor = 0;
            } catch (e) { }
        } .bind(this), 0)
    });

    function getValue()
    {
        return dInput.value + '/' + mInput.value + '/' + yInput.value;
    }

    function isNumberKey(keyCode)
    {
        return keyCode >= 48 && keyCode <= 57 || keyCode >= 96 && keyCode <= 105;
    }

    function getNumberFromChartCode(keyCode)
    {
        return String.fromCharCode((96 <= keyCode && keyCode <= 105) ? keyCode - 48 : keyCode)
    }

    //Public method fro setting value
    inputDateContainer.setValue = function (dateStr)
    {
        dInput.value = dateStr.substr(0, 2);
        mInput.value = dateStr.substr(3, 2);
        yInput.value = dateStr.substr(6, 4);
    }

    var toDateInput = null;


    //Link to another date component to switch to it by TAB
    inputDateContainer.linkToDate = function (dateInput)
    {
        toDateInput = dateInput;
    }

    inputDateContainer.append(dInput)
    inputDateContainer.append($('<span>/</span>'))
    inputDateContainer.append(mInput)
    inputDateContainer.append($('<span>/</span>'))
    inputDateContainer.append(yInput)

    return inputDateContainer;
}



;
/********************************************************
////////////////// [ Local Storage] /////////////////////
********************************************************/
//#region Local Storage
ISQ.Tools = initializeNS('ISQ.Tools');
ISQ.Tools.Storage = initializeNS('ISQ.Tools.Storage');
ISQ.Tools.Storage.HTML5 = false;
try
{
    ISQ.Tools.Storage.HTML5 = window['localStorage'] !== null && typeof (window['localStorage']) !== 'undefined';
} catch (ex) { /* ie10 from spoon may throw exception here #8853 */ }
ISQ.Tools.Storage.get = function (key, sessionOnly)
{
    if (!ISQ.Tools.Storage.HTML5) return null;
    if (sessionOnly)
        return window['sessionStorage'].getItem(key);
    else
        return window['localStorage'].getItem(key);
}
ISQ.Tools.Storage.set = function (key, val, sessionOnly)
{
    if (!ISQ.Tools.Storage.HTML5) return false;
    if (sessionOnly)
        window['sessionStorage'].setItem(key, val);
    else
        window['localStorage'].setItem(key, val);
    return true;
}
ISQ.Tools.Storage.remove = function (key, sessionOnly)
{
    if (!ISQ.Tools.Storage.HTML5) return;
    if (sessionOnly)
        window['sessionStorage'].removeItem(key);
    else
        window['localStorage'].removeItem(key);
}
ISQ.Tools.Storage.clear = function (sessionOnly)
{
    if (!ISQ.Tools.Storage.HTML5) return;
    if (sessionOnly)
        window['sessionStorage'].clear();
    else
        window['localStorage'].clear();
}
//#endregion;

//#region Code shortcuts
ISQ.Tools = initializeNS('ISQ.Tools');
ISQ.Tools.foreach = function (arr, func)
{
    for (var i in arr)
    {
        var result = null;
        if (ISQ.Base.isDerivedOf(func, ISQ.Handler))
            result = func.handle(arr[i], i);
        else
            result = func(arr[i], i);
        if (result === false) break;
    }
}
window.foreach = ISQ.Tools.foreach;

ISQ.Tools.iteration = function (arr, func, backwards)
{
    if (!backwards)
    {
        for (var i = 0; i < arr.length; ++i)
        {
            var result = null;
            if (ISQ.Base.isDerivedOf(func, ISQ.Handler))
                result = func.handle(arr[i], i);
            else
                result = func(arr[i], i);
            if (result === false) break;
        }
    }
    else
    {
        for (var i = arr.length - 1; i >= 0; --i)
        {
            var result = null;
            if (ISQ.Base.isDerivedOf(func, ISQ.Handler))
                result = func.handle(arr[i], i);
            else
                result = func(arr[i], i);
            if (result === false) break;
        }
    }
}
window["iteration"] = window._it = ISQ.Tools.iteration;

//#endregion;</script>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
if (typeof(ISQ.Infra) === 'undefined') ISQ.Infra = {};

ISQ.Infra.Queue = ISQ.Base.extend({name: "ISQ.Infra.Queue"});
ISQ.Infra.Queue.prototype.ctor = function()
{
}
ISQ.Infra.Queue.prototype.dtor = function ()
{
    this.reset();
    delete this.mArray;
}


ISQ.Infra.Queue.prototype.mArray = null;
ISQ.Infra.Queue.prototype.mLength = 0;
ISQ.Infra.Queue.prototype.mDndx = 0;
ISQ.Infra.Queue.prototype.mEndx = 0;
ISQ.Infra.Queue.prototype.mCount = 0;

ISQ.Infra.Queue.prototype.count = function()
{
	return this.mCount;	
}
ISQ.Infra.Queue.prototype.init = function()
{
	this.mLength = 5;
	this.mArray = new Array(this.mLength);
	
	// resetting the array
	for(var i=0;i<this.mLength;++i)
		this.mArray[i] = null;
}

ISQ.Infra.Queue.prototype.enqueue = function(object)
{
	// checking parameter
	if (object === null) return;
	
	// first initiation of the array
	if (this.mArray === null) this.init();
	
	// if enqueue index is full, enlarging array
	if (this.mArray[this.mEndx] !== null) this.enlarge();
	
	// inserting object
	this.mArray[this.mEndx++] = object;
	// making sure index is in bounds //
	if (this.mEndx === this.mLength) this.mEndx = 0;
	++this.mCount;
}

///////////
/// In priority queue, the object is added to the dequeue index
ISQ.Infra.Queue.prototype.priorityEnqueue = function(object)
{
	// checking parameter
	if (object === null) return;
	
	// first initiation of the array
	if (this.mArray === null) this.init();
	
	var array = new Array();
	array.push(object);
	var currentCount = this.mCount+1;
	while (this.mCount > 0)
	{
		array.push(this.dequeue());
	}

	this.mDndx = 0;
	this.mEndx = array.length;
	if (this.mLength < currentCount) this.mLength *= 2;
	this.mCount = currentCount;
	this.mArray = array;
}

ISQ.Infra.Queue.prototype.enlarge = function()
{
	var array = new Array();
	var currentCount = this.mCount;
	while (this.mCount > 0)
		array.push(this.dequeue());

	this.mDndx = 0;
	this.mEndx = array.length;
	this.mLength *= 2;
	this.mCount = currentCount;
	this.mArray = array;
}

ISQ.Infra.Queue.prototype.dequeue = function()
{
	if (this.mCount === 0) return null;
	
	// making sure index is in bounds //
	if (this.mDndx === this.mLength) this.mDndx = 0;
	
	// pulling object
	var object = this.mArray[this.mDndx];
	this.mArray[this.mDndx++] = null;
	--this.mCount;
	
	// returning object
	return object;
}

ISQ.Infra.Queue.prototype.reset = function()
{
	this.mDndx = 0;
	this.mEndx = 0;
	this.mCount = 0;
	if (this.mArray !== null)
	{
	    for (var i = 0; i < this.mArray.length; ++i)
	    {
	        if (this.mArray[i])
	        {
	            if (typeof (this.mArray[i].dispose) === 'function') this.mArray[i].dispose();
	            delete this.mArray[i];
	        }
	    }
	}
}</script>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
if (typeof(ISQ.Infra) === 'undefined') ISQ.Infra = {};

ISQ.Infra.LinkedList = ISQ.Base.extend({name: "ISQ.Infra.LinkedList"});

ISQ.Infra.LinkedList.prototype.ctor = function()
{};
ISQ.Infra.LinkedList.prototype.dtor = function()
{
	var node = this.mHead;
	while(node !== null)
	{
		var curr = node;
		node = node.mNext;
		curr.dispose();		
	}
	this.mHead = null;
	this.mTail = null;
	this.mCount = 0;
};

///////////////////////////////////////////////////////
/////////////////////////////////////////////////////// Members
///////////////////////////////////////////////////////
ISQ.Infra.LinkedList.prototype.mHead = null;
ISQ.Infra.LinkedList.prototype.mTail = null;
ISQ.Infra.LinkedList.prototype.mCount = 0;

///////////////////////////////////////////////////////
/////////////////////////////////////////////////////// Properties
///////////////////////////////////////////////////////
ISQ.Infra.LinkedList.prototype.head = function()
{
	return this.mHead;
}
ISQ.Infra.LinkedList.prototype.tail = function()
{
	return this.mTail;
}
ISQ.Infra.LinkedList.prototype.count = function()
{
	return this.mCount;
}

///////////////////////////////////////////////////////
/////////////////////////////////////////////////////// Methods
///////////////////////////////////////////////////////
ISQ.Infra.LinkedList.prototype.addFirst = function(nodeOrData)
{
	var node = nodeOrData;
	if (!ISQ.Base.isDerivedOf(node, ISQ.Infra.LinkedListNode)) node = new ISQ.Infra.LinkedListNode(nodeOrData, this);
	if (node.mList !== this) throw("ISQ.Infra.LinkedList.addFirst() ");
	
	if (this.mHead === null)
	{
		this.mHead = node;
		this.mTail = node;
	}
	else
	{
		this.mHead.mPrevious = node;
		node.mNext = this.mHead;
		this.mHead = node;
	}
	
	++this.mCount;
	
	return node;
}
ISQ.Infra.LinkedList.prototype.addLast = function(nodeOrData)
{
	var node = nodeOrData;
	if (!ISQ.Base.isDerivedOf(node, ISQ.Infra.LinkedListNode)) node = new ISQ.Infra.LinkedListNode(nodeOrData, this);
	if (node.mList !== this) throw("ISQ.Infra.LinkedList.addLast() tried to remove non-existing value");
	
	if (this.mTail === null)
	{
		this.mHead = node;
		this.mTail = node;
	}
	else
	{
		this.mTail.mNext = node;
		node.mPrevious = this.mTail;
		this.mTail = node;
	}
	
	++this.mCount;
	
	return node;
}
ISQ.Infra.LinkedList.prototype.setFirst = function (node)
{
    if (this.head() === node) return node;

    this.remove(node, false);
    this.addFirst(node);

    return node;
}
ISQ.Infra.LinkedList.prototype.setLast = function(node)
{
    if (this.tail() === node) return node;

    this.remove(node, false);
	this.addLast(node);
	
	return node;
}
ISQ.Infra.LinkedList.prototype.remove = function (node, toDispose)
{
    if (!ISQ.Base.isDerivedOf(node, ISQ.Infra.LinkedListNode)) throw ("ISQ.Infra.LinkedList.remove() Unexpected node type");
    if (node.mList !== this) throw ("ISQ.Infra.LinkedList.remove() tried to remove non-existing value");

    if (this.mCount === 1)
    {
        this.mHead = null;
        this.mTail = null;
    }
    else if (this.mHead === node)
    {
        this.mHead = node.mNext;
        this.mHead.mPrevious = null;
    }
    else if (this.mTail === node)
    {
        this.mTail = node.mPrevious;
        this.mTail.mNext = null;
    }
    else
    {
        node.mPrevious.mNext = node.mNext;
        node.mNext.mPrevious = node.mPrevious;
    }

    node.mNext = null;
    node.mPrevious = null;
    --this.mCount;

    // disposing node
    if (toDispose !== false) node.dispose();
}
ISQ.Infra.LinkedList.prototype.contains = function (nodeToFind)
{
    var node = this.mHead;
    while (node !== null)
    {
        if (node === nodeToFind) return true;
        node = node.mNext;
    }
    return false;
}
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////////// 
//////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////// LINKED LIST NODE
ISQ.Infra.LinkedListNode = ISQ.Base.extend({name: "ISQ.Infra.LinkedListNode"});
ISQ.Infra.LinkedListNode.prototype.ctor = function()
{
	this.mData = arguments[0];
	this.mList = arguments[1];
	this.mPrevious = null;
	this.mNext = null;
};
ISQ.Infra.LinkedListNode.prototype.dtor = function ()
{
    this.mData = null;
    delete this.mData;
    delete this.mNext;
    delete this.mPrevious;
    delete this.mList;
};
///////////////////////////////////////////////////////
/////////////////////////////////////////////////////// Members
///////////////////////////////////////////////////////
ISQ.Infra.LinkedListNode.prototype.mData = null;
ISQ.Infra.LinkedListNode.prototype.mNext = null;
ISQ.Infra.LinkedListNode.prototype.mPrevious = null;
ISQ.Infra.LinkedListNode.prototype.mList = null;

///////////////////////////////////////////////////////
/////////////////////////////////////////////////////// Properties
///////////////////////////////////////////////////////
ISQ.Infra.LinkedListNode.prototype.data = function()
{
	if (arguments.length === 0) return this.mData;
	this.mData = arguments[0];
}
ISQ.Infra.LinkedListNode.prototype.next = function()
{
	return this.mNext;
}
ISQ.Infra.LinkedListNode.prototype.previous = function()
{
	return this.mPrevious;
}

</script>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
if (typeof(ISQ.Infra) === 'undefined') ISQ.Infra = {};

ISQ.Infra.Stack = ISQ.Base.extend({name: "ISQ.Infra.Stack"});

ISQ.Infra.Stack.prototype.ctor = function()
{};
ISQ.Infra.Stack.prototype.dtor = function ()
{
    this.clear();
};

///////////////////////////////////////////////////////
/////////////////////////////////////////////////////// Members
///////////////////////////////////////////////////////
ISQ.Infra.Stack.prototype.mArr = null;
ISQ.Infra.Stack.prototype.mIndex = -1;

///////////////////////////////////////////////////////
/////////////////////////////////////////////////////// Properties
///////////////////////////////////////////////////////
ISQ.Infra.Stack.prototype.pop = function ()
{
    var dat = this.mArr[this.mIndex];
    this.mArr[this.mIndex--] = null;
    return dat;
}
ISQ.Infra.Stack.prototype.peek = function ()
{
    if (this.mIndex === -1) return null;
    return this.mArr[this.mIndex];
}
ISQ.Infra.Stack.prototype.count = function ()
{
    return this.mIndex;
}

///////////////////////////////////////////////////////
/////////////////////////////////////////////////////// Methods
///////////////////////////////////////////////////////
ISQ.Infra.Stack.prototype.push = function (data)
{
    if (!this.mArr)
    {
        this.mArr = new Array();
        this.mIndex = -1;
    }

    this.mArr[++this.mIndex] = data;
}
ISQ.Infra.Stack.prototype.clear = function ()
{
    this.mArr = null;
}</script>
    
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
ISQ.Html = initializeNS("ISQ.Html");

ISQ.Html = initializeNS("ISQ.Html");
///////////////////////////////////////////
/////// [Detecting Elements] //////////////
///////////////////////////////////////////
//#region Detecting Elements
ISQ.Html._ = function (string, forceUpdate_IE)
{
    if (!string) return null;

    var pointer = null;
    if (typeof (string) === 'string')
    {
        // document.getElementById() in IE browsers
        // traverses the DOM until finding the id.
        // In order to optimized this, we create a map/hashtable.
        if (ISQ.Http.browser.app === 'ie')
        {
            if (!ISQ.Html.IE_idMap)
            {
                ISQ.Html.IE_idMap = new Array();

                // adding to session GC
                if (typeof (ISQ.Console) !== 'undefined' && typeof (sessionGC) === 'function')
                {
                    sessionGC().add(ISQ.Html.IE_idMap);
                    ISQ.Html.IE_idMap.dispose = function ()
                    {
                        ISQ.Html.IE_idMap = new Array();
                    }
                }
            }
            // trying to get from our map
            if (!forceUpdate_IE)
            {
                pointer = ISQ.Html.IE_idMap[string];
                // We MUST return a pointer to an element within the document. 
                // Since we created a hashtable for IE browsers, we verify it
                if (ISQ.Http.browser.isIE && pointer)
                {
                    var pp = pointer;
                    do
                    {
                        pp = pp.parentNode;
                    } while (pp !== null && pp !== document);
                    if (pp === null) pointer = null;
                }
            }
            // performing document.getElementById()
            // and storing in our map
            if (!pointer || forceUpdate_IE === true)
            {
                pointer = document.getElementById(string);
                if (pointer) ISQ.Html.IE_idMap[string] = pointer;
            }
        }
        // other browsers stored id in a map/hashtable
        else
        {
            pointer = document.getElementById(string);
        }
    }
    else if (typeof (string) === 'object' && typeof (string.parentNode) !== 'undefined' && typeof (string.nodeName) !== 'undefined')
    {
        pointer = string;
    }

    return pointer;
};
if (typeof (window['_']) !== 'function') window['_'] = ISQ.Html._;;
ISQ.Html = initializeNS("ISQ.Html");
ISQ.Html.pageDirection = function ()
{
    if (!ISQ.Html._pageDirection)
    {
        ISQ.Html._pageDirection = document.body.getAttribute('dir');
        if (!ISQ.Html._pageDirection) ISQ.Html._pageDirection = ISQ.CSS.getValue(document.body, 'direction');
        if (!ISQ.Html._pageDirection) ISQ.Html._pageDirection = "ltr";
    }
    return ISQ.Html._pageDirection;
}

//#region element sizes
///////////////////////////////////////////
/////////// [Minimum Height] ///////////
///////////////////////////////////////////
ISQ.Html.setMinHeight = function (element, height)
{
    element = ISQ.Html._(element);
    if (element === null) return;

    if (element.offsetHeight < height) element.style.height = height + "px";
};

///////////////////////////////////////////
/////////// [Actual Height] ///////////
///////////////////////////////////////////
ISQ.Html.actualHeight = function (element)
{
    var elem = $(element);
    var height = elem.height();

    // borders
    var bt = elem.css("border-top");
    if (bt) height += parseInt(bt);
    var bb = elem.css("border-bottom");
    if (bb) height += parseInt(bb);

    // padding
    var pt = elem.css("padding-top");
    if (pt) height += parseInt(pt);
    var pb = elem.css("padding-bottom");
    if (pb) height += parseInt(pb);

    return height;
}
//#endregion


///////////////////////////////////////////
/////////// [Redraw] ///////////
///////////////////////////////////////////
ISQ.Html.redraw = function (elm)
{
    var prevStyle = ISQ.CSS.getElementStyle(elm, "display");
    elm.style.display = 'inline';
    var x = elm.offsetHeight; // no need to store this anywhere, the reference is enough
    elm.style.display = prevStyle;
    return x;
};
ISQ.Html = initializeNS("ISQ.Html");

///////////////////////////////////////////
/////////// [element position] ///////////
///////////////////////////////////////////
ISQ.Html.position_new = function (element, relativeElement)
{
    // not supporting relative positioning
    if (relativeElement) return ISQ.Html.position(element, relativeElement);

    // in case browser doesn't support this method
    if (typeof (element.getBoundingClientRect) == 'undefined' || !element.getBoundingClientRect)
        return ISQ.Html.position(element, relativeElement);

    // using native method
    var rect = element.getBoundingClientRect();
    rect.x = rect.left;
    rect.y = rect.top;
    return rect;
}
ISQ.Html.position = function (element, relativeElement, newAlgorithm)
{
    var position = { x: -1, y: -1 };

    // getting element //
    element = ISQ.Html._(element);

    // no element //
    if (element === null) return position;

    // getting offset parent
    var offsetParentNode = ISQ.Html._(relativeElement) || document.body;

    // calculating position //
    position.x = 0;
    position.y = 0;
    var _parent = element;
    while (_parent !== null && _parent !== offsetParentNode && _parent !== document.body && _parent.nodeName !== "HTML")
    {
        position.x += _parent.offsetLeft;
        position.x -= _parent.scrollLeft;
        var lm = parseInt(ISQ.CSS.getElementStyle(_parent, "margin-left"));

        position.x -= isNaN(lm) ? 0 : lm;
        position.y += _parent.offsetTop;
        position.y -= _parent.scrollTop;
        _parent = _parent.offsetParent;
    }

    if (offsetParentNode !== document.body && (_parent === document.body || _parent === null))
    {
        position.x = -1;
        position.y = -1;
    }

    element = null;
    relativeElement = null;

    return position;
};

//#endregion;
ISQ.Html = initializeNS("ISQ.Html");
///////////////////////////////////////////
///////// [browser screen size] ///////////
///////////////////////////////////////////
//#region screen/page size

ISQ.Html.screenSize = function ()
{
    return ISQ.Html.pageSize(true);
}
ISQ.Html.scrollBarWidth = function ()
{
    return 17;
}

ISQ.Html.scrollBarWidth_afterCheck = function ()
{
    var screen = ISQ.Html.screenSize();
    if (document.body.scrollHeight === screen.h) return 0;
    return ISQ.Html.scrollBarWidth();
}

///////////////////////////////////////////
/////////// [page size] ///////////
///////////////////////////////////////////
ISQ.Html.pageSize = function (onlyScreenSize, includeVerScrollBar)
{
    var res = { w: 0, h: 0 };

    //////////////////////////////////////////////////////////////////////////
    // screen size
    var screenSize = {};
    if (self && self.innerHeight) // all except Explorer
    {
        screenSize.w = self.innerWidth;
        screenSize.h = self.innerHeight;
    }
    else if (document.documentElement && document.documentElement.clientHeight) // Explorer 6 Strict Mode
    {
        screenSize.w = document.documentElement.clientWidth;
        screenSize.h = document.documentElement.clientHeight;
    }
    else if (document.body) // other Explorers
    {
        screenSize.w = document.body.clientWidth;
        screenSize.h = document.body.clientHeight;
    }

    //////////////////////////////////////////////////////////////////////////
    // scroll height + width
    var scrollW = ISQ.Html.getScroll('width');
    var scrollH = ISQ.Html.getScroll('height');

    //////////////////////////////////////////////////////////////////////////
    // calculating result 

    // width
    if (onlyScreenSize || screenSize.w > scrollW)
        res.w = screenSize.w;
    else
        res.w = scrollW;

    // height
    if ((onlyScreenSize && (!ISQ.Http.browser.isIPad || window.top !== window)) || screenSize.h > scrollH)
        res.h = screenSize.h;
    else
        res.h = scrollH;

    /// vertical scroll bar is shown
    if (scrollH > screenSize.h)
    {
        if (ISQ.CSS.getElementStyle(document.body, 'overflow') === 'hidden') return res;
        if (ISQ.CSS.getElementStyle(document.body, 'overflow-y') === 'hidden') return res;

        // non ie browsers, the width includes the vertical scroll-bar
        if (ISQ.Http.browser.app !== 'ie' || ISQ.Http.browser.isIE10 || ISQ.Http.browser.isIE9 || ISQ.Http.browser.isIE11)
        {
            if (!includeVerScrollBar)
                res.w -= ISQ.Html.scrollBarWidth();
        }
        // IE browsers, width not-including vertical scroll-bar
        else
        {
            if (includeVerScrollBar)
                res.w += ISQ.Html.scrollBarWidth();
        }

    }

    return res;
}
//#endregion

///////////////////////////////////////////
/////////// [scroll top/left] /////////////
///////////////////////////////////////////
//#region scroll top/left
ISQ.Html.getScroll = function (type)
{
    type = type || 'top';

    var result = 0;
    var scroll = 0;
    if (type === 'top')
    {
        if (ISQ.Http.browser.app !== 'ie' || ISQ.Http.browser.isIE10 || ISQ.Http.browser.isIE11)
            scroll = window.pageYOffset;
        if (ISQ.Http.browser.app !== 'ie')
            scroll = ISQ.Html.returnMaxScroll(scroll, window.scrollY);
        scroll = ISQ.Html.returnMaxScroll(scroll, document.body.scrollTop);
        scroll = ISQ.Html.returnMaxScroll(scroll, document.documentElement.scrollTop);
        scroll = ISQ.Html.returnMaxScroll(scroll, document.body.parentNode.scrollTop);
    }
    else if (type === 'left')
    {
        if (ISQ.Http.browser.app !== 'ie' || ISQ.Http.browser.isIE10 || ISQ.Http.browser.isIE11)
            scroll = window.pageXOffset;
        if (ISQ.Http.browser.app !== 'ie')
            scroll = ISQ.Html.returnMaxScroll(scroll, window.scrollX);
        scroll = ISQ.Html.returnMaxScroll(scroll, document.body.scrollLeft);
        scroll = ISQ.Html.returnMaxScroll(scroll, document.documentElement.scrollLeft);
        scroll = ISQ.Html.returnMaxScroll(scroll, document.body.parentNode.scrollLeft);
    }
    else if (type === 'height')
    {
        switch (ISQ.Http.browser.app)
        {
            case "chrome":
            case "ff":
            case "opera":
            case "safari":
                // iframe
                if (window.top === window)
                    scroll = document.documentElement.scrollHeight;
                // top window
                else
                    scroll = document.body.scrollHeight;
                break;
            default:
                scroll = ISQ.Html.returnMaxScroll(scroll, document.body.scrollHeight);
                scroll = ISQ.Html.returnMaxScroll(scroll, document.documentElement.scrollHeight);
                scroll = ISQ.Html.returnMaxScroll(scroll, document.body.parentNode.scrollHeight);
                break;

        }
    }
    else if (type === 'width')
    {
        scroll = ISQ.Html.returnMaxScroll(scroll, document.body.scrollWidth);
        scroll = ISQ.Html.returnMaxScroll(scroll, document.documentElement.scrollWidth);
        scroll = ISQ.Html.returnMaxScroll(scroll, document.body.parentNode.scrollWidth);
    }

    return scroll;
}
ISQ.Html.returnMaxScroll = function (value1, value2)
{
    if (value1 > value2) return value1;
    return value2;
}
//#endregion;
ISQ.Html = initializeNS("ISQ.Html");
 ///////////////////////////////////////////
/////////// [DOM Event] ///////////
///////////////////////////////////////////
//#region DOM Event

ISQ.Html.getEventTarget = function (event4ff)
{
    return window.event ? window.event.srcElement : event4ff ? event4ff.target : null;
};
ISQ.Html.getDomEvent = function (event4ff)
{
    if (ISQ.Base.isDerivedOf(event4ff, ISQ.Html.DomEvent))
        return event4ff;
    return new ISQ.Html.DomEvent(event4ff);
};
ISQ.Html.DomEvent = ISQ.Base.extend({ name: "ISQ.Html.DomEvent" });
ISQ.Html.DomEvent.prototype.ctor = function (event4ff)
{
    this.domEvent = window.event || event4ff; // IE9 has both event4ff and window.event. it should use window.event.
    this.target = ISQ.Html.getEventTarget(event4ff);
};
ISQ.Html.DomEvent.prototype.dtor = function ()
{
    delete target;
    delete domEvent;
};
ISQ.Html.DomEvent.prototype.cancel = function ()
{
    if(!this.domEvent) return;
    if (this.domEvent.stopPropagation) this.domEvent.stopPropagation();
    if (this.domEvent.cancelBubble != null) this.domEvent.cancelBubble = true;
};
ISQ.Html.DomEvent.prototype.target = null;
ISQ.Html.DomEvent.prototype.domEvent = null;
//#endregion

///////////////////////////////////////////
/////////// [window.addEvents / window.removeEvents] ///////////
///////////////////////////////////////////
//#region window.AddEvents / window.removeEvents
window.addEvents = function (Element, eventType, Method)
{
    if (Element.addEventListener)
    {
        if (eventType.indexOf("on") == 0)
            eventType = eventType.charAt(2).toLowerCase() + eventType.slice(3);
        Element.addEventListener(eventType, Method);
    }
    else if (Element.attachEvent) // IE
    {
        if (eventType.indexOf("on") != 0)
            eventType = "on" + eventType;  //eventType.charAt(0).toUpperCase() + eventType.slice(1);
        Element.attachEvent(eventType, Method);
    }
}
window.removeEvents = function (Element, eventType, Method)
{
    if (Element.removeEventListener) // browsers
    {
        if (eventType.indexOf("on") == 0)
            eventType = eventType.charAt(2).toLowerCase() + eventType.slice(3);
        Element.removeEventListener(eventType, Method);
    }
    else if (Element.detachEvent) // IE
    {
        //   if (eventType.indexOf("on") != 0)
        //        eventType = "on" + eventType.charAt(0).toUpperCase() + eventType.slice(1);
        if (eventType.indexOf("on") != 0)
            eventType = "on" + eventType;
        Element.detachEvent(eventType, Method);
    }
}

//#endregion;
ISQ.Html = initializeNS("ISQ.Html");
///////////////////////////////////////////
/////////// [Scroll Event] ///////////
///////////////////////////////////////////
//#region scroll event
ISQ.Html.Scroll = initializeNS("ISQ.Html.Scroll");
ISQ.Html.Scroll.init = function ()
{
    if (ISQ.Html.Scroll._wasInit) return;
    ISQ.Html.Scroll._wasInit = true;
    ISQ.Html.Scroll._running = true;

    // adding to session GC
    if (typeof (ISQ.Console) !== 'undefined' && typeof (sessionGC) === 'function')
        sessionGC().add(ISQ.Html.Scroll);

    // creating event
    ISQ.Html.Scroll.event = new ISQ.Event();

    /////////// adding listeners ////////////////
    if (window.addEventListener)
        window.addEventListener('scroll', ISQ.Html.Scroll.scrollHandler, true);
    else if (window.attachEvent)
        window.attachEvent('onscroll', ISQ.Html.Scroll.scrollHandler);


    // updating intervals for older browesrs
    if (ISQ.Http.browser.isIE8 || ISQ.Http.browser.isIE7 || ISQ.Http.browser.isIE6)
    {
        ISQ.Html.Scroll.interval = 30;
        ISQ.Html.Scroll.diff = 65;
    }
}
ISQ.Html.Scroll.scrollHandler = function (event4ff)
{
    if (!ISQ.Html.Scroll._running) return;

    // getting target
    var target = ISQ.Html.getEventTarget(event4ff);
    if (target !== null && target !== document) return;

    // getting scroll
    var scroll =
    {
        left: ISQ.Html.getScroll('left'),
        top: ISQ.Html.getScroll('top')
    }

    // scroll wasn't changed
    if (ISQ.Html.Scroll.mLastScroll && ISQ.Html.Scroll.mLastScroll.left === scroll.left && ISQ.Html.Scroll.mLastScroll.top === scroll.top) return;
    ISQ.Html.Scroll.mLastScroll = scroll;


    // saving timestamp
    ISQ.Html.Scroll.timeStamp = new Date().getTime();

    // if a timer is running, returning
    if (ISQ.Html.Scroll.timer !== null) return;

    // running a timer
    ISQ.Html.Scroll.timer = setInterval(function ()
    {
        if (ISQ.Html.Scroll._running)
        {
            var now = new Date().getTime();
            if (now - ISQ.Html.Scroll.timeStamp < ISQ.Html.Scroll.diff) return;

            ISQ.Html.Scroll.event.dispatch(ISQ.Html.Scroll.mLastScroll, ISQ.Html.pageSize(), ISQ.Html.screenSize());
        }

        clearInterval(ISQ.Html.Scroll.timer);
        ISQ.Html.Scroll.timer = null;

    }, ISQ.Html.Scroll.interval);
}
ISQ.Html.Scroll.dispose = function ()
{
    ISQ.Html.Scroll._running = false;

    /////////// removing listeners ////////////////
    if (window.removeEventListener)
        window.removeEventListener('scroll', ISQ.Html.Scroll.scrollHandler, true);
    else if (window.detachEvent)
        window.detachEvent('onscroll', ISQ.Html.Scroll.scrollHandler);

    // disposing event
    ISQ.Html.Scroll.event.dispose();
    ISQ.Html.Scroll.event = null;
}
ISQ.Html.Scroll.interval = 5;
ISQ.Html.Scroll.diff = 11;
ISQ.Html.Scroll.timer = null;
//#endregion
;
ISQ.Html = initializeNS("ISQ.Html");
///////////////////////////////////////////
/////////// [Resize Event] ///////////
///////////////////////////////////////////
//#region resize event
ISQ.Html.ReSize = initializeNS("ISQ.Html.ReSize");
ISQ.Html.ReSize.enumListenTo =
{
    width: 1,
    height: 2,
    both: 3
}
ISQ.Html.ReSize.init = function (listenTo, skipTimer)
{
    if (!this.mListenTo) this.mListenTo = 0;
    this.mListenTo |= listenTo;
    ISQ.Html.ReSize.mSkipTimer |= skipTimer === true;
    if (ISQ.Html.ReSize.wasInit()) return;
    ISQ.Html.ReSize._wasInit = true;
    ISQ.Html.ReSize._running = true;
    // adding to session GC
    if (typeof (ISQ.Console) !== 'undefined' && typeof (sessionGC) == 'function')
        sessionGC().add(ISQ.Html.ReSize);

    // creating event
    ISQ.Html.ReSize.Event = new ISQ.Event();

    // saving current window size
    ISQ.Html.ReSize.mWindowSize_thisEvent = ISQ.Html.screenSize();
    ISQ.Html.ReSize.mWindowSize_browserEvent = ISQ.Html.screenSize();

    /////////// adding listeners ////////////////
    if (window.addEventListener)
    {
        window.addEventListener('resize', ISQ.Html.ReSize.resizeHandler, true);
        if (ISQ.Http.browser.isMobile)
            window.addEventListener('zoom', ISQ.Html.ReSize.resizeHandler, true);
    }
    else if (window.attachEvent)
        window.attachEvent('onresize', ISQ.Html.ReSize.resizeHandler);
}
ISQ.Html.ReSize.resizeHandler = function ()
{
    if (!ISQ.Html.ReSize._running) return;

    // if width wasn't changed, returning
    var dims = ISQ.Html.screenSize();

    // bug #1939: from some reason, in ie8 sometimes in this point, 
    // ISQ.Html.ReSize.mWindowSize_thisEvent = null
    // OR
    // ISQ.Html.ReSize.mWindowSize_browserEvent = null
    // if so, returning.
    if (!ISQ.Html.ReSize.mWindowSize_thisEvent || !ISQ.Html.ReSize.mWindowSize_browserEvent) return;

    // if current size equals to last known window size,
    // canceling timer and returning
    if ((dims.w === ISQ.Html.ReSize.mWindowSize_thisEvent.w || (ISQ.Html.ReSize.mListenTo & ISQ.Html.ReSize.enumListenTo.width) === 0)
        && (dims.h === ISQ.Html.ReSize.mWindowSize_thisEvent.h || (ISQ.Html.ReSize.mListenTo & ISQ.Html.ReSize.enumListenTo.height) === 0))
    {
        if (ISQ.Html.ReSize.timer)
        {
            clearInterval(ISQ.Html.ReSize.timer);
            ISQ.Html.ReSize.timer = null;
        }
        return;
    }

    // if current size equals the last size fired by browser event
    // returning
    if ((dims.w === ISQ.Html.ReSize.mWindowSize_browserEvent.w || (ISQ.Html.ReSize.mListenTo & ISQ.Html.ReSize.enumListenTo.width) === 0)
        && (dims.h === ISQ.Html.ReSize.mWindowSize_browserEvent.h || (ISQ.Html.ReSize.mListenTo & ISQ.Html.ReSize.enumListenTo.height) === 0)) return;

    // saving current window size
    ISQ.Html.ReSize.mWindowSize_browserEvent = dims;

    // saving timestamp
    ISQ.Html.ReSize.timeStamp = new Date().getTime();

    // if a timer is running, returning
    if (ISQ.Html.ReSize.timer != null && typeof (ISQ.Html.ReSize.timer) !== 'undefined') return;

    // skipping timer:
    // timer is used to prevent interpreting resize event multiple times and
    // to fire 1 event every X ms.
    if (ISQ.Html.ReSize.mSkipTimer)
    {
        // firing event
        ISQ.Html.ReSize.Event.dispatch();

        // saving window size
        ISQ.Html.ReSize.mWindowSize_thisEvent = ISQ.Html.ReSize.mWindowSize_browserEvent;
        return;
    }

    // running a timer
    ISQ.Html.ReSize.timer = setInterval(function ()
    {
        if (ISQ.Html.ReSize._running)
        {
            var now = new Date().getTime();
            if (now - ISQ.Html.ReSize.timeStamp < ISQ.Html.ReSize.diff) return;

            // firing event
            ISQ.Html.ReSize.Event.dispatch();

            // saving window size
            ISQ.Html.ReSize.mWindowSize_thisEvent = ISQ.Html.ReSize.mWindowSize_browserEvent;
        }

        clearInterval(ISQ.Html.ReSize.timer);
        ISQ.Html.ReSize.timer = null;

    }, ISQ.Html.ReSize.interval);
}
ISQ.Html.ReSize.wasInit = function ()
{
    if (typeof (this._wasInit) === 'undefined') return false;
    return this._wasInit;
};

ISQ.Html.ReSize.suspend = function ()
{
    if (!ISQ.Html.ReSize.wasInit()) return;
    ISQ.Html.ReSize._running = false;
}
ISQ.Html.ReSize.resume = function ()
{
    if (!ISQ.Html.ReSize.wasInit()) return;
    ISQ.Html.ReSize._running = true;
}
ISQ.Html.ReSize.dispose = function ()
{
    if (!ISQ.Html.ReSize.wasInit()) return;

    // reomving running flag
    ISQ.Html.ReSize._running = false;

    /////////// removing  listeners ////////////////
    if (window.removeEventListener)
    {
        window.removeEventListener('resize', ISQ.Html.ReSize.resizeHandler, true);
        if (ISQ.Http.browser.isMobile)
            window.removeEventListener('zoom', ISQ.Html.ReSize.resizeHandler, true);
    }
    else if (window.detachEvent)
        window.detachEvent('onresize', ISQ.Html.ReSize.resizeHandler);

    // disposing event
    ISQ.Html.ReSize.Event.dispose();
    ISQ.Html.ReSize.Event = null;
}

ISQ.Html.ReSize.interval = 100;
ISQ.Html.ReSize.diff = 199;

// removed code below cause when there's a float on a console page, it resets the static members
//ISQ.Html.ReSize.mWindowSize_browserEvent = null; // used to compare window size when browser fires event
//ISQ.Html.ReSize.mWindowSize_thisEvent = null; // saves the last window size according to this.Resize.Event
//ISQ.Html.ReSize.timer = null;
//ISQ.Html.ReSize.mListenTo = 0;
//ISQ.Html.ReSize.mSkipTimer = false;
//#endregion;
ISQ.Html = initializeNS("ISQ.Html");
///////////////////////////////////////////
/////////// [Window active] ///////////
///////////////////////////////////////////
//#region window active
ISQ.Html.WindowActive = initializeNS("ISQ.Html.WindowActive");
ISQ.Html.WindowActive.isInit = false;
ISQ.Html.WindowActive.hidden = null;
ISQ.Html.WindowActive.event = null;
ISQ.Html.WindowActive.init = function ()
{
    // fires an even when browser window becomes active / inactive
    if (ISQ.Html.WindowActive.isInit) return;
    ISQ.Html.WindowActive.isInit = true;
    ISQ.Html.WindowActive.event = new ISQ.Event();

    ISQ.Html.WindowActive.hidden = "hidden";

    // Standards:
    if (ISQ.Html.WindowActive.hidden in document)
        document.addEventListener("visibilitychange", ISQ.Html.WindowActive.onchange);
    else if ((ISQ.Html.WindowActive.hidden = "mozHidden") in document)
        document.addEventListener("mozvisibilitychange", ISQ.Html.WindowActive.onchange);
    else if ((ISQ.Html.WindowActive.hidden = "webkitHidden") in document)
        document.addEventListener("webkitvisibilitychange", ISQ.Html.WindowActive.onchange);
    else if ((ISQ.Html.WindowActive.hidden = "msHidden") in document)
        document.addEventListener("msvisibilitychange", ISQ.Html.WindowActive.onchange);

    // IE 9 and lower:
    else if ('onfocusin' in document)
        document.onfocusin = document.onfocusout = ISQ.Html.WindowActive.onchange;

    // All others:
    else
        window.onpageshow = window.onpagehide
            = window.onfocus = window.onblur = ISQ.Html.WindowActive.onchange;
}
ISQ.Html.WindowActive.onchange = function (evt)
{
    var active = true, inactive = false;
    var evtMap = {
        focus: active, focusin: active, pageshow: active,
        blur: inactive, focusout: inactive, pagehide: inactive
    };

    evt = evt || window.event;
    var isActive;
    if (evt.type in evtMap)
        isActive = evtMap[evt.type];
    else
        isActive = this[ISQ.Html.WindowActive.hidden] ? inactive : active;

    // dispatch event
    ISQ.Html.WindowActive.event.dispatch(isActive)
}
ISQ.Html.WindowActive.dispose = function ()
{
    if (!ISQ.Html.WindowActive.isInit) return;

    // Standards:
    if ("hidden" in document)
        document.removeEventListener("visibilitychange", ISQ.Html.WindowActive.onchange);
    else if ("mozHidden" in document)
        document.removeEventListener("mozvisibilitychange", ISQ.Html.WindowActive.onchange);
    else if ("webkitHidden" in document)
        document.removeEventListener("webkitvisibilitychange", ISQ.Html.WindowActive.onchange);
    else if ("msHidden" in document)
        document.removeEventListener("msvisibilitychange", ISQ.Html.WindowActive.onchange);

    // IE 9 and lower:
    else if ('onfocusin' in document)
        document.onfocusin = document.onfocusout = null;

    // All others:
    else
        window.onpageshow = window.onpagehide
            = window.onfocus = window.onblur = null;

    // disposing event
    ISQ.Html.WindowActive.event.dispose();
    ISQ.Html.WindowActive.event = null;
}

//#endregion;
ISQ.Html = initializeNS("ISQ.Html");
///////////////////////////////////////////
/////////// [element creation] ///////////
///////////////////////////////////////////
//#region element creation
ISQ.Html._doc = document;
ISQ.Html.createElement = function (type, parent, style)
{
    var elem = ISQ.Html._doc.createElement(type);
    var _parent = ISQ.Html._(parent);
    if (_parent !== null) _parent.appendChild(elem);
    if (typeof (style) === 'string') ISQ.CSS.setStyle(elem, style);

    return elem;
};
var createElement = ISQ.Html.createElement;
ISQ.Html.createDiv = function (parent, style)
{
    var elem = ISQ.Html._doc.createElement("div");
    var _parent = ISQ.Html._(parent);
    if (_parent !== null) _parent.appendChild(elem);
    if (typeof (style) === 'string') ISQ.CSS.setStyle(elem, style);
    return elem;
};
var createDiv = ISQ.Html.createDiv;
ISQ.Html.createTable = function (parent, width, dir, style, align)
{
    var table = createElement("table", parent); table.setAttribute("cellPadding", 0); table.setAttribute("cellSpacing", 0);
    table.setAttribute("border", 0);
    if (typeof (align) === 'string') table.setAttribute("align", align)
    if (typeof (width) === 'number' || typeof (width) === 'string') table.setAttribute("width", width);
    if (typeof (dir) === 'string')
    {
        table.setAttribute("dir", dir);
        table.style.direction = dir;
    }
    if (typeof (style) === 'string') ISQ.CSS.setStyle(table, style);

    return createElement("tbody", table);
};
var createTable = ISQ.Html.createTable;
ISQ.Html.createRow = function (tbody, style, valign)
{
    var tr = createElement("tr", tbody);
    if (typeof (style) === 'string') ISQ.CSS.setStyle(tr, style);
    if (typeof (valign) === 'string') tr.setAttribute('valign', valign);
    return tr;
};
var createRow = ISQ.Html.createRow;
ISQ.Html.addSpaceRow = function (tbody, height, colspan, style)
{
    var tr = createRow(tbody);
    var td = createElement("td", tr);
    td.style.height = height;
    if (typeof (style) === 'string') ISQ.CSS.setStyle(tr, style);

    if (colspan)
        td.setAttribute("colSpan", colspan);

    return tr;
};
var addSpaceRow = ISQ.Html.addSpaceRow;
ISQ.Html.addSpaceTd = function (tr, width, rowSpan)
{
    var td = createElement("td", tr);
    if (typeof (rowSpan) === 'number') td.setAttribute("rowSpan", rowSpan);

    if (!width) return;
    td.style.width = width;
    var div = createDiv(td, "width:" + width);
    div.innerHTML = "&nbsp;";
    return td;
};
var addSpaceTd = ISQ.Html.addSpaceTd;
ISQ.Html.createTd = function (tr, align, valign, style, colSpan)
{
    var td = createElement("td", tr);
    if (valign)
        td.setAttribute("vAlign", valign);
    if (align)
        td.setAttribute("align", align);
    if (typeof (style) === 'string') ISQ.CSS.setStyle(td, style);

    if (colSpan)
        td.setAttribute("colSpan", colSpan);

    return td;
};
var createTd = ISQ.Html.createTd;
ISQ.Html.clearNode = function (node, recursive)
{
    if (typeof (node) === 'undefined' || node === null) return null;
    if (node.nodeType !== 1) return node;
    recursive = recursive !== false; // true by default


    // in recursive mode, using the more efficient way
    if (recursive)
    {
        // cannot set innerHTML to some node elements.
        // making sure we don't
        var nodeName = node.nodeName;
        switch (nodeName)
        {
            case "TR":
            case "TBODY":
            case "TABLE":
                break;
            default:
                node.innerHTML = "";
                return node;
        }
    }

    // non recursive mode
    while (node.firstChild !== null)
    {
        if (recursive) ISQ.Html.clearNode(node.firstChild, true);
        node.removeChild(node.firstChild);
    }
    return node;
};
var clearNode = ISQ.Html.clearNode;
ISQ.Html.createInput = function (type, name, parent, value, errorStyle, okStyle, placeholder)
{
    if (typeof (arguments[0]) == 'object')
    {
        var obj = arguments[0];
        return createInput(obj.type, obj.name, obj.parent, obj.value || null, obj.errorStyle || null, obj.style || null, obj.placeholder || null);
    }

    var input;
    // creating an input for ie)
    name = name || '';
    var inputCreated = false;
    if (ISQ.Http.browser.app === 'ie' && !ISQ.Http.browser.isIE11)
    {
        try
        {
            var str = new Array();
            str.push("<input type='");
            str.push(type);
            str.push("' name='");
            str.push(name);
            str.push("' id='");
            str.push(name);
            str.push("' />");
            input = ISQ.Html._doc.createElement(str.join(''));
            if (parent) parent.appendChild(input);
            inputCreated = true;
        }
        catch (e)
        {
            inputCreated = false;
        }

    }

    // non ie browsers || ie9 which failed to create input
    if (!inputCreated)
    {
        input = createElement("input", parent);
        input.type = type;
        input.name = input.id = name;
    }

    // fixing bug #1613
    if (typeof (value) !== 'undefined' && value !== null) input.value = value;
    if (typeof (placeholder) !== 'undefined' && placeholder !== null) input.placeholder = placeholder;
    // setting styles
    if (typeof (errorStyle) === 'string')
    {
        input.errorStyle = errorStyle;
        input.error = function ()
        {
            ISQ.CSS.setStyle(this, this.errorStyle);
            input.hasError = true;
        }
    }

    input.okStyle = typeof (okStyle) === 'string' ? okStyle : "";
    ISQ.CSS.setStyle(input, input.okStyle);
    input.ok = function ()
    {
        ISQ.CSS.setStyle(this, this.okStyle);
        input.hasError = false;
    };

    //	
    return input;
};
var createInput = ISQ.Html.createInput;
ISQ.Html.createCheckbox = function (name, id, parent, text, _style, checked, onclick)
{
    if (typeof (arguments[0]) == 'object' && arguments[0] != null)
    {
        var obj = arguments[0];
        return createCheckbox(obj.name, obj.id, obj.parent, obj.text, obj.style, obj.checked, obj.onclick);
    }
    var table = createTable(parent);
    var id = id || name || 'cb_' + Math.floor(Math.random() * 1000000);
    if (_style) ISQ.CSS.setStyle(table.parentNode, _style);
    var tr = createRow(table);
    var td = createTd(tr);
    var cb = createInput('checkbox', id, td);
    cb.style.margin = '2px 3px 0';
    cb.id = id;
    cb.checked = cb.defaultChecked = checked === true;
    if (typeof (onclick) != 'undefined') cb.onclick = onclick;

    if (text)
    {
        td = createTd(tr);
        var lbl = createElement('label', td);
        lbl.setAttribute('for', cb.id);
        lbl.innerHTML = text;
        cb.label = lbl;
    }

    return cb;
};
var createCheckbox = ISQ.Html.createCheckbox;
ISQ.Html.createRadio = function (name, id, parent, text, value, _style, checked, _float, onclick, holderStyle)
{
    if (typeof (arguments[0]) == 'object')
    {
        var obj = arguments[0];
        return ISQ.Html.createRadio(obj.name, obj.id, obj.parent, obj.text, obj.value, obj.style, obj.checked, obj.floatStyle, obj.onclick, obj.holderStyle);
    }
    var table = createTable(parent);
    if (_float)
    {
        // _float is either left or right and allows for side by side radio buttons
        table.parentNode.setAttribute('align', _float);
        var dir = (_float.toLowerCase() === 'left' ? 'right' : 'left');
        ISQ.CSS.setStyle(table.parentNode, 'margin-' + dir + ': 5px');
    }
    var tr = createRow(table);
    var td = createTd(tr, '', '', holderStyle);
    var radio = createInput('radio', name, td, value, _style, _style);
    radio.style.margin = '0 3px 0';
    radio.id = id || 'radio_' + Math.floor(Math.random() * 1000000);
    if (typeof (checked) != 'undefined') radio.checked = checked;
    if (typeof (onclick) != 'undefined') radio.onclick = onclick;

    td = createTd(tr);
    var lbl = createElement('label', td);
    lbl.setAttribute('for', radio.id);
    lbl.innerHTML = text;

    return radio;
};
var createRadio = ISQ.Html.createRadio;
ISQ.Html.createSelect = function (obj)
{
    var sel = createElement("select", obj.parent, obj.style || '');

    // default value
    if (obj.defaultValue)
    {
        var opt = createElement("option", sel);
        opt.selected = true;
        if (typeof (obj.defaultValue) === 'object')
        {
            opt.value = obj.defaultValue.value;
            opt.innerHTML = ISQ.Data.unHTML(obj.defaultValue.html.toString());
        }
        else
        {
            opt.value = opt.innerHTML = obj.defaultValue;
        }

        if (obj.defaultValue.title) opt.title = obj.defaultValue.title;
    }

    for (var i = 0; i < obj.values.length; ++i)
    {
        var opt = createElement("option", sel);
        if (typeof (obj.values[i]) === 'object')
        {
            opt.innerHTML = ISQ.Data.unHTML(obj.values[i].html.toString());
            opt.value = obj.values[i].value;
        }
        else
        {
            opt.value = obj.values[i];
            opt.innerHTML = ISQ.Data.unHTML(obj.values[i].toString());
        }
        if (obj.selected && opt.value == obj.selected)
            opt.selected = true;

        if (obj.values[i].title) opt.title = obj.values[i].title;
    }
    return sel;
}
var createSelect = ISQ.Html.createSelect;
ISQ.Html.updateSelectOptions = function (obj)
{
    clearNode(obj.select);
    for (var i = 0; i < obj.values.length; ++i)
    {
        var opt = createElement("option", obj.select);
        if (typeof (obj.values[i]) === 'object')
        {
            opt.innerHTML = obj.values[i].html;
            opt.value = obj.values[i].value
        }
        else
        {
            opt.value = opt.innerHTML = obj.values[i];
        }
        if (obj.selected && opt.value == obj.selected)
            opt.selected = true;
    }
    return obj.select;
}
var updateSelectOptions = ISQ.Html.updateSelectOptions;
ISQ.Html.select_selectedOption = function (sel)
{
    return sel[sel.selectedIndex];
}
ISQ.Html.createForm = function (obj)
{
    var form = createElement("form", obj.parent);
    if (typeof (obj.action) === 'string') form.action = obj.action;
    if (typeof (obj.method) === 'string') form.method = obj.method;
    if (typeof (obj.id) === 'string') form.id = from.name = obj.id;
    if (typeof (obj.name) === 'string')
    {
        from.name = obj.name;
        if (typeof (obj.id) !== 'string') form.id = from.name;
    }

    var handler = typeof (obj.onsubmit) !== 'undefined' && obj.onsubmit !== null ? obj.onsubmit : null;
    if (handler !== null) handler.executed = false;
    form.onsubmit = function (event4ff)
    {
        if (handler !== null)
        {
            if (!handler.executed)
            {
                handler.handle(ISQ.Html.getDomEvent(event4ff));
                handler.executed = true;
            }
            else
            {
                handler.executed = false;
            }
        }
        return false;
    }

    function keyHandler(event4ff)
    {
        var event = ISQ.Html.getDomEvent(event4ff);
        if (event.domEvent.keyCode !== 13) return false;
        if (handler !== null)
        {
            if (!handler.executed)
            {
                handler.handle(event);
                handler.executed = true;
            }
            else
            {
                handler.executed = false;
            }
        }
        event.cancel();
        return false;
    }

    if (ISQ.Html._doc.addEventListener)
    {
        if (ISQ.Http.browser.app !== 'chrome' && ISQ.Http.browser.app !== 'opera')
            form.addEventListener('keypress', keyHandler, true);
        else
            form.addEventListener('keyup', keyHandler, true);
    }
    else if (ISQ.Html._doc.attachEvent)
    {
        form.attachEvent('onkeyup', keyHandler);
    }
    return form;
}
var createForm = ISQ.Html.createForm;
ISQ.Html.createIframe = function (id, name, _style, src)
{
    src = src || "about:blank";
    var ifr = createElement('iframe');
    ifr.setAttribute("name", name);
    ifr.setAttribute("id", id);
    ifr.setAttribute("src", src);
    if (_style) ISQ.CSS.setStyle(ifr, _style);

    return ifr;
}
ISQ.Html.createImage = function (obj)
{
    if (!obj.src) throw ("createImage: invalid src");
    var img = new Image();
    img.src = obj.src;
    if (obj.onload) img.onload = obj.onload;
    if (obj.id) img.id = obj.id;
    if (obj.align) img.setAttribute('align', obj.align);
    if (obj.style) ISQ.CSS.setStyle(img, obj.style);
    if (obj.parent) obj.parent.appendChild(img);
    if (obj.altText) img.setAttribute('title', obj.altText);
    if (obj.overSrc) ISQ.Html.setImageMouseOverAndOut(img, obj.overSrc);
    return img;
}
var createImage = ISQ.Html.createImage;
ISQ.Html.createLink = function (ctorObject)
{
    var a = createElement("a", ctorObject.parent, ctorObject.style);
    if (ctorObject.text) a.innerHTML = ctorObject.text;
    if (typeof (ctorObject.href) === 'string')
        a.href = ctorObject.href;
    else
        a.href = 'javascript:void(0)';

    if (typeof (ctorObject.title) === 'string') a.title = ctorObject.title;
    if (typeof (ctorObject.target) === 'string') a.target = ctorObject.target;
    if (typeof (ctorObject.id) === 'string') a.id = ctorObject.id;

    // setting onclick
    ISQ.Html.setOnclick(a, ctorObject.onclick);
    return a;
}
var createLink = ISQ.Html.createLink;
window.setOnclick = ISQ.Html.setOnclick = function (link, onclickFunc)
{
    if (link.nodeName !== "A")
    {
        if (onclickFunc) link.onclick = onclickFunc;
        return;
    }

    link.onclick = function (event4ff)
    {
        // saving link's href (for unload event purposes)
        // (for console sessions only)
        if (typeof (ISQ.Console) !== 'undefined' && typeof (ISQ.Console.SessionManager) !== 'undefined')
        {
            ISQ.Console.SessionManager.lastClickedLinkHref = this.href ? this.href : null;
            // delete lastClickedLinkHref so that in ISQ.Console.SessionManager.unloadHandler()
            // a correct href will be caught.
            setTimeout(function ()
            {
                delete ISQ.Console.SessionManager.lastClickedLinkHref;
            }, 10);
        }

        // firing given 'onclick' function
        // as 'this' (<A>) as 'this' of given function
        if (typeof (onclickFunc) !== 'undefined')
        {
            onclickFunc.apply(this, new Array(event4ff));
        }
    }
}
ISQ.Html.createHR = function (tbody, height, bgColor, colspan)
{
    var tr = createRow(tbody);
    var td = createElement("td", tr);
    td.style.height = height;
    td.style.background = bgColor;
    if (typeof (colspan) === 'number') td.setAttribute("colSpan", colspan);
    return tr;
}
var createHR = ISQ.Html.createHR;
ISQ.Html.createTextNode = function (text, parent)
{
    var elem = ISQ.Html._doc.createTextNode(text);
    var _parent = ISQ.Html._(parent);
    if (_parent !== null) _parent.appendChild(elem);
    return elem;
}
var createTextNode = ISQ.Html.createTextNode;
//#endregion;
ISQ.Html = initializeNS("ISQ.Html");
ISQ.Html.moveChildNodesToElement = function (parentElement, newParentElement)
{
    clearNode(newParentElement);
    var childNodes = parentElement.childNodes;
    while (childNodes.length > 0)
        newParentElement.appendChild(childNodes[0]);
}
var moveChildNodesToElement = ISQ.Html.moveChildNodesToElement;
// recursion on dom elements
ISQ.Html.domRecursion = function (domElem, func)
{
    if (!domElem) return;
    func(domElem);

    for (var i = 0; i < domElem.childNodes.length; ++i)
        domRecursion(domElem.childNodes[i], func);
}
window.domRecursion = ISQ.Html.domRecursion;
// image mouse over and mouseout
ISQ.Html.setImageMouseOverAndOut = function (imgObj, srcOver)
{
    var srcOut = imgObj.src;

    imgObj.onmouseover = function () { this.src = srcOver; }
    imgObj.onmouseout = function () { this.src = srcOut; }
}
var setImageMouseOverAndOut = ISQ.Html.setImageMouseOverAndOut;

ISQ.Html.elementToString = function (elem, newInnerHTML)
{
    var s = new Array();
    s.push("<");
    s.push(elem.nodeName);
    s.push(" ");
    for (var i = 0; i < elem.attributes.length; ++i)
    {
        var attrib = elem.attributes[i];
        var attribValue = attrib.value || attrib.nodeValue;
        if (!attribValue) continue;
        var quot = null;
        if (typeof (attribValue) === 'string')
            quot = attribValue.indexOf('\'') > -1 ? '"' : '\'';

        s.push(attrib.nodeName);
        s.push("=");
        if (quot) s.push(quot);
        s.push(attribValue);
        if (quot) s.push(quot);
        s.push(" ");
    }
    s.push(">");
    if (newInnerHTML)
        s.push(newInnerHTML);
    else
        s.push(elem.innerHTML);
    s.push("</");
    s.push(elem.nodeName);
    s.push(">");
    return s.join('');
}
var elementToString = ISQ.Html.elementToString;

ISQ.Html.getElementsByClassName = function (node, _className)
{
    if (typeof (document.getElementsByClassName) === 'function')
        return node.getElementsByClassName(_className);
    else
        return node.querySelectorAll('.' + _className);
};
ISQ.Html = initializeNS("ISQ.Html");
 // add placeholder to textbox/textarea
ISQ.Html.setPlaceHolder = function (input, text, cssClass, parentNode)
{
    var parentElement = input.parentNode || parentNode;
    if (!parentElement) return;

    var textLabel = createDiv(parentElement);
    textLabel.className = cssClass;
    textLabel.innerHTML = text;
    textLabel.onclick = function ()
    {
        input.focus();
    };
    var fieldkeyup = function ()
    {
        if (input.value == '')
            textLabel.style.display = 'block';
        else
            textLabel.style.display = 'none';
    };
    var fieldonblur = function ()
    {
        if (input.value == '')
            textLabel.style.display = 'block';
    };
    window.addEvents(input, 'onkeyup', fieldkeyup);
    window.addEvents(input, 'onblur', fieldonblur);
    // for clearing the placeholder if values populated in javascript
    input.autoCheck = fieldkeyup;
}
;
ISQ.Html = initializeNS("ISQ.Html");

///////////////////////////////////////////
///////////// [iframes] ///////////
///////////////////////////////////////////
//#region iframes
ISQ.Html.createInvisibleIframe = function (handler)
{
    var ifr = createElement("iframe", document.body, "visible:hidden;position:absolute;top:0px;left:0px;width:1px;height:1px");
    ifr.setAttribute("frameBorder", 0);
    setTimeout(function ()
    {
        if (handler.isDisposed())
        {
            if (ifr.parentNode)
            {
                document.body.removeChild(ifr);   
            }
            return;
        }
        ISQ.Html.waitUntilAvailable(ifr, handler);
    }, 0);
    return ifr;
}
createInvisibleIframe = ISQ.Html.createInvisibleIframe;
ISQ.Html.waitUntilAvailable = function (ifr, handler)
{
    // get window and document objects for iframe (IE compatible)
    var idoc = null;
    var iwin = null;
    try
    {
        idoc = ifr.contentDocument || ifr.contentWindow.document || null;
        iwin = ifr.contentWindow || ifr.contentDocument.defaultView || null;
    }
    catch (ex)
    { }

    if (!idoc || !iwin || (!idoc.body && !iwin.document.body))
    {
        setTimeout(function ()
        {
            if (handler.isDisposed())
            {
                document.body.removeChild(ifr);
                return;
            }
            ISQ.Html.waitUntilAvailable(ifr, handler);
        }, 10);
        return;
    }

    if (idoc.body)
        ISQ.Html.iframeReady(idoc, handler)
    else
        ISQ.Html.iframeReady(iwin.document, handler);
}
ISQ.Html.iframeReady = function (ifrDoc, handler)
{
    // adding creating html and body elements
    ifrDoc.open();
    ifrDoc.writeln("<html><body></body></html>");
    ifrDoc.close();

    // firing handler
    handler.handle(ifrDoc);
    handler.dispose();
}
//#endregion;
ISQ.Html = initializeNS("ISQ.Html");
///////////////////////////////////////////
///////////// [doctype] ///////////
///////////////////////////////////////////
//#region doctype
ISQ.Html.detectDoctype = function ()
{
    //////////////////////////////////////////////////////////////////////////
    // detecting docType
    var doctype = "loose";
    try
    {
        var doctypeNode = null;

        if (window.document.doctype)
        {
            doctypeNode = window.document.doctype.systemId;
            if (!doctypeNode) doctypeNode = window.document.doctype.publicId;

            // maybe html5
            if (!doctypeNode && window.document.doctype["name"].toLowerCase() === 'html')
                doctypeNode = "doctype html";
        }
        else //if (!ISQ.Http.browser.isIE9 && !ISQ.Http.browser.isIE10)
        {
            doctypeNode = window.document.firstChild;
            // a commented doctype node
            if (doctypeNode.innerHTML.length !== 0)
                doctypeNode = null;
            // a valid doctype
            else
                doctypeNode = doctypeNode.nodeValue;
        }

        if (doctypeNode === null)
        {
            doctype = "nodoctype";
        }
        else
        {
            doctypeNode = doctypeNode.toLowerCase();
            if (doctypeNode === "doctype html" || doctypeNode === "ctype ht") // ie6,7,8
                doctype = "html5";
            else if (doctypeNode.indexOf("xhtml") !== -1 || doctypeNode.indexOf('rdfa 1.1') !== -1) // ie
                doctype = "xhtml";
            else if (doctypeNode.indexOf("strict") !== -1)
                doctype = "strict";
            else if (doctypeNode.indexOf("loose") !== -1)
                doctype = "loose";
            else if (doctypeNode.indexOf("transitional") !== -1)
            {
                if (doctypeNode.indexOf("4.01") !== -1)
                    doctype = "transitional401";
                else if (doctypeNode.indexOf("4.0") !== -1)
                    doctype = "transitional4";
                else
                    doctype = "transitional";
            }
            else if (doctypeNode.indexOf("frameset") !== -1)
                doctype = "frameset";
            else // no doctype, quirks, 4.0 transitional quirks
                doctype = "nodoctype";
        }
    }
    catch (e)
    {
        doctype = "nodoctype";
    }
    return doctype;
};
//#endregion;</script>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
ISQ.Http = initializeNS('ISQ.Http');
ISQ.Http.MAX_URL_SIZE = 2047;  // 2048 (max in IE) minus 1.

// can be removed
ISQ.Http.getNoHashUrl = function()
{
	var hash = window.location.hash;
	var _src = window.location.href;
	if (hash !== '')
	{
		var ndx;
		do
		{
			ndx = _src.indexOf(hash);
			if (ndx !== -1) _src = _src.substring(0, ndx);	
		}
		while(ndx !== -1);
	}
	return _src;
}

///////////////////////////////////////////
/////////// [BROWSER DETECTION] ///////////
///////////////////////////////////////////
// ISQ.Http.browser = null;
ISQ.Http.detectBroswer = function ()
{
    var appVersion = navigator.appVersion;
    var userAgent = navigator.userAgent;
    var _index = 0;

    ISQ.Http.browser = {};

    //////////////////////////////////////////////////////////////////////////
    // MOBILE 
    // android
    if (appVersion.indexOf("Android") !== -1 || userAgent.indexOf("Android") !== -1)
    {
        ISQ.Http.browser.app = "android";
        var ndx = appVersion.indexOf("Android ") + 8;
        var version = appVersion.substring(ndx, appVersion.indexOf(";", ndx));
        ISQ.Http.browser.version = version;
        ISQ.Http.browser.isMobile = appVersion.indexOf('Mobile') > -1 || userAgent.indexOf("Mobile") !== -1;
        ISQ.Http.browser.isTablet = !ISQ.Http.browser.isMobile;
        ISQ.Http.browser.usesViewport = true;
        ISQ.Http.browser.isAndroid = true;

        // marking old android
        if (parseInt(ISQ.Http.browser.version) < 4) ISQ.Http.browser.oldAndroid = true;
    }
    // iphone
    else if (navigator.appVersion.indexOf("iPhone") !== -1)
    {
        var version = navigator.appVersion.substring(0, navigator.appVersion.indexOf(" "));
        ISQ.Http.browser.app = "safari";
        ISQ.Http.browser.version = "iphone " + parseInt(version);
        ISQ.Http.browser.isMobile = true;
        ISQ.Http.browser.usesViewport = true;
        ISQ.Http.browser.isIPhone = true;

        if (appVersion.indexOf("OS 6_") !== -1)
            ISQ.Http.browser.isIOS6 = true;
        else if (appVersion.indexOf("OS 7_") !== -1)
            ISQ.Http.browser.isIOS7 = true;

        ISQ.Http.browser.isIOS = true

       // ISQ.Http.browser.isIOS = ISQ.Http.browser.isIOS6 || ISQ.Http.browser.isIOS7;
    }
    // ipad
    else if (navigator.appVersion.indexOf("iPad") !== -1)
    {
        var version = navigator.appVersion.substring(0, navigator.appVersion.indexOf(" "));
        ISQ.Http.browser.app = "safari";
        ISQ.Http.browser.version = "ipad " + parseInt(version);
        ISQ.Http.browser.isTablet = true;
        ISQ.Http.browser.usesViewport = true;
        ISQ.Http.browser.isIPad = true;

        if (appVersion.indexOf("OS 6_") !== -1)
            ISQ.Http.browser.isIOS6 = true;
        else if (appVersion.indexOf("OS 7_") !== -1)
            ISQ.Http.browser.isIOS7 = true;

        ISQ.Http.browser.isIOS = ISQ.Http.browser.isIOS6 || ISQ.Http.browser.isIOS7;
    }

    //////////////////////////////////////////////////////////////////////////
    // BROWSER

    // ie
    if ((_index = appVersion.indexOf("MSIE ")) !== -1)
    {
        ISQ.Http.browser.app = "ie";

        _index += 5;
        var spndx = appVersion.indexOf(" ", _index);
        if (spndx === -1)
            ISQ.Http.browser.version = appVersion.substring(_index);
        else
            ISQ.Http.browser.version = appVersion.substring(_index, spndx);

        if (ISQ.Http.browser.version.startsWith("10"))
            ISQ.Http.browser.isIE10 = true;
        if (ISQ.Http.browser.version.startsWith("9"))
            ISQ.Http.browser.isIE9 = true;
        if (ISQ.Http.browser.version.startsWith("8"))
            ISQ.Http.browser.isIE8 = true;
        if (ISQ.Http.browser.version.startsWith("7"))
            ISQ.Http.browser.isIE7 = true;
        if (ISQ.Http.browser.version.startsWith("6"))
            ISQ.Http.browser.isIE6 = true;
        ISQ.Http.browser.isIE = true;
    }
    // chrome
    else if (appVersion.indexOf("Chrome") !== -1)
    {
        ISQ.Http.browser.app = "chrome";
        ISQ.Http.browser.version = "0";
    }
    // safari
    else if ((_index = appVersion.indexOf("Safari")) !== -1 && ISQ.Http.browser.app != 'android')
    {
        var version = appVersion.substring(_index + 7);
        ISQ.Http.browser.app = "safari";

        if (version <= '530.17')
            ISQ.Http.browser.version = "3";
        else
            ISQ.Http.browser.version = "4";
    }
    // firefox
    else if ((_index = userAgent.indexOf("Firefox/")) !== -1)
    {
        ISQ.Http.browser.app = "ff";
        var spndx = userAgent.indexOf(" ", _index);
        if (spndx === -1)
            ISQ.Http.browser.version = userAgent.substring(_index + 8);
        else
            ISQ.Http.browser.version = userAgent.substring(_index + 8, spndx);

        if (ISQ.Http.browser.version.startsWith("3"))
            ISQ.Http.browser.isFF3 = true;
        if (ISQ.Http.browser.version.startsWith("3.0"))
            ISQ.Http.browser.isFF3_0 = true;
        if (ISQ.Http.browser.version.startsWith("3.6"))
            ISQ.Http.browser.isFF3_6 = true;
    }
    // opera
    else if (userAgent.indexOf("Opera/") !== -1)
    {
        ISQ.Http.browser.app = "opera";

        var ndx = userAgent.indexOf("Version/");
        // before opera 10.10
        if (ndx === -1)
        {
            var sndx = userAgent.indexOf(" ", 6);
            ISQ.Http.browser.version = userAgent.substring(6, sndx);
        }
        else
        {
            var sndx = userAgent.indexOf(" ", ndx);
            if (sndx === -1)
                ISQ.Http.browser.version = userAgent.substring(ndx + 8);
            else
                ISQ.Http.browser.version = userAgent.substring(ndx + 8, sndx);
        }

        ISQ.Http.browser.isOpera = true;
    }
    // a symbian browser => safari
    else if (userAgent.indexOf("Symbian")!=-1)
    {
        ISQ.Http.browser.app = "symbian";
        ISQ.Http.browser.version = 1;
        ISQ.Http.browser.full = ISQ.Http.browser.app + ISQ.Http.browser.version;
    }

    // defaults browser wasn't detected
    if (!ISQ.Http.browser.app)
    {
        if (userAgent.indexOf("AppleWebKit") !== -1)
        {
            ISQ.Http.browser.app = "safari";
            ISQ.Http.browser.version = "5";
        }
        // ie11+
        else if (appVersion.indexOf("Trident/7") !== -1)
        {
            ISQ.Http.browser.app = "ie";
            ISQ.Http.browser.isIE = true;

            var ndx = appVersion.indexOf("rv:");
            if (ndx !== -1)
            {
                ndx += 3;
                if (appVersion.equals("11", ndx))
                {
                    ISQ.Http.browser.version = "11";
                    ISQ.Http.browser.isIE11 = true;
                }
            }
        }
        else
        {
            ISQ.Http.browser.app = "default";
            ISQ.Http.browser.version = "--";
        }
    }

    // saving full browser
    ISQ.Http.browser.full = ISQ.Http.browser.app + ISQ.Http.browser.version;

    userAgent = null;
    appVersion = null;
}
if (typeof(ISQ.Http.browser) === 'undefined' || !ISQ.Http.browser) ISQ.Http.detectBroswer();

ISQ.Http.isIEQuirksMode = function ()
{
    return (ISQ.Http.browser.isIE && document.compatMode !== 'CSS1Compat');
}

ISQ.Http.isChrome = function ()
{
    var appVersion = navigator.appVersion;
    if (appVersion.indexOf("Chrome") !== -1)
    {
        return true;
    }
    return false;
}


///////////////////////////////////////////
/////////// [Cookies] ///////////
///////////////////////////////////////////
ISQ.Http.Cookies = initializeNS("ISQ.Http.Cookies");
ISQ.Http.Cookies._read = function (key)
{
    if (!key) return null;
    var str = document.cookie;
    var keyNdx = 0;
    var cookieCharAt;
    var keyCharAt;
    var ndx = 0;
    var enumStates = { KEY: 1, VALUE: 2 };
    var state = enumStates.KEY;
    while (ndx < str.length)
    {
        cookieCharAt = str.charAt(ndx++);
        if (cookieCharAt === ' ') continue; // skipping spaces

        if (state === enumStates.KEY) // COOKIE KEY
        {
            if (cookieCharAt === '=')
            {
                state = enumStates.VALUE;
                keyNdx = 0; // didn't find the key
                continue;
            }
            keyCharAt = key.charAt(keyNdx);

            // found the correct character
            if (cookieCharAt === keyCharAt || cookieCharAt.toLowerCase() === keyCharAt.toLowerCase())
            {
                if (++keyNdx === key.length) // found the key, checking if it's a cookie name
                {
                    if (str.charAt(ndx) === '=') // found key!
                    {
                        var endPos = str.indexOf(";", ++ndx);
                        if (endPos === -1) endPos = str.length;
                        return str.substring(ndx, endPos);
                    }
                    else
                    {
                        keyNdx = 0; // didn't find the key
                    }
                }
            }
            else
                keyNdx = 0; // didn't find the key
        }
        else // COOKIE VALUE: SKIPPING UNTIL END ';'
        {
            if (cookieCharAt === ';') state = enumStates.KEY;
        }

    }
    return null;
};
ISQ.Http.Cookies._readCaseSensitive = function (key)
{
    if (!key) return null;
    var str = document.cookie;
    var ndx = str.indexOf(key);
    while (ndx !== -1)
    {
        // found as cookie name
        ndx += key.length;
        if (str.charAt(ndx) === '=')
        {
            var endPos = str.indexOf(";", ++ndx);
            if (endPos === -1) endPos = str.length;
            return str.substring(ndx, endPos);
        }
        else // didn't find it the string as a cookie name
        {
            ndx = str.indexOf(key);
        }
    }
    return null;
};
ISQ.Http.Cookies._write = function (name, value, path, domain, secure, expiresInSec, noEscape)
{
    name = name || null;
    value = !isNaN(value) ? value : value || null;
    path = path || "/";
    domain = domain || null;
    secure = secure === true;
    expiresInSec = expiresInSec || null; // session cookie

    if (name === null || value === null) return;

    var expirationDate = new Date();
    if (expiresInSec !== null)
    {
        expirationDate.setSeconds(expirationDate.getSeconds() + expiresInSec);
        expirationDate = expirationDate.toGMTString();
    }

    // Build the set-cookie string:
    var cookieString = [];
    if (name.indexOf("%20") !== -1 || name.toLowerCase().indexOf("%3a") !== -1)
        cookieString.push(name);
    else
        cookieString.push(escape(name));
    cookieString.push("=");
    if (value.toString().indexOf("%20") !== -1 || value.toString().toLowerCase().indexOf("%3a") !== -1 || noEscape)
        cookieString.push(value);
    else
        cookieString.push(escape(value));

    // adding a path
    cookieString.push("; path=");
    cookieString.push(path);

    if (domain !== null)
    {
        cookieString.push("; domain=");
        cookieString.push(domain);
    }

    if (secure)
    {
        cookieString.push("; secure=");
        cookieString.push(secure);
    }

    // adding expiry date (if no session cookie)
    if (expiresInSec !== null)
    {
        cookieString.push("; expires=");
        cookieString.push(expirationDate);
    }

    // Create/update the cookie:
    document.cookie = cookieString.join("");
};
ISQ.Http.Cookies._delete = function (name, path, domain, secure)
{
    name = name || null;
    path = path || null;
    domain = domain || null;
    secure = secure || null;
    
    if (name === null)
        return;

    var value = ISQ.Http.Cookies._read(name);
    if (value === null) return;
    
    var expirationDate = new Date();
    expirationDate.setMonth(expirationDate.getMonth() - 1);
    expirationDate = expirationDate.toGMTString();

    // Build the set-cookie string:
    var cookieString = [];
    cookieString.push(escape(name));
    cookieString.push("=1");

    // adding expiry date
    cookieString.push("; expires=");
    cookieString.push(expirationDate);

    // adding a path
    path = path || "/";
    cookieString.push("; path=");
    cookieString.push(path);

    // domain
    domain = domain || ISQ.Http.domain(false);
    cookieString.push("; domain=");
    cookieString.push(domain);

    if (secure !== null)
    {
        cookieString.push("; secure=");
        cookieString.push(secure);
    }

    // Create/update the cookie:
    document.cookie = cookieString.join("");
};
ISQ.Http.Cookies.encode64 = function (txt)
{
    txt += ""; // making as string
    if (txt.length === 0) return txt;
    var en = ISQ.Tools.Base64.encodeString(txt);
    return en.replace(/\=/g, "_").replace(/\+/g, "|");
};
ISQ.Http.Cookies.decode64 = function(txt)
{
    txt += ""; // making as string
    if (txt.length === 0) return txt;

    var de = txt.replace(/\_/g, "=").replace(/\|/g, "+");
    return ISQ.Tools.Base64.decodeString(de);
};

///////////////////////////////////////////
/////////// [Domain] ///////////
///////////////////////////////////////////
ISQ.Http.domain = function (includePort, url)
{
    includePort = includePort === true;
    var domain;
    var domainAndPort;
    if (typeof (ISQ.Http.mDomain) === 'undefined' || !ISQ.Http.mDomain || url)
    {
        url = url || window.location.href;
        var protocolIndex = url.indexOf('//') + 2;
        domain = url.substring(protocolIndex);

        var slashIndex = domain.indexOf("/");
        if (slashIndex > -1)
            domainAndPort = domain.substring(0, slashIndex);
        else
            domainAndPort = domain;

        var colIndex = domain.indexOf(":");
        if (colIndex > -1)
            domain = domainAndPort.substring(0, colIndex);
        else
            domain = domainAndPort;
    }

    if (!url)
    {
        ISQ.Http.mIncludePort = domainAndPort;
        ISQ.Http.mDomain = domain;
    }

    if (includePort)
        return domainAndPort;
    else
        return domain;
};
// returns the relative path and file name + arguments.
// E.g: www.nanorep.com/test/index.html?account=qa will return:  {path: "/test", filename: "index.html?account=qa"}
ISQ.Http.relativePath = function(url)
{
	url = url || window.location.href;
	var result = {path: "", filename: ""};
	var index = url.indexOf('//')+2;
	index = url.indexOf('/', index);
	if (index == url.length-1) return result;
	var qmIndex =  url.indexOf('?');
	var lastIndex = url.LastIndexOf_char('/', qmIndex === -1 ? 0 : qmIndex);

	// setting path and filename
	result.path = url.substring(index, lastIndex++);
	result.filename = url.substring(lastIndex);

	// removing hash
	index = result.filename.indexOf("#");
	if (index !== -1) result.filename = result.filename.substring(0, index);

	return result;
};

///////////////////////////////////////////
/////////// [Url & Hash Arguments] ///////
///////////////////////////////////////////
if (typeof (ISQ.Http.urlArguments) === 'undefined' || !ISQ.Http.urlArguments)
{
    // NOTE: key is converted to lower case!!!
    if (window.location.search.length !== 0)
        ISQ.Http.urlArguments = ISQ.Tools.stringToPairArray(window.location.search.substring(1), '=', '&', true, false);
    else    
        ISQ.Http.urlArguments = [];
}
if (typeof (ISQ.Http.hashArguments) === 'undefined' || !ISQ.Http.hashArguments)
{
	// NOTE: key is converted to lower case!!!
	if (window.location.hash.length !== 0)
		ISQ.Http.hashArguments = ISQ.Tools.stringToPairArray(window.location.hash.substring(1), '=', '&', true, false);
	else
		ISQ.Http.hashArguments = [];
}

//////////////////////////////////////////////////////////////////////////
// gets the value of the url parameter with the given name. use win to optionally read from a window other than the current one
ISQ.Http.getUrlParam = function (name, win)
{
    name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
    var regexS = "[\\?&]" + name + "=([^&#]*)";
    var regex = new RegExp(regexS);
    win = win || window;
    var results = regex.exec(win.location.href);
    if (results == null)
        return "";
    else
        return results[1];
};
ISQ.Http.getUrlFakePart = function ()
{
    var ndx = window.location.href.indexOf("/~");
    if (ndx === -1) return '';
    ndx += 2;

    // '/~ as an argument
    if (window.location.search && ndx > window.location.href.indexOf("?"))
        return '';
    // '/~ as a hash
    if (window.location.hash && ndx > window.location.href.indexOf("#"))
        return '';

    var endNDx = window.location.href.indexOf("/", ndx);
    if (endNDx === -1) return '';
    return window.location.href.substring(ndx, endNDx);
}
/**
 * [isValidUrl description]
 * @return {Boolean} [description]
 */
ISQ.Http.isValidUrl = function (url)
{
    return (/^((?:https?\:\/\/|www\.)(?:[-a-z0-9]+\.)*[-a-z0-9]+.*)$/gi).test(url);
}
</script>
    <script type="text/javascript">ISQ.Com = initializeNS("ISQ.Com");
ISQ.Com.JsonP = {};
//////////////////////////////////////////////////////////////////////////
//#region jsonP request
ISQ.Com.JsonP.Request = ISQ.Base.extend(
{
    name: "ISQ.Com.JsonP.Request",
    cbId: new Date().getTime() % 1000,
    enumResponseType: { OK: 200, ERROR: 400, TIMEOUT: 500 },
    _prototype:
    {
        ctor: function (obj) { },

        //#region interface
        send: function (obj)
        {
            var elem;
            var functionName = "_jspcb" + (ISQ.Com.JsonP.Request.cbId++);
            window[functionName] = function (jsonResponse)
            {
                // clearing timeout
                clearTimeout(timer);
                // firing handler
                obj.handler(ISQ.Com.JsonP.Request.enumResponseType.OK, jsonResponse, obj);
                // deleting reference
                try
                {
                    delete window[functionName];
                }
                catch(e)
                {
                    window[functionName] = undefined;
                }
                // removing element from DOM
                var pn = elem.parentNode;
                if (pn) pn.removeChild(elem);
            }

            // building params
            var sb = [];
            sb.push(obj.url);
            sb.push("?cb=");
            sb.push(functionName);
            if (obj.params) for (var parm in obj.params)
            {
                if (obj.params[parm] == null) continue; // skipping null params
                sb.push('&');
                sb.push(parm);
                sb.push('=');
                sb.push(obj.params[parm]);
            }

            // sending request
            elem = document.createElement("script");
            elem.type = 'text/javascript';
            elem.async = true;
            elem.defer = true;
            elem.src = sb.join('');
            elem.onload = function()
            {
            	clearTimeout(timer); // script was loaded
            }
            elem.onreadystatechange = function()
            {
            	if (this.readyState !== 'complete' && this.readyState !== 'loaded') return;
            	clearTimeout(timer); // script was loaded
            }
            document.getElementsByTagName("head")[0].appendChild(elem);

            // setting timeout
            var timeout = function ()
            {
                // removing elem from dom
                var pn = elem.parentNode;
                if (pn) pn.removeChild(elem);
                // firing handler
                obj.handler(ISQ.Com.JsonP.Request.enumResponseType.TIMEOUT, null, obj);
            }
            var timer = setTimeout(timeout, obj.timeout || 10000);
        }
        //#endregion
    }
});
//#endregion

//////////////////////////////////////////////////////////////////////////
//#region jsonP client
ISQ.Com.JsonP.Client = ISQ.Base.extend(
{
    name: "ISQ.Com.JsonP.Client",
    enumState: { DISCONNECTED: 0, CONNECTING: 1, CONNECTED: 2, FAILED: 3 },
    SESSION_ID_KEY: "sid",
	REQUEST_ID: 0,
    _prototype:
    {
        ctor: function (obj)
        {
            this.mState = ISQ.Com.JsonP.Client.enumState.DISCONNECTED;
            this.mAccount = obj.account;
            this.mHost = obj.host || "";
            this.mUrlPrefix = this.mHost + '/~' + obj.account.toLowerCase() + obj.urlPrefix;
            this.mRequest = new ISQ.Com.JsonP.Request();
            this.mLoginParams = obj.loginParams || null;
            this.mDefaultTimeout = obj.defaultTimeout || 10000;
            this.fStateChanged = obj.fStateChanged;

            //////////////////////////////////////////////////////////////////////////
            // referer
            if (!this.mLoginParams.url)
            {
                var ndx = window.location.href.indexOf("#");
                if (ndx == -1)
                    this.mLoginParams.url = escape(window.location.href);
                else
                    this.mLoginParams.url = escape(window.location.href.substring(0, ndx));
            }
        },

        setHost: function(newHost)
        {
            if (newHost === this.mHost) return;
            this.mUrlPrefix = this.mUrlPrefix.replace(this.mHost + "/~", newHost + "/~");
            this.mHost = newHost;
        },

        //#region interface
        retry: function (obj)
        {
			// changing state to indicate we're disconnected from server
			if (this.mState !== ISQ.Com.JsonP.Client.enumState.CONNECTING && (this.mState !== ISQ.Com.JsonP.Client.enumState.CONNECTED || obj.params.sid === this.mSessionId))
				this.changeState(ISQ.Com.JsonP.Client.enumState.DISCONNECTED);
            this.request(obj); // performing login and resending data
        },
        request: function (obj)
        {
            // obj = {url, params, handler, timeout}

            // fixing url
            if (!obj.url.startsWith(this.mUrlPrefix)) obj.url = this.mUrlPrefix + obj.url;
            obj.timeout = obj.timeout || this.mDefaultTimeout;
			//obj.requestId = ++this.REQUEST_ID;

            // sending request
            if (this.mState != ISQ.Com.JsonP.Client.enumState.CONNECTED)
            {
                if (!this.mQueue) this.mQueue = new ISQ.Infra.Queue();
                this.mQueue.enqueue(obj);

                // sending hello
                if (this.mState != ISQ.Com.JsonP.Client.enumState.CONNECTING) this.hello();
            }
            else
            {
                // sending request
                this.request_internal(obj);
            }

			//return obj.requestId;
        },
        keepAlive: function (oneTime)
        {
            var mthis = this;
            this.request(
            {
                url: "keepAlive.js",
                params: null,
                handler: function (status, json)
                {
                    clearTimeout(mthis.mKeepAliveTimer);

                    if (mthis.mState != ISQ.Com.JsonP.Client.enumState.CONNECTED) return; // not connected...
                    if (oneTime) return;

                    if (status == ISQ.Com.JsonP.Request.enumResponseType.OK)
                        mthis.mKeepAliveTimer = setTimeout(function () { mthis.keepAlive(); }, mthis.mKeepAliveInterval);
                    else
                        mthis.mKeepAliveTimer = setTimeout(function () { mthis.keepAlive(); }, mthis.mKeepAliveInterval * 2);
                }
            });
        },
        stopKeepAlive: function ()
        {
            clearTimeout(this.mKeepAliveTimer);
        },
        persistentSession: function (json)
        {
            json.widgetSessionId = this.id();
            json.now = new Date().getTime();
            json.logoutTimeout = this.mLogoutInterval - (2 * this.mKeepAliveInterval);
            json.account = this.mAccount;

            var value = ISQ.Data.jsonToString(json);
            ISQ.Http.Cookies._write(ISQ.Com.JsonP.Client.SESSION_ID_KEY, value, '/widget', ISQ.Http.domain()); // session cookie
        },
        deleteSession: function ()
        {
            ISQ.Http.Cookies._delete(ISQ.Com.JsonP.Client.SESSION_ID_KEY, '/widget', ISQ.Http.domain());
        },
        loadSessionFromId: function (sessionId)
        {
            // session is good, performing login request
            this.mSessionId = sessionId;
            this.keepAlive(true);
        },
        loadSession: function ()
        {
            var obj = { result: false };

            // if connected, cannot restore session
            if (this.mState !== ISQ.Com.JsonP.Client.enumState.DISCONNECTED) return obj;

            //////////////////////////////////////////////////////////////////////////
            // getting data from storage or cookie
            var data = ISQ.Tools.Storage.get(ISQ.Com.JsonP.Client.SESSION_ID_KEY, true);
            if (!data)
            {
                data = ISQ.Http.Cookies._read(ISQ.Com.JsonP.Client.SESSION_ID_KEY);
                if (data) data = unescape(data);
            }
            if (!data) return obj;
            if (data.length < 3) return obj;

            var json = null;
            try { json = eval("(" + data + ")"); } catch (e) { }
            if (!json) return obj;

            // verifying account
            if (json.account != this.mAccount) return obj;

            // removing cookie
            this.deleteSession();

            // verifying session is not expired
            if (!json.now) return obj;
            var now = new Date().getTime();
            this.mLogoutInterval = parseInt(json.logoutTimeout);
            if (now - json.now > this.mLogoutInterval) return obj;

            this.loadSessionFromId(json.widgetSessionId);

            json.result = true; // setting as result true
            return json;
        },
        die: function ()
        {
            if (this.mState != ISQ.Com.JsonP.Client.enumState.CONNECTED) return;
            this.changeState(ISQ.Com.JsonP.Client.enumState.DISCONNECTED);
            this.request_internal(
	        {
	            url: this.mUrlPrefix + "die.js",
	            params: null,
	            handler: function () { }
	        });
        },
        setContext: function (contexts, ctxCallback, forceRequest)
        {
            // lower case contexts
            for (var key in contexts)
            {
                var keyLC = key.toLowerCase();
                contexts[keyLC] = contexts[key].Trim();
                if (keyLC !== key) delete contexts[key]; // removing non-LC contexts
            }
            this.mContexts = contexts;

            //
            var str = [];
            for (var key in contexts)
            {
                if (str.length != 0) str.push(',');
                str.push(key);
                str.push(':');
                str.push(contexts[key].replace(/,/g, " "));
            }

            // updating login params
            this.mLoginParams.ctx = str.join('');

            // updating context
            if (forceRequest || this.mState === ISQ.Com.JsonP.Client.enumState.CONNECTED || this.mState === ISQ.Com.JsonP.Client.enumState.CONNECTING)
            {
                this.request(
                {
                    url: "set.js",
                    params: { ctx: this.mLoginParams.ctx },
                    handler: function (status, jsonObject, jsonRequest)
                    {
                        if (status != ISQ.Com.JsonP.Request.enumResponseType.OK)
                        {
                            _session().retry(jsonRequest);
                            return;
                        }

                        if (ctxCallback)
                            ctxCallback();
                    }
                });
            }
        },
        setValues: function (values)
        {
            var str = [];
            for (var key in values)
            {
                if (str.length != 0) str.push(',');
                str.push(key);
                str.push(':');
                str.push(values[key]);
            }

            // updating login params
            this.mLoginParams.values = ISQ.Http.Cookies.encode64(str.join(''));

            // updating context
            if (this.mState === ISQ.Com.JsonP.Client.enumState.CONNECTED || this.mState === ISQ.Com.JsonP.Client.enumState.CONNECTING)
            {
                this.request(
                {
                    url: "set.js",
                    params: { values: this.mLoginParams.values },
                    handler: function () { }
                });
            }
        },
        getUploadParams: function (data, handler)
        {
            this.request(
            {
                url: "getUploadParams.js",
                params: { data: data },
                handler: function (status, jsonObject)
                {
                    handler.handle(jsonObject);
                }
            });
        },
        deleteFile: function (data)
        {
            this.request(
            {
                url: "deleteTempFile.js",
                params: { data: data },
                handler: function (status, jsonObject) { }
            });
        },
        //#endregion

        //#region props
        state: function ()
        {
            return this.mState;
        },
        id: function ()
        {
            return this.mSessionId;
        },
        contexts: function ()
        {
            return this.mContexts;
        },
        hasContext: function ()
        {
            if (this.mContexts) for (var i in this.mContexts) { return true; }
            return false;
        },
        //#endregion

        //#region internals
        hello: function ()
        {
            if (this.mState != ISQ.Com.JsonP.Client.enumState.DISCONNECTED) return;
            this.mState = ISQ.Com.JsonP.Client.enumState.CONNECTING;
            var mthis = this;
            this.request_internal(
            {
                url: this.mUrlPrefix + "hello.js",
                params: this.mLoginParams,
                handler: function (status, json)
                {
                    clearTimeout(mthis.mLoginTimer);

                    if (status == ISQ.Com.JsonP.Request.enumResponseType.OK)
                    {
                        // saving session id
                        mthis.mSessionId = json.sessionId;

                        // setting disconnection timer
                        mthis.mLogoutInterval = json.timeout * 1000;
                        clearTimeout(mthis.mDisconnectedTimer);
                        mthis.mDisconnectedTimer = setTimeout(function ()
                        {
                            mthis.changeState(ISQ.Com.JsonP.Client.enumState.DISCONNECTED);
                        }, mthis.mLogoutInterval);

                        // processing queue
                        if (mthis.mQueue)
                        {
                            while (mthis.mQueue.count() != 0)
                                mthis.request_internal(mthis.mQueue.dequeue());
                        }

                        // state changed (after queue in order to allow object in queue to be sent first)
                        mthis.changeState(ISQ.Com.JsonP.Client.enumState.CONNECTED);
                    }
                    else
                    {
                        console.log("Could not connect to server");

                        // setting disconnection timer
                        mthis.mLoginTimer = setTimeout(function ()
                        {
                            mthis.changeState(ISQ.Com.JsonP.Client.enumState.DISCONNECTED);
                        }, mthis.mLoginTimerInterval);

                        if (mthis.mLoginTimerInterval < 30000)
                            mthis.mLoginTimerInterval += 1000; // adding 1 second
                    }
                }
            });
        },
        request_internal: function (obj)
        {
            if (!obj.params) obj.params = {};
            obj.params.sid = this.mSessionId;
            this.mRequest.send(obj);
        },
        changeState: function (newState)
        {
            var prevState = this.mState;
            this.mState = newState;

            if (this.fStateChanged) this.fStateChanged(prevState, newState);
        },
        //#endregion

        //#region members
        mContexts: null,
        mUrlPrefix: "",
        mHost: null,
        mState: null,
        mRequest: null,
        mDefaultTimeout: null,
        mLoginParams: null,
        mQueue: null,
        mSessionId: 0,
        mDisconnectedTimer: null,
        mLoginTimer: null,
        mLoginTimerInterval: 2000, // 2 seconds
        fStateChanged: null,
        mKeepAliveInterval: 3000,
        mKeepAliveTimer: null,
        mLogoutInterval: null,
        mAccount: null
        //#endregion
    }
});
//#endregion


</script>
    <script type="text/javascript">ISQ.Com = initializeNS("ISQ.Com");
ISQ.Com.TinyAjax =
{
    enumMethod: { GET: 'GET', POST: 'POST' }
    , enumStatus: { OK: 200, FAIL: 400, TIMEOUT: 500 }
    , create: function (info)
    {
        // info: {url, method, headers, timeout, data, handler}

        // creating object
        var xmlhttp = null;
        if (typeof (XMLHttpRequest) === 'function' || typeof (XMLHttpRequest) === 'object')
            xmlhttp = new XMLHttpRequest();
        else
            throw "Cannot create ajax object";

        // openning request
        if (info.method == this.enumMethod.GET && info.data) info.url += "?" + info.data;
        xmlhttp.open(info.method, info.url, true);

        // headers
        if (info.headers) for (var n in info.headers) xmlhttp.setRequestHeader(n, info.headers[n]);

        // registering success
        xmlhttp.onreadystatechange = function ()
        {
            switch (this.readyState)
            {
                case 4:
                    ready(ISQ.Com.TinyAjax.enumStatus.OK);
                    break;
            }
        };
        xmlhttp.onerror = function ()
        {
            ready(ISQ.Com.TinyAjax.enumStatus.FAIL);
        }
        xmlhttp.onload = function ()
        {
            ready(ISQ.Com.TinyAjax.enumStatus.OK);
        };

        //////////////////////////////////////////////////////////////////////////
        var ready = function (status)
        {
            if (!running) return;
            clearTimeout(timer);
            running = false;

            // status
            var tmpStatus = -1;
            try
            {
                var tmpStatus = xmlhttp.status;
                if (!tmpStatus) tmpStatus = 400;
            }
            catch (e)
            {
                if (timeout) tmpStatus = -1;
                else tmpStatus = 400;
            }

            var text = "";
            switch (tmpStatus)
            {
                case 200:
                    status = ISQ.Com.TinyAjax.enumStatus.OK;
                    text = xmlhttp.responseText || "";
                    break;
                case 400:
                case 403:
                case 404:
                    status = ISQ.Com.TinyAjax.enumStatus.FAIL;
                    break;
                default:
                    if (timeout) status = ISQ.Com.TinyAjax.enumStatus.TIMEOUT;
                    else status = ISQ.Com.TinyAjax.enumStatus.FAIL;
                    break;
            }

            // firing handler
            info.handler(status, text);
        };
        var timer = setTimeout(function ()
        {
            if (!running) return; // already handled
            timeout = true;
            xmlhttp.abort();

            /// when 'aborting' a request in OPERA browser,
            /// sometimes it closes the request with an empty 200 response && sometimes it doesn't close the request (didn't find the logical explanation).
            /// if the request was closed with an empty 200 (and the response was handled), not calling directly to 'handleResponse()'
            if (running) ready(ISQ.Com.TinyAjax.enumStatus.TIMEOUT);

        }, (info.timeout || 10000));

        var running = true;
        var timeout = false;

        // sending the request
        if (info.method === this.enumMethod.POST)
            xmlhttp.send(info.data);
        else
            xmlhttp.send(null); // firefox 3.0 requires 'null'
    }
};
</script>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////
///////////////////////////////////////////
ISQ.CSS = initializeNS("ISQ.CSS");

//used in charts
ISQ.CSS.getVerticalMargin = function (element)
{
    var w = 0;

    tp = ISQ.CSS.getElementStyle(element, 'margin-top');
    tp = parseInt(tp);
    if (!isNaN(tp)) w += tp;

    bt = ISQ.CSS.getElementStyle(element, 'margin-bottom');
    bt = parseInt(bt);
    if (!isNaN(bt)) w += bt;

    return w;
}
// used in charts
ISQ.CSS.getHorizonalMargin = function (element)
{
    var w = 0;

    left = ISQ.CSS.getElementStyle(element, 'margin-left');
    left = parseInt(left);
    if (!isNaN(left)) w += left;

    right = ISQ.CSS.getElementStyle(element, 'margin-right');
    right = parseInt(right);
    if (!isNaN(right)) w += right;

    return w;
}

ISQ.CSS.setStyle = function (node, style, clear)
{
    node = ISQ.Html._(node);
    if (node === null) return;

    if (typeof (style) !== 'string') return;
    if (typeof (clear) === 'undefined') clear = true;

    if (clear)
    {
        node.className = '';
        node.style.cssText = '';
    }

    var splittedStyle = style.split("&");
    for (var i = 0; i < splittedStyle.length; ++i)
    {
        // class
        if (splittedStyle[i].charAt(0) === '.')
            node.className += " " + splittedStyle[i].substring(1);
        // style attributes
        else
            node.style.cssText += ";" + splittedStyle[i];
    }
}

ISQ.CSS.setOpacity = function (node, percent)
{
    node = ISQ.Html._(node);
    if (node === null) return;

    if (typeof (percent) !== 'number' || (percent < 0 || percent > 100)) return;

    if (ISQ.Http.browser.isIE6 || ISQ.Http.browser.isIE7)
    {
        if (percent === 100)
        {
            node.style.removeAttribute("filter");
            if (node.nodeName === "TR")
            {
                for (var i = 0; i < node.childNodes.length; ++i)
                    ISQ.CSS.setOpacity(node.childNodes[i], percent);
                //node.childNodes[i].style.removeAttribute("filter");
            }
        }
        else
        {
            node.style.filter = "alpha(opacity=" + percent + ")";
            if (node.nodeName === "TR")
            {
                for (var i = 0; i < node.childNodes.length; ++i)
                    ISQ.CSS.setOpacity(node.childNodes[i], percent);
                //node.childNodes[i].style.filter = 'inherit';
            }
        }
    }
    else if (ISQ.Http.browser.isIE8 || ISQ.Http.browser.isIE9)
    {
        if (percent === 100)
        {
            node.style.removeAttribute("filter");
            if (node.nodeName === "TR")
            {
                for (var i = 0; i < node.childNodes.length; ++i)
                    node.childNodes[i].style.removeAttribute("filter");
            }
        }
        else
        {
            node.style.filter = "progid:DXImageTransform.Microsoft.Alpha(Opacity=" + percent + ")";
            if (node.nodeName === "TR")
            {
                for (var i = 0; i < node.childNodes.length; ++i)
                    node.childNodes[i].style.filter = 'inherit';
            }
        }
    }
    else
    {
        if (percent === 100)
        {
            node.style.removeProperty("opacity");
            if (ISQ.Http.browser.app === 'opera' && node.nodeName === "TR")
            {
                for (var i = 0; i < node.childNodes.length; ++i)
                    node.childNodes[i].style.removeProperty("opacity");
            }
        }
        else
        {
            node.style.opacity = (percent / 100);
            if (ISQ.Http.browser.app === 'opera' && node.nodeName === "TR")
            {
                for (var i = 0; i < node.childNodes.length; ++i)
                    node.childNodes[i].style.opacity = 'inherit';
            }
        }
    }
}




// enables/disables the css file with the given href
ISQ.CSS.toggleCss = function (cssIdentifier, enable)
{
    var found = false;
    var rules = 'cssRules';
    if (ISQ.Http.browser.app === "ie" && !ISQ.Http.browser.isIE11) rules = 'rules';
    var l = document.styleSheets.length;
    for (var i = l - 1; i >= 0; --i)
    {
        var styleSheet = document.styleSheets[i];
        // rtl css is NOT an external sheet. thus, can skip these stylesheets
        // if stylesheet doesn't have selectors, skipping it
        try
        {

            if (styleSheet.href || styleSheet[rules].length == 0) continue;
            var selector = styleSheet[rules][0].selectorText;
            // first selector might be an @import of external font
            if (!selector && styleSheet[rules].length > 1)
                selector = styleSheet[rules][1].selectorText;

            if (!selector) continue;
            if (selector.toLowerCase() !== cssIdentifier.toLowerCase()) continue;
            styleSheet.disabled = !enable;
            found = true;
        }
        catch (e) { }
    }

    return found;
}

// moves the css to the bottom of the head so it overrides css's above it
ISQ.CSS.bringToFront = function (cssIdentifier)
{
    var found = false;
    var rules = 'cssRules';
    if (ISQ.Http.browser.app === "ie" && !ISQ.Http.browser.isIE11) rules = 'rules';
    var l = document.styleSheets.length;
    for (var i = l - 1; i >= 0; --i)
    {
        var styleSheet = document.styleSheets[i];
        // rtl css is NOT an external sheet. thus, can skip these stylesheets
        // if stylesheet doesn't have selectors, skipping it
        try
        {

            if (styleSheet.href || styleSheet[rules].length == 0) continue;

            var selector = styleSheet[rules][0].selectorText;

            // first selector might be an @import of external font
            if (!selector && styleSheet[rules].length > 1)
                selector = styleSheet[rules][1].selectorText;

            if (!selector) continue;

            if (selector.toLowerCase() !== cssIdentifier.toLowerCase()) continue;

            if (styleSheet.ownerNode)
                styleElement = styleSheet.ownerNode;
            else
                styleElement = styleSheet.owningElement;

            var head = styleElement.parentNode;
            if (head)
                head.appendChild(styleElement);
            found = true;
        }
        catch (e)
        {
            // console.log('problem');
        }
    }

    return found;
}

ISQ.CSS.getElementWidth = function (elm, includeMargin)
{
    var w = elm.offsetWidth;
    w -= ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'padding-left'), 0);
    w -= ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'padding-right'), 0);
    if (includeMargin) w -= ISQ.CSS.getHorizonalMargin(elm);
    return w;
}
ISQ.CSS.getElementHeight = function (elm, includeMargin, ignoreIfHidden)
{
    var w = elm.offsetHeight;
    if (w === 0)
    {
        if (ignoreIfHidden) return 0;
        w = ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'height'), 0);
    }

    w -= ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'padding-top'), 0);
    w -= ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'padding-bottom'), 0);

    if (includeMargin) w -= ISQ.CSS.getVerticalMargin(elm);
    return w;
}
ISQ.CSS.getPaddingWidth = function (elm)
{
    var width = ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'padding-left'), 0);
    width += ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'padding-right'), 0);
    return width;
}
ISQ.CSS.setWidthIncludingPadding = function (elm, width)
{
    width -= ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'padding-left'), 0);
    width -= ISQ.Tools.getNumber(ISQ.CSS.getElementStyle(elm, 'padding-right'), 0);
    elm.style.width = width + "px";
}

// adds a css class to an element
ISQ.CSS.addClass = function (elem, className)
{
    // prevent adding the same class twice
    if (elem.className)
    {
        var tokens = elem.className.split(' ');
        for (var i in tokens)
        {
            if (tokens[i] == className) return;
        }
    }

    // add class
    elem.className += ' ' + className;
}

// removes a class from an element
ISQ.CSS.removeClass = function (elem, className)
{
    if (!elem.className) return;
    var classes = new Array();
    var tokens = elem.className.split(' ');
    for (var i in tokens)
    {
        if (tokens[i] && tokens[i] != className) classes.push(tokens[i]);
    }

    // set classes
    elem.className = classes.join(' ');
}
ISQ.CSS.addNewStyleToHead = function (styleContent, id)
{
    var styleNode = document.createElement('style');
    styleNode.type = "text/css";
    if (id) styleNode.id = id;

    document.getElementsByTagName('head')[0].appendChild(styleNode);

    if (ISQ.Http.browser.app === "ie" && !ISQ.Http.browser.isIE11 && styleNode.styleSheet)
    {
        styleNode.styleSheet.cssText = styleContent;
    }
    else
    {
        var styleTextNode = document.createTextNode(styleContent);
        styleNode.appendChild(styleTextNode);
    }
    return styleNode;
}

ISQ.CSS.addNewStyle = function (styleContent, id, splitInHeader)
{
    // going to split the css include file to several elements in the <head>
    if (splitInHeader)
    {
        if (typeof ISQ.CSS.dynamicLoadedCssUniqueId == "undefined")
            ISQ.CSS.dynamicLoadedCssUniqueId = 0;

        var incStart = "splitInHeaderStart{direction:rtl}\r\n";
        var incEnd = "splitInHeaderEnd{direction:rtl}\r\n";

        var splittingCmd = function ()
        {
            while (i != -1)
            {
                ISQ.CSS.dynamicLoadedCssUniqueId++;
                var iEnd = styleContent.indexOf(incEnd);
                var newIncludeContent = styleContent.substring(i + incStart.length, iEnd - i);

                var sb = [];
                sb.push(styleContent.substring(0, i));
                sb.push(styleContent.substring(iEnd + incEnd.length));
                styleContent = sb.join('');
                ISQ.CSS.addNewStyleToHead(newIncludeContent, id + ISQ.CSS.dynamicLoadedCssUniqueId);
                i = styleContent.indexOf(incStart);
            }
            if (styleContent.length > 0)
                ISQ.CSS.addNewStyleToHead(styleContent, id + ISQ.CSS.dynamicLoadedCssUniqueId);
        }

        var i = -1;
        i = styleContent.indexOf(incStart);

        if (i != -1)
            splittingCmd();
        else
        {
            incStart = "splitInHeaderStart{direction:rtl}";
            incEnd = "splitInHeaderEnd{direction:rtl}";
            i = styleContent.indexOf(incStart);
            splittingCmd();
        }
    }
    else
    {
        return ISQ.CSS.addNewStyleToHead(styleContent, id);
    }

};

ISQ.CSS = initializeNS("ISQ.CSS");
// styleProp eg.: font-size
ISQ.CSS.getElementStyle = function (el, styleProp)
{
    el = ISQ.Html._(el);
    var value = null;
    if (window.getComputedStyle) // real browsers
    {
        value = document.defaultView.getComputedStyle(el, null).getPropertyValue(styleProp);
    }
    if (!value && el.runtimeStyle) // IE
    {
        // convert font-size -> fontSize
        if (styleProp.indexOf('-') !== -1)
        {
            var arr = [];
            for (var idx = 0; idx < styleProp.length; idx++)
            {
                if (styleProp.charAt(idx) === '-')
                {
                    arr.push(styleProp.charAt(++idx).toUpperCase());
                }
                else
                {
                    arr.push(styleProp.charAt(idx));
                }
            }
            styleProp = arr.join('');
        }

        // getting value from defaultView (IE10+)
        if (typeof (document.defaultView) !== 'undefined')
        {
            try { value = document.defaultView.getComputedStyle(el, null)[styleProp]; }
            catch (e) { value = null; }
        }
        // getting value from runtime Style
        if (!value)
        {
            try { value = el.runtimeStyle[styleProp]; }
            catch (e) { value = null; }
        }
        // getting value from currentStyle
        if (!value)
        {
            if ((ISQ.Http.browser.isIE7 || ISQ.Http.browser.isIE6) && styleProp.contains('border')) value = null; // accessing currentStyle['border*'] causes uncatchable exception in IE6,7
            else if (el.currentStyle) value = el.currentStyle[styleProp];
        }
    }

    return value;
};</script>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////
/////////////////////////////////////////// Extends ISQ.CSS
ISQ.CSS = initializeNS("ISQ.CSS");
ISQ.CSS.setNodeStyleText = function (node, styleText)
{
    node.setAttribute('style', styleText);
    node.style.cssText = styleText;
};
ISQ.CSS.removeStyle = function (id)
{
    // removes stylesheets with a specific id
    if (!id) return;

    var _head = document.getElementsByTagName('head')[0];
    for (var i = 0; i < _head.childNodes.length; i++)
    {
        var childNode = _head.childNodes[i];
        if (childNode.id == id)
        {
            _head.removeChild(childNode);
            --i;
        }
    }

}
ISQ.CSS.generateCSSstring = function (styleText, styleName)
{
    if (styleText === null || styleName === null)
        return '';

    var html = [];
    html.push(styleName);
    html.push("{" + styleText + "}");

    var str = html.join('');
    return str;
};
ISQ.CSS.getAttributeValueFromStyleString = function (style, attribute)
{
    var value = 0;
    var startPos = style.indexOf(attribute);
    if (startPos > -1)
    {
        startPos = style.indexOf(":", startPos);
        var endPos = style.indexOf(";", startPos);
        if (endPos > -1)
            value = style.substring(startPos + 1, endPos);
        else
            value = style.substring(startPos + 1);
    }

    return value;
};
ISQ.CSS.getBackgroundImage = function (style)
{
    var value = '';
    var cssValue = ISQ.CSS.getAttributeValueFromStyleString(style, "background-image");
    if (cssValue === 0)
        cssValue = ISQ.CSS.getAttributeValueFromStyleString(style, "background");

    var startIndex = cssValue.indexOf("url(");
    if (startIndex > -1)
    {
        startIndex += 4;
        var endIndex = cssValue.indexOf(")", startIndex);
        endIndex -= 1;
        value = cssValue.substring(startIndex, endIndex);

        value = value.replace("\"", "");
    }

    return value;
};
ISQ.CSS.getSelectorStyle = function (selector1, selector2)
{
    if (typeof (selector1) !== 'string') return;
    selector1 = selector1.toLowerCase();

    if (typeof (selector2) !== 'string')
        selector2 = null;
    else
        selector2 = selector2.toLowerCase();

    // rules
    var rules = 'cssRules';
    if (ISQ.Http.browser.app === "ie" && !ISQ.Http.browser.isIE11) rules = 'rules';

    try
    {
        // number of <style> tags
        var l = document.styleSheets.length;
        var styles = new Array();

        // looping from end to beginning
        for (var i = l - 1; i >= 0; --i)
        {
            var styleSheet = document.styleSheets[i];
            try
            {
                // stylesheet is disabled: no need to check here...
                if (styleSheet.disabled) continue;

                // looping stylesheet selectors (#log{}, #myDiv{})
                var n = styleSheet[rules].length;
                for (var j = n - 1; j >= 0; --j)
                {
                    // splitting selectors. E.g.: #log, #myDiv{}
                    var selectorText = styleSheet[rules][j].selectorText;
                    if (!selectorText) continue;
                    var selectors = selectorText.toLowerCase().split(",");
                    var m = selectors.length;

                    for (h = m - 1; h >= 0; --h)
                    {
                        // searching for exact match. E.g. "#myDiv" || ".myClass"
                        var cssSlector = selectors[h].Trim();
                        // if found a match (to one of the selectors)
                        // returning its style
                        if (selector1 === cssSlector || (selector2 !== null && selector2 === cssSlector))
                        {
                            var val;
                            for (var attribute in styleSheet[rules][j].style)
                            {
                                if (styles[attribute]) continue;
                                val = styleSheet[rules][j].style[attribute];
                                if (!val) continue;
                                styles[attribute] = val;
                            }
                        }
                    }
                }
            }
            // in some rare cases FIREFOX adds parent's page css file and causes security exception
            catch (ex)
			{ }
        }

        return styles;
    }
    catch (ex)
	{ }

    return null;
}
// returns selectors' attribute
ISQ.CSS.getValueBySelectors = function (attribute, selector1, selector2)
{
    if (typeof (attribute) !== 'string') return;
    if (typeof (selector1) !== 'string') return;
    if (typeof (selector2) !== 'string') selector2 = null;


    var cssStyle = ISQ.CSS.getSelectorStyle(selector1, selector2);
    if (cssStyle === null) return null;

    value = cssStyle[attribute];

    if (typeof (value) !== 'string') return null;
    var trimmed = value.Trim();
    if (trimmed === '') return null;
    return trimmed;
}

ISQ.CSS.changeValueBySelector = function (selector, attribute, newValue)
{
    if (typeof (attribute) !== 'string') return;
    if (typeof (selector) !== 'string') return;
    if (typeof (newValue) !== 'string') return;

    var cssStyle = ISQ.CSS.getSelectorStyle(selector);
    if (!cssStyle) return null;

    // setting new value
    cssStyle[attribute] = newValue;
}
ISQ.CSS.getValue = function (element, attribute)
{
    // getting element's style
    var _element = ISQ.Html._(element);
    if (_element === null) return null;
    var _id = "#" + _element.id;
    var _class = "." + _element.className;
    var nodeName = _element.nodeName.toLowerCase();

    // attribute
    attribute = attribute.toLowerCase();

    // value
    var value = null;

    // getting style attribute value
    value = _element.style[attribute];
    if (value) return value.Trim();


    var res = ISQ.CSS.getValueBySelectors(attribute, _class, _id);
    if (res === null) return ISQ.CSS.getValueBySelectors(attribute, nodeName + _class, nodeName + _id)
}</script>
    <script type="text/javascript">///////////////////////////////////////////
///////////////////////////////////////////
ISQ.CDC = initializeNS("ISQ.CDC");

// including helper functions
///////////////////////////////////////////
///////////////////////////////////////////
if (typeof (nanoRep) === 'undefined') window.nanoRep = {};
if (typeof (nanoRep.CDC) === 'undefined') nanoRep.CDC = {};

nanoRep.CDC.Helper =
{
    splitURLArguments: function (message)
    {
        var result = new Array();
        var str = message;
        var l = str.length;
        if (l === 0) return result;

        var getStringValue = function (array)
        {
            return unescape(array.join('').toString()).replace(/^\s+|\s+$/g, "");
        }

        var state = 1;
        var lastKey = '';
        var ndx = 0;
        var collected = new Array();
        while (ndx < l)
        {
            switch (state) // 1 = key, 2 = value
            {
                case 1:
                    if (str.charAt(ndx) !== '=')
                    {
                        collected.push(str.charAt(ndx));
                    }
                    else
                    {
                        state = 2;
                        lastKey = getStringValue(collected).toLowerCase();
                        collected = new Array();
                    }
                    break;
                case 2:
                    if (str.charAt(ndx) !== '&')
                    {
                        collected.push(str.charAt(ndx));
                    }
                    else
                    {
                        state = 1;
                        result[lastKey] = getStringValue(collected);
                        collected = new Array();
                    }
                    break;
            }
            ++ndx;
        }
        // saving last value (if wasn't saved)
        if (state === 2) result[lastKey] = getStringValue(collected);

        return result;
    },

    getTargetWindow: function (_name, fromProxy)
    {
        if (!_name) return window.top;

        var windowContext = window;
        if (fromProxy) windowContext = window.parent;

        // returning parent
        if (_name === 'parent')
            return windowContext.parent;

        var topWindowChecked = false;
        var targetWindow;
        do
        {
            try
            {
                if (windowContext === window.top) topWindowChecked = true;
                targetWindow = windowContext.frames[_name];

                // found 
                if (targetWindow) return targetWindow;
            }
            catch (e)
            { }

            windowContext = windowContext.parent;

        } while (!topWindowChecked);
        // didn't found - returning top
        return window.top;
    },
    parseMessage: function (message)
    {
        if (!message) return "";

        var params = nanoRep.CDC.Helper.splitURLArguments(message);
        params.s = unescape(params.s); // source
        params.t = unescape(params.t); // target
        return params;
    }
} ;

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
/*
 The CDC has 2 working modes:
  - In chrome/ff3+/ie8+/opera 11/safari5+: using window.postMessage() to sent the messages.
  - In ie6,7: using an iframe and changing its "#" to sent the messages.

  This implementation fixes these bugs (appears in cdc version 1,2):
  - In chrome/ff/ie8... : when changing iframe's # add entries to browser's history.
  - When sending multiple messages - only the last one arrives.
  - Cannot send the same message data twice. (for e.g. 'minimize')
*/

ISQ.CDC.User = ISQ.Base.extend({ name: "ISQ.CDC.User" });
ISQ.CDC.User.prototype.ctor = function (obj)
// obj {proxyIFrameUrl (iframe url in case of legacy mode) , targetWindowName (the target window which messages will be sent to), allowMessagesFrom (a domain which is the source of recieved messages) , server (server domain which the iframe downloads the relay code)}
{
    this.mTargetWindowName = obj.targetWindowName || '';
    this.mProxyIFrameUrl = obj.proxyIFrameUrl || null;
    this.mAllowMessagesFrom = obj.allowMessagesFrom || null;
    this.incomingMessageEvent = new ISQ.Event();
    //this.mSingleRelay = obj.singleRelay === true;
    this.mWidget = obj.widget || null;
    this.eFilterMessages = new ISQ.Event();

    if (typeof (ISQ.CDC.users) === 'undefined')
        ISQ.CDC.users = new Array();
    ISQ.CDC.users.push(this);

    // legacy mode: using #
    //if (true || (typeof (window.postMessage) != 'function' && typeof (window.postMessage) != 'object'))
    if (typeof (window.postMessage) != 'function' && typeof (window.postMessage) != 'object')
    {
        this.mLegacyMode = true;
        this.mHost_l = window.location.protocol + '//' + window.location.host;
        if (this.mProxyIFrameUrl)
        {
            if (this.mProxyIFrameUrl.contains("?"))
                this.mProxyIFrameUrl += "&srv=" + obj.server;
            else
                this.mProxyIFrameUrl += "?srv=" + obj.server;
        }
    }
    // non-legacy mode: using window.postMessage
    else
    {
        var mthis = this;
        this.mPostMessageEventListener = function (messageEvent)
        {
            // security
            if (messageEvent.origin !== mthis.mAllowMessagesFrom) return;
            var message = ISQ.CDC.Helper.splitURLArguments(messageEvent.data);
            message["s"] = unescape(messageEvent.origin);
            message["t"] = "*";
            mthis.dispatchMessage(message);
        };
        if (window.addEventListener)
            window.addEventListener("message", this.mPostMessageEventListener, false);
        else if (window.attachEvent)
            window.attachEvent("onmessage", this.mPostMessageEventListener);
    }
};
ISQ.CDC.User.prototype.dtor = function ()
{
    // removing created iframe from 
    if (this.mProxyIFrame_l && this.mProxyIFrame_l.parentNode !== null) document.body.removeChild(this.mProxyIFrame_l);

    if (!this.mLegacyMode)
    {
        if (window.removeEventListener)
            window.removeEventListener("message", this.mPostMessageEventListener, false);
        else if (window.detachEvent)
            window.detachEvent("onmessage", this.mPostMessageEventListener);
    }
};
ISQ.CDC.User.prototype.sendMessage = function (data, targetHost)
{
    // target host
    targetHost = targetHost || "*";

    // new implementation: using window.postMessage
    if (!this.mLegacyMode)
    {
        var targetWindow = ISQ.CDC.Helper.getTargetWindow(this.mTargetWindowName);
        data += "&ord=" + (++this.mMessageOrdinal);
        targetWindow.postMessage(data, targetHost);
    }
    // old implementation: using #
    else
    {
        // Explanation:
        // Each message creates an iframe (message in the url) and removes it after load

        if (!this.mMessagesOnSent) this.mMessagesOnSent = new Array();

        // creating base url
        if (!this.mProxyIFrameBaseUrl_l)
        {
            var baseUrl = new Array();
            baseUrl.push(this.mProxyIFrameUrl);
            baseUrl.push("#");
            baseUrl.push("s="); // source
            baseUrl.push(escape(this.mHost_l));
            baseUrl.push("&t="); // target
            baseUrl.push(escape(targetHost));
            baseUrl.push("&twnd="); // target window name
            baseUrl.push(this.mTargetWindowName);
            this.mProxyIFrameBaseUrl_l = baseUrl.join('');
        }

        var msgObj = function (cdcInstance, ordinal, data, targetHost)
        {
            var url = new Array();
            url.push(cdcInstance.mProxyIFrameBaseUrl_l);
            url.push("&");
            url.push(data);
            url.push("&ord=");
            url.push(ordinal);

            // creating the iframe
            var styleValue = "position: absolute; left: 0px; top:-1100px;height:70px;width:70px;";
            var iframe = document.createElement("iframe");
            var iframeId = ISQ.CDC.User.getIframeId();
            iframe.setAttribute('id', iframeId);
            iframe.setAttribute('name', iframeId);
            iframe.setAttribute('src', url.join(''));
            iframe.setAttribute('frameBorder', '1'); // IE needs this otherwise resize event is not fired
            iframe.setAttribute('scrolling', 'auto');
            iframe.setAttribute('width', "70px"); // Need a certain size otherwise IE7 does not fire resize event
            iframe.setAttribute('height', "70px");
            iframe.setAttribute('style', styleValue);
            if (iframe.style.setAttribute) iframe.style.setAttribute('cssText', styleValue); // IE needs this because setting style attribute is broken. No really.
            document.body.appendChild(iframe);

            // registering iframe onload event and removing iframe
            var onloadHandler = function ()
            {
                setTimeout(function ()
                {
                    //if (iframe.parentNode)
                    //iframe.parentNode.removeChild(iframe);

                    cdcInstance.mMessagesOnSent[ordinal] = null; // GC
                }, 100);
            };

            if (ISQ.Http.browser.app === 'opera')
                iframe.onload = onloadHandler;
            else if (document.addEventListener)
                iframe.addEventListener('load', onloadHandler, true);
            else if (document.attachEvent)
                iframe.attachEvent('onload', onloadHandler);
        };
        var ordinal = ++this.mMessageOrdinal;
        this.mMessagesOnSent[ordinal] = new msgObj(this, ordinal, data, targetHost);
    }
};
ISQ.CDC.User.prototype.dispatchMessage = function (message)
{
    /*
    * Since messages can be retrieved in a different order than they were sent,
    * We must dispatch them in the correct order.
    */

    if (message["widget"] && this.mWidget !== message["widget"]) return; // enforcing message received by relevant instance
    var obj = { message: message, filter: false };
    this.eFilterMessages.dispatch(obj);
    if (obj.filter) return; // filtering object
    if (message["subject"] && message["subject"] == "reset")  // reset ordinal message
    {
        this.mLastHandledMessageOrdinal = 0;
        this.mMessageOrdinal = 0;
        this.mReceivedMessages = null;
        this.mWasReset_debug = true;
    }
    var ord = parseInt(message["ord"]);

    //debug
    //window.top.document.getElementById('log').innerHTML += "cdc-user message: " + message["subject"] + ". for widget: " + message["widget"] + ". ordinal " + ord + "<br/>";

    var diff = ord - this.mLastHandledMessageOrdinal;
    if (diff <= 0) return; // not handling the same ordinal message
    if (diff > 1)  // incoming message is skipping a previous one
    {
        //debug
        //window.top.document.getElementById('log').innerHTML += "cdc-user message delayed: " + message["subject"] + ". ordinal diff: " + diff + "<br/>";
        if (this.mReceivedMessages === null)
        {
            this.mReceivedMessages = new Array();
            this.mReceivedMessagesCount = 0;
        }
        this.mReceivedMessages[ord] = message;
        ++this.mReceivedMessagesCount;
    }
    else
    {
        try
        {
            this.incomingMessageEvent.dispatch(message);
        }
        catch (e) { }

        if (this.mReceivedMessages !== null)
        {
            var numberOfMessages = this.mReceivedMessagesCount;
            var ndx = ord + 1;
            for (var i = 0; i < numberOfMessages; ++i, ++ndx)
            {
                if (!this.mReceivedMessages[ndx]) break;
                //debug
                //window.top.document.getElementById('log').innerHTML += "cdc-user. released message " + (ndx) + ". " + this.mWidget + "<br/>";
                this.incomingMessageEvent.dispatch(this.mReceivedMessages[ndx]);
                ord = ndx; // setting last handled message
                --this.mReceivedMessagesCount;
            }
            if (this.mReceivedMessagesCount === 0) this.mReceivedMessages = null;

            //debug
            //window.top.document.getElementById('log').innerHTML += "cdc-user released delayed messages. " + this.mWidget + " last handled ord: " + ord + "<br/>";
        }

        this.mLastHandledMessageOrdinal = ord; // setting last handled message
    }
};
ISQ.CDC.User.prototype.targetWindowName = function ()
{
    return this.mTargetWindowName;
};
ISQ.CDC.User.prototype.allowMessagesFrom = function ()
{
    return this.mAllowMessagesFrom;
};
ISQ.CDC.User.prototype.mTargetWindowName = null;
ISQ.CDC.User.prototype.mLegacyMode = false;
ISQ.CDC.User.prototype.mHost_l = "";
//ISQ.CDC.User.prototype.mProxyIFrameId_l = null;
//ISQ.CDC.User.prototype.mProxyIFrame_l = null;
ISQ.CDC.User.prototype.mProxyIFrameUrl = null;
ISQ.CDC.User.prototype.mProxyIFrameBaseUrl_l = null;
ISQ.CDC.User.prototype.mCurrentHeight = 70;
ISQ.CDC.User.prototype.incomingMessageEvent = null;
ISQ.CDC.User.prototype.eFilterMessages = null;
ISQ.CDC.User.prototype.mPostMessageEventListener = null;
ISQ.CDC.User.prototype.mIsCDCStation = true;
ISQ.CDC.User.prototype.mMessageOrdinal = 0;
//ISQ.CDC.User.prototype.mMessageTimer_l = null;
//ISQ.CDC.User.prototype.mTempMessage_l = "";
ISQ.CDC.User.prototype.mAllowMessagesFrom = null;
ISQ.CDC.User.prototype.mMessagesOnSent = null;
ISQ.CDC.User.prototype.mReceivedMessages = null;
ISQ.CDC.User.prototype.mLastHandledMessageOrdinal = 0;
ISQ.CDC.User.prototype.mReceivedMessagesCount = 0;
ISQ.CDC.User.prototype.mWasReset_debug = false;


ISQ.CDC.User.getIframeId = function()
{
    return "nR_CDC" + ISQ.CDC.User.iframeIdCounter++;    
}
ISQ.CDC.User.iframeIdCounter = new Date().getTime();</script>
    <script type="text/javascript">////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////
var VisualEffects = {};

////////////////////////////////////////////////////////////////////////
/****************************** [FADE] ********************************/
////////////////////////////////////////////////////////////////////////
VisualEffects.FadeEnum = {IN: 5, OUT: 6};
VisualEffects.Fade = function(element)
{
	this.mElement = _(element);
	
	// no valid element
	if (this.mElement === null) throw("VisualEffects.Fade Ctor: No valid element");
	
	// initiating events
	this.fadeInEvent = new ISQ.Event();
	this.fadeOutEvent = new ISQ.Event();
	
	return this;
}

/// members
VisualEffects.Fade.prototype.mElement = null;
VisualEffects.Fade.prototype.fadeInEvent = null;
VisualEffects.Fade.prototype.fadeOutEvent = null;
VisualEffects.Fade.prototype.mIsRunning = false;
VisualEffects.Fade.prototype.mTimer = null;
VisualEffects.Fade.prototype.mInterval = null;
VisualEffects.Fade.prototype.mAmount = null;
VisualEffects.Fade.prototype.mLeftAmount = null;
VisualEffects.Fade.prototype.mTime = null;
VisualEffects.Fade.prototype.mLastExecutionTime = null;
VisualEffects.Fade.prototype.mAvailableToRun = true;
VisualEffects.Fade.prototype.mCurrentDirection = null;
VisualEffects.Fade.prototype.mCurrentOpacity = -1;
VisualEffects.Fade.prototype.mRemoveFilterStyle = false;
VisualEffects.Fade.prototype.mCancelInIe6 = false;


/// methods
VisualEffects.Fade.prototype.stop = function()
{
	if (this.mIsRunning)
	{
		clearTimeout(this.mTimer);
		this.mIsRunning = false;
	}
}

VisualEffects.Fade.prototype.fadeOut = function (time, cancelInIe6)
{
    try
    {
        // stopping current run
        this.stop();

        // to cancel fade in ie6 ?!
        this.mCancelInIe6 = cancelInIe6 === true ? true : false;

        // getting opacity
        this.mCurrentOpacity = this.getOpacity();

        // if can't fade out
        if (this.mCurrentOpacity === 0)
        {
            this.fadeOutEvent.dispatch();
            return false;
        }

        // defining parameters
        this.mCurrentDirection = VisualEffects.FadeEnum.OUT;
        this.mTime = time;
        this.mInterval = 10;
        this.mLeftAmount = this.mCurrentOpacity;
        this.mAmount = this.mLeftAmount / (this.mTime / this.mInterval); // E.g. left amount of 100 / (maxTime(500ms)/interval(10ms)) = 2;

        // finishing fading in ie6 if there's text in it
        if (ISQ.Http.browser.isIE6 && this.mCancelInIe6) this.mAmount = this.mLeftAmount;

        // changing opacity
        this.updateOpacity(-this.mAmount);

        // updating flag
        this.mIsRunning = true;

        // running timer
        var _self = this;
        this.mLastExecutionTime = new Date();
        this.mTimer = setTimeout(function () { _self.fader() }, this.mInterval);
    }
    catch (ex)
    {
        //alert(ex.message);
        return false;
    }
    return true;
}

VisualEffects.Fade.prototype.fadeIn = function (time, removeFilterAttribute, cancelInIe6)
{
    try
    {
        // stopping current run
        this.stop();

        // does it have text in it?
        this.mRemoveFilterStyle = removeFilterAttribute === true ? true : false;

        // to cancel fade in ie6 ?!
        this.mCancelInIe6 = cancelInIe6 === true ? true : false;

        // getting current opacity
        this.mCurrentOpacity = this.getOpacity();

        // if can't fade in
        if (this.mCurrentOpacity === 100)
        {
            this.fadeInEvent.dispatch();
            return false;
        }

        // defining parameters
        this.mCurrentDirection = VisualEffects.FadeEnum.IN;
        this.mTime = time;
        this.mInterval = 10;
        this.mLeftAmount = (100 - this.mCurrentOpacity);
        this.mAmount = this.mLeftAmount / (this.mTime / this.mInterval); // E.g. left amount of 100 / (maxTime(500ms)/interval(10ms)) = 2;

        // finishing fading in ie6 if there's text in it
        if (ISQ.Http.browser.isIE6 && this.mCancelInIe6) this.mAmount = this.mLeftAmount;

        // changing opacity
        this.updateOpacity(this.mAmount);

        // updating flag
        this.mIsRunning = true;

        // running timer
        var _self = this;
        this.mLastExecutionTime = new Date();
        this.mTimer = setTimeout(function () { _self.fader() }, this.mInterval);
    }
    catch (ex)
    {
        //alert(ex.message);	
        return false;
    }
    return true;
}

VisualEffects.Fade.prototype.fader = function ()
{
    try
    {
        clearTimeout(this.mTimer);        

        // if stop has invoked
        if (!this.mIsRunning) return;

        // taking current time
        var diff = new Date() - this.mLastExecutionTime;
        this.mInterval = diff;

        // updating time
        this.mTime -= diff;
        if (this.mTime <= 0) this.mTime = 0;

        switch (this.mCurrentDirection)
        {
            case VisualEffects.FadeEnum.OUT:
                // calculation amount
                this.mLeftAmount = this.mCurrentOpacity;
                if (this.mTime === 0) this.mTime = this.mInterval;
                this.mAmount = this.mLeftAmount / (this.mTime / this.mInterval);
                this.mAmount = this.mAmount > this.mLeftAmount ? this.mLeftAmount : this.mAmount;

                // changing opacity
                this.updateOpacity(-this.mAmount);

                // finished fading out
                if (this.mCurrentOpacity === 0)
                {
                    this.mIsRunning = false;
                    this.fadeOutEvent.dispatch();
                    return;
                }
                break;
            case VisualEffects.FadeEnum.IN:
                // calculation amount
                this.mLeftAmount = this.mCurrentOpacity >= 100 ? 100 : (100 - this.mCurrentOpacity);
                if (this.mTime === 0) this.mTime = this.mInterval;
                this.mAmount = this.mLeftAmount / (this.mTime / this.mInterval);
                this.mAmount = this.mAmount > this.mLeftAmount ? this.mLeftAmount : this.mAmount;

                // changing opacity
                this.updateOpacity(this.mAmount);

                // finished fading out
                if (this.mCurrentOpacity === 100)
                {
                    // setting flag
                    this.mIsRunning = false;

                    // clearing filter style attribute in IE with text
                    if (this.mRemoveFilterStyle && ISQ.Http.browser.app === "ie" && !ISQ.Http.browser.isIE11)
                    {
                        this.mElement.style.filter = '';
                        this.mElement.style.removeAttribute('filter');
                    }

                    this.fadeInEvent.dispatch();
                    return;
                }
                break;
        }

        // if stop has invoked
        if (!this.mIsRunning) return;

        // running timer
        var _self = this;
        this.mLastExecutionTime = new Date();
        this.mTimer = setTimeout(function () { _self.fader() }, this.mInterval);
    }
    catch (ex)
    {
        //alert(ex.message);	
    }
}

VisualEffects.Fade.prototype.getOpacity = function()
{
	var opacity = 100;
	// ie browser
	if (ISQ.Http.browser.app === "ie" && !ISQ.Http.browser.isIE11)
	{
		var opString = ISQ.CSS.getValue(this.mElement, 'filter');
		if (typeof(opString) !== 'undefined' && opString !== null)
		{
			var start = opString.indexOf("alpha(opacity=");
			if (start !== -1)
			{
				var endIndex = opString.indexOf(",");
				if (endIndex === -1) endIndex = opString.indexOf(")");
				var parsedOp = parseInt(opString.substring(start + 14, endIndex));
				if (!isNaN(parsedOp)) opacity = parsedOp;
			}
			
			if (opacity < 0)
				opacity = 0;
			else if (opacity > 100) 
				opacity = 100;
		}
	}
	// non-ie
	else
	{
		var opString = ISQ.CSS.getValue(this.mElement, 'opacity');
		if (typeof(opString) !== 'undefined' && opString !== null)
		{
			var parsedOp = Number(opString);
			if (!isNaN(parsedOp))
			{
				opacity = parsedOp;
				opacity *= 100;
				if (opacity < 0)
					opacity = 0;
				else if (opacity > 100)
					opacity = 100;
			}
		}
	}
	return opacity;
}


VisualEffects.Fade.prototype.setOpacity = function (opacity)
{
    this.updateOpacity(-this.mCurrentOpacity + opacity);
}

VisualEffects.Fade.prototype.updateOpacity = function (updateBy)
{
    // updating variable opacity
    this.mCurrentOpacity += updateBy;

    if (this.mCurrentOpacity < 0)
        this.mCurrentOpacity = 0;
    else if (this.mCurrentOpacity > 100)
        this.mCurrentOpacity = 100;

    // updating style
    if (ISQ.Http.browser.app === "ie" && !ISQ.Http.browser.isIE11)
    {
        var filterA = new Array();
        filterA.push("alpha(opacity=");
        filterA.push(this.mCurrentOpacity);
        filterA.push(")");
        this.mElement.style.filter = filterA.join('');
    }
    else
    {
        var op = parseInt(this.mCurrentOpacity) / 100;
        this.mElement.style.opacity = op;
    }
}</script>
    <script type="text/javascript">/////////////////////////////////////////////////////////////////////////////////////////////
// Progress bar (3 dots with oscillating opacity)

ISQ.GUI = initializeNS("ISQ.GUI");
ISQ.GUI.ProgressAnimation = ISQ.Base.extend({name: "ISQ.GUI.ProgressAnimation"});
ISQ.GUI.ProgressAnimation.prototype.ctor = function (ctorObject)
{
    this.mDiv = ctorObject.container;
    this.mOnShow = ctorObject.onShow || null;
    this.mOnHide = ctorObject.onHide || null;
    this.mDivCounter = ctorObject.numofboxes || 3;
    this.mOpacityMinValue = ctorObject.opacityMin || 20;
    this.mOpacityMaxValue = ctorObject.opacityMax || 60;


    // creating divs
    this.mArray = new Array();
    var opacity = this.mOpacityMaxValue;
    for (var i = 0; i < this.mDivCounter; ++i)
    {
        opacity -= this.mOpacityDiff;

        var div = createDiv(this.mDiv, ctorObject.boxStyle);
        if (ISQ.Http.browser.isIE6 || ISQ.Http.browser.isIE7) div.innerHTML = "&nbsp;";
        this.mArray[i] =
        {
            div: div,
            opacity: opacity,
            increment: this.mIncrementValue
        }
    }
}
ISQ.GUI.ProgressAnimation.prototype.dtor = function ()
{
    this.hide();
    try
    {
        clearNode(this.mDiv);
        if (this.mDiv.parentNode) this.mDiv.parentNode.removeChild(this.mDiv);
    }
    catch (e) { }
}
ISQ.GUI.ProgressAnimation.prototype.show = function (className)
{
    if (className)
    {
        if (!this.mOriginalClassName)
            this.mOriginalClassName = this.mDiv.className;
        this.mDiv.className = className;
    }

    this.mDiv.style.display = 'block';
    this.start();

    if (typeof (this.mOnShow) === 'function') this.mOnShow();
}
ISQ.GUI.ProgressAnimation.prototype.start = function ()
{
    if (this.mTimer) return;
    this.timerFunc();
}
ISQ.GUI.ProgressAnimation.prototype.timerFunc = function ()
{
    if (this.mIsDisposed) return;

    for (var i = 0; i < this.mArray.length; ++i)
    {
        ISQ.CSS.setOpacity(this.mArray[i].div, this.mArray[i].opacity);

        // updating opacity for next round
        var opacity = this.mArray[i].opacity + this.mArray[i].increment;
        if (opacity > this.mOpacityMaxValue || opacity < this.mOpacityMinValue)
        {
            this.mArray[i].increment *= -1;
            opacity = this.mArray[i].opacity + (this.mArray[i].increment * this.mOpacityEdgeSkip);
        }
        this.mArray[i].opacity = opacity;
    }

    var thisObj = this;
    this.mTimer = setTimeout(function ()
    {
        thisObj.timerFunc();
    }, this.mTimerInterval);
}
ISQ.GUI.ProgressAnimation.prototype.stop = function ()
{
    clearTimeout(this.mTimer);
    this.mTimer = null;
}
ISQ.GUI.ProgressAnimation.prototype.hide = function ()
{
    if (this.mOriginalClassName)
    {
        this.mDiv.className = this.mOriginalClassName;
    }

    this.mDiv.style.display = 'none';
    this.stop();

    if (typeof (this.mOnHide) === 'function') this.mOnHide();
}

ISQ.GUI.ProgressAnimation.prototype.container = function ()
{
    return this.mDiv;
}

ISQ.GUI.ProgressAnimation.prototype.mDiv = null;
ISQ.GUI.ProgressAnimation.prototype.mOriginalClassName = null;
ISQ.GUI.ProgressAnimation.prototype.mDivCounter = 3;
ISQ.GUI.ProgressAnimation.prototype.mOpacityDiff = 12;
ISQ.GUI.ProgressAnimation.prototype.mTimer = null;
ISQ.GUI.ProgressAnimation.prototype.mTimerInterval = 50;
ISQ.GUI.ProgressAnimation.prototype.mIncrementValue = 3;
ISQ.GUI.ProgressAnimation.prototype.mOpacityEdgeSkip = 5;
ISQ.GUI.ProgressAnimation.prototype.mOpacityMaxValue = 60;
ISQ.GUI.ProgressAnimation.prototype.mOpacityMinValue = 20;
ISQ.GUI.ProgressAnimation.prototype.mOnShow = null; 
ISQ.GUI.ProgressAnimation.prototype.mOnHide = null;</script>
    <script type="text/javascript">/////////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////
ISQ.GUI = initializeNS('ISQ.GUI');
ISQ.GUI.IntuitiveInput = ISQ.Base.extend({ name: "ISQ.GUI.IntuitiveInput" });

ISQ.GUI.IntuitiveInput.prototype.ctor = function (obj)
{
    this.mInput = obj.input;
    this.mInput.intuitive = this;
    this.mOnTimeElapsedHandler = obj.onTimeElapsedHandler || null;
    if (!this.mOnTimeElapsedHandler) throw ("Intuitive search ctor: invalid onTimeElapsedHandler");
    this.mOnBeginWritingHandler = obj.onBeginWritingHandler || null;
    this.mEnterKeyHandler = obj.enterKeyHandler || null;
    this.mLastValue = this.mInitialValue = obj.initialValue || this.mInput.value.Trim();
    this.mInterval = obj.interval || this.mInterval;
    this.mOriginalKeyUpHandler = obj.keyUpHandler || null;
    this.mRange = obj.range || null;

    // keyup handler
    if (this.mInput.onkeyup)
    {
        var oldKeyUp = this.mInput.onkeyup; // fire the old keyup event before our handler
        this.mInput.onkeyup = function (event4ff)
        {
            oldKeyUp(event4ff);
            this.intuitive.inputKeyUpHandler.apply(this.intuitive, new Array(event4ff, this.value));
        }
    }
    else
    {
        this.mInput.onkeyup = this.inputKeyUpHandler;
    }

    this.mInput.onpaste = function (event4ff)
    {
        var mthis = this;
        setTimeout(function ()
        {
            mthis.intuitive.inputKeyUpHandler.apply(mthis.intuitive, new Array(event4ff, mthis.value));
        }, 0);
    }

    // firing event 
    if (obj.processAfterConstructor === true)
        this.mInput.onkeyup();
    else
        this.mFirstRun = false;
}
ISQ.GUI.IntuitiveInput.prototype.dtor = function ()
{
    this.mInput.intuitive = null;
    this.mInput = null;
    this.mOnTimeElapsedHandler.dispose();
    this.mOnTimeElapsedHandler = null;

    if (this.mOnBeginWritingHandler !== null)
    {
        this.mOnBeginWritingHandler.dispose();
        this.mOnBeginWritingHandler = null;
    }
}
ISQ.GUI.IntuitiveInput.prototype.inputKeyUpHandler = function (event4ff, value)
{
    if (typeof (this.intuitive) !== 'undefined')
    {
        arguments.callee.apply(this.intuitive, new Array(event4ff, this.value))
        return;
    }

    // handling Enter key
    if (this.mEnterKeyHandler)
    {
        var _event = ISQ.Html.getDomEvent(event4ff);
        if (_event && _event.domEvent && _event.domEvent.keyCode === 13)
        {
            this.mEnterKeyHandler.handle(_event);
            return;
        }
    }
    
    //Checking values range
    if (this.mRange)
    {   
        var from = this.mRange[0];
        var to = this.mRange[1];
        if (value > to)
        {
            this.mInput.value = to;
            value = to + '';
        }
        else if(value < from)
        {
            this.mInput.value = from;
            value = from + '';
        }
    }

    // first run
    if (this.mFirstRun)
    {
        this.mFirstRun = false;
        if (this.mLastValue.length === 0) return;

        // invoking event
        this.mOnTimeElapsedHandler.handle(this.mLastValue, true);
        return;
    }

    // value hasn't changed, returning
    if (value === this.mLastValue) return;
    value = value.Trim();

    // firing starts writing handler
    if (this.mKeyUpTimer === null && this.mOnBeginWritingHandler && value !== this.mLastValue)
        this.mOnBeginWritingHandler.handle();

    // updating last value
    this.mLastValue = value;

    // clearing timeout
    clearTimeout(this.mKeyUpTimer);

    // not firing event if query equals last fired query
    if (value === this.mLastQuery) return;

    // no value, firing immediate event
    if (value.length === 0)
    {
        // invoking event
        this.mOnTimeElapsedHandler.handle(value, this.mLastQuery !== value);

        // saving last query
        this.mLastQuery = "";

        // setting timer as 'null'
        // (used to know if the user has started writing)
        this.mKeyUpTimer = null;

        return;
    }

    // starting timer
    var dummy = this;
    this.mKeyUpTimer = setTimeout(function ()
    {
        // if value equals previous value, firing event
        // and indicating that value wasn't changed
        if (dummy.mLastQuery === value)
        {
            dummy.mOnTimeElapsedHandler.handle(value, false);
            return;
        }

        // updating lastValue, firing event
        // and indicating value has changed
        dummy.mLastQuery = value;
        dummy.mOnTimeElapsedHandler.handle(value, true);

        // setting timer as 'null'
        // (used to know if the user has started writing)
        dummy.mKeyUpTimer = null;

    }, this.mInterval);
}

ISQ.GUI.IntuitiveInput.prototype.resetValue = function (dontEmptyInput, initialValue)
{
    if (!dontEmptyInput) this.mInput.value = "";
    if (typeof (initialValue) !== 'undefined') this.mInitialValue = initialValue;
    this.mLastValue = this.mInitialValue;
    this.mLastQuery = null;

    // clearing timeout
    clearTimeout(this.mKeyUpTimer);
    this.mKeyUpTimer = null;
}

ISQ.GUI.IntuitiveInput.prototype.input = function ()
{
    return this.mInput;
}
ISQ.GUI.IntuitiveInput.prototype.value = function ()
{
    return this.mInput.value;
}

ISQ.GUI.IntuitiveInput.prototype.enable = function ()
{
    this.mInput.disabled = false;
}
ISQ.GUI.IntuitiveInput.prototype.disable = function ()
{
    this.mInput.disabled = true;
}

ISQ.GUI.IntuitiveInput.prototype.mInput = null;
ISQ.GUI.IntuitiveInput.prototype.mLastValue = "";
ISQ.GUI.IntuitiveInput.prototype.mInitialValue = "";
ISQ.GUI.IntuitiveInput.prototype.mLastQuery = null;
ISQ.GUI.IntuitiveInput.prototype.mOnTimeElapsedHandler = null;
ISQ.GUI.IntuitiveInput.prototype.mOriginalKeyUpHandler = null;
ISQ.GUI.IntuitiveInput.prototype.mKeyUpTimer = null;
ISQ.GUI.IntuitiveInput.prototype.mInterval = 500;
ISQ.GUI.IntuitiveInput.prototype.mOnBeginWritingHandler = null;
ISQ.GUI.IntuitiveInput.prototype.mFirstRun = true;
ISQ.GUI.IntuitiveInput.prototype.mEnterKeyHandler = null;
</script>
    <script type="text/javascript">//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
ISQ.Debug = initializeNS('ISQ.Debug');
var _debug = function ()
{
    if (arguments.length === 0) return ISQ.Debug;
    if (typeof (arguments[0]) === 'object')
        ISQ.Debug.insertHTML(arguments[0]);
    else
        ISQ.Debug.insertText(arguments[0]);
}
ISQ.Debug.init = function ()
{
    if (!debugLevel) return;

    if (document.addEventListener)
        document.addEventListener('keydown', ISQ.Debug.documentKeyDown, true);
    else if (document.attachEvent)
        document.attachEvent('onkeydown', ISQ.Debug.documentKeyDown);
}
ISQ.Debug.insertText = function (txt)
{
    if (!debugLevel) return;

    this.show();
    var div = createDiv(this.mPopup.contentNode);
    div.innerHTML = txt;
}
ISQ.Debug.insertTimeDiff = function (txt, date)
{
    var now = new Date();
    var diff = (now - date);
    if (diff > 10)
        ISQ.Debug.insertText("<b>" + txt + "</b> @ <b>" + diff + " ms</b>");
    //else
        //ISQ.Debug.insertText("<b>" + txt + "</b> @ " + diff + " ms");
    return now;
}
ISQ.Debug.insertTime = function (txt)
{   
    var d = new Date();
    ISQ.Debug.insertText("<b>" + txt + "</b> @ " + d.ToString("%M:%S") + ":" + d.getMilliseconds());
}
ISQ.Debug.insertHTML = function (html)
{
    if (!debugLevel) return;
    this.show();
    this.mPopup.contentNode.appendChild(html);
}
ISQ.Debug.insertObject = function (obj, _internal, depth)
{
    depth = depth || 0;
    if (depth === 4)
    {
        ISQ.Debug.insertText("DEPTH TOO DEEP");
        return;
    }
    if (!_internal) ISQ.Debug.insertText("START depicting object:");
    for (var i in obj)
    {
        ISQ.Debug.insertText("KEY:" + i);
        if (obj[i] === null)
        {
            ISQ.Debug.insertText("NULL");
        }
        else if (typeof(obj[i]) === 'undefined')
        {
            ISQ.Debug.insertText("Undefined");
        }
        else if (typeof (obj[i]) === 'object')
        {
            var printed = false;
            if (ISQ.Base.isDerivedOf(obj[i], ISQ.Base))
            {
                if (obj[i].isDerivedOf(ISQ.Policies.Policy))
                {
                    printed = true;
                    ISQ.Debug.insertText("Policy Id:" + obj[i].id());
                }
                else if (obj[i].isDerivedOf(ISQ.Event))
                {
                    printed = true;
                    ISQ.Debug.insertText("Event");
                }
                else if (obj[i].isDerivedOf(ISQ.Handler))
                {
                    printed = true;
                    ISQ.Debug.insertText("Handler");
                }
            }
            else if (obj[i].nodeName)
            {
                printed = true;
                ISQ.Debug.insertText("HTML node. Name:" + obj[i].nodeName + ", id: " + obj[i].id);
            }
            if (!printed)
            {
                ISQ.Debug.insertText("{");
                ISQ.Debug.insertObject(obj[i], true, depth + 1);
                ISQ.Debug.insertText("}");
            }
        }
        else if (typeof (obj[i]) === 'function')
        {
            ISQ.Debug.insertText("function()");
        }
        else
        {
            ISQ.Debug.insertText("VALUE: " + obj[i]);
        }
    }
    if (!_internal) ISQ.Debug.insertText("STOP depicting object:");
}
ISQ.Debug.insertStackCallback = function ()
{
    var max = 30;
    var array = new Array();
    // getting the function which called this function
    var curr = arguments.callee.caller;
    // moving one function up
    curr = curr.caller;
    // starting to save results
    for (var i = 0; i < max && curr !== null; ++i)
    {
        var found = false;
        for (var j = 0; j < array.Length && !found; ++j)
        {
            if (array[j] === curr) found = true;
        }
        if (found) break;
        array.push(curr);
        curr = curr.caller;
    }
    this.insertText("Printing callstack");
    this.insertArray(array);
}
ISQ.Debug.insertArray = function (arr)
{
    for (var i = 0; i < arr.length; ++i)
    {
        this.insertText(i + ": " + arr[i]);
    }
}

ISQ.Debug.createPopup = function ()
{
    // creating div
    var div = createDiv(document.body, "border:2px solid #aaa;background:#212620;width:300px;");
    innerDiv = createDiv(div, "padding:5px");
    var title = createElement("h2", innerDiv, "color:#e5e5e5");
    title.innerHTML = "Debug";

    var a = createLink(
    {
        text: "X",
        onclick: function ()
        {
            this.debugConsole.hide();
        },
        style: "color: #E5E5E5;margin-left: 5px;position: absolute;right: 8px;top: 5px;text-decoration:none",
        parent: innerDiv
    });
    a.debugConsole = this;

    a = createLink(
    {
        text: "Clear All",
        onclick: function ()
        {
            this.debugConsole.mPopup.contentNode.innerHTML = "";
        },
        style: "color: #E5E5E5;float: left;margin: 5px 0 0;text-decoration: none;",
        parent: innerDiv
    });
    a.debugConsole = this;

    var debugDiv = createDiv(div, "background:#efefef;padding:5px;width:290px;height:300px;overflow-y:auto;resize:both;margin-top:20px;border-top:1px solid #666;font-size:14px;font-family:verdana");
    debugDiv.id = 'nanoRepDebugDiv';

    // creating popup
    this.mPopup = new ISQ.GUI.Popup(
    {
        position:
        {
            type: ISQ.GUI.Popup.PositionType.SCREEN_LEFT_TOP,
            adjust: false,
            fixed: true
        },
        element: div,
        drag: title,
        blockerOptions:
		{
		    show: false
		}
    });
    this.mPopup.contentNode = debugDiv;
}

ISQ.Debug.show = function()
{
    if (!this.mPopup) this.createPopup();
    this.mPopup.show();
}
ISQ.Debug.hide = function ()
{
    this.mPopup.hide();
}
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
ISQ.Debug.documentKeyDown = function (_event)
{
    var _e = window.event || _event;
    if (_e.shiftKey) return true;
    if (_e.keyCode !== 192) return true;
    ISQ.Debug.toggleConsole();
    return false;
}
ISQ.Debug.toggleConsole = function ()
{
    if (!ISQ.Debug.mConsolePopup)
    {
        ISQ.Debug.mConsolePopup = createDiv(document.body, "position:fixed;bottom:1px;padding:4px 7px;width:80%;background:#fff;z-index:20;border:1px solid #cdcdcd;right:0");
        ISQ.Debug.mConsoleInput = createInput(
        {
            parent: ISQ.Debug.mConsolePopup,
            type: "text",
            style: "width:90%;border:0;font-size:16px;"
        });
        setTimeout(function () { ISQ.Debug.mConsoleInput.focus(); }, 0); // resetting input
        ISQ.Debug.mConsoleInput.onkeyup = ISQ.Debug.parseConsoleInput;
    }
    else
    {
        setTimeout(function () { ISQ.Debug.mConsoleInput.value = ""; }, 0); // resetting input
        if (ISQ.Debug.mConsolePopup.style.display === 'none')
        {
            ISQ.Debug.mConsolePopup.style.display = 'block';
            try { ISQ.Debug.mConsoleInput.focus(); } catch (e) { }
        }
        else
        {
            ISQ.Debug.mConsolePopup.style.display = 'none';
        }
    }
}
ISQ.Debug.parseConsoleInput = function (_event)
{
    var _e = window.event || _event;
    if (_e.keyCode != 13) return;

    var val = ISQ.Debug.mConsoleInput.value.Trim();
    if (!val) return;
    switch (val)
    {
        case "open()":
            ISQ.Debug.show();
            break;
        case "refreshCharts()":
            var gcArr = pageGC().array();
            for (var i = 0; i < gcArr.length; ++i)
            {
                if (!ISQ.Base.isDerivedOf(gcArr[i], ISQ.Statistics.Charts.IChart)) continue;
                if (gcArr[i].isDisposed()) continue;
                gcArr[i].process();
            }
            break;
    }
}

ISQ.Debug.mPopup = null;
ISQ.Debug.mConsolePopup = null;
ISQ.Debug.mConsoleInput = null;

//////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////
</script>
    <script type="text/javascript">ISQ.Widget = initializeNS('ISQ.Widget');
ISQ.API = initializeNS('ISQ.API')
ISQ.Widget.supportsPostMessage = (typeof (window.postMessage) === 'function' || typeof (window.postMessage) === 'object');
ISQ.Widget.doctype = typeof(ISQ.Html) !== 'undefined' ? ISQ.Html.detectDoctype() : null;
ISQ.Widget.getDynamicHost = function()
{
	return "//" + "my.nanorep.com";;
}</script>
    <script type="text/javascript">ISQ.Widget = ISQ.Widget || {};
/**
 * Parses the string of custom params.
 * @param {string} value key1:value1,key2:value2
 * @return {Object} A dictionary of key/value pairs
 */
ISQ.Widget.parseCustomParams = function (value)
{
	var result = {}, pos, len, param;
	value = value.split(',');
	function customUnescape(arg)
	{
		return arg.replace(/(\\\\|\\colon|\\comma)/g,
			function(entry)
			{
				switch (entry)
				{
					case '\\\\': return '\\';
					case '\\colon': return ':';
					case '\\comma': return ',';
				}
			});
	}
	for (pos = 0, len = value.length; pos < len; ++pos)
	{
		param = value[pos].split(':', 2);
		if (param.length === 2) result[customUnescape(param[0])] = customUnescape(param[1]);
	}
	return result;
};
;

//// This function gets an url and urlWithDomain and makes sure 
//// that url is a valid url in the domain 'urlWithDomain' belongs to.
//// The method will return the fixed url or if onlyValidate is ture, will return "" if invalid
// widgetui
ISQ.Widget.getInnerFrameUrl = function (url, urlWithDomain, onlyValidate)
{
    url = url || 'CDCframe.html';

    /////////////////////////////////////////////////
    // urlWithDomain can be http://www.nanorep.com || qa.nanorep.com || nanorep.com
    var colonIndex = urlWithDomain.indexOf("://") + 3;
    var slashIndex;
    var domain;
    var protocol = "";
    if (colonIndex !== 2)
    {
        slashIndex = urlWithDomain.indexOf("/", colonIndex);
        protocol = urlWithDomain.substring(0, colonIndex);
        domain = urlWithDomain.substring(colonIndex, slashIndex);
    }
    else
    {
        slashIndex = urlWithDomain.indexOf("/");
        domain = urlWithDomain.substring(0, slashIndex);
    }

    // url can be:  http://www.nanorep.com/widget/iframe.html || /widget/iframe.html || widget/iframe.html
    var urlColonNdx = url.indexOf("://") + 3;
    var urlSlashIndex;
    var urlDomain;
    var urlProtocol = "";
    if (urlColonNdx !== 2)
    {
        urlSlashIndex = url.indexOf("/", urlColonNdx);
        urlProtocol = url.substring(0, urlColonNdx);
        urlDomain = url.substring(urlColonNdx, urlSlashIndex);
    }
    else
    {
        urlSlashIndex = url.indexOf("/");
        urlDomain = url.substring(0, urlSlashIndex);
    }

    /////////////////////////////////////////////////////////////
    // url starts with valid domain
    if (protocol && urlDomain === domain)
    {
        if (urlProtocol !== protocol) return url.replace(urlProtocol, protocol);
        return url;
    }

    // validate mode:
    else if (onlyValidate)
    {
        // urlDomain is the same domain as current widget's domain(i.e preview)
        if (urlDomain === ISQ.Http.domain()) return url;
        // illegal iframe url
        return "";
    }

    //////////////////////////////////////////////////////////////////////////
    // building a valid url
    var iframeSrc = '';
    if (url.charAt(0) === '/')
    {
        // building a valid iframe url
        iframeSrc = protocol + domain + url;
    }
    else
    {
        /// innerFrameUrl is a full path (http://....) ///
        if (urlColonNdx !== 2) // -1 + 3
        {
            iframeSrc = protocol + domain + url.substring(urlSlashIndex);
        }
        /// relative path in the domain
        else
        {
            /*
            var lastSlashIndex;
            do
            {
            lastSlashIndex = slashIndex;
            slashIndex = urlWithDomain.indexOf("/", lastSlashIndex+1);
            }
            while (slashIndex !== -1)

            var relativePath = urlWithDomain.substring(0, lastSlashIndex);
            iframeSrc = relativePath + '/' + url;
            */

            // current fix (a logic bug): handling it as it was with '/'
            iframeSrc = protocol + domain + "/" + url;
        }
    }
    return iframeSrc;
};

ISQ.Widget.APIKeyEndDelimiter = "<";
ISQ.Widget.APIValueEndDelimiter = "(";


// widgetUI
// builds the link to nanorep.com used in the footer
ISQ.Widget.buildNRLinkUrl = function (account, source, widgetType)
{
    var url = new Array();
    //rl.push("http://widget.nanorep.com/From-Widget/?s=poweredBy&aid=");
    url.push("http://www.nanorep.com/?s=poweredBy&aid=");
    url.push(account);
    if (source)
    {
        url.push('&utm_source=');

        // strip subdomain
        var tokens = ISQ.Http.domain(false, source).split('.');
        var idx = url.length;
        for (var i = tokens.length - 1; i >= 0; i--)
        {
            url.splice(idx, 0, tokens[i]);
            if (tokens[i].length > 3) break;
            if (i > 0) url.splice(idx, 0, '.');
        }
    }
    url.push("&utm_medium=widget&utm_content=");
    url.push(widgetType);

    return url.join('');
}
// widgetUI
ISQ.Widget.addCssStyles = function (styleContent, id)
{
    if (typeof (styleContent) === 'string' && styleContent)
    {
        // value is not base64 encoded
        if (styleContent.contains(" "))
            ISQ.CSS.addNewStyle(styleContent, id);
        else // value is base64 encoded
            ISQ.CSS.addNewStyle(ISQ.Tools.Base64.decode(styleContent), id);
    }
}
</script>
    <script type="text/javascript">

// widgetUI + mostpopular
// syntax: {{value1|value2:default}}
// if global default is null, replacement fails if a param is missing
ISQ.Widget.replacePlaceholders = function (sourceText, replacers, startSignature, endSignature, ignoreMissed)
{
    var result = {};
    result.success = false;
    result.text = sourceText;
    if (!sourceText)
    {
        result.success = true; // returning success for empty sourceText
        return result;
    }

    //var params = ISQ.Widget.API.getCustomParams();

    var builder = new Array();
    var startIndex = 0;
    var lastEndPos = 0;
    var paramSeparator = ["|", ":"];
    while (startIndex < sourceText.length)
    {
        startIndex = sourceText.indexOf(startSignature, lastEndPos);
        if (startIndex === -1)
        {
            builder.push(sourceText.substring(lastEndPos));
            break;
        }
        // adding string in between signatures
        builder.push(sourceText.substring(lastEndPos, startIndex));

        //////////////////////////////////////////////////////////////////////////
        // search for end signature
        lastEndPos = sourceText.indexOf(endSignature, startIndex);
        // if end signature not found, break
        if (lastEndPos == -1)
        {
            builder.push(sourceText.substring(startIndex));
            break;
        }

        var placeholder = sourceText.substring(startIndex + 2, lastEndPos);
        lastEndPos += 2; // skipping end signature for next loop;

        //////////////////////////////////////////////////////////////////////////
        // getting placeholder value (checking multiple placeholder and default value
        var placeholders = placeholder.split('|');
        var defaultValue;
        for (var pIndex = 0; pIndex < placeholders.length; ++pIndex)
        {
            placeholder = placeholders[pIndex];
            if (pIndex == placeholders.length - 1)
            {
                var colonIndex = placeholder.indexOf(':');
                if (colonIndex !== -1)
                {
                    defaultValue = placeholder.substring(colonIndex + 1);
                    placeholder = placeholder.substring(0, colonIndex);
                }
            }
            // no replacers
            if (!replacers)
            {
                // if in last iteration, taking default value.
                if (pIndex == placeholders.length - 1)
                    paramValue = defaultValue;
                continue; // continuing the loop
            }
            else
            {
                var paramValue = replacers[placeholder];
                if (paramValue) break; // valid placeholder found
                paramValue = defaultValue; // attempt to use default value 
            }
        }
        if (!paramValue)
        {
            if (!ignoreMissed) return result; //FAILED
            paramValue = "";
        }

        // build string
        builder.push(paramValue);
    }
    result.text = builder.join('');
    result.success = true;
    return result;
}

// widgetUI + mostpopular
ISQ.Widget.buildAttachmentUrls_forEvent = function (urls)
{
    if (!urls) return null;
    var fixedUrls = []
    var sp = urls.split(',');
    for (var i = 0; i < sp.length; ++i)
    {
        if (fixedUrls.length != 0) fixedUrls.push(',');
        ISQ.Widget.getAttachmentUrl(sp[i], fixedUrls);
    }
    return fixedUrls.join('');
}

ISQ.Widget.getAttachmentUrl = function (url, answerBuilder)
{
    var pos = url.indexOf("/"); // filename contains bucket
    if (pos == -1) return;

    answerBuilder.push("http://");
    answerBuilder.push(url.substring(0, pos));
    answerBuilder.push(".s3.amazonaws.com/");
    answerBuilder.push(url.substring(pos + 1));
}
</script> 
    <script type="text/javascript">ISQ.Widget.buildCNFSource = function (serverUrl, account, isFloat, kb, referer, preview, splitTestGroup)
{
    var output = [];
    if (serverUrl) output.push(serverUrl);
    output.push("/~");
    output.push(account.toLowerCase());
    output.push("/widget/scripts/cnf.js?account=");
    output.push(account);
    output.push("&key=");
    output.push(ISQ.Http.Cookies.encode64(ISQ.Http.domain(true, referer ? referer : null)));

    if (splitTestGroup)
    {
        output.push("&splittestgroup=");
        output.push(splitTestGroup);
    }
    if (referer)
    {
        // removing http(s):// 
        refererStart = referer.indexOf("//");
        if (refererStart > 0 && refererStart < 8)
            refererStart += 2;
        else
            refererStart = 0;
        
        referer = referer.substring(refererStart);
        // removing www. from domain as we don't allow it in the console anyway and its not recognized with www by the server
        if (referer.indexOf("www.") == 0)
            referer = referer.replace("www.", "");

        output.push("&referer=");
        output.push(referer);
    }
    if (isFloat) output.push("&isFloat=true");
    if (kb) // kb (will be used if no other domain was found)
    {
        output.push("&kb=");
        output.push(kb);
    }
    if (preview) output.push("&preview=true");

    // iphone 6+ is adding '?3132131312' to request URL. we're keeping request integrity #8361
    if (ISQ.Http.browser.isIPhone) output.push("&d=1");
    return output.join('');
};</script>
    <script type="text/javascript">ISQ.Widget = initializeNS('ISQ.Widget');
ISQ.API = initializeNS('ISQ.API');
// #region Chat Providers
ISQ.Widget.Proxy = initializeNS('ISQ.Widget.Proxy');
ISQ.Widget.Proxy.Chat =
{
    sendMessage: function (targetArray, msg)
    {
        _it(targetArray, function (widget)
        {
            widget.cdcUser.sendMessage("subject=chat&" + msg);
        });
    }
};

ISQ.Widget.Proxy.Chat.LiveChatInc =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else // startChat
            LC_API.open_chat_window();
    },
    load: function (options, widget)
    {
        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage([widget], "type=available&data=" + this.mAvailable);
                else
                {
                    if (this.mAvailable === "true")
                    {
                        widget.mState |= ISQ.Widget.iChat.enumState.available;
                    }
                    else
                    {
                        widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                    }
                }
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;

        // if script already loaded on page...
        var x = document.head.getElementsByTagName('script');
        for (var i = 0; i < x.length; i++)
        {
            if (x[i].src.indexOf('livechatinc') != -1)
            {
                this.mAvailable = LC_API.agents_are_available(); // saving availability result
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage([widget], "type=available&data=" + this.mAvailable);
                else
                {
                    if (this.mAvailable === "true")
                    {
                        widget.mState |= ISQ.Widget.iChat.enumState.available;
                    }
                    else
                    {
                        widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                    }
                }
                // resetting array
                //this.mPendingWidgets = [];
                // updating state
                this.mState = this.enumStates.availabilityReceived;
                return;
            }

        }
        //////////////////////////////////////////////////////////
        window.__lc = {};
        window.LC_API = {};
        window.__lc.license = options.LiveChatInc.id; // getting id
        // on chat ended, close the chat float
        window.LC_API.on_chat_ended = function ()
        {
            window.LC_API.hide_chat_window();
        };
        // on chat started, open chat ( if in float mode )
        if (!options.popup.enabled)
            window.LC_API.on_chat_started = function (data)
            {
                window.LC_API.open_chat_window();
            };
        var mthis = this;

        window.LC_API.on_before_load = function ()
        {
            window.LC_API.hide_chat_window();
        }

        window.LC_API.on_after_load = function ()
        {
            //if chat not running or popup enabled, hide the chat window after loading as it should not appear 
            if (!window.LC_API.chat_running() || options.popup.enabled)
                window.LC_API.hide_chat_window();

            mthis.mAvailable = LC_API.agents_are_available(); // saving availability result
            // sending message
            if (widget.cdcUser)
                ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
            else
            {
                if (mthis.mAvailable == true)
                {
                    widget.mState |= ISQ.Widget.iChat.enumState.available;
                }
                else
                {
                    widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                }
            }

            // resetting array
            //mthis.mPendingWidgets = [];
            // updating state
            mthis.mState = mthis.enumStates.availabilityReceived;
        };
        // loading LP script
        url = "//" + options.LiveChatInc.server + "/tracking.js";
        ISQ.Tools.appendScript(url);
    }
};



ISQ.Widget.Proxy.Chat.Zopim =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else // startChat
        {
            if (options.popup.enabled)
            {
                $zopim.livechat.window.openPopout();
            }
            else
            {
                $zopim.livechat.window.show();
            }
        }
    },
    load: function (options, widget)
    {
        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage([widget], "type=available&data=" + this.mAvailable);
                else
                {
                    if (this.mAvailable == true)
                    {
                        widget.mState |= ISQ.Widget.iChat.enumState.available;
                    }
                    else
                    {
                        widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                    }
                }
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;

        var mthis = this;
        var zopimScript_Loaded = function ()
        {
            if (!$zopim.livechat) return;
            // if already chatting, don't close the chat window.
            if (!$zopim.livechat.isChatting() || options.popup.enabled)
                $zopim.livechat.hideAll();

            // on chat end, closing the floating widget
            $zopim.livechat.setOnChatEnd(function ()
            {
                $zopim.livechat.hideAll();
            });
            // on hiding chat box, if chat not running close it.
            $zopim.livechat.window.onHide(function ()
            {
                if (!$zopim.livechat.isChatting() || options.popup.enabled)
                    $zopim.livechat.hideAll();
            });



            var agentStatusDetector = function (agentStatus)
            {
                if (agentStatus == "online")
                    mthis.mAvailable = true;
                else
                    mthis.mAvailable = false;

                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
                else
                {
                    if (mthis.mAvailable == true)
                    {
                        widget.mState |= ISQ.Widget.iChat.enumState.available;
                    }
                    else
                    {
                        widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                    }
                }
                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            }
            // hide widget from view

            // request to know if agent is available
            $zopim.livechat.setOnStatus(agentStatusDetector);
        }


        // if script already loaded on page...
        var x = document.head.getElementsByTagName('script');
        for (var i = 0; i < x.length; i++)
        {
            if (x[i].src.indexOf('zopim') != -1)
            {
                zopimScript_Loaded();
                return;
            }
        }

        // zopim script
        window.$zopim || (function (d, s)
        {
            var z = $zopim = function (c) { z._.push(c) }, $ = z.s =
        d.createElement(s), e = d.getElementsByTagName(s)[0]; z.set = function (o)
        {
            z.set.
        _.push(o)
        }; z._ = []; z.set._ = []; $.async = !0; $.setAttribute('charset', 'utf-8');
            $.src = (window.location.protocol === 'https:' ? 'https:' : "http:") + options.Zopim.server + '?' + options.Zopim.id; z.t = +new Date; $.type = 'text/javascript';
            if (zopimScript_Loaded)
            {
                // most browsers
                if (ISQ.Http.browser.app !== "ie" || ISQ.Http.browser.isIE11)
                    $.onload = zopimScript_Loaded;
                else
                {
                    // ie
                    $.onreadystatechange = function ()
                    {
                        if (this.readyState !== 'complete' && this.readyState !== 'loaded') return;
                        zopimScript_Loaded();
                    }
                }
            }
            e.parentNode.insertBefore($, e);
        })(document, 'script');
        // end zopim script
    }
};

ISQ.Widget.Proxy.Chat.SnapEngage =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else // startChat
            SnapEngage.startLink();
    },
    load: function (options, widget)
    {
        var mthis = this;

        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;
        var SnapEngage_Loaded = function ()
        {
            if (typeof SnapEngage == "undefined") return;
            SnapEngage.hideButton();
            SnapEngage.getAgentStatusAsync(function (online)
            {
                if (online)
                    mthis.mAvailable = true;
                else
                    mthis.mAvailable = false;
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);

                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            });
            SnapEngage.setCallback('Close', function (type, status)
            {
                SnapEngage.hideButton();
            });
        }
        // if script already loaded on page...
        var x = document.head.getElementsByTagName('script');
        for (var i = 0; i < x.length; i++)
        {
            if (x[i].src.indexOf('snapengage') != -1)
            {
                SnapEngage_Loaded();
                return;
            }
        }
        var url = (window.location.protocol === 'https:' ? 'https:' : "http:") + options.SnapEngage.server + options.SnapEngage.id + ".js";
        ISQ.Tools.appendScript(url, SnapEngage_Loaded);
    }
};





ISQ.Widget.Proxy.Chat.Olark =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else // startChat
            olark('api.box.expand');

    },
    load: function (options, widget)
    {

        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage([widget], "type=available&data=" + this.mAvailable);
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;

        var mthis = this;
        var olark_Loaded = function ()
        {
            var updateAvailability = function (isOnline)
            {
                mthis.mAvailable = isOnline;
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);

                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            }

            olark.configure('box.start_hidden', true);
            //olark('api.box.hide');
            olark('api.chat.onOperatorsAvailable', function ()
            {
                updateAvailability(true);
            });
            olark('api.chat.onOperatorsAway', function ()
            {
                updateAvailability(false);
            });
        }
        // if script already loaded on page...
        var x = document.head.getElementsByTagName('script');
        for (var i = 0; i < x.length; i++)
        {
            if (x[i].src.indexOf('olark') != -1)
            {
                olark_Loaded();
                return;
            }
        }

        window.olark || (function (c)
        {
            var f = window, d = document, l = f.location.protocol == "https:" ? "https:" : "http:", z = c.name, r = "load"; var nt = function ()
            {
                f[z] = function ()
                {
                    (a.s = a.s || []).push(arguments)
                }; var a = f[z]._ = {
            }, q = c.methods.length; while (q--)
            {
                (function (n)
                {
                    f[z][n] = function ()
                    {
                        f[z]("call", n, arguments)
                    }
                })(c.methods[q])
            } a.l = c.loader; a.i = nt; a.p = {
                0: +new Date
            }; a.P = function (u)
            {
                a.p[u] = new Date - a.p[0]
            }; function s()
            {
                a.P(r); f[z](r)
            } f.addEventListener ? f.addEventListener(r, s, false) : f.attachEvent("on" + r, s); var ld = function ()
            {
                function p(hd)
                {
                    hd = "head"; return ["<", hd, "></", hd, "><", i, ' onl' + 'oad="var d=', g, ";d.getElementsByTagName('head')[0].", j, "(d.", h, "('script')).", k, "='", l, "//", a.l, "'", '"', "></", i, ">"].join("")
                } var i = "body", m = d[i]; if (!m)
                {
                    return setTimeout(ld, 100)
                } a.P(1); var j = "appendChild", h = "createElement", k = "src", n = d[h]("div"), v = n[j](d[h](z)), b = d[h]("iframe"), g = "document", e = "domain", o; n.style.display = "none"; m.insertBefore(n, m.firstChild).id = z; b.frameBorder = "0"; b.id = z + "-loader"; if (/MSIE[ ]+6/.test(navigator.userAgent))
                {
                    b.src = "javascript:false"
                } b.allowTransparency = "true"; v[j](b); try
                {
                    b.contentWindow[g].open()
                } catch (w)
                {
                    c[e] = d[e]; o = "javascript:var d=" + g + ".open();d.domain='" + d.domain + "';"; b[k] = o + "void(0);"
                } try
                {
                    var t = b.contentWindow[g]; t.write(p()); t.close()
                } catch (x)
                {
                    b[k] = o + 'd.write("' + p().replace(/"/g, String.fromCharCode(92) + '"') + '");d.close();'
                } a.P(2)
            }; ld()
        }; nt()
    })({
        loader: "static.olark.com/jsclient/loader0.js", name: "olark", methods: ["configure", "extend", "declare", "identify"]
    });

    olark.identify(options.Olark.id);
    olark_Loaded();

}
};

ISQ.Widget.Proxy.Chat.LiveEngage =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    log: function(entry) {
        _it(this.mPendingWidgets, function (widget) {
            if (widget.cdcUser)
                widget.cdcUser.sendMessage("subject=widgetLog&entry=" + entry);
        });
    },
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else
        {
            this.log('LivePerson LE2: opening chat window');
        
            if (window.lpTag.taglets.rendererStub.click(options.LiveEngage.engagementId)) { // startChat
                this.log('LivePerson LE2: chat window opened');

                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(this.mPendingWidgets, "type=vendorwindowopened");
            }
        }
    },
    load: function (options, widget)
    {
        var mthis = this;

        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;


        var LiveEngage_Loaded = function ()
        {
            mthis.log('LivePerson LE2: API Loaded');

            var updateAvailability = function (engagementId, isOnline)
            {
                mthis.log('LivePerson LE2: Availability (' + engagementId + ':' + isOnline + ')');

                mthis.mAvailable = isOnline;
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);

                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            }

            // poll for agent availability changes
            var engagementsMap = {};
            engagementsMap[options.LiveEngage.engagementId] = {};
            setInterval(function() {
                var engagement, activeEngagementState;
                for (var engagementId in engagementsMap) {
                    if (engagementsMap.hasOwnProperty(engagementId)) {
                        engagement = engagementsMap[engagementId];
                        activeEngagementState = window.lpTag.taglets.rendererStub.getEngagementState(engagementId).state;
                        if (engagement.state !== activeEngagementState) {
                            engagement.state = activeEngagementState;
                            updateAvailability(engagementId, engagement.state === 1)
                        }
                    }
                }
            }, 500);
        };

        // container is required by button and must be presented in page
        if (!document.getElementById('LivePersonChat')) {
            var container = document.createElement('div');
            container.id = 'LivePersonChat';
            container.style.display = 'none';
            document.body.appendChild(container);
        }

        mthis.log('LivePerson LE2: injecting API');

        // inject LiveEngage Embed code
        window.lpTag=window.lpTag||{};if(typeof window.lpTag._tagCount==='undefined'){window.lpTag={site:options.LiveEngage.id||'',section:lpTag.section||'',autoStart:lpTag.autoStart===false?false:true,ovr:lpTag.ovr||{},_v:'1.5.1',_tagCount:1,protocol:location.protocol,events:{bind:function(app,ev,fn){lpTag.defer(function(){lpTag.events.bind(app,ev,fn);},0);},trigger:function(app,ev,json){lpTag.defer(function(){lpTag.events.trigger(app,ev,json);},1);}},defer:function(fn,fnType){if(fnType==0){this._defB=this._defB||[];this._defB.push(fn);}else if(fnType==1){this._defT=this._defT||[];this._defT.push(fn);}else{this._defL=this._defL||[];this._defL.push(fn);}},load:function(src,chr,id){var t=this;setTimeout(function(){t._load(src,chr,id);},0);},_load:function(src,chr,id){var url=src;if(!src){url=this.protocol+'//'+((this.ovr&&this.ovr.domain)?this.ovr.domain:'lptag.liveperson.net')+'/tag/tag.js?site='+this.site;}var s=document.createElement('script');s.setAttribute('charset',chr?chr:'UTF-8');if(id){s.setAttribute('id',id);}s.setAttribute('src',url);document.getElementsByTagName('head').item(0).appendChild(s);},init:function(){this._timing=this._timing||{};this._timing.start=(new Date()).getTime();var that=this;if(window.attachEvent){window.attachEvent('onload',function(){that._domReady('domReady');});}else{window.addEventListener('DOMContentLoaded',function(){that._domReady('contReady');},false);window.addEventListener('load',function(){that._domReady('domReady');},false);}if(typeof(window._lptStop)=='undefined'){this.load();}},start:function(){this.autoStart=true;},_domReady:function(n){if(!this.isDom){this.isDom=true;this.events.trigger('LPT','DOM_READY',{t:n});}this._timing[n]=(new Date()).getTime();},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],ev:lpTag.ev||[]};lpTag.init();}else{window.lpTag._tagCount+=1;}

        // bind to events
        window.lpTag.events.bind('LE_ENGAGER',  'SHOW', function() {
            LiveEngage_Loaded();
        });
        window.lpTag.events.bind('lpUnifiedWindow', 'windowClosed', function() {
            mthis.log('LivePerson LE2: chat window closed');

            // sending message
            if (widget.cdcUser)
                ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=vendorwindowclosed");
        });
    }
};


ISQ.Widget.Proxy.Chat.SalesForce =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    log: function(entry) {
        _it(this.mPendingWidgets, function (widget) {
            if (widget.cdcUser)
                widget.cdcUser.sendMessage("subject=widgetLog&entry=" + entry);
        });
    },
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else
        {
            this.log('SalesForce: opening chat window');

            // support custom popup size
            if (options.popup && options.popup.size && options.popup.size.length === 2) {
                window.liveagent.setChatWindowWidth(+options.popup.size[0]);
                window.liveagent.setChatWindowHeight(+options.popup.size[1]);
            }

            window.liveagent.startChat(options.SalesForce.buttonId);
        }
    },
    load: function (options, widget)
    {
        var mthis = this;
        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;

        // NOTE:
        // according to the SalesForm API hostname is unique per organization
        // and another hostnames actually returns the same script
        // so we probably can keep using our hostname here
        var hostName = options.SalesForce.hostName || 'la1-c2-lon';
        var apiScriptURL = 'https://c.' + hostName + '.salesforceliveagent.com/content/g/js/36.0/deployment.js';

        // create LiveAgent events array if not created yet
        if (!window._laq) { window._laq = []; }
        window._laq.push(function() {
            window.liveagent.showWhenOnline(options.SalesForce.buttonId, document.createElement('div'));
            window.liveagent.showWhenOffline(options.SalesForce.buttonId, document.createElement('div'));
        });

        // API Loaded callback
        var SalesForce_Loaded = function ()
        {
            mthis.log('SalesForce: API Loaded');

            // uncomment the following line to enable logging in console (might be useful for development)
            // window.liveagent.enableLogging();

            // handle online/offline events
            window.liveagent.addButtonEventHandler(options.SalesForce.buttonId, function(eventType) {
                switch (eventType) {
                    case window.liveagent.BUTTON_EVENT.BUTTON_AVAILABLE:
                        updateAvailability(options.SalesForce.buttonId, true);
                        break;
                    case window.liveagent.BUTTON_EVENT.BUTTON_UNAVAILABLE:
                        updateAvailability(options.SalesForce.buttonId, false);
                        break;
                    case window.liveagent.BUTTON_EVENT.BUTTON_ACCEPTED:
                        mthis.log('SalesForce: chat window opened');
                        // sending message
                        // if (widget.cdcUser)
                        //     ISQ.Widget.Proxy.Chat.sendMessage(this.mPendingWidgets, "type=vendorwindowopened");
                        break;
                    case window.liveagent.BUTTON_EVENT.BUTTON_REJECTED:
                        mthis.log('SalesForce: chat window closed');
                        // sending message
                        // if (widget.cdcUser)
                        //     ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=vendorwindowclosed");
                        break;
                }
            });

            // script is loaded -> initialize liveagent provider
            window.liveagent.init('https://d.' + hostName + '.salesforceliveagent.com/chat',  options.SalesForce.deploymentId,  options.SalesForce.organizationId);

            var updateAvailability = function (buttonId, isOnline)
            {
                mthis.log('SalesForce: Availability (' + buttonId + ':' + isOnline + ')');

                mthis.mAvailable = isOnline;
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);

                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            }
        };

        // load API script dynamically
        mthis.log('SalesForce: injecting API');
        var se = document.createElement('script'); se.type = 'text/javascript'; se.async = true;
        se.src = apiScriptURL;
        var done = false;
        se.onload = se.onreadystatechange = function() {
            if (!done&&(!this.readyState||this.readyState === 'loaded'||this.readyState === 'complete')) {
                SalesForce_Loaded();
            }
        };
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(se, s);
    }
};

// #endregion ;

// doesn't work in firefox, limitation
ISQ.Widget.preventOuterScroll = function (widgetContainer)
{
    var preventOuterScroll = function (e)
    {
        if (!window.nanorepScrollLocked)
            return true;

        e.preventDefault();
        e.stopPropagation();
        return false;
    }
    var preventOuterScrollEnable = function ()
    {
        window.nanorepScrollLocked = true;
    }
    var preventOuterScrollDisable = function ()
    {
        window.nanorepScrollLocked = false;
    }
    window.nanorepScrollLocked = false;
    if (ISQ.Http.browser.app != "ff")
        window.addEvents(window, "onmousewheel", preventOuterScroll);

    window.addEvents(widgetContainer, "onmouseenter", preventOuterScrollEnable);
    window.addEvents(widgetContainer, "onmouseleave", preventOuterScrollDisable);

}

//float+embed
ISQ.Widget.appendConfigurationsToIframeSource = function (iframeSrc, widgetData)
{
    // account
    iframeSrc.push("#account=");
    iframeSrc.push(widgetData.account);

    // kb (the widget will use the domain related to this kb if no other domain was found)
    if (widgetData.kb)
    {
        iframeSrc.push("&kb=");
        iframeSrc.push(widgetData.kb);
    }
    // splitTestGroup - run widget even thou in split test
    if (widgetData.splitTestGroup)
    {
        iframeSrc.push("&splittestgroup=");
        iframeSrc.push(widgetData.splitTestGroup);
    }
    // preview
    if (widgetData.preview) iframeSrc.push("&preview=true");

    // doctype
    iframeSrc.push("&doctype=");
    iframeSrc.push(ISQ.Widget.doctype);

    // referer AS HASH
    iframeSrc.push("&refencoded=true&referer=");
    iframeSrc.push(ISQ.Http.Cookies.encode64(widgetData.referer));

    //
    // cdc frame
    if (!ISQ.Widget.supportsPostMessage && widgetData.cdcFrame)
    {
        iframeSrc.push("&cdcFrame=");
        iframeSrc.push(ISQ.Widget.getInnerFrameUrl(widgetData.cdcFrame, window.location.href));
        iframeSrc.push("&cdcversion=");
        iframeSrc.push(widgetData.cdcVersion);
    }
    if (ISQ.Widget.supportsPostMessage)
        iframeSrc.push("&cnf=true");

    // page id
    if (widgetData.pageId)
    {
        iframeSrc.push("&pageId=");
        iframeSrc.push(widgetData.pageId);
    }

    // search delay
    if (widgetData.searchDelay)
    {
        iframeSrc.push("&searchDelay=");
        iframeSrc.push(widgetData.searchDelay);
    }

    // search delay
    if (widgetData.naive)
    {
        iframeSrc.push("&naive=");
        iframeSrc.push(widgetData.naive);
    }


    // events
    iframeSrc.push("&reportEvents=true");
    // debug
    if (widgetData.debug) iframeSrc.push("&debug=isq");
    // custom values
    ISQ.Widget.appendCustomValuesToStringBuilder(iframeSrc, widgetData.customValues);
};

// float+embed
//// This function adds nRepData custom values to a stringBuilder (used for building widget src)
ISQ.Widget.appendCustomValuesToStringBuilder = function (stringBuilder, dataArray)
{
    if (!dataArray) return;
    var type;
    for (var key in dataArray)
    {
        type = typeof (dataArray[key]);

        // skipping objects and functions
        if (type === 'function' || type === 'object') continue;

        stringBuilder.push("&");
        stringBuilder.push(key);
        stringBuilder.push("=");
        if (type === 'string')
        {
            if (key === "onloadQuestionId" || key === "languageCode" || key == "configId")
                stringBuilder.push(dataArray[key]);
            else
                stringBuilder.push(ISQ.Http.Cookies.encode64(dataArray[key]));
        }
        else
        {
            stringBuilder.push(dataArray[key]);
        }
    }
};


//float+embed
//////////////////////////////////////////////////////////////////////////
// This method downloads cnf.js by embed/float to accelerate widget loading time.
ISQ.Widget.downloadAndSendCNF = function (widgetData)
{
    if (!ISQ.Widget.CNFStatus) ISQ.Widget.CNFStatus = [];
    var statusObject = ISQ.Widget.CNFStatus[widgetData.id] =
    {
        downloaded: false,
        waitingForDownload: false
    };

    // creating an event for loaded cnf
    if (!window._nRepData.eCNFLoaded) window._nRepData.eCNFLoaded = new ISQ.Event();

    // widgetData should use existing CNF object
    if (widgetData.useExistingCNF && ((widgetData.id === "float" && typeof (ISQ.Cnf_Float) === 'object') || (widgetData.id === "embed" && typeof (ISQ.Cnf_Embed) === 'object')))
    {
        // browser doesn't support post message, not sending CNF
        if (!ISQ.Widget.supportsPostMessage) return false;

        ISQ.Widget.cnfLoaded(widgetData);

        widgetData.useExistingCNF = false; // it's a one-time property. (when reloading embed, we might want it to download the CNF)
        statusObject.downloaded = true;

        return true;
    }

    // downloading CNF
    ISQ.Widget.downloadCnf(widgetData, function ()
    {
        // taking ref to cnf
        var cnf = null;
        if (widgetData.type === 'float') cnf = ISQ.Cnf_Float;
        else if (widgetData.type === 'embed') cnf = ISQ.Cnf_Embed;
        
        // in control group
        if (cnf.controlGroup)
        {
            ISQ.Widget.handleEventMessage({ "type": "notLoad", "reason": "conversion control group" }, widgetData);
            return;
        }

        // updating dynamic host
        widgetData.dynamicHost = "//" + cnf.serverUrl;

        // calllback
        ISQ.Widget.cnfLoaded(widgetData);

        // browser doesn't support post message, not sending CNF
        if (!ISQ.Widget.supportsPostMessage) return;

        statusObject.downloaded = true;
        if (!statusObject.waitingForDownload) return;
        if (widgetData.type === 'float')
            ISQ.Widget.sendCNFData(ISQ.Cnf_Float, widgetData);
        else
            ISQ.Widget.sendCNFData(ISQ.Cnf_Embed, widgetData);
    });

    return ISQ.Widget.supportsPostMessage;
};
//float+embed
ISQ.Widget.cnfLoaded = function (widgetData)
{
    var cnf = null;
    if (widgetData.type === 'float')
        cnf = ISQ.Cnf_Float;
    else
        cnf = ISQ.Cnf_Embed;
    if (!cnf) return;

    ////////////////////////////////////////////
    // chat monitor tag
    var chatConfig = eval("(" + cnf.chatConfiguration + ")");
    if (chatConfig.active === "LP")
    {
        // if monitor tag has started, updating cnf
        if (typeof (lpMTagConfig) != 'undefined' && typeof (lpMTagConfig.LPSID_VAR) != 'undefined')
        {
            chatConfig.LP.visitorId = lpMTagConfig.LPSID_VAR;
            cnf.chatConfiguration = ISQ.Data.jsonToString(chatConfig);
        }
        else // waiting for it
        {
            var lptagInterval = setInterval(function ()
            {
                if (typeof (lpMTagConfig) != 'undefined' && typeof (lpMTagConfig.LPSID_VAR) != 'undefined')
                {
                    stringBuilder = [];
                    stringBuilder.push("subject=visitorId&data=");
                    stringBuilder.push(lpMTagConfig.LPSID_VAR);
                    widgetData.cdcUser.sendMessage(stringBuilder.join(''));

                    clearInterval(lptagInterval);
                }
            }, 500);
        }
    }


    // can resumeChat
    //cnf.canResumeChat = !_nRepData.canResumeChat;
    //if (!_nRepData.canResumeChat) _nRepData.canResumeChat = true;

    ///////////////////////////////////////////
    // firing events/handlers
    window._nRepData.eCNFLoaded.dispatch(widgetData.id);
    if (widgetData.eCnfLoaded) widgetData.eCnfLoaded();
}
//float+embed
ISQ.Widget.downloadCnf = function (widgetData, callback)
{
    //////////////////////////////////////////////////////////////////////////
    // downloading cnf.js

    // referer
    var referer = null;
    if (widgetData.preview) referer = escape(widgetData.referer);
    else if (widgetData.customValues && widgetData.customValues.configId)
        referer = "!" + widgetData.customValues.configId;

    // building script
    var head = document.getElementsByTagName("head")[0];
    var elm = createElement("script");
    elm.setAttribute("type", "text/javascript");
    elm.setAttribute("src", ISQ.Widget.buildCNFSource(widgetData.dynamicHost
        , widgetData.account
        , widgetData.type === 'float'
        , widgetData.kb
        , referer
        , widgetData.preview, widgetData.splitTestGroup));
    elm.async = true;
    elm.defer = true;

    // callback
    var innerCallback = function ()
    {
        // referer.js went to action
        if (ISQ.Referer.handlerObjects[elm.src].pendingLoad === true) return;
        callback();
    };

    ISQ.Referer = initializeNS("ISQ.Referer");
    ISQ.Referer.handlerObjects = ISQ.Referer.handlerObjects || [];
    ISQ.Referer.handlerObjects[elm.src] = { callback: callback }; // in-case referer.js will get in action
    if (ISQ.Http.browser.app !== "ie" || ISQ.Http.browser.isIE11)
    {
        elm.onload = innerCallback;
    }
    // ie
    else
    {
        elm.onreadystatechange = function ()
        {
            if (this.readyState !== 'complete' && this.readyState !== 'loaded') return;
            innerCallback();
            // IE9 fires 'complete' twice
            innerCallback = null;
        }
    }

    // appending script
    head.appendChild(elm);

    return true;
};

//float+embed
//////////////////////////////////////////////////////////////////////////
// this method sends cnf data to widget
ISQ.Widget.sendCNFData = function (cnfObject, widgetData)
{
    var cnfStatusObject = ISQ.Widget.CNFStatus[widgetData.id];
    cnfStatusObject.waitingForDownload = true;
    if (!cnfStatusObject.downloaded) return;

    //////////////////////////////////////////////////////////////////////////
    // adding scripts from CNF
    if (typeof (cnfObject['chatProviders']) != 'undefined') eval(cnfObject['chatProviders']);

    //////////////////////////////////////////////////////////////////////////
    var amount = 1800;
    var internalSend = function (substring_, finished)
    {
        stringBuilder = [];
        stringBuilder.push("subject=cnf&data=");
        stringBuilder.push(substring_);
        if (finished)
            stringBuilder.push("&finished=true");
        widgetData.cdcUser.sendMessage(stringBuilder.join(''));

    }

    var str = ISQ.Data.jsonToString(cnfObject);
    str = ISQ.Http.Cookies.encode64(str);
    var ndxStart = 0;
    if (amount < str.length)
    {
        while (ndxStart < str.length)
        {
            if (ndxStart + amount > str.length)
                amount = str.length - ndxStart;
            internalSend(str.substr(ndxStart, amount));
            ndxStart += amount;
        }
        internalSend("", true);
    }
    else
    {
        internalSend(str, true);
    }

    if (widgetData.eAfterCnfSent) widgetData.eAfterCnfSent();
};

//float+embed
ISQ.Widget.sendingMessagesToWidget = function (widgetData)
{
    return ISQ.Widget.supportsPostMessage // browser supports cdc messages
        || widgetData.formValues instanceof Array // we have form values to send
        || typeof (widgetData.context) === 'object' // we have contexts to send
        || typeof (widgetData.customParams) === 'object'; // we have custom params
};
//float+embed
ISQ.Widget.initCDC = function (widgetData, handlerFunc)
{
    // using 'postMessage' ability in browsers which support this ability
    if (ISQ.Widget.supportsPostMessage)
        widgetData.cdcVersion = 3;
    else if (!widgetData.cdcVersion) // default cdc version
        widgetData.cdcVersion = 0;

    var sendingMessages = ISQ.Widget.sendingMessagesToWidget(widgetData);

    widgetData.cdcUser = null;
    switch (widgetData.cdcVersion)
    {
        // IE6, 7 (or any browser which doesn't support 'postMessage')       
        case 0: // version 0 is available only for sending messages to widget (i.e. static embed)
        case 1: // old version of float
        case 2: // old version of float or dynamic embed

            if (widgetData.cdcVersion !== 0) // registering cdc message event (version 1,2)
                ISQ.Widget.cdcMessageEvent.addHandler(handlerFunc, widgetData);

            // creating cdc user FOR SENDING messages ONLY
            if (sendingMessages)
            {
                widgetData.cdcUser = new ISQ.CDC.User(
                {
                    targetWindowName: widgetData.iframe.id,
                    proxyIFrameUrl: widgetData.staticHost + "/common/cdc/cdc.html",
                    server: widgetData.staticHost
                });
            }
            break;
        case 3: // ALL Browsers which support postMessage + ie6,7 with version3 cdcFrame
            // creating a cdc for sending and receiving messages
            var ctorObject =
            {
                allowMessagesFrom: widgetData.staticHost,
                widget: widgetData.type
            };
            // there are contact form values to be sent. (or cnf.js)
            if (sendingMessages)
            {
                ctorObject.server = widgetData.staticHost;
                ctorObject.targetWindowName = widgetData.iframe.id;
                ctorObject.proxyIFrameUrl = widgetData.staticHost + "/common/cdc/cdc.html";
            }
            // creating cdc-user instance
            widgetData.cdcUser = new ISQ.CDC.User(ctorObject);
            widgetData.cdcUser.incomingMessageEvent.addHandler(handlerFunc, widgetData);
            break;
    }
};

ISQ.Widget.APIKeyEndDelimiter = "<";
ISQ.Widget.APIValueEndDelimiter = "(";

ISQ.Widget.sendAPItoWidget = function (widgetData)
{
    var sendingMessages = ISQ.Widget.sendingMessagesToWidget(widgetData);

    if (!widgetData.cdcUser || !sendingMessages) return;
    var stringBuilder = [];
    stringBuilder.push("subject=api");

    //////////////////////////////////////////////////////////////////////////
    // sending form values
    var formValues = widgetData.formValues;
    if ((formValues instanceof Array) && formValues.length !== 0)
    {
        stringBuilder.push("&form=");
        var name, value, type;
        for (var i = 0; i < formValues.length; ++i)
        {
            var formValue = formValues[i];
            if (!(formValue instanceof Array) || formValue.length < 2) continue;

            if (formValue.length === 2)
            {
                name = formValue[0];
                value = formValue[1];
                type = null;
            }
            else
            {
                name = formValue[1];
                type = formValue[0];
                value = formValue[2];
            }

            // adding value to request
            if (i !== 0) stringBuilder.push(ISQ.Widget.APIKeyEndDelimiter);
            stringBuilder.push(ISQ.Http.Cookies.encode64(name));
            stringBuilder.push(ISQ.Widget.APIValueEndDelimiter);
            stringBuilder.push(ISQ.Http.Cookies.encode64(value));
            if (type)
            {
                stringBuilder.push(ISQ.Widget.APIValueEndDelimiter);
                stringBuilder.push(ISQ.Http.Cookies.encode64(type));
            }
        }
    }
    //////////////////////////////////////////////////////////////////////////
    // sending contexts
    var contexts = widgetData.context;
    if (typeof (contexts) === 'object')
    {
        stringBuilder.push("&context=");
        ISQ.Widget.CDC_appendKeyValueToMessage(contexts, stringBuilder);
    }
    //////////////////////////////////////////////////////////////////////////
    // custom params
    var custParams = widgetData.customParams;
    if (typeof (custParams) === 'object')
    {
        stringBuilder.push("&customparams=");
        ISQ.Widget.CDC_appendKeyValueToMessage(custParams, stringBuilder);
    }
    widgetData.cdcUser.sendMessage(stringBuilder.join(''));
};


//float+embed
//// This function works around widget's 'steal focus' behaviour
ISQ.Widget.fixStealFocus = function (widgetData)
{
    if (!widgetData.iframe) return;
    var focusInput = widgetData.setFocus;
    if (!focusInput) return;
    focusInput = ISQ.Html._(focusInput);
    if (!focusInput) return;

    var focusFunc = function ()
    {
        try
        {
            focusInput.focus();
        }
        catch (e) { }
    };

    if (window.attachEvent)
        widgetData.iframe.attachEvent('onload', focusFunc);
    else if (window.addEventListener)
        widgetData.iframe.addEventListener('load', focusFunc, true);
};
// float+embed
ISQ.Widget.resizeIframeOnLoad_IE = function (widgetData, width, height, onloadMethod)
{
    if (ISQ.Http.browser.app !== 'ie' || ISQ.Http.browser.isIE11) return false;

    // If IE and window wasn't loaded yet
    // in IE6,7: waiting for window.onload event to send the set size message
    if (ISQ.Http.browser.isIE6 || ISQ.Http.browser.isIE7)
    {
        if (document.readyState === 'complete') return false; // page was loaded, nothing to do
        if (!widgetData.registeredOnload)
        {
            widgetData.registeredOnload = true;
            window.attachEvent('onload', function ()
            {
                onloadMethod(widgetData, parseInt(width), parseInt(height) + 1);
            });
        }
        return true;
    }
    // In ie8+: sending a message via postMessage to notify about the size.
    // (if document wasn't loaded OR embed/float in iframe)
    else if (document.readyState !== 'complete' || window != window.top)
    {
        onloadMethod(widgetData, parseInt(width), parseInt(height) + 1);
        widgetData.cdcUser.sendMessage("subject=refreshSize");
        return true;
    }
    else // no thing to do
        return false;
};


// float only
//// SUPPORTS CDC VERSION 2 (and v1 - but its deprecated)
//// This function receives a message from cdc frame
//// and fires its event
ISQ.Widget.incomingCDCMessageOrginizer = null;
ISQ.Widget.incomingCDCMessage = function (message)
{
    // removing '?' from start
    if (message.charAt(0) === "?") message = message.substr(1);

    // getting message parts
    var messageArgs = ISQ.Tools.stringToPairArray(message, "=", "&", true, false);

    ////////////////////////////////////////////////////////
    // dispatching and sending messages in order
    if (!ISQ.Widget.incomingCDCMessageOrginizer) ISQ.Widget.incomingCDCMessageOrginizer = [];
    var currentWidgetOrginizer = ISQ.Widget.incomingCDCMessageOrginizer[messageArgs["widget"]];
    if (!currentWidgetOrginizer)
    {
        currentWidgetOrginizer = ISQ.Widget.incomingCDCMessageOrginizer[messageArgs["widget"]] = {};
        currentWidgetOrginizer.lastHandledOrdinal = 0;
        currentWidgetOrginizer.pendingMessages = null;
    }

    if (messageArgs["subject"] && messageArgs["subject"] == "reset")
    {
        currentWidgetOrginizer.lastHandledOrdinal = 0;
        currentWidgetOrginizer.pendingMessages = null;
    }
    var ord = parseInt(messageArgs["ord"]);
    //window.top.document.getElementById('log').innerHTML += "incoming message with ord: " + ord + "<br/>";
    var diff = ord - currentWidgetOrginizer.lastHandledOrdinal;
    if (diff <= 0) return; // not handling the same ordinal message
    if (diff > 1)  // incoming message is skipping a previous one
    {
        //debug
        //window.top.document.getElementById('log').innerHTML += "cdc-user message delayed: " + messageArgs["subject"] + ". ordinal diff: " + diff + "<br/>";
        if (currentWidgetOrginizer.pendingMessages === null)
        {
            currentWidgetOrginizer.pendingMessages = [];
            currentWidgetOrginizer.pendingMessagesCount = 0;
        }
        currentWidgetOrginizer.pendingMessages[ord] = messageArgs;
        ++currentWidgetOrginizer.pendingMessagesCount;
    }
    else
    {
        try
        {
            //debug
            //window.top.document.getElementById('log').innerHTML += "valid message: " + messageArgs["subject"] + ". ordinal: " + ord + "<br/>";
            ISQ.Widget.cdcMessageEvent.dispatch(messageArgs);
        }
        catch (e) { }

        if (currentWidgetOrginizer.pendingMessages !== null)
        {
            var numberOfMessages = currentWidgetOrginizer.pendingMessagesCount;
            var ndx = ord + 1;
            for (var i = 0; i < numberOfMessages; ++i, ++ndx)
            {
                if (!currentWidgetOrginizer.pendingMessages[ndx]) break;
                //debug
                //window.top.document.getElementById('log').innerHTML += "cdc-user. released message " + (ndx) + ". " + this.mWidget + "<br/>";
                ISQ.Widget.cdcMessageEvent.dispatch(currentWidgetOrginizer.pendingMessages[ndx]);
                ord = ndx; // setting last handled message
                --currentWidgetOrginizer.pendingMessagesCount;
            }
            if (currentWidgetOrginizer.pendingMessagesCount === 0) currentWidgetOrginizer.pendingMessages = null;

            //debug
            //window.top.document.getElementById('log').innerHTML += "cdc-user released delayed messages. " + this.mWidget + " last handled ord: " + ord + "<br/>";
        }

        currentWidgetOrginizer.lastHandledOrdinal = ord; // setting last handled message
    }
};

//float+embed
// creating cdc message event
if (!ISQ.Widget.cdcMessageEvent) ISQ.Widget.cdcMessageEvent = new ISQ.Event();
if (!ISQ.Widget.incomingCustomCDCMessage) ISQ.Widget.incomingCustomCDCMessage = new ISQ.Event();

//float+embed
ISQ.Widget.handleCommonCDCMessage = function (messageArgs, widgetData)
{
    switch (messageArgs["subject"])
    {
        case "cnf":
            if (widgetData.id === 'float')
                ISQ.Widget.sendCNFData(ISQ.Cnf_Float, widgetData);
            else
                ISQ.Widget.sendCNFData(ISQ.Cnf_Embed, widgetData);
            break;
        case "event":
            ISQ.Widget.handleEventMessage(messageArgs, widgetData);
            break;
        case "pagescript":
            ISQ.API.runPageScript(messageArgs["data"], true);
            break;
        case "chatResumeRequest":
            // if we have two or more widgets on page
            // resume chat only in one widget
            if (_nRepData.chatInResume)
            {
                ISQ.Widget.preventChatResuming(widgetData);
                break;
            }
            if (!_nRepData.chatInResume)
                _nRepData.chatInResume = true;
            ISQ.Widget.aboutToResumeChat(widgetData);
            break;
        case "chatEnded":
            // setting chat in resume to false on chat ending
            _nRepData.chatInResume = false;
            break;
        case "loadChat":
        case "startCustomChat":
            var loadCustomChat = function ()
            {
                var config = eval('(' + messageArgs["config"] + ')');
                switch (config.active)
                {
                    case "LiveChatInc":
                        ISQ.Widget.Proxy.Chat.LiveChatInc.start(messageArgs["subject"], config, widgetData);
                        break;
                    case "Zopim":
                        ISQ.Widget.Proxy.Chat.Zopim.start(messageArgs["subject"], config, widgetData);
                        break;
                    case "Olark":
                        ISQ.Widget.Proxy.Chat.Olark.start(messageArgs["subject"], config, widgetData);
                        break;
                    case "SalesForce":
                        ISQ.Widget.Proxy.Chat.SalesForce.start(messageArgs["subject"], config, widgetData);
                        break;
                    case "SnapEngage":
                        ISQ.Widget.Proxy.Chat.SnapEngage.start(messageArgs["subject"], config, widgetData);
                        break;
                    case "LiveEngage":
                        ISQ.Widget.Proxy.Chat.LiveEngage.start(messageArgs["subject"], config, widgetData);
                        break;
                }
            }
            if (!isNSexists("ISQ.Widget.Proxy.Chat"))
                ISQ.Tools.appendScript("/widget/scripts/chatProviders.js", new ISQ.Handler(loadCustomChat));
            else
                loadCustomChat();
            break;
        case "hideWidget":
            (_nRepData["float"] || _nRepData["embed"]).container.style.display = 'none';
            break;
        case "showWidget":
            (_nRepData["float"] || _nRepData["embed"]).container.style.display = 'block';
            break;
        default:
            ISQ.Widget.incomingCustomCDCMessage.dispatch(messageArgs, widgetData);
            break;
    }
};
//float+embed
ISQ.Widget.aboutToResumeChat = function (widgetData)
{
    widgetData.cdcUser.sendMessage("subject=chatResumeApproved");
};
//float+embed
ISQ.Widget.preventChatResuming = function (widgetData)
{
    widgetData.cdcUser.sendMessage("subject=preventChatResuming");
};


// float+embed
ISQ.Widget.createMobileBlockerLink = function (widgetData, container, widthString, heightString)
{
    if (!ISQ.Http.browser.isMobile) return;

    //////////////////////////////////////////////////////////////////////////
    // creating and adding link
    var a = widgetData.mobileBlockerLink = document.createElement("a");
    a.className = "nR_noRemove";
    a.style.cssText = "display:block;width: " + widthString + ";height:" + widgetData.height + "px;position:relative;left:0px;top:-" + widgetData.height + "px;z-index:1001;background:transparent;";
    container.appendChild(a);

    // setting href
    a.href = widgetData.iframe.src;
    a.target = "_blank";

    a.onclick = function (_event)
    {
        // if there's a back-image, hiding the link to understand if the user clicked on the back-image
        if (widgetData.backImgDiv && ISQ.Cnf_Float.floatBackImageAsk)
        {
            this.style.display = 'none';
            var elm = document.elementFromPoint(_event.clientX, _event.clientY);
            while (elm != null && elm !== widgetData.backImgDiv && elm !== document.body)
                elm = elm.parentNode;
            this.style.display = 'block';

            // the click was ON the back-image and we have an onload question
            if (elm == widgetData.backImgDiv && ISQ.Cnf_Float.floatBackImageAsk && ISQ.Cnf_Float.floatBackImageAsk > 0)
            {
                var href = this.href;
                if (!this.hrefLength) this.hrefLength = href.length;
                if (href.contains("#"))
                    href += "&onloadquestionid=" + ISQ.Cnf_Float.floatBackImageAsk;
                else
                    href += "#onloadquestionid=" + ISQ.Cnf_Float.floatBackImageAsk;
                this.href = href;
            }
            else
            {
                if (this.hrefLength && this.href.length != this.hrefLength)
                    this.href = this.href.substring(0, this.hrefLength);
            }
        }

        widgetData.cdcUser.sendMessage("subject=mobileOpenNewWindow");
    }

    //////////////////////////////////////////////////////////////////////////
    // OZEN
    var oz = _("ozen");
    if (widgetData.id === 'float' && oz && oz.nodeName === "A")
    {
        // setting href
        oz.href = widgetData.iframe.src;
        oz.target = "_blank";

        oz.onclick = function (_event)
        {
            // if there's a back-image, hiding the link to understand if the user clicked on the back-image
            if (widgetData.backImgDiv && ISQ.Cnf_Float.floatBackImageAsk)
            {
                this.style.display = 'none';
                var elm = document.elementFromPoint(_event.clientX, _event.clientY);
                while (elm != null && elm !== widgetData.backImgDiv && elm !== document.body)
                    elm = elm.parentNode;
                this.style.display = 'block';

                // the click was ON the back-image and we have an onload question
                if (elm == widgetData.backImgDiv && ISQ.Cnf_Float.floatBackImageAsk && ISQ.Cnf_Float.floatBackImageAsk > 0)
                {
                    var href = this.href;
                    if (!this.hrefLength) this.hrefLength = href.length;
                    if (href.contains("#"))
                        href += "&onloadquestionid=" + ISQ.Cnf_Float.floatBackImageAsk;
                    else
                        href += "#onloadquestionid=" + ISQ.Cnf_Float.floatBackImageAsk;
                    this.href = href;
                }
                else
                {
                    if (this.hrefLength && this.href.length != this.hrefLength)
                        this.href = this.href.substring(0, this.hrefLength);
                }
            }

            widgetData.cdcUser.sendMessage("subject=mobileOpenNewWindow");
        }
    }
};


//#region Mobiles: resize widgets on zoom (#7722, #8515)

//float+embed
ISQ.Widget.Mobile = {};
ISQ.Widget.Mobile.resizeStart = function ()
{
    if (!ISQ.Http.browser.isMobile || ISQ.Http.browser.oldAndroid) return;
    if (!ISQ.Widget.Mobile.resizeInterval)
        ISQ.Widget.Mobile.resizeInterval = setInterval(ISQ.Widget.Mobile.resizeTimerElapsed, 200);

    window.addEventListener("orientationchange", ISQ.Widget.Mobile.orientationChanged);
}
// not in use?
ISQ.Widget.Mobile.resizeStop = function ()
{
    if (ISQ.Widget.Mobile.resizeInterval)
        clearInterval(ISQ.Widget.Mobile.resizeInterval);
    ISQ.Widget.Mobile.resizeInterval = null;

    window.removeEventListener("orientationchange", ISQ.Widget.Mobile.orientationChanged);
}
//float+embed
ISQ.Widget.Mobile.resizeTimerElapsed = function ()
{
	if (!ISQ.Cnf_Float) {
		return;
	}

    // create sizer div that will tell us the viewport dimensions
    var sizerDiv = ISQ.Widget.Mobile.sizerDiv;
    if (!sizerDiv)
    {
        sizerDiv = createDiv(document.body);
        sizerDiv.style.cssText = 'width:0; height:0; position:fixed; bottom:0;right:0;';
        ISQ.Widget.Mobile.sizerDiv = sizerDiv;
    }

    // fire event if width is different than the last time or if calling function requested
    if (sizerDiv.offsetLeft != ISQ.Widget.Mobile.oldViewportWidth || ISQ.Widget.Mobile.forceNextAction)
    {
        if (ISQ.Cnf_Embed)  {
			ISQ.Widget.Mobile.forceNextAction = ISQ.Embed.Mobile.resizeAction(sizerDiv.offsetLeft, sizerDiv.offsetTop);
		}
		
        ISQ.Widget.Mobile.oldViewportWidth = sizerDiv.offsetLeft;

        // resize teaser
        var cnf = ISQ.Cnf_Float || ISQ.Cnf_Embed;
		if (!cnf.mobileWidgetEnabled) return;
        if (ISQ.Cnf_Float && ISQ.Cnf_Float.mobileResponsive) return;
		if (ISQ.Cnf_Embed && ISQ.Cnf_Embed.mobileResponsive && ISQ.Embed.Mobile.isMobileOptimized() ) return;

        ISQ.Widget.Mobile.forceNextAction |= ISQ.Widget.Mobile.resizeAction(sizerDiv.offsetLeft, sizerDiv.offsetTop);
    }
}
//float+embed
ISQ.Widget.Mobile.orientationChanged = function ()
{
    ISQ.Widget.Mobile.oldViewportWidth = null;
}
//float+embed
/* mobile teaser */
// resize the teaser when the viewport is resized
ISQ.Widget.Mobile.resizeAction = function (viewportWidth, viewportHeight)
{
    if (_nRepData["float"] && !_nRepData["float"].widgetLoaded) return true; // wait till float is loaded, #9128
    if (!ISQ.Widget.Mobile.teaser)
    {
        // build teaser element 
        if( ISQ.Widget.Mobile.buildTeaserElement(viewportWidth, viewportHeight) )
		{
			// resize teaser
			ISQ.Widget.Mobile.teaser.scale(viewportWidth, viewportHeight);
		}
		return false;
    }

    // hide the teaser for some time until resizing is finished (to prevent flickering while resizing)
    if (ISQ.Widget.Mobile.timer) clearTimeout(ISQ.Widget.Mobile.timer);
    ISQ.Widget.Mobile.teaser.style.display = 'none';
    ISQ.Widget.Mobile.timer = setTimeout(function () { ISQ.Widget.Mobile.teaser.scale(viewportWidth, viewportHeight); }, 200);
    return false;
}
//float+embed
ISQ.Widget.Mobile.buildTeaserElement = function (viewportWidth, viewportHeight)
{
	if( ISQ.Widget.isMobileWidget) return;

    // take available configuration
    var widgetData = _nRepData['float'] || _nRepData['embed'];
    var cnf = ISQ.Cnf_Float || ISQ.Cnf_Embed;

    var dockRight = _nRepData['float'] && _nRepData['float'].dockMethod == nanoRep.Float.enumDockMethod.RIGHT;

    // build teaser
    var teaser = ISQ.Widget.Mobile.teaser = createDiv(document.body);
    teaser.style.cssText = 'visibility:hidden; text-align:center; width:100%; bottom:0; z-index:1000; font-family:Arial;';
    teaser.style.color = cnf.titleColor || '#FFF';
    teaser.style.backgroundColor = cnf.titleBGColor || '#009FD4';
    teaser.style.position = 'fixed';
    if (ISQ.Tools.isLanguageRTL(cnf.kbLanguageCode)) teaser.style.direction = 'rtl';

    // set height and font size
    teaser.heightRatio_portrait = 1 / 18;
    teaser.heightRatio_landscape = 1 / 9;
    teaser.fontRatio = 0.8;

    var heightRatio = viewportHeight > viewportWidth ? teaser.heightRatio_portrait : teaser.heightRatio_landscape;
    var height = viewportHeight * heightRatio;
    var fontSize = Math.floor(height * teaser.fontRatio) + 'px';
    teaser.style.height = Math.ceil(height) + 'px';
    teaser.style.lineHeight = Math.ceil(height) + 'px';
    teaser.style.fontSize = fontSize;
    teaser.style.bottom = -1 * Math.ceil(height / 3) + 'px';

    // set text
    var sp = createElement('span', teaser);
    sp.style.cssText = 'text-overflow:nowrap; font-size: inherit; color: inherit;';
    sp.innerHTML = cnf.titleTeaserText;
    teaser.textSpan = sp;
    teaser.onclick = function () { ISQ.Widget.Mobile.openWidgetInNewWindow(widgetData); };

    // calculate teaser height:width ratio according to the text  
    teaser.widthRatio = height / (sp.offsetWidth * 1.15);

    // set scaling ratios    
    teaser.leftRatio = 1 / 5;
    teaser.paddingRatio = 1 / 9;
    teaser.borderRatio = 1 / 5;

    // scaling function
    teaser.scale = function (viewportWidth, viewportHeight)
    {
        // width and height
        var heightRatio = viewportHeight > viewportWidth ? this.heightRatio_portrait : this.heightRatio_landscape;
        var height = viewportHeight * heightRatio;
        var width = height / this.widthRatio;
        this.style.width = Math.ceil(width) + 'px';
        this.style.height = this.style.lineHeight = Math.ceil(height) + 'px';

        // side margin and letter spacing
        var sideMargin = Math.ceil(height * this.leftRatio) + 'px';
        if (!dockRight) this.style.left = sideMargin; else this.style.right = sideMargin;
        this.style.letterSpacing = width > 350 ? '-2px' : width > 150 ? '-1px' : '';

        // font, padding, border
        this.style.fontSize = Math.floor(height * this.fontRatio) + 'px';
        var borderRadius = Math.ceil(height * this.borderRatio);
        this.style.borderRadius = borderRadius + 'px ' + borderRadius + 'px 0 0';
        this.style.visibility = 'visible';
        this.style.display = 'block';
    }

    // start animation
    nanoRep.Widget.PositionAnimator.setBottom(teaser, 0);
    nanoRep.Widget.PositionAnimator.start();

    return teaser;
};
//float+embed
ISQ.Widget.Mobile.openWidgetInNewWindow = function (widgetData)
{
    widgetData.cdcUser.sendMessage("subject=mobileOpenNewWindow");
    window.open(widgetData.iframe.src);
};
//float+embed
ISQ.Widget.Mobile.forceNextAction = false;


ISQ.Widget.applyContextFromCookie = function (widgetData)
{
    var contextFromCookie = ISQ.Http.Cookies._read("nrContext");
    if (!contextFromCookie) return;
    var ctxSplit = contextFromCookie.split(",");

    if (!widgetData.context) widgetData.context = {};
    for (var i = 0; i < ctxSplit.length; i += 2)
    {
        // ignoring this category if exists in context script
        if (widgetData.context[ctxSplit[i]]) continue;

        // applying context from cookie to widgetData
        widgetData.context[ctxSplit[i]] = ctxSplit[i + 1];
    }
}

ISQ.Widget.applyContextToCookie = function (context)
{
    var cookieContext = [];
    for (key in context)
    {
        cookieContext.push(key);
        cookieContext.push(",");
        cookieContext.push(context[key]);
        cookieContext.push(",");
    }
    cookieContext.splice(cookieContext.length - 1, 1);
    var cookieString = cookieContext.join("");
    ISQ.Http.Cookies._write("nrContext", cookieString, "/", ISQ.Http.domain(), false, (24 * 60 * 60 * 30), true);
}


//#endregion


//float+embed
//#region API
ISQ.API.init = function (widgetData)
{
    ISQ.API.defaultWidgetData = widgetData;
};
ISQ.API.getWidgetData = function (id)
{
    var widgetData = null;
    if (id) widgetData = _nRepData[id];
    return widgetData || ISQ.API.defaultWidgetData;
};
// open the contact form
ISQ.API.openContactForm = function (id)
{
    var widgetData = ISQ.API.getWidgetData(id);
    if (!widgetData || !widgetData.cdcUser) return;

    if (widgetData.id == 'float')
    {
        if (ISQ.Http.browser.isMobile) return;
        // expanding float
        //nanoRep.Float.changeState(nanoRep.Float.enumStates.expand);
    }
    else
    {
        if (ISQ.Http.browser.oldAndroid) return;
    }

    widgetData.cdcUser.sendMessage('subject=openContactForm');
};
// start the chat - optionally count stats only
ISQ.API.startChat = function (countStatsOnly, id)
{
    var widgetData = ISQ.API.getWidgetData(id);
    if (!widgetData || !widgetData.cdcUser) return;

    if (widgetData.id == 'float')
    {
        if (ISQ.Http.browser.isMobile) return;

        // expanding float
        nanoRep.Float.changeState(nanoRep.Float.enumStates.expand);
    }
    else
    {
        if (ISQ.Http.browser.oldAndroid) return;
    }

    if (widgetData.autoMinimizeTimer)
        clearTimeout(widgetData.autoMinimizeTimer);

    var msg = 'subject=startChat';
    if (countStatsOnly) msg += '&countStatsOnly=true';

    widgetData.cdcUser.sendMessage(msg);
};

// customize widget
ISQ.API.customizeWidget = function (data, id)
{
    if (typeof (data) != "object") return;

    var widgetData = ISQ.API.getWidgetData(id);
    if (!widgetData || !widgetData.cdcUser) return;

    var message = "subject=customize";
    if (data.bgcolor)
        message += "&bgcolor=" + data.bgcolor;
    if (data.title)
        message += "&title=" + data.title;

    widgetData.cdcUser.sendMessage(message);
}

// asking a question in the widget
ISQ.API.ask = function (question, id)
{
    if (!question) question = '';
    var widgetData = ISQ.API.getWidgetData(id);
    if (!widgetData || !widgetData.cdcUser) return;
    widgetData.cdcUser.sendMessage('subject=ask&question=' + question);
};

// asking a question in the widget by id
ISQ.API.askById = function (questionId, id, sender)
{
    if (!questionId) return;
    var widgetData = ISQ.API.getWidgetData(id);
    if (!widgetData || !widgetData.cdcUser) return;
    var msg = 'subject=askById&questionid=' + questionId;
    if (sender) msg += "&sender=" + sender;
    widgetData.cdcUser.sendMessage(msg);

    // expanding widget only if 
    //    if (widgetData.id == 'float' && _nRepData["float"].state.id < nanoRep.Float.enumStates.expand) // expanding float
    //        nanoRep.Float.changeState(nanoRep.Float.enumStates.expand);
};

ISQ.API.importCustomParams = function (obj)
{
    /* 
    obj.table: invokes importCustomParamsFromTable(..)
    obj.customParams: custom params to import
    obj.widget: '', // to which widget to set the customParams ('float', 'embed', ''). Empty is both widgets. default: EMPTY
    */
    if (obj.table)
    {
        obj.customParams = ISQ.API.getCustomParamsFromTable(obj);
    }
    else if (obj.ul)
    {
        obj.customParams = ISQ.API.getCustomParamsFromUl(obj);
    }

    // custom params to import
    if (!obj.customParams) return;

    // merge function
    var mergeFunc = function (type)
    {
        var array = type ? window._nRepData[type] : _nRepData;
        if (!array) return; // widget isn't present yet

        if (!array["customParams"])
            array["customParams"] = obj.customParams;
        else
        {
            for (var i in obj.customParams)
            {
                if (array["customParams"][i]) continue; // defined param has precedence
                array["customParams"][i] = obj.customParams[i];
            }
        }
    }

    // merge once for common custom params (_nRepData['customParams']) in case widgets haven't been loaded into the page yet
    mergeFunc('');

    // merge into specific widgets
    if (obj.widget)
    {
        mergeFunc(obj.widget);
    }
    else
    {
        mergeFunc("float");
        mergeFunc("embed");
    }
}

ISQ.API.getCustomParamsFromTable = function (obj)
{
    /* 
    obj: 
    {
    table: ,  //DOMElement or elementID
    skipRows: [],  // indices of rows with text to skip.
    }
    */

    if (!obj.table) return;
    var table = window._(obj.table);
    if (!table) return;

    // extracting params
    var customParams = [];
    var trs = table.getElementsByTagName("TR");
    var tds, tmpArr, hasText = false, paramName, paramValue, innerText;
    var contentRowNum = -1;
    var rowState = "";
    for (var trNdx = 0; trNdx < trs.length; ++trNdx)
    {
        // checking if the row has data
        rowState = "noText";
        paramName = paramValue = "";
        tds = [];
        tmpArr = trs[trNdx].getElementsByTagName("TH");
        for (var i = 0; i < tmpArr.length; ++i) tds.push(tmpArr[i]); // joining two arrays
        tmpArr = trs[trNdx].getElementsByTagName("TD");
        for (var i = 0; i < tmpArr.length; ++i) tds.push(tmpArr[i]); // joining two arrays

        contentRowNum++; // treating row as with text
        for (var tdNdx = 0; tdNdx < tds.length; ++tdNdx)
        {
            innerText = tds[tdNdx].innerText || tds[tdNdx].textContent;
            if (!innerText) continue;
            innerText = innerText.Trim();
            rowState = "hasText";

            // if need to skip this row
            if (obj.skipRows && ISQ.Data.indexOfArray(obj.skipRows, contentRowNum) !== -1)
            {
                rowState = "skip";
                break;
            }
            else if (!paramName) // getting paramName
                paramName = innerText;
            else if (!paramValue) // paramValue
            {
                paramValue = innerText;
                break; // breaking after we get paramValue
            }
        }

        // row has no data
        if (rowState === "noText")
        {
            --contentRowNum;
            continue;
        }
        if (rowState === "skip") continue;
        if (!paramName || !paramValue) continue;
        customParams[paramName] = paramValue;
    }

    return customParams;
}
ISQ.API.getCustomParamsFromUl = function (obj)
{
    if (!obj.ul) return;
    var ul = window._(obj.ul);

    // if no ul return, nothing to do
    if (!ul) return;

    // running the list to get key - value pairs
    var lis = ul.getElementsByTagName("LI");
    var customParams = [];
    var innerText, paramName, paramVal = "";
    for (var i = 0; i < lis.length; ++i)
    {
        paramName = paramVal = "";
        for (var j = 0; j < lis[i].children.length; ++j)
        {
            if (lis[i].children[j].localName == "small")
                paramName = lis[i].children[j].innerHTML.replace(/:/g, "").Trim();
            else if (lis[i].children[j].localName == "b")
                paramVal = lis[i].children[j].innerHTML.Trim();
        }

        if (!paramName || !paramVal) return;
        customParams[paramName] = paramVal;
    }

    // returning custom params
    return customParams;
}
ISQ.API.runPageScript = function (script, encoded)
{
    if (!script) return;
    try
    {
        if (encoded)
            eval(ISQ.Tools.Base64.decodeString(script));
        else
            eval(script);
    }
    catch (e) { }
}

</script>
    <script type="text/javascript">
// widgetUI
ISQ.Widget.CDC_getKeyValueArrayFromMessage = function (text, returnObject)
{
    var result;
    if (returnObject)
        result = {};
    else
        result = [];
    var valueSplit = text.split(ISQ.Widget.APIKeyEndDelimiter);
    var valueDataSplit, name, value;
    for (var valNdx = 0; valNdx < valueSplit.length; ++valNdx)
    {
        valueDataSplit = valueSplit[valNdx].split(ISQ.Widget.APIValueEndDelimiter);
        name = ISQ.Http.Cookies.decode64(valueDataSplit[0]);
        value = ISQ.Http.Cookies.decode64(valueDataSplit[1]);
        result[name] = value;
    }
    return result;
};
// widgetUI
ISQ.Widget.CDC_appendKeyValueToMessage = function (arr, stringBuilder)
{
    var first = true;
    for (var name in arr)
    {
        if (!first) stringBuilder.push(ISQ.Widget.APIKeyEndDelimiter);
        first = false;
        stringBuilder.push(ISQ.Http.Cookies.encode64(name));
        stringBuilder.push(ISQ.Widget.APIValueEndDelimiter);
        stringBuilder.push(ISQ.Http.Cookies.encode64(arr[name]));
    }
};
</script>
    <script type="text/javascript">// handles answers from external sources: parses the summary
ISQ.Export = {};

ISQ.enumContentProviders =
{
    "worldManuals": "-1000"
};

ISQ.Export.parseExternalSourceSummary = function (summary, sourceType, blockContainer)
{
    switch (sourceType)
    {
        case ISQ.enumContentProviders.worldManuals:
            return ISQ.Export.wmParser(summary, ISQ.Widget.HTML.widgetContainer, blockContainer);
            break;

        default:
            return summary;
            break;
    }
}

ISQ.Export.popupTimer = null;
ISQ.Export.currentHeight = 500;
ISQ.Export.currentWidth = 800;
ISQ.Export.currentMaxHeight = 0;
ISQ.Export.currentMaxWidth = 0;
ISQ.Export.scaled = false;
ISQ.Export.Blocker= false;

// add screen blocker for device image - in mobile/tablet
ISQ.Export.AddBlocker = function (screenWidth, answer)
{
    if (screenWidth && screenWidth >= 850 || ISQ.Widget.isFloat) return;
    if (answer && answer.wmElement && answer.wmElement.visible && !ISQ.Export.Blocker)
    {

        ISQ.Export.Blocker = createDiv(document.body, "width:100%;top:0px;bottom:0px;left:0px;right:0px;position:fixed;z-index:99996;background-color: black;opacity:0.6");
        ISQ.Export.Blocker.CloseButton = createDiv(document.body, "cursor:pointer;font-size:28px;width:40px;height:40px;line-height:40px;border-radius:20px 20px 20px 20px;background-color:#e00000;font-weight:bold;color:white;right:10px;top:10px;text-align:center;z-index:999999;position:fixed;");
        ISQ.Export.Blocker.CloseButton.innerHTML = "X";
        var embed = document.querySelectorAll(".widgetSearchBox");
        if (embed.length > 0)
            embed[0].style["display"] = 'none';
        ISQ.Export.Blocker.CloseButton.onclick = function ()
        {
            if (embed.length > 0)
                embed[0].style["display"] = 'block';
            answer.wmElement["imgDiv"].style.display = 'none';
            answer.wmElement["imgDiv"].isClosed = true; //telling other places that this code is removed.
            answer.wmElement.visible = false;
            ISQ.Export.removeBlocker();
        }
    }
}
// remove screen blocker for device image - in mobile/tablet
ISQ.Export.removeBlocker = function ()
{
    if (!ISQ.Export.Blocker) return;
    ISQ.Export.Blocker.CloseButton.parentNode.removeChild(ISQ.Export.Blocker.CloseButton);
    ISQ.Export.Blocker.parentNode.removeChild(ISQ.Export.Blocker);
    ISQ.Export.Blocker = false;
}

// on support page resized / embed resized / window resized
ISQ.Export.wmWidgetSize = function (answerDiv, container)
{
    ISQ.Export.currentMaxHeight = 0;
    ISQ.Export.currentMaxWidth = 0;
    var marginIgnore = 40;
    var elements = answerDiv.querySelectorAll(".pointer[data-image-url]"); // take all pointer calasses that have data-image-url attribute.
    // if is mobile or tablet 
    var screenWidth = window.innerWidth || document.documentElement.clientWidth;
    var screenHeight = window.innerHeight || document.documentElement.clientHeight;
    if (screenWidth < 850 && !ISQ.Widget.isFloat)
    {

        for (var i = 0; i < elements.length; i++)
        {
            var cElement = elements[i];
            var imgWidth = parseInt(elements[i].getAttribute("data-width"));
            var imgHeight = parseInt(elements[i].getAttribute("data-height"));

            var newImgSize = screenWidth - 40;
            var hRatio = 1;

            if (imgWidth > newImgSize)
            {
                ISQ.Export.scaled = true;
                hRatio = newImgSize / imgWidth;
                newImgHeight = parseInt(imgHeight * hRatio);
                cElement["imgDiv"].style.width = newImgSize + "px";
                cElement["imgDiv"].style.height = parseInt(imgHeight * hRatio) + "px";
            }
            else
            {
                newImgSize = parseInt(imgWidth);
                newImgHeight = parseInt(imgHeight);
            }
            cElement["imgDiv"].style.backgroundSize = "100%";
            cElement["imgDiv"].style.left = (screenWidth - newImgSize) / 2 + 'px';
            cElement["imgDiv"].style.zIndex = 999998;

            // if not embed widget
            if (!ISQ.Export.embedWidget)
            {
                cElement["imgDiv"].style.position = 'fixed';
                cElement["imgDiv"].style.top = (screenHeight - newImgHeight) / 2 + marginIgnore + 'px';
            }
            else
            {
                //cElement["imgDiv"].style.height = imgHeight + "px"
                cElement["imgDiv"].style.position = 'absolute';
                if (cElement["imgDiv"].pointer)
                {
                    cElement["imgDiv"].pointer.style.position = 'absolute';
                    cElement["imgDiv"].pointer.style.top = parseInt(cElement.getAttribute("data-position-top")) - 20  + 'px';
                    cElement["imgDiv"].pointer.style.left = parseInt(cElement.getAttribute("data-position-left")) - 20 + 'px';
                    cElement["imgDiv"].pointer.style.width = "auto";
                }
            }

            if (cElement["imgDiv"].pointer)
            {
                var marginTopOfMainPic = -40;
                cElement["imgDiv"].pointer.style.position = 'absolute';
                cElement["imgDiv"].pointer.style.top = parseInt(((imgHeight * hRatio) - newImgHeight) / 2) -  20  + (hRatio * parseInt(cElement.getAttribute("data-position-top"))) + 'px';
                cElement["imgDiv"].pointer.style.left = parseInt(((imgWidth * hRatio) - newImgSize) / 2) - 20 + (hRatio * parseInt(cElement.getAttribute("data-position-left"))) + 'px';

                if (!cElement["imgDiv"].pointer.originalOffset)
                {
                    var lastState = cElement["imgDiv"].style.display;
                    cElement["imgDiv"].style.display = "block";
                    cElement["imgDiv"].firstChild.style.display = "block";
                    cElement["imgDiv"].pointer.originalOffset = cElement["imgDiv"].pointer.offsetWidth || 60;
                    cElement["imgDiv"].style.display = lastState;
                }
                cElement["imgDiv"].pointer.style.width = parseInt(cElement["imgDiv"].pointer.originalOffset) * hRatio + 'px';
            }
        }
        answerDiv.style.width = '100%';

        // if item is visible, we need to add blocker (if not added already)
        ISQ.Export.AddBlocker(null, ISQ.Export.currentAnswerElement);
    }
    else
    {
        ISQ.Export.removeBlocker();
        // if is pc with higher resolution than 850px ) 
        if (elements.length > 0)
        {
            var fixedMargin = 100;
            var fixedHorizontalMargin = 80;
            var maxWidth = 0;
            var maxHeight = 0;
            for (var i = 0; i < elements.length; i++)
            {
                var cElement = elements[i];
                var imgWidth =cElement.getAttribute("data-width");
                if (maxWidth < parseInt(imgWidth)) maxWidth = parseInt(imgWidth);

                var imgHeight = parseInt(cElement.getAttribute("data-height"));
                if (maxHeight < imgHeight) maxHeight = parseInt(imgHeight);


                if (!cElement["imgDiv"])
                    return false;

                cElement["imgDiv"].style.width = imgWidth + "px"
                cElement["imgDiv"].style.height = imgHeight + "px"
                cElement["imgDiv"].style.position = 'absolute';
                if (cElement["imgDiv"].pointer)
                {
                    cElement["imgDiv"].pointer.style.position = 'absolute';
                    cElement["imgDiv"].pointer.style.top = parseInt(cElement.getAttribute("data-position-top")) - 20 + 'px';
                    cElement["imgDiv"].pointer.style.left = parseInt(cElement.getAttribute("data-position-left")) - 20 + 'px';
                    cElement["imgDiv"].pointer.style.width = "auto";
                }
            }
            if (parseInt(maxHeight) > parseInt(ISQ.Export.currentMaxHeight) && parseInt(maxHeight) < 3000)
                ISQ.Export.currentMaxHeight = maxHeight;
            if (parseInt(maxWidth) > parseInt(ISQ.Export.currentMaxWidth) && parseInt(maxWidth) < 3000)
                ISQ.Export.currentMaxWidth = maxWidth;

            var originalWidth = container.offsetWidth;
            answerDiv.style.width = originalWidth - 50 - ISQ.Export.currentMaxWidth + "px";

            //  answersContainer.style.width = 450 + parseInt(ISQ.Export.currentMaxWidth) + 'px';
            answerDiv.style.minHeight = (parseInt(ISQ.Export.currentMaxHeight) + 50) + 'px';

            ISQ.Export.currentHeight = (fixedMargin + parseInt(ISQ.Export.currentMaxHeight)) + 100;
            ISQ.Export.currentWidth = 600 + parseInt(ISQ.Export.currentMaxWidth);
        }
        if (ISQ.Export.scaled)
            ISQ.Export.scaled = false;
    }

    var elements = ISQ.Html.getElementsByClassName(container, "hoverImagesClass");

    if(!ISQ.Export.isSupportPage)
        ISQ.Widget.HTML.dynamicSize_sendMessage();

    if (elements.length > 0 && !ISQ.Export.isSupportPage && ISQ.Widget.isFloat)
        ISQ.Widget.CDC.sendMessage("subject=setSize&height=" + ISQ.Export.currentHeight + "&width=" + ISQ.Export.currentWidth);
    else
        return false;
}
ISQ.Export.embedWidget = false;
ISQ.Export.wmElement = null;
ISQ.Export.isSupportPage = false;
ISQ.Export.registeredEvents = [];
ISQ.Export.questionCounter = 0;
ISQ.Export.currentAnswerElement = null;

ISQ.Export.wmParser = function (answer, container, blockContainer, isSupportPage)
{
    ISQ.Export.currentAnswerElement = answer;
    var processes = 0;
    // clearing events
    for (var i = 0; i < ISQ.Export.registeredEvents.length; i++)
    {
        window.removeEvents(ISQ.Export.registeredEvents[i], "onscroll", wmResizeOrScroll)
        window.removeEvents(ISQ.Export.registeredEvents[i], "onresize", wmResizeOrScroll)
    }
    ISQ.Export.registeredEvents = [];

    if (!answer) return;
    //  answer.style.position = 'relative';
    answer.style.overflow = 'hidden';
    var answerOffset = answer.offsetTop;
    var widgetWidth;
    var answerDiv;
    var winObject;
    var winObjectScroll = null;
    var widgetContainer;

    if (isSupportPage || !ISQ.Widget.isContained)
    {
        ISQ.Export.isSupportPage = true;
        winObject = window;
        if (!ISQ.Widget.isContained && ISQ.Widget.HTML)
            winObjectScroll = ISQ.Widget.HTML.contentWrapper;

        if (answer.style.display == 'none')
            answer.style.display = 'block';

        widgetWidth = answer.offsetWidth;
        widgetContainer = answer;
        answerDiv = createDiv(null, "float:left;");
    }
    else if (!ISQ.Widget.isFloat)  // embed widget requires embed.js control of scroll
    {

        ISQ.Export.embedWidget = true;
        winObject = null;
        if (ISQ.Widget.sendingCDCMessages)
            ISQ.Widget.CDC.sendMessage("subject=enableScrollingEvent");

        widgetWidth = ISQ.Widget.HTML.contentWrapper.offsetWidth;
        answerDiv = createDiv(null, "float:left;position:relative");
        widgetContainer = ISQ.Widget.HTML.widgetContainer;
    }
    else // if is float widget
    {

        widgetContainer = ISQ.Widget.HTML.widgetContainer;
        winObject = ISQ.Widget.HTML.contentWrapper;
        widgetWidth = ISQ.Widget.HTML.contentWrapper.offsetWidth;
        answerDiv = createDiv(null, "float:left;position:relative");
    }
    answerDiv.innerHTML = answer.innerHTML;
    answerDiv.style.minHeight = '290px';
    answer.innerHTML = '';
    answer.appendChild(answerDiv);
    answer.answerDiv = answerDiv;
    var answersContainer = createDiv(answer, "width:" + (widgetWidth - answerDiv.offsetWidth) + "px;position:relative;float:right;");
    var screenWidth = window.innerWidth || document.documentElement.clientWidth;
    // setting position of image during resize & scroll
    var setPositionOfElement = function (element, obj)
    {
        if (element["imgDiv"].style.position == 'fixed')
        {
            return;
        }
        // if obj = only embeded widget sends the coords 
        if (obj)
            for (key in obj)
            {
                try
                {
                    if (!isNaN(obj[key]) && obj[key])
                        obj[key] = parseInt(obj[key]);

                }
                catch (err)
                {
                }
            }
        // if should set height of picture in embed

        if (!isSupportPage && !ISQ.Widget.isFloat && !obj && ISQ.Widget.isContained)
        {
            element["imgDiv"].style.display = 'none';
            ISQ.Widget.CDC.sendMessage("subject=getWindowAttributes");
            return;
        }
        else
        {
            if(!element["imgDiv"].isClosed)
                element["imgDiv"].style.display = 'block';
        }
        var getOffsetTopOfItem = function (element)
        {
            var offsetTop = parseInt(element.offsetTop);
            if (typeof offsetTop != 'number' || isNaN(offsetTop))
                offsetTop = 0;

            if (element.parentNode)
            {
                var offTop = getOffsetTopOfItem(element.parentNode);
                return (offsetTop > offTop) ? offsetTop : offTop;
            }
            else
                return offsetTop;
        }
        var articleTop = element.container.offsetTop;
        var articleBottom = element.container.offsetTop + element.container.offsetHeight;
        // limit width of element to 400 at most!
        var newWidth = 400;
        var currentWidth = parseInt(element["imgDiv"].style.width.replace('px', ''));
        var screenHeight = window.innerHeight || document.documentElement.clientHeight;

        // setting top and left for support page content ( not float/embed )
        if (isSupportPage)
        {
            var marginReduction = 40;
            articleTop += marginReduction;
            var startingY = window.pageYOffset || (document.documentElement || document.body.parentNode || document.body).scrollTop;
            var topPosition = (startingY + marginReduction - getOffsetTopOfItem(element.container)) + (screenHeight - element["imgDiv"].offsetHeight) / 2;
            var leftPosition = document.body.scrollLeft + (element.container.offsetWidth - element["imgDiv"].offsetWidth) + element.container.offsetLeft - 20;
        } // IF STAND ALONE WIDGET
        else if (!ISQ.Widget.isContained)
        {

            var topPosition = winObjectScroll.scrollTop + (screenHeight - element["imgDiv"].offsetHeight) / 2;
            var leftPosition = winObjectScroll.scrollLeft + (element.container.offsetWidth - element["imgDiv"].offsetWidth) + element.container.offsetLeft;
        }
        else
        {
            // locating the image top to floating widget
            if (ISQ.Widget.isFloat)
                var topPosition = ISQ.Widget.HTML.contentWrapper.offsetTop + ISQ.Widget.HTML.contentWrapper.scrollTop + (ISQ.Widget.HTML.contentWrapper.offsetHeight - element["imgDiv"].offsetHeight) / 2;
            // embedded widget
            else if (obj)
            {
                var offsetHeight = (blockContainer.offsetHeight > obj.height) ? parseInt(obj.height) : parseInt(blockContainer.offsetHeight);
                // var imgHeightOffset = (blockContainer.offsetHeight - element["imgDiv"].offsetHeight)
                var topPosition = parseInt(obj.scrollTop) - parseInt(ISQ.Widget.HTML.contentWrapper.offsetTop) + ((offsetHeight - parseInt(element["imgDiv"].offsetHeight)) / 2) - parseInt(obj.offsetTop);
            }
            var leftPosition = element.container.scrollLeft + (element.container.offsetWidth - element["imgDiv"].offsetWidth) + element.container.offsetLeft - 20;
        }
        // if reached the top of the article, stop there...
        if (topPosition < articleTop)
            topPosition = articleTop;

        // embedded widget positioning of the picture
        if (!isSupportPage && !ISQ.Widget.isFloat && obj)
        {
            // if image reached the end of the article
            if (topPosition + element["imgDiv"].offsetHeight > articleBottom)
                topPosition = articleBottom - element["imgDiv"].offsetHeight;
        }
        else if (topPosition + element["imgDiv"].offsetHeight > articleBottom)
        {
            topPosition = articleBottom - element["imgDiv"].offsetHeight;
        }
        if (!isSupportPage)
            topPosition -= articleTop;

        if (isNaN(topPosition))
            topPosition = 0;

        element["imgDiv"].style.top = topPosition + 'px';
        element["imgDiv"].style.left = leftPosition + 'px';
        if (ISQ.Widget.isFloat)
        {
            element["imgDiv"].style.left = 'auto';
            element["imgDiv"].style.right = '15px';
        }
    }


    // register to browser events
    var wmResizeOrScroll = function (obj)
    {
        if (ISQ.Export.currentAnswerElement.wmElement && ISQ.Export.currentAnswerElement.wmElement["imgDiv"].style.display == 'none' && !obj)
            return;
        if (ISQ.Export.currentAnswerElement.wmElement != null)
            setPositionOfElement(ISQ.Export.currentAnswerElement.wmElement, obj)
    }

    // resize event 
    var wmResize = function (obj)
    {
        if (ISQ.Export.currentAnswerElement.wmElement && ISQ.Export.currentAnswerElement.wmElement["imgDiv"].style.display == 'none')
            return;
        ISQ.Export.wmWidgetSize(answerDiv, widgetContainer);
        if (ISQ.Export.currentAnswerElement.wmElement != null)
            setPositionOfElement(ISQ.Export.currentAnswerElement.wmElement, obj)
    }
    // registering events on support page 
    if (winObject)
    {
        window.addEvents(winObjectScroll || winObject, "onscroll", wmResizeOrScroll);
        window.addEvents(winObject, "onresize", wmResize);
    }
    else
    {
        // if embeded widget, using callback from the embed.js
        ISQ.Widget.embedCallback = wmResizeOrScroll;
    }

    //var elements = ISQ.Html.getElementsByClassName(answerDiv, "pointer");
    var elements = answerDiv.querySelectorAll(".pointer[data-image-url]"); // take all pointer calasses that have data-image-url attribute.

    if (elements.length > 0)
        answer.className += " wmCss";

    // going through all the elements and checking the biggest image
    // then resizing the article so the image won't go on top of the article
    if (elements.length > 0)
    {
        var fixedMargin = 100;
        var fixedHorizontalMargin = 80;
        var maxWidth = 0;
        var maxHeight = 0;
        for (var i = 0; i < elements.length; i++)
        {
            var imgWidth = elements[i].getAttribute("data-width") - 0;
            if (maxWidth < imgWidth && imgWidth < 1000) maxWidth = imgWidth;

            var imgHeight = elements[i].getAttribute("data-height") - 0;
            if (maxHeight < imgHeight && imgHeight < 1000) maxHeight = imgHeight;
        }
        if (parseInt(maxHeight) > parseInt(ISQ.Export.currentMaxHeight))
            ISQ.Export.currentMaxHeight = maxHeight;
        if (parseInt(maxWidth) > parseInt(ISQ.Export.currentMaxWidth))
            ISQ.Export.currentMaxWidth = maxWidth;

        // answerDiv.style.width = "550px";

        if (isSupportPage)
            answerDiv.style.width = answer.offsetWidth - (30 + parseInt(ISQ.Export.currentMaxWidth)) + 'px';
        else if (ISQ.Widget.HTML.contentWrapper)
            answerDiv.style.width = (550 > screenWidth) ? "100%" : "550px";
        else
            answerDiv.style.width = "550px";
        //answersContainer.style.width = 450 + parseInt(ISQ.Export.currentMaxWidth) + 'px';
        // answer.style.minHeight = (fixedMargin + parseInt(ISQ.Export.currentMaxHeight)) + 'px';
        ISQ.Export.currentHeight = (fixedMargin + parseInt(ISQ.Export.currentMaxHeight)) + 100;
        ISQ.Export.currentWidth = 550 + parseInt(ISQ.Export.currentMaxWidth);


    }
    else
    {
        answersContainer.style.width = 'auto';
    }
    // going through elements that should act like images on spans hover, and implementing the logic 
    for (var i = 0; i < elements.length; i++)
    {
        var currentElement = elements[i];
        currentElement.answerElement = answer;
        currentElement.container = blockContainer || answer;
        // taking the attributes from each element
        var imgUrl = currentElement.getAttribute("data-image-url");
        var imgWidth = currentElement.getAttribute("data-width");
        var imgHeight = currentElement.getAttribute("data-height");
        var imgPointerTop = currentElement.getAttribute("data-position-top");
        var imgPointerLeft = currentElement.getAttribute("data-position-left");
        var pointerImage = currentElement.getAttribute("data-pointer-url");
        var imgRightPos = (360 - imgWidth) / 2;
        if (imgRightPos < 0) imgRightPos = 30;
        var ratio = 1;
        // creating the image and the image pointer
        var imgDiv;
        imgDiv = createDiv(answer, ".hoverImagesClass&width:" + imgWidth + "px;height:" + imgHeight + "px;background-size:100%;"); //right:" + imgRightPos + "px;"); //" + (parseInt(answerDiv.style.width)+10)+"px;");
        var imageElement = document.createElement("img");
        imageElement.src = imgUrl;
        imageElement.style.cssText = "width:100%";
        imageElement.style.display = 'none';
        imgDiv.appendChild(imageElement);

        //if (imgWidth > 30000)//need to check what this code is doing. 1000 before
        //
        //{
        //    processes++;
        //    //    imgDiv = createDiv(answer, ".hoverImagesClass"); //right:" + imgRightPos + "px;"); //" + (parseInt(answerDiv.style.width)+10)+"px;");
        //    imgDiv.parentObj = elements[i];
        //    imgDiv.image = createElement("img");
        //    imgDiv.image.parentObj = imgDiv;
        //    imgDiv.image.onload = function ()
        //    {
        //        document.body.appendChild(this);
        //        this.parentObj.style.width = this.width || this.offsetWidth;
        //        this.parentObj.style.height = this.height || this.offsetHeight;
        //        this.parentObj.parentObj.setAttribute("data-width", this.width || this.offsetWidth);
        //        this.parentObj.parentObj.setAttribute("data-height", this.height || this.offsetHeight);
        //        document.body.removeChild(this);
        //
        //        processes--;
        //        if (processes == 0 && answer.wmElement != null)
        //            answer.wmElement.linkAction(null, false);
        //    }
        //    imgDiv.image.src = imgUrl;
        //    // imgDiv.appendChild(imgDiv.image);
        //}
        if (imgWidth > 350)
        {
            ratio = 350 / imgWidth;
            imgWidth = 350;
            imgHeight = (imgHeight * ratio) + "px";
            currentElement.setAttribute("data-width", imgWidth);
            currentElement.setAttribute("data-height", imgHeight);
            currentElement.setAttribute("data-position-top", imgPointerTop * ratio);
            currentElement.setAttribute("data-position-left", imgPointerLeft * ratio);

            imgPointerTop = currentElement.getAttribute("data-position-top");
            imgPointerLeft = currentElement.getAttribute("data-position-left");
        }
        var imgPointer = createElement("img");
        imgPointer.style.cssText = "position:absolute;left:" + (imgPointerLeft - 20) + "px;top:" + (imgPointerTop - 20) + "px;";
        imgPointer.src = pointerImage;
        imgDiv.appendChild(imgPointer);
        imgDiv.pointer = imgPointer;

        currentElement["imgDiv"] = imgDiv;
        currentElement.style.color = '#E60000'; // message["bgcolor"];
        currentElement.style.cursor = 'pointer';

        // showing the image on span hover 
        var clearElements = function ()
        {
            var elements = ISQ.Html.getElementsByClassName(answer, "hoverImagesClass");
            for (var x = 0; x < elements.length; x++)
            {
                elements[x].style.opacity = 0;
            }
        }
        // text link on hover / click
        currentElement.linkAction = function (e, forceOpen)
        {
            ISQ.Export.currentAnswerElement = this.answerElement;
            var addBlocker = (window.innerWidth || document.documentElement.clientWidth) < 850 && !ISQ.Widget.isFloat;
            if (!forceOpen && addBlocker) return;
            // hide old image
            if (this.answerElement.wmElement && this.answerElement.wmElement != this)
                this.answerElement.wmElement["imgDiv"].style.display = 'none';

            this.answerElement.wmElement = this;

            this.answerElement.wmElement.visible = true;
            if (ISQ.Export.popupTimer)
                clearInterval(ISQ.Export.popupTimer);
            clearElements();
            this["imgDiv"].style.opacity = 1;
            this['imgDiv'].isClosed = false; // telling other places that this div should display.
            this["imgDiv"].style.cursor = 'pointer';
            this["imgDiv"].style.display = 'block';

            this["imgDiv"].firstChild.style.display = "block";

            // recalculating position of images in case the window was resized while the images were hidden
            ISQ.Export.wmWidgetSize(this.answerElement.answerDiv, widgetContainer);


            // repositioning the image       
            setPositionOfElement(this);
            //            this["imgDiv"].onclick = function ()
            //            {
            //                answer.wmElement["imgDiv"].style.display = 'none';
            //                answer.wmElement.visible = false;
            //                ISQ.Export.removeBlocker();
            //            }
            ISQ.Export.AddBlocker(window.innerWidth || document.documentElement.clientWidth);
        }
        currentElement.onmouseover = currentElement.linkAction;
        currentElement.onclick = function (e)
        {
            this.linkAction(e, true);
        };

        if (i == 0 && (ISQ.Export.questionCounter == 0 || isSupportPage))
        {
            ISQ.Export.questionCounter++;
            // setting the first picture to be seen but only on pc, not in tablet nor iphone
            setPositionOfElement(currentElement);
            if (screenWidth > 849 || ISQ.Widget.isFloat)
            {
                answer.wmElement = currentElement;
                currentElement["imgDiv"].style.opacity = 1;
            }
        }
        currentElement["imgDiv"].style.display = 'none';

    }
    if (isSupportPage)
    {
        var currentScrolling = window.document.body.scrollHeight;
        checkScrollChanged = function ()
        {
            if (window.document.body.scrollHeight != currentScrolling)
            {
                currentScrolling = window.document.body.scrollHeight;
                wmResizeOrScroll();

            }
        }
        setInterval(checkScrollChanged, 200);
    }
    if (answer.addEventListener)
    {
        answer.addEventListener("mouseenter", function ()
        {
            ISQ.Export.currentAnswerElement = this;
        });
    }
    else
    {
        answer.attachEvent("onmouseenter", function ()
        {
            ISQ.Export.currentAnswerElement = this;
        });
    }
    if (answer.wmElement != null)
        ISQ.Widget.elementsArr.push(answer.wmElement);

    ISQ.Widget.wmElements.push({ "c": answerDiv, "w": widgetContainer })

    // waiting for the page to be built\
    if (ISQ.Widget.isFloat || !isSupportPage)
    {
        if (ISQ.Widget.wmElements.length == 1)
        {

            setTimeout(function ()
            {
                //for (var i = 0; i < ISQ.Widget.wmElements.length; i++)
                ISQ.Export.wmWidgetSize(ISQ.Widget.wmElements[0].c, ISQ.Widget.wmElements[0].w);
                ISQ.Export.questionCounter = 0;
                for (var i = ISQ.Widget.elementsArr.length - 1; i >= 0; i--)
                {
                    answer.wmElement = ISQ.Widget.elementsArr[i];
                    answer.wmElement.linkAction(null, false);
                }
                ISQ.Widget.wmElements = [];
                ISQ.Widget.elementsArr = [];
                ISQ.Widget.HTML.dynamicSize_sendMessage();
            }, 500);
        }
    }
    else
    {
        ISQ.Export.wmWidgetSize(answerDiv, widgetContainer);
        if (answer.wmElement != null && processes == 0)
        {
            setTimeout(function ()
            {
                answer.wmElement.linkAction(null, false);
            }
            , 500);
        }
    }
    //answer.style.display = 'none';

    if (!isSupportPage)
        return answersContainer;
}

if (!ISQ.Widget)
    ISQ.Widget = {};
ISQ.Widget.wmElements = [];
ISQ.Widget.elementsArr = [];</script>
    <script type="text/javascript">/********************************************************/
ISQ.Widget = initializeNS('ISQ.Widget');

/********************************************************
//////////////////// [ GLOBALS ] ////////////////////////
********************************************************/
//#region globals
ISQ.Widget.enumState =
{
    // bitwise
	questions: 1,
    autoQuestions: 2,
    allQuestions: 3,

    chat: 4,
    chatSurvey: 8,
    chatEnded: 20, // 16 + 4
    allChat: 28,

    contactForm: 32,
    customLink: 64,

    nonChatEscalations: 96, // 32 + 64
    allEscalations: 124 // 96 + 28
};
ISQ.Widget.enumMobileHandlingMode =
{
    none: 0,
    inactive: 1,
    normalWidget: 2
};

initializeNS("ISQ.Widget.Texts");
ISQ.Widget.Texts.available = ["en","de","ar","zh","ru","ja","ko","fr","iw","it","nl","pt","es","sv"];
ISQ.Widget.account = "";
ISQ.Widget.dynamicHost = "";
ISQ.Widget.configId = "";
ISQ.Widget.cdcFrame = "";
ISQ.Widget.sendingCDCMessages = false;
ISQ.Widget.cdcVersion = "1";
ISQ.Widget.onloadQuestion = "";
ISQ.Widget.onloadQuestionId = "";
ISQ.Widget.onloadQuestionIdFromURL = false;
ISQ.Widget.lastQuestionId = "";
ISQ.Widget.isFloat = false;
ISQ.Widget.isFullScreen = false;
ISQ.Widget.isContained = false;
ISQ.Widget.spriteLoaded = false;
ISQ.Widget.skinName = null;
ISQ.Widget.referer =
{
    normal: "",
    escaped: "",
    encoded: false
};
ISQ.Widget.state = ISQ.Widget.enumState.questions;
ISQ.Widget.userActive = false;
ISQ.Widget.lastQueryKeyTime = 0;
ISQ.Widget.updateQueryDiff_ms = 2000;
ISQ.Widget.customTitle = "";
ISQ.Widget.customTeaserText = "";
ISQ.Widget.dynamicSize = false; // means the widget tells its container (embed) about its width&height.
ISQ.Widget.dynamicMaxSize = 0;
ISQ.Widget.mobileHandlingMode = ISQ.Widget.enumMobileHandlingMode.none;
ISQ.Widget.isPreview = ISQ.Http.hashArguments["preview"] === 'true' || ISQ.Http.urlArguments["preview"] === 'true';
ISQ.Widget.reportEvents = ISQ.Http.hashArguments["reportevents"] === 'true';
ISQ.Widget.rtlCssLoaded = false;

ISQ.Widget.TranslationHelper = {};
ISQ.Widget.TranslationHelper.languageEnabled = false;
ISQ.Widget.TranslationHelper.detectedLanguage = null;

ISQ.Widget = initializeNS("ISQ.Widget");
ISQ.Widget.iChat = ISQ.Base.extend({ name: "ISQ.Widget.iChat", abstractClass: true });
ISQ.Widget["iChat"] = ISQ.Widget.iChat; // for keeping name reference intact after obfuscation
//#region static
ISQ.Widget.iChat.END_SENTENCE_MARKS = ['.', '!', '?', '\n', ' ']; // several ways to end a sentence
ISQ.Widget.iChat.LINE_MAX_LENGTH = 600;
ISQ.Widget.iChat.instance = null;
ISQ.Widget.iChat.defaultInstance = null;
ISQ.Widget.iChat.chatCookieName = "chatForResume";
ISQ.Widget.iChat.enumState =
{
    preinit: 0,
    initiated: 1,
    available: 2,
    requestingChat: 4,
    preChat: 8,
    resumeChat: 16,
    chat: 32,
    userActive: 1024
};
ISQ.Widget.iChat.enumMessageType =
{
    visitor_text : 0,
    agent_text : 1,
    system : 2,
    visitor_id : 3,
    agent_id : 4,
    requestChat : 5,
    chatStarted_agent: 6,
    chatStarted_visitor: 7,
    chatEnded : 8
}
ISQ.Widget.iChat.enumRequestChatStatus =
{
    inChat: 0,
    requestingChat: 1,
    newChat: 2,
    resumingChat: 3,
    preChat: 4,
    popup: 5
}
ISQ.Widget.iChat.closeSurvey = function ()
{
    if (!ISQ.Widget.iChat.instance) return;
    ISQ.Widget.iChat.instance.mChatSurvey.closeSurvey();
}
ISQ.Widget.iChat.submitSurvey = function ()
{
    if (!ISQ.Widget.iChat.instance) return;
    ISQ.Widget.iChat.instance.mChatSurvey.submitSurvey()
}
//#endregion

//#region abstract
ISQ.Widget.iChat.abstractClass.onRequestChat;
ISQ.Widget.iChat.abstractClass.onEndChat;
ISQ.Widget.iChat.abstractClass.onChatStopped;
ISQ.Widget.iChat.abstractClass.onChatError;
ISQ.Widget.iChat.abstractClass.onChatStarted;
ISQ.Widget.iChat.abstractClass.onSendMessage;
ISQ.Widget.iChat.abstractClass.onSendAnswerId;
ISQ.Widget.iChat.abstractClass.onUserTyping;
ISQ.Widget.iChat.abstractClass.supportingEmailChat;
ISQ.Widget.iChat.abstractClass.emailChat;
ISQ.Widget.iChat.abstractClass.agentName;
ISQ.Widget.iChat.abstractClass.getDataToSave;
ISQ.Widget.iChat.abstractClass.showPostChat;
//#endregion

//#region ctor
ISQ.Widget.iChat.prototype.ctor = function (obj)
{
    // single instance
    if (ISQ.Widget.iChat.instance && ISQ.Widget.iChat.instance !== ISQ.Widget.iChat.defaultInstance)
        ISQ.Widget.iChat.instance.dispose(); // destroying current instance
    ISQ.Widget.iChat.instance = this; // allowing only one provider on a page

    // default instance
    if (obj.isDefault) ISQ.Widget.iChat.defaultInstance = this;

    // applying arguments
    this.mConfig = obj.config;
    this.hAgentTyping = obj.hAgentTyping;
    this.hIncomingMessage = obj.hIncomingMessage;
    this.hChatEnded = obj.hChatEnded;
    this.hChatStarted = obj.hChatStarted;
    this.hResumingChat = obj.hResumingChat;
    this.hChatRequested = obj.hChatRequested;
    this.hChatAvailableChanged = obj.hChatAvailableChanged;
    this.hConnectionError = obj.hConnectionError;
    this.hShowActionBar = obj.hShowActionBar;
}
ISQ.Widget.iChat.prototype.dtor = function () {  }
//#endregion

//#region methods
ISQ.Widget.iChat.prototype.sendMessage_internal = function (msgObj, sendFunction)
{
    if (!this.inChat())
    {
        if (!this.requestingChat()) return;
        if (!this.mPendingMessages) this.mPendingMessages = [];
        this.mPendingMessages.push(msgObj);
        this.saveChatForResume();
    }
    else
    {
        ////////////////////////////////////////////////////////////////////////
        // stopping user typing message
        this.userTyping(false);

        ////////////////////////////////////////////////////////////////////////
        // sending in segments
        var message = msgObj.text;
        var encoded = ISQ.Data.getURLencodedString(ISQ.Data.unHTML(message)); // removing '<' and '>' to prevent cross-site scripting

        // creating queue and starting timer
        if (!this.mMessagesQueue)
        {
            this.mMessagesQueue = [];
            var mthis = this;
            var func = function (i)
            {
                setTimeout(function ()
                {
                    var obj = mthis.mMessagesQueue[i++];
                    obj.sendFunction(obj.message);
                    ISQ.Widget.Log.add("chat message sent");
                    if (i !== mthis.mMessagesQueue.length)
                        func(i);
                    else
                        mthis.mMessagesQueue = null;

                }, 20);
            };
            func(0);
        }

        // message is shorter than limit
        if (encoded.length <= ISQ.Widget.iChat.LINE_MAX_LENGTH)
        {
            this.mMessagesQueue.push({ message: message, sendFunction: sendFunction });
        }
        else // message needs to broken into segments
        {
            var start = 0, end = ISQ.Widget.iChat.LINE_MAX_LENGTH;
            var idx = -1;
            while (end < encoded.length)
            {
                end = Math.min(encoded.length, start + ISQ.Widget.iChat.LINE_MAX_LENGTH);

                // TRIM IS NEEDED
                if (end !== encoded.length)
                {
                    var lastIdx = -1;

                    // find closest end sentence mark
                    var chrLength = 0;
                    for (var i = 0; i < ISQ.Widget.iChat.END_SENTENCE_MARKS.length; i++)
                    {
                        var chr = ISQ.Data.getURLencodedString(ISQ.Widget.iChat.END_SENTENCE_MARKS[i]); // encoded end of sentence char
                        idx = encoded.LastIndexOf(chr, end); // searching backwards
                        if (idx < start) continue;

                        if (idx > lastIdx)
                        {
                            lastIdx = idx;
                            chrLength = chr.length;
                        }
                    }
                    end = lastIdx + chrLength;
                }

                // add the segment to the results array
                var segment = encoded.substring(start, end);
                if (segment.length > 0)
                {
                    var plain = ISQ.Data.getURLdecodedString(segment);
                    this.mMessagesQueue.push({ message: plain, sendFunction: sendFunction })
                }

                // move start
                start = end;
            }
        }
    }
}
ISQ.Widget.iChat.prototype.sendMessage = function (message)
{
    if (!message) return;
    this.onSendMessage.apply(this, arguments);
}
ISQ.Widget.iChat.prototype.sendAnswerId = function (messageObject)
{
    if (!messageObject.id) return;
    messageObject.type = ISQ.Widget.iChat.enumMessageType.visitor_id;
    this.onSendAnswerId.apply(this, arguments);
}
ISQ.Widget.iChat.prototype.userTyping = function (isTyping)
{
    if (!this.inChat()) return;
    if (isTyping === this.mUserTyping) return;
    this.mUserTyping = isTyping;

    this.onUserTyping(isTyping);
}
ISQ.Widget.iChat.prototype.requestChat = function (postPreChat)
{
    // resuming chat
    if (!postPreChat && this.resumingChat())
    {
        this.mState |= ISQ.Widget.iChat.enumState.requestingChat;
        this.hChatRequested.handle(ISQ.Widget.iChat.enumRequestChatStatus.requestingChat);
        this.hChatRequested.handle(ISQ.Widget.iChat.enumRequestChatStatus.resumingChat);
        return true;
    }
    // in chat
    else if (!postPreChat && this.inChat())
    {
        this.hChatRequested.handle(ISQ.Widget.iChat.enumRequestChatStatus.inChat);
        return true;
    }
    else // requesting chat now. onRequestChat will fire the handler
    {
        if (!this.available())
        {
            this.hChatAvailableChanged.handle(false);
            return true;
        }
        // indicating user was active
        this.mState |= ISQ.Widget.iChat.enumState.userActive;
        this.mState |= ISQ.Widget.iChat.enumState.requestingChat;
        if (this.mChatSurvey) this.mChatSurvey.dispose(); // disposing previous preChat
        return this.onRequestChat(postPreChat);
    }
}
// get availability per answer, required for LP chat
ISQ.Widget.iChat.prototype.getAvailabilityPerAnswer = function (reqSkill)
{
    return false;
}
// if more then one widget on the page #10538
ISQ.Widget.iChat.prototype.setChatNotActive = function ()
{
    this.mActive = false;
}
ISQ.Widget.iChat.prototype.endChat = function ()
{
    this.deleteChatFromResume();
    // nothing to end
    if ((this.mState & ~ISQ.Widget.iChat.enumState.userActive) < ISQ.Widget.iChat.enumState.requestingChat) return;

    // opening post chat survey 
    if (this.inChat() && this.mConfig.postChat)
    {
        this.showPostChat();
    }

    // removing flags
    this.mState &= ~ISQ.Widget.iChat.enumState.chat;
    this.mState &= ~ISQ.Widget.iChat.enumState.resumeChat;
    this.mState &= ~ISQ.Widget.iChat.enumState.requestingChat;

    this.mPendingMessages = null;
    this.onEndChat();
}
ISQ.Widget.iChat.prototype.aboutToResumeChat = function ()
{
    this.mState |= ISQ.Widget.iChat.enumState.resumeChat;
    this.mState |= ISQ.Widget.iChat.enumState.available;
    // handler
    this.hResumingChat.handle();
}
ISQ.Widget.iChat.prototype.chatStarted = function ()
{
    if (!this.mActive) return; //#10538
    this.mState |= ISQ.Widget.iChat.enumState.chat; // setting chat flag
    this.mState &= ~ISQ.Widget.iChat.enumState.requestingChat;

    // derived
    this.onChatStarted.apply(this, arguments);

    // handler
    this.hChatStarted.handle();

    // sending waiting content
    if (this.mPendingMessages)
    {
        for (var i = 0; i < this.mPendingMessages.length; ++i)
        {
            if (this.mPendingMessages[i].type === ISQ.Widget.iChat.enumMessageType.visitor_id)
                this.sendAnswerId(this.mPendingMessages[i]);
            else
                this.sendMessage(this.mPendingMessages[i].text);
        }
        this.mPendingMessages = null;
    }

    // saving chat to resume (session)
    this.saveChatForResume();
}
ISQ.Widget.iChat.prototype.connectionError = function ()
{
    this.mState &= ~ISQ.Widget.iChat.enumState.chat; // removing chat flag
    this.mState &= ~ISQ.Widget.iChat.enumState.requestingChat;
    this.mState &= ~ISQ.Widget.iChat.enumState.resumeChat;
    this.mState &= ~ISQ.Widget.iChat.enumState.preChat;

    this.onChatStopped.apply(this, arguments); // derived method

    // deleting session cookie
    this.deleteChatFromResume();

    this.hConnectionError.handle();
}
ISQ.Widget.iChat.prototype.chatStopped = function (chatMoved)
{
    var chatInProgress = (this.mState & ISQ.Widget.iChat.enumState.chat) > 0;
    if (!chatInProgress) return;
    //this.mState &= ~ISQ.Widget.iChat.enumState.chat; // removing chat flag
    this.mState &= ~ISQ.Widget.iChat.enumState.requestingChat;

    this.mPendingSessionKey = null;
    
    this.onChatStopped.apply(this, arguments); // derived method
    // deleting session cookie
    this.deleteChatFromResume();

    // if chat stopped and chat was resumed
    if (this.resumingChat())
    {
        // removing flags
        this.mState &= ~ISQ.Widget.iChat.enumState.available;
        this.mState &= ~ISQ.Widget.iChat.enumState.resumeChat;
    }

    // firing handler
    this.hChatEnded.handle.apply(this.hChatEnded, arguments);
}
ISQ.Widget.iChat.prototype.chatError = function ()
{
    if (!this.inChat()) return; // not in chat
    this.mState |= ~ISQ.Widget.iChat.enumState.chat;
    this.mState &= ~ISQ.Widget.iChat.enumState.requestingChat;
    this.onChatError.apply(this, arguments); // derived method

    // if chat stopped and chat was resumed
    if (this.resumingChat())
    {
        // removing flags
        this.mState &= ~ISQ.Widget.iChat.enumState.available;
        this.mState &= ~ISQ.Widget.iChat.enumState.resumeChat;
    }

    // handler
    this.hChatEnded.handle.apply(this.hChatEnded, arguments);
}
ISQ.Widget.iChat.prototype.agentTyping = function(isTyping)
{
    this.hAgentTyping.handle(isTyping);
}
ISQ.Widget.iChat.prototype.saveChatForResume = function ()
{
    var json = this.getDataToSave();
    if (!json) return;
    _session().persistentSession(json);

    clearTimeout(this.mCookieTimer);
    var mthis = this;
    this.mCookieTimer = setTimeout(function ()
    {
        _session().persistentSession(json);
        mthis.mCookieTimer = setTimeout(arguments.callee, 10 * 1000);

    }, 10 * 1000); // 10 seconds -> saving session

}
ISQ.Widget.iChat.prototype.deleteChatFromResume = function ()
{
    clearTimeout(this.mCookieTimer);
    _session().deleteSession();
    ISQ.Widget.CDC.sendMessage("subject=chatEnded");
    //ISQ.Tools.Storage.remove(ISQ.Widget.iChat.chatCookieName, true);
    //ISQ.Http.Cookies._delete(ISQ.Widget.iChat.chatCookieName, '/widget', ISQ.Http.domain());
}
ISQ.Widget.iChat.prototype.getChatToResume = function ()
{
    var json = _session().loadSession();
    if (!json.result) return null;
    return json;

    var data = ISQ.Tools.Storage.get(ISQ.Widget.iChat.chatCookieName, true);
    if (!data)
    {
        data = ISQ.Http.Cookies._read(ISQ.Widget.iChat.chatCookieName);
        if (data) data = unescape(data);
    }
    if (!data) return null;
    ISQ.Tools.Storage.remove(ISQ.Widget.iChat.chatCookieName, true);
    ISQ.Http.Cookies._delete(ISQ.Widget.iChat.chatCookieName, "/widget", ISQ.Http.domain());
}
//#endregion

//#region props
ISQ.Widget.iChat.prototype.available = function ()
{
    return (this.mState & ISQ.Widget.iChat.enumState.available) == ISQ.Widget.iChat.enumState.available;
}
ISQ.Widget.iChat.prototype.beforeChatAvailableChanged = function (isAvailable)
{
    // fire handler only once
    isAvailable = isAvailable === true;
    if (this.available() === isAvailable) return;

    if (this.hChatAvailableChanged) this.hChatAvailableChanged.handle(isAvailable);
}
ISQ.Widget.iChat.prototype.inPreChat = function ()
{
    return (this.mState & ISQ.Widget.iChat.enumState.preChat) == ISQ.Widget.iChat.enumState.preChat;
}
ISQ.Widget.iChat.prototype.resumingChat = function ()
{
    return (this.mState & ISQ.Widget.iChat.enumState.resumeChat) == ISQ.Widget.iChat.enumState.resumeChat;
}
ISQ.Widget.iChat.prototype.inChat = function()
{
    return (this.mState & ISQ.Widget.iChat.enumState.chat) == ISQ.Widget.iChat.enumState.chat;
}
ISQ.Widget.iChat.prototype.requestingChat = function ()
{
    return (this.mState & ISQ.Widget.iChat.enumState.requestingChat) == ISQ.Widget.iChat.enumState.requestingChat;
}
ISQ.Widget.iChat.prototype.userActive = function ()
{
    return (this.mState & ISQ.Widget.iChat.enumState.userActive) == ISQ.Widget.iChat.enumState.userActive;
}
ISQ.Widget.iChat.prototype.pendingMessages = function ()
{
    return this.mPendingMessages;
}
ISQ.Widget.iChat.prototype.setVisitorId = function (){}
//#endregion
ISQ.Widget.iChat.prototype.mActive = true;
//#region handlers
ISQ.Widget.iChat.prototype.hChatStarted = null;
ISQ.Widget.iChat.prototype.hChatEnded = null;
ISQ.Widget.iChat.prototype.hIncomingMessage = null;
ISQ.Widget.iChat.prototype.hAgentTyping = null;
ISQ.Widget.iChat.prototype.hResumingChat = null;
ISQ.Widget.iChat.prototype.hChatRequested = null;
ISQ.Widget.iChat.prototype.hChatAvailableChanged = null;
ISQ.Widget.iChat.prototype.hConnectionError = null;

ISQ.Widget.iChat.prototype.handleCDCMessage = function (messageObject) { }
//#endregion


//#region members
ISQ.Widget.iChat.prototype.mConfig = null;
ISQ.Widget.iChat.prototype.mState = ISQ.Widget.iChat.enumState.init;
ISQ.Widget.iChat.prototype.mPendingMessages = null;
ISQ.Widget.iChat.prototype.mMessagesQueue = null;
ISQ.Widget.iChat.prototype.mChatSurvey = null;
ISQ.Widget.iChat.prototype.mUserTyping = false;
ISQ.Widget.iChat.prototype.mCookieTimer = null;
//#endregion

//#region chat survey
///////////////////////////////////////////////////////////
// creating instance
ISQ.Widget.iChat.ChatSurvey = ISQ.Base.extend({name: "ISQ.Widget.iChat.ChatSurvey", abstractClass: true});
ISQ.Widget.iChat.ChatSurvey.abstractClass.onSubmit;
ISQ.Widget.iChat.ChatSurvey.abstractClass.onBuild;
ISQ.Widget.iChat.ChatSurvey.abstractClass.init;
ISQ.Widget.iChat.ChatSurvey.abstractClass.onSurveyFinished;
// constructor
ISQ.Widget.iChat.ChatSurvey.prototype.ctor = function()
{
    ISQ.Widget.Suggestions.hide(_('chatSuggestions'));
    ISQ.Widget.Suggestions.hide(_('searchSuggestions'));
}
// destructor
ISQ.Widget.iChat.ChatSurvey.prototype.dtor = function()
{
    _('actionBarChatSurvey').style.display = 'none';
}
// set chat state
ISQ.Widget.iChat.ChatSurvey.prototype.setChatState = function(surveyType)
{
    switch(surveyType)
    {
        case "pre":
            ISQ.Widget.iChat.instance.mState |= ISQ.Widget.iChat.enumState.preChat;
            break;
            
    }
}
// build survey
ISQ.Widget.iChat.ChatSurvey.prototype.build = function(data)
{
    ISQ.Widget.Chat.prepereSurveyPane(); // show chat pane prepere for survey UI
    this.showLoadingAnim(ISQ.Widget.HTML.chatPane); // show loading animation
    this.onBuild(data, ISQ.Widget.HTML.chatPane);
}
// show survey
ISQ.Widget.iChat.ChatSurvey.prototype.showSurvey = function (container)
{
    this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);
    this.mLoadingAnimation.dispose();
    // saving pointer
    this.mSurveyContainer = container;
    // showing survey pane
    container.style.direction = ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage]["dir"];
    _('chatSurveySubmitButton').innerHTML = ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage]["sendBtn"];
    _('chatSurveyCloseButton').innerHTML = ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage]["cancel"];
    // fix content widths in ie6,7
    ISQ.Widget.HTML.fixContentWidths();

    var func = function ()
    {
        // show action bar
        _('actionBarChatSurvey').style.display = 'block';
        _('actionBarQuery').style.display = 'none';

        // send message in dynamic size mode
        ISQ.Widget.HTML.dynamicSize_sendMessage();
    }
    // fade in survey container
    if (ISQ.Widget.HTML.canPerformFade(this.mSurveyContainer))
    {
        if (this.mFader === null)
        {
            this.mFader = new VisualEffects.Fade(this.mSurveyContainer);
            this.mFader.fadeInEvent.addHandler(func);
        }

        // setting display & opacity
        this.mFader.setOpacity(0);

        // fading in
        this.mFader.fadeIn(200, true);
    }
    else
    {
        func();
    }
}
// cancel survey
ISQ.Widget.iChat.ChatSurvey.prototype.surveyCanceled = function ()
{
    // restore previous widget state
    ISQ.Widget.Chat.endChat(this.mState, true);
    // disposing survey instance
    this.dispose();
}
// finish survey
ISQ.Widget.iChat.ChatSurvey.prototype.surveyFinished = function ()
{
    /// not in pre-chat survey, notifying widget chat ended
    //if ((ISQ.Widget.iChat.instance.mState & ISQ.Widget.iChat.enumState.preChat) != ISQ.Widget.iChat.enumState.preChat)


    this.onSurveyFinished();

    // hiding load animation on empty survey (#12286)
    _('widgetBlocker').style.display = 'none';
    if (this.mLoadingAnimation && this.mLoadingAnimation.animDiv) {
        this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);
        this.mLoadingAnimation.dispose();
    }

    this.dispose(); // disposing this
}
// submit survey
ISQ.Widget.iChat.ChatSurvey.prototype.submitSurvey = function ()
{   
     // show loading animation
     this.showLoadingAnim(clearNode(_('blockerContent')));
     _('widgetBlocker').style.display = 'block';
 
     // height fix for IE6,7
     if (ISQ.Http.browser.isIE7 || ISQ.Http.browser.isIE6) _('widgetBlocker').style.height = ISQ.Widget.HTML.contentWrapper.offsetHeight;

     if (!this.onSubmit())
     {
         _('widgetBlocker').style.display = 'none';
        this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);
        this.mLoadingAnimation.dispose();
     }; 
}
// survey submitted successfully
ISQ.Widget.iChat.ChatSurvey.prototype.submitSurveySuccess = function (result, content, pageReload)
{
    _('widgetBlocker').style.display = 'none';
    if(this.mLoadingAnimation.animDiv)
    {
        this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);
        this.mLoadingAnimation.dispose();
    }
    
    this.closeSurvey(result, pageReload); 
}
ISQ.Widget.iChat.ChatSurvey.prototype.submitSurveyError = function (result)
{
    _('widgetBlocker').style.display = 'none';
    if (this.mLoadingAnimation.animDiv)
    {
        this.mLoadingAnimation.animDiv.parentNode.removeChild(this.mLoadingAnimation.animDiv);
        this.mLoadingAnimation.dispose();
    }
    this.surveyCanceled();
}
ISQ.Widget.iChat.ChatSurvey.prototype.closeSurvey = function (continueToChat, pageReload)
{
    var action = null;
    var mthis = this;
    if((ISQ.Widget.iChat.instance.mState & ISQ.Widget.iChat.enumState.preChat) == ISQ.Widget.iChat.enumState.preChat)
    {
        action = function()
        {
            if(continueToChat) mthis.surveyFinished();
            else mthis.surveyCanceled();

            // removing flag
            ISQ.Widget.iChat.instance.mState &= ~ISQ.Widget.iChat.enumState.preChat;  
        }  
    }
    else 
    {
        
        action = function()
        {
            mthis.surveyFinished();
        }
    }
    
    if (!pageReload && ISQ.Widget.HTML.canPerformFade(this.mSurveyContainer))
    {
        this.mFader.fadeOutEvent.clear();
        this.mFader.fadeOutEvent.addHandler(action);
        this.mFader.fadeOut(100);
    }
    else
    {
        action();
    }
}
// loading animator
ISQ.Widget.iChat.ChatSurvey.prototype.showLoadingAnim = function (parentNode)
{
    var animDiv = createDiv(parentNode, '.surveyLoading');
    var div = createDiv(animDiv, 'float:left;').innerHTML = 'Please wait...';
    this.mLoadingAnimation = new ISQ.GUI.ProgressAnimation(
    {
        container: createDiv(animDiv, '.searchAnim &float:left;')
    });
    this.mLoadingAnimation.show();
    this.mLoadingAnimation.animDiv = animDiv;
}
ISQ.Widget.iChat.ChatSurvey.prototype.mLoadingAnimation = null;
ISQ.Widget.iChat.ChatSurvey.prototype.mSurveyContainer = null;
ISQ.Widget.iChat.ChatSurvey.prototype.mFader = null;;
// #region Chat Providers
ISQ.Widget.Proxy = initializeNS('ISQ.Widget.Proxy');
ISQ.Widget.Proxy.Chat =
{
    sendMessage: function (targetArray, msg)
    {
        _it(targetArray, function (widget)
        {
            widget.cdcUser.sendMessage("subject=chat&" + msg);
        });
    }
};

ISQ.Widget.Proxy.Chat.LiveChatInc =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else // startChat
            LC_API.open_chat_window();
    },
    load: function (options, widget)
    {
        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage([widget], "type=available&data=" + this.mAvailable);
                else
                {
                    if (this.mAvailable === "true")
                    {
                        widget.mState |= ISQ.Widget.iChat.enumState.available;
                    }
                    else
                    {
                        widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                    }
                }
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;

        // if script already loaded on page...
        var x = document.head.getElementsByTagName('script');
        for (var i = 0; i < x.length; i++)
        {
            if (x[i].src.indexOf('livechatinc') != -1)
            {
                this.mAvailable = LC_API.agents_are_available(); // saving availability result
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage([widget], "type=available&data=" + this.mAvailable);
                else
                {
                    if (this.mAvailable === "true")
                    {
                        widget.mState |= ISQ.Widget.iChat.enumState.available;
                    }
                    else
                    {
                        widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                    }
                }
                // resetting array
                //this.mPendingWidgets = [];
                // updating state
                this.mState = this.enumStates.availabilityReceived;
                return;
            }

        }
        //////////////////////////////////////////////////////////
        window.__lc = {};
        window.LC_API = {};
        window.__lc.license = options.LiveChatInc.id; // getting id
        // on chat ended, close the chat float
        window.LC_API.on_chat_ended = function ()
        {
            window.LC_API.hide_chat_window();
        };
        // on chat started, open chat ( if in float mode )
        if (!options.popup.enabled)
            window.LC_API.on_chat_started = function (data)
            {
                window.LC_API.open_chat_window();
            };
        var mthis = this;

        window.LC_API.on_before_load = function ()
        {
            window.LC_API.hide_chat_window();
        }

        window.LC_API.on_after_load = function ()
        {
            //if chat not running or popup enabled, hide the chat window after loading as it should not appear 
            if (!window.LC_API.chat_running() || options.popup.enabled)
                window.LC_API.hide_chat_window();

            mthis.mAvailable = LC_API.agents_are_available(); // saving availability result
            // sending message
            if (widget.cdcUser)
                ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
            else
            {
                if (mthis.mAvailable == true)
                {
                    widget.mState |= ISQ.Widget.iChat.enumState.available;
                }
                else
                {
                    widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                }
            }

            // resetting array
            //mthis.mPendingWidgets = [];
            // updating state
            mthis.mState = mthis.enumStates.availabilityReceived;
        };
        // loading LP script
        url = "//" + options.LiveChatInc.server + "/tracking.js";
        ISQ.Tools.appendScript(url);
    }
};



ISQ.Widget.Proxy.Chat.Zopim =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else // startChat
        {
            if (options.popup.enabled)
            {
                $zopim.livechat.window.openPopout();
            }
            else
            {
                $zopim.livechat.window.show();
            }
        }
    },
    load: function (options, widget)
    {
        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage([widget], "type=available&data=" + this.mAvailable);
                else
                {
                    if (this.mAvailable == true)
                    {
                        widget.mState |= ISQ.Widget.iChat.enumState.available;
                    }
                    else
                    {
                        widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                    }
                }
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;

        var mthis = this;
        var zopimScript_Loaded = function ()
        {
            if (!$zopim.livechat) return;
            // if already chatting, don't close the chat window.
            if (!$zopim.livechat.isChatting() || options.popup.enabled)
                $zopim.livechat.hideAll();

            // on chat end, closing the floating widget
            $zopim.livechat.setOnChatEnd(function ()
            {
                $zopim.livechat.hideAll();
            });
            // on hiding chat box, if chat not running close it.
            $zopim.livechat.window.onHide(function ()
            {
                if (!$zopim.livechat.isChatting() || options.popup.enabled)
                    $zopim.livechat.hideAll();
            });



            var agentStatusDetector = function (agentStatus)
            {
                if (agentStatus == "online")
                    mthis.mAvailable = true;
                else
                    mthis.mAvailable = false;

                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
                else
                {
                    if (mthis.mAvailable == true)
                    {
                        widget.mState |= ISQ.Widget.iChat.enumState.available;
                    }
                    else
                    {
                        widget.mState &= ~ISQ.Widget.iChat.enumState.available;
                    }
                }
                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            }
            // hide widget from view

            // request to know if agent is available
            $zopim.livechat.setOnStatus(agentStatusDetector);
        }


        // if script already loaded on page...
        var x = document.head.getElementsByTagName('script');
        for (var i = 0; i < x.length; i++)
        {
            if (x[i].src.indexOf('zopim') != -1)
            {
                zopimScript_Loaded();
                return;
            }
        }

        // zopim script
        window.$zopim || (function (d, s)
        {
            var z = $zopim = function (c) { z._.push(c) }, $ = z.s =
        d.createElement(s), e = d.getElementsByTagName(s)[0]; z.set = function (o)
        {
            z.set.
        _.push(o)
        }; z._ = []; z.set._ = []; $.async = !0; $.setAttribute('charset', 'utf-8');
            $.src = (window.location.protocol === 'https:' ? 'https:' : "http:") + options.Zopim.server + '?' + options.Zopim.id; z.t = +new Date; $.type = 'text/javascript';
            if (zopimScript_Loaded)
            {
                // most browsers
                if (ISQ.Http.browser.app !== "ie" || ISQ.Http.browser.isIE11)
                    $.onload = zopimScript_Loaded;
                else
                {
                    // ie
                    $.onreadystatechange = function ()
                    {
                        if (this.readyState !== 'complete' && this.readyState !== 'loaded') return;
                        zopimScript_Loaded();
                    }
                }
            }
            e.parentNode.insertBefore($, e);
        })(document, 'script');
        // end zopim script
    }
};

ISQ.Widget.Proxy.Chat.SnapEngage =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else // startChat
            SnapEngage.startLink();
    },
    load: function (options, widget)
    {
        var mthis = this;

        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;
        var SnapEngage_Loaded = function ()
        {
            if (typeof SnapEngage == "undefined") return;
            SnapEngage.hideButton();
            SnapEngage.getAgentStatusAsync(function (online)
            {
                if (online)
                    mthis.mAvailable = true;
                else
                    mthis.mAvailable = false;
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);

                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            });
            SnapEngage.setCallback('Close', function (type, status)
            {
                SnapEngage.hideButton();
            });
        }
        // if script already loaded on page...
        var x = document.head.getElementsByTagName('script');
        for (var i = 0; i < x.length; i++)
        {
            if (x[i].src.indexOf('snapengage') != -1)
            {
                SnapEngage_Loaded();
                return;
            }
        }
        var url = (window.location.protocol === 'https:' ? 'https:' : "http:") + options.SnapEngage.server + options.SnapEngage.id + ".js";
        ISQ.Tools.appendScript(url, SnapEngage_Loaded);
    }
};





ISQ.Widget.Proxy.Chat.Olark =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else // startChat
            olark('api.box.expand');

    },
    load: function (options, widget)
    {

        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage([widget], "type=available&data=" + this.mAvailable);
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;

        var mthis = this;
        var olark_Loaded = function ()
        {
            var updateAvailability = function (isOnline)
            {
                mthis.mAvailable = isOnline;
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);

                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            }

            olark.configure('box.start_hidden', true);
            //olark('api.box.hide');
            olark('api.chat.onOperatorsAvailable', function ()
            {
                updateAvailability(true);
            });
            olark('api.chat.onOperatorsAway', function ()
            {
                updateAvailability(false);
            });
        }
        // if script already loaded on page...
        var x = document.head.getElementsByTagName('script');
        for (var i = 0; i < x.length; i++)
        {
            if (x[i].src.indexOf('olark') != -1)
            {
                olark_Loaded();
                return;
            }
        }

        window.olark || (function (c)
        {
            var f = window, d = document, l = f.location.protocol == "https:" ? "https:" : "http:", z = c.name, r = "load"; var nt = function ()
            {
                f[z] = function ()
                {
                    (a.s = a.s || []).push(arguments)
                }; var a = f[z]._ = {
            }, q = c.methods.length; while (q--)
            {
                (function (n)
                {
                    f[z][n] = function ()
                    {
                        f[z]("call", n, arguments)
                    }
                })(c.methods[q])
            } a.l = c.loader; a.i = nt; a.p = {
                0: +new Date
            }; a.P = function (u)
            {
                a.p[u] = new Date - a.p[0]
            }; function s()
            {
                a.P(r); f[z](r)
            } f.addEventListener ? f.addEventListener(r, s, false) : f.attachEvent("on" + r, s); var ld = function ()
            {
                function p(hd)
                {
                    hd = "head"; return ["<", hd, "></", hd, "><", i, ' onl' + 'oad="var d=', g, ";d.getElementsByTagName('head')[0].", j, "(d.", h, "('script')).", k, "='", l, "//", a.l, "'", '"', "></", i, ">"].join("")
                } var i = "body", m = d[i]; if (!m)
                {
                    return setTimeout(ld, 100)
                } a.P(1); var j = "appendChild", h = "createElement", k = "src", n = d[h]("div"), v = n[j](d[h](z)), b = d[h]("iframe"), g = "document", e = "domain", o; n.style.display = "none"; m.insertBefore(n, m.firstChild).id = z; b.frameBorder = "0"; b.id = z + "-loader"; if (/MSIE[ ]+6/.test(navigator.userAgent))
                {
                    b.src = "javascript:false"
                } b.allowTransparency = "true"; v[j](b); try
                {
                    b.contentWindow[g].open()
                } catch (w)
                {
                    c[e] = d[e]; o = "javascript:var d=" + g + ".open();d.domain='" + d.domain + "';"; b[k] = o + "void(0);"
                } try
                {
                    var t = b.contentWindow[g]; t.write(p()); t.close()
                } catch (x)
                {
                    b[k] = o + 'd.write("' + p().replace(/"/g, String.fromCharCode(92) + '"') + '");d.close();'
                } a.P(2)
            }; ld()
        }; nt()
    })({
        loader: "static.olark.com/jsclient/loader0.js", name: "olark", methods: ["configure", "extend", "declare", "identify"]
    });

    olark.identify(options.Olark.id);
    olark_Loaded();

}
};

ISQ.Widget.Proxy.Chat.LiveEngage =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    log: function(entry) {
        _it(this.mPendingWidgets, function (widget) {
            if (widget.cdcUser)
                widget.cdcUser.sendMessage("subject=widgetLog&entry=" + entry);
        });
    },
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else
        {
            this.log('LivePerson LE2: opening chat window');
        
            if (window.lpTag.taglets.rendererStub.click(options.LiveEngage.engagementId)) { // startChat
                this.log('LivePerson LE2: chat window opened');

                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(this.mPendingWidgets, "type=vendorwindowopened");
            }
        }
    },
    load: function (options, widget)
    {
        var mthis = this;

        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;


        var LiveEngage_Loaded = function ()
        {
            mthis.log('LivePerson LE2: API Loaded');

            var updateAvailability = function (engagementId, isOnline)
            {
                mthis.log('LivePerson LE2: Availability (' + engagementId + ':' + isOnline + ')');

                mthis.mAvailable = isOnline;
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);

                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            }

            // poll for agent availability changes
            var engagementsMap = {};
            engagementsMap[options.LiveEngage.engagementId] = {};
            setInterval(function() {
                var engagement, activeEngagementState;
                for (var engagementId in engagementsMap) {
                    if (engagementsMap.hasOwnProperty(engagementId)) {
                        engagement = engagementsMap[engagementId];
                        activeEngagementState = window.lpTag.taglets.rendererStub.getEngagementState(engagementId).state;
                        if (engagement.state !== activeEngagementState) {
                            engagement.state = activeEngagementState;
                            updateAvailability(engagementId, engagement.state === 1)
                        }
                    }
                }
            }, 500);
        };

        // container is required by button and must be presented in page
        if (!document.getElementById('LivePersonChat')) {
            var container = document.createElement('div');
            container.id = 'LivePersonChat';
            container.style.display = 'none';
            document.body.appendChild(container);
        }

        mthis.log('LivePerson LE2: injecting API');

        // inject LiveEngage Embed code
        window.lpTag=window.lpTag||{};if(typeof window.lpTag._tagCount==='undefined'){window.lpTag={site:options.LiveEngage.id||'',section:lpTag.section||'',autoStart:lpTag.autoStart===false?false:true,ovr:lpTag.ovr||{},_v:'1.5.1',_tagCount:1,protocol:location.protocol,events:{bind:function(app,ev,fn){lpTag.defer(function(){lpTag.events.bind(app,ev,fn);},0);},trigger:function(app,ev,json){lpTag.defer(function(){lpTag.events.trigger(app,ev,json);},1);}},defer:function(fn,fnType){if(fnType==0){this._defB=this._defB||[];this._defB.push(fn);}else if(fnType==1){this._defT=this._defT||[];this._defT.push(fn);}else{this._defL=this._defL||[];this._defL.push(fn);}},load:function(src,chr,id){var t=this;setTimeout(function(){t._load(src,chr,id);},0);},_load:function(src,chr,id){var url=src;if(!src){url=this.protocol+'//'+((this.ovr&&this.ovr.domain)?this.ovr.domain:'lptag.liveperson.net')+'/tag/tag.js?site='+this.site;}var s=document.createElement('script');s.setAttribute('charset',chr?chr:'UTF-8');if(id){s.setAttribute('id',id);}s.setAttribute('src',url);document.getElementsByTagName('head').item(0).appendChild(s);},init:function(){this._timing=this._timing||{};this._timing.start=(new Date()).getTime();var that=this;if(window.attachEvent){window.attachEvent('onload',function(){that._domReady('domReady');});}else{window.addEventListener('DOMContentLoaded',function(){that._domReady('contReady');},false);window.addEventListener('load',function(){that._domReady('domReady');},false);}if(typeof(window._lptStop)=='undefined'){this.load();}},start:function(){this.autoStart=true;},_domReady:function(n){if(!this.isDom){this.isDom=true;this.events.trigger('LPT','DOM_READY',{t:n});}this._timing[n]=(new Date()).getTime();},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],ev:lpTag.ev||[]};lpTag.init();}else{window.lpTag._tagCount+=1;}

        // bind to events
        window.lpTag.events.bind('LE_ENGAGER',  'SHOW', function() {
            LiveEngage_Loaded();
        });
        window.lpTag.events.bind('lpUnifiedWindow', 'windowClosed', function() {
            mthis.log('LivePerson LE2: chat window closed');

            // sending message
            if (widget.cdcUser)
                ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=vendorwindowclosed");
        });
    }
};


ISQ.Widget.Proxy.Chat.SalesForce =
{
    enumStates: { none: 0, loaded: 1, availabilityReceived: 2 },
    mState: 0,
    mAvailable: false,
    mPendingWidgets: [],
    log: function(entry) {
        _it(this.mPendingWidgets, function (widget) {
            if (widget.cdcUser)
                widget.cdcUser.sendMessage("subject=widgetLog&entry=" + entry);
        });
    },
    start: function (action, options, widget)
    {
        if (action == "loadChat")
            this.load(options, widget);
        else
        {
            this.log('SalesForce: opening chat window');

            // support custom popup size
            if (options.popup && options.popup.size && options.popup.size.length === 2) {
                window.liveagent.setChatWindowWidth(+options.popup.size[0]);
                window.liveagent.setChatWindowHeight(+options.popup.size[1]);
            }

            window.liveagent.startChat(options.SalesForce.buttonId);
        }
    },
    load: function (options, widget)
    {
        var mthis = this;
        if (this.mState >= this.enumStates.loaded)
        {
            // if we got availability
            if (this.mState >= this.enumStates.availabilityReceived)
            {
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);
            }
            else // availability wasn't processed yet, adding widget to array
            {
                this.mPendingWidgets.push(widget);
            }
            return;
        }
        else
        {
            this.mPendingWidgets.push(widget);
        }
        this.mState = this.enumStates.loaded;

        // NOTE:
        // according to the SalesForm API hostname is unique per organization
        // and another hostnames actually returns the same script
        // so we probably can keep using our hostname here
        var hostName = options.SalesForce.hostName || 'la1-c2-lon';
        var apiScriptURL = 'https://c.' + hostName + '.salesforceliveagent.com/content/g/js/36.0/deployment.js';

        // create LiveAgent events array if not created yet
        if (!window._laq) { window._laq = []; }
        window._laq.push(function() {
            window.liveagent.showWhenOnline(options.SalesForce.buttonId, document.createElement('div'));
            window.liveagent.showWhenOffline(options.SalesForce.buttonId, document.createElement('div'));
        });

        // API Loaded callback
        var SalesForce_Loaded = function ()
        {
            mthis.log('SalesForce: API Loaded');

            // uncomment the following line to enable logging in console (might be useful for development)
            // window.liveagent.enableLogging();

            // handle online/offline events
            window.liveagent.addButtonEventHandler(options.SalesForce.buttonId, function(eventType) {
                switch (eventType) {
                    case window.liveagent.BUTTON_EVENT.BUTTON_AVAILABLE:
                        updateAvailability(options.SalesForce.buttonId, true);
                        break;
                    case window.liveagent.BUTTON_EVENT.BUTTON_UNAVAILABLE:
                        updateAvailability(options.SalesForce.buttonId, false);
                        break;
                    case window.liveagent.BUTTON_EVENT.BUTTON_ACCEPTED:
                        mthis.log('SalesForce: chat window opened');
                        // sending message
                        // if (widget.cdcUser)
                        //     ISQ.Widget.Proxy.Chat.sendMessage(this.mPendingWidgets, "type=vendorwindowopened");
                        break;
                    case window.liveagent.BUTTON_EVENT.BUTTON_REJECTED:
                        mthis.log('SalesForce: chat window closed');
                        // sending message
                        // if (widget.cdcUser)
                        //     ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=vendorwindowclosed");
                        break;
                }
            });

            // script is loaded -> initialize liveagent provider
            window.liveagent.init('https://d.' + hostName + '.salesforceliveagent.com/chat',  options.SalesForce.deploymentId,  options.SalesForce.organizationId);

            var updateAvailability = function (buttonId, isOnline)
            {
                mthis.log('SalesForce: Availability (' + buttonId + ':' + isOnline + ')');

                mthis.mAvailable = isOnline;
                // sending message
                if (widget.cdcUser)
                    ISQ.Widget.Proxy.Chat.sendMessage(mthis.mPendingWidgets, "type=available&data=" + mthis.mAvailable);

                // resetting array
                //mthis.mPendingWidgets = [];
                // updating state
                mthis.mState = mthis.enumStates.availabilityReceived;
            }
        };

        // load API script dynamically
        mthis.log('SalesForce: injecting API');
        var se = document.createElement('script'); se.type = 'text/javascript'; se.async = true;
        se.src = apiScriptURL;
        var done = false;
        se.onload = se.onreadystatechange = function() {
            if (!done&&(!this.readyState||this.readyState === 'loaded'||this.readyState === 'complete')) {
                SalesForce_Loaded();
            }
        };
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(se, s);
    }
};

// #endregion ;

ISQ.Translation = {};
ISQ.Translation.Infra = {};
ISQ.Translation.Infra.rtlLanguages = { iw: true, ar: true, ur: true, yi: true, he: true };
ISQ.Translation.Infra.getLanguageDirection = function (langCode) { return ISQ.Translation.Infra.rtlLanguages[langCode] == null ? 'ltr' : 'rtl'; };
//#endregion

/********************************************************
////////////////////// [ LOG ] //////////////////////////
********************************************************/
//#region log
ISQ.Widget.Log = initializeNS('ISQ.Widget.Log');
ISQ.Widget.Log.statusEnum = { RED: 1, GREEN: 2 };

// sets the debug to On //
ISQ.Widget.Log.openPopup = function ()
{
    if (!ISQ.Widget.Debug.enabled) return;
    if (ISQ.Widget.Log.window && !ISQ.Widget.Log.window.closed)
        ISQ.Widget.Log.window.focus();
    else
        ISQ.Widget.Log.on();
};
ISQ.Widget.Log.on = function ()
{
    var width = 560;
    var left = screen.width - width - 20;

    ISQ.Widget.Debug.enabled = false;
    var win = window.open("", "nanoRepLog", "width=" + width + ",height=330,left=" + left + ",top=0,scrollbars=yes");

    // failed to create window
    if (!win) return;
    if (!win.document) return;

    // open new document
    try
    {
        win.document.open();
        win.document.write("<html><title>widget log</title>");
        win.document.write("<body style='margin:10px; font-size:12px; font-family:arial;'>");
        win.document.write("<div id='logComments' style='width:95%; height:100%;'>");

        // append any msgs
        if (ISQ.Widget.Log.messages)
        {
            win.document.write(ISQ.Widget.Log.messages.join(''));
            ISQ.Widget.Log.messages = null;
        }

        win.document.write("</div></body></html>");

        // close the document
        win.document.close();

        ISQ.Widget.Log.window = win;

        ISQ.Widget.Log.element = win.document.getElementById('logComments');
        ISQ.Widget.Debug.enabled = true;

        // auto scroll
        ISQ.Widget.Log.autoScroll();
    }
    catch (e)
    {
        ISQ.Widget.Debug.enabled = false;
    }
};
ISQ.Widget.Log.add = function (txt, status)
{
    try
    {
        if (!ISQ.Widget.Debug.enabled) return;

        status = status || ISQ.Widget.Log.statusEnum.GREEN;

        var color = '';
        if (status === ISQ.Widget.Log.statusEnum.GREEN)
            color = '#006600';
        else if (status === ISQ.Widget.Log.statusEnum.RED)
        {
            color = '#BB0000';
            ISQ.Widget.Log.openPopup();
        }

        var d = new Date();
        var msg = [];
        msg.push(d.ToString("%d/%m/%y %H:%M:%S"));
        msg.push("  -  ");
        msg.push(txt);

        if (ISQ.Widget.Log.element)
        {
            // adding <span>
            var font = ISQ.Widget.Log.window.document.createElement("span");
            font.style.color = color;
            font.innerHTML = msg.join('');
            ISQ.Widget.Log.element.appendChild(font);

            // adding br
            var br = ISQ.Widget.Log.window.document.createElement("br", ISQ.Widget.Log.element);
            ISQ.Widget.Log.element.appendChild(br);

            // auto scroll
            ISQ.Widget.Log.autoScroll();
        }
        else
        {
            if (!ISQ.Widget.Log.messages) ISQ.Widget.Log.messages = [];

            ISQ.Widget.Log.messages.push('<span style="color:');
            ISQ.Widget.Log.messages.push(color);
            ISQ.Widget.Log.messages.push('">');
            ISQ.Widget.Log.messages.push(msg.join(''));
            ISQ.Widget.Log.messages.push('</span>');
            ISQ.Widget.Log.messages.push('<br/>');
        }
    }
    catch (e)
    { }
};
ISQ.Widget.Log.autoScroll = function ()
{
    var currHeight = ISQ.Widget.Log.window.document.body.scrollHeight;
    var visibleHeight = ISQ.Widget.Log.window.document.body.offsetHeight;
    if (currHeight > visibleHeight)
        ISQ.Widget.Log.window.document.body.scrollTop = currHeight - visibleHeight;
};

//////////////////////////////////////////////////////////////////////////
// members
ISQ.Widget.Log.element = null;
ISQ.Widget.Log.window = null;
ISQ.Widget.Log.alwaysOn = false;
ISQ.Widget.Log.messages = null;
//#endregion

/********************************************************
///////////////////// [ DEBUG ] /////////////////////////
 *******************************************************/
//#region debug
ISQ.Widget.Debug = initializeNS('ISQ.Widget.Debug');
ISQ.Widget.Debug.enabled = false;
ISQ.Widget.Debug.register = function ()
{
    if (document.addEventListener)
        document.addEventListener('keyup', ISQ.Widget.Debug.keyUpEvent, true);
    else if (document.attachEvent)
        document.attachEvent('onkeyup', ISQ.Widget.Debug.keyUpEvent);
};
ISQ.Widget.Debug.keyUpEvent = function (event4FF)
{
    var e = event4FF || window.event;
    if (e.shiftKey && e.ctrlKey)
    {
        if (e.keyCode == 81 || e.keyCode == 87) // ctrl+shift+q || ctrl+shift+w
            ISQ.Widget.Log.openPopup();
        else if (e.keyCode === 90)
            ISQ.Widget.Debug.togglePopup();
    }
};
ISQ.Widget.Debug.togglePopup = function()
{
    var dis = _('debugPopup').style.display;

    if (dis === 'block')
        _('debugPopup').style.display = 'none';
    else
        _('debugPopup').style.display = 'block';
};
ISQ.Widget.Debug.closeSession = function()
{
    _session().die();

    ISQ.Widget.Debug.togglePopup();
};

// overwriting ISQ.Debug.insertText
ISQ.Debug.insertText = function (txt, type)
{
    if (!debugLevel) return;
    type = type || ISQ.Widget.Log.statusEnum.RED;
    ISQ.Widget.Log.add(txt, type);
};
//#endregion

/********************************************************
///////////////////// [ INIT ] //////////////////////////
********************************************************/
//#region init

//////////////////////////////////////////////////////////////////////////
// widget UI init
ISQ.Widget.init = function ()
{
    var customParams;
    // log
    var debug = ISQ.Http.hashArguments["debug"];
    if (debugLevel || (typeof (debug) !== 'undefined' && (debug === 'true' || debug === 'isq')))
    {
        ISQ.Widget.Debug.register(); //registering events to open debug window
        ISQ.Widget.Debug.enabled = true;
        if (ISQ.Widget.Log.alwaysOn) ISQ.Widget.Log.on();
    }

    //////////////////////////////////////////////////////////////////////////
    // fix eval bug in ff 3.6 (#3593)
    if (ISQ.Http.browser.isFF3) eval('[0,1]');

    // Get custom params
    customParams = ISQ.Http.hashArguments['params'] || ISQ.Http.urlArguments['params'];
    if (customParams) ISQ.Widget.API.customParams = ISQ.Widget.parseCustomParams(customParams);

    // getting referer
    var refencoded = false;
    if (ISQ.Http.hashArguments["referer"])
    {
        ISQ.Widget.referer.normal = ISQ.Http.hashArguments["referer"];
        ISQ.Widget.referer.encoded = ISQ.Http.hashArguments["refencoded"] == 'true';
    }
    else if (ISQ.Http.urlArguments["referer"])
    {
        ISQ.Widget.referer.normal = ISQ.Http.urlArguments["referer"];
        ISQ.Widget.referer.encoded = ISQ.Http.urlArguments["refencoded"] == 'true';
    }
    else
    {
        ISQ.Widget.referer.normal = "";
    }

    // base64 decode
    if (ISQ.Widget.referer.normal && ISQ.Widget.referer.encoded)
        ISQ.Widget.referer.normal = ISQ.Http.Cookies.decode64(ISQ.Widget.referer.normal);

    var ndx = ISQ.Widget.referer.normal.toLowerCase().indexOf("%3a");
    if (ndx > 6 || ndx === -1)
    {
        ISQ.Widget.referer.escaped = escape(ISQ.Widget.referer.normal);
    }
    else
    {
        ISQ.Widget.referer.escaped = ISQ.Widget.referer.normal;
        ISQ.Widget.referer.normal = unescape(ISQ.Widget.referer.normal);
    }

    ISQ.Widget.account = ISQ.Http.hashArguments["account"] || ISQ.Http.urlArguments["account"];
    //ISQ.Widget.dynamicHost = ISQ.Widget.getDynamicHost();
    ISQ.Widget.configId = ISQ.Http.hashArguments["configid"] || ISQ.Http.urlArguments["configid"];
    ISQ.Widget.Log.add('Initiating a widget for <u>' + ISQ.Widget.account + '</u> account');
    ISQ.Widget.Log.add('Server URL <u>' + ISQ.Http.domain(true) + '</u>');
    ISQ.Widget.Log.add('Widget Referer <u>' + ISQ.Widget.referer.normal + '</u>');

    // cross-domain communication
    ISQ.Widget.cdcFrame = ISQ.Widget.getInnerFrameUrl(ISQ.Http.hashArguments["cdcframe"], ISQ.Widget.referer.normal, true);
    if (ISQ.Widget.cdcFrame) ISQ.Widget.cdcVersion = ISQ.Http.hashArguments["cdcversion"] || "1";

    // splitTestGroup - run widget even thou in split test
    ISQ.Widget.splitTestGroup = ISQ.Http.hashArguments["splittestgroup"];

    // is float
    ISQ.Widget.isFloat = ISQ.Http.hashArguments["isfloat"] === 'true';

    ISQ.Widget.isFullScreen = ISQ.Http.hashArguments["fullscreenmode"] === 'true';

    // dynamic size. embed in mobile devices is automatically dynamic size
    ISQ.Widget.dynamicSize = !ISQ.Widget.isFloat && ISQ.Http.hashArguments["dynamicsize"] === 'true';
    ISQ.Widget.dynamicMaxSize = parseInt(ISQ.Http.hashArguments["dynamicmaxsize"]) || 0;
    if (isNaN(ISQ.Widget.dynamicMaxSize)) ISQ.Widget.dynamicMaxSize = 0;

    // adjustable embed width
    ISQ.Widget.HTML.Mobile.adjustableEmbedWidth = ISQ.Http.browser.isMobile && !ISQ.Http.browser.oldAndroid && !ISQ.Widget.isFloat && window.top !== window;

    // supports CDC:
    ISQ.Widget.sendingCDCMessages = window.top !== window &&  // widget inside an iframe
        (
            ISQ.Widget.supportsPostMessage || // browser supports 'postMessage' (aka cnf was downloaded by parent window) OR
            (ISQ.Widget.cdcFrame && (ISQ.Widget.dynamicSize || ISQ.Widget.isFloat)) // has CDC-Frame and in float or dynamic embed.
        );
    ISQ.Widget.CDC.init();

    //
    var resetCDC = ISQ.Http.Cookies._read("resetcdc");
    if (resetCDC === '1')
    {
        ISQ.Http.Cookies._delete("resetcdc", "/widget", ISQ.Http.domain());
        ISQ.Widget.CDC.sendMessage("subject=reset");
    }

    // load cnf file
    ISQ.Widget.Cnf.load();

    // TO DO: read html collapse size
    var htmlCollapseHeight = ISQ.Http.hashArguments["htmlcollapseheight"];
    if (typeof (htmlCollapseHeight) !== 'undefined')
    {
        ISQ.Widget.HTML.htmlCollapseHeight = parseInt(htmlCollapseHeight);
    }
    // adding '?aid=' to logo links
    // building footer link

    ISQ.Widget.initContext();

};
// load context from storage/cookie
ISQ.Widget.initContext = function ()
{
    var contextFromStorage = null;
    // loading context from localstorage/cookie
    if (window['localStorage'] && !ISQ.Http.browser.isIOS7)
        contextFromStorage = window['localStorage'].getItem("nanorep.wContext" + ISQ.Http.Cookies.encode64(ISQ.Widget.account));
    if (!contextFromStorage)
        contextFromStorage = ISQ.Http.Cookies._readCaseSensitive("nanorep.wContext" + ISQ.Http.Cookies.encode64(ISQ.Widget.account));

    if (contextFromStorage && !ISQ.Widget.contextSetAlready)
    {
        var currentContext = eval("(" + contextFromStorage + ")");
        _session().setContext(currentContext, null, false);
    }
}

ISQ.Widget.embedCallback = null;


//#endregion

/********************************************************
///////////////// [ PAGE UNLOAD ] //////////////////////
********************************************************/
//#region Page unload
ISQ.Widget.pageUnload = function ()
{
    ISQ.Widget.Chat.pageUnload();

    if (ISQ.Widget.Log.element) ISQ.Widget.Log.element.innerHTML = '';
};
//#endregion

/********************************************************
///////////////////// [ CNF ] ///////////////////////////
********************************************************/
//#region cnf
ISQ.Widget.Cnf = initializeNS('ISQ.Widget.Cnf');

///////////// load function ////////////////
ISQ.Widget.Cnf.load = function ()
{
    ////////////////////////////////////////
    // cnf is loaded by float/embed
    if (ISQ.Widget.supportsPostMessage && (window.top !== window && self !== self.top) && ISQ.Http.hashArguments["cnf"] == "true")
    {
        ISQ.Widget.isContained = true;

        // resetting ISQ.Cnf
        ISQ.Cnf = null;

        // sending preload message
        ISQ.Widget.CDC.sendMessage("subject=cnf");
    }
    ////////////////////////////////////////
    // need to download the cnf (IE6,7, mobile devices, browsing to widget.html directly)
    else
    {
        var kb = ISQ.Http.hashArguments["kb"] || ISQ.Http.urlArguments["kb"];
        var cnfDownloadedSecondTime = !ISQ.Widget.supportsPostMessage && window.top !== window;

        ISQ.Tools.appendScript(ISQ.Widget.buildCNFSource(ISQ.Widget.dynamicHost, ISQ.Widget.account, ISQ.Widget.isFloat, kb, ISQ.Widget.referer.escaped, cnfDownloadedSecondTime, ISQ.Widget.splitTestGroup), function ()
        {
            // performing in timeout
            setTimeout(function ()
            {
                // setting CNF object
                if (ISQ.Widget.isFloat)
                    ISQ.Cnf = ISQ.Cnf_Float;
                else
                    ISQ.Cnf = ISQ.Cnf_Embed;

                // in control group
                if (ISQ.Cnf.controlGroup) return;

                // onload script
                var customScript = ISQ.Cnf.customScript;
                delete ISQ.Cnf.customScript;
                if (customScript) try { eval(customScript); } catch (e) { }

                // calling load handler
                ISQ.Widget.Cnf.postDownload();
            }, 0);
        });
    }
};
//
ISQ.Widget.Cnf.postDownload = function ()
{
    ISQ.Widget.loadHandler();
};

/**
* Speech Recognition
*/
ISQ.Widget.Cnf.SpeechRecognition = {};
ISQ.Widget.Cnf.SpeechRecognition.active = false;
ISQ.Widget.Cnf.SpeechRecognition.showClearQueryOnStop = false;
ISQ.Widget.Cnf.SpeechRecognition.listenCommand = false;
ISQ.Widget.Cnf.SpeechRecognition.actions = [];
ISQ.Widget.Cnf.SpeechRecognition.autoStopTimeout = null;
ISQ.Widget.Cnf.SpeechRecognition.idleTime = 2000;
ISQ.Widget.Cnf.SpeechRecognition.waitForCommandTime = 3000;


ISQ.Widget.Cnf.SpeechRecognition.init = function () //loadHadler
{
    var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (SpeechRecognition === null || !ISQ.Widget.isFullScreen) {
        //If speech feature not supported - remove microphone button
        ISQ.Widget.HTML.speechButton.parentNode.removeChild(ISQ.Widget.HTML.speechButton);
        //And delete it from html mapping
        delete ISQ.Widget.HTML.speechButton;

        return;
    }

    //Init recognizer
    var recognizer = ISQ.Widget.Cnf.SpeechRecognition.recognizer = new SpeechRecognition();

    // Sets the type of the recognition (one-shot or continuous)
    recognizer.continuous = true;

    //run onResults callback for all iterim results
    //if false - callback will run only once on end
    recognizer.interimResults = true;

    //Recognitions alternative texts
    recognizer.maxAlternatives = 1;

    // Specifies the recognition language.
    recognizer.lang = ISQ.Widget.TranslationHelper.detectedLanguage || ISQ.Cnf.kbLanguageCode;

    // fired when the speech recognizer returns a result
    recognizer.onresult = ISQ.Widget.Cnf.SpeechRecognition.onResult;

    // fired when the recognition service has begun to listen so user can talk
    //recognizer.onstart = ISQ.Widget.Cnf.SpeechRecognition.onStart;
    recognizer.onaudiostart = ISQ.Widget.Cnf.SpeechRecognition.onStart;

    //  fired when speech servise stopped
    recognizer.onend = ISQ.Widget.Cnf.SpeechRecognition.onEnd;

    // Error callback
    recognizer.onerror = function (event) {
        //Stop recognizer
        ISQ.Widget.Cnf.SpeechRecognition.stop();
        ISQ.Widget.Log.add('Speech recognition error: ' + event.error);
    };

    // Listener for sppech button to start/stop speech recognition
    ISQ.Widget.HTML.speechButton.onclick = function () {
        if (ISQ.Widget.Cnf.SpeechRecognition.active) {
            ISQ.Widget.Cnf.SpeechRecognition.stop();
        } else {
            ISQ.Widget.Cnf.SpeechRecognition.start();
        }
    }

}

ISQ.Widget.Cnf.SpeechRecognition.updateLanguage = function () {
    if (!ISQ.Widget.Cnf.SpeechRecognition.recognizer) return;

    var lang = ISQ.Widget.TranslationHelper.detectedLanguage || ISQ.Cnf.kbLanguageCode || 'en';
    ISQ.Widget.Cnf.SpeechRecognition.recognizer.lang = lang;
}

ISQ.Widget.Cnf.SpeechRecognition.onResult = function (event) {
    if (!ISQ.Widget.Cnf.SpeechRecognition.active) return;

    var text = '';
    for (var i = event.resultIndex; i < event.results.length; i++) {
        if (event.results[i].isFinal) {
            text = event.results[i][0].transcript;
        }
        else {
            text += event.results[i][0].transcript;
        }
    }

    ISQ.Widget.Cnf.SpeechRecognition.log('Results ' + text)

    if (!ISQ.Widget.Cnf.SpeechRecognition.listenCommand) {
        ISQ.Widget.Cnf.SpeechRecognition.processSearchText(text);
    }
    else {
        ISQ.Widget.Cnf.SpeechRecognition.processCommandText(text);
    }

    //Autostop listening after some time with no results
    if (ISQ.Widget.Cnf.SpeechRecognition.autoStopTimeout !== null) {
        clearTimeout(ISQ.Widget.Cnf.SpeechRecognition.autoStopTimeout);
    }

    ISQ.Widget.Cnf.SpeechRecognition.autoStopTimeout = setTimeout(ISQ.Widget.Cnf.SpeechRecognition.stop, ISQ.Widget.Cnf.SpeechRecognition.idleTime);
}

ISQ.Widget.Cnf.SpeechRecognition.processSearchText = function (text) {

    if (ISQ.Widget.Cnf.SpeechRecognition.text !== text)
    {
        ISQ.Widget.Cnf.SpeechRecognition.text = text;

        //Apply text to query field
        ISQ.Widget.Cnf.SpeechRecognition.applyText(ISQ.Widget.Cnf.SpeechRecognition.text);
    }


    /*

	// Reactivate recognition for waiting command
	if (ISQ.Widget.Cnf.SpeechRecognition.commandTimeout !== null)
	{
		clearTimeout(ISQ.Widget.Cnf.SpeechRecognition.commandTimeout);
	}

	ISQ.Widget.Cnf.SpeechRecognition.commandTimeout = setTimeout(function(){
		ISQ.Widget.Cnf.SpeechRecognition.stop(function(){
			ISQ.Widget.Cnf.SpeechRecognition.setCommandMode(true);
			ISQ.Widget.Cnf.SpeechRecognition.start();
		});

	}, ISQ.Widget.Cnf.SpeechRecognition.waitForCommandTime);
	*/
}

ISQ.Widget.Cnf.SpeechRecognition.processCommandText = function (text) {
    var actions = ISQ.Widget.Cnf.SpeechRecognition.actions;
    for (var i = 0; i < actions.length ; i++) {
        for (var j = 0; j < actions[i].phrases.length; j++) {
            var phrase = actions[i].phrases[j].toLowerCase().trim();

            if (text.toLowerCase().trim().indexOf(phrase) !== -1) {
                ISQ.Widget.Cnf.SpeechRecognition.stop();
                ISQ.Widget.Cnf.SpeechRecognition.executeAction(actions[i]);
                return;
            }
        }
    }
}

ISQ.Widget.Cnf.SpeechRecognition.setCommandMode = function (mode) {
    ISQ.Widget.Cnf.SpeechRecognition.listenCommand = mode;

    if (mode) {
        ISQ.CSS.addClass(ISQ.Widget.HTML.speechButton, 'command-mode');
    } else {
        ISQ.CSS.removeClass(ISQ.Widget.HTML.speechButton, 'command-mode');
    }
}

ISQ.Widget.Cnf.SpeechRecognition.executeAction = function (action) {
    switch (action.name) {
        case 'show_pricings':
            window.open('http://www.nanorep.com/product/pricing', '_blank');
            break;
        case 'contact_sales':
            window.open('http://www.nanorep.com/product/pricing', '_blank');
            break;
        case 'howitworks':
            window.open('http://www.nanorep.com/howitworks', '_blank');
            break;
    }
}

ISQ.Widget.Cnf.SpeechRecognition.updateActions = function (actions) {
    ISQ.Widget.Cnf.SpeechRecognition.actions = [];
    if (!actions) return;

    for (var i = 0; i < actions.length; i++) {
        ISQ.Widget.Cnf.SpeechRecognition.actions.push(actions[i]);
    }
}

ISQ.Widget.Cnf.SpeechRecognition.log = function (text) {
}

ISQ.Widget.Cnf.SpeechRecognition.onStart = function (event) {
    // Clear current text
    ISQ.Widget.Cnf.SpeechRecognition.text = '';

    //hide clear query and show voice icon
    ISQ.Widget.HTML.clearQuery.hide();

    //Make button active
    ISQ.CSS.addClass(ISQ.Widget.HTML.speechButton, 'active');

    // Autostop after idle without speaking
    ISQ.Widget.Cnf.SpeechRecognition.autoStopTimeout = setTimeout(ISQ.Widget.Cnf.SpeechRecognition.stop, ISQ.Widget.Cnf.SpeechRecognition.idleTime);
}

ISQ.Widget.Cnf.SpeechRecognition.onEnd = function (event) {
    //Remove button active state
    ISQ.CSS.removeClass(ISQ.Widget.HTML.speechButton, 'active');
    ISQ.Widget.Cnf.SpeechRecognition.active = false;

    ISQ.Widget.Cnf.SpeechRecognition.applyText(ISQ.Widget.Cnf.SpeechRecognition.text);

    clearTimeout(ISQ.Widget.Cnf.SpeechRecognition.autoStopTimeout);
    clearTimeout(ISQ.Widget.Cnf.SpeechRecognition.commandTimeout);

    if (ISQ.Widget.Cnf.SpeechRecognition.showClearQueryOnStop) {
        ISQ.Widget.Cnf.SpeechRecognition.showClearQueryOnStop = false;
        ISQ.Widget.HTML.clearQuery.show();
    }

    ISQ.Widget.Cnf.SpeechRecognition.setCommandMode(false);

    if (typeof ISQ.Widget.Cnf.SpeechRecognition.onStopCallback === 'function') {
        ISQ.Widget.Cnf.SpeechRecognition.onStopCallback();
        ISQ.Widget.Cnf.SpeechRecognition.onStopCallback = null;
    }
}

ISQ.Widget.Cnf.SpeechRecognition.start = function () {
    if (!ISQ.Widget.Cnf.SpeechRecognition.recognizer) return;

    try {
        ISQ.Widget.Cnf.SpeechRecognition.recognizer.start();
        ISQ.Widget.Cnf.SpeechRecognition.active = true;
    } catch (e) {
        ISQ.Widget.Log.add('Speech recognition not started: ' + e.message);
    }
}

ISQ.Widget.Cnf.SpeechRecognition.stop = function (callback) {
    if (!ISQ.Widget.Cnf.SpeechRecognition.recognizer) return;

    if (callback) {
        ISQ.Widget.Cnf.SpeechRecognition.onStopCallback = callback;
    }

    ISQ.Widget.Cnf.SpeechRecognition.recognizer.stop();
    ISQ.Widget.Cnf.SpeechRecognition.active = false;

}

//Apply text to query field
ISQ.Widget.Cnf.SpeechRecognition.applyText = function (text) {
    if (text && text.length) {
        ISQ.Widget.HTML.queryField.value = text;
        ISQ.Widget.Query.mobile_ignoreNextChange = true;
        ISQ.Widget.Query.analyzeQuery(text, ISQ.Widget.Query.enumTextQuerySource.suggestion);
    }
}

ISQ.Widget.Cnf.SpeechRecognition.hideButton = function () {
    if (!ISQ.Widget.HTML.speechButton) return;

    ISQ.Widget.HTML.speechButton.style.display = 'none';
}

ISQ.Widget.Cnf.SpeechRecognition.showButton = function () {
    if (!ISQ.Widget.HTML.speechButton) return;

    ISQ.Widget.HTML.speechButton.style.display = 'block';
}

ISQ.Widget.Cnf.SpeechRecognition.activate = function () {
    ISQ.Widget.Cnf.SpeechRecognition.showButton();
}

ISQ.Widget.Cnf.SpeechRecognition.deactivate = function () {
    ISQ.Widget.Cnf.SpeechRecognition.hideButton();
}

//#endregion

//#endregion


/********************************************************
///////////////////// [ CSS ] ///////////////////////////
********************************************************/
//#region css
ISQ.Widget.Css = initializeNS('ISQ.Widget.Css');

///////////// is the css loaded ////////////////
ISQ.Widget.Css.RTL_CSS_identifier = 'html.rtl_css_file';
ISQ.Widget.Css.dynamic_RTL_CSS_identifier = 'html.dynamic_rtl_css_file';

//#endregion

/********************************************************
//////////////// [ Load handler ] ///////////////////////
********************************************************/
//#region load handler

//////////////////////////////////////////////////////////////////////////
// loadHandler
ISQ.Widget.loadHandler = function ()
{
    if (ISQ.Cnf.controlGroup) return; // in control group

    // tracking user (part of feature #7736)
    //ISQ.Widget.EndUserTracking.init(); // initiating end user tracking
    //ISQ.Widget.EndUserTracking.trackUser(); // tracking user
    if (ISQ.Widget.isFloat && ISQ.Cnf['limited']) return;

    // don't do anything if container isn't visible
    var size = ISQ.Html.screenSize();
    if (size.h === 0 && (ISQ.Http.browser.isMobile || !ISQ.Widget.isFloat || !ISQ.Http.browser.isIE7))
    {
        setTimeout(function () { ISQ.Widget.loadHandler(); }, 10);
        return;
    }

    // setting server url
    ISQ.Widget.dynamicHost = "//" + ISQ.Cnf.serverUrl;
    _session().setHost(ISQ.Widget.dynamicHost);

    // context might have been passed via hashArguments (#7720)
    var ctxStr = ISQ.Http.hashArguments["context"];
    if (ctxStr)
    {
        var contextObject = {};
        var ctxSplit = ctxStr.split(",");
        iteration(ctxSplit, function (item)
        {
            var itemSplit = item.split(":");
            if (itemSplit.length != 2) return;
            contextObject[itemSplit[0]] = itemSplit[1];
        });
        ISQ.Widget.API.updateContext(contextObject, true);
    }
    // Updating context with the CNF
    var newContexts = ISQ.Widget.combineContext(ISQ.Cnf.contextAttributes, _session().contexts(), ISQ.Widget.API.getCustomParams());
    if (newContexts)
    {
        // setting updated context
        if (ISQ.Http.browser.isMobile)
        {
            var tmp = [];
            ISQ.Widget.CDC_appendKeyValueToMessage(newContexts, tmp);
            ISQ.Widget.HTML.Mobile.context = tmp.join('');
        }
        if (!ISQ.Http.browser.isMobile || ISQ.Widget.HTML.Mobile.adjustableEmbedWidth)
            ISQ.Widget.API.updateContext(newContexts, false);
    }
    // loading widget text from file
    if (ISQ.Cnf['languageDictionary'])
        eval(ISQ.Cnf['languageDictionary']);

    // loading FAQ
    ISQ.Widget.FAQ.scriptLoadState = ISQ.Widget.FAQ.initEnum.loaded;
    ISQ.Widget.FAQ.handleCnfData();
    if (ISQ.Widget.FAQ.pendingFAQCallback) ISQ.Widget.FAQ.pendingFAQCallback();

    ISQ.Widget.skinName = (ISQ.Cnf.skinName) ? ISQ.Cnf.skinName : null;

    // adding skin css
    ISQ.Widget.addCssStyles(ISQ.Cnf['skinCSS']);

    // applying RTL skin css
    if (ISQ.Cnf['skinCSS_rtl'])
    {
        ISQ.Widget.rtlCssLoaded = true;
        // ISQ.Widget.addCssStyles(ISQ.Cnf['skinCSS_rtl']);
        ISQ.CSS.addNewStyle(ISQ.Cnf['skinCSS_rtl'], "fileloaderStyleSheet", true);
        //ISQ.CSS.addNewStyle(ISQ.Cnf['skinCSS_rtl']
    }
    // adding custom css
    if (typeof (ISQ.Cnf['customCSS']) === 'string')
    {
        var customCssProcessed = false;
        var customCssSource = ISQ.Cnf['customCSS'];
        // adding @import directives to unique style tag
        // directive: @import url("fdfdfd.css");
        var ndx = customCssSource.indexOf("@import");
        if (ndx !== -1 && !ISQ.Http.browser.isAndroid)
        {
            var customCssErr = false;
            var customCSSBuilder = [];
            var endNdx = -1;
            var imports = [];
            do
            {
                // adding previous text
                customCSSBuilder.push("htmlCustomCSS{\"visibility:visible;\"}")
                customCSSBuilder.push(customCssSource.substring(0, ndx));

                // getting ndx of "("
                ndx = customCssSource.indexOf("(", ndx);
                if (ndx === -1)
                {
                    customCssErr = true;
                    break;
                }
                // getting ndx of ")"
                endNdx = customCssSource.indexOf(")", ndx);
                if (endNdx === -1)
                {
                    customCssErr = true;
                    break;
                }

                // getting the url, skipping the ' and ". E.g.:  ("import.css") -->  import.css
                imports.push(customCssSource.substring(ndx + 2, endNdx - 1));

                // getting the closing ';' of the directive
                endNdx = customCssSource.indexOf(";", endNdx);
                if (endNdx++ === -1)
                {
                    customCssErr = true;
                    break;
                }

                // searching for the next @import
                ndx = customCssSource.indexOf("@import", endNdx);

            } while (ndx !== -1);

            if (!customCssErr)
            {
                // adding remaining text
                if (endNdx !== customCssSource.length)
                    customCSSBuilder.push(customCssSource.substring(endNdx));

                // adding custom css

                ISQ.CSS.addNewStyle(customCSSBuilder.join(''));

                customCssProcessed = true;

                for (i = 0; i < imports.length; ++i)
                {
                    var lnk = createElement("link");
                    lnk.rel = "stylesheet";
                    lnk.setAttribute("rel", "stylesheet");
                    lnk.href = imports[i];
                    lnk.setAttribute("href", imports[i]);

                    document.getElementsByTagName("HEAD")[0].appendChild(lnk);
                }
            }
        }

        // custom css string wasn't processed, adding to a new style tag
        if (!customCssProcessed)
        {
            ISQ.CSS.addNewStyle("htmlCustomCSS{\"visibility:visible;\"}" + customCssSource);
        }
    }

    // set labels applying to contact form
    if (ISQ.Cnf.applyLabelToTickets)
    {
        var parts = ISQ.Cnf.applyLabelToTickets.split(",");
        for (i = 0; i < parts.length; i++)
            ISQ.Widget.ContactForm.reportPreDefinedValue("label_" + parts[i], parts[i], "label");
    }

    // fixing IE6,7 resize bug (#2931: Hebrew widget is broken during and after resize)
    if (ISQ.Http.browser.isIE6 || ISQ.Http.browser.isIE7)
    {
        setTimeout(function ()
        {
            document.body.style.position = 'relative';
            document.body.style.left = 0;
            document.body.style.top = 0;
        }, 0); // setting in timeout to fix bug #3129
    }

    // load text localization
    ISQ.Widget.Localize = {};

    //////////////////////////////////////////////////////////////////////////
    // getting UI language code

    // if UI language code was overridden (by url argument)
    if (!ISQ.Cnf.ignoreScriptCustomValues)
    {
        if (ISQ.Http.hashArguments["languagecode"])
            ISQ.Cnf.initialUiLanguage = ISQ.Tools.getUniformLanguageCode(ISQ.Http.hashArguments["languagecode"]);
        else if (ISQ.Http.urlArguments["languagecode"])
            ISQ.Cnf.initialUiLanguage = ISQ.Tools.getUniformLanguageCode(ISQ.Http.urlArguments["languagecode"]);
    }

    if (!ISQ.Cnf.initialUiLanguage)
    {
        // UI language code will be as configured
        if (ISQ.Cnf.uiLanguageCode)
            ISQ.Cnf.initialUiLanguage = ISQ.Cnf.uiLanguageCode; // UI language code
        // UI language code will be kbLanguage code
        else
            ISQ.Cnf.initialUiLanguage = ISQ.Cnf.kbLanguageCode; // UI language code
    }

    // set localized FAQ texts
    nanoRep.FAQ.init(ISQ.Cnf.initialUiLanguage, window.location.protocol + "//" + ISQ.Http.domain(true));

    // getting language code
    ISQ.Widget.Localize.array = ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage];

    // if localization wasn't found, use en
    if (!ISQ.Widget.Localize.array)
    {
        ISQ.Cnf.initialUiLanguage = 'en';
        ISQ.Widget.Localize.array = ISQ.Widget.Texts['en'];
    }

    ISQ.Cnf.currentUiLanguage = ISQ.Cnf.initialUiLanguage;
    ISQ.Widget.Log.add('<b>UI</b> Language code:<u>' + ISQ.Cnf.currentUiLanguage + '</u>');
    ISQ.Widget.Log.add('<b>KB</b> Language code:<u>' + ISQ.Cnf.kbLanguageCode + '</u>');

    //////////////////////////////////////////////////////////////////////////

    // disable rtl css based on cnf language
    if (ISQ.Widget.Localize.array["dir"] !== "rtl")
    {
        ISQ.CSS.toggleCss(ISQ.Widget.Css.RTL_CSS_identifier, false);
        ISQ.CSS.toggleCss(ISQ.Widget.Css.dynamic_RTL_CSS_identifier, false);
        ISQ.Widget.HTML.dynamicRTLCssLoaded = false;
    }

    var footerNanoRepLink = _('footerNanoRepLink');
    if (!ISQ.Cnf.goResponseBranding)
    {
        footerNanoRepLink.href = ISQ.Widget.buildNRLinkUrl(ISQ.Widget.account, ISQ.Widget.referer.normal, ISQ.Widget.isFloat ? 'float' : 'embed');
        footerNanoRepLink.className = "link_nano_img padding";
    }
    else
    {
        footerNanoRepLink.className = "link_nano_img padding link_go_response";
    }

    // registering page's unload event
    if (ISQ.Http.browser.app === "chrome") // #2677
        window.onbeforeunload = ISQ.Widget.pageUnload;
    else
        window.onunload = ISQ.Widget.pageUnload;

    document.body.onclick = function (evt)
    {
        evt = window.event || evt;
        var tar = evt.target || evt.srcElement;

        // making sure that's a link
        if (tar.nodeName != "A") return;

        // making sure link is in answer pane
        var p = tar.parentNode;
        var pane = _('answerPane');
        while (p != null && p != pane) p = p.parentNode;
        if (p != pane) return;

        // verifying href
        var href = tar.href;
        if (href.startsWith("javascript")) return;

        //var content = _('contentArea').innerHTML;
        ISQ.Widget.setOngoingData(href);
    }

    // setting pointers to html elements
    ISQ.Widget.HTML.setPointers();

    // applying PIE
    ISQ.Widget.HTML.enablePIE();

    // resetting inputs (inputs values doesn't reset in all browsers)
    _('txtChatInput').value = "";
    ISQ.Widget.HTML.queryField.value = "";

    // iphone&ipad: setting input field class to fix its style
    if (ISQ.Http.browser.isIPad || ISQ.Http.browser.isIPhone)
        ISQ.Widget.HTML.queryField.className += " apple";

    // css full screen indicator
    if (window.top === window || ISQ.Widget.isFullScreen) ISQ.CSS.addClass(_('widgetContainer'), 'fullScreen');

    if (ISQ.Widget.isFullScreen) {
        ISQ.CSS.addClass(document.body, 'fullscreenMobile'); //Add class for fullscreen mobile mode
    }

    //////////////////////////////////////////////////////////////////////////
    // custom values
    if (!ISQ.Cnf.ignoreScriptCustomValues)
    {
        // bg color
        if (ISQ.Http.hashArguments["bgcolor"] || ISQ.Http.urlArguments["bgcolor"])
        {
            var color;
            if (ISQ.Http.hashArguments["bgcolor"])
                color = ISQ.Http.Cookies.decode64(ISQ.Http.hashArguments["bgcolor"]);
            else
                color = ISQ.Http.Cookies.decode64(ISQ.Http.urlArguments["bgcolor"]);

            _('widgetTitleWrapper').style.backgroundColor = color;
            ISQ.Widget.HTML.footerWrapper.style.backgroundColor = color;
            _('widgetMinimizedFooter').style.backgroundColor = color;
        }
        // teaser text
        if (ISQ.Http.hashArguments["teaser"])
            ISQ.Widget.customTeaserText = ISQ.Http.Cookies.decode64(ISQ.Http.hashArguments["teaser"]);
        else if (ISQ.Http.urlArguments["teaser"])
            ISQ.Widget.customTeaserText = ISQ.Http.Cookies.decode64(ISQ.Http.urlArguments["teaser"]);

        // title
        if (ISQ.Http.hashArguments["title"])
            ISQ.Widget.customTitle = ISQ.Http.Cookies.decode64(ISQ.Http.hashArguments["title"]);
        else if (ISQ.Http.urlArguments["title"])
            ISQ.Widget.customTitle = ISQ.Http.Cookies.decode64(ISQ.Http.urlArguments["title"]);

        // title color
        if (ISQ.Http.hashArguments["color"])
            _('widgetTitleText').style.color = ISQ.Http.Cookies.decode64(ISQ.Http.hashArguments["color"]);
        else if (ISQ.Http.urlArguments["color"])
            _('widgetTitleText').style.color = ISQ.Http.Cookies.decode64(ISQ.Http.urlArguments["color"]);
    }

    //////////////////////////////////////////////////////////////////////////
    // show the widget
    ISQ.Widget.HTML.widgetContainer.style.display = 'block';
    _('widgetLoading').style.display = 'none';

    // fixing branding color
    //ISQ.Widget.HTML.fixBrandingColor();

    // set initial texts
    ISQ.Widget.setInitialTexts();


    //Close button on top of query
    ISQ.Widget.HTML.clearQuery.onclick = function ()
    {
        ISQ.Widget.HTML.queryField.value = '';
        ISQ.Widget.Query.analyzeQuery(_query(false), ISQ.Widget.Query.enumTextQuerySource.regular);
        this.hide();
    }
    // close button hide
    ISQ.Widget.HTML.clearQuery.hide = function ()
    {
        this.style.opacity = 0;
        this.style.display = 'none';

        ISQ.Widget.Cnf.SpeechRecognition.showButton();
    }
    // close button show
    ISQ.Widget.HTML.clearQuery.show = function ()
    {
        //Dont show it when speech active
        if (ISQ.Widget.Cnf.SpeechRecognition.active) return;

        // if query is not empty
        if (ISQ.Widget.HTML.queryField.value && ISQ.Widget.HTML.queryField.value.length > 0)
        {
            // making sure query is not the initial text
            if (!ISQ.Widget.userActive && ISQ.Cnf.initialText && ISQ.Widget.HTML.queryField.value == ISQ.Cnf.initialText)
                return;

            // do not show in teaser mode
            if (ISQ.Widget.HTML.isTeaser) return;

            this.style.opacity = 1;
            this.style.display = 'block';

            //When show clearQuery hide speech button
            ISQ.Widget.Cnf.SpeechRecognition.hideButton();
        }
    }

    //#region adjust heights

    // saving teaser's width
    if (ISQ.Cnf.floatTeaser_width) ISQ.Cnf.floatTeaser_WidgetSize[0] = ISQ.Cnf.floatTeaser_width;

    // not in float, hiding minimize
    if (!ISQ.Widget.isFloat) _('minimizeButtonWrapper').style.display = 'none';

    // script in answers: saving scripts in footer.
    var footerResult = ISQ.Data.getDBAnswerAsHtml(ISQ.Cnf.answerFooter, true, null, null, null, ISQ.Widget.referer.normal);
    ISQ.Cnf.answerFooter = footerResult.text;
    ISQ.Cnf.answerFooterScript = footerResult.script;
    // customer logo
    if (ISQ.Widget.isFloat && ISQ.Cnf.customerBrandingLogo && ISQ.CSS.getElementStyle(_('customerLogo'), 'visibility') !== 'hidden')
    {
        var img = new Image();
        img.onload = function ()
        {
            this.loaded = true;
            ISQ.Widget.onCustomerLogoLoad();
        };
        ISQ.Cnf.customerBrandingLogo_img = img;
        img.src = ISQ.Cnf.customerBrandingLogo;
        ISQ.Cnf.customerBrandingLogo_img.loaded = false;
    }
    else
    {
        ISQ.Cnf.customerBrandingLogo = null;
    }

    // setting mobile mode
    ISQ.Widget.HTML.Mobile.setMode();

    // initiating query
    ISQ.Widget.Query.init();

    // widget is limited, showing contact form
    if (ISQ.Cnf.limited)
    {
        ISQ.Widget.HTML.limitedMode();
    }
    // widget is not limited, loading elements
    else
    {
        // initiating Chat (and resuming if needed)
        if (ISQ.Cnf["chatConfiguration"] && ISQ.Cnf.chatEnabled && ISQ.Widget.mobileHandlingMode !== ISQ.Widget.enumMobileHandlingMode.inactive)
            ISQ.Widget.Chat.init();

        // // auto questions
        if (((ISQ.Widget.state & ISQ.Widget.enumState.allChat) === 0) && !ISQ.Widget.onloadQuestion && !ISQ.Widget.onloadQuestionId && ISQ.Cnf.autoQuestions)
            ISQ.Widget.AutoQuestions.init(ISQ.Cnf.autoQuestions, ISQ.Cnf.autoQuestionsInterval, ISQ.Cnf.repeatAutoQuestions);

        // initial text
        var initialText = ISQ.Cnf.initialText || ISQ.Widget.onloadQuestion || ISQ.Widget.onloadQuestionId;
        if (initialText && ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) === 0))
        {
            ISQ.Widget.HTML.queryField.className += " initialText";
            ISQ.Widget.HTML.queryField.value = ISQ.Cnf.initialText;
            // arial-label
            ISQ.Widget.HTML.queryField.setAttribute("arial-lable", initialText);
        }

        // setting focus
        if (ISQ.Widget.state !== ISQ.Widget.enumState.autoQuestions || initialText)
            ISQ.Widget.Query.setFocus();

        // onload question / FAQ
        if (ISQ.Http.hashArguments["onloadquestion"])
            ISQ.Widget.onloadQuestion = ISQ.Http.Cookies.decode64(ISQ.Http.hashArguments["onloadquestion"]);
        else if (ISQ.Http.urlArguments["onloadquestion"])
            ISQ.Widget.onloadQuestion = ISQ.Http.Cookies.decode64(ISQ.Http.urlArguments["onloadquestion"]);

        // onload question id
        if (ISQ.Http.hashArguments["onloadquestionid"])
        {
            ISQ.Widget.onloadQuestionId = ISQ.Http.hashArguments["onloadquestionid"];
            ISQ.Widget.onloadQuestionIdFromURL = true;

            if (((ISQ.Widget.state & ISQ.Widget.enumState.allChat) === 0) && ISQ.Widget.onloadQuestionId) ISQ.Widget.state = ISQ.Widget.enumState.questions; // questions via scripts are counted as regular user questions
        }
        else if (ISQ.Http.urlArguments["onloadquestionid"])
        {
            ISQ.Widget.onloadQuestionId = ISQ.Http.urlArguments["onloadquestionid"];
            if (((ISQ.Widget.state & ISQ.Widget.enumState.allChat) === 0) && ISQ.Widget.onloadQuestionId) ISQ.Widget.state = ISQ.Widget.enumState.questions; // questions via scripts are counted as regular user questions
        }
        else if (((ISQ.Widget.state & ISQ.Widget.enumState.allChat) === 0) && ISQ.Cnf.onloadQuestionId && ISQ.Cnf.onloadQuestionId != '-1') // onload question '-1' means no question
        {
            ISQ.Widget.onloadQuestionId = ISQ.Cnf.onloadQuestionId; // we ignore statistics in this case
            if (ISQ.Widget.isFloat)
            {
                ISQ.Widget.state = ISQ.Widget.enumState.questions;
            }
            else
            {
                ISQ.Widget.state = ISQ.Widget.enumState.autoQuestions; // questions from CNF is counted as auto question
            }
        }
        // FAQ
        else if (((ISQ.Widget.state & ISQ.Widget.enumState.allChat) == 0) && (!ISQ.Widget.isFloat || ISQ.Http.browser.isMobile) && !ISQ.Cnf.autoQuestions) {
            ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnWidgetLoad);
            if (ISQ.Http.browser.isMobile) {
                ISQ.Widget.FAQ.pendingFAQCallbackList.push(function () {
                    ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnWidgetLoad);
                })
                ISQ.Widget.FAQ.initalize();
            }
        }
    }

    // resizing widget
    ISQ.Widget.HTML.resizeHandler();

    // branding
    if (ISQ.Cnf.hideBranding)
    {
        _('footerNanoRepLink').style.display = 'none';
        _('logoInCollapsedMode').style.display = 'none';
    }
    if (ISQ.Cnf.customerBrandingText)
    {
        _('customerBrandingText').style.display = 'block';
        _('customerBrandingText').innerHTML = ISQ.Cnf.customerBrandingText;
    }

    // hide byEmail icon
    if (ISQ.Cnf.hideByEmailIcon)
        _('repByEmail').className = 'noActionBarIcon';

    // hide powered by if FAQ shown
    if (ISQ.Cnf.faqWidgetConfig && ISQ.Cnf.faqWidgetConfig != "[]")
    {
        _("footerNanoRepLink").style.visibility = "hidden";
        ISQ.Widget.HTML.widgetFooter.className = "widgetFooter";
    }

    // add resize handlers:
    if (!ISQ.Http.browser.isIE6 && (!ISQ.Http.browser.usesViewport || ISQ.Http.browser.isIOS7))
    {
        ISQ.Html.ReSize.init(ISQ.Html.ReSize.enumListenTo.both, true);

        // parameters for IOS7 (#8855)
        var lastTime = 0;
        var prevSize = { w: 0, h: 0 };
        var ignoreNext = false;
        var ios7SizeFix = ISQ.Http.browser.isIOS7 && !ISQ.Widget.isFloat && window !== window.top;

        ISQ.Html.ReSize.Event.addHandler(function ()
        {
            if (ios7SizeFix)
            {
                viewportSize = ISQ.Html.screenSize();

                var now = new Date().getTime();
                if (ignoreNext && viewportSize.h < prevSize.h)
                {
                    lastTime = now;
                    if (now - lastTime < 100) return;
                }
                prevSize = viewportSize;
                ignoreNext = false;
                lastTime = now;
            }
            ISQ.Widget.HTML.resizeHandler(null, true);

            if (ios7SizeFix) ignoreNext = true;
        });
    }
    // ie6, mobiles and tablets do not fire the resize events.
    else
    {
        // on tablets, ie6 and adjustable embed, poll for resizing
        if (ISQ.Http.browser.isTablet || ISQ.Http.browser.isIE6 || ISQ.Widget.HTML.Mobile.adjustableEmbedWidth)
        {
            // these devices doesn't fire some resize events and so we need to poll periodically
            setInterval(ISQ.Widget.HTML.resizePollingHandler, 20);
        }

        // tablets and mobile:
        if (!ISQ.Http.browser.isIE6 && ISQ.Widget.mobileHandlingMode !== ISQ.Widget.enumMobileHandlingMode.inactive)
            window.addEventListener("orientationchange", ISQ.Widget.HTML.Mobile.orientationChanged);
    }
    //#endregion

    // notifying click if "notifyClick" is passed
    var notifyClick = ISQ.Http.hashArguments["notifyclick"] || false;
    if (notifyClick === 'true' && !ISQ.Http.browser.isMobile)
    {
        // non tablets
        if (!ISQ.Http.browser.isTablet)
        {
            document.onclick = function (e)
            {
                var evt = e || window.event;
                // a flag indicating ignore the next click event
                // was set. canceling it, and ignoring click event
                if (ISQ.Widget.HTML.ignoreNextClickEvent)
                {
                    ISQ.Widget.HTML.ignoreNextClickEvent = false;
                    return;
                }

                // delaying the execution since clicking on links
                // cancels iframe loading
                if (ISQ.Http.browser.isIE6)
                {
                    setTimeout(function ()
                    {
                        ISQ.Widget.CDC.sendMessage("subject=click");
                    }, 0);
                }
                else
                {
                    ISQ.Widget.CDC.sendMessage("subject=click");
                    //if click is not in textfield
                    var target = evt.target || evt.srcElement;
                    if (target.tagName !== "INPUT")
                    {
                        ISQ.Widget.Expand();
                    }
                }
            }
        }
        // tablets
        else
        {
            _('chatStatusWrapper').addEventListener("click", function (evt)
            {
                ISQ.Widget.CDC.sendMessage("subject=click");
            });
            _('widgetTitleWrapper').addEventListener("click", function (evt)
            {
                if (ISQ.Widget.HTML.Mobile.ignoreClickEvent)
                {
                    ISQ.Widget.HTML.Mobile.ignoreClickEvent = false;
                    return;
                }
                ISQ.Widget.CDC.sendMessage("subject=click");
            });
            ISQ.Widget.HTML.queryField.addEventListener("click", function (evt)
            {
                ISQ.Widget.CDC.sendMessage("subject=click");
            });
            _('contentAreaWrapper').addEventListener("click", function (evt)
            {
                ISQ.Widget.CDC.sendMessage("subject=click");
            });
            _('actionBarWrapper').addEventListener("click", function (evt)
            {
                ISQ.Widget.CDC.sendMessage("subject=click");
            });
        }

    }

    // register onscroll event
    if (ISQ.Cnf.answerPeeksEnabled)
    {
        if (document.addEventListener)
            ISQ.Widget.HTML.contentWrapper.addEventListener('scroll', ISQ.Widget.Query.contentWrapperScroll);
        else if (document.attachEvent)
            ISQ.Widget.HTML.contentWrapper.attachEvent('onscroll', ISQ.Widget.Query.contentWrapperScroll);
    }

    // #region cdc message
    // sending cdc frame load message
    if (ISQ.Widget.sendingCDCMessages)
    {
        var msg = null;
        // float
        if (ISQ.Widget.isFloat)
        {
            msg = "subject=load";

            // docking
            if (typeof (ISQ.Cnf.dockRTL) !== 'undefined')
                msg += "&dockrtl=" + ISQ.Cnf.dockRTL;
            // float is supposed to be open expanded/collapsed
            if (ISQ.Cnf.floatOpenOnLoad === true
                || ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions
                || ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) != 0)
            //|| ISQ.Widget.onloadQuestion || ISQ.Widget.onloadQuestionId
               )
            {
                msg += "&stateonload=";
                if ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) != 0) // chat
                    msg += "chat";
                else if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions // questions
                    || ISQ.Widget.onloadQuestion || ISQ.Widget.onloadQuestionId)
                    msg += "expand";
                else if (ISQ.Cnf.floatOpenOnLoad === true) //
                    msg += "collapse";
                else
                    msg += "teaser";
            }
            // auto minimize (if not resuming chat or onload question)
            if (typeof (ISQ.Cnf.floatAutoMinimizeTimeout) !== 'undefined'
                && ISQ.Widget.state !== ISQ.Widget.enumState.chat
                && !ISQ.Widget.onloadQuestion
                && !ISQ.Widget.onloadQuestionId)
                msg += "&autominimize=" + ISQ.Cnf.floatAutoMinimizeTimeout;
            // open on hover
            if (typeof (ISQ.Cnf.floatOpenOnHover) !== 'undefined')
                msg += "&openonhover=" + ISQ.Cnf.floatOpenOnHover;
            /// teaser text
            if (ISQ.Cnf.titleTeaserText)
                msg += "&teasertext=" + ISQ.Http.Cookies.encode64(ISQ.Cnf.titleTeaserText);
            // teaser font
            if (ISQ.Cnf.generatedTeaser_textFont)
                msg += "&teaserfont=" + ISQ.Http.Cookies.encode64(ISQ.Cnf.generatedTeaser_textFont);
            // teaser color
            if (ISQ.Cnf.titleColor)
                msg += "&teasercolor=" + ISQ.Http.Cookies.encode64(ISQ.Cnf.titleColor);
            // teaser direction
            msg += "&teaserdir=" + ISQ.Widget.Localize.array["dir"];
            // teaser pos
            if (ISQ.Cnf.generatedTeaser_textPosition)
                msg += "&teaserposition=" + ISQ.Cnf.generatedTeaser_textPosition[0] + "," + ISQ.Cnf.generatedTeaser_textPosition[1];
            // teaser size
            if (ISQ.Cnf.generatedTeaser_textSize)
                msg += "&teasersize=" + ISQ.Cnf.generatedTeaser_textSize[0] + "," + ISQ.Cnf.generatedTeaser_textSize[1];
            // side margin
            if (ISQ.Cnf.floatMarginSide)
                msg += "&marginside=" + ISQ.Cnf.floatMarginSide;
            // bottom margin
            if (ISQ.Cnf.floatMarginBottom)
                msg += "&marginbottom=" + ISQ.Cnf.floatMarginBottom;
            // teaser width
            if (ISQ.Cnf.floatTeaser_width)
                msg += "&teaserwidth=" + ISQ.Cnf.floatTeaser_width;
            // box shadow
            if (ISQ.Cnf.containerBoxShadow)
                msg += "&containerBoxShadow=" + ISQ.Http.Cookies.encode64(ISQ.Cnf.containerBoxShadow);
            // ignore script custom values
            if (ISQ.Cnf.ignoreScriptCustomValues)
                msg += "&ignorescriptcustomvalues=" + ISQ.Cnf.ignoreScriptCustomValues;

            ISQ.Widget.CDC.sendMessage(msg);
        }
        // embed
        else if (ISQ.Widget.dynamicSize)
        {
            ISQ.Widget.HTML.dynamicSize_sendMessage();
        }
    }

    // sending 'load' event (+ integrate with GA)
    ISQ.Widget.reportEvents |= (ISQ.Cnf.integrateWithGA === true);
    if (ISQ.Widget.reportEvents)
        ISQ.Widget.CDC.sendMessage("subject=event&type=load&integrate_ga=" + (ISQ.Cnf.integrateWithGA === true));

    // #endregion

    //////////////////////////////////////////////////////////////////////////
    if (!ISQ.Cnf.limited)
    {
        var ongoingdata = ISQ.Tools.Storage.get("ongoingdata");
        if (ongoingdata)
        {
            ISQ.Tools.Storage.remove("ongoingdata"); // removing data
            // to json
            ongoingdata = eval('(' + ongoingdata + ')');
            // modifying urls
            var ongoingRef = ongoingdata.href;
            var thisRef = ISQ.Widget.referer.normal;
            ISQ.Widget.onloadQuestionId = ongoingdata.onloadQuestionId;

            var ongoingRelRef = ISQ.Http.relativePath(ongoingRef);
            var thisRelRef = ISQ.Http.relativePath(thisRef);
            var refsAreEqual = (ISQ.Http.domain(true, ongoingRef) === ISQ.Http.domain(true, thisRef)) &&
                (ongoingRelRef.filename === thisRelRef.filename) &&
                (ongoingRelRef.path === thisRelRef.path);

            // comparing kb, accounts
            if (refsAreEqual && ISQ.Widget.account == ongoingdata.account && ISQ.Cnf.kbLanguageCode == ongoingdata.kb)
            {
                // updating widget's height
                if (ISQ.Widget.isFloat)
                    ISQ.Widget.CDC.sendMessage("subject=widgetToExpand");
                else
                    ISQ.Widget.HTML.dynamicSize_sendMessage();

                _session().loadSessionFromId(ongoingdata.sid);
                setTimeout(function ()
                {
                    // restoring session
					ISQ.Widget.runOnloadQuestion();
                }, 100);


            }
        }
        // onload question
        else if (ISQ.Widget.onloadQuestion)
        {
            ISQ.Widget.state = ISQ.Widget.enumState.questions;
            if (ISQ.Cnf.autoQuestionsTypeEffect)
            {
                ISQ.Widget.Query.typeTimer = new ISQ.Timer(new ISQ.Handler(ISQ.Widget.Query.typeQuestion), false, ISQ.Widget.onloadQuestion, 0);
                ISQ.Widget.Query.typeTimer.start(ISQ.Widget.Query.typeInterval);
            }
            else
            {
                ISQ.Widget.HTML.queryField.value = ISQ.Widget.onloadQuestion;
            }
            ISQ.Widget.Query.analyzeQuery(ISQ.Widget.onloadQuestion, ISQ.Widget.Query.enumTextQuerySource.linkedAnswer);
            ISQ.Widget.Query.clearTextboxOnInteraction = true;
        }
        // onload question id
        else if (ISQ.Widget.onloadQuestionId)
        {
			if (!ISQ.Widget.isFloat)
			{
				ISQ.Widget.runOnloadQuestion(null, ISQ.Widget.onloadQuestionIdFromURL ? 'direct' : 'onload');
			}
        }
        // auto questions
        else if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions)
        {
            ISQ.Widget.AutoQuestions.go();
        }
    }

    ISQ.Widget.Cnf.SpeechRecognition.init();
};

ISQ.Widget.setOngoingData = function (url)
{
    var data = ISQ.Data.jsonToString(
        {
            href: url,
            sid: _session().id(),
            onloadQuestionId: ISQ.Widget.lastQuestionId,
            kb: ISQ.Widget.Query.kbLanguageCode,
            account: ISQ.Widget.account
        });
    ISQ.Tools.Storage.set('ongoingdata', data);
}

ISQ.Widget.runOnloadQuestion = function (customHandler,src)
{
	if(!src) src = "onload";
	ISQ.Widget.Query.tempQuestionTrailId = ISQ.Widget.onloadQuestionId;
	ISQ.Widget.Query.getAnswerById(ISQ.Widget.onloadQuestionId, ISQ.Cnf.onloadQuestionId && ISQ.Cnf.onloadQuestionId != '-1', src, customHandler);
	ISQ.Widget.Query.clearTextboxOnInteraction = true;
}

ISQ.Widget.expandedFirstTime = false;
ISQ.Widget.Expand = function ()
{
    if (!ISQ.Widget.isFloat) return;
    if (!ISQ.Cnf.floatOpenOnClick) return;

    //Send message, there we expand a widget
    ISQ.Widget.CDC.sendMessage("subject=openOnClick");

	//Initialize FAQ and onload question only once
	if (ISQ.Widget.expandedFirstTime) return;

	ISQ.Widget.expandedFirstTime = true;

    //initialize FAQ's
    ISQ.Widget.FAQ.initalize();

    //Show initilized FAQ's
    ISQ.Widget.FAQ.pendingFAQCallbackList.push(function ()
    {
        //clearNode(ISQ.Widget.HTML.answerPane);
        ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnClearSearchField);
    });

	//Show onload question after click if provided
	if (ISQ.Widget.onloadQuestionId)
	{
		var customHandler = function(answers)
		{
			ISQ.Widget.Query.fader_callback = function () { if (ISQ.Widget.userActive) return; ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnWidgetLoad); }
			ISQ.Widget.Query.hideAnswers(answers, true);
		}

		ISQ.Widget.runOnloadQuestion(customHandler);
	}

}

// load language dictionary
ISQ.Widget.loadLanguageDictionary = function (languageInitials, callback)
{
    if (!ISQ.Widget.Texts[languageInitials])
    {
        for (var i = 0; i < ISQ.Widget.Texts.available.length; i++)
        {
            // language has translation file
            if (ISQ.Widget.Texts.available[i] == languageInitials)
            {
                ISQ.Tools.FileLoader.load("/widget/languages/lang-" + languageInitials + ".js", new ISQ.Handler(function (tag)
                {
                    if (callback)
                        callback();
                }));
                return;
            }
        }
    }
    if (callback)
        callback();
}

// sets the localization array to one in the given language
ISQ.Widget.setUiLanguage = function (language)
{
    //if (!language) return;
    language = language || ISQ.Cnf.currentUiLanguage;

    // toggle rtl css files according to language direction
    //var direction = ISQ.Widget.Query.toTranslateContent(ISQ.Cnf.kbLanguageCode, detectedLanguage) ? ISQ.Translation.Infra.getLanguageDirection(detectedLanguage) : ISQ.Widget.Localize.array["dir"];
    var direction = ISQ.Translation.Infra.getLanguageDirection(language);

    //toggle rtl css
    var toggleCSSNow = function ()
    {
        ISQ.Widget.rtlCssLoaded = true;
        ISQ.CSS.toggleCss("html.rtl_css_file", true); // rtl of skin
        ISQ.CSS.toggleCss("html.skinrtl_css_file", true);
        ISQ.CSS.bringToFront("html.widgetskin_css_file"); //html.widgetskin_css_file
        ISQ.CSS.bringToFront("html.skinrtl_css_file");
        ISQ.CSS.bringToFront("htmlCustomCSS");

        ISQ.Widget.HTML.dynamicRTLCssLoaded = true;

        ISQ.CSS.addClass(document.body, 'isRtl');

        ISQ.Widget.Cnf.SpeechRecognition.updateLanguage();

        if (ISQ.Widget.reportEvents) ISQ.Widget.CDC.sendMessage("subject=event&type=directionchanged&rtl=true");
    }
    if (direction === 'rtl' && !ISQ.Widget.HTML.dynamicRTLCssLoaded)
    {
        if (ISQ.Widget.rtlCssLoaded)
            toggleCSSNow();
        else if (ISQ.Cnf['skinCustomRTLCSSfile'])
        {
            ISQ.Tools.FileLoader.load(ISQ.Cnf['skinCustomRTLCSSfile'], new ISQ.Handler(function (tag)
            {
                toggleCSSNow();
            }), null, true);
        }
    }
    else if (direction == "rtl")
    {
        toggleCSSNow();
    }
    else if (direction === 'ltr' && ISQ.Widget.HTML.dynamicRTLCssLoaded)
    {
        ISQ.CSS.toggleCss("html.rtl_css_file", false);
        ISQ.CSS.toggleCss("html.skinrtl_css_file", false);

        ISQ.CSS.removeClass(document.body, 'isRtl');
        ISQ.Widget.Cnf.SpeechRecognition.updateLanguage();

        ISQ.Widget.HTML.dynamicRTLCssLoaded = false;
        if (ISQ.Widget.reportEvents)
            ISQ.Widget.CDC.sendMessage("subject=event&type=directionchanged&rtl=false");
    }

    if (ISQ.Cnf.currentUiLanguage === language) return;

    // dynamically loading new language if required
    ISQ.Widget.loadLanguageDictionary(language, function ()
    {
        // use the language if we have texts in it
        if (ISQ.Widget.Texts[language])
        {
            ISQ.Cnf.currentUiLanguage = language;
            ISQ.Widget.Localize.array = ISQ.Widget.Texts[language];
        } // if we have texts in the initial ui language, use it
        else if (ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage])
        {
            ISQ.Cnf.currentUiLanguage = ISQ.Cnf.initialUiLanguage;
            ISQ.Widget.Localize.array = ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage];
        }
        else
        {// localization wasn't found, use en
            ISQ.Cnf.currentUiLanguage = 'en';
            ISQ.Widget.Localize.array = ISQ.Widget.Texts['en'];
        }
        ISQ.Widget.setTitle();

        if (ISQ.Widget.Chat.chatConfig.active) ISQ.Widget.Chat.updateCaptions();
    });

}

//#endregion

/********************************************************
///////////////////// [ HTML ] //////////////////////////
********************************************************/
//#region HTML
ISQ.Widget.HTML = initializeNS('ISQ.Widget.HTML'); ;

ISQ.Widget.HTML.customLink_onclick = function ()
{
    //if (this.target === "_self")
    //    _session().prepareToDie(false);
    return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.customEmail);
}
ISQ.Widget.HTML.customChat_onclick = function ()
{
    //if (this.target === "_self")
    //    _session().prepareToDie(false);
    return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.customChat, ISQ.Widget.enumChatEscalationActions.normal);
}

// pointers to elements
ISQ.Widget.HTML.setPointers = function ()
{
    ISQ.Widget.HTML.widgetContainer = _('widgetContainer');
    ISQ.Widget.HTML.queryField = _('txtSearch');
    ISQ.Widget.HTML.clearQuery = _('clearQuery');
    ISQ.Widget.HTML.searchContainer = _('searchContainer');
    ISQ.Widget.HTML.answerPane = _('answerPane');
    ISQ.Widget.HTML.chatPane = _('chatPane');
    ISQ.Widget.HTML.contentWrapper = _('contentAreaWrapper');
    ISQ.Widget.HTML.contentArea = _('contentArea');
    ISQ.Widget.HTML.titleWrapper = _('widgetTitleWrapper');
    ISQ.Widget.HTML.titleText = _('widgetTitleText');
    ISQ.Widget.HTML.actionBarWrapper = _('actionBarWrapper');
    ISQ.Widget.HTML.actionBarContainer = _('actionBarContainer');
    ISQ.Widget.HTML.actionBarQuery = _('actionBarQuery');
    ISQ.Widget.HTML.contactForm = _('contactForm');
    ISQ.Widget.HTML.searchWrapper = _('searchContainerWrapper');
    ISQ.Widget.HTML.chatStatus = _('chatStatus');
    ISQ.Widget.HTML.chatInputWrapper = _('chatInputWrapper');
    ISQ.Widget.HTML.txtEmailChat = _('txtEmailChat');
    ISQ.Widget.HTML.footerWrapper = _('widgetFooterWrapper');
    ISQ.Widget.HTML.widgetFooter = _('widgetFooter');
    ISQ.Widget.HTML.speechButton = _('speechButton');
}

ISQ.Widget.HTML.fixBrandingColor = function ()
{
    var d = ISQ.Widget.HTML.footerWrapper;
    var cssStyle = ISQ.CSS.getSelectorStyle('#widgetFooterWrapper');
    if (!cssStyle) return;

    var cssValues = ISQ.Tools.stringToPairArray(cssStyle.cssText, ":", ";", true, true);
    // hidden
    if (cssValues["display"] === 'none' || cssValues["visibility"] === 'hidden') return;

    var bgColor = cssStyle["backgroundColor"];
    if (!bgColor) bgColor = cssStyle["background-color"];
    //if (!bgColor) return;
    alert(bgColor);
}

//////////////////////////////////////////////////////////////////////////
// mobile
// #region mobile
ISQ.Widget.HTML.Mobile = {};
ISQ.Widget.HTML.Mobile.ignoreClickEvent = false;
ISQ.Widget.HTML.Mobile.formPredefinedData = null;
ISQ.Widget.HTML.Mobile.context = null;
ISQ.Widget.HTML.Mobile.positionSet = false;
ISQ.Widget.HTML.Mobile.incrementedBottom = 0;
ISQ.Widget.HTML.Mobile.incrementedBottom_withChat = 0;
ISQ.Widget.HTML.Mobile.adjustableEmbedWidth = null;
ISQ.Widget.HTML.Mobile.setMode = function ()
{
    if (!ISQ.Http.browser.isMobile) return;

    // fixing bug which iphone would show text in different size than it should
    document.body.style.webkitTextSizeAdjust = '100%';

    //////////////////////////////////////////////////////////////////////////
    // embedded (all mobiles except old android)
    if (ISQ.Widget.HTML.Mobile.adjustableEmbedWidth)
    {
        ISQ.Widget.mobileHandlingMode = ISQ.Widget.enumMobileHandlingMode.normalWidget;

        // setting widths
        ISQ.Widget.HTML.Mobile.setWidths();
        return;
    }

    //////////////////////////////////////////////////////////////////////////
    // floating widget (or embed on old android)
    //////////////////////////////////////////////////////////////////////////
    // deleting cookie
    ISQ.Http.Cookies._delete("nouserstats", "/", ISQ.Http.domain(false), false);

    // normal widget

    if (window.top === window || ISQ.Widget.isFullScreen)
    {
        ISQ.Widget.mobileHandlingMode = ISQ.Widget.enumMobileHandlingMode.normalWidget;

        // setting overflow
        document.body.parentNode.style.overflow = 'visible';
        document.body.parentNode.style.height = 'auto';
        document.body.style.overflow = 'visible';
        document.body.style.height = 'auto';

        if (!ISQ.Widget.isFullScreen)
        {
            ISQ.Widget.HTML.contentWrapper.style.overflow = 'visible';
            ISQ.Widget.HTML.contentWrapper.style.overflowY = 'visible';
        }

        ISQ.Widget.HTML.Mobile.hideAddressbar();

        // showing query field
        ISQ.Widget.HTML.queryField.style.display = 'block';

        // updating title
        ISQ.Widget.setTitle();

        _('minimizeButtonWrapper').style.display = 'none';

        // getting API data (trying to use html5 localStorgae)
        var apiData = null;
        if (window['localStorage'] && !ISQ.Http.browser.isIOS7)
            apiData = window['localStorage'].getItem("nanorep.api." + ISQ.Http.Cookies.encode64(ISQ.Widget.referer.escaped));
        if (!apiData)
        {
            apiData = ISQ.Http.Cookies._readCaseSensitive(ISQ.Http.Cookies.encode64(ISQ.Widget.referer.escaped))
            // deleting the cookie
            if (apiData) ISQ.Http.Cookies._delete(ISQ.Http.Cookies.encode64(ISQ.Widget.referer.escaped), "/widget", ISQ.Http.domain(false), false);
        }
        // processing API data
        if (apiData)
        {
            var apiData = ISQ.Tools.stringToPairArray(unescape(apiData), '=', '&', false, false);
            if (apiData["f"]) //contactForm
                ISQ.Widget.ContactForm.preDefinedValuesFromMessage = apiData["f"];
            if (apiData["c"]) // context
                _session().setContext(ISQ.Widget.CDC_getKeyValueArrayFromMessage(apiData["c"])); // setting context in session
        }

        // setting widths
        ISQ.Widget.HTML.Mobile.setWidths();

        // setting fixed position
        ISQ.Widget.HTML.Mobile.setPositions();
    }
    // widget inside an iframe, thus inactive
    else
    {
        ISQ.Widget.mobileHandlingMode = ISQ.Widget.enumMobileHandlingMode.inactive;
        ISQ.Widget.HTML.queryField.onclick = null;
        _('minimizeButtonWrapper').style.display = 'block';
        ISQ.Widget.HTML.showMinimizeIcon();
        // disabling search box, because some OP (e.g. android 2.3.3) fires onclick
        // when clicking the mobile blocker (#6592)
        _('txtSearch').disabled = true;
    }

}
ISQ.Widget.HTML.Mobile.orientationChanged = function ()
{
    var viewport = ISQ.Html.screenSize();
    // working around a bug which on orientation changed, only width or height is changed.
    if (viewport.h == ISQ.Widget.HTML.currentHeight || viewport.w === ISQ.Widget.HTML.currentWidth)
    {
        setTimeout(ISQ.Widget.HTML.Mobile.orientationChanged, 20);
        return;
    }

    ISQ.Widget.HTML.Mobile.hideAddressbar();
    ISQ.Widget.HTML.resizeHandler(viewport, true);
    ISQ.Widget.Query.resizeAnswerElements();
}
ISQ.Widget.HTML.Mobile.setPositions = function ()
{
    if (ISQ.Widget.mobileHandlingMode !== ISQ.Widget.enumMobileHandlingMode.normalWidget || ISQ.Widget.HTML.Mobile.adjustableEmbedWidth) return;

    // customer logo is pending resize, thus not setting fixed positions yet
    if (ISQ.Cnf.customerBrandingLogo && (!ISQ.Cnf.customerBrandingLogo_img || !ISQ.Cnf.customerBrandingLogo_img.loaded)) return;

    if (ISQ.Widget.HTML.Mobile.positionSet) return;
    ISQ.Widget.HTML.Mobile.positionSet = true;

    //////////////////////////////////////////////////////////////////////////
    // fixed position set
    // adding to array
    var fixedElements = new Array();
    fixedElements.push(ISQ.Widget.HTML.footerWrapper); // footer
    fixedElements.push(_('actionBarWrapper')); // action bar wrapper
    fixedElements.push(_('chatInputWrapper')); // chat input wrapper

    // setting fixed position
    iteration(fixedElements, function (elm)
    {
        if (elm.id && elm.id == 'actionBarWrapper' && ISQ.Widget.skinName == 'Arcade')
        {
            elm.style.zIndex = 2; //#8856
            elm.style.bottom = "3px";
        }
        else
        {
            elm.style.zIndex = 1; //#8856
            elm.style.bottom = ISQ.Widget.HTML.Mobile.incrementedBottom + "px";
        }
        elm.style.position = 'fixed';
        elm.style.width = '100%';
        // since actionbarwarpper is on top of the widgetFooterWrapper, we should skip it
        if (elm.id != 'actionBarWrapper' || ISQ.Widget.skinName != 'Arcade')
            ISQ.Widget.HTML.Mobile.incrementedBottom += ISQ.CSS.getElementHeight(elm, true);

        // if the element is not supposed to be displayed now, setting its inline style
        if (ISQ.CSS.getElementStyle(elm, "display") === "none")
            elm.style.display = 'none';
    });

    // calc height in chat mode
    ISQ.Widget.HTML.Mobile.incrementedBottom_withChat = ISQ.Widget.HTML.Mobile.incrementedBottom;
    _('chatInputWrapper').style.display = 'block';
    ISQ.Widget.HTML.Mobile.incrementedBottom_withChat += ISQ.CSS.getElementHeight(_('chatInputWrapper'), true);
    _('chatInputWrapper').style.display = 'none';

    //////////////////////////////////////////////////////////////////////////
    // to allow hiding the address-bar, we must make sure page-height is higher than visual viewport.
    if (window == window.top) ISQ.Widget.HTML.contentWrapper.style.minHeight = (window.outerHeight + ISQ.Widget.HTML.Mobile.incrementedBottom) + "px";

    // set footer wrapper's bg color to prevent content from showing under it
    var footerColor = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.footerWrapper, 'background-color');
    var footerOpacity = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.footerWrapper, 'opacity');
    if (ISQ.Tools.getOpacityFromRGBA(footerColor) === 0 || footerOpacity === 0)
    {
        // set to white if body is transparent or to body's bg color
        var bodyColor = ISQ.CSS.getElementStyle(document.body, 'background-color');
        if (ISQ.Tools.getOpacityFromRGBA(bodyColor) === 0)
            ISQ.Widget.HTML.footerWrapper.style.backgroundColor = "#fff";
        else
            ISQ.Widget.HTML.footerWrapper.style.backgroundColor = bodyColor;
    }

    // android workaround a bug which fixed positioned elements aren't redrawn when scrolling
    if (ISQ.Http.browser.oldAndroid)
    {
        var timer = null;
        window.addEventListener("touchmove", function ()
        {
            iteration(fixedElements, function (elm)
            {
                if (elm.style.display !== 'none')
                {
                    elm.style.display = 'none';
                    elm.toShow = true;
                }
            });
            clearTimeout(timer);
        });

        window.addEventListener("touchend", function ()
        {
            clearTimeout(timer);
            timer = setTimeout(function ()
            {
                iteration(fixedElements, function (elm)
                {
                    if (elm.toShow) elm.style.display = 'block';
                    elm.toShow = false;
                });
            }, 200);
        });
    }

    // iphone
    if (ISQ.Http.browser.isIPhone) //#4151
    {
        window.addEventListener("touchstart", function ()
        {
            ISQ.Widget.HTML.queryField.blur();
        });
    }

    //////////////////////////////////////////////////////////////////////////
    // bottom padding to show avoid obscuring content
    ISQ.Widget.HTML.Mobile.setScrollPaddingHeight();
}
ISQ.Widget.HTML.Mobile.setScrollPaddingHeight = function (chatMode)
{
    if (ISQ.Widget.mobileHandlingMode !== ISQ.Widget.enumMobileHandlingMode.normalWidget || ISQ.Widget.HTML.Mobile.adjustableEmbedWidth) return;
    _('mobileScrollPadding').style.display = 'block';
    var h;
    if (chatMode)
        h = ISQ.Widget.HTML.Mobile.incrementedBottom_withChat;
    else
        h = ISQ.Widget.HTML.Mobile.incrementedBottom;

    if (ISQ.Widget.isFullScreen) h = 0; //Dont use it in mobile floating wiget

    _('mobileScrollPadding').style.height = h + "px";
}
ISQ.Widget.HTML.Mobile.beforeOpeningWidget = function ()
{
	// adding to instruct the server to ignore user statistics
    ISQ.Http.Cookies._write("nouserstats", "1", "/", ISQ.Http.domain(false), false);

    // API
    var d = [];
    if (ISQ.Widget.HTML.Mobile.formPredefinedData)
    {
        d.push("f=");
        d.push(ISQ.Widget.HTML.Mobile.formPredefinedData);
    }

    if (ISQ.Widget.HTML.Mobile.context)
    {
        if (d.length !== 0) d.push("&");
        d.push("c=");
        d.push(ISQ.Widget.HTML.Mobile.context);
    }
//    var customParams = ISQ.Widget.API.getCustomParams();
//    if (customParams)
//    {
//        if (d.length !== 0) d.push("&");
//        d.push("cp=");
//        d.push(ISQ.Data.jsonToString(customParams));
//    }
    if (d.length === 0) return;

    // saving API data (trying to use html5 localStorgae)
    if (window['localStorage'] && !ISQ.Http.browser.isIOS7)
        window['localStorage'].setItem("nanorep.api." + ISQ.Http.Cookies.encode64(ISQ.Widget.referer.escaped), d.join(''));
    else
        ISQ.Http.Cookies._write(ISQ.Http.Cookies.encode64(ISQ.Widget.referer.escaped), d.join(''), "/widget", ISQ.Http.domain(false), false);
}
ISQ.Widget.HTML.Mobile.hideAddressbar = function (time)
{
    if (ISQ.Widget.mobileHandlingMode !== ISQ.Widget.enumMobileHandlingMode.normalWidget) return;

    setTimeout(function ()
    {
        window.scrollTo(0, 1);
    }, time || 0);
}
ISQ.Widget.HTML.Mobile.setWidths = function (allowDuringResize)
{
    if (!ISQ.Http.browser.usesViewport) return;
    if (ISQ.Widget.HTML.currentlyResizing && !allowDuringResize) return;
    if (ISQ.Http.browser.isMobile && ISQ.Widget.mobileHandlingMode !== ISQ.Widget.enumMobileHandlingMode.normalWidget) return;

    var w;

    // title text
    w = ISQ.CSS.getElementWidth(_('widgetTitleWrapper'), true);
    w -= ISQ.CSS.getElementWidth(_('widgetTitleLeft'), true);
    w -= ISQ.CSS.getElementWidth(_('widgetTitleRight'), true);
    w -= ISQ.CSS.getElementWidth(_('minimizeButtonWrapper'), true);
    ISQ.CSS.setWidthIncludingPadding(ISQ.Widget.HTML.titleText, w - 20);

    // textbox
    if (_('searchContainer').offsetWidth !== 0 && ISQ.Widget.HTML.searchContainer.firstChild !== null)
    {
        w = ISQ.CSS.getElementWidth(_('searchContainerWrapper'), true);

        // fixing miss-calculation: setting max possible width.
        ISQ.CSS.setWidthIncludingPadding(_('txtSearch'), w - 20);

        w -= ISQ.CSS.getElementWidth(_('searchContainerLeft'), true);
        ISQ.Widget.HTML.searchContainer.firstChild.style.display = 'block';
        w -= ISQ.CSS.getElementWidth(ISQ.Widget.HTML.searchContainer.firstChild, true);
        w -= ISQ.CSS.getElementWidth(_('searchContainerRight'), true);
        w -= ISQ.CSS.getHorizonalMargin(_('txtSearch'));
        ISQ.CSS.setWidthIncludingPadding(_('txtSearch'), w - 20);
        ISQ.Widget.HTML.searchContainer.firstChild.style.display = 'none';

    }

    // chat status
    if (_('chatStatusContainer').offsetWidth !== 0)
    {

        w = ISQ.CSS.getElementWidth(_('chatStatusContainer'), true);
        // reducing icon
        w -= ISQ.CSS.getElementWidth(_('chatStatusIcon'), true);
        // reducing close chat
        w -= ISQ.CSS.getElementWidth(_('closeChat'), true);
        // reducing status margins
        w -= ISQ.CSS.getHorizonalMargin(_('chatStatus'));
        // setting width
        ISQ.CSS.setWidthIncludingPadding(_('chatStatus'), w - 20);
    }

    // txt chat input
    if (_('chatInputContainer').offsetWidth !== 0)
    {
        w = ISQ.CSS.getElementWidth(_('chatInputContainer'), true);
        w -= ISQ.CSS.getElementWidth(_('btnSendChat'), true);
        w -= ISQ.CSS.getHorizonalMargin(_('btnSendChat'));
        w -= ISQ.CSS.getHorizonalMargin(_('txtChatInput'));
        ISQ.CSS.setWidthIncludingPadding(_('txtChatInput'), w - 40);
    }
}

// #endregion

//#region PIE

ISQ.Widget.HTML.enablePIE = function ()
{
    if (!ISQ.Http.browser.isIE6 && !ISQ.Http.browser.isIE7 && !ISQ.Http.browser.isIE8) return;
    if (typeof (ISQ.Cnf.roundedCornersIEEnabled) !== 'undefined' && !ISQ.Cnf.roundedCornersIEEnabled) return;
    if (ISQ.Http.browser.isIE6 && !ISQ.Widget.isFloat) return; // PIE is disabled in embedded IE6
    if (ISQ.Http.browser.isIE6 && window.location.href.startsWith('https://')) return; // PIE is disabled in https IE6

    if (typeof PIE_init==="undefined")
    {
        ISQ.Tools.FileLoader.load("/common/GUI/PIE_uncompressed.js", new ISQ.Handler(function (tag)
        {
            ISQ.Widget.HTML.enablePIE();
        }), this);
        return;
    }
    PIE_init(); // initializing PIE
    if (typeof (PIE) === 'undefined') return;
    setTimeout(function () { PIE.attach(ISQ.Widget.HTML.titleWrapper); }, 0);
    setTimeout(function () { PIE.attach(ISQ.Widget.HTML.footerWrapper); }, 0);
    setTimeout(function () { PIE.attach(_('widgetMinimizedFooter')); }, 0);
    setTimeout(function () { PIE.attach(_('searchContainer')); }, 0);
    setTimeout(function () { PIE.attach(_('actionBarWrapper')); }, 0);
}
ISQ.Widget.HTML.disablePIE = function ()
{
    if (!ISQ.Http.browser.isIE6 && !ISQ.Http.browser.isIE7 && !ISQ.Http.browser.isIE8) return;
    if (typeof (ISQ.Cnf.roundedCornersIEEnabled) !== 'undefined' && !ISQ.Cnf.roundedCornersIEEnabled) return;
    if (typeof (PIE) === 'undefined') return;
    if (ISQ.Http.browser.isIE6 && !ISQ.Widget.isFloat) return; // PIE is disabled in embedded IE6
    if (ISQ.Http.browser.isIE6 && window.location.href.startsWith('https://')) return; // PIE is disabled in https IE6

    PIE.detach(ISQ.Widget.HTML.titleWrapper);
    PIE.detach(ISQ.Widget.HTML.footerWrapper);
    PIE.detach(_('widgetMinimizedFooter'));
    PIE.detach(_('searchContainer'));
    PIE.detach(_('actionBarWrapper'));
};

//#endregion PIE

//////////////////////////////////////////////////////////////////////////
// highlights the searchField when there's an error #7581
ISQ.Widget.HTML.highlightSearchFieldError = function (times, on)
{
    var textField = ISQ.Widget.HTML.searchContainer;
    if (on)
    {
        if (textField.className.indexOf('error') == -1) textField.oldClassName = textField.className;
        textField.className += ' error';
        times--;
    }
    else
    {
        textField.className = textField.oldClassName;
    }

    if (times) setTimeout(function () { ISQ.Widget.HTML.highlightSearchFieldError(times, !on) }, 150);
}


//create state changed event
if (!ISQ.Widget.stateChangedEvent) ISQ.Widget.stateChangedEvent = new ISQ.Event();

//////////////////////////////////////////////////////////////////////////
// adjusts elements and height of the content area inside the widget.
// runs at init and onresize

ISQ.Widget.HTML.resizeHandler = function (viewportSize, activateResizeTimer)
{
    if (!viewportSize) viewportSize = ISQ.Html.screenSize();

    ISQ.Widget.HTML.currentHeight = viewportSize.h;
    ISQ.Widget.HTML.currentWidth = viewportSize.w;

    // mobile widget on full page: set widths and continue normally on all except old android
    if (ISQ.Http.browser.isMobile && ISQ.Widget.mobileHandlingMode == ISQ.Widget.enumMobileHandlingMode.normalWidget)
    {
        ISQ.Widget.HTML.Mobile.setWidths();
        if (ISQ.Http.browser.oldAndroid) return; // not resizing on old android
    }

    //    top.document.getElementById("log").style.display = 'block';
    //    top.document.getElementById("log").innerHTML += "<br/>--------------resize handler:" + ISQ.Widget.HTML.currentHeight;
    //    top.document.getElementById("log").innerHTML += "<br/>--------------resize handler:" + _('widgetContainer').offsetHeight;

    // start resize timer
    if (activateResizeTimer && !ISQ.Widget.HTML.resizeTimer)
    {
        ISQ.Widget.HTML.currentlyResizing = true;
        ISQ.Widget.HTML.resizeTimer = setInterval(ISQ.Widget.HTML.resizeTimerElapsed, ISQ.Widget.HTML.resizeTimerInterval);
    }

    // check if we must collapse some elements while minimizing
    if (!ISQ.Widget.dynamicSize)
    {
        if (ISQ.Widget.HTML.currentHeight <= ISQ.Widget.HTML.htmlCollapseHeight)
        {
            ISQ.Widget.HTML.toTeaser();
        }
        else if (ISQ.Widget.HTML.isTeaser)
        {
            ISQ.Widget.HTML.toNormal();
        }
    }

    if (ISQ.Http.browser.isMobile)
    {
        // mobile devices doesn't show minimize button
        _('minimizeButtonWrapper').style.display = 'none';

        // setting title
        ISQ.Widget.setTitle();
    }

    // set content area height
    if (!ISQ.Http.browser.isMobile || window.top !== window || ISQ.Widget.isFullScreen)
    {
        var height = viewportSize.h;
        height -= _('widgetTitleWrapper').offsetHeight;
        height -= ISQ.Widget.HTML.searchWrapper.offsetHeight;
        if (ISQ.Widget.HTML.isTeaser && !ISQ.Widget.isFullScreen)
        {
            height -= _('widgetMinimizedFooter').offsetHeight;
            height -= _('chatStatusWrapper').offsetHeight;
        }
        else
        {
            height -= ISQ.Widget.HTML.footerWrapper.offsetHeight;
            var footerMarg = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.widgetFooter, 'margin-top');
            if (footerMarg)
                height -= parseInt(footerMarg);

            if (!ISQ.Widget.isFullScreen)
            {
                if (ISQ.CSS.getElementStyle(ISQ.Widget.HTML.actionBarWrapper, "position") !== "absolute")
                    height -= ISQ.Widget.HTML.actionBarWrapper.offsetHeight;
            }

            if (_("searchSuggestions").offsetHeight > 0)
                height -= _("searchSuggestions").offsetHeight;
            if (_('chatStatusWrapper').style.display !== 'none')
                height -= _('chatStatusWrapper').offsetHeight;

            height -= ISQ.Widget.HTML.chatInputWrapper.offsetHeight;
            // top & bottom margins for content area
            var marginTop = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.contentWrapper, 'margin-top');
            if (marginTop)
                height -= parseInt(marginTop);
            var marginBottom = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.contentWrapper, 'margin-bottom');
            if (marginBottom)
                height -= parseInt(marginBottom);
        }

        var border = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.widgetContainer, 'border-top-width', true);
        var borderInt = parseInt(border);
        if (!isNaN(borderInt)) height -= borderInt;

        border = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.widgetContainer, 'border-bottom-width');
        borderInt = parseInt(border);
        if (!isNaN(borderInt)) height -= borderInt;

        // set content area height
        if (height < 10) height = 0;
        ISQ.Widget.HTML.contentWrapper.style.height = height + "px";
    }

    // showing/hiding logo in collapsed mode
    if (ISQ.Cnf.showLogoInCollapsedMode)
    {
        if (!ISQ.Cnf.hideBranding && ISQ.Widget.HTML.currentWidth === ISQ.Cnf.floatCollapsed_WidgetSize[0]
            && ISQ.Widget.HTML.currentHeight === ISQ.Cnf.floatCollapsed_WidgetSize[1])
        {
            _('logoInCollapsedMode').style.display = 'block';
        }
        else
        {
            _('logoInCollapsedMode').style.display = 'none';
        }
    }

    // setting widths
    ISQ.Widget.HTML.Mobile.setWidths(true);

    //top.document.getElementById("log").innerHTML += "<br/>--------------resize handler:" + searchContainerWrapper.offsetHeight;
    //    ISQ.Widget.Log.add("--------------resize handler:" + height, ISQ.Widget.Log.statusEnum.RED);
    //    ISQ.Widget.Log.add("--------------resize handler caller:" + arguments.callee.caller, ISQ.Widget.Log.statusEnum.RED);
    //    ISQ.Widget.Log.add("--------------resize handler caller:" + arguments.callee.caller.caller, ISQ.Widget.Log.statusEnum.RED);
    //    ISQ.Widget.Log.add("--------------resize handler caller:" + arguments.callee.caller.caller.caller, ISQ.Widget.Log.statusEnum.RED);
}

//////////////////////////////////////////////////////////////////////////
// Showing action bar
ISQ.Widget.HTML.actionBarIsShown = false;
ISQ.Widget.HTML.showActionBar = function ()
{
    if (ISQ.Widget.HTML.currentlyResizing || ISQ.Widget.HTML.isTeaser)
    {
        ISQ.Widget.HTML.pendingShowActionBar = true;
        return;
    }

    ISQ.Widget.HTML.pendingShowActionBar = false;
    ISQ.Widget.HTML.actionBarIsShown = true;
    if (ISQ.Widget.HTML.canPerformFade(ISQ.Widget.HTML.actionBarContainer))
    {
        if (ISQ.Widget.HTML.actionBarFader === null)
        {
            ISQ.Widget.HTML.actionBarFader = new VisualEffects.Fade(ISQ.Widget.HTML.actionBarContainer);
            ISQ.Widget.HTML.actionBarFader.fadeOutEvent.addHandler(ISQ.Widget.HTML.post_hideActionBarFader);
            ISQ.Widget.HTML.actionBarFader.fadeInEvent.addHandler(ISQ.Widget.HTML.post_showActionBar);
        }
        // setting opacity 0
        ISQ.Widget.HTML.actionBarFader.setOpacity(0);
        ISQ.Widget.HTML.actionBarWrapper.style.display = 'block';
        ISQ.Widget.HTML.actionBarContainer.style.display = 'block';

        // starting fade
        ISQ.Widget.HTML.actionBarFader.fadeIn(500, true);

        // resizing the actionbar to the correct width in percentages;
        // default width is 70%
        if (ISQ.Widget.skinName == 'Arcade')
        {
            var brandingLogo = document.getElementById("customerBrandingText");
            var nanoLogoWidth = document.getElementById("footerNanoRepLink").offsetWidth;
            var logoWidth = 0;
            if (brandingLogo)
                logoWidth = brandingLogo.offsetWidth;
            var logosWidth = nanoLogoWidth + logoWidth;
            var actionBarPercentages = 70;
            while (logosWidth + ISQ.Widget.HTML.actionBarWrapper.offsetWidth + 10 > ISQ.Widget.HTML.footerWrapper.offsetWidth && actionBarPercentages > 0)
            {
                actionBarPercentages--;
                ISQ.Widget.HTML.actionBarWrapper.style.width = actionBarPercentages + "%";
            }

        }

        // setting content div height
        ISQ.Widget.HTML.resizeHandler();
    }
    else
    {
        ISQ.Widget.HTML.actionBarWrapper.style.display = 'block';
        ISQ.Widget.HTML.actionBarContainer.style.display = 'block';

        // setting content div height
        ISQ.Widget.HTML.resizeHandler();
    }
}
//////////////////////////////////////////////////////////////////////////
// Hiding action bar
ISQ.Widget.HTML.hide_finishFunction = null;
ISQ.Widget.HTML.hideActionBar = function (finishFunction, skipFade)
{
    ISQ.Widget.HTML.pendingShowActionBar = false;
    ISQ.Widget.Log.add("hide action bar");
    ISQ.Widget.HTML.actionBarIsShown = false;
    if (finishFunction) ISQ.Widget.HTML.hide_finishFunction = finishFunction;

    if (!skipFade && ISQ.Widget.HTML.canPerformFade(ISQ.Widget.HTML.actionBarContainer))
    {
        if (ISQ.Widget.HTML.actionBarFader === null)
        {
            ISQ.Widget.HTML.post_hideActionBarFader();
            return;
        }
        ISQ.Widget.HTML.actionBarFader.fadeOut(200);
    }
    else
    {
        ISQ.Widget.HTML.post_hideActionBarFader();
    }
}

ISQ.Widget.HTML.post_hideActionBarFader = function ()
{
    ISQ.Widget.HTML.actionBarWrapper.style.display = 'none';
    ISQ.Widget.HTML.actionBarContainer.style.display = 'none';

    // setting content div height
    ISQ.Widget.HTML.resizeHandler();

    if (ISQ.Widget.HTML.hide_finishFunction)
    {
        ISQ.Widget.HTML.hide_finishFunction();
        ISQ.Widget.HTML.hide_finishFunction = null;
    }
}

ISQ.Widget.HTML.post_showActionBar = function ()
{

}

//////////////////////////////////////////////////////////////////////////
// scrolls content wrapper to bottom
ISQ.Widget.HTML.scrollContentToBottom = function ()
{
    ISQ.Widget.HTML.contentWrapper.scrollTop = ISQ.Widget.HTML.contentWrapper.scrollHeight - ISQ.Widget.HTML.contentWrapper.offsetHeight;
}

//////////////////////////////////////////////////////////////////////////
// setting up limited mode
ISQ.Widget.HTML.limitedMode = function ()
{
    ISQ.Widget.Log.add("Widget is running in limited mode");
    ISQ.Widget.HTML.queryField.style.display = 'none';
    ISQ.Widget.HTML.queryField.style.visibility = 'hidden';
    ISQ.Widget.HTML.queryField.value = "Limited mode";
    ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.email, null, true);
    ISQ.Widget.HTML.queryField.value = "";
}

//////////////////////////////////////////////////////////////////////////
// interval function to perform resize when event doesn't fire
ISQ.Widget.HTML.resizePollingHandler = function ()
{
    var viewport = ISQ.Html.screenSize();
    if (viewport.h == ISQ.Widget.HTML.currentHeight && viewport.w === ISQ.Widget.HTML.currentWidth) return;

    ISQ.Widget.HTML.Mobile.hideAddressbar();
    ISQ.Widget.HTML.resizeHandler(viewport, true);
}


//////////////////////////////////////////////////////////////////////////
// fix answer widths for IE6 and IE7
ISQ.Widget.HTML.timeoutFixContent = 0;
ISQ.Widget.HTML.fixContentWidths = function ()
{
    ISQ.Widget.HTML.timeoutFixContent = 0;
    ISQ.Widget.HTML.fixContentWidths_internal();
}

ISQ.Widget.HTML.fixContentWidths_internal = function ()
{
    ///////// [IE7/IE6 FIX] ////////////
    //	when there's a vertical scroll, some parts of the table are hidden by scroll bar
    if (ISQ.Http.browser.isIE7 || ISQ.Http.browser.isIE6)
    {
        if (ISQ.Widget.HTML.contentWrapper.scrollHeight > ISQ.Widget.HTML.contentWrapper.offsetHeight) // in case of vertical scrollbars
        {
            var newWidth, paddingRight, paddingLeft;
            if ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) !== 0)
            {
                // we're going to set the widths of answer tables and contentArea to that of the content wrapper.
                // build the width
                newWidth = (ISQ.Widget.HTML.contentWrapper.offsetWidth - ISQ.Html.scrollBarWidth()) - 2;

                paddingLeft = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.chatPane, 'padding-left');
                paddingRight = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.chatPane, 'padding-right');
            }
            else
            {
                // we're going to set the widths of answer tables and contentArea to that of the title.
                // build the width
                newWidth = (ISQ.Widget.HTML.searchWrapper.offsetWidth - ISQ.Html.scrollBarWidth()) - 2;

                paddingLeft = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.answerPane, 'padding-left');
                paddingRight = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.answerPane, 'padding-right');
            }

            // fixing a bug happens when width<=0 (when float wasn't finished animating)
            if (newWidth <= 0)
            {
                if (++ISQ.Widget.HTML.timeoutFixContent < 40) // 2 seconds
                    setTimeout(ISQ.Widget.HTML.fixContentWidths_internal, 50);
                return;
            }

            if (paddingLeft)
                newWidth -= parseInt(paddingLeft);
            if (paddingRight)
                newWidth -= parseInt(paddingRight);
            newWidth += 'px';

            // set
            _('answerPane').style.width = newWidth;
            _('contentArea').style.width = newWidth;
            if (ISQ.Http.browser.isIE6 && ISQ.Widget.Localize.array["dir"] === "rtl")
            {
                // workaround for #2551
                var width = ISQ.Widget.HTML.searchWrapper.offsetWidth;
                if (width) { width = width + 'px' } else { width = 'auto' }
                setTimeout(function () { ISQ.Widget.HTML.searchWrapper.style.width = width }, 0);
            }
        }
        else
        {
            _('answerPane').style.width = 'auto';
            _('contentArea').style.width = '100%';
        }
    }
}

//////////////////////////////////////////////////////////////////////////
// method returns true if there is content shown:
// in escalation state or is questions and there are answers shown
ISQ.Widget.HTML.hasContent = function ()
{
    if ((ISQ.Widget.state & ISQ.Widget.enumState.allEscalations) !== 0) return true;
    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions) // auto questions
        return _query(true, true).length !== 0;
    if (ISQ.Widget.state & ISQ.Widget.enumState.questions) // normal questions
        return _query(true, false).length !== 0;
    return false;
}

//////////////////////////////////////////////////////////////////////////
// minimizeBtnClicked
ISQ.Widget.HTML.minimizeBtnClicked = function ()
{
    ISQ.Widget.HTML.Mobile.ignoreClickEvent = true;
    var openExpand = ISQ.Widget.HTML.hasContent();

    // raising a flag to ignore next click event (raised due to user clicked on minimize)
    ISQ.Widget.HTML.ignoreNextClickEvent = true;
    ISQ.Widget.CDC.sendMessage("subject=minimize&openExpand=" + openExpand, true);

    // stop auto questions
    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions)
    {
        ISQ.Widget.Query.clearTextboxOnInteraction = true;
        ISQ.Widget.AutoQuestions.stop_();
    }
}

//////////////////////////////////////////////////////////////////////////
// collapses some html elements when in transitioning to minimized mode
ISQ.Widget.HTML.toTeaser = function ()
{
    ISQ.Widget.HTML.isTeaser = true;
    ISQ.Widget.HTML.contentWrapper.className = 'empty';
    ISQ.Widget.HTML.footerWrapper.style.display = 'none';
    _('widgetMinimizedFooter').style.display = 'block';
    if (ISQ.Widget.isFloat) _('minimizeButtonWrapper').style.display = 'none';
    // hiding search suggestions
    if (_('searchSuggestions').childNodes.length > 0) _('searchSuggestions').style.display = "none";
    ISQ.Widget.HTML.actionBarWrapper.style.display = 'none';

    // hide clear query button
    ISQ.Widget.HTML.clearQuery.hide();

    if ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) !== 0) // chat mode
    {
        if (!ISQ.Widget.HTML.chatStatus.originalText) // save original chat status text and auto-ellipsis
        {
            ISQ.Widget.HTML.chatStatus.originalText = ISQ.Widget.HTML.chatStatus.innerHTML;
            ISQ.Data.autoEllipseText(ISQ.Widget.HTML.chatStatus.innerHTML, ISQ.Widget.HTML.chatStatus.offsetWidth, ISQ.Widget.HTML.chatStatus);
        }
        _('closeChat').style.display = 'none';
        _('chatPane').style.display = 'none';
        ISQ.Widget.HTML.chatInputWrapper.style.display = 'none';
        _('chatStatusContainer').className = 'chatStatusContainerMinimized';
    }
    else if (ISQ.Widget.state === ISQ.Widget.enumState.contactForm) // contact form mode
    {
        _('contactForm').style.display = 'none';
    }
    else
    {
        _('answerPane').style.display = 'none';
    }

    // updating title
    ISQ.Widget.setTitle();

    //fire event
    ISQ.Widget.stateChangedEvent.dispatch('teaser');
}


ISQ.Widget.HTML.showMinimizeIcon = function ()
{
    if (!ISQ.Widget.spriteLoaded)
    {
        _('minimizeButton').className += "widgetActive";
        ISQ.Widget.spriteLoaded = true;
    }
}

//////////////////////////////////////////////////////////////////////////
// expands the elements that were hidden in ISQ.Widget.HTML.toTeaser()

ISQ.Widget.HTML.toNormal = function ()
{
    ISQ.Widget.HTML.isTeaser = false;
    ISQ.Widget.HTML.contentWrapper.className = '';
    _('widgetMinimizedFooter').style.display = 'none';
    if (ISQ.Widget.isFloat)
    {
        _('minimizeButtonWrapper').style.display = 'inline';
        ISQ.Widget.HTML.showMinimizeIcon();
    }
    // showing actionBar if there's a reason for it
    if (ISQ.Widget.HTML.hasContent() && ISQ.Widget.Query.numberOfTopics !== 0 && (ISQ.Widget.state & ISQ.Widget.enumState.nonChatEscalations) === 0)
        ISQ.Widget.HTML.actionBarWrapper.style.display = 'block';

    // showing search suggestions
    if (_('searchSuggestions').childNodes.length > 0) _('searchSuggestions').style.display = "block";

    // showing answer pane if in auto/question state
    if ((ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) !== 0)
        _('answerPane').style.display = 'block';

    // show clear query button
    if (ISQ.Widget.HTML.hasContent()) ISQ.Widget.HTML.clearQuery.show();

    // when in chat mode
    if ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) !== 0)
    {
        if (ISQ.Widget.HTML.chatStatus.originalText) // restore original text
        {
            ISQ.Widget.HTML.chatStatus.innerHTML = ISQ.Widget.HTML.chatStatus.originalText;
            ISQ.Widget.HTML.chatStatus.originalText = null;
        }
        _('chatPane').style.display = 'block';
        _('closeChat').style.display = 'block';
        if (ISQ.Widget.state !== ISQ.Widget.enumState.chatSurvey)
            ISQ.Widget.HTML.chatInputWrapper.style.display = 'block';
        _('chatStatusContainer').className = '';
    }
    else if (ISQ.Widget.state === ISQ.Widget.enumState.contactForm) // contact form mode
    {
        _('contactForm').style.display = 'block';
    }

    // showing footer if not in contact form state
    if (ISQ.Widget.state !== ISQ.Widget.enumState.contactForm || ISQ.Cnf.showFooterWithContactForm !== false)
        ISQ.Widget.HTML.footerWrapper.style.display = 'block';

    // updating title
    ISQ.Widget.setTitle();

    // restore paged answer scrolls
    if (ISQ.Widget.HTML.answerPane.restorePagerScroll)
        ISQ.Widget.HTML.answerPane.restorePagerScroll();

    //fire event
    ISQ.Widget.stateChangedEvent.dispatch('normal');
}

//////////////////////////////////////////////////////////////////////////
// does the given element support fade in/out
ISQ.Widget.HTML.canPerformFade = function (element)
{
    // fade was calculated
    if (typeof (element.isFadeAvailable) === 'bool') return element.isFadeAvailable;
    if (ISQ.Http.browser.app !== 'ie' || ISQ.Http.browser.isIE11)
    {
        element.isFadeAvailable = true;
        //ISQ.Widget.Query.isFadeAvailable = true;
        return element.isFadeAvailable;
    }

    // in IE browsers: verifying background is NOT transparent
    var bgColor = ISQ.CSS.getElementStyle(element, "background-color");
    if (!bgColor || bgColor.toLowerCase() == 'transparent')
        element.isFadeAvailable = false;
    else
        element.isFadeAvailable = true;

    return element.isFadeAvailable;
}

//////////////////////////////////////////////////////////////////////////
// runs during setHeights animation. fires events for animation started or stopped
ISQ.Widget.HTML.resizeTimerElapsed = function ()
{
    // first time
    if (!ISQ.Widget.HTML.lastWindowSize)
    {
        ISQ.Widget.HTML.lastWindowSize = {};

        // animation started
        ISQ.Widget.HTML.resizeStarted();
    }

    if (ISQ.Widget.HTML.currentHeight == ISQ.Widget.HTML.lastWindowSize.h && ISQ.Widget.HTML.currentWidth == ISQ.Widget.HTML.lastWindowSize.w)
    {
        // clear interval
        clearInterval(ISQ.Widget.HTML.resizeTimer);
        ISQ.Widget.HTML.resizeTimer = null;
        ISQ.Widget.HTML.lastWindowSize = null;

        // resize animation stopped
        ISQ.Widget.HTML.currentlyResizing = false;
        ISQ.Widget.HTML.resizeStopped();
        return;
    }

    // save current dimensions
    ISQ.Widget.HTML.lastWindowSize.h = ISQ.Widget.HTML.currentHeight;
    ISQ.Widget.HTML.lastWindowSize.w = ISQ.Widget.HTML.currentWidth;
}

//////////////////////////////////////////////////////////////////////////
// called when resize animation start has been detected by the timer
ISQ.Widget.HTML.resizeStarted = function ()
{
    // hide action bar
    if (!ISQ.Widget.dynamicSize && !ISQ.Http.browser.isMobile)
    {
        ISQ.Widget.HTML.actionBarWrapper.style.display = 'none';
        ISQ.Widget.HTML.actionBarContainer.style.display = 'none';
    }
}

//////////////////////////////////////////////////////////////////////////
// called when resize animation stop has been detected by the timer
ISQ.Widget.HTML.resizeStopped = function ()
{
    // working around some bugs with PIE
    if (ISQ.Http.browser.isIE6 || ISQ.Http.browser.isIE7)
    {
        ISQ.Widget.HTML.disablePIE();
        ISQ.Widget.HTML.enablePIE();
    }

    // working around scrolltop bug with FF 3.x
    if (ISQ.Widget.dynamicSize && ISQ.Http.browser.app == "ff" && ISQ.Http.browser.version.indexOf('3.') === 0)
    {
        document.body.scrollTop = 0;
    }

    if (ISQ.Widget.HTML.isTeaser) return;

    // show the action bar if needed
    if (ISQ.Widget.HTML.pendingShowActionBar)
    {
        if (ISQ.Widget.state == ISQ.Widget.enumState.questions)
        {
            ISQ.Widget.Query.showActionBar();
        }
        else if (ISQ.Widget.state == ISQ.Widget.enumState.chat)
        {
            ISQ.Widget.HTML.showActionBar();
            if (ISQ.Widget.iChat.instance && ISQ.Widget.iChat.instance.resumingChat()) ISQ.Widget.HTML.scrollContentToBottom();
        }
        else if (ISQ.Widget.state == ISQ.Widget.enumState.chatSurvey)
        {
            ISQ.Widget.HTML.showActionBar();
        }
    }
    else if (ISQ.Widget.HTML.actionBarIsShown)
    {
        if (ISQ.Http.browser.isMobile)
        {
            ISQ.Widget.Query.showActionBar();
        }
        else if (!ISQ.Widget.dynamicSize)
        {
            //ISQ.Widget.HTML.actionBarWrapper.style.display = 'block';
            //ISQ.Widget.HTML.actionBarContainer.style.display = 'block';
            ISQ.Widget.HTML.showActionBar();
            ISQ.Widget.HTML.resizeHandler();
        }
    }
    // fixing bug which contact forms in ie6,7 (#2497)
    // didn't appear well after widget enlarge
    else if (ISQ.Widget.state === ISQ.Widget.enumState.contactForm && (ISQ.Http.browser.isIE7 || ISQ.Http.browser.isIE6) && _('clientFormTabDivs'))
    {
        _('clientFormTabDivs', true).style.display = 'none';
        _('clientFormTabDivs').style.display = 'block';
    }

    // handle customer logo if needed
    if (_('customerLogo').pendingResize)
        ISQ.Widget.onCustomerLogoLoad();

    // resizing elements inside answers
    if ((ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) !== 0)
        ISQ.Widget.Query.resizeAnswerElements();

    // setting widths
    ISQ.Widget.HTML.Mobile.setWidths();

    // restore paged answer scrolls
    if (ISQ.Widget.HTML.answerPane.restorePagerScroll)
        ISQ.Widget.HTML.answerPane.restorePagerScroll();
    ISQ.Widget.HTML.dynamicSize_sendMessage();


    if (ISQ.Widget.ContactForm.mResizeContactForm)
    {
        var functionToExecute = ISQ.Widget.ContactForm.mResizeContactForm;
        ISQ.Widget.ContactForm.mResizeContactForm = null;
        functionToExecute();
        functionToExecute = null;
    }
};
ISQ.Widget.HTML.showRechannelingChatButton = function () {
    _("repByChatRech").style.display = "block";
}
//////////////////////////////////////////////////////////////////////////
// sends a message about new size
ISQ.Widget.HTML.dynamicSize_sendMessageTimer = null;
ISQ.Widget.HTML.dynamicSize_sendMessage = function (firstRequest, force,limit)
{
    if (!ISQ.Widget.dynamicSize && !force) return;

    // canceling previous timer
    if (ISQ.Widget.HTML.dynamicSize_sendMessageTimer)
        clearTimeout(ISQ.Widget.HTML.dynamicSize_sendMessageTimer);

    // height function
    var calcHeightFunction = function ()
    {
        limit = limit || ISQ.Widget.dynamicMaxSize;

        // removing scrollbars from wrapper to get an accurate height
        var wrapper = ISQ.Widget.HTML.contentWrapper;
        wrapper.style.overflowY = 'hidden';
        // getting page size (including vertical scroll)
        var height = 0;

        // hiding blocker div
        if (ISQ.Widget.HTML.shownOverlay) _('widgetBlocker').style.display = 'none';

        // iframes in webkit doesn't return a correct value of scrollHeight
        if (ISQ.Http.browser.app === 'chrome' || ISQ.Http.browser.app === 'safari' || ISQ.Http.browser.isMobile || (ISQ.Http.browser.isAndroid && ISQ.Http.browser.isTablet))
        {
            var border = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.widgetContainer, 'border-top-width');
            var borderInt = parseInt(border);
            if (!isNaN(borderInt)) height += borderInt;

            border = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.widgetContainer, 'border-bottom-width');
            borderInt = parseInt(border);
            if (!isNaN(borderInt)) height += borderInt;
            height += ISQ.Widget.HTML.widgetContainer.scrollHeight;
        }
        else
        {
            var pageSize = ISQ.Html.pageSize(false, true);
            height += pageSize.h;
        }
        // content area height
        if ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) !== 0)
        {
            // in chat mode
            var chatHeight = 250;
            if (ISQ.Widget.Chat.chatConfig.heightInDynamicEmbed)
                chatHeight = ISQ.Widget.Chat.chatConfig.heightInDynamicEmbed;
            height += chatHeight - wrapper.offsetHeight;
        }
        else
            height += _('contentArea').scrollHeight - wrapper.offsetHeight;

        // enforcing dynamic max height (except in faq mode and contact form mode )

        if (limit && height > limit)
        {
            if (!ISQ.Widget.FAQ.shown && ISQ.Widget.state != ISQ.Widget.enumState.contactForm)
            {
                wrapper.style.overflowY = 'auto';
                height = limit;
            }
        }

        if ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) !== 0) // enable auto-scroll in chat mode
        {
            wrapper.style.overflowY = 'auto';
        }

        if (ISQ.Widget.isFullScreen && ISQ.Widget.state  ==  ISQ.Widget.enumState.contactForm) // enable auto-scroll for contacxt form in mobile widget
        {
            wrapper.style.overflowY = 'auto';
        }

        // if an overlay is shown
        if (ISQ.Widget.HTML.shownOverlay)
        {
            _('widgetBlocker').style.display = 'block';
            var totalHeight = ISQ.Widget.HTML.shownOverlay.offsetHeight +
                    ISQ.Widget.HTML.titleWrapper.offsetHeight +
                    ISQ.Widget.HTML.searchWrapper.offsetHeight +
                    ISQ.Widget.HTML.actionBarWrapper.offsetHeight;
            if (totalHeight > height) height = totalHeight;
            ISQ.Widget.HTML.updateOverlayTop(ISQ.Widget.HTML.shownOverlay);
        }

        ISQ.Widget.CDC.sendMessage("subject=setSize&height=" + height);
    }

    if (firstRequest === true) // first request: sending height immediately
    {
        calcHeightFunction();
    }
    else // sending message after current callstack
    {
        ISQ.Widget.HTML.dynamicSize_sendMessageTimer = setTimeout(function ()
        {
            calcHeightFunction();
        }, 0);
    }
};

////////////////////////////////////////////////////////////////////////////
// overlay hnadling
ISQ.Widget.HTML.showOverlay = function (contentDiv)
{
    // showing data
    var blocker = _('widgetBlocker');
    blocker.style.display = 'block';
    if (_('blockerContent') != contentDiv) _('blockerContent').style.display = 'none';
    contentDiv.blocker = blocker;
    contentDiv.style.display = 'block';
    ISQ.Widget.HTML.shownOverlay = contentDiv;

    // horizontal alignment
    var left = (ISQ.Widget.HTML.contentWrapper.offsetWidth - contentDiv.offsetWidth) / 2;
    contentDiv.style.left = left + 'px';

    // vertical alignment
    ISQ.Widget.HTML.updateOverlayTop(contentDiv);
}
ISQ.Widget.HTML.updateOverlayTop = function (contentDiv)
{
    var top = ISQ.Widget.HTML.actionBarWrapper.offsetTop - contentDiv.offsetHeight;
    contentDiv.style.top = top + 'px';
}
ISQ.Widget.HTML.hideOverlay = function (contentDiv)
{
    contentDiv.style.display = 'none';
    contentDiv.blocker.style.display = 'none';
    ISQ.Widget.HTML.shownOverlay = null;

    // updating widget's height
    ISQ.Widget.HTML.dynamicSize_sendMessage();
}

//////////////////////////////////////////////////////////////////////////
// members
ISQ.Widget.HTML.currentHeight = 0;
ISQ.Widget.HTML.currentWidth = 0;
ISQ.Widget.HTML.isTeaser = false;
ISQ.Widget.HTML.htmlCollapseHeight = 85; // the height beyond which some widget html elements disappear when it's being minimized
ISQ.Widget.HTML.searchAnim = null; // search animator
ISQ.Widget.HTML.contentFader = null; // content faded blocker
ISQ.Widget.HTML.actionBarFader = null;
ISQ.Widget.HTML.ignoreNextClickEvent = false;
ISQ.Widget.HTML.currentlyResizing = false;
ISQ.Widget.HTML.resizeTimerInterval = 100;
ISQ.Widget.HTML.resizeTimer = null;
ISQ.Widget.HTML.lastWindowSize = null;
ISQ.Widget.HTML.pendingShowActionBar = false;
ISQ.Widget.HTML.chatProviderChanged = false;
ISQ.Widget.HTML.dynamicRTLCssLoaded = true;
ISQ.Widget.HTML.shownOverlay = null;

//#endregion

/********************************************************
//////////////// [ AUTO QUESTIONS ] /////////////////////
********************************************************/
//#region auto questions
ISQ.Widget.AutoQuestions = initializeNS('ISQ.Widget.AutoQuestions');
/// question array ///
ISQ.Widget.AutoQuestions.array = null;
/// question change interval ///
ISQ.Widget.AutoQuestions.interval = 10000;
/// current question index ///
ISQ.Widget.AutoQuestions.currentIndex = -1;
/// time out object ///
ISQ.Widget.AutoQuestions.timeout = null;
/// repeat auto questions
ISQ.Widget.AutoQuestions.repeatMode = true;

/// init ///
ISQ.Widget.AutoQuestions.init = function (questions, interval, repeat)
{
    if (!questions) return false;
    ISQ.Widget.AutoQuestions.array = new Array();
    var qArray = questions.split(";");
    var l = qArray.length;
    for (var i = 0; i < l; ++i)
    {
        if (qArray[i].Trim() != '') ISQ.Widget.AutoQuestions.array.push(qArray[i]);
    }
    ISQ.Widget.AutoQuestions.interval = !isNaN(interval) ? parseInt(interval) : ISQ.Widget.AutoQuestions.interval;
    ISQ.Widget.AutoQuestions.repeatMode = repeat === true && ISQ.Widget.AutoQuestions.array.length > 1;

    ISQ.Widget.Log.add("Initiated " + ISQ.Widget.AutoQuestions.array.length + " auto questions with " + ISQ.Widget.AutoQuestions.interval + " interval between them");

    ISQ.Widget.state = ISQ.Widget.enumState.autoQuestions;
    return true;
}
/// show next ///
ISQ.Widget.AutoQuestions.showNext = function ()
{
    ISQ.Widget.AutoQuestions.timeout = setTimeout(ISQ.Widget.AutoQuestions.go, ISQ.Widget.AutoQuestions.interval);
}

/// starts the auto question cycle ///
ISQ.Widget.AutoQuestions.go = function ()
{
    if (ISQ.Widget.AutoQuestions.array === null || ISQ.Widget.AutoQuestions.array.length < 1) return;

    var l = ISQ.Widget.AutoQuestions.array.length;
    var next = ISQ.Widget.AutoQuestions.currentIndex + 1;
    if (next === l)
    {
        if (!ISQ.Widget.AutoQuestions.repeatMode) return;
        next = 0;
    }
    var question = ISQ.Widget.AutoQuestions.array[next];
    ISQ.Widget.AutoQuestions.currentIndex = next;

    // asking the question
    ISQ.Widget.Query.ask(question, ISQ.Widget.Query.enumTextQuerySource.linkedAnswer);

    //// canceling input field focus when auto question
    if (ISQ.Cnf.initialText === "") ISQ.Widget.HTML.queryField.blur();
}

/// stops the auto question cycle ///
ISQ.Widget.AutoQuestions.stop_ = function ()
{
    ISQ.Widget.state = ISQ.Widget.enumState.questions;

    clearTimeout(ISQ.Widget.AutoQuestions.timeout);
    if (ISQ.Widget.Query.typeTimer !== null)
    {
        ISQ.Widget.Query.typeTimer.cancel();
        ISQ.Widget.Query.typeTimer.dispose();
        ISQ.Widget.Query.typeTimer = null;
    }

    // resetting last query sent
    // to allow users to ask the same question
    // as the last asked auto question
    ISQ.Widget.Query.lastQuerySent = "";
}

/// gets the current question string ///
ISQ.Widget.AutoQuestions.getCurrentQuestion = function ()
{
    return ISQ.Widget.AutoQuestions.array[ISQ.Widget.AutoQuestions.currentIndex];
}
//#endregion



/********************************************************
//////////////////// [ Protocol ] ///////////////////////
********************************************************/
//#region session
ISQ.Widget.Protocol = {};
ISQ.Widget.Protocol.client = null;
ISQ.Widget.Protocol.onConnectionStateChange = function (previousState, currentState)
{
    switch (currentState)
    {
        // session has expired
        case ISQ.Com.JsonP.Client.enumState.DISCONNECTED:
            ISQ.Widget.Log.add('connectionState has changed: Disconnected');
            if (ISQ.Widget.ContactForm.preview) ISQ.Widget.ContactForm.preview.sessionEnded();
            break;
        // session is connected
        case ISQ.Com.JsonP.Client.enumState.CONNECTED:
            ISQ.Widget.Log.add('connectionState has changed: Connected to account ' + ISQ.Widget.account + ". sid: " + _session().id());
            break;
        // connecting
        case ISQ.Com.JsonP.Client.enumState.CONNECTING:
            ISQ.Widget.Log.add('connectionState has changed: Connecting');
            if (ISQ.Widget.ContactForm.preview) ISQ.Widget.ContactForm.preview.sessionEnded();
            break;

        // login has failed
        case ISQ.Com.JsonP.Client.enumState.FAILED:
            ISQ.Widget.Log.add('connectionState has changed: Login has failed', ISQ.Widget.Log.statusEnum.RED);
            break;
    }
}
var _session = function ()
{
    if (!ISQ.Widget.Protocol.client)
    {
        ISQ.Widget.Protocol.client = new ISQ.Com.JsonP.Client(
        {
            host: ISQ.Widget.dynamicHost,
            urlPrefix: '/api/widget/v1/',
            defaultTimeout: 8000,
            account: ISQ.Widget.account,
            loginParams:
            {
                internal: "true",
                url: ISQ.Widget.referer.escaped,
                doctype: ISQ.Http.hashArguments["doctype"],
                configId: ISQ.Widget.configId,
                kb: (ISQ.Http.hashArguments["kb"] || ISQ.Http.urlArguments["kb"]),
                nostats: !!ISQ.Widget.isPreview,
                ctx: null,
                values: null
            },
            fStateChanged: this.onConnectionStateChange
        });
    }
    return ISQ.Widget.Protocol.client;
}
//#endregion


/********************************************************
//////////////////// [ QUERY ] //////////////////////////
********************************************************/
//#region query
ISQ.Widget.Query = initializeNS('ISQ.Widget.Query'); ;

ISQ.Widget.Query.isSameQuery = false;
ISQ.Widget.Query.lastQuerySent = '';
ISQ.Widget.Query.lastSuggestionSent = '';
ISQ.Widget.Query.lastWrittenQuery = null;
ISQ.Widget.Query.lastQuerySource = null;
ISQ.Widget.Query.lastQuerySent_time = null;
ISQ.Widget.Query.pendingRequest = false;
ISQ.Widget.Query.timer = null;
ISQ.Widget.Query.activeRequestId = -1;
ISQ.Widget.Query.ignoreKeyCodes = new Array();
ISQ.Widget.Query.kbLanguageCode = '';
ISQ.Widget.Query.numberOfTopics = 0;
ISQ.Widget.Query.contextOnlyAnswers = 0;
ISQ.Widget.Query.currentAnswers = null;
ISQ.Widget.Query.currentAnswersForComparison = null;
ISQ.Widget.Query.firstAnswerId = -1;
ISQ.Widget.Query.ticketingInterface = null;
ISQ.Widget.Query.chatEscalationAction = null;
ISQ.Widget.Query.chatInviteContent = null;
ISQ.Widget.Query.chatPushAnswers = { pushed: false };
ISQ.Widget.Query.fader = null;
ISQ.Widget.Query.cachedAnswerTranslationDelimiter = ":";
ISQ.Widget.Query.previousDetectedLanguage = null;
ISQ.Widget.Query.previousResponseWasAutoQuestion = false;
ISQ.Widget.Query.queryTranslator = null;
ISQ.Widget.Query.answerTranslator = null;
ISQ.Widget.Query.queryChangedEvent = null;
ISQ.Widget.Query.typeTimer = null;
ISQ.Widget.Query.typeInterval = 50;
ISQ.Widget.Query.questionsTrail = null;
ISQ.Widget.Query.tempQuestionTrailId = null;
ISQ.Widget.Query.gettingAnswerById = false;
ISQ.Widget.Query.setFocusByScript = false;
ISQ.Widget.Query.firstUserTyping = true;
ISQ.Widget.Query.clearTextboxOnInteraction = false;
ISQ.Widget.Query.searchDelay_min = 250;
ISQ.Widget.Query.searchDelay_max = 2500;
ISQ.Widget.Query.searchDelay_history = new ISQ.Infra.LinkedList();
ISQ.Widget.Query.elementsToResize = null;
ISQ.Widget.Query.resizeableTags = ["IMG", "OBJECT", "EMBED", "IFRAME"];
ISQ.Widget.Query.lastQueryTranslation = null;
ISQ.Widget.Query.resizeToWidth = 0;
ISQ.Widget.Query.mobile_previousValue = null;
ISQ.Widget.Query.mobile_ignoreNextChange = false;
ISQ.Widget.Query.userActiveReported = false;
ISQ.Widget.Query.lastAutoQuestionRequestId = -1;
ISQ.Widget.Query.contextCategories = null;
ISQ.Widget.Query.scrollInterval = null;
ISQ.Widget.Query.peekElementHeight = 27;
ISQ.Widget.Query.rechannelingOptions = null;
ISQ.Widget.Query.activateAutoLink = null;
ISQ.Widget.Query.resetAutoLink = null;
ISQ.Widget.Query.autoLinkAnimationTime = {slow: 2.0, fast: 0.85, superFast: 0.5};

var _query = function (toTrim, includeInitialText)
{
    var value = ISQ.Widget.HTML.queryField.value;
    if (!ISQ.Widget.userActive && !includeInitialText) return '';
    if (toTrim === true) value = value.Trim();
    return value;
}
ISQ.Widget.Query.init = function ()
{
    // inserting ignore key codes to hashtable
    ISQ.Widget.Query.ignoreKeyCodes[13] = true;
    ISQ.Widget.Query.ignoreKeyCodes[16] = true;
    ISQ.Widget.Query.ignoreKeyCodes[17] = true;
    ISQ.Widget.Query.ignoreKeyCodes[18] = true;
    ISQ.Widget.Query.ignoreKeyCodes[20] = true;
    ISQ.Widget.Query.ignoreKeyCodes[37] = true;
    ISQ.Widget.Query.ignoreKeyCodes[38] = true;
    ISQ.Widget.Query.ignoreKeyCodes[39] = true;
    ISQ.Widget.Query.ignoreKeyCodes[40] = true;
    ISQ.Widget.Query.ignoreKeyCodes[91] = true;
    ISQ.Widget.Query.ignoreKeyCodes[92] = true;
    //ISQ.Widget.Query.ignoreKeyCodes[32] = true; space

    // search animator
//    ISQ.Widget.HTML.searchAnim = new ISQ.GUI.ProgressAnimation(
//    {
//        container: createDiv(ISQ.Widget.HTML.searchContainer, ".searchAnim"),
//        onShow: function () { ISQ.CSS.addClass(ISQ.Widget.HTML.contentArea, 'busy'); },
//        onHide: function () { ISQ.CSS.removeClass(ISQ.Widget.HTML.contentArea, 'busy'); }
//    });


    ISQ.Widget.HTML.contentFader =
    {
        show : function()
        {
            ISQ.CSS.addClass(ISQ.Widget.HTML.contentArea, 'busy');
        },
        hide : function()
        {
            ISQ.CSS.removeClass(ISQ.Widget.HTML.contentArea, 'busy');
        }
    };

    // query changed event
    ISQ.Widget.Query.queryChangedEvent = new ISQ.Event();


    // search delay
    var srchDelay = ISQ.Http.hashArguments["searchdelay"] || ISQ.Http.urlArguments["searchdelay"];
    if (srchDelay) srchDelay = parseInt(srchDelay);
    if (!isNaN(srchDelay)) ISQ.Widget.Query.searchDelay_min = srchDelay;

    // 1. mobiles/tablets don't fire key events for hebrew/pinyin characters
    // 2. japanese / chinese keyboards on don't fire keyup events on FF (#8174)
    if ((ISQ.Http.browser.isMobile && ISQ.Widget.mobileHandlingMode === ISQ.Widget.enumMobileHandlingMode.normalWidget)
        || ISQ.Http.browser.isTablet || ((ISQ.Cnf.kbLanguageCode == 'ja' || ISQ.Cnf.kbLanguageCode == 'zh') && ISQ.Http.browser.app == "ff"))
    {
        ISQ.Widget.Query.mobile_previousValue = ISQ.Cnf.initialText || null;
        setInterval(ISQ.Widget.Query.queryInterval_mobile, 100);
        ISQ.Widget.HTML.queryField.onkeyup = null;
    }

    // initiating auto complete
    ISQ.Widget.Suggestions.init();

    // code that should stop ipad from freezing when touch event is made on an input element when there are many elements in the dom
    /* if (ISQ.Http.browser.isIPad)
    {
    var scroll = 0;
    document.addEventListener("touchstart", function (e)
    {
    scroll = document.body.scrollTop;
    });

    document.addEventListener("touchend", function (e)
    {
    var node = e.target.nodeName.toString().toUpperCase();
    if (node == 'INPUT' || node == 'TEXTAREA' || node == 'SELECT')
    {
    e.preventDefault();
    }
    });
    }*/
};

ISQ.Widget.Query.queryInterval_mobile = function ()
{
    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions) return;
    if (ISQ.Widget.Query.typeTimer && !ISQ.Widget.Query.typeTimer.isDisposed()) return; // auto-typing effect currently running

    var q = _query(false, true);
    if (q === ISQ.Widget.Query.mobile_previousValue) return;
    ISQ.Widget.Query.mobile_previousValue = q;
    if (ISQ.Widget.Query.mobile_ignoreNextChange)
    {
        ISQ.Widget.Query.mobile_ignoreNextChange = false;
        return;
    }

    ISQ.Widget.userActive = true;

    // creating event object
    var evt = {
        keyCode: q.charCodeAt(q.length - 1)
    };

    ISQ.Widget.Query.keyUpHandler(evt);
};


ISQ.Widget.chatScriptLoaded = false;
ISQ.Widget.Query.onFocusHandler = function (evt)
{
    // ON FOCUS HANDLER SUPPOSES
    // TO SEND A 'FOCUS' MESSAGE TO FLOAT.
    // initiating translations
    ISQ.Widget.Translation.init();
    ISQ.Widget.FAQ.initalize();
    if (ISQ.Http.browser.isMobile)
    {
        // inactive
        if (ISQ.Widget.mobileHandlingMode === ISQ.Widget.enumMobileHandlingMode.inactive)
            ISQ.Widget.HTML.queryField.blur();
        // normal widget
        else
        {
            // when gettingAnswerById, we use focusHandler to clear the textbox instead of onClickHandler in android since onClick isn't supported well
            if (ISQ.Http.browser.isAndroid && (ISQ.Widget.Query.gettingAnswerById || !ISQ.Widget.userActive))
            {
                ISQ.Widget.Query.clearTextboxOnInteraction = true;
                ISQ.Widget.Query.userInteractionHandler(evt);
            }
            ISQ.Widget.HTML.Mobile.hideAddressbar(20);
        }
        return;
    }

    if (!ISQ.Widget.sendingCDCMessages)
    {
        ISQ.Widget.HTML.queryField.onfocus = null;
        return false;
    }
    // sending focus message to float
    else if (ISQ.Widget.isFloat)
    {
        ISQ.Widget.CDC.sendMessage('subject=textfieldFocus');
    }
}
var forceBlur = function ()
{
    document.activeElement.blur();
    window.focus();
}

ISQ.Widget.onBlurHandler = function ()
{

    // fix ipad problem where keyboard doesn't work, forcing focus out from query field
    if (ISQ.Http.browser.isIPad && document.activeElement == ISQ.Widget.HTML.queryField)
        document.getElementById('ipadFocusOut').focus();

    if (!ISQ.Widget.sendingCDCMessages) return;

    // hiding auto suggestions
    ISQ.Widget.Suggestions.hide(_('searchSuggestions'));

    // sending blur message to float
    if (ISQ.Widget.isFloat) ISQ.Widget.CDC.sendMessage("subject=blur");
}

ISQ.Widget.Query.onBlurHandler = function ()
{
    if (!ISQ.Widget.sendingCDCMessages)
    {
        ISQ.Widget.HTML.queryField.onblur = null;
        return false;
    }

    // sending blur message to float
    if (ISQ.Widget.isFloat)
        ISQ.Widget.CDC.sendMessage("subject=blur");
}

ISQ.Widget.Query.setFocus = function ()
{
    // not setting focus if not explicitly set or when in float/mobile mode
    if (ISQ.Http.hashArguments["autograbfocusinembed"]) ISQ.Cnf.autoGrabFocusInEmbed &= ISQ.Http.hashArguments["autograbfocusinembed"] === "true";
    if (ISQ.Widget.isPreview || ISQ.Cnf.autoGrabFocusInEmbed === false || ISQ.Cnf.autoGrabFocusInEmbed === 0 || ISQ.Widget.isFloat || ISQ.Http.browser.isMobile) return;

    // THIS METHOD CAN BE EXECUTED ONLY WHEN
    // EMBED + AUTO_GRAB_FOCUS.

    // set flag
    ISQ.Widget.Query.setFocusByScript = true;

    try
    {
        ISQ.Widget.HTML.queryField.focus();
        ISQ.Widget.Log.add("Focus:  was added to query field");
    }
    catch (e)
    {
        setTimeout(function ()
        {
            try
            {
                ISQ.Widget.HTML.queryField.focus();
                ISQ.Widget.Log.add("Focus: was added to query field with timeout");
            }
            catch (e) { /* re: #2342 */ }
        }, 0);
    }
}

ISQ.Widget.Query.onclickHandler = function (evt, clearTextbox)
{
    if (ISQ.Http.browser.isAndroid) return; // android doesn't support this well. we use onFocusHandler instead
    ISQ.Widget.Query.userInteractionHandler(evt, clearTextbox);
}

ISQ.Widget.Query.userInteractionHandler = function (evt, clearTextbox)
{
    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions || ISQ.Cnf.initialText || ISQ.Widget.Query.clearTextboxOnInteraction)
    {
        if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions)
        {
            // changing frame state: TO DO
            //ISQ.Widget.IFC.To.changeState('expand', true);

            // stopping auto question
            ISQ.Widget.AutoQuestions.stop_();
        }

        if ((clearTextbox && !ISQ.Widget.userActive) || ISQ.Widget.Query.clearTextboxOnInteraction)
        {
            // clearing text box
            ISQ.Widget.HTML.queryField.value = '';
            // setting query field css class
            ISQ.Widget.HTML.queryField.className = ISQ.Widget.HTML.queryField.className.replace("initialText", "");

            // ignore next change (because textbox is cleared)
            ISQ.Widget.Query.mobile_ignoreNextChange = true;

            // stopping typing effect
            if (ISQ.Widget.Query.typeTimer) ISQ.Widget.Query.typeTimer.cancel();
        }

        // resetting flag
        ISQ.Widget.Query.clearTextboxOnInteraction = false;
    }
    return false;
}

// canceling ie "beep" when pressing the Enter key by returning false //
ISQ.Widget.Query.keyPressHandler = function (event4FF)
{
    var e = event4FF || window.event;
    var CARRIAGE_RETURN_KEYCODE = 13;
    if (e.keyCode === CARRIAGE_RETURN_KEYCODE)
    {
        if (ISQ.Widget.Query.activateAutoLink)
        {
            var fastAnimTime = ISQ.Widget.Query.autoLinkAnimationTime.fast;
            ISQ.Widget.Query.activateAutoLink(fastAnimTime);
        }
        return false;
    }
    ISQ.Widget.userActive = true;
}

ISQ.Widget.Query.keyDownHandler = function (event4ff)
{
    var clearText = (ISQ.Widget.HTML.queryField.value.length == 0) ? false : true;

    // setting focus handler
    ISQ.Widget.Query.userInteractionHandler(event4ff, clearText);

    ISQ.Widget.userActive = true; //setting user as active

    // removing key down handler
    ISQ.Widget.HTML.queryField.onkeydown = null;
}

// paste handler
ISQ.Widget.Query.pasteHandler = function (event4FF)
{
    ISQ.Widget.Query.userInteractionHandler(event4FF, true);
    ISQ.Widget.userActive = true;
    setTimeout(function () { ISQ.Widget.Query.keyUpHandler(event4FF); }, 0);
}
// handling text query
ISQ.Widget.Query.keyUpHandler = function (event4FF)
{
    var e = event4FF || window.event;

    if (!ISQ.Widget.userActive) return;

    /// analyzing the key ///
    if (typeof (e.keyCode) != 'unknown' && ISQ.Widget.Query.ignoreKeyCodes[e.keyCode]) return false; // IE8 breaks when pasting an no key was pressed

    // if not in contact form mode and in limited mode
    // returning
    if (ISQ.Cnf.limited && ISQ.Widget.state !== ISQ.Widget.enumState.contactForm) return false;

    // if current state is 'custom escalation link'
    // changing state back to 'quetsions'
    if (ISQ.Widget.state === ISQ.Widget.enumState.customLink)
        ISQ.Widget.state = ISQ.Widget.enumState.questions;

    // saving keyup timestamp
    ISQ.Widget.Query.searchDelay_history.addLast(new Date());
    if (ISQ.Widget.Query.searchDelay_history.count() === 6) ISQ.Widget.Query.searchDelay_history.remove(ISQ.Widget.Query.searchDelay_history.head());

    /// analyzing query ///
    ISQ.Widget.Query.analyzeQuery(_query(false), ISQ.Widget.Query.enumTextQuerySource.regular);

    return false;
};

ISQ.Widget.Query.openAutoLink = function (autoLink, answer)
{
    _session().request(
        {
            url: 'trackEvent.js',
            params:
            {
                text: encodeURIComponent(ISQ.Widget.Query.lastQuerySent),
                articleId: answer.id,
                data: '{\"type\":\"autoLink\"}',
                eventType: 'action'
            },
            handler: function (status, jsonData)
            {
                if (status == ISQ.Com.JsonP.Request.enumResponseType.OK)
                {
                    var prefixes = ['http://', 'https://', '//'];
                    var url = null;
                    for (var i = 0, n = prefixes.length; i < n; ++i)
                    {
                        var prefix = prefixes[i];
                        if (autoLink.url.substring(0, prefix.length) === prefix)
                        {
                            url = autoLink.url;
                            break;
                        }
                    }
                    if (!url) url = 'http://' + autoLink.url;
                    if (autoLink.keepArticleOpen) ISQ.Widget.setOngoingData(url);
                    window.open(url, '_top');
                }
            }
        });
}

// types the provided question and analyzes the query
ISQ.Widget.Query.ask = function (question, questionType)
{
    var canChangeTitle = (!ISQ.Cnf.initialText || ISQ.Widget.state !== ISQ.Widget.enumState.autoQuestions);

    if (ISQ.Cnf.autoQuestionsTypeEffect && canChangeTitle && questionType !== ISQ.Widget.Query.enumTextQuerySource.api)
    {
        ISQ.Widget.Query.analyzeQuery(question, questionType); // sending query
        ISQ.Widget.Query.typeTimer = new ISQ.Timer(new ISQ.Handler(ISQ.Widget.Query.typeQuestion), false, question, 0);
        ISQ.Widget.Query.typeTimer.start(ISQ.Widget.Query.typeInterval);
    }
    else
    {
        if (canChangeTitle) ISQ.Widget.HTML.queryField.value = question;
        ISQ.Widget.Query.analyzeQuery(question, questionType); // sending query
    }
};

ISQ.Widget.Query.questionLinkClicked = function (tag, ignoreStatistics)
{
    // making sure not to 'ask' the same question twice
    if (ISQ.Widget.Query.tempQuestionTrailId === tag) return;

    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions)
    {
        // #8100
        ISQ.Widget.state = ISQ.Widget.enumState.questions;
    }

    // marking user as active
    ISQ.Widget.userActive = true;

    // append current question to question trail
    ISQ.Widget.Query.appendQuestionToTrail();

    // asking the question
    ISQ.Widget.Query.tempQuestionTrailId = tag;
    ISQ.Widget.Query.getAnswerById(tag, ignoreStatistics);
};

ISQ.Widget.Query.clearQuestionTrail = function ()
{
    if (ISQ.Widget.Query.questionsTrail)
    {
        ISQ.Widget.Query.questionsTrail.dispose();
        ISQ.Widget.Query.questionsTrail = null;
    }
    ISQ.Widget.Query.tempQuestionTrailId = null;
};

ISQ.Widget.Query.appendQuestionTag = function (stringBuilder, answerId, text)
{
    stringBuilder.push("<a href='javascript:void(0)' onclick='ISQ.Widget.Query.questionLinkClicked(\"");
    stringBuilder.push(answerId);
    stringBuilder.push("\")'>");
    stringBuilder.push(text);
    stringBuilder.push("</a>");
}

// when clicking a named anchor inside the widget it may cause the body to scroll up (#9258)
ISQ.Widget.Query.namedAnchorClick = function (hash)
{
    var list = document.getElementsByTagName('A');
    hash = hash.substring(1); // ignore # char
    for (var i in list)
    {
        try
        {
            if (list[i].getAttribute('name') === hash)
            {
                if (ISQ.Widget.isFloat || ISQ.Widget.HTML.contentWrapper.scrollHeight > ISQ.Widget.HTML.contentWrapper.offsetHeight) // scroll the content wrapper
                    ISQ.Widget.HTML.contentWrapper.scrollTop = ISQ.Html.position(list[i]).y - ISQ.Widget.HTML.searchContainer.offsetHeight;
                else // scroll the parent page
                    list[i].scrollIntoView();
                break;
            }
        } catch (ex) { }
    }
    return false;
}

ISQ.Widget.Query.appendQuestionToTrail = function ()
{
    if (!ISQ.Widget.Query.questionsTrail) ISQ.Widget.Query.questionsTrail = new ISQ.Infra.Stack();
    if (!ISQ.Widget.Query.tempQuestionTrailId)
    {
        var question = ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions ? ISQ.Widget.AutoQuestions.getCurrentQuestion() : _query(true, true);
        ISQ.Widget.Query.questionsTrail.push({ tag: question, isTagAnId: false });
    }
    else
        ISQ.Widget.Query.questionsTrail.push({ tag: ISQ.Widget.Query.tempQuestionTrailId, isTagAnId: true });
    ISQ.Widget.Query.tempQuestionTrailId = null;
}


ISQ.Widget.Query.popQuestionFromTrail = function ()
{
    if (!ISQ.Widget.Query.questionsTrail) return null;
    return ISQ.Widget.Query.questionsTrail.pop();
};

ISQ.Widget.Query.getCurrentQuestionFromTrail = function ()
{
    if (!ISQ.Widget.Query.questionsTrail) return null;
    return ISQ.Widget.Query.questionsTrail.peek();
};

ISQ.Widget.Query.typeQuestion = function (question, ndx)
{
    if (ndx === question.length)
    {
        ISQ.Widget.Query.typeTimer.dispose();
        return;
    }
    ISQ.Widget.HTML.queryField.value = question.substr(0, ndx + 1);
    ISQ.Widget.Query.typeTimer.start(ISQ.Widget.Query.typeInterval, question, ndx + 1);
};


ISQ.Widget.Query.enumTextQuerySource =
{
    regular: 1,
    api: 2,
    linkedAnswer: 3,
    suggestion: 4
}
ISQ.Widget.Query.analyzeQuery = function (query, source) //  allowSameQuestion, askedViaAPI
{
    query = query.replace(/\n/g, " "); // removing \n
    var trimmedQuery = query.Trim();

    // not getting answer by id
    ISQ.Widget.Query.clearQuestionTrail();
    ISQ.Widget.Query.gettingAnswerById = false;

    ISQ.Widget.Query.lastQuerySource = source;
    // if there is an active autolink, then reset it
    if (ISQ.Widget.Query.resetAutoLink) ISQ.Widget.Query.resetAutoLink();

    if (ISQ.Widget.state === ISQ.Widget.enumState.questions)
    {
        // no query
        if (trimmedQuery.length === 0)
        {
            // canceling send query timeout
            if (ISQ.Widget.Query.timer !== null) clearTimeout(ISQ.Widget.Query.timer);
            if (ISQ.Widget.Query.acTimer) clearTimeout(ISQ.Widget.Query.acTimer);

            ISQ.Widget.Query.lastQuerySent = '';
            ISQ.Widget.Query.lastSuggestionSent = '';
            ISQ.Widget.Query.hideAnswers(null, !ISQ.Widget.dynamicSize);
            ISQ.Widget.HTML.contentFader.hide();
            ISQ.Widget.HTML.hideActionBar();
            ISQ.Widget.Query.firstUserTyping = true;
            ISQ.Widget.Query.currentAnswers = null;
            ISQ.Widget.Query.currentAnswersForComparison = null;
            ISQ.Widget.Suggestions.hide(_('searchSuggestions'));

            // show faq
            if (ISQ.Cnf.faqData)
            {
                clearNode(ISQ.Widget.HTML.answerPane);
                ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnClearSearchField);
            }
            // setting widget size to its default dimensions
            if (ISQ.Widget.isFloat)
                ISQ.Widget.CDC.sendMessage("subject=widgetToExpand");

            //Hide clear query icon
            ISQ.Widget.HTML.clearQuery.hide();
            return;
        }

        //////////////////////////////////////////////////////////////////////////
        // suggestions - timer func
        if (ISQ.Cnf.autocompleteEnabled && source === ISQ.Widget.Query.enumTextQuerySource.regular && !(ISQ.Http.hashArguments["naive"]))
        {
            var queryForSuggestion = ISQ.Widget.Query.getLastWords(trimmedQuery, ISQ.Cnf.autocomplete_maxQueryLength);
            if (!queryForSuggestion) ISQ.Widget.Suggestions.hide(_('searchSuggestions'));
            if (ISQ.Widget.Query.acTimer) clearTimeout(ISQ.Widget.Query.acTimer);
            ISQ.Widget.Query.acTimer = setTimeout(function ()
            {
                ISQ.Widget.Query.acTimer = null;
                if (ISQ.Widget.Query.lastSuggestionSent === queryForSuggestion) return; // not sending same query twice
                ISQ.Widget.Query.lastSuggestionSent = queryForSuggestion;
                ISQ.Widget.Suggestions.request(queryForSuggestion,
                {
                    container: _('searchSuggestions'),
                    eventsHandler: function (type, id, title, summary)
                    {
                        if (type != "click") return;
                        ISQ.Widget.HTML.queryField.value = title;
                        ISQ.Widget.Query.mobile_ignoreNextChange = true; // ignoring text-change interval
                        ISQ.Widget.Query.analyzeQuery(title, ISQ.Widget.Query.enumTextQuerySource.suggestion);
                    },
                    documentEventsHandler: function (type, result, title)
                    {
                        ISQ.Widget.HTML.queryField.value = title || trimmedQuery;
                    },
                    includeAnswers: false
                });
            }, 200);
        }

        // current query equals last query
        var allowSameQuestion = ISQ.Widget.Query.previousResponseWasAutoQuestion || source !== ISQ.Widget.Query.enumTextQuerySource.regular;
        if (!allowSameQuestion && trimmedQuery === ISQ.Widget.Query.lastQuerySent)
        {
            if (!ISQ.Widget.Query.pendingRequest)
            {
                // canceling send query timeout
                if (ISQ.Widget.Query.timer !== null) clearTimeout(ISQ.Widget.Query.timer);

                ISQ.Widget.HTML.contentFader.hide();
                ISQ.Widget.Query.firstUserTyping = true;
            }
            return;
        }

        // canceling send query timeout
        if (ISQ.Widget.Query.timer !== null) clearTimeout(ISQ.Widget.Query.timer);

        // a valid query
        ISQ.Widget.HTML.contentFader.show();
                    //ISQ.Widget.HTML.clearQuery.hide();
    }

    // auto question //
    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions || source !== ISQ.Widget.Query.enumTextQuerySource.regular)
    {
        ++ISQ.Widget.Suggestions.requestId; // preventing from popularSuggestions response to appear
        ISQ.Widget.Suggestions.hide(_('searchSuggestions'));
        ISQ.Widget.Query.lastSuggestionSent = '';
        ISQ.Widget.Query.isSameQuery = source === ISQ.Widget.Query.enumTextQuerySource.suggestion;
        ISQ.Widget.Query.send(trimmedQuery, false, source);


        // saving user's last 'written query'
        if (ISQ.Widget.Query.enumTextQuerySource.suggestion === source)
            ISQ.Widget.Query.lastWrittenQuery = trimmedQuery;
    }
    // other states
    else
    {
        // user started typing
        if (ISQ.Widget.Query.firstUserTyping && ISQ.Widget.state === ISQ.Widget.enumState.questions)
        {
            if (ISQ.Widget.reportEvents)
            {
                if (!ISQ.Widget.Query.userActiveReported)
                {
                    ISQ.Widget.CDC.sendMessage("subject=event&type=useractive");
                    ISQ.Widget.Query.userActiveReported = true;
                }
                ISQ.Widget.CDC.sendMessage("subject=event&type=userstartedtyping");
            }
            if (ISQ.Widget.isFloat)
                ISQ.Widget.CDC.sendMessage("subject=userWrites");
            ISQ.Widget.Query.firstUserTyping = false;
        }

        /// checking if query is an update of the previous query
        /// by calculating the time passed from the previous query
        var now = new Date().getTime();
        var diff = now - ISQ.Widget.lastQueryKeyTime;
        ISQ.Widget.lastQueryKeyTime = new Date().getTime();
        if (ISQ.Widget.Query.isSameQuery && diff > ISQ.Widget.updateQueryDiff_ms)
            ISQ.Widget.Query.isSameQuery = false;

        // setting timer
        var time;
        if (ISQ.Widget.state === ISQ.Widget.enumState.contactForm)
            time = 0;
        else
        {
            if (ISQ.Widget.Query.searchDelay_history.count() > 2)
            {
                var total = 0;
                var previousNode = ISQ.Widget.Query.searchDelay_history.head();
                var node = previousNode.next();
                while (node)
                {
                    var diff = (node.data() - previousNode.data());
                    if (diff < ISQ.Widget.Query.searchDelay_min)
                        diff = ISQ.Widget.Query.searchDelay_min;
                    else if (diff > ISQ.Widget.Query.searchDelay_max)
                        diff = ISQ.Widget.Query.searchDelay_max;
                    total += diff;
                    previousNode = node;
                    node = node.next();
                }
                time = total / ISQ.Widget.Query.searchDelay_history.count() * 2; // with factor
            }
            else
            {
                time = ISQ.Widget.Query.searchDelay_min * 2; // with factor
            }
        }

        //////////////////////////////////////////////////////////////////////////
        // query timer func
        ISQ.Widget.Query.lastWrittenQuery = trimmedQuery;
        var timerFunc = function ()
        {
            ISQ.Widget.Query.firstUserTyping = true;
            ISQ.Widget.Query.timerElapsedHandler(trimmedQuery, allowSameQuestion);
            ISQ.Widget.Query.timer = null;
        }

        // Since we use adaptive query frequency (#6221),
        // If the user will write a long query, the query won't be sent until he finished (it might take a long time)
        var timeDiffFromLastQuery = 0;
        if (ISQ.Widget.Query.lastQuerySent_time)
            timeDiffFromLastQuery = now - ISQ.Widget.Query.lastQuerySent_time;
        else if (ISQ.Widget.Query.searchDelay_history.count() !== 0)
            timeDiffFromLastQuery = now - ISQ.Widget.Query.searchDelay_history.tail().data();
        if (timeDiffFromLastQuery >= 5000)
            timerFunc();
        else
            ISQ.Widget.Query.timer = setTimeout(timerFunc, time);
    }
};
//#region suggestions
ISQ.Widget.Query.getLastWords = function (trimmedQuery, maxWordCount)
{
    var startingIndex = 0;
    var wordCount = 0;
    var spaceMode = false;

    // removing characters which are not encoded by encodeURI
    trimmedQuery = trimmedQuery.replacer(
    [
        { from: "", to: " " },
        { from: "\\", to: " " },
        { from: "-", to: " " },
        { from: "=", to: " " },
        { from: "(", to: " " },
        { from: ")", to: " " },
        { from: "[", to: " " },
        { from: "]", to: " " },
        { from: "{", to: " " },
        { from: "}", to: " " },
        { from: "<", to: " " },
        { from: ">", to: " " },
        { from: "#", to: " " },
        { from: "@", to: " " },
        { from: "^", to: " " },
        { from: "!", to: " " },
        { from: "?", to: " " },
        { from: "/", to: " " },
        { from: "&", to: " " },
        { from: "%", to: " " },
        { from: "$", to: " " },
        { from: "*", to: " " },
        { from: "¿", to: " " },
        { from: "\t", to: " " },
        { from: "\r", to: " " },
        { from: "\n", to: " " }
    ]);

    // trimming white spaces at the end
    var ndx = trimmedQuery.length - 1;
    var isWhiteSpace = true;
    while (trimmedQuery.charAt(ndx) === ' ') --ndx;

    //////////////////////////////////////////////////////////////////////////
    // counting words
    var tmpNdx = ndx;
    var wordStartNdx = ndx;
    var hasOneCharWord = false;
    for (; ndx >= 0; --ndx)
    {
        isWhiteSpace = trimmedQuery.charAt(ndx) === ' ';
        if (spaceMode)
        {
            if (!isWhiteSpace)
            {
                spaceMode = false;
                wordStartNdx = ndx;
            }
        }
        else if (isWhiteSpace)
        {
            // detecting there are one-char words
            //if (!hasOneCharWord && wordCount != 0 && wordStartNdx - ndx === 1) hasOneCharWord = true;
            if (++wordCount === maxWordCount) break;
            wordStartNdx = -1;
            spaceMode = true;
        }
    }

    if (wordCount < maxWordCount) return trimmedQuery.Trim();
    if (ndx === -1) return trimmedQuery.Trim();
    if (!hasOneCharWord) return trimmedQuery.substring(1 + ndx).Trim();

    // THE FOLLOWING PART IS NOT IN USE!

    //////////////////////////////////////////////////////////////////////////
    // need to trim query (taking last 5 while ignoring 1-char words
    wordStartNdx = ndx = tmpNdx;
    wordCount = 0;
    spaceMode = false;
    words = [];
    for (; ndx >= 0; --ndx)
    {
        isWhiteSpace = trimmedQuery.charAt(ndx) === ' ';

        if (spaceMode)
        {
            if (!isWhiteSpace)
            {
                spaceMode = false;
                wordStartNdx = ndx;
            }
        }
        else if (isWhiteSpace)
        {
            if (wordStartNdx - ndx > 1)
            {
                if (tmpNdx == trimmedQuery.length)
                    words.push(trimmedQuery.substring(ndx + 1));
                else
                    words.push(trimmedQuery.substring(ndx + 1, wordStartNdx + 1));
                if (++wordCount === maxWordCount)
                {
                    wordStartNdx = -1; // not taking last word
                    break;
                }
            }
            wordStartNdx = -1;
            spaceMode = true;
        }
    }
    // adding last word
    if (wordStartNdx != -1) words.push(trimmedQuery.substring(0, wordStartNdx + 1));
    return words.reverse().join(' ');
}
ISQ.Widget.Query.countWords = function (query)
{
    // skipping leading spaces
    var i = 0;
    while (query.charAt(i) === " " && i < query.length) ++i;
    if (i === query.length) return 0;

    // counting words
    var inSpaceMode = false;
    var wordCount = 1;
    for (; i < query.length; ++i)
    {
        if (query.charAt(i) !== " ")
        {
            inSpaceMode = false;
            continue;
        }
        else
        {
            if (inSpaceMode) continue; // skipping adjacent spaces
            inSpaceMode = true;
            ++wordCount;
        }
    }
    return wordCount;
}

ISQ.Widget.Suggestions =
{
    //#region interface
    init: function ()
    {
        // copying styles from textbox
        ISQ.Data.copyElementFontStyle(_('txtSearch'), _('searchSuggestions'));
    },
    request: function (q, infoObject, kbLanguageCode)
    {
        if (!q.length) return;
        kbLanguageCode = kbLanguageCode || ISQ.Widget.TranslationHelper.detectedLanguage || ISQ.Cnf.kbLanguageCode;

        if (!this.running)
            this.request_internal(q, infoObject, kbLanguageCode);
        else
            this.pendingQuery = { q: q, obj: infoObject, kbLanguageCode: kbLanguageCode };
    },
    hide: function (div)
    {
        clearNode(div).style.display = 'none';
        document.onkeyup = null;
        ISQ.Widget.HTML.resizeHandler();
        ISQ.Widget.HTML.dynamicSize_sendMessage(); // updating height
    },
    checkForHide: function (kbLanguageCode, lastQuerySent)
    {
        if (!kbLanguageCode) return false;
        if (ISQ.Widget.Query.countWords(lastQuerySent) < 2) return false;

        if (ISQ.Widget.Query.kbLanguageCode) // comparing with language code of returned answer
        {
            if (kbLanguageCode != ISQ.Widget.Query.kbLanguageCode)
            {
                this.hide(_('searchSuggestions'));
                return true;
            }
        }
        else if (kbLanguageCode != ISQ.Cnf.kbLanguageCode) // comparing with default kb language code
        {
            this.hide(_('searchSuggestions'));
            return true;
        }
        return false;
    },
    //#endregion

    //#region internals
    enumSearchWord: { none: 0, word: 1, subword: 2 },
    request_internal: function (q, infoObject, kbLanguageCode)
    {
        this.running = true;
        var mthis = this;

        _session().request(
        {
            url: "suggest.js",
            params:
            {
                text: encodeURIComponent(q),
                maxResults: infoObject.maxResults ? infoObject.maxResults : null,
                includeItemId: infoObject.verbose ? infoObject.verbose : null,
                stemming: true,
                requestId: ++this.requestId
            },
            handler: function (status, jsonData)
            {
                mthis.running = false;
                if (mthis.checkForHide(kbLanguageCode, ISQ.Widget.Query.lastQuerySent)) return;

                // succeeded
                if (status == ISQ.Com.JsonP.Request.enumResponseType.OK)
                {
                    mthis.currentLanguageCode = kbLanguageCode;
                    mthis.processResponse(jsonData, infoObject);
                }
                // failed and there's no pending query
                else if (!mthis.pendingQuery)
                    mthis.request(q, infoObject, kbLanguageCode);

                // proccessing next request
                mthis.processNextRequest();
            }
        });
    },
    processResponse: function (jsonData, obj)
    {
        this.hide(obj.container);
        var mthis = this;

        // user cleared the textbox until response got back
        if (ISQ.Widget.state === ISQ.Widget.enumState.questions && !_query(true, false)) return;

        try
        {
            if (jsonData.rid != this.requestId) return;

            var direction = ISQ.Translation.Infra.getLanguageDirection(jsonData.lc);
            obj.container.style.direction = direction;
            if (direction == "rtl") obj.container.style.textAlign = "right";
            else obj.container.style.textAlign = "left";
            var widgetWidth = obj.container.parentNode.offsetWidth;
            var widgetPadding = 20;
            //////////////////////////////////////////////////////////////////////////
            // QUERY STEM
            var queryInfo = this.parseStemming(jsonData.q, false);

            //////////////////////////////////////////////////////////////////////////
            // results
            //#region results iteration
            var results = [];
            var selectedResult = -1;
            var outedResult = -1;
            iteration(jsonData.a, function (suggestion, index)
            {
                var words, answerBody = null, id = "-1";
                if (typeof (suggestion) === 'string')
                {
                    words = suggestion;
                }
                else
                {
                    words = suggestion.w;
                    id = suggestion.i;
                }

                var answerInfo = mthis.parseStemming(words, true);
                if (!answerInfo.text.Trim()) return;

                // inserting first popular suggestion to the text box
                //if (index === 0 && this.insertSuggestionToTextbox(answerInfo.text)) return;

                var div = createDiv(obj.container, ".autoCompleteDiv");
                if (ISQ.Http.browser.isIOS) div.style.maxWidth = (widgetWidth - widgetPadding) + 'px'; // #9578
                div.index = results.length;
                results.push(div);

                // adding to ui
                div.innerHTML = mthis.emphasizeText(answerInfo, queryInfo);
                div.answerTitle = answerInfo.text;
                div.id = id;
                div.setAttribute("tabindex", "4");

                // events
                div.onmouseover = function ()
                {
                    var parentDiv = this.parentNode;
                    for (var cns in parentDiv.childNodes)
                    {
                        var childDiv = parentDiv.childNodes[cns];
                        if (childDiv.nodeName != "DIV" || childDiv == this || childDiv.className.indexOf(' autoCompleteDiv_hover') == -1) continue;
                        childDiv.ignoreMouseout = false;
                        childDiv.onmouseout();
                    }
                    selectedResult = this.index;
                    if (this.className.indexOf(' autoCompleteDiv_hover') == -1)
                        this.className += ' autoCompleteDiv_hover';
                    if (obj.eventsHandler) obj.eventsHandler("mouseover", this.id, div.answerTitle);
                }
                div.onmouseout = function ()
                {
                    if (this.ignoreMouseout) return;
                    outedResult = this.index;
                    this.className = this.className.replace(' autoCompleteDiv_hover', '');
                    if (obj.eventsHandler) obj.eventsHandler("mouseout", this.id, div.answerTitle);
                }
                div.onclick = function ()
                {
                    mthis.clicked = true;
                    if (obj.eventsHandler) obj.eventsHandler("click", this.id, div.answerTitle);
                    mthis.hide(obj.container); // hiding suggestions
                }
            });

            //#endregion
            ////////////////////////////////////////////////////////////////////////
            // text ellipsis

            // taking width of parentNode BEFORE showing the container because container
            // might be wider than wanted (tablets - #8215)
            obj.container.style.display = 'block';
            obj.container.style.overflow = 'hidden';
            obj.container.style.width = "100%";

            this.ellipsisText(obj.container, obj.container.offsetWidth - 15);

            //////////////////////////////////////////////////////////////////////////
            // showing suggestions container
            if (ISQ.Widget.state === ISQ.Widget.enumState.questions)
            {
                ISQ.Widget.HTML.resizeHandler();
                ISQ.Widget.HTML.dynamicSize_sendMessage();
            }

            //////////////////////////////////////////////////////////////////////////
            // Registering document events
            //#region document keyup event
            document.onkeyup = function (event4ff)
            {
                var _event = ISQ.Html.getDomEvent(event4ff);
                var div;

                switch (_event.domEvent.keyCode)
                {
                    case 40: //down

                        // setting onmouseout behaviour from current div
                        if (selectedResult !== -1)
                        {
                            div = results[selectedResult];
                            div.ignoreMouseout = false;
                            div.onmouseout();
                        }

                        // updating selected suggested div
                        ++selectedResult;
                        if (selectedResult === results.length)
                        {
                            selectedResult = -1;
                            return;
                        }

                        // setting onmouseover behaviour
                        div = results[selectedResult];
                        div.ignoreMouseout = true;

                        // firing event
                        if (obj.documentEventsHandler) obj.documentEventsHandler("down", selectedResult, div.answerTitle);

                        div.onmouseover(); // this method also sets the 'selected suggested div index'
                        break;

                    case 38: //up

                        // setting onmouseout behaviour from current div
                        if (selectedResult !== -1)
                        {
                            div = results[selectedResult];
                            div.ignoreMouseout = false;
                            div.onmouseout();
                        }

                        // updating selected suggested div
                        if (selectedResult === -1)
                            selectedResult = results.length - 1;
                        else
                            --selectedResult;

                        // no suggested is picked
                        var title = null;
                        if (selectedResult !== -1)
                        {
                            // setting onmouseover behaviour
                            div = results[selectedResult];
                            div.ignoreMouseout = true;
                            title = div.answerTitle;
                            div.onmouseover(); // this method also sets the 'selected suggested div index'
                        }

                        // firing event
                        if (obj.documentEventsHandler) obj.documentEventsHandler("up", selectedResult, title);

                        break;

                    case 13: //enter
                        if (selectedResult === -1 || selectedResult == outedResult)
                        {
                            mthis.hide(obj.container); // hiding suggestions
                            return;
                        }
                        results[selectedResult].onclick();
                        break;
                    case 27: //escape
                        mthis.hide(obj.container); // hiding suggestions
                        break;
                }
            }
            //#endregion

            if (obj.onDrawHandler) obj.onDrawHandler();
        }
        catch (e)
        {
            //if (debugLevel) debugger;
        }
    },
    insertSuggestionToTextbox: function (query)
    {
        // NOT WORKING
        var q = _query(false, false);
        if (!query.startsWith(q)) return false;
        ISQ.Widget.HTML.queryField.value = query;
        if (ISQ.Widget.HTML.queryField.setSelectionRange)
            ISQ.Widget.HTML.queryField.setSelectionRange(q.length, query.length);
        else if (ISQ.Widget.HTML.queryField.createTextRange)
        {
            var range = ISQ.Widget.HTML.queryField.createTextRange();
            range.moveStart("character", q.length);
            range.moveEnd("character", query.length);
            range.select();
        }
        return true;
    },
    ellipsisText: function (elem, width)
    {
        var textElem = {};
        var origFontSize = parseInt(ISQ.CSS.getElementStyle(elem, 'font-size'));
        var minFontSize = 12;
        var ellipsed = false;

        for (var i = 0; i < elem.childNodes.length; ++i)
        {
            if (!textElem[i])
            {
                textElem[i] = elem.childNodes[i];
                textElem[i].origText = textElem[i].innerHTML;
            }
            textElem[i].style.fontSize = origFontSize + "px";

            ISQ.Data.autoEllipseText(textElem[i].origText, width, textElem[i]);
            if (textElem[i].origText != textElem[i].innerHTML && origFontSize > minFontSize)
            {
                ellipsed = true;
                --origFontSize;
                --i;
            }
        }
        if (!ellipsed) return;
        for (var i in textElem)
        {
            textElem[i].origText = null;
            textElem[i].style.fontSize = origFontSize + "px";
            textElem[i].title = ISQ.Data.htmlEncode(textElem[i].title, "b", true);
        }
    },
    processNextRequest: function ()
    {
        var pendingQuery = this.pendingQuery;
        if (pendingQuery) {
        this.pendingQuery = null;
            this.request_internal(pendingQuery.q, pendingQuery.obj, pendingQuery.kbLanguageCode);
        }
    },
    parseStemming: function (data, answerStemming)
    {
        var result = { stemmingData: {}, text: [], lastWord: "" };

        // hide numbers over 5 digits long, which may span multiple words.
        // eg. windows,window|phone|123|4567|890|bob --> windows,window|phone|bob
        var replaceLongNumbers = function (string)
        {
            var count = 0;
            var arr = [];
            var maxConsecutiveDigits = 5;
            var lastPos = 0;
            for (var i = 0; i < string.length; i++)
            {
                var c = string.charAt(i);
                if (c == '|')
                {
                    if (count == 0) arr.push(c);
                    continue;
                }
                if (isNaN(c))
                {
                    if (count > 0)
                    {
                        if (count <= maxConsecutiveDigits) arr.push(string.substring(lastPos, i));
                        count = 0;
                    }
                    arr.push(c);
                    continue;
                }

                // digits
                if (count == 0) lastPos = i; // position where we started counting digits
                count++;
            }

            if (count > 0 && count <= maxConsecutiveDigits) arr.push(string.substring(lastPos, i));

            return arr.join('');
        }
        data = replaceLongNumbers(data);

        var references = data.split("|");

        iteration(references, function (keywordRef)
        {
            var keywords = keywordRef.split(',');

            if (answerStemming)
                result.stemmingData[keywords[0]] = keywords[0]; // setting default value
            else
                result.stemmingData[keywords[0]] = [];
            iteration(keywords, function (word, index)
            {
                if (index != 0 && keywords[0] === word) return; // word is the same as seed

                // check for blacklisted words
                var hideWord = false;
                iteration(ISQ.Widget.Query.suggestionsBlacklist, function (blWord, j)
                {
                    if (blWord == word) { hideWord = true; return; }
                });
                if (hideWord) return;

                if (index == 0) // first word
                {
                    result.lastWord = word;
                    result.text.push(word); // building the text
                    return;
                }

                // answer stemming: creating pointers from stem to seed
                if (answerStemming)
                    result.stemmingData[word] = keywords[0];
                else // query stemming: adding all stems in array of seed
                    result.stemmingData[keywords[0]].push(word);
            });
        });

        result.text = result.text.join(' '); // creating text
        return result;
    },
    emphasizeText: function (answerInfo, queryInfo)
    {
        var answerLC = answerInfo.text.toLowerCase();
        var emphData = [];
        var mthis = this;

        // going over each SEED in the query and finding the place to emphasize
        foreach(queryInfo.stemmingData, function (arr, word)
        {
            // seed as full word
            var result = mthis.searchForWord(emphData, word, answerLC);
            if (result.status === mthis.enumSearchWord.word)
            {
                emphData.push(result);
                return;
            }

            // query stems as full words
            var stemResult;
            var added = false;
            iteration(arr, function (queryStem)
            {
                stemResult = mthis.searchForWord(emphData, queryStem, answerLC);
                if (stemResult.status === mthis.enumSearchWord.word)
                {
                    emphData.push(stemResult);
                    added = true;
                    return;
                }
            });
            if (added) return;


            // searching in answer for a stem as full word
            var stemResult = null;
            if (answerInfo.stemmingData[word])
            {
                stemResult = mthis.searchForWord(emphData, answerInfo.stemmingData[word], answerLC);
                if (stemResult.status === mthis.enumSearchWord.word)
                {
                    emphData.push(stemResult);
                    added = true;
                    return;
                }
            }
            if (added) return;

            // searching for all stems as full words
            iteration(arr, function (queryStem)
            {
                stemResult = mthis.searchForWord(emphData, answerInfo.stemmingData[queryStem], answerLC);
                if (stemResult.status === mthis.enumSearchWord.word)
                {
                    emphData.push(stemResult);
                    added = true;
                    return;
                }
            });
            if (added) return;

            // seed as subword (only for the last word)
            if (result.status === mthis.enumSearchWord.subword && queryInfo.lastWord === word)
            {
                emphData.push(result);
                return;
            }
        });

        // merging results
        var emphasizeIndices = new Array(answerInfo.text.length);
        iteration(emphData, function (item)
        {
            for (var i = item.ndx; i < item.endNdx; ++i)
                emphasizeIndices[i] = 1;
        });
        emphData = [];
        var data = null;
        iteration(emphasizeIndices, function (emphasize, ndx)
        {
            if (data === null)
            {
                if (emphasize)
                    data = { ndx: ndx };
            }
            else if (!emphasize)
            {
                data.endNdx = ndx;
                emphData.push(data);
                data = null;
            }
        });
        if (data)
        {
            data.endNdx = answerInfo.text.length;
            emphData.push(data);
        }

        return this.emphasizeFinalizer(answerInfo.text, emphData);
    },
    searchForWord: function (emphData, word, answerLC)
    {
        var resultObject =
        {
            status: this.enumSearchWord.none
        };

        // searching as a word
        var ndx = -1;
        for (var j = emphData.length - 1; j >= 0 && ndx === -1; --j)
        {
            ndx = answerLC.indexOf(" " + word + " ", emphData[j].endNdx);
            if (ndx !== -1) ndx++;
        }
        if (ndx === -1)
        {
            ndx = answerLC.indexOf(" " + word + " ");
            if (ndx !== -1) ndx++;
        }
        if (ndx !== -1)
            resultObject.status = this.enumSearchWord.word;

        if (ndx === -1)
        {
            ndx = answerLC.indexOf(word + " ");
            if (ndx === 0)
                resultObject.status = this.enumSearchWord.word;
            else if (ndx > 0)
                resultObject.status = this.enumSearchWord.subword;
        }
        if (ndx === -1)
        {
            ndx = answerLC.indexOf(" " + word);
            if (ndx !== -1)
            {
                ndx++;
                if (ndx + word.length === answerLC.length)
                    resultObject.status = this.enumSearchWord.word;
                else
                    resultObject.status = this.enumSearchWord.subword;
            }
        }

        // searching as a substring
        if (ndx === -1)
        {
            for (var j = emphData.length - 1; j >= 0 && ndx === -1; --j)
                ndx = answerLC.indexOf(word, emphData[j].endNdx); // searching as a word
            if (ndx === -1) ndx = answerLC.indexOf(word);
            if (ndx !== -1) resultObject.status = this.enumSearchWord.word;
        }

        // found a result
        if (ndx !== -1)
        {
            resultObject.ndx = ndx;
            resultObject.endNdx = ndx + word.length;
            resultObject.word = word;
        }

        return resultObject;
    },
    emphasizeFinalizer: function (txt, data)
    {
        var lastNdx = 0;
        var builder = [];
        for (var i = 0; i < data.length; ++i)
        {
            if (data[i].ndx != lastNdx) builder.push(txt.substring(lastNdx, data[i].ndx));

            builder.push("<b>");
            builder.push(txt.substring(data[i].ndx, data[i].endNdx));
            builder.push("</b>");

            lastNdx = data[i].endNdx;
        }

        if (lastNdx != txt.length)
            builder.push(txt.substring(lastNdx));
        return builder.join('');
    },
    //#endregion

    //#region members
    pendingQuery: null,
    running: false,
    clicked: false,
    requestId: 0,
    currentLanguageCode: ''
    //#endregion
};
//#endregion
ISQ.Widget.Query.timerElapsedHandler = function (query, allowSameQuestion)
{
    ///// dispatching event /////
    ISQ.Widget.Query.queryChangedEvent.dispatch(query);

    // Checking if query (trimmed) equals last sent query || is empty.
    // Performing this check AFTER send-timer to avoid false behaviour when users add space to query.
    // e.g. :  'why', 'why ' , 'why does'. in second query, the search animation will disappear
    if ((!allowSameQuestion && query === ISQ.Widget.Query.lastQuerySent) || query.length === 0)
    {
        ISQ.Widget.HTML.contentFader.hide();
        if (!query.length) ISQ.Widget.Query.hideAnswers(null, true);
        return;
    }

    // in limited mode, not sending the request
    if (ISQ.Cnf.limited) return;

    ///// sending the query /////
    if (ISQ.Widget.state === ISQ.Widget.enumState.questions && (query.length > 2 || !ISQ.Cnf.autocompleteEnabled))
        ISQ.Widget.Query.send(query);

    if (query.length > 0)
        ISQ.Widget.HTML.clearQuery.show();
    else
        ISQ.Widget.HTML.clearQuery.hide();
    // else
    ISQ.Widget.HTML.contentFader.hide();
};
ISQ.Widget.Query.send = function (query, retry_translateQuery, querySource)
{
    ISQ.Widget.Translation.init();
    if (ISQ.Widget.Translation.currentState == ISQ.Widget.Translation.enumTranslationState.pending)
    {
        ISQ.Widget.Translation.loadCallback = function ()
        {
            ISQ.Widget.Query.send(query, retry_translateQuery, querySource);

        }
        return;
    }
    // 'retry_translateQuery' is kept here to easy implementing #5800

    // in limited mode, not sending the request (dbl check)
    if (ISQ.Cnf.limited) return;

    // if this is a retry: (translating query)
    if (!retry_translateQuery)
    {
        // reporting event (#4950, #4837)
        if (ISQ.Widget.reportEvents)
            ISQ.Widget.CDC.sendMessage("subject=event&type=query&isAutoQuestion=" + (ISQ.Widget.state == ISQ.Widget.enumState.autoQuestions) + "&data=" + ISQ.Tools.Base64.encodeString(query));

        ////////////	checking the query	//////////////////////
        if (query === '')
        {
            ISQ.Widget.Log.add('empty query');
            //ISQ.Widget.HTML.colapse();
            return;
        }

        // log
        ISQ.Widget.Log.add("Is same query: " + ISQ.Widget.Query.isSameQuery);
    }

    // saving the query
    ISQ.Widget.Query.lastQuerySent = query;
    ISQ.Widget.Query.lastQuerySent_time = new Date();

    // inc. request ID
    ++ISQ.Widget.Query.activeRequestId;
    if (ISQ.Widget.state == ISQ.Widget.enumState.autoQuestions) // saving auto-Q last request Id
        ISQ.Widget.Query.lastAutoQuestionRequestId = ISQ.Widget.Query.activeRequestId;


    if (querySource === ISQ.Widget.Query.enumTextQuerySource.suggestion)
    {
        var detectedLang = ISQ.Widget.Query.kbLanguageCode !== ISQ.Widget.TranslationHelper.defaultLanguage ? ISQ.Widget.Query.kbLanguageCode : null;
        ISQ.Widget.Query.send_internal(ISQ.Widget.Query.lastQuerySent, ISQ.Widget.Query.activeRequestId, null, detectedLang, querySource);
    }
    // translation enabled && retrying with translation
    //if (ISQ.Cnf.translationEnabled && retry_translateQuery && ISQ.Widget.state !== ISQ.Widget.enumState.autoQuestions)
    else if (ISQ.Cnf.translationEnabled && ISQ.Widget.state !== ISQ.Widget.enumState.autoQuestions)
    {
        ISQ.Widget.Query.queryTranslator = new ISQ.Widget.TranslationHelper.QueryTranslator(
        {
            query: ISQ.Widget.Query.lastQuerySent,
            handler: new ISQ.Handler(ISQ.Widget.Query.send_internal),
            queryId: ISQ.Widget.Query.activeRequestId
        });
    }
    else // no translation
    {
        ISQ.Widget.Query.send_internal(ISQ.Widget.Query.lastQuerySent, ISQ.Widget.Query.activeRequestId, null, null, querySource);
    }

    // pending query response
    ISQ.Widget.Query.pendingRequest = true;
};


// sends the query to the server
ISQ.Widget.Query.send_internal = function (queryText, queryId, translation, detectedLanguage, querySource)
{
    if (queryId != ISQ.Widget.Query.activeRequestId) return; // (async query translation)

    detectedLanguage = ISQ.Tools.getUniformLanguageCode(detectedLanguage);
    // hiding autocomplete if kbLanguage code doesn't fit
    ISQ.Widget.Suggestions.checkForHide(detectedLanguage, queryText);
    // switching texts array according to query's language
    ISQ.Widget.setUiLanguage(detectedLanguage);

    // setting translated query
    ISQ.Widget.Query.lastQueryTranslation = translation;

    // widget title
    ISQ.Widget.setTitle();

    // show "translating..." message
    if (translation && ISQ.Widget.state === ISQ.Widget.enumState.questions)
    {
        // TO DO:
        //var translatingText = ISQ.Widget.TranslationHelper.getStaticTranslation(ISQ.Widget.TranslationHelper.staticTranslationsEnum.translating) || "Translating";
        //_('ISQsearchMsg').innerHTML = "<b>" + translatingText + "...</b>";
        //_('ISQsearchMsg').style.visibility = "visible";

        // search anim
        //ISQ.Widget.HTML.searchAnim.show("searchAnim searchAnimTranslating");
        ISQ.Widget.HTML.contentFader.show();
        //ISQ.Widget.HTML.clearQuery.hide();
    }

    // send question
    _session().request(
    {
        url: "q.js",
        params:
        {
            "auto": ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions,
            "requestId": queryId,
            "naive": ISQ.Http.hashArguments["naive"] || null,
            "text": encodeURIComponent(queryText),
            "sameQ": ISQ.Widget.Query.isSameQuery,
            "translation": translation || null,
            "translationLanguage": detectedLanguage || null,
            "suggestion": querySource === ISQ.Widget.Query.enumTextQuerySource.suggestion
        },
        handler: function (status, jsonObject, jsonRequest)
        {
            ISQ.Widget.Query.responseHandler(status, jsonObject, jsonRequest,
                function (answers)
                {
                    if (answers.length === 1) answers[0].isSingle = true;
                    ISQ.Widget.Query.hideAnswers(answers, true);
                });
        }
    });

    // updating 'isUpdateQuery'
    ISQ.Widget.Query.isSameQuery = true;

    // clearing answer tds
    ISQ.Widget.Query.elementsToResize = null;
}

ISQ.Widget.Query.getAnswerById = function (answerId, ignoreStatistics, src, customHandler)
{
    // clearing answers
    ISQ.Widget.Suggestions.hide(_('searchSuggestions'));
	ISQ.Widget.Query.hideAnswers(null, true);

    ISQ.Widget.Query.currentAnswersForComparison = ISQ.Widget.Query.currentAnswers = null;

    //
    ++ISQ.Widget.Query.activeRequestId;

    ISQ.Widget.Query.lastQuerySent = '';
    ISQ.Widget.HTML.queryField.value = "";
    ISQ.Widget.Query.mobile_ignoreNextChange = true;

    // showing animation
    ISQ.Widget.HTML.contentFader.show();
    //ISQ.Widget.HTML.clearQuery.hide();

    // setting flag
    ISQ.Widget.Query.gettingAnswerById = true;
    ISQ.Widget.Query.pendingRequest = true;

    //initialize FAQ's
    ISQ.Widget.FAQ.initalize();

    _session().request(
    {
        url: "a.js",
        params:
        {
            requestId: ISQ.Widget.Query.activeRequestId
            ,answerId: answerId
            ,"auto": (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions || ignoreStatistics)
            ,"src": src
            , "translationLangauge": ISQ.Widget.TranslationHelper.detectedLanguage // detected language (for translation)
            , "kbLC": ISQ.Widget.Query.kbLanguageCode
        },
        handler: function (status, jsonObject, jsonRequest) { ISQ.Widget.Query.responseHandler(status, jsonObject, jsonRequest, customHandler); }
    });

    // clearing answer tds
    ISQ.Widget.Query.elementsToResize = null;
}

ISQ.Widget.Query.responseHandler = function (status, jsonObject, jsonRequest, customHandler)
{
    if (status != ISQ.Com.JsonP.Request.enumResponseType.OK)
    {
        _session().retry(jsonRequest);
        return;
    }

    var results = null;
    var similiarAnswers = false;
    var isAutoQuestion = false;
    var differentLanguage = false;

    //#region checking request id
    if (ISQ.Widget.Query.activeRequestId != jsonObject.requestId)
    {
        ////////////	Debug	//////////////////////
        ISQ.Widget.Log.add('Query: Request Id doesn\'t match. sent: ' + ISQ.Widget.Query.activeRequestId + ", received: " + jsonObject.requestId);
        return;
    }
    //#endregion

    //#region context
    if (jsonObject.context)
    {
        ISQ.Widget.Query.contextSuggestionEnabled = (jsonObject.contextSuggestionEnabled) ? true : false;
        try
        {
            // creating an by order
            arr = [];
            for (var i = 0; i < jsonObject.context.values.length; ++i)
                arr[jsonObject.context.values[i].id] = jsonObject.context.values[i];
            ISQ.Widget.Query.contextCategories = [];
            for (var i = 0; i < jsonObject.context.order.length; ++i)
                ISQ.Widget.Query.contextCategories.push(arr[jsonObject.context.order[i]]);
        }
        catch (e)
        {
            ISQ.Widget.Query.contextCategories = null;
        }
    }
    //#endregion

    //#region language code
    // checking if user's language is different than the last query
    ISQ.Widget.Query.kbLanguageCode = jsonObject.kbLanguageCode;
    differentLanguage = ISQ.Widget.Query.previousDetectedLanguage && ISQ.Widget.Query.previousDetectedLanguage !== ISQ.Widget.TranslationHelper.detectedLanguage;
    ISQ.Widget.Query.previousDetectedLanguage = ISQ.Widget.TranslationHelper.detectedLanguage;

    // hiding suggestion if lang code changed
    if (ISQ.Widget.Suggestions.currentLanguageCode && ISQ.Widget.Suggestions.currentLanguageCode != jsonObject.kbLanguageCode)
        ISQ.Widget.Suggestions.hide(_('searchSuggestions'));
    //#endregion

    //#region initiating answers
    ISQ.Widget.Query.numberOfTopics = jsonObject.answers.length;
    ISQ.Widget.Query.contextOnlyAnswers = 0;
    for (var i = 0; i < ISQ.Widget.Query.numberOfTopics; ++i)
        ISQ.Widget.Query.initResultObject(jsonObject.answers[i]);
    //#endregion

    // #region comparing with last results (if no custom handler)
    if (!customHandler && !ISQ.Widget.Query.previousResponseWasAutoQuestion && !differentLanguage && ISQ.Widget.Query.currentAnswersForComparison && jsonObject.answers.length && jsonObject.answers.length === ISQ.Widget.Query.currentAnswersForComparison.length)
    {
        var i = 0;
        for (i = 0; i < ISQ.Widget.Query.currentAnswersForComparison.length; ++i)
            if (!ISQ.Widget.Query.compareResults(ISQ.Widget.Query.currentAnswersForComparison[i], jsonObject.answers[i])) break;
        similiarAnswers = i === ISQ.Widget.Query.currentAnswersForComparison.length;
    }
    ISQ.Widget.Query.currentAnswersForComparison = jsonObject.answers;
    //#endregion

    // #region auto question?
    ISQ.Widget.Query.previousResponseWasAutoQuestion = ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions || ISQ.Widget.Query.gettingAnswerById;
    isAutoQuestion = ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions || jsonObject.requestId <= ISQ.Widget.Query.lastAutoQuestionRequestId;
    //#endregion

    //#region api event
    if (ISQ.Widget.reportEvents)
    {
        var msg = [];
        msg.push("subject=event&type=incomingsearchresults&hasresults=");
        msg.push((jsonObject.answers.length !== 0));
        msg.push("&isAutoQuestion=");
        msg.push(isAutoQuestion);
        msg.push("&query=");
        msg.push(ISQ.Tools.Base64.encodeString(ISQ.Widget.Query.lastQuerySent));
        msg.push("&results=");
        // creating and adding results data to message
        var evtResults = [];
        for (var i = 0; i < jsonObject.answers.length; ++i)
            evtResults.push({
                answerId: jsonObject.answers[i].id,
                title: (jsonObject.answers[i].translation ? jsonObject.answers[i].translation.title : jsonObject.answers[i].title),
                body: (jsonObject.answers[i].translation ? jsonObject.answers[i].translation.summary : jsonObject.answers[i].summary),
                attachments: ISQ.Widget.buildAttachmentUrls_forEvent(jsonObject.answers[i].attachments)
            });
        msg.push(ISQ.Tools.Base64.encodeString(ISQ.Data.jsonToString(evtResults)));

        // sending message
        ISQ.Widget.CDC.sendMessage(msg.join(''));
    }
    //#endregion

    // no result - rechanneling options
    ISQ.Widget.Query.rechannelingOptions = jsonObject.rechanneling || null;

    //#region showing answers
    ISQ.Widget.Query.pendingRequest = false;
    if (similiarAnswers) // similar answers
    {
        ISQ.Widget.HTML.contentFader.hide();
        ISQ.Widget.HTML.clearQuery.show();
        return;
    }

    // NEW ANSWERS TO SHOW

    // show faq on widget load when gettingAnswerById
    if (ISQ.Cnf.faqData && !ISQ.Widget.isFloat && !ISQ.Widget.userActive && ISQ.Widget.Query.gettingAnswerById && ((ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) !== 0) && jsonObject.answers.length)
        ISQ.Widget.Query.fader_callback = function () { if (ISQ.Widget.userActive) return; ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnWidgetLoad); }

    // if custom handler
    if (customHandler) customHandler(jsonObject.answers, true);
    else ISQ.Widget.Query.hideAnswers(jsonObject.answers, true);

    //#endregion

};

ISQ.Widget.Query.replacePlaceholders_answerObject = function (resultObject)
{
    //////////////////////////////////////////////////////////////////////////
    // Answer
    // perform replacement on title
    var replacerResult = ISQ.Widget.replacePlaceholders(resultObject.title, ISQ.Widget.API.getCustomParams(), "{{", "}}");
    if (replacerResult.success) // if title replacement succeeded
    {
        resultObject.title = replacerResult.text; // update title
        // and perform content replacement
        replacerResult = ISQ.Widget.replacePlaceholders(resultObject.summary, ISQ.Widget.API.getCustomParams(), "{{", "}}");
        if (replacerResult.success) resultObject.summary = replacerResult.text;
    }
    // if replacement failed
    if (!replacerResult.success) // drop answer from shown results
    {
        ISQ.Widget.Query.numberOfTopics--;
        return;
    }

    //////////////////////////////////////////////////////////////////////////
    // Answer Translation
    if (resultObject.translation)
    {
        // perform replacement on title
        var replacerResult = ISQ.Widget.replacePlaceholders(resultObject.translation.title, ISQ.Widget.API.getCustomParams(), "{{", "}}");
        if (replacerResult.success) // if title replacement succeeded
        {
            resultObject.translation.title = replacerResult.text; // update title
            // and perform content replacement
            replacerResult = ISQ.Widget.replacePlaceholders(resultObject.translation.summary, ISQ.Widget.API.getCustomParams(), "{{", "}}");
            if (replacerResult.success) resultObject.translation.summary = replacerResult.text;
        }
        // if replacement failed
        if (!replacerResult.success) // drop answer from shown results
        {
            ISQ.Widget.Query.numberOfTopics--;
            return;
        }
    }

    //////////////////////////////////////////////////////////////////////////
    // inserting to answers
    var shallowCopy = {};
    ISQ.Tools.extend(true, shallowCopy, resultObject);

    if (!ISQ.Widget.Query.currentAnswers) ISQ.Widget.Query.currentAnswers = [];
    ISQ.Widget.Query.currentAnswers.push(shallowCopy);

    // parsing answer
    var parsedSummary = ISQ.Data.getDBAnswerAsHtml(shallowCopy.summary, false, ISQ.Widget.Query.appendQuestionTag, null, 'ISQ.Widget.Query.namedAnchorClick', ISQ.Widget.referer.normal);
    shallowCopy.summary = parsedSummary.text;
    shallowCopy.summaryScript = parsedSummary.script;

    if (shallowCopy.translation)
    {
        parsedSummary = ISQ.Data.getDBAnswerAsHtml(shallowCopy.translation.summary, false, ISQ.Widget.Query.appendQuestionTag, null, 'ISQ.Widget.Query.namedAnchorClick', ISQ.Widget.referer.normal);
        shallowCopy.translation.summary = parsedSummary.text;
    }
}
// converting array of json of array of json to normal format
ISQ.Widget.Query.RecursiveContextReading = function (context, contextObject, parent)
{
    for (var i = 0; i < context.length; i++)
    {
        var currentItem = context[i];
        if (typeof currentItem=="string" && currentItem == "") continue;
        // if its a value
        if (typeof currentItem == "string")
        {
            if (parent != null)
                parent[currentItem] = currentItem;
            else
            {
                contextObject[currentItem] = currentItem;
            }
        }
        else
        {
            for (key in currentItem)
            {
                contextObject[key] = {};
                //  if (parent != null)
                //      parent.child = contextObject[key];

                ISQ.Widget.Query.RecursiveContextReading(currentItem[key], contextObject[key], contextObject[key]);
            }
        }

    }
}

// on context received callback
ISQ.Widget.Query.ContextResponse = function (context, contextCategories, callback)
{
    var answerPane = document.getElementById("answerPane");
    var contextCats = [];
    contextCategories = contextCategories.split("|");
    for (var i = 0; i < contextCategories.length; i++)
    {
        contextCats.push(contextCategories[i].split(","));
    }

    var reFormatContextData = function (contextObject, contextCats)
    {
        var categories = {};
        ISQ.Widget.Query.RecursiveContextReading(contextObject, categories, null);
		// sorting context by alphabetical order
        function sortObject(o)
        {
            var sorted = {}, key, a = [];
            for (key in o)
            {
                if (o.hasOwnProperty(key))
                {
                    a.push(key);
                }
            }
            var s = function (a, b)
            {
                var nameA = a.toLowerCase(), nameB = b.toLowerCase();
                if (nameA < nameB)
                    return -1;
                if (nameA > nameB)
                    return 1;
                return 0;
            };
            a.sort(s);

            for (key = 0; key < a.length; key++)
            {
                sorted[a[key]] = o[a[key]];
            }

            for (key in sorted)
            {
                if (typeof sorted[key] == "object")
                    sorted[key] = sortObject(sorted[key]);
            }

            return sorted;
        }
        // sorting object
        var sortedContext = sortObject(categories);
        return ISQ.Widget.Query.buildContextSelection(
        {
            "context": sortedContext,
            "body": answerPane,
            "contextCats": contextCats
        });
    }

    ISQ.Widget.Query.contextSelectors = [];

    // if contains seperated selections of context
    if (context.groups)
    {
        for (var i = 0; i < context.groups.length; i++)
        {
            reFormatContextData(context.groups[i].values, contextCats[i]);
        }
    }
    // if contains only one set of context selection
    else if (context.values)
    {
        reFormatContextData(context.values, contextCats[0]);
    }

    if (!ISQ.Widget.Query.buildContextSelectionOverride)
    {
        var contextSelectionTitle = document.createElement("div");
        contextSelectionTitle.className = "contextSelectionTitle";
        contextSelectionTitle.innerHTML = "More than one answer is available";
        answerPane.insertBefore(contextSelectionTitle, answerPane.childNodes[0]);
    }
    // building answers after context returned and ui built
    if (callback)
        callback();
};
ISQ.Widget.Query.contextSuggestionEnabled = false;
ISQ.Widget.Query.processAnswers = function (results)
{
    // no results OR not in questions state, returning
    if (!results || ((ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) === 0))
    {
        /// hiding search animation ///
        ISQ.Widget.HTML.contentFader.hide();
        ISQ.Widget.HTML.clearQuery.show();
        return;
    }
    // in case answers received after user deleted the textbox
    if (ISQ.Widget.HTML.queryField.value === "" && ISQ.Widget.state === ISQ.Widget.enumState.questions && !ISQ.Widget.Query.gettingAnswerById)
    {
        ISQ.Widget.HTML.contentFader.hide();
        ISQ.Widget.HTML.clearQuery.show();
        return;
    }

    try
    {
        //var translationsArray = null;
        var noActionBar = false;
        ISQ.Widget.Query.firstAnswerId = -1;
        ISQ.Widget.Query.chatEscalationAction = ISQ.Widget.Query.numberOfTopics == 0 ? ISQ.Widget.enumChatEscalationActions.normal : ISQ.Widget.enumChatEscalationActions.hide;
        ISQ.Widget.Query.chatPushAnswers.pushed = false;
        ISQ.Widget.Query.currentAnswers = null;

        // perform replacing on answers before processing, as answers may be dropped
        if (ISQ.Widget.Query.numberOfTopics > 0)
        {
            for (var i = 0; i < results.length; ++i)
                ISQ.Widget.Query.replacePlaceholders_answerObject(results[i]);
        }

        // if there are results
        if (ISQ.Widget.Query.numberOfTopics > 0)
        {
            //ISQ.Widget.Query.currentAnswers = new Array();
            var resultObject;
            var resizeWidget = false;
            if (ISQ.Export)
            {
                ISQ.Export.currentMaxHeight = 0;
                ISQ.Export.currentMaxWidth = 0;
            }
            // build answers function
            var buildAnswers = function ()
            {
                // showing selected context
                if (ISQ.Widget.Query.contextSuggestionEnabled)
                    ISQ.Widget.Query.contextSelectionClearContext();

                var answerContactForm = []
                var currentFormId = null;
                for (var i = 0; i < ISQ.Widget.Query.numberOfTopics; i++)
                {
                    resultObject = ISQ.Widget.Query.currentAnswers[i]; // getting result

                    if(i==0)
                        ISQ.Widget.lastQuestionId = resultObject.id;
                    resultObject.answerNum = i;

                    // do we need to translate the answer back into the user's language?
                    var answerLanguage = resultObject.languageCode || ISQ.Widget.Query.kbLanguageCode;
                    //var toTranslateContent = ISQ.Widget.Query.toTranslateContent(answerLanguage);

                    // adding to previous answers array
                    //ISQ.Widget.Query.currentAnswers.push(resultObject);

                    //search for new contact forms.for loading.
                    currentFormId = null;
                    if(resultObject && resultObject.rechanneling && resultObject.rechanneling.length)
                    {
                        //iterate for each form
                        _it(resultObject.rechanneling,function(channel)
						{
                            //if contactform exists and need to show within in article.
                            if(channel.contactForms && channel.showInArticle)
                            {
                                //search if already exists
                                var found = false;
                                currentFormId = channel.contactForms;
                                for(var k = 0; k < answerContactForm.length; k++ )
                                    if(answerContactForm[k].contactForms === channel.contactForms)
                                    {
                                        found = true;
                                        break;
                                    }
                                //if not exists, add to forms list.

                                if(!found) answerContactForm.push(channel);

                                return false; // if found, return.
                            }
                        });
                    }

                    // saving first answer
                    if (i === 0)
                    {
                        ISQ.Widget.Query.firstAnswerId = resultObject.id;

                        ISQ.Widget.Query.rechannelingOptions = resultObject.rechanneling;

                        // if showing answer after a search-by-id,
                        // setting its title in the search box
                        if (ISQ.Widget.Query.gettingAnswerById)
                        {
                            // need to clear textbox on click
                            ISQ.Widget.Query.clearTextboxOnInteraction = true;

                            ISQ.Widget.Query.mobile_ignoreNextChange = true;
                            ISQ.Widget.Query.lastQuerySent = resultObject.title;
                            if (!ISQ.Widget.userActive && ISQ.Cnf.initialText) // if user is not active, showing initial text
                                ISQ.Widget.HTML.queryField.value = ISQ.Cnf.initialText;
                            else //if (!toTranslateContent)
                            {
                                if (ISQ.Cnf.autoQuestionsTypeEffect)
                                {
                                    ISQ.Widget.Query.typeTimer = new ISQ.Timer(new ISQ.Handler(ISQ.Widget.Query.typeQuestion), false, (resultObject.translation ? resultObject.translation.title : resultObject.title), 0);
                                    ISQ.Widget.Query.typeTimer.start(ISQ.Widget.Query.typeInterval);
                                }
                                else
                                {
                                    ISQ.Widget.HTML.queryField.value = (resultObject.translation ? resultObject.translation.title : resultObject.title);
                                }
                            }

                            // saving user's first interaction with the widget
                            if (!ISQ.Widget.Query.lastWrittenQuery)
                                ISQ.Widget.Query.lastWrittenQuery = (resultObject.translation ? resultObject.translation.title : resultObject.title);

                            // scrolling to top in mobiles #8873
                            if (ISQ.Http.browser.isMobile && window.top === window)
                                document.body.scrollTop = 0;
                        }

                        // chat required skill (setting global LP param)
                        if (typeof (ISQ.Widget.iChat.instance) !== 'undefined' && ISQ.Widget.iChat.instance != null && ISQ.Widget.state !== ISQ.Widget.enumState.autoQuestions)
                        {
                            var skill = "";
                            if (resultObject.chatRequiredSkill) skill = resultObject.chatRequiredSkill;
                            else if (ISQ.Widget.Chat.chatConfig.skill) skill = ISQ.Widget.Chat.chatConfig.skill;

                            noActionBar = ISQ.Widget.iChat.instance.getAvailabilityPerAnswer(skill);
                        }
                    }

                    // chat escalation action
                    ISQ.Widget.Query.chatEscalationAction = Math.max(ISQ.Widget.Query.chatEscalationAction, resultObject.chatEscalationAction); // the chatEscalationAction enum is arranged in severity order
                    if (!ISQ.Widget.Query.chatInviteContent) ISQ.Widget.Query.chatInviteContent = resultObject.chatInviteContent;

                    // prevent push chat in auto questions (#5239)
                    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions && ISQ.Widget.Query.chatEscalationAction == ISQ.Widget.enumChatEscalationActions.pushChat)
                        ISQ.Widget.Query.chatEscalationAction = ISQ.Widget.enumChatEscalationActions.normal;

                    // prevent push chat for the same answer twice (#7887)
                    if (ISQ.Widget.Query.chatEscalationAction == ISQ.Widget.enumChatEscalationActions.pushChat)
                    {
                        if (ISQ.Widget.Query.chatPushAnswers[resultObject.id]) ISQ.Widget.Query.chatEscalationAction = ISQ.Widget.enumChatEscalationActions.normal;
                        ISQ.Widget.Query.chatPushAnswers[resultObject.id] = true;
                    }

                    if (resultObject.contextSelectionOnly) ++ISQ.Widget.Query.contextOnlyAnswers;

                    // showing translation
                    if (resultObject.translation) {
                        // append the translated answer to the html table
                        ISQ.Widget.Query.appendSingleAnswer(
                            {
                                answerObject: resultObject,
                                footer: ISQ.Widget.TranslationHelper.getStaticTranslation(ISQ.Widget.TranslationHelper.staticTranslationsEnum.footer),
                                direction: ISQ.Translation.Infra.getLanguageDirection(ISQ.Widget.TranslationHelper.detectedLanguage),
                                showTranslateIcon: true,
                                visible: true,
                                translationProvider: resultObject.translation.provider,
                                translated: true,
                                contactFormId: currentFormId
                            });

                        // append the original answer to the html table as hidden
                        ISQ.Widget.Query.appendSingleAnswer(
                            {
                                answerObject: resultObject,
                                footer: ISQ.Cnf.answerFooter,
                                direction: ISQ.Translation.Infra.getLanguageDirection(ISQ.Cnf.initialUiLanguage),
                                showTranslateIcon: true,
                                visible: false, // visible if translation failed
                                translationProvider: resultObject.translation.provider,
                                contactFormId: currentFormId
                            });
                    }
                    // appending answer w/o translation
                    else {
                        var answerTable = ISQ.Widget.Query.appendSingleAnswer(
                            {
                                answerObject: resultObject,
                                footer: ISQ.Cnf.answerFooter,
                                direction: ISQ.Translation.Infra.getLanguageDirection(answerLanguage),
                                showTranslateIcon: false,
                                visible: true,
                                contactFormId: currentFormId
                            });

                        resultObject.answerTable = answerTable;
                    }
                    if (resultObject.externalSourceType)
                        switch (resultObject.externalSourceType)
                    {
                        case ISQ.enumContentProviders.worldManuals:
                            resizeWidget = true;
                            break;
                    }
                }

                if(answerContactForm.length)
                    ISQ.Widget.Forms.getForms(answerContactForm);

                if (resizeWidget && ISQ.Widget.isFloat)
                {
                    var elements = ISQ.Html.getElementsByClassName(ISQ.Widget.HTML.widgetContainer, "hoverImagesClass");
                    if (elements.length > 0)
                    {
                        ISQ.Widget.CDC.sendMessage("subject=setSize&height=" + ISQ.Export.currentHeight + "&width=" + ISQ.Export.currentWidth);
                        // ISQ.Export.wmWidgetSize(answerTable);
                    }
                    else
                        ISQ.Widget.CDC.sendMessage("subject=widgetToExpand");
                }


                // display answers
                ISQ.Widget.Query.displayAnswers(noActionBar);
            }

            // reading context and loading context selection if no context available
            if (ISQ.Widget.Query.contextCategories)
                ISQ.Widget.Query.processContext(buildAnswers);
            else
                buildAnswers();

        }
        /// no answers ///
        else
        {
            // showing 'no results' + 'back'
            var previousQuestion = ISQ.Widget.Query.getCurrentQuestionFromTrail();
            if (previousQuestion)
            {
                var backDiv = createDiv(ISQ.Widget.HTML.answerPane, '.answerBackLinkContainer');
                var backLink = createLink(
				{
				    text: ISQ.Widget.getStaticText('back'),
				    parent: backDiv,
				    onclick: function ()
				    {
				        ISQ.Widget.Query.popQuestionFromTrail();
				        ISQ.Widget.Query.tempQuestionTrailId = null;
				        if (ISQ.Widget.Query.typeTimer) ISQ.Widget.Query.typeTimer.cancel();
				        if (!this.question.isTagAnId)
				        {
				            ISQ.Widget.Query.ask(this.question.tag, ISQ.Widget.Query.enumTextQuerySource.linkedAnswer);
				        }
				        else
				        {
				            ISQ.Widget.Query.tempQuestionTrailId = this.question.tag;
				            ISQ.Widget.Query.getAnswerById(this.question.tag);
				        }
				    }
				});
                backLink.question = previousQuestion;
            }

            var direction = ISQ.Widget.Query.toTranslateContent(ISQ.Cnf.kbLanguageCode) ? ISQ.Translation.Infra.getLanguageDirection(ISQ.Widget.TranslationHelper.detectedLanguage) : ISQ.Widget.Localize.array["dir"]; // direction may vary if detected language is different than the answers
            var d = createDiv(ISQ.Widget.HTML.answerPane, ".noResults &direction:" + direction);

            var noResultsMessage = "";
            // requesting selected context
            var context = ISQ.Widget.Query.getContextString();
            // checking if feature enabled & context selected
            if (ISQ.Widget.Query.contextSuggestionEnabled && context)
                noResultsMessage = ISQ.Widget.getStaticText("searchMsgNOResultsContext");
            else
                noResultsMessage = ISQ.Widget.getStaticText("searchMsgNOResults");

            noResultsMessage = ISQ.Widget.replacePlaceholders(noResultsMessage, ISQ.Widget.API.getCustomParams(), "{{", "}}", true).text;
            // either replacing query with actual query , or with context, depends if context suggestion is enabled and context exist


            if (ISQ.Widget.Query.contextSuggestionEnabled && context)
            {
                noResultsMessage = noResultsMessage.replace('{CONTEXT}', context);
                noResultsMessage = noResultsMessage.replace("{LINK}", '<span class="clearSelectionLink" onclick="ISQ.Widget.Query.clearContext()">');
                noResultsMessage = noResultsMessage.replace("{/LINK}", "</span>");
            }
            else
                noResultsMessage = noResultsMessage.replace('{QUERY}', ISQ.Data.unHTML(_query(true)));

            d.innerHTML = noResultsMessage;

            try
            {
                if (ISQ.Widget.Query.contextSuggestionEnabled)
                    var noResultsScript = ISQ.Widget.getStaticText("searchMsgNOResultsContextScript");
                else
                    var noResultsScript = ISQ.Widget.getStaticText("searchMsgNOResultsScript");

                if (noResultsScript)
                {
                    noResultsScript = ISQ.Widget.replacePlaceholders(noResultsScript, ISQ.Widget.API.getCustomParams(), "{{", "}}", true).text;
                    eval(noResultsScript);
                }
                if (ISQ.Cnf.faqData)
                {
                    // showing FAQ
                    ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnNoResuls);
                }
            }
            catch (e) { }

        // display answers
        ISQ.Widget.Query.displayAnswers(noActionBar);
    }
    }
    catch (e)
    {
        /// hiding search animation ///
        ISQ.Widget.HTML.contentFader.hide();

        ///// debug /////
        ISQ.Widget.Log.add('Query.parseAnswers:' + e, ISQ.Widget.Log.statusEnum.RED);
    }
};

ISQ.Widget.Query.processContext = function (callback)
{
    var AnswersContexts = {};
    ISQ.Widget.Query.ContextObject = {};
    // creating a context object for later use
    for (var i = 0; i < ISQ.Widget.Query.contextCategories.length; i++)
    {
        ISQ.Widget.Query.ContextObject[ISQ.Widget.Query.contextCategories[i].id] = ISQ.Widget.Query.contextCategories[i];
        if (!ISQ.Widget.Query.ContextObject[ISQ.Widget.Query.contextCategories[i].id].parentId)
            ISQ.Widget.Query.ContextObject[ISQ.Widget.Query.contextCategories[i].id].parentId = null;
    }

    var contextTreeMapping = {};
    var contextTrees = [];
    var categoriesArr = [];
    for (var i = 0; i < ISQ.Widget.Query.numberOfTopics; i++)
    {
        resultObject = ISQ.Widget.Query.currentAnswers[i];
        // if answer relies on specific context
        if (resultObject.contextSelection && resultObject.contextSelectionOnly)
        {
            for (var x = 0; x < resultObject.contextSelection.length; x++)
            {
                // grouping the context selections into an array for later use
                var currentContext = ISQ.Widget.Query.ContextObject[resultObject.contextSelection[x]];
                if (!contextTreeMapping[currentContext.id])
                {
                    contextTreeMapping[currentContext.id] = { "name": ISQ.Widget.Query.ContextObject[currentContext.id].name };
                    if (!currentContext.parentId)
                        currentContext.parentId = null;
                    categoriesArr.push({ "id": currentContext.id, "parentId": currentContext.parentId });
                }
            }
        }
    }
    // going through an array that contains all the categories and mapping them out to parent <--> child so we can make sure no item is missing
    for (var i = 0; i < categoriesArr.length; i++)
    {
        var cat = categoriesArr[i];
        if (cat.parentId)
        {
            // if server did not send a crucial context
            if (!contextTreeMapping[cat.parentId])
            {
                contextTreeMapping[cat.parentId] = { "name": ISQ.Widget.Query.ContextObject[cat.parentId].name }
                categoriesArr.push({ "id": ISQ.Widget.Query.ContextObject[cat.parentId].id, "parentId": ISQ.Widget.Query.ContextObject[cat.parentId].parentId });
            }
            contextTreeMapping[cat.parentId].child = contextTreeMapping[cat.id];
            contextTreeMapping[cat.id].parent = contextTreeMapping[cat.parentId];
        }
        else
            contextTrees.push(contextTreeMapping[cat.id]);
    }
    // read from context tree all the items
    var drillDownGetContexts = function (contextNode, sb)
    {
        sb.push(contextNode.name);
        if (contextNode.child)
        {
            sb.push(",");
            drillDownGetContexts(contextNode.child, sb);
        }
    }
    var contexts = [];
    // going through all the trees and reading them into a string that will be sent in the request
    for (var i = 0; i < contextTrees.length; i++)
    {
        drillDownGetContexts(contextTrees[i], contexts);
        if (i < contextTrees.length - 1)
            contexts.push("|");
    }
    // sending request to the server to get the data
    //if there is a context to request
    if (contexts.length > 0)
        _session().request(
                {
                    url: "contextvalues.js",
                    params:
                    {
                        account: ISQ.Widget.account,
                        kb: ISQ.Cnf.kbId,
                        //   cb: "ISQ.Widget.Query.ContextResponse",
                        contexts: contexts.join('')
                    },
                    handler: function (status, jsonData)
                    {
                        // succeeded
                        if (status == ISQ.Com.JsonP.Request.enumResponseType.OK)
                        {
                            ISQ.Widget.Query.ContextResponse(jsonData, contexts.join(''), callback);
                            //mthis.currentLanguageCode = kbLanguageCode;
                            //mthis.processResponse(jsonData, infoObject);
                        }
                        // failed
                        else
                        {

                        }
                    }
                });
    else
        callback();

}

ISQ.Widget.Query.initResultObject = function (jsonObject)
{
    // setting default values
    jsonObject.languageCode = jsonObject.languageCode || null;
    jsonObject.chatEscalationAction = (typeof jsonObject.chatEscalationAction == "undefined") ? ISQ.Widget.enumChatEscalationActions.normal : jsonObject.chatEscalationAction;
    jsonObject.chatRequiredSkill = jsonObject.chatRequiredSkill || null;
    jsonObject.chatInviteContent = jsonObject.chatInviteContent || null;
    jsonObject.attachments = jsonObject.attachments || null;
    jsonObject.context = !jsonObject.context ? null : (function () { var splt = jsonObject.context.split(','); var a = []; for (var i = 0; i < splt.length; ++i) { a[splt[i]] = splt[++i]; }; return a; })();
    jsonObject.title = ISQ.Data.htmlEncode(jsonObject.title);
    jsonObject.externalSourceId = jsonObject.externalSourceId;
    jsonObject.externalSourceType = jsonObject.externalSourceType;
    jsonObject.translation = jsonObject.translation || null;
};
ISQ.Widget.Query.compareResults = function (answer1, answer2)
{
    var smpCompare = function (obj1, obj2)
    {
        for (var mm in obj1) if (obj1[mm] != obj2[mm]) return false;
        return true;
    }

    if (!smpCompare(answer1, answer2)) return false;
    if (!smpCompare(answer2, answer1)) return false;
    return ISQ.Tools.compareArrays(answer1.context, answer2.context);
}

// custom UI for the context selection
ISQ.Widget.Query.buildContextSelectionOverride = null;
// holds value that states if context was selected by the user
ISQ.Widget.Query.contextByUser = false;

// changing the context and reasking
ISQ.Widget.Query.changeContext = function (currentContext)
{
    _session().setContext(currentContext, function ()
    {
        ISQ.Widget.CDC.sendMessage("subject=updateContext&context=" + ISQ.Data.jsonToString(currentContext));
        ISQ.Widget.Query.contextByUser = true;
        // saving API data (trying to use html5 localStorgae)
        if (window['localStorage'] && !ISQ.Http.browser.isIOS7)
            window['localStorage'].setItem("nanorep.wContext" + ISQ.Http.Cookies.encode64(ISQ.Widget.account), ISQ.Data.jsonToString(currentContext));
        else
            ISQ.Http.Cookies._write("nanorep.wContext" + ISQ.Http.Cookies.encode64(ISQ.Widget.account), ISQ.Data.jsonToString(currentContext), "/widget", ISQ.Http.domain(false), false);
        ISQ.Widget.API.reAsk();
    }, true);
}
// clearing the context of the widget
ISQ.Widget.Query.clearContext = function ()
{
    _session().setContext({ "nocontext": "true" }, function () { ISQ.Widget.API.reAsk(); }, true);
    window["localStorage"].removeItem("nanorep.wContext" + ISQ.Http.Cookies.encode64(ISQ.Widget.account));
    ISQ.Http.Cookies._delete("nanorep.wContext" + ISQ.Http.Cookies.encode64(ISQ.Widget.account), "/widget", ISQ.Http.domain(false), false);
}

ISQ.Widget.Query.compileContextDisplayName = function(text,contextStr)
{
    var value = text;
    if(window.setContextDisplayName) value = window.setContextDisplayName(text);
    contextStr.push(value);
}

ISQ.Widget.Query.getContextString = function (withLabels)
{
    var contextMatch = 0;
    var currentContext = _session().contexts();
    if (currentContext && !currentContext.nocontext && ISQ.Widget.Query.contextCategories)
    {
        var contextStr = [];
        for (var i = 0; i < ISQ.Widget.Query.contextCategories.length; i++)
        {
            if (!currentContext[ISQ.Widget.Query.contextCategories[i].name.toLowerCase()])
                continue;
            if (withLabels)
            {
                contextStr.push(ISQ.Widget.Query.contextCategories[i].name.firstLetterUpperCase());
                contextStr.push(" ");
            }

            //changing content name to custom name
            ISQ.Widget.Query.compileContextDisplayName(currentContext[ISQ.Widget.Query.contextCategories[i].name.toLowerCase()],contextStr);

            contextStr.push(", ");
        }
        contextStr.splice(contextStr.length - 1, 1);
        return contextStr.join("");
    }
    return null;
}
ISQ.Widget.Query.contextSelectionClearContext = function ()
{

    var contextMatch = 0;
    var currentContext = _session().contexts();
    if (currentContext && !currentContext.nocontext && ISQ.Widget.Query.contextCategories)
    {
        for (var i = 0; i < ISQ.Widget.Query.contextCategories.length; i++)
        {
            if (!currentContext[ISQ.Widget.Query.contextCategories[i].name.toLowerCase()])
                continue;
            contextMatch++;
        }
        if (contextMatch == ISQ.Widget.Query.contextCategories.length)
        {
            // continue
        }
        else if (!ISQ.Widget.Query.contextByUser) return;

        // build cancel context UI here
        var contextStr = ["<span>"];
        var selectionDiv = createDiv(null, ".selectedContextElement&.borderBoxSizing");
        selectionDiv.id = "selectedContextElement";
        for (var i = 0; i < ISQ.Widget.Query.contextCategories.length; i++)
        {
            if (!currentContext[ISQ.Widget.Query.contextCategories[i].name.toLowerCase()])
                continue;
            // contextStr.push(ISQ.Widget.Query.contextCategories[i].name.firstLetterUpperCase());
            //contextStr.push(":");
            contextStr.push("<strong style=\"font-weight:600;\">");

            ISQ.Widget.Query.compileContextDisplayName(currentContext[ISQ.Widget.Query.contextCategories[i].name.toLowerCase()],contextStr);

            contextStr.push("</strong>");
            contextStr.push(" | ");
        }
        contextStr.splice(contextStr.length - 1, 1);
        contextStr.push("</span>")


        selectionDiv.innerHTML = contextStr.join('');
        var changeButton = createDiv(selectionDiv, ".selectedContextElementChangeButton")
        changeButton.innerHTML = "Change";
        // on current context clicked, clear context and reask
        changeButton.onclick = function ()
        {
            ISQ.Widget.Query.clearContext();
            selectionDiv.parentNode.removeChild(selectionDiv);
        }
        ISQ.Widget.HTML.answerPane.appendChild(selectionDiv);
    }
}
ISQ.Widget.Query.contextSelectors = [];
// adding an answer to the UI with a context selection
ISQ.Widget.Query.buildContextSelection = function (obj)
{
    ISQ.Widget.Suggestions.hide(_('searchSuggestions'));
    if (ISQ.Widget.Query.buildContextSelectionOverride)
    {
        ISQ.Widget.Query.buildContextSelectionOverride(obj);
        return;
    }
    var tableBody = obj.body;
    var contextCats = obj.contextCats;
    var contextSelectionGroup = createDiv(null);
    contextSelectionGroup.className = "contextSelectors";

    var contextValues = obj.context;
    var categories = ISQ.Widget.Query.contextCategories;

    var selectors = { "items": [] };
    var selectionsClearChilds = function (selector)
    {
        selector.element.innerHTML = '';
        selector.uniqueValues = {};
        selector.container.style.display = 'none';
        if (selector.childElement)
        {
            selectionsClearChilds(selector.childElement);
        }
    }

    for (var i = 0; i < contextCats.length; i++)
    {
        var selectorName = contextCats[i];
        for (var x = 0; x < ISQ.Widget.Query.contextCategories.length; x++)
        {
            if (!ISQ.Widget.Query.contextCategories[x].selectionText || ISQ.Widget.Query.contextCategories[x].selectionText.length == 0)
                continue;
            if (ISQ.Widget.Query.contextCategories[x].name == selectorName)
            {
                selectorName = ISQ.Widget.Query.contextCategories[x].selectionText
                break;
            }
        }

        var parentSelector = null;
        var selector = {};
        selector.labelName = selectorName;
        selector.name = contextCats[i]; //categories[i].name;
        selector.idx = i;
        selector.ldx = contextCats.length - 1;
        //  selector.id = categories[i].id;
        selector.container = document.createElement("div");
        selector.fieldName = document.createElement("div");
        selector.fieldName.className = "contextLabel";
        selector.fieldName.innerHTML = selectorName;
        selector.uniqueValues = {};
        selector.element = document.createElement("select");
        selector.element.className = "borderBoxSizing cWuSelector contextSelect";
        selector.element.selector = selector;
        selector.populateNext = false;
        selector.element.onchange = function ()
        {
            var selector = this.selector;
            if (selector.childElement)
            {
                selectionsClearChilds(selector.childElement);
                // if nothing selected, populate next child
                // if (this.options[this.selectedIndex].value != "Any")
                if (this.selectedIndex != -1)
                {
                    ISQ.Widget.Query.populateContextSelect({
                        "selectors": selectors,
                        "contextIdx": selector.idx + 1,
                        "selector": selector.childElement,
                        "contextValues": selector.uniqueValues[selector.element.options[selector.element.selectedIndex].value],
                        // "categories": categories,
                        "populate": true // force populating the dropdown without further checks
                    });
                }
                if (!ISQ.Widget.isFloat)
                {
                    // resize the content pane
                    ISQ.Widget.HTML.resizeHandler();

                    // dynamic size
                    ISQ.Widget.HTML.dynamicSize_sendMessage();
                }
            }
            else
            {
                // making sure if there are independed dropdowns, that they were all selected before reasking
                var items = ISQ.Html.getElementsByClassName(document, "cWuSelector");
                for (var i = 0; i < items.length; i++)
                {
                    if (items[i].selectedIndex == 0)
                        return false;
                }
                // updating context
                var currentContext = _session().contexts() || {};
                if (currentContext.nocontext)
                    delete currentContext["nocontext"];

                for (var x = 0; x < ISQ.Widget.Query.contextSelectors.length; x++)
                {
                    var mySelector = ISQ.Widget.Query.contextSelectors[x];
                    for (var i = 0; i < mySelector.items.length; i++)
                    {
                        currentContext[mySelector.items[i].name] = mySelector.items[i].element.options[mySelector.items[i].element.selectedIndex].value.Trim(" ");
                    }
                }
                // updating the context of the widget according to the selection
                ISQ.Widget.Query.changeContext(currentContext);
                return false;
            }
        }
        if (i == 0)
        {
            ISQ.Widget.Query.populateContextSelect({
                "selectors": selectors,
                "contextIdx": i,
                "selector": selector,
                "contextValues": contextValues,
                "categories": categories
            });
        }
        else
        {
            selector.container.style.display = 'none';
        }
        selector.container.appendChild(selector.fieldName);
        selector.container.appendChild(selector.element);
        contextSelectionGroup.appendChild(selector.container);
        // if first select adding automatically all the values.

        // linking dropdown -- > parent dropdown
        selectors.items.push(selector);
    }
    ISQ.Widget.Query.contextSelectors.push(selectors);

    // linking between selectors
    for (var x = selectors.items.length - 2; x >= 0; x--)
    {
        selectors.items[x].childElement = selectors.items[x + 1];
    }
    // executing the change command on all the drop downs - not relevant anymore as we add a "please select" item
    for (var i = 0; i < selectors.items.length; i++)
    {
        if (selectors.items[i].element.options.length == 1)
        {
            selectors.items[i].element.onchange();
        }
    }
    var items = ISQ.Html.getElementsByClassName(document, "cWuSelector");
    if (tableBody.childNodes.length > 0 && items.length == 0)
        tableBody.insertBefore(contextSelectionGroup, tableBody.childNodes[0]);
    else
        tableBody.appendChild(contextSelectionGroup);

    var contextSelectedItem = document.getElementById("selectedContextElement");
    if (contextSelectedItem)
        contextSelectedItem.parentNode.removeChild(contextSelectedItem);

}
// populating selectbox with values
ISQ.Widget.Query.populateContextSelect = function (obj)
{
    var selectors = obj.selectors;
    var idx = obj.contextIdx;
    var selector = obj.selector;
    var contextValues = obj.contextValues;
    //var categories = obj.categories;
    var populate = obj.populate;

    if (selectors.items.length == 0 || selectors.populateNext || populate)
    {
        selectors.populateNext = false;
        // insert context values to selector
        var addValue = function (key,value)
        {
            var option = createElement("option");
            option.value = value;
            option.innerHTML = key;
            selector.element.appendChild(option);
        }
        addValue("Please select",-1);
        //addValue("Any","");

        selector.container.style.display = 'block';
        for (key in contextValues)
        {
            if (selector.uniqueValues[key])
                continue;

            selector.uniqueValues[key] = contextValues[key];

            var optionValue = key;
            var option = createElement("option");
            option.value = optionValue;
            option.innerHTML = optionValue;
            selector.element.appendChild(option);
        }
    }
}

ISQ.Widget.Query.processQuotes = function (parentNode, id)
{
    // adding 'use this answer' (#11786)
    if (ISQ.Cnf.supportBlockQuotes)
    {
        (function recFunc(node)
        {
            // found a blockquote
            if (node.nodeName == "BLOCKQUOTE")
            {
                // empty
                if (node.innerText.Trim() == ""
                    && !node.innerHTML.contains("IMG")) return;

                node.className += " enabled";
                node.onclick = function ()
                {
                    // event
                    var query = ISQ.Tools.Base64.encodeString(ISQ.Widget.Query.lastQuerySent);
                    var text = ISQ.Tools.Base64.encodeString(node.innerHTML);
                    if (ISQ.Widget.reportEvents)
                        ISQ.Widget.CDC.sendMessage("subject=event&type=quote&query=" + query + "&answerid=" + id + "&text=" + text);
                }
            }

            // going over children
            for (var i = 0; i < node.childNodes.length; ++i)
                arguments.callee(node.childNodes[i]);
        })(parentNode);
    }
}

//////////////////////////////////////////////////////////////////////////
// appendSingleAnswer
ISQ.Widget.Query.appendSingleAnswer = function (obj)
{

    // if should show context selection
    if (obj.answerObject.contextSelectionOnly || obj.answerObject.summary == "")
        return;

    // parse answer summary (doing replace before HTML processing to avoid corruption by wbr)
    var summaryBuilder = [];

    var summary, title;
    var direction = ISQ.Widget.Localize.array["dir"];
    if (obj.translated)
    {
        summary = obj.answerObject.translation.summary;
        title = obj.answerObject.translation.title;
        direction = obj.direction || ISQ.Translation.Infra.getLanguageDirection(ISQ.Widget.TranslationHelper.detectedLanguage);
    }
    else
    {
        summary = obj.answerObject.summary;
        title = obj.answerObject.title;
        //directionByLanguage = ISQ.Translation.Infra.getLanguageDirection(ISQ.Cnf.initialUiLanguage);
        var directionByLanguage = (ISQ.Widget.HTML.dynamicRTLCssLoaded) ? "rtl" : "ltr";
        direction = (directionByLanguage != "") ? directionByLanguage : obj.direction;
    }

    // create answer table
    var padding;
    var tbody = createTable(ISQ.Widget.HTML.answerPane, '', direction, '.answerTable &' + (obj.style || ''));
    var tableId = "tblAnswer_" + obj.answerObject.id;
    tbody.parentNode.setAttribute("id", tableId + obj.visible);
    var textAlign = direction === 'rtl' ? 'right' : 'left';
    var textAlignOpp = direction === 'rtl' ? 'left' : 'right';

    // answer title
    if (title && title.Trim() !== '')
    {
        var tr = createRow(tbody, ".TRanswerOnMouseout");
        tr.onmouseover = function () { this.className = 'TRanswerOnMouseover' };
        tr.onmouseout = function () { this.className = 'TRanswerOnMouseout' };

        var td = createTd(tr, '', 'top');
        var titleText;
        var titleTable = createTable(td, '100%', direction);
        var titleTr = createRow(titleTable);
        var titleTd = createTd(titleTr, '', (obj.isFAQ ? 'middle' : 'top'), '.answerTitle &.expanded');

        // handle answers from external source
        var externalSourceIconShown = false;
        titleText = ISQ.Data.breakWords(title);

        // add 'back' link before title if we have a question in the question trial
        if (obj.answerObject.answerNum == 0 && !obj.translated)
        {
            //#region question trail back link
            var previousQuestion = ISQ.Widget.Query.getCurrentQuestionFromTrail();
            if (previousQuestion)
            {
                var backDiv = createDiv(document.body, '.answerBackLinkContainer');
                var backLink = createLink({
                    text: ISQ.Widget.getStaticText('back'),
                    parent: backDiv,
                    onclick: function ()
                    {
                        ISQ.Widget.Query.popQuestionFromTrail();
                        ISQ.Widget.Query.tempQuestionTrailId = null;
                        if (ISQ.Widget.Query.typeTimer) ISQ.Widget.Query.typeTimer.cancel();
                        if (ISQ.Cnf.faqData && this.question.tag == ISQ.Cnf.initialText) // #8924
                        {
                            clearNode(ISQ.Widget.HTML.answerPane);
                            ISQ.Widget.Query.mobile_ignoreNextChange = true;
                            ISQ.Widget.HTML.queryField.value = ISQ.Cnf.initialText;
                            ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnClearSearchField);
                        }
                        else if (!this.question.isTagAnId)
                        {
                            ISQ.Widget.Query.ask(this.question.tag, ISQ.Widget.Query.enumTextQuerySource.linkedAnswer);
                            ISQ.Widget.Query.clearTextboxOnInteraction = false;
                        }
                        else
                        {
                            ISQ.Widget.Query.tempQuestionTrailId = this.question.tag;
                            ISQ.Widget.Query.getAnswerById(this.question.tag);
                        }
                    }
                });
                backLink.question = previousQuestion;
                ISQ.Widget.HTML.answerPane.insertBefore(backDiv, ISQ.Widget.HTML.answerPane.firstChild);
            }
            //#endregion
        }

        var tdiv = createDiv(titleTd, '.titleText');
        tdiv.innerHTML = "<h3>" + titleText + "</h3>";
        tdiv.setAttribute("tabindex", "5");
        if (obj.answerObject.context != null && ISQ.Widget.Query.contextCategories)
        {
            var d = createDiv(titleTd, ".answerContextContainer");
            for (var ndx = 0; ndx < ISQ.Widget.Query.contextCategories.length; ++ndx)
            {
                // only if answer has this value
                var data = obj.answerObject.context[ISQ.Widget.Query.contextCategories[ndx].id];
                if (!data) continue;

                // skipping contexts not allowed to be visible
                if ((ISQ.Widget.Query.contextCategories[ndx] && ISQ.Widget.Query.contextCategories[ndx].flags & ISQ.Widget.enumKBCategoriesFlags.visibleInWidget) != ISQ.Widget.enumKBCategoriesFlags.visibleInWidget)
                    continue;

                createElement("span", d, ".answerContext").innerHTML = data;
            }
        }

        // Add keywordset Id
        //createDiv(titleTd, '.answerContext').innerHTML = obj.answerObject.keywordsetId;

        // translation icon
        var translationIcon = null;
        if (obj.showTranslateIcon && ISQ.Cnf.translationEnabled)
        {
            var dir = obj.visible ? direction : null;
            translationIcon = ISQ.Widget.Translation.createTranslationIcon(tableId, obj.translationProvider, direction, obj.visible);
            if (translationIcon !== null)
            {
                padding = '&padding-' + (externalSourceIconShown ? textAlign : textAlignOpp) + ': 5px;';
                td = createTd(titleTr, '', 'top', '.answerIcon &.globe ' + padding);
                td.appendChild(translationIcon);
            }

        }

        // thumb icon
        var thumbIcon = null;
        var showFaqLikes = !ISQ.Http.browser.isIE7 && obj.isFAQ && ISQ.Http.hashArguments["showlikes"] !== 'false' && ISQ.Http.urlArguments["showlikes"] !== 'false';
        if (showFaqLikes)// || (!obj.isFAQ && (ISQ.Widget.state === ISQ.Widget.enumState.questions && ISQ.Widget.userActive && !obj.answerObject.externalSourceType)))
        {
            padding = translationIcon ? '' : '&padding-' + textAlign + ': 5px;';
            td = createTd(titleTr, '', 'top', '.answerIcon' + padding);
            //            if (obj.isFAQ)
            //                thumbIcon = nanoRep.FAQ.Likes.buildThumbUpIcon(obj.answerObject.id, td, obj.answerObject.likes, direction === 'rtl', ISQ.Cnf.cacheVar, ISQ.Widget.account, ISQ.Cnf.kbId, ISQ.Widget.isPreview, null, ISQ.Widget.referer.normal);
            //            else
            //                ISQ.Widget.Thumb.Rememberer.addIcon(td, ISQ.Widget.Query.lastQuerySent, obj.answerObject.id, obj.answerObject.keywordsetId, obj.visible, obj.answerObject.likes);
            thumbIcon = nanoRep.FAQ.Likes.buildThumbUpIcon(obj.answerObject.id, td, obj.answerObject.likes, direction === 'rtl', ISQ.Cnf.cacheVar, ISQ.Widget.account, ISQ.Cnf.kbId, ISQ.Widget.isPreview, null, ISQ.Widget.referer.normal);

        }
    }

    // Parse the actions
    if (obj.answerObject.actions)
    {
        var actions = ISQ.Data.parseJson(obj.answerObject.actions);
        var autoLink = actions.autoLink;
        // Add the autolink if the answer is visible
        if (autoLink && obj.visible)
        {
            var autoLinkTr = createRow(tbody)
            var autoLinkTd = createTd(autoLinkTr, '', 'middle', '.autoLink');
            var url = autoLink.url || '', text = autoLink.title || url;
            var allowToAbort = autoLink.hasOwnProperty('allowToAbort') ? autoLink.allowToAbort : true;

            var progressBar = createDiv(autoLinkTd, '.progressBar&.widgetBGcolor');
            createTextNode(text, createDiv(progressBar, '.progressBarText'));
            createDiv(progressBar, '.progressBarHover');
            var progressBarBG = createDiv(progressBar, '.progressBarBG');

            function openAutoLink () { ISQ.Widget.Query.openAutoLink(actions.autoLink, obj.answerObject); }

            var step;
            // Wait for `timeInSeconds` and show the progress animation in the meanwhile
            var activateAutoLink = function (timeInSeconds)
                {
                    step = 100 / (timeInSeconds * 100);
                    // If the progress bar is not the last child, that means that there is 'Cancel' button and
                    // therefore the autlink is alreay activated.
                    if (autoLinkTd.lastChild !== progressBar) return;
                    function reset(button)
                    {
                        clearInterval(intervalId);
                        progressBarBG.style.width = '0';
                        button.parentNode.removeChild(button);
                        ISQ.Widget.Query.resetAutoLink = null;
                    }
                    var intervalId = setInterval(
                        function ()
                        {
                            var width = parseFloat(progressBarBG.style.width, 10) || 0;
                            if (width < 100)
                            {
                                progressBarBG.style.width = (width + step) + '%';
                            }
                            else
                            {
                                clearInterval(intervalId);
                                if (ISQ.Widget.HTML.answerPane.contains(progressBar)) openAutoLink();
                            }
                        }, 10);
                    if (allowToAbort)
                    {
                        // A cancel button that stops the progress animation and removes itself
                        var cancelButton = createLink(
                            {
                                parent: autoLinkTd,
                                text: ISQ.Widget.getStaticText('cancel'),
                                style: '.cancel',
                                onclick: function () { reset(this); }
                            });
                        ISQ.Widget.Query.resetAutoLink = function () { reset(cancelButton); };
                    }
                };
            // Open the autolink on click
            addEvents(progressBar, 'click', openAutoLink);
            // Activate the autolink if it is located on a single anwser
            if (obj.answerObject.isSingle)
            {
                // Set the activation function, that may be used
                // to activate the autolink later via pressing enter
                ISQ.Widget.Query.activateAutoLink = activateAutoLink;
                var animTime = ISQ.Widget.Query.autoLinkAnimationTime;
                // Find out the desired speed of animation
                if (allowToAbort)
                {
                    var fast = (ISQ.Widget.Query.lastQuerySent.slice(-1) === '?' ||
                        ISQ.Widget.Query.lastQuerySource === ISQ.Widget.Query.enumTextQuerySource.suggestion);
                    activateAutoLink(fast ? animTime.fast : animTime.slow);
                }
                else
                {
                    activateAutoLink(animTime.superFast);
                }
            }
        }
    }

    var summaryTr = createRow(tbody, '.summaryRow');
    var summaryTd = createTd(summaryTr, '', 'top', '.answerBody');
    var resizeWidgetContent = false;
    summaryTd.setAttribute("tabindex", "5");

    // parsing answer
    if (summary)
    {
        var addContent = function (parentNode, stringContent)
        {
            //LIOR
            //DEBUG
            if (obj.answerObject.externalSourceType)// && ISQ.Widget.isFloat) // external source
            {
                parentNode.innerHTML = stringContent;
                parentNode.appendChild(ISQ.Export.parseExternalSourceSummary(parentNode, obj.answerObject.externalSourceType, tbody.parentNode));
                tbody.externalSource = obj.answerObject.externalSourceType;
                resizeWidgetContent = true;
            }
            else // regular answer
                parentNode.innerHTML = stringContent;


            ISQ.Widget.Query.processQuotes(parentNode, obj.answerObject.id);
        }

        // pagination
        var parts = summary.split(ISQ.Tools.pagerSeperator);
        if (parts.length > 1)
            ISQ.Widget.Query.addAnswerPager(obj.answerObject.id, parts, summaryTd, tableId, direction, addContent);
        else
            addContent(summaryTd, summary);
    }

    // if is FAQ add placeholder for contact forms.
    if(!obj.isFAQ && obj.contactFormId)
    {
		//save placeholder for current id.
        var form_placeholder_row = createRow(tbody);
        var form_placeholder_cell = createTd(form_placeholder_row,'','','.formId_' + obj.contactFormId);
    }

    // attachments
    ISQ.Widget.Query.appendAttachments(obj.answerObject.attachments, summaryTd);

    // adding answers footer (if needed, only to the last answer)
    var answerFooterScript = null;
    if (summary && (!ISQ.Cnf.showFooterOnlyOnLastAnswer || obj.answerObject.answerNum === ISQ.Widget.Query.numberOfTopics - 1))
    {
        var replacerResult = ISQ.Widget.replacePlaceholders(obj.footer, ISQ.Widget.API.getCustomParams(), "{{", "}}");
        if (replacerResult.success)
        {
            answerFooterScript = ISQ.Widget.replacePlaceholders(ISQ.Cnf.answerFooterScript, ISQ.Widget.API.getCustomParams(), "{{", "}}");
            if (answerFooterScript.success)
            {
                answerFooterScript = answerFooterScript.text;
                var answerFooterDiv = createDiv(null, ".answerFooter");
                answerFooterDiv.innerHTML = replacerResult.text || "";
                summaryTd.appendChild(answerFooterDiv);
            }
            else
                answerFooterScript = null;
        }
    }

    // showing like/dislike section in the footer of each answer
    if (!obj.isFAQ && ISQ.Widget.state === ISQ.Widget.enumState.questions && ISQ.Widget.userActive)// && !obj.answerObject.externalSourceType)
    {
        var row = createRow(tbody);
        var td = createTd(row, '', '', '');
        // containers for dislike and like in normal answers

        var likesContainer = createDiv(td, ".articlelikeContainer");
        var likeDiv = createDiv(likesContainer, ".iLike");
        var dislikeDiv = createDiv(likesContainer, ".iDontLike");

        ISQ.Widget.Thumb.Rememberer.addIcon(likeDiv, ISQ.Widget.Query.lastQuerySent, obj.answerObject.id, obj.answerObject.keywordsetId, obj.visible, obj.answerObject.likes, 'up');
        ISQ.Widget.Thumb.Rememberer.addIcon(dislikeDiv, ISQ.Widget.Query.lastQuerySent, obj.answerObject.id, obj.answerObject.keywordsetId, obj.visible, 0, 'down');
    };

    // onclick title
    if (obj.isFAQ && titleTd)
    {
        titleTd.onclick = function ()
        {
            if (summaryTr.className.indexOf('collapsed') == -1)
            {
                titleTd.className = 'answerTitle collapsed';
                summaryTr.className = 'summaryRow collapsed';
                // switching feedback in FAQ to initial mode (without dislike, next to the question)
                ISQ.Widget.FAQ.removeThumbsForFAQarticle(summaryTr);
                ISQ.Widget.HTML.dynamicSize_sendMessage();
            }
            else if (summaryTd.innerHTML)
            {
                titleTd.className = 'answerTitle expanded';
                summaryTr.className = 'summaryRow expanded';
                // switching feedback in FAQ to the bottom of the question and showing dislike icon
                if (summaryTr.likes)
                    ISQ.Widget.FAQ.BuildThumbsForFAQarticle(summaryTr.likes.results, summaryTr, summaryTr.likes.likeIcon)
                // if is worldmanuals...
                // DEBUG
                // LIOR
                if (tbody.externalSource)
                    ISQ.Export.wmWidgetSize(tbody)
                else
                    ISQ.Widget.HTML.dynamicSize_sendMessage();
            }
            else
            {
                // disable next click temporarily
                if (titleTd.clickDisabled) return;
                titleTd.clickDisabled = true;

                // request answer
                ISQ.Widget.Query.pendingRequest = true;

                _session().request(
                {
                    url: "a.js",
                    params:
                    {
                        requestId: ISQ.Widget.Query.activeRequestId,
                        answerId: obj.answerObject.id,
                        "auto": false,
                        "src": "FAQ"
                    },
                    handler: function (status, jsonObject, jsonRequest)
                    {
                        titleTd.clickDisabled = false;
                        ISQ.Widget.Query.responseHandler(status, jsonObject, jsonRequest, function (results) { ISQ.Widget.FAQ.buildAnswer(results, titleTd, thumbIcon, tbody) })
                    }
                });
            }
        }
        titleTd.summaryTr = summaryTr;
        titleTd.summaryTd = summaryTd;

        // open aswer content on enter press on FAQs within widget
        tdiv.onkeyup = function (event4ff)
        {
            var _event = ISQ.Html.getDomEvent(event4ff);

            if (_event.domEvent.keyCode == 13)
            {
                titleTd.onclick();
            }
        }
    }

    // collapsed
    if (obj.collapsed)
    {
        if (titleTd) titleTd.className = 'answerTitle collapsed';
        summaryTr.className = 'summaryRow collapsed';
    }

    // running summary and footer scripts
    if (obj.answerObject.summaryScript) eval(obj.answerObject.summaryScript);

    // answer footer script
    if (answerFooterScript && (obj.answerObject.answerNum === ISQ.Widget.Query.numberOfTopics - 1 || !ISQ.Cnf.showFooterOnlyOnLastAnswer))
        eval(answerFooterScript);

    // resizing elements
    if (summary) ISQ.Widget.Query.resizeSingleAnswerElements(summaryTd, true);

    // hide for translation
    if (!obj.visible) tbody.parentNode.style.display = 'none';

    return tbody.parentNode;
}

ISQ.Widget.Query.updateWidgetHeightWidth = function (custom)
{
    // sending height to container
    ISQ.Widget.HTML.contentWrapper.style.height = '600px';
    ISQ.Widget.HTML.contentWrapper.style.width = '800px';
    ISQ.Widget.HTML.dynamicSize_sendMessage(false, ISQ.Widget.isFloat);
}

ISQ.Widget.Query.addAnswerPager = function (answerId, parts, summaryTd, tableId, direction, hContentDrawing)
{
    var pagedDivs = [];
    ISQ.Widget.HTML.answerPane.style.display = 'block';
    var width = ISQ.CSS.getElementWidth(summaryTd, false);
    ISQ.Widget.HTML.answerPane.style.display = 'none';

    // rtl - browsers report different scrollLeft values!
    var rtl = direction === "rtl";
    var ff = ISQ.Http.browser.app === 'ff';
    var webkit = ISQ.Http.browser.app === 'chrome' || ISQ.Http.browser.app === 'safari' || (ISQ.Http.browser.isMobile && !ff) || ISQ.Http.browser.isIE7;

    var container = createDiv(summaryTd, '.pagedContainer');
    container.style.width = width + 'px';
    var table = createTable(container, parts.length * width + 'px', '', 'table-layout:fixed;direction:inherit;');
    var tr = createRow(table, 'top');
    var div;

    // pager clicked function
    var pagerClicked = function (idx)
    {
        pagedDivs[idx].style.height = 'auto';

        // reporting the event
        if (ISQ.Widget.reportEvents)
            ISQ.Widget.CDC.sendMessage("subject=event&type=answerPageChanged&answerid=" + answerId + "&page=" + (idx + 1));

        // scroll page into view
        scrollTo(pagedDivs[idx].offset, 0, function ()
        {
            // restore heights
            for (var j = 0; j < pagedDivs.length; j++)
            {
                if (j !== idx) pagedDivs[j].style.height = 0;
            }

            // resize
            ISQ.Widget.HTML.dynamicSize_sendMessage();

            // save scroll pos for IE (#7299) and mobiles (#7802)
            if (ISQ.Http.browser.isMobile || ISQ.Http.browser.isIE)
            {
                var scrollLeft = container.scrollLeft;
                ISQ.Widget.HTML.answerPane.restorePagerScroll = function ()
                {
                    try
                    {
                        container.scrollLeft = scrollLeft;
                    }
                    catch (e) { }
                }
            }
        });
        ISQ.Widget.HTML.contentWrapper.scrollTop = 0;

        // show/hide the other answers
        var answerTables = ISQ.Widget.HTML.answerPane.childNodes;
        for (var i = 0; i < answerTables.length; i++)
        {
            if (!answerTables[i].id.startsWith(tableId))
            {
                answerTables[i].style.display = (idx == 0 && answerTables[i].id.indexOf('true') > -1 ? 'inline-table' : 'none');
            }
        }

        // resize
        ISQ.Widget.HTML.dynamicSize_sendMessage();
    }

    // find next/prev links color
    //#region next/prev links color
    var bgColor = null;
    var node = ISQ.Widget.HTML.answerPane;
    do
    {
        bgColor = ISQ.CSS.getValue(node, 'background-color');
        node = node.parentNode;
    }
    while (!bgColor && node !== document.body)
    if (!bgColor) bgColor = '#FFF';

    // create css dynamically
    ISQ.CSS.addNewStyle('.answerTable .pagerLink.next, .answerTable .pagerLink.prev {display:block; color: ' + bgColor + '}');

    //#endregion

    // create paged tds
    var buildPaging = function ()
    {
        for (var i = 0; i < parts.length; i++)
        {
            td = createTd(tr);
            div = createDiv(td, 'width:100%');

            // add pager
            var pager = new ISQ.GUI.Pagination(
            {
                page: i,
                pageSize: 1,
                total: parts.length,
                clickHandler: new ISQ.Handler(pagerClicked),
                next: ISQ.Widget.Localize.array["next"],
                prev: ISQ.Widget.Localize.array["prev"]
            });

            //createDiv(div).innerHTML = parts[i];
            // ouside handler responsible on adding the content
            hContentDrawing(createDiv(div), parts[i]);

            td.style.width = width + 'px';
            if (i > 0) div.style.height = 0;
            pagedDivs[i] = div;

            // set page scroll offset
            if (rtl && webkit)
                div.offset = width * (parts.length - i - 1);
            else
                div.offset = width * i;

            // draw pager
            pager.draw(createDiv(div, '.pager'));
        }
    }

    if (ISQ.GUI.Pagination)
        buildPaging();
    else
        ISQ.Tools.FileLoader.load("/common/GUI/pagination.js", new ISQ.Handler(function (tag)
        {
            buildPaging();
        }), this);

    // smooth scrolling function
    var fastest = 70, slowest = 3, speedFraction = 7;

    var scrollTo = function (x, state, handler)
    {
        var scrollLeft = Math.abs(container.scrollLeft); // FF reports negative values in rtl mode
        x = Math.abs(x);

        // scroll speed (fastest when it's farthest away, slowest when nearest)
        var diff = Math.abs(scrollLeft - x);
        if (diff > slowest) delta = Math.min(fastest, Math.max(Math.floor(diff / speedFraction), slowest));
        else delta = 1;

        switch (state)
        {
            // all done
            case -1:
                handler();
                return;

                // start here
            case 0:
                if (x > scrollLeft)
                {
                    state = 1;
                }
                else
                {
                    if (!(rtl && ff))
                        delta *= -1;
                    state = 2;
                }
                break;

            // scroll right
            case 1:
                if (x <= scrollLeft)
                {
                    delta = 0;
                    state = -1;
                }
                else if (rtl && ff)
                {
                    delta *= -1;
                }
                break;

            // scroll left
            case 2:
                if (x < scrollLeft)
                {
                    if (!(rtl && ff))
                        delta *= -1;
                }
                else
                {
                    delta = 0;
                    state = -1;
                }
                break;
        }

        // scroll
        if (delta != 0) container.scrollLeft += delta;

        setTimeout(function () { scrollTo(x, state, handler) }, 10);
    }
}

ISQ.Widget.Query.contentWrapperScroll = function ()
{
    var i = 0;
    if (!ISQ.Widget.Query.currentAnswers) return;

    iteration(ISQ.Widget.Query.currentAnswers, function (answerObj)
    {
        var top;
        var peekElement = answerObj.peekElement;
        var tableTop = ISQ.Html.position(answerObj.answerTable).y;
        var isAbove = tableTop < ISQ.Widget.HTML.contentWrapper.scrollTop + ISQ.Widget.HTML.contentWrapper.offsetTop;
        var isBelow = tableTop > ISQ.Widget.HTML.contentWrapper.scrollTop + ISQ.Widget.HTML.contentWrapper.offsetHeight;

        if (isAbove || isBelow)
        {
            if (!peekElement)
            {
                // create peek element
                peekElement = createDiv(ISQ.Widget.HTML.answerPane, '.answerPeek');
                peekElement.onclick = function () { ISQ.Widget.Query.scrollToElement(answerObj.answerTable) }
                answerObj.peekElement = peekElement;

                // set width
                ISQ.CSS.setWidthIncludingPadding(peekElement, ISQ.Widget.HTML.answerPane.offsetWidth - ISQ.CSS.getPaddingWidth(ISQ.Widget.HTML.answerPane));
            }

            // set top
            if (isAbove)
            {
                top = ISQ.Widget.HTML.contentWrapper.offsetTop + (i * ISQ.Widget.Query.peekElementHeight) + 2;
                peekElement.innerHTML = '&#9650; ' + answerObj.title;
            }
            else
            {
                top = ISQ.Widget.HTML.contentWrapper.offsetTop + ISQ.Widget.HTML.contentWrapper.offsetHeight - ((3 - i) * ISQ.Widget.Query.peekElementHeight) + 2;
                peekElement.innerHTML = '&#9660; ' + answerObj.title;
            }

            peekElement.style.top = top + 'px';
            peekElement.style.display = 'block';
        }
        else if (peekElement)
        {
            peekElement.style.display = 'none';
        }

        i++;
    });
}

ISQ.Widget.Query.scrollToElement = function (element)
{
    var elementTop = ISQ.Html.position(element).y - ISQ.Widget.HTML.contentWrapper.offsetTop;
    var isAbove = elementTop < ISQ.Widget.HTML.contentWrapper.scrollTop;
    var isBelow = elementTop > ISQ.Widget.HTML.contentWrapper.scrollTop + 30;

    if (!isAbove && !isBelow)
    {
        if (ISQ.Widget.Query.scrollInterval)
        {
            clearInterval(ISQ.Widget.Query.scrollInterval);
            ISQ.Widget.Query.scrollInterval = null;
        }
        return;
    }

    if (!ISQ.Widget.Query.scrollInterval)
    {
        ISQ.Widget.Query.scrollInterval = setInterval(function () { ISQ.Widget.Query.scrollToElement(element) }, 1);
        return;
    }

    if (isBelow)
        ISQ.Widget.HTML.contentWrapper.scrollTop += 10;
    else
        ISQ.Widget.HTML.contentWrapper.scrollTop -= 10;
}
ISQ.Widget.Query.appendAttachments = function (attachments, container)
{
    if (!attachments) return;

    var ulObj = createElement("ul", null, ".attachments");
    var att = attachments.split(',');
    for (var i = 0; i < att.length; i++)
    {
        var liObj = createElement("li");
        ISQ.Widget.Query.buildAttachmentLink(att[i], liObj);
        ulObj.appendChild(liObj);
    }
    container.appendChild(ulObj);
}
ISQ.Widget.Query.buildAttachmentLink = function (url, liObj)
{
    var pos = url.indexOf("/"); // filename contains bucket
    if (pos == -1) return;

    var summaryBuilder = [];
    summaryBuilder.push('<a href="');
    summaryBuilder.push("http://");
    summaryBuilder.push(url.substring(0, pos));
    summaryBuilder.push(".s3.amazonaws.com/");
    summaryBuilder.push(url.substring(pos + 1));
    summaryBuilder.push('" target="_blank">');
    ISQ.Data.breakWords(url.substring(url.lastIndexOf('/') + 1), summaryBuilder);
    summaryBuilder.push("</a>");
    liObj.innerHTML = summaryBuilder.join('');
}

// if the current user's query is in a different language from kb's language
// and answers should be translated
ISQ.Widget.Query.toTranslateContent = function (compareWithLanguage, detectedLanguage)
{
    if (!ISQ.Cnf.translationEnabled || ISQ.Cnf.translationDetectionOnly) return false;
    if (!ISQ.Widget.TranslationHelper.languageEnabled) return false;
    if (ISQ.Widget.Suggestions.clicked)
    {
        ISQ.Widget.Suggestions.clicked = false;
        return false;
    }

    if (!detectedLanguage) detectedLanguage = ISQ.Tools.getUniformLanguageCode(ISQ.Widget.TranslationHelper.detectedLanguage);
    if (!detectedLanguage) return false;

    var cmpLang = ISQ.Tools.getUniformLanguageCode(compareWithLanguage);
    return detectedLanguage != cmpLang;
}

ISQ.Widget.Query.getFader = function ()
{
    if (ISQ.Widget.Query.fader === null)
    {
        ISQ.Widget.Query.fader = new VisualEffects.Fade(ISQ.Widget.HTML.answerPane);
        ISQ.Widget.Query.fader.fadeOutEvent.addHandler(ISQ.Widget.Query.fader_fadeOutHandler);
        ISQ.Widget.Query.fader.fadeInEvent.addHandler(ISQ.Widget.Query.fader_fadeInHandler);
    }
    return ISQ.Widget.Query.fader;
}

ISQ.Widget.Query.displayAnswers = function (noActionBar)
{
    var chatAvailable = (ISQ.Widget.iChat.instance && ISQ.Widget.iChat.instance.available()) || (ISQ.Cnf.customEscalationLink && ISQ.Cnf.customEscalationLink_Action === ISQ.Widget.enumCustomLinkStats.countChatEscalation);

    // build chat invitation
    if (ISQ.Widget.state !== ISQ.Widget.enumState.autoQuestions && ISQ.Widget.Query.chatInviteContent && ISQ.Widget.Query.chatEscalationAction == ISQ.Widget.enumChatEscalationActions.inviteChat && chatAvailable)
    {
        var chatInviteDiv = createDiv(null, '.chatInviteDiv');
        chatInviteDiv.innerHTML = ISQ.Widget.Query.chatInviteContent;
        ISQ.Widget.HTML.answerPane.insertBefore(chatInviteDiv, ISQ.Widget.HTML.answerPane.firstChild);
        ISQ.Widget.Query.chatInviteContent = null;

        if (ISQ.Widget.iChat.instance && ISQ.Widget.iChat.instance.available()) // integrated chat
            chatInviteDiv.onclick = function () { ISQ.Widget.Chat.requestChat(ISQ.Widget.enumChatEscalationActions.inviteChat); };
        else // custom chat
            chatInviteDiv.onclick = function ()
            {
                chatInviteDiv.style.display = 'none';
                ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.customChat, ISQ.Widget.enumChatEscalationActions.inviteChat);
            }
    }

    // showing query's action bar
    if (!noActionBar && ISQ.Widget.state !== ISQ.Widget.enumState.autoQuestions && ISQ.Widget.userActive)
        ISQ.Widget.Query.showActionBar();

    ISQ.Widget.HTML.answerPane.style.display = 'block';

    // scrolling to top of question
    if (ISQ.Http.browser.full !== "safari3")
        ISQ.Widget.HTML.contentWrapper.scrollTop = 0;

    // sending dynamic message
    ISQ.Widget.HTML.dynamicSize_sendMessage();

    if (ISQ.Widget.HTML.canPerformFade(ISQ.Widget.HTML.answerPane))
    {
        var fader = ISQ.Widget.Query.getFader();
        fader.fadeIn(200, true);
    }
    else
    {
        ISQ.Widget.Query.fader_fadeInHandler();
    }



    // resizing answer elements
    ISQ.Widget.Query.resizeAnswerElements();
};

ISQ.Widget.Query.showActionBar = function ()
{
    var emalBtn = null;
    var chatBtn = null;
    var customLink = null;

    ///
    // #region setting email btn
    if (ISQ.Cnf.customEscalationLink && ISQ.Cnf.customEscalationLink_Action !== ISQ.Widget.enumCustomLinkStats.countChatEscalation)
        emalBtn = customLink = _('customLink');
    else
        emalBtn = _('repByEmail');
    emalBtn.innerHTML = ISQ.Widget.getStaticText("email");
    emalBtn.setAttribute("tabindex", "6");
    // #endregion

    // #region setting chat btn
    var showChatBtn = false;
    switch (ISQ.Cnf.showChatConfiguration)
    {
        case ISQ.Widget.enumShowChatConfiguration.always:
            showChatBtn = ISQ.Widget.Query.chatEscalationAction > ISQ.Widget.enumChatEscalationActions.hide;
            break;
        case ISQ.Widget.enumShowChatConfiguration.selectedAnswers:
            showChatBtn = ISQ.Widget.Query.chatEscalationAction > ISQ.Widget.enumChatEscalationActions.normal;
            break;
        case ISQ.Widget.enumShowChatConfiguration.selectedAnswers_and_noAnswers:
            showChatBtn = ISQ.Widget.Query.chatEscalationAction > ISQ.Widget.enumChatEscalationActions.normal || ISQ.Widget.Query.firstAnswerId === -1;
            break;
    }

    if (showChatBtn)
    {
        if (ISQ.Cnf.customEscalationLink && ISQ.Cnf.customEscalationLink_Action === ISQ.Widget.enumCustomLinkStats.countChatEscalation)
            chatBtn = customLink = _('customChat');
        else if (ISQ.Widget.iChat.instance && ISQ.Widget.iChat.instance.available()) // integrated chat
            chatBtn = _('repByChat');
        if (chatBtn)
        {
            chatBtn.innerHTML = ISQ.Widget.getStaticText("chat");
            chatBtn.setAttribute("tabindex", "7");
        }
    }
    // #endregion

    // #region setting custom link href
    if (customLink)
    {
        customLink.href = ISQ.Widget.Query.buildCustomLink(ISQ.Cnf.customEscalationLink);
        ISQ.Widget.Query.switchLinkTarget(customLink, ISQ.Cnf.customEscalationLink_target);

    }
    //#endregion

    // #region showing buttons
    _('customLink').style.display = 'none';
    _('repByEmail').style.display = 'none';
    _('customChat').style.display = 'none';
    _('repByChat').style.display = 'none';
    _('actionBarSep').style.display = 'none';

    // showing only context selection dialog
    if (ISQ.Widget.Query.numberOfTopics && ISQ.Widget.Query.contextOnlyAnswers === ISQ.Widget.Query.numberOfTopics)
	{
		ISQ.Widget.HTML.hideActionBar(); // hiding action bar is about to be viewed
		return;
	}


    // showing chat btn
    if (chatBtn)
    {
        chatBtn.style.display = 'block';
        if (ISQ.Widget.Chat.chatConfig.showEmailButton)
        {
            _('actionBarSep').style.display = 'block';
            emalBtn.style.display = 'block'; // showing email btn
        }
    }
    else // showing email btn
    {
        emalBtn.style.display = 'block';
    }
    //#endregion

    /////////////////////////////////////////
    // RECHANNELS

    // clearing previous nodes
    for (var i = 0; i < ISQ.Widget.HTML.actionBarQuery.childNodes.length; ++i)
    {
        var item = ISQ.Widget.HTML.actionBarQuery.childNodes[i];
        if (item.rechannel !== 'true') continue;
        ISQ.Widget.HTML.actionBarQuery.removeChild(item);
        --i;
    }
    var chatRechanneling = false;

    // adding
    if (ISQ.Widget.Query.rechannelingOptions)
    {
        _it(ISQ.Widget.Query.rechannelingOptions, function (channelObj)
        {
            var channel = parseInt(channelObj.channel);

            if(!channelObj.showInArticle)
            {
                switch (channel)
                {
                    case ISQ.Widget.Escalate.enumType.clickToCall:
                        // adding separator
                        var sep = _('actionBarSep').cloneNode();
                        sep.rechannel = "true";
                        sep.id = '';
                        sep.style.display = 'block';
                        sep.innerHTML = _('actionBarSep').innerHTML;
                        ISQ.Widget.HTML.actionBarQuery.appendChild(sep);

                        // adding button
                        var node = _('repByEmail').cloneNode();
                        node.className = "repByVoice";
                        node.id = "repByVoice";
                        node.rechannel = "true";
                        node.style.display = 'block';
                        node.innerHTML = channelObj.buttonText;
                        node.href = "javascript: void(0)";
                        node.clicked = false;
                        switch(channelObj.actionEsc)
                        {
                            // if custom script open link.
                            case ISQ.Widget.Escalate.escaeTypeEnum.customUrl:
                                node.onclick = function () { return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.clickToCall, null, null, channelObj.name, channelObj,node); };
                                break;
                            // if custom script. run the code.
                            case ISQ.Widget.Escalate.escaeTypeEnum.customScript:

                                if (!ISQ.Widget.sendingCDCMessages)
                                    node.style.display = "none";
                                else
                                    node.onclick = function ()
                                    {
                                        ISQ.Widget.API.runPageScript(channelObj.scriptContent);
                                        return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.clickToCall, null, null, channelObj.name,null,null,true);
                                    };
                                break;
                            //open call screen
                            case ISQ.Widget.Escalate.escaeTypeEnum.normal:
                            default:
                                node.onclick = function ()
                                {
                                    // setting overlay
                                    var overlay = _('phoneNumberOverlay');

                                    var phoneNumber = document.querySelector('#phoneNumberOverlay .phoneNumber');
                                    var phoneDetails = document.querySelector('#phoneNumberOverlay .phoneDetails');

                                    phoneNumber.innerHTML = channelObj.phoneNumber;
                                    phoneNumber.target = '_blank';
                                    //phoneNumber.href = "tel:" + channelObj.phoneNumber;

                                    phoneDetails.innerHTML = channelObj.customContent.replace(/\n/g, "<br/>");

                                    ISQ.Widget.HTML.showOverlay(overlay);

                                    // updating widget's height
                                    ISQ.Widget.HTML.dynamicSize_sendMessage();

                                    // reporting escalation
                                    if (node.clicked == 'true') return;
                                    node.clicked = 'true';
                                    return ISQ.Widget.Escalate.send(channel, null, null, channelObj.name);
                                }
                                break;

                        }

                        ISQ.Widget.HTML.actionBarQuery.appendChild(node);
                        break;
                    case ISQ.Widget.Escalate.enumType.customEmail:
                        // adding separator
                        var sep = _('actionBarSep').cloneNode();
                        sep.rechannel = "true";
                        sep.id = '';
                        sep.style.display = 'block';
                        sep.innerHTML = _('actionBarSep').innerHTML;
                        ISQ.Widget.HTML.actionBarQuery.appendChild(sep);
                        var node = _('repByEmail').cloneNode();
                        node.id = "repByEmailRech";
                        node.rechannel = "true";
                        node.style.display = 'block';
                        node.innerHTML = channelObj.buttonText;

                        if (channelObj.contactForms)
                            node.onclick = function () { return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.email, null, null, channelObj.name, channelObj); };
                        if (channelObj.linkUrl && channelObj.actionEsc == ISQ.Widget.Escalate.escaeTypeEnum.customUrl)
                        {

                            node.onclick = function () { return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.customEmail, null, null, channelObj.name, channelObj,node); };

                        }
                        if(channelObj.scriptContent && channelObj.actionEsc == ISQ.Widget.Escalate.escaeTypeEnum.customScript)
                        {
                            if (!ISQ.Widget.sendingCDCMessages)
                                node.style.display = "none";
                            else
                                node.onclick = function ()
                                {
                                    ISQ.Widget.API.runPageScript(channelObj.scriptContent);
                                    return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.customEmail, null, null, channelObj.name,null,null,true);
                                };
                        }

                        ISQ.Widget.HTML.actionBarQuery.appendChild(node);
                        break;
                    case ISQ.Widget.Escalate.enumType.chat:
                        chatRechanneling = true;
                        var node = _('repByChat').cloneNode();
                        node.id = "repByChatRech";
                        node.rechannel = "true";


                        node.innerHTML = channelObj.buttonText;

                        //if custom url send info
                        switch(channelObj.actionEsc)
                        {
                            // if custom script open link.
                            case ISQ.Widget.Escalate.escaeTypeEnum.customUrl:
                                node.style.display = "block";
                                node.onclick = function () { return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.customChat, null, null, channelObj.name, channelObj,node); };
                                break;
                            // if custom script. run the code.
                            case ISQ.Widget.Escalate.escaeTypeEnum.customScript:
                                if (ISQ.Widget.sendingCDCMessages)
                                {
                                    node.style.display = "block";
                                    node.onclick = function ()
                                    {
                                        ISQ.Widget.API.runPageScript(channelObj.scriptContent);
                                        return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.customChat, null, null, channelObj.name,null,null,true);
                                    };
                                }
                                break;
                            //open call screen
                            case ISQ.Widget.Escalate.escaeTypeEnum.normal:
                            default:
                                node.style.display = "none";
                                _('repByChat').style.display = "none";
                                var chatConfig = eval("(" + ISQ.Cnf.chatConfiguration + ")");

                                if (chatConfig) {
                                    ISQ.Widget.HTML.chatProviderChanged = true;
                                    chatConfig.active = channelObj.chatProvider;
                                    if (!chatConfig[channelObj.chatProvider])
                                        chatConfig[channelObj.chatProvider] = {};
                                    chatConfig[channelObj.chatProvider].id = channelObj.accountNum;
                                    if (channelObj.engagementId)
                                        chatConfig[channelObj.chatProvider].engagementId = channelObj.engagementId;
                                    if (channelObj.hostName)
                                        chatConfig[channelObj.chatProvider].hostName = channelObj.hostName;
                                    if (channelObj.buttonId)
                                        chatConfig[channelObj.chatProvider].buttonId = channelObj.buttonId;
                                    if (channelObj.deploymentId)
                                        chatConfig[channelObj.chatProvider].deploymentId = channelObj.deploymentId;
                                    if (channelObj.organizationId)
                                        chatConfig[channelObj.chatProvider].organizationId = channelObj.organizationId;
                                    if (channelObj.agentSkill)
                                        chatConfig.skill = channelObj.agentSkill;
                                    if (channelObj.initStatus)
                                        chatConfig.initialStatus = channelObj.initStatus;
                                    chatConfig.popup.enabled = channelObj.isPopup;
                                    if (channelObj.popupSize)
                                        chatConfig.popup.size = channelObj.popupSize.split(",");
                                    chatConfig.postChat = channelObj.postChat;
                                    chatConfig.preChat = channelObj.preChat;
                                    chatConfig.hideSendToEmail = channelObj.hideSendToEmail;
                                    ISQ.Widget.Chat.init(chatConfig, false, channelObj);
                                }
                                break;
                        }
                        ISQ.Widget.HTML.actionBarQuery.appendChild(node);
                        break;
                }
            }
        });

    }
    if (ISQ.Widget.HTML.chatProviderChanged && !chatRechanneling)
    {
        ISQ.Widget.HTML.chatProviderChanged = false;

        // disposing temp instance
        if (ISQ.Widget.iChat.instance !== ISQ.Widget.iChat.defaultInstance)
            ISQ.Widget.iChat.instance.dispose();

        ISQ.Widget.iChat.instance = ISQ.Widget.iChat.defaultInstance; // active is the default
        ISQ.Widget.Chat.init(null, true);
    }

    ISQ.Widget.HTML.showActionBar();
    if (ISQ.Widget.HTML.pendingShowActionBar) return; // widget is resizing


    // auto-ellipsis ask a rep text
    var actionBarText = _('actionBarText');
    actionBarText.innerHTML = '';

    // calculate available width for ask a rep
    var width = ISQ.Widget.HTML.actionBarQuery.offsetWidth;
    var paddingLeft = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.actionBarQuery, 'padding-left');
    if (paddingLeft)
        width -= parseInt(paddingLeft);
    var paddingRight = ISQ.CSS.getElementStyle(ISQ.Widget.HTML.actionBarQuery, 'padding-right');
    if (paddingRight)
        width -= parseInt(paddingRight);
    var marginLeft = ISQ.CSS.getElementStyle(actionBarText, 'margin-left');
    if (marginLeft)
        width -= parseInt(marginLeft);
    var marginRight = ISQ.CSS.getElementStyle(actionBarText, 'margin-right');
    if (marginRight)
        width -= parseInt(marginRight);
    width = width - _('repByEmail').offsetWidth - _('actionBarSep').offsetWidth - _('repByChat').offsetWidth;

    var text = ISQ.Cnf.customAskRepByText || ISQ.Widget.getStaticText("askBy");
    ISQ.Data.autoEllipseText(text, width, actionBarText, null, null, '#actionBarWrapper');

    //////////////////////////////////////////////////////////////////////////////////////////
    // auto ellipsis rechanneling
    var actionBarWidth = ISQ.Widget.HTML.actionBarWrapper.offsetWidth - 10;
    var totalWidth = 0;
    for (var i = 0; i < ISQ.Widget.HTML.actionBarQuery.childNodes.length; ++i)
    {
        var item = ISQ.Widget.HTML.actionBarQuery.childNodes[i];
        if (item.offsetWidth) totalWidth += item.offsetWidth;
    }
    if (totalWidth > actionBarWidth)
    {
        for (var i = 0; i < ISQ.Widget.HTML.actionBarQuery.childNodes.length && totalWidth > actionBarWidth; ++i)
        {
            var item = ISQ.Widget.HTML.actionBarQuery.childNodes[i];
            if (item.rechannel != "true") continue;
            if (item.nodeName != "A") continue;
            totalWidth -= item.offsetWidth;
            totalWidth += 24; // adding minimum width
            if (totalWidth >= actionBarWidth) // setting minimum width
                item.style.width = "24px";
            else // (totalWidth < width)
            {
                var itemWidth = actionBarWidth - totalWidth - 25;  // 25: padding and margin of the link
                totalWidth += itemWidth; // adding minimum width
                item.style.width = (itemWidth + 24) + "px";
                item.style.whiteSpace = 'nowrap';
                item.style.textOverflow = 'ellipsis';
                item.style.overflow = 'hidden';
            }
        }
    }

    // start chat (push) if required
    var chatAvailable = (ISQ.Widget.iChat.instance && ISQ.Widget.iChat.instance.available()) || (ISQ.Cnf.customEscalationLink && ISQ.Cnf.customEscalationLink_Action === ISQ.Widget.enumCustomLinkStats.countChatEscalation);

    if (chatAvailable && ISQ.Widget.state === ISQ.Widget.enumState.questions &&
        ISQ.Widget.Query.chatEscalationAction == ISQ.Widget.enumChatEscalationActions.pushChat && !ISQ.Widget.Query.chatPushAnswers.pushed)
    {
        ISQ.Widget.Query.chatPushAnswers.pushed = true;

        if (ISQ.Widget.iChat.instance && ISQ.Widget.iChat.instance.available()) // integrated chat
            ISQ.Widget.Chat.requestChat(ISQ.Widget.enumChatEscalationActions.pushChat);
        else
            ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.customChat, ISQ.Widget.enumChatEscalationActions.pushChat);
    }


}
ISQ.Widget.Query.switchLinkTarget = function(elem, type)
{
    switch (type)
    {
        case ISQ.Widget.enumCustomLinkTarget.CurrentPage:
            elem.target = '_top';
            break;
        case ISQ.Widget.enumCustomLinkTarget.NewTab:
            elem.target = '_blank';
            break;
        case ISQ.Widget.enumCustomLinkTarget.Popup:
            // the window.open is in Escalate.send()
            elem.target = '_blank';
            break;
        case ISQ.Widget.enumCustomLinkTarget.Widget:
            elem.target = '_self';
            break;
        default:
            elem.target = '_blank';
            break;
    }
}
ISQ.Widget.Query.buildCustomLink = function (url)
{
	// make some replacements in the link url
    var str = url.replace('{QUERY}', encodeURIComponent(_query(true)));

    // replace custom params with their values
    var customParams = nanoRep.Widget.API.getCustomParams();
    for (var i in customParams)
    {
        str = str.replace('{' + i + '}', encodeURIComponent(customParams[i]));
        // #10136: if value starts with !, don't url encode.
        str = str.replace('{!' + i + '}', customParams[i]);
    }

    // custom params
    var context = _session().contexts();
    if (context)
    {
        for (var i in context)
        {
            var x = new RegExp('{' + i + '}', "gi");

			str = str.replace(x, encodeURIComponent(context[i]));
            // #10136: if value starts with !, don't url encode.
            str = str.replace(x, context[i]);
        }
    }

    // replace unused params
    str = str.replace(/\{.*?\}/g, '');

    return str;
}

ISQ.Widget.Query.hideAnswers = function (newAnswersXml, clearAnswers)
{
    // saving xml
    ISQ.Widget.Query.fader_clearAnswers = clearAnswers;
    ISQ.Widget.Query.fader_tempXml = newAnswersXml;

    // Drop the autolink activating function
    if (clearAnswers) ISQ.Widget.Query.activateAutoLink = null;

    // setting faq shown flag
    ISQ.Widget.FAQ.shown = false;

    if (ISQ.Widget.HTML.canPerformFade(ISQ.Widget.HTML.answerPane))
    {
        var fader = ISQ.Widget.Query.getFader();
        // fading out and showing answers
        fader.fadeOut(200);
    }
    else
    {
        ISQ.Widget.Query.fader_fadeOutHandler();
    }

    // hide translation tooltip
    if (ISQ.Cnf.translationEnabled)
        ISQ.Widget.Translation.toggleTranslationTooltip(null, false);
}

ISQ.Widget.Query.resizeSingleAnswerElements = function (containerElement, addToArray, resizeToWidth)
{
    if (resizeToWidth) ISQ.Widget.Query.resizeToWidth = resizeToWidth; // requesting to set to specific width
    else ISQ.Widget.Query.resizeToWidth = 0;

    for (var i = 0; i < ISQ.Widget.Query.resizeableTags.length; ++i)
    {
        var elems = containerElement.getElementsByTagName(ISQ.Widget.Query.resizeableTags[i]);
        for (var j = 0; j < elems.length; ++j)
        {
            // registering onload event for image
            if (ISQ.Widget.Query.resizeableTags[i] === "IMG")
            {
				if (elems[j].complete)
				{
					elems[j].setAttribute('loaded', 'true');
					elems[j].loaded = true;
				}
				else
				{
					elems[j].style.visibility = 'hidden';
					elems[j].onload = function ()
					{
						this.loaded = true;
						this.setAttribute("loaded", "true");
						this.style.visibility = 'visible';

						if (ISQ.Widget.HTML.isTeaser) return;
						if (ISQ.Widget.HTML.currentlyResizing) return;
						ISQ.Widget.Query.resizeAnswerElement(this);
					};
				}
            }

            // applying resize (not in teaser mode)
            if (!ISQ.Widget.HTML.isTeaser)
                ISQ.Widget.Query.resizeAnswerElement(elems[j]);

            // adding to array
            if (addToArray)
            {
                if (!ISQ.Widget.Query.elementsToResize) ISQ.Widget.Query.elementsToResize = new Array();
                ISQ.Widget.Query.elementsToResize.push(elems[j]);
            }
        }
    }
}
ISQ.Widget.Query.resizeAnswerElements = function ()
{
    if (ISQ.Widget.HTML.isTeaser) return;
    if (ISQ.Widget.HTML.currentlyResizing) return;

    // width to resize to
    if (!ISQ.Widget.Query.resizeToWidth)
    {
        // getting answer pane width
        var w = ISQ.CSS.getElementWidth(ISQ.Widget.HTML.answerPane) - ISQ.CSS.getPaddingWidth(ISQ.Widget.HTML.answerPane);
        ISQ.Widget.Query.resizeToWidth = w;
    }

    // setting new width and resizing elements
    if (!ISQ.Widget.Query.elementsToResize) return;
    for (var i = 0; i < ISQ.Widget.Query.elementsToResize.length; ++i)
        ISQ.Widget.Query.resizeAnswerElement(ISQ.Widget.Query.elementsToResize[i]);
}
ISQ.Widget.Query.resizeAnswerElement = function (elem)
{
    // not handling a case which 'ISQ.Widget.Query.resizeToWidth' <= 0
    // (the widget is in auto question mode or before showing the first answers)
    if (ISQ.Widget.Query.resizeToWidth <= 0) return;

    // not resizing an image before it loads
    if (elem.nodeName === "IMG")
    {
        var loaded = elem.getAttribute("loaded") === "true";
        if (!loaded && !elem.loaded) return;
    }

    // sending set-size message for dynamic
    ISQ.Widget.HTML.dynamicSize_sendMessage();

    //////////////////////////////////////////////////////////////////////////
    // not resizing if last-resize-width hasn't changed
    var lastResizeWidth = parseInt(elem.getAttribute("lastResizeWidth"));
    if (!isNaN(lastResizeWidth))
    {
        if (lastResizeWidth === ISQ.Widget.Query.resizeToWidth) return;
    }
    else
    {
        if (elem.lastResizeWidth === ISQ.Widget.Query.resizeToWidth) return;
    }
    elem.lastResizeWidth = ISQ.Widget.Query.resizeToWidth;
    elem.setAttribute("lastResizeWidth", ISQ.Widget.Query.resizeToWidth);

    var changed = elem.getAttribute("widthChanged") === 'true';

    // offset width
    var width = elem.offsetWidth;
    if (width === 0) return;
    if (width > ISQ.Widget.Query.resizeToWidth || changed)
    {
        // getting ratio
        var _ratio = elem.getAttribute("_ratio");
        if (!_ratio)
        {
            var height = elem.offsetHeight;
            _ratio = height / width;
            elem.setAttribute("_ratio", _ratio);
        }
        else
        {
            _ratio = parseFloat(_ratio);
        }

        // original width
        var origWidth = elem.getAttribute("originalWidth");
        if (!origWidth)
        {
            origWidth = width;
            elem.setAttribute("originalWidth", origWidth);
        }
        else
        {
            origWidth = parseFloat(origWidth);
        }

        var newWidth = ISQ.Widget.Query.resizeToWidth - 5;
        if (newWidth > origWidth) newWidth = origWidth;
        var newHeight = parseInt(_ratio * newWidth);

        // resizing element
        elem.style.width = newWidth + "px";
        elem.style.height = newHeight + "px";
        elem.setAttribute("widthChanged", 'true');
        elem.setAttribute("width", newWidth + "px");
        elem.setAttribute("height", newHeight + "px");
    }
}

// #region FADER
ISQ.Widget.Query.fader_clearAnswers = false;
ISQ.Widget.Query.fader_tempXml = null;
ISQ.Widget.Query.fader_callback = null;
ISQ.Widget.Query.fader_fadeOutHandler = function ()
{
    // clearing answers
    if (ISQ.Widget.Query.fader_clearAnswers)
    {
        clearNode(ISQ.Widget.HTML.answerPane);
    }
    else
    {
        ISQ.Widget.HTML.answerPane.style.display = 'none';
        ISQ.Widget.HTML.dynamicSize_sendMessage();
    }

    ISQ.Widget.Query.fader_clearAnswers = false;

    // resetting first received answer
    ISQ.Widget.Query.firstAnswerId = -1;

    // if received answers, calling parser
    if (ISQ.Widget.Query.fader_tempXml)
    {
        ISQ.Widget.Query.processAnswers(ISQ.Widget.Query.fader_tempXml);
        ISQ.Widget.Query.fader_tempXml = null;
    }

    // if callback required, do it
    if (typeof (ISQ.Widget.Query.fader_callback) === 'function')
    {
        ISQ.Widget.Query.fader_callback();
        ISQ.Widget.Query.fader_callback = null;
    }
};
ISQ.Widget.Query.fader_fadeInHandler = function ()
{
    // hiding search animation
    ISQ.Widget.HTML.contentFader.hide();
    ISQ.Widget.HTML.clearQuery.show();

    // fixing answer widths for IE6,7
    ISQ.Widget.HTML.fixContentWidths();

    // processing auto questions
    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions)
        ISQ.Widget.AutoQuestions.showNext();

    // show answer 'peeks'
    if (ISQ.Cnf.answerPeeksEnabled) ISQ.Widget.Query.contentWrapperScroll();
};
// #endregion


//#endregion

/********************************************************
////////////////// [ STATIC TEXT ] //////////////////////
********************************************************/
// #region static text
ISQ.Widget.getText = function (key)
{
    var v = ISQ.Widget.Localize.array[key];
    if (!v && ISQ.Widget.TranslationHelper.detectedLanguage)
    {
        var nowRTL = ISQ.Translation.Infra.rtlLanguages[ISQ.Widget.TranslationHelper.detectedLanguage];
        var initialRTL = ISQ.Translation.Infra.rtlLanguages[ISQ.Cnf.initialUiLanguage];

        if (nowRTL && initialRTL) v = ISQ.Widget.Texts['iw'][key];
    }
    if (!v) v = ISQ.Widget.Texts[ISQ.Cnf.initialUiLanguage][key];
    if (!v) v = ISQ.Widget.Texts['en'][key];
    return v;
}
//////////////////////////////////////////////////////////////////////////
// This method returns a required static text.
// If possible, it returns a translation.
ISQ.Widget.getStaticText = function (type)
{
    // get translated text if exists
    var text;
    if (ISQ.Cnf.translationEnabled && ISQ.Widget.TranslationHelper.detectedLanguage && ISQ.Widget.TranslationHelper.staticTranslationsEnum[type])
        text = ISQ.Widget.TranslationHelper.getStaticTranslation(ISQ.Widget.TranslationHelper.staticTranslationsEnum[type]);
    else if (!text)
        text = ISQ.Cnf[type]; // taking from cnf
    if (!text || (ISQ.Cnf.translationEnabled && ((ISQ.Cnf.uiLanguageCode && ISQ.Widget.TranslationHelper.detectedLanguage !== ISQ.Cnf.uiLanguageCode) || (ISQ.Widget.TranslationHelper.detectedLanguage && ISQ.Widget.TranslationHelper.detectedLanguage !== ISQ.Cnf.kbLanguageCode))))
        text = ISQ.Widget.Localize.array[type];
    return text;
}

//////////////////////////////////////////////////////////////////////////
// sets texts of some elements when widget loads
ISQ.Widget.setInitialTexts = function ()
{
    // replacing default texts with custom texts
    if (ISQ.Cnf.customEmailButtonText)
        ISQ.Widget.Localize.array['email'] = ISQ.Cnf.customEmailButtonText.Trim();
    if (ISQ.Cnf.customAskRepByText)
        ISQ.Widget.Localize.array['askBy'] = ISQ.Cnf.customAskRepByText.Trim();
    if (ISQ.Cnf.customChatButtonText)
        ISQ.Widget.Localize.array['chat'] = ISQ.Cnf.customChatButtonText.Trim();

    if (ISQ.Cnf.customNoAnswersTextContext)
    {
        ISQ.Widget.Localize.array['searchMsgNOResultsContext'] = ISQ.Cnf.customNoAnswersTextContext.Trim();
        // script in no results message
        var noResults = ISQ.Data.getDBAnswerAsHtml(ISQ.Cnf.customNoAnswersTextContext.Trim(), true, null, null, null, ISQ.Widget.referer.normal);
        ISQ.Widget.Localize.array['searchMsgNOResultsContext'] = noResults.text;
        ISQ.Widget.Localize.array['searchMsgNOResultsContextScript'] = noResults.script;
    }

    if (ISQ.Cnf.customNoAnswersText)
    {
        ISQ.Widget.Localize.array['searchMsgNOResults'] = ISQ.Cnf.customNoAnswersText.Trim();
        // script in no results message
        var noResults = ISQ.Data.getDBAnswerAsHtml(ISQ.Cnf.customNoAnswersText.Trim(), true, null, null, null, ISQ.Widget.referer.normal);
        ISQ.Widget.Localize.array['searchMsgNOResults'] = noResults.text;
        ISQ.Widget.Localize.array['searchMsgNOResultsScript'] = noResults.script;
    }
    if (ISQ.Cnf.titleTeaserText)
        ISQ.Widget.Localize.array['titleTeaserText'] = ISQ.Cnf.titleTeaserText.Trim();
    if (ISQ.Cnf.titleNormalText)
        ISQ.Widget.Localize.array['titleNormalText'] = ISQ.Cnf.titleNormalText.Trim();

    // widget title
    ISQ.Widget.setTitle();
}

//////////////////////////////////////////////////////////////////////////
// sets widget title based on mode
ISQ.Widget.setTitle = function ()
{
    var text;
    if (ISQ.Widget.customTitle)
        text = ISQ.Widget.customTitle;
    if (ISQ.Widget.HTML.isTeaser && (!ISQ.Widget.isFloat || ISQ.Widget.HTML.currentWidth !== ISQ.Cnf.floatCollapsed_WidgetSize[0]))
    {
        if (ISQ.Widget.customTeaserText)
            text = ISQ.Widget.customTeaserText;
        else if (!ISQ.Widget.customTitle)
            text = ISQ.Widget.getStaticText('titleTeaserText');

        ISQ.Widget.HTML.titleWrapper.style.cursor = 'pointer';
    }
    else
    {
        if (ISQ.Widget.customTitle)
            text = ISQ.Widget.customTitle;
        else
            text = ISQ.Widget.getStaticText('titleNormalText');
        ISQ.Widget.HTML.titleWrapper.style.cursor = 'default';
    }

    // adding 'back' to activated mobile state
    //if (window !== window.top && ISQ.Http.browser.isMobile && ISQ.Widget.mobileHandlingMode === ISQ.Widget.enumMobileHandlingMode.normalWidget)
    //text = "<a href='javascript:ISQ.Widget.HTML.Mobile.deactivate();' id='mobileBackBtn' >" + ISQ.Widget.getStaticText("back") + "</a>&nbsp;&nbsp;" + text;

    // setting text
    // avoiding script injection
    if (ISQ.Widget.customTitle || ISQ.Widget.customTeaserText)
    {
        if (ISQ.Widget.HTML.titleText.innerText)
            ISQ.Widget.HTML.titleText.innerText = text;
        else
            ISQ.Widget.HTML.titleText.textContent = text;
    }
    else
        ISQ.Widget.HTML.titleText.innerHTML = text;
}

//////////////////////////////////////////////////////////////////////////
// called when customer logo has loaded
ISQ.Widget.onCustomerLogoLoad = function ()
{
    var img = ISQ.Cnf.customerBrandingLogo_img;

    var customerLogo = _('customerLogo');
    customerLogo.src = img.src;

    var footer = _('widgetFooter');

    if (ISQ.Widget.HTML.currentlyResizing || ISQ.Widget.HTML.isTeaser)
    {
        // wait till resize finises
        customerLogo.pendingResize = true;
        return;
    }

    // show the logo
    customerLogo.pendingResize = false;
    customerLogo.style.display = 'block';

    // if the widget footer is too short for logo, expand it when logo loads
    if (footer.offsetHeight < img.height)
    {
        footer.style.height = img.height + 'px';

        // resize the content pane
        ISQ.Widget.HTML.resizeHandler();

        // dynamic size
        ISQ.Widget.HTML.dynamicSize_sendMessage();
    }
    else
    {
        // align the logo vertically
        var marginTop = Math.floor(footer.offsetHeight / 2) - Math.floor(img.height / 2) + 'px';
        customerLogo.style.marginTop = marginTop;

        // align customer branding text vertically
        if (ISQ.Cnf.customerBrandingText)
            _('customerBrandingText').style.lineHeight = footer.offsetHeight + 'px';
    }

    // setting mobile position
    ISQ.Widget.HTML.Mobile.setPositions();
}
//#endregion

/********************************************************
////////////////// [ TRANSLATIONS ] /////////////////////
********************************************************/
// #region translation

ISQ.Widget.Translation = initializeNS('ISQ.Widget.Translation');

ISQ.Widget.Translation.enumTranslationState =
{
    none: 0,
    pending: 1,
    loaded: 2,
    failed:3
}

ISQ.Widget.Translation.currentState = ISQ.Widget.Translation.enumTranslationState.none;

ISQ.Widget.Translation.init = function ()
{
    if (!ISQ.Cnf.translationEnabled || ISQ.Widget.Translation.currentState != ISQ.Widget.Translation.enumTranslationState.none)
        return;

    ISQ.Widget.Translation.currentState = ISQ.Widget.Translation.enumTranslationState.pending;
    ISQ.Tools.FileLoader.load("/widget/scripts/translations.js", new ISQ.Handler(function (tag)
    {
        ISQ.Widget.Translation.afterInit();
    }));
}

ISQ.Widget.Translation.afterInit = function ()
{
    // prepare static texts for translation -- note the order must be the same as in the ISQ.Widget.TranslationHelper.staticTranslationsEnum
    var staticTexts = [ISQ.Cnf.answerFooter, ISQ.Widget.Localize.array['searchMsgNOResults'], ISQ.Widget.Localize.array['searchMsgResults'],
            ISQ.Widget.Localize.array['newSearch'], ISQ.Widget.Localize.array['askBy'],
            ISQ.Widget.Localize.array['email'], ISQ.Widget.Localize.array['chat'],
            "Translating", "Translated from " + ISQ.Tools.getLanguageName(ISQ.Cnf.kbLanguageCode) + ", click to turn on or off"];

    // initialize translation helper
    try
    {
        var apiKeys = eval('({' + ISQ.Cnf.translationApiKey + '})');
        ISQ.Widget.TranslationHelper.init(staticTexts, ISQ.Cnf.kbLanguageCode, apiKeys, ISQ.Cnf.translationLanguages);

        // register event
        ISQ.Translation.Infra.failureEvent.addHandler(ISQ.Widget.Translation.translationFailedHandler);
        ISQ.Widget.Translation.currentState = ISQ.Widget.Translation.enumTranslationState.loaded;
        if (ISQ.Widget.Translation.loadCallback)
            ISQ.Widget.Translation.loadCallback();
    }
    catch (ex)
    {
        // turn off translations
        ISQ.Widget.Log.add("Exception initializing translations: " + ex, ISQ.Widget.Log.statusEnum.RED);
        ISQ.Cnf.translationEnabled = false;
        ISQ.Widget.Translation.currentState = ISQ.Widget.Translation.enumTranslationState.failed;
    }
}

// creates translation icon and tooltip
ISQ.Widget.Translation.createTranslationIcon = function (tableId, apiProvider, direction, visible)
{
    var icon = createLink(
    {
        style: visible ? '.translationIcon' : '.translationIconOff',
        onclick: function ()
        {
            ISQ.Widget.Translation.toggleTranslationTooltip(this, false);
            ISQ.Widget.Translation.toggleAnswerTranlsationVisibility(tableId);

            // restore paged answer scrolls
            if (ISQ.Widget.HTML.answerPane.restorePagerScroll)
                ISQ.Widget.HTML.answerPane.restorePagerScroll();
        }
    });

    icon.onmouseover = function () { ISQ.Widget.Translation.toggleTranslationTooltip(this, true); }
    icon.onmouseout = function () { ISQ.Widget.Translation.toggleTranslationTooltip(this, false); }

    // create tooltip div
    if (ISQ.Widget.Translation.translationTooltipDiv === null)
    {
        ISQ.Widget.Translation.translationTooltipDiv = createDiv(document.body, '.translationTooltip');
    }

    if (direction)
        ISQ.Widget.Translation.translationTooltipDiv.style.direction = direction;

    // set tooltip contents
    var html = new Array();
    html.push(ISQ.Widget.TranslationHelper.getStaticTranslation(ISQ.Widget.TranslationHelper.staticTranslationsEnum.translatedFrom));

    // show api provider brand
    html.push('<p dir=ltr>');
    switch (apiProvider)
    {
        case ISQ.Translation.Infra.providerEnum.Microsoft:
            html.push("Translation powered by Microsoft&reg; Translator");
            break;
        case ISQ.Translation.Infra.providerEnum.GoogleV1:
        case ISQ.Translation.Infra.providerEnum.GoogleV2:
            html.push("Translation powered by <img src='/widget/skins/googleLogo.png?cv=1' align='absmiddle' alt=''/>");
            break;
    }
    html.push('</p>');
    ISQ.Widget.Translation.translationTooltipDiv.innerHTML = html.join('');

    return icon;
}

// shows/hides the "translated from... " tooltip
ISQ.Widget.Translation.toggleTranslationTooltip = function (icon, show)
{
    if (!ISQ.Widget.Translation.translationTooltipDiv) return;
    var toolTip = ISQ.Widget.Translation.translationTooltipDiv;

    // set visibility
    if (show)
    {
        if (!icon) return;

        // set tooltip's position
        var pos = ISQ.Html.position(icon);

        var windowWidth = ISQ.Html.screenSize().w;
        var toolTipWidth = toolTip.offsetWidth;

        var left = (pos.x - toolTipWidth / 2 + 8);
        left = left < 0 ? 0 : left + toolTipWidth > windowWidth ? windowWidth - toolTipWidth : left;
        toolTip.style.left = left + 'px';
        toolTip.style.top = (pos.y + 20 - ISQ.Widget.HTML.contentWrapper.scrollTop) + 'px';

        toolTip.style.visibility = 'visible';
    }
    else
    {
        toolTip.style.visibility = 'hidden';
    }
}

// toggles visibility of 2 tables
ISQ.Widget.Translation.toggleAnswerTranlsationVisibility = function (tableId)
{
    var displayedId = tableId + 'true';
    var hiddenId = tableId + 'false';

    var table1 = _(displayedId, true);
    var table2 = _(hiddenId, true);

    if (table1 && table2)
    {
        var x = table1.style.display;
        table1.style.display = table2.style.display;
        table2.style.display = x;

        // resizing elements
        ISQ.Widget.Query.resizeSingleAnswerElements(table2, false);

        // sending set-size message for dynamic
        ISQ.Widget.HTML.dynamicSize_sendMessage();
    }
}

//////////////////////////////////////////////////////////////////////////
// called when translation failed
// notifies the server that translation has failed
// turns off translations if it's completely dead
ISQ.Widget.Translation.translationFailedHandler = function (errorCode, apiProvider)
{
    var message = null;
    var providerName = apiProvider == null ? '' : ISQ.Translation.Infra.getProviderName(apiProvider);

    switch (errorCode)
    {
        case ISQ.Translation.Infra.failureEnum.DetectionTimeout:
            message = "Language detection has timed out using provider: " + providerName;
            break;
        case ISQ.Translation.Infra.failureEnum.DetectionApiFallback:
            message = "Language detection: falling back from provider: " + providerName;
            break;
        case ISQ.Translation.Infra.failureEnum.TranslationTimeout:
            message = "Translation has timed out using provider: " + providerName;
            break;
        case ISQ.Translation.Infra.failureEnum.TranslationApiFallback:
            message = "Translation: falling back to provider: " + providerName;
            break;
        case ISQ.Translation.Infra.failureEnum.TranslationDead:
            // turn off translations
            message = "Both API Providers have failed. Translations are now turned off.";
            ISQ.Cnf.translationEnabled = false;

            // if required, show process untranslated query/answers
            if (ISQ.Widget.Query.answerTranslator)
            {
                ISQ.Widget.Query.answerTranslator.translationFailed();
                ISQ.Widget.Query.answerTranslator = null;
            }
            else if (ISQ.Widget.Query.queryTranslator)
            {
                ISQ.Widget.Query.queryTranslator.translationFailed();
                ISQ.Widget.Query.queryTranslator = null;
            }

            break;
    }

    // notify the server
    _session().request(
    {
        url: "translationfailed.js",
        params:
        {
            errorCode: errorCode,
            provider: apiProvider,
            message: message
        },
        handler: function (){}
    });
}

//////////////////////////////////////////////////////////////////////////
// members
ISQ.Widget.Translation.translationTooltipDiv = null;

//#endregion


/********************************************************
/////////////////// [ THUMB UP ] ////////////////////////
********************************************************/
//#region thumb up
ISQ.Widget.Thumb = {};
ISQ.Widget.Thumb.send = function (answerId, keywordsetId, ThumbAction)
{
    ////////////	checking topicId	//////////////////////
    if (!answerId) return;

    ////////////	checking the query	//////////////////////
    var q = _query(true);
    if (!q) // query, taking first result's title
    {
        if (ISQ.Widget.Query.currentAnswers && ISQ.Widget.Query.currentAnswers.length != 0)
            q = ISQ.Widget.Query.currentAnswers[0].title;
    };
    if (!q) return;

    // hiding auto complete
    ISQ.Widget.Suggestions.hide(_('searchSuggestions'));

    if (ISQ.Widget.reportEvents) // reporting the event
    {
        // getting liked answer title
        var answerTitle = "";
        iteration(ISQ.Widget.Query.currentAnswers, function (answerObj)
        {
            if (answerObj.id === answerId)
            {
                answerTitle = answerObj.title;
                return false;
            }
        });

        ISQ.Widget.CDC.sendMessage("subject=event&type=like&query=" + ISQ.Tools.Base64.encodeString(q) + "&answer=" + ISQ.Tools.Base64.encodeString(answerTitle) + "&action=" + ThumbAction);
    }

    /// Hiding action bar
    // ISQ.Widget.HTML.hideActionBar(); // do not hide actionbar after channeling action was selected #13045

    // using translation
    if (ISQ.Widget.TranslationHelper.detectedLanguage != ISQ.Widget.Query.kbLanguageCode && ISQ.Widget.Query.lastQueryTranslation)
        q = ISQ.Widget.Query.lastQueryTranslation;

    // sending request
    _session().request(
    {
        url: "thumb.js",
        params:
        {
            text: encodeURIComponent(q),
            kbLC: ISQ.Widget.Query.kbLanguageCode,
            type: ThumbAction,
            ksId: keywordsetId,
            articleId: answerId
        },
        handler: function (status, jsonObject)
        {
            if (status != ISQ.Com.JsonP.Request.enumResponseType.OK || !jsonObject.result) return;
            var thumbDir = (ThumbAction == nanoRep.FAQ.Likes.enumFeedback.positive) ? 'up' : 'down';
            ISQ.Widget.Thumb.Rememberer.set(answerId, thumbDir);
        }
    });
}

//#endregion

/********************************************************
////////////// [ THUMB UP REMEMBERER ] //////////////////
********************************************************/
//#region thumb up remember
ISQ.Widget.Thumb.Rememberer = {};

///// [STATIC] /////
/// array ///
ISQ.Widget.Thumb.Rememberer.idArray = new Array();
ISQ.Widget.Thumb.Rememberer.queryArray = new Array();

/// current query ///
ISQ.Widget.Thumb.Rememberer.currentQuery = '';

/// get status Function ///
ISQ.Widget.Thumb.Rememberer.addIcon = function (parentNode, query, topicId, keywordsetId, visible, likes, directionUpDown)
{
    var cssThumbApplied = "thumbUpApplied";
    var cssThumb = 'thumbUp';
    if (directionUpDown == "down")
    {
        cssThumbApplied = "thumbDownApplied";
        cssThumb = 'thumbDown';
    }
    ////// [query] ////////
    if (typeof (ISQ.Widget.Thumb.Rememberer.queryArray[" " + query]) === 'undefined')
    {
        ISQ.Widget.Thumb.Rememberer.queryArray[" " + query] = new Array();
    }
    else if (ISQ.Widget.Thumb.Rememberer.currentQuery !== query)
    {
        delete ISQ.Widget.Thumb.Rememberer.queryArray[" " + query];
        ISQ.Widget.Thumb.Rememberer.queryArray[" " + query] = new Array();
    }

    ISQ.Widget.Thumb.Rememberer.currentQuery = query;
    ISQ.Widget.Thumb.Rememberer.queryArray[" " + query].push(topicId);

    /// already thumbed ///
    var link = null;
    if (typeof (ISQ.Widget.Thumb.Rememberer.idArray[topicId]) !== 'undefined' && typeof (ISQ.Widget.Thumb.Rememberer.idArray[topicId]) !== 'undefined' && (ISQ.Widget.Thumb.Rememberer.idArray[topicId] === '1' || ISQ.Widget.Thumb.Rememberer.idArray[topicId] === '2'))
    {
        link = createLink(
        {
            parent: parentNode
        });

        if ((ISQ.Widget.Thumb.Rememberer.idArray[topicId] === '1' && directionUpDown == 'up') || (ISQ.Widget.Thumb.Rememberer.idArray[topicId] === '2' && directionUpDown == 'down'))
            link.className = cssThumbApplied;
        else
            link.className = cssThumb;
    }
    /// thumb-up
    else
    {
        var title = "";
        if (nanoRep.FAQ && nanoRep.FAQ.Localization)
            title = (directionUpDown == 'up') ? nanoRep.FAQ.Localization["like"] : nanoRep.FAQ.Localization["dislike"];
        link = createLink(
        {
            parent: parentNode,
            onclick: function ()
            {

                if (directionUpDown == 'up')
                {
                    ISQ.Widget.Thumb.send(topicId, keywordsetId, nanoRep.FAQ.Likes.enumFeedback.positive);

                    var currentCounter = this.likesCounter.innerHTML | 0;

                    this.likesCounter.innerHTML = currentCounter + 1;
                }
                else
                    ISQ.Widget.Thumb.Rememberer.dislikeOptions(this, topicId, keywordsetId, ISQ.Widget.Thumb.send);
            },
            title: title
        });
        link.id = ISQ.Widget.Thumb.Rememberer.getIconElement(topicId, visible, directionUpDown);
        link.oppositeId = ISQ.Widget.Thumb.Rememberer.getIconElement(topicId, visible, (directionUpDown == "up") ? 'down' : 'up');
        link.className = cssThumb;
        link.widgetAnswer = true; // setting flag for dislike options

        if (ISQ.Widget.Localize.array["dir"] === 'rtl')
        {
            // fix for IE8...
            link.style.cssText = "display:block !important;float:right;direction:rtl;";
        }

    }

    // thumbdown doesn't have a counter and that's why we return here.
    if (directionUpDown == "down") return;

    if (ISQ.Widget.Localize.array["dir"] === 'rtl')
    {
        createDiv(parentNode, '.newLikesRightEdge');
        link.likesCounter = createDiv(parentNode, '.newlikes');
        link.style["float"] = "right";
        link.likesCounter.className += " newlikesRTL";
        if (link.style.setProperty)
            link.style.setProperty("float", "right");
        else
            link.style.setAttribute("float", "right");

    }
    else
    {
        createDiv(parentNode, '.newLikesLeftEdge');
        link.likesCounter = createDiv(parentNode, '.newlikes');
    }
    link.likesCounter.innerHTML = (likes) ? likes : '0';

}
ISQ.Widget.Thumb.Rememberer.dislikeOptions = function (dislikeLink, topicId, keywordsetId, callback)
{
    var rtl = ISQ.Widget.Localize.array["dir"] === 'rtl';
    var obj = {};
    obj.thumbDown = dislikeLink;
    obj.thumbDown.newPosition = { "left": "-1px", "top": "-135px" };
    nanoRep.FAQ.Likes.saveData(obj, topicId, rtl, null, null, null, null, null, callback, keywordsetId);
    nanoRep.FAQ.Likes.toggleDislikeOptions(false, rtl);
}


/// change status function ///
ISQ.Widget.Thumb.Rememberer.set = function (topicId, directionUpDown)
{
    if (!ISQ.Widget.Thumb.Rememberer.queryArray[" " + ISQ.Widget.Thumb.Rememberer.currentQuery]) return; // when there were no results
    var l = ISQ.Widget.Thumb.Rememberer.queryArray[" " + ISQ.Widget.Thumb.Rememberer.currentQuery].length;

    for (var i = 0; i < l; ++i)
    {
        var _topic = ISQ.Widget.Thumb.Rememberer.queryArray[" " + ISQ.Widget.Thumb.Rememberer.currentQuery][i];
        var _element1 = _(ISQ.Widget.Thumb.Rememberer.getIconElement(_topic, true, directionUpDown), true);
        var _element2 = _(ISQ.Widget.Thumb.Rememberer.getIconElement(_topic, false, directionUpDown), true); // when toggling between translation and original answer, there are two "like" icons
        // taking the other element ( if thumbsup, other element = thumb down )
        var _element1opp = _(ISQ.Widget.Thumb.Rememberer.getIconElement(_topic, true, (directionUpDown == 'up') ? 'down' : 'up'), true);
        var _element2opp = _(ISQ.Widget.Thumb.Rememberer.getIconElement(_topic, false, (directionUpDown == 'up') ? 'down' : 'up'), true);

        // if thumb was not clicked yet
        if (_topic == topicId)
        {
            if (_element1 !== null)
            {
                ISQ.Widget.Thumb.Rememberer.disableLikeIcon(_element1, directionUpDown);
                _element1.style.cursor = 'default';
                _element1.title = '';
                _element1opp.className += (directionUpDown == 'up') ? " opacity20" : " opacity30";
                _element1opp.title = '';
            }
            if (_element2 !== null)
            {
                ISQ.Widget.Thumb.Rememberer.disableLikeIcon(_element2, directionUpDown);
                _element2.style.cursor = 'default';
                _element2.title = '';
                _element2opp.className += (directionUpDown == 'up') ? " opacity20" : " opacity30";
                _element2opp.title = '';
            }

            if (!ISQ.Widget.Thumb.Rememberer.idArray[topicId])
                ISQ.Widget.Thumb.Rememberer.idArray[topicId] = {};
            ISQ.Widget.Thumb.Rememberer.idArray[topicId] = (directionUpDown == 'up') ? '1' : '2';
        }
        else // after a thumb was clicked...
        {


            if (_element1 !== null)
            {
                _element1.className += (directionUpDown == 'up') ? " opacity20" : " opacity30";
                _element1.title = '';
                _element1opp.className += (directionUpDown == 'up') ? " opacity20" : " opacity30";
                _element1opp.title = '';
                _element1.onclick = _element1opp.onclick = null;

            }
            if (_element2 !== null)
            {
                _element2.className += (directionUpDown == 'up') ? " opacity20" : " opacity30";
                _element2.title = '';
                _element2opp.className += (directionUpDown == 'up') ? " opacity20" : " opacity30";
                _element2opp.title = '';
                _element2.onclick = _element2opp.onclick = null;
            }
        }

    }

    // resetting current query ///
    ISQ.Widget.Thumb.Rememberer.currentQuery = '';
}

ISQ.Widget.Thumb.Rememberer.isIdThumbed = function (id, directionUpDown)
{
    return (typeof (ISQ.Widget.Thumb.Rememberer.idArray[id][directionUpDown]) !== 'undefined' && (ISQ.Widget.Thumb.Rememberer.idArray[id][directionUpDown] === '1' || ISQ.Widget.Thumb.Rememberer.idArray[id][directionUpDown] === '2'));
}

ISQ.Widget.Thumb.Rememberer.disableLikeIcon = function (_element, directionUpDown)
{
    var cssThumbApplied = "thumbUpApplied";
    if (directionUpDown == "down")
        cssThumbApplied = "thumbDownApplied";

    _element.className = cssThumbApplied;
    _element.onclick = null;
    _element.title = '';

    var oppositeElement = _(_element.oppositeId);
    if(oppositeElement)
    {
        oppositeElement.onclick = null;
        oppositeElement.title = '';
    }

}

ISQ.Widget.Thumb.Rememberer.getIconElement = function (topicId, visible, directionUpDown)
{
    return "thumb" + directionUpDown  + "Image" + topicId + visible;
}
//#endregion

/********************************************************
/////////////////// [ ESCALATE] /////////////////////////
********************************************************/
//#region escalate
ISQ.Widget.Escalate = initializeNS('ISQ.Widget.Escalate');

// repeated in server Enums.cs
ISQ.Widget.Escalate.enumType =
{
    email : 0,
    customEmail: 1,
    customChat: 2,
    chat: 3,
    customEmail_fromContactForm: 4,
    clickToCall: 5
};

// repeated in server Enums.cs
ISQ.Widget.Escalate.escaeTypeEnum =
{
    normal: "0",
    customUrl: "1",
    customScript: "2"
};

ISQ.Widget.Escalate.toEmail = function()
{
    if (ISQ.Cnf.customEscalationLink && ISQ.Cnf.customEscalationLink_Action !== ISQ.Widget.enumCustomLinkStats.countChatEscalation)
        _('customLink').onclick();
    else
        _('repByEmail').onclick();
}
ISQ.Widget.Escalate.send = function (type, chatStartAction, ignoreQueryValue, apiName, channelObj,node,actionDone)
{
    if (typeof (chatStartAction) === 'undefined') chatStartAction = null;
    if (typeof (ignoreQueryValue) === 'undefined') ignoreQueryValue = false;
    if (chatStartAction) ignoreQueryValue = true;

    // hiding auto complete
    ISQ.Widget.Suggestions.hide(_('searchSuggestions'));

    // validating query
    var query = _query(true);
    if (ISQ.Widget.Query.lastWrittenQuery)
    {
        if (ISQ.Widget.Query.typeTimer)
        {
            ISQ.Widget.Query.typeTimer.cancel(); // stopping type-effect
            ISQ.Widget.Query.clearTextboxOnInteraction = false;
        }
        query = ISQ.Widget.Query.lastWrittenQuery;
        if (type != ISQ.Widget.Escalate.enumType.customEmail_fromContactForm) // in case it's an external contact form, we don't set value into the query field
            ISQ.Widget.HTML.queryField.value = ISQ.Widget.Query.lastWrittenQuery;
    }
    if (!ignoreQueryValue && !query) return;

    // stopping auto questions (not supposed to happen)
    if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions)
        ISQ.Widget.AutoQuestions.stop_();

    // hiding action bar
    if (type != ISQ.Widget.Escalate.enumType.chat && type != ISQ.Widget.Escalate.enumType.clickToCall)
        ISQ.Widget.HTML.hideActionBar();

    // non LP chat escalation
    if (type !== ISQ.Widget.Escalate.enumType.chat)
    {
        ISQ.Widget.HTML.Mobile.hideAddressbar();

        // updating state (in chat mode, this method is called after a chat was started: the state was already changed)
        if (type === ISQ.Widget.Escalate.enumType.customEmail)
            ISQ.Widget.state = ISQ.Widget.enumState.customLink;
        else
            ISQ.Widget.state = ISQ.Widget.enumState.contactForm;
    }

    // resetting query
	if (type !== ISQ.Widget.Escalate.enumType.chat)
		ISQ.Widget.Query.lastQuerySent = '';

    // custom contact form && ticketing interface
    ISQ.Widget.Query.ticketingInterface = null;
    var rechannelingContactFormId = 0;
    if (channelObj)
    {
        if (channelObj.contactForms)
            rechannelingContactFormId = channelObj.contactForms;
        if (channelObj.ticketingInterface)
            ISQ.Widget.Query.ticketingInterface = channelObj.ticketingInterface;
    }

    // sending request
    _session().request(
    {
        url: "escalate.js",
        params:
        {
            type: type
            , text: encodeURIComponent(query)
            , articleId: ISQ.Widget.Query.firstAnswerId
            , translation: ISQ.Widget.Query.lastQueryTranslation
            , translationLanguage: ISQ.Tools.getUniformLanguageCode(ISQ.Widget.TranslationHelper.detectedLanguage) // query's language
            , chatType: chatStartAction
            , apiName: apiName
            , contactFormId: rechannelingContactFormId
        },
        handler: function (status, jsonObject)
        {
            ISQ.Widget.Escalate.parseResponse(status, jsonObject, type, query,null,channelObj);
        }
    });
    // if we recived channel object.
    if(channelObj && (type === ISQ.Widget.Escalate.enumType.customEmail || type === ISQ.Widget.Escalate.enumType.customChat || type === ISQ.Widget.Escalate.enumType.clickToCall))
    {
        if (channelObj.popupSize && channelObj.linkTarget == ISQ.Widget.enumCustomLinkTarget.Popup)
        {
            var size = channelObj.popupSize.split(",");
            var popupWindow = {};
            if (size.length > 0)
                popupWindow.w = parseInt(size[0]) || 800;
            else
                popupWindow.w = 800;
            if (size.length > 1)
                popupWindow.h = parseInt(size[1]) || 600;
            else
                popupWindow.h = 600;

            window.open(ISQ.Widget.Query.buildCustomLink(channelObj.linkUrl), "nr_escalationWindow", "height=" + popupWindow.h + ",width=" + popupWindow.w);
        }
        else
        {
            node.href = channelObj.linkUrl;
            ISQ.Widget.Query.switchLinkTarget(node, parseInt(channelObj.linkTarget) || 0);

        }
    }
    // not in chat mode & custom escalation link
    else if ( !actionDone && (type === ISQ.Widget.Escalate.enumType.customEmail || type === ISQ.Widget.Escalate.enumType.customChat))
    {
        // hiding all thumb-ups
        // ISQ.Widget.Thumb.Rememberer.set();

        // opening in popup if:
        // 1. custom link is configured to be opened in popup
        // 2. customChat button and chat was pushed/invite
        if (ISQ.Cnf.customEscalationLink_target === ISQ.Widget.enumCustomLinkTarget.Popup || (type === ISQ.Widget.Escalate.enumType.customChat && chatStartAction != ISQ.Widget.enumChatEscalationActions.normal))
        {
            var width = 800, height = 600;
            if (ISQ.Cnf.customLinkPopupSize != null)
            {
                width = ISQ.Cnf.customLinkPopupSize[0];
                height = ISQ.Cnf.customLinkPopupSize[1];
            }
            window.open(ISQ.Widget.Query.buildCustomLink(ISQ.Cnf.customEscalationLink), "nr_escalationWindow", "height=" + height + ",width=" + width);
            return false; // returning false to cancel the 'href'
        }
        else
        {
            return true; // returning true to allow href
        }
    }
};
ISQ.Widget.Escalate.parseResponse = function (status, jsonObject, escalatedType, escalatedQuery,container,channel)
{
    // failed
    if (status != ISQ.Com.JsonP.Request.enumResponseType.OK)
    {
        ISQ.Widget.Log.add('Error parsing escalation response');
        return;
    }

    // scrolling to top of content wrapper
    if (ISQ.Http.browser.isIE6 || ISQ.Http.browser.isIE7)
        ISQ.Widget.HTML.contentWrapper.scrollTop = 0;

    try
    {
        //#region creating data for event
        var eventData = { query: escalatedQuery };
        switch (escalatedType)
        {
            case ISQ.Widget.Escalate.enumType.email:
                eventData.escType = "email";
                break;
            case ISQ.Widget.Escalate.enumType.customEmail:
                eventData.escType = "customEmail";
                break;
            case ISQ.Widget.Escalate.enumType.customChat:
                eventData.escType = "customChat";
                break;
            case ISQ.Widget.Escalate.enumType.chat:
                eventData.escType = "chat";
                break;
        }
        //#endregion

        //////////////////////////////////////////////////////////////////////////
        // handling response
        switch (jsonObject.action)
        {
            //////////////////////////////////////////////////////////////////////////
            // #region no action
            case "noAction":
                // reporting ESCALATION
                if (ISQ.Widget.reportEvents)
                    ISQ.Widget.CDC.sendMessage("subject=event&type=escalation&query=" + ISQ.Tools.Base64.encodeString(eventData.query) + "&esctype=" + eventData.escType);

                //////////////////////////////////////////////////////////////////////////
                // message received
                if (jsonObject.status)
                {
                    if (jsonObject.status === 'readOnly')
                    {
                        txt = ISQ.Cnf["readOnlyModeAlert"] || ISQ.Widget.Localize.array["readOnlyModeAlert"];
                        if (!txt) txt = ISQ.Widget.Texts['en']["readOnlyModeAlert"];
                    }
                    else if (jsonObject.status === 'success')
                    {
                        txt = ( channel && channel.ThankYouMessage) || ISQ.Cnf["topicPostConfirmationText"] || ISQ.Widget.Localize.array["topicPostConfirmationText"];
                        if (!txt) txt = ISQ.Widget.Texts['en']["topicPostConfirmationText"];
                    }
                    else
                        txt = '';

                    // do we need to translate the message?
                    if (txt && ISQ.Widget.Query.toTranslateContent(ISQ.Cnf.initialUiLanguage))
                        ISQ.Translation.Infra.translate(txt, null, ISQ.Widget.TranslationHelper.detectedLanguage, new ISQ.Handler(function(text)
                        {
                            ISQ.Widget.Escalate.showThankYouMessage(text,container);
                        }));
                    else if (txt)
                        ISQ.Widget.Escalate.showThankYouMessage(txt,container);
                    return;
                }
                else
                {
                    // changing state
                    if (ISQ.Widget.state === ISQ.Widget.enumState.contactForm)
                        ISQ.Widget.state = ISQ.Widget.enumState.questions;
                }
                break;
            // #endregion
            //////////////////////////////////////////////////////////////////////////
            // #region contact form
            case "contactForm":
                // reporting CONTACT FORM
                if (ISQ.Widget.reportEvents)
                    ISQ.Widget.CDC.sendMessage("subject=event&type=contactForm&query=" + ISQ.Tools.Base64.encodeString(eventData.query));
                ISQ.Widget.ContactForm.detectedLanguageKBExists = jsonObject.detectedLanguageKBExists;
                ISQ.Widget.ContactForm.show(jsonObject.data, jsonObject.allowedAttachments,null,channel);

                break;
            // #endregion
            case "customLink":
                // reporting ESCALATION
                if (ISQ.Widget.reportEvents)
                    ISQ.Widget.CDC.sendMessage("subject=event&type=escalation&query=" + ISQ.Tools.Base64.encodeString(eventData.query) + "&esctype=" + eventData.escType);
                break;
        }
    }
    catch (e)
    {
        ISQ.Widget.Log.add('Escalate.parseResponse:' + e.message, ISQ.Widget.Log.statusEnum.RED);
    }
};

ISQ.Widget.Escalate.showThankYouMessage = function (txt,confirmationElement)
{
    // setting state
    ISQ.Widget.state = ISQ.Widget.enumState.questions;

    // in limited mode, canceling focus on query field
    if (ISQ.Cnf.limited)
    {
        ISQ.Widget.HTML.queryField.style.display = 'none';
        ISQ.Widget.HTML.queryField.style.visibility = 'hidden';
    }

    if(!confirmationElement)
    {
        // showing answer pane with message
        ISQ.Widget.Query.displayAnswers(true);
        ISQ.Widget.HTML.answerPane.style.display = 'block';
        ISQ.Widget.HTML.answerPane.innerHTML = txt;

    }
    else
    {
        confirmationElement.style.padding = "10px";
        confirmationElement.style.borderRadius = "3px";
        confirmationElement.style.backgroundColor = "#f2f2f2";
        confirmationElement.style.fontFamily = "Open Sans";
        confirmationElement.style.fontSize = "14px";
        confirmationElement.style.color = "#516166";
        confirmationElement.innerHTML = txt;
    }

    // close contact form
    ISQ.Widget.ContactForm.thankYouShown = true;
    ISQ.Widget.ContactForm.closeComplete();
}
// #endregion

/********************************************************
///////////////// [ CONTACT FORM ] //////////////////////
********************************************************/
// #region contact form
ISQ.Widget.ContactForm = initializeNS('ISQ.Widget.ContactForm');
ISQ.Widget.ContactForm.fader = null;
ISQ.Widget.ContactForm.fader_submit = false;
ISQ.Widget.ContactForm.blockedCreditCardReplacement = '*';
ISQ.Widget.ContactForm.closed = false;
ISQ.Widget.ContactForm.thankYouShown = false;
ISQ.Widget.ContactForm.canceled = false;
ISQ.Widget.ContactForm.detectedLanguageKBExists = null;
ISQ.Widget.ContactForm.preview = null;
ISQ.Widget.ContactForm.preDefinedValues = [];
ISQ.Widget.ContactForm.mSessionOpenTimer = null;
ISQ.Widget.ContactForm.mResizeContactForm = null;
ISQ.Widget.ContactForm.showContactForm = null;
ISQ.Widget.ContactForm.preDefinedValuesFromMessage = null;
ISQ.Widget.ContactForm.getPreDefinedValues = function ()
{
    // returns predfined form values as key/value pairs
    if (!ISQ.Widget.ContactForm.preDefinedValues) return [];
    var data = [];
    for (var obj in ISQ.Widget.ContactForm.preDefinedValues)
    {
        data[ISQ.Widget.ContactForm.preDefinedValues[obj].name] = ISQ.Widget.ContactForm.preDefinedValues[obj].value;
    }
    return data;
}
ISQ.Widget.ContactForm.show = function (jsonText, allowedExtensions,container,channel)
{
    if (ISQ.Widget.ContactForm.showContactForm)
        ISQ.Widget.ContactForm.showContactForm(jsonText, allowedExtensions,container,channel);
    else
        ISQ.Tools.FileLoader.load("/widget/scripts/contactform.js", new ISQ.Handler(function (tag)
        {
            if (ISQ.Widget.ContactForm.preDefinedValuesFromMessage)
                ISQ.WebForms.PreviewContact.incomingPreDefinedValuesFromMessage(ISQ.Widget.ContactForm.preDefinedValuesFromMessage);
            ISQ.Widget.ContactForm.showContactForm(jsonText, allowedExtensions,container,channel);
        }));
}
ISQ.Widget.ContactForm.incomingPreDefinedValuesFromMessage = function (messageValue)
{
    var valueSplit = messageValue.split(ISQ.Widget.APIKeyEndDelimiter);
    var valueDataSplit;
    for (var valNdx = 0; valNdx < valueSplit.length; ++valNdx)
    {
        valueDataSplit = valueSplit[valNdx].split("(");
        // value has type
        if (valueDataSplit.length === 3)
            ISQ.Widget.ContactForm.reportPreDefinedValue(ISQ.Http.Cookies.decode64(valueDataSplit[0]), ISQ.Http.Cookies.decode64(valueDataSplit[1]), ISQ.Http.Cookies.decode64(valueDataSplit[2]));
        // value has no type
        else
            ISQ.Widget.ContactForm.reportPreDefinedValue(ISQ.Http.Cookies.decode64(valueDataSplit[0]), ISQ.Http.Cookies.decode64(valueDataSplit[1]));
    }
    // if contact form is shown, inserting pre-defined values into fields
    if ((ISQ.Widget.state & ISQ.Widget.enumState.contactForm) !== 0 && ISQ.Widget.ContactForm.preview)
        ISQ.Widget.ContactForm.preview.populateValues(ISQ.Widget.ContactForm.preDefinedValues, _query(true, false));


    // updating session's values
    _session().setValues(ISQ.Widget.ContactForm.getPreDefinedValues());
}
ISQ.Widget.ContactForm.reportPreDefinedValue = function (key, value, type)
{
    type = type || "text";
    // adding value
    ISQ.Widget.ContactForm.preDefinedValues[key] = new ISQ.Widget.ContactForm.preDefinedValue(key, value, type);
}
//#region predefined value
ISQ.Widget.ContactForm.preDefinedValue = function (name, value, type)
{
    this.name = name;
    this.value = value;
    this.type = type;
}
ISQ.Widget.ContactForm.preDefinedValue.prototype.name = '';
ISQ.Widget.ContactForm.preDefinedValue.prototype.value = '';
ISQ.Widget.ContactForm.preDefinedValue.prototype.type = '';
// #endregion

/********************************************************
///////////////////// [ CDC ] ///////////////////////////
********************************************************/
//#region CDC
ISQ.Widget.CDC = initializeNS('ISQ.Widget.CDC'); ;
ISQ.Widget.CDC.lastMessage = 'load';
ISQ.Widget.CDC.waitingForFrameToLoad = false;
ISQ.Widget.CDC.nextMessage = '';
ISQ.Widget.CDC.user = null;
ISQ.Widget.CDC.messageOrdinal_cdc2 = 0;

ISQ.Widget.CDC.init = function ()
{
    var refererHost;
    if (ISQ.Widget.isPreview)
        refererHost = window.location.protocol + "//" + ISQ.Http.domain(true);
    else
        refererHost = ISQ.Widget.referer.normal.substring(0, ISQ.Widget.referer.normal.indexOf("/", 8));

    // if sending messages, creating a cdc user
    if (ISQ.Widget.sendingCDCMessages)
    {
        // using 'postMessage' ability in browsers which support this ability
        if (ISQ.Widget.supportsPostMessage) ISQ.Widget.cdcVersion = "3";

        switch (ISQ.Widget.cdcVersion)
        {
            case "1":
            case "2":
                break;
            case "3":
                // creating cdc user which allows sending & receiving messages
                ISQ.Widget.CDC.user = new ISQ.CDC.User(
                {
                    targetWindowName: "parent",
                    proxyIFrameUrl: ISQ.Widget.cdcFrame,
                    allowMessagesFrom: refererHost,
                    server: window.location.protocol + '//' + window.location.host
                });
                break;
        }
    }

    // if cdc-user object wasn't created,
    // creating one for RECEIVING messages from float/embed
    if (!ISQ.Widget.CDC.user)
    {
        ISQ.Widget.CDC.user = new ISQ.CDC.User(
        {
            allowMessagesFrom: refererHost
        });
    }

    // cdc-user INCOMING MESSAGES handler
    ISQ.Widget.CDC.user.incomingMessageEvent.addHandler(ISQ.Widget.CDC.incomingMessage);
};
ISQ.Widget.contextSetAlready = false;
ISQ.Widget.CDC.incomingMessage = function (message)
{
    switch (message["subject"])
    {
        case 'scrolledOrReiszed':
            // calling back a function that requires the infomation of external scrolling or resizing
            // relevant for embeded widget only
            if (ISQ.Widget.embedCallback)
                ISQ.Widget.embedCallback({
                    "scrollLeft": message["scrollleft"],
                    "scrollTop": message["scrolltop"],
                    "width": message["width"],
                    "height": message["height"],
                    "offsetTop": message["offsettop"]
                });

            break;
        case 'api':
            // form
            var formData = message["form"];
            if (formData)
            {
                // mobile inactive mode, just saving the data to a member
                if (ISQ.Http.browser.isMobile && !ISQ.Widget.HTML.Mobile.adjustableEmbedWidth)
                    ISQ.Widget.HTML.Mobile.formPredefinedData = formData;
                else // parsing data
                    ISQ.Widget.ContactForm.incomingPreDefinedValuesFromMessage(formData);
            }

            // custom params
            var custParams = message["customparams"];
            if (custParams) ISQ.Widget.API.customParams = ISQ.Widget.CDC_getKeyValueArrayFromMessage(custParams, true);

            // context
            var context = message["context"];
            if (context)
            {
                _session().setContext(ISQ.Widget.CDC_getKeyValueArrayFromMessage(context));
                ISQ.Widget.contextSetAlready = true;
            }
            //NOTE: context might change according to the CNF
            break;
        case "cnf":
            if (!ISQ.Cnf) ISQ.Cnf = [];
            ISQ.Cnf.push(message["data"]);
            var finished = message["finished"];
            if (finished) // cnf data finished
            {
                var completeCnf = ISQ.Cnf.join('');
                if (!completeCnf) return; // empty cnf: widget disabled #9458
                ISQ.Cnf = eval("(" + ISQ.Http.Cookies.decode64(completeCnf) + ")");

                setTimeout(function ()
                {
                    // onload script
                    var customScript = ISQ.Cnf.customScript;
                    delete ISQ.Cnf.customScript;
                    if (customScript) try { eval(customScript); } catch (e) { }

                    ISQ.Widget.Cnf.postDownload();
                }, 0);
            }
            break;
        case "refreshSize":
            ISQ.Widget.HTML.resizeHandler(null, true);
            break;
        case "setHeight":
            ISQ.Widget.HTML.resizeHandler({ w: ISQ.Html.screenSize().w, h: parseInt(message["size"]) }, true);
            break;
        case "dynamicSizeRequest":
            ISQ.Widget.HTML.dynamicSize_sendMessage();
            break;
        // EXTERNAL API:
        case "openContactForm":
            var contactFormData = message["data"] ? ISQ.Http.Cookies.decode64(message["data"]) : null;
            // if widget is not in search state
            if ((ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) === 0)
            {
                //   if (ISQ.Widget.state == ISQ.Widget.enumState.contactForm)
                // ISQ.Widget.ContactForm.FormLoaded();
                // if contact form isn't shown - break
                if ((ISQ.Widget.state & ISQ.Widget.enumState.contactForm) === 0) break;
                if (!contactFormData) break; // not given form to show - invalid state
                // closing previous contact form
                ISQ.Widget.ContactForm.close(false, true);
            }

            if (contactFormData) // showing given contact form
                ISQ.Widget.ContactForm.show(contactFormData);
            else // requesting server for contact form
                ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.email, null, true);


            break;
        case "customize":
            if (message["bgcolor"])
            {
                _('widgetTitleWrapper').style.backgroundColor = message["bgcolor"];
                _('widgetContainer').style.borderColor = message["bgcolor"];
            }
            if (message["title"])
            {
                ISQ.Widget.customTitle = message["title"];
                ISQ.Widget.HTML.titleText.innerHTML = message["title"];
            }
            break;
        case "startChat":
            // make sure we're in questions state
            if ((ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) === 0) break;

            // stop auto questions (#5240)
            if (ISQ.Widget.state === ISQ.Widget.enumState.autoQuestions)
            {
                ISQ.Widget.Query.clearTextboxOnInteraction = true;
                ISQ.Widget.AutoQuestions.stop_();
            }

            var countStatsOnly = message["countstatsonly"];

            if (countStatsOnly)
            {
                ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.chat, ISQ.Widget.enumChatEscalationActions.normal);
                break;
            }

            if (!ISQ.Widget.iChat.instance || !ISQ.Widget.iChat.instance.available()) break;
            ISQ.Widget.Chat.requestChat(ISQ.Widget.enumChatEscalationActions.normal);
            break;
        case "ask":
            if ((ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) === 0) break;
            var q = message["question"] || "";
            ISQ.Widget.userActive = true;
            ISQ.Widget.Query.ask(q, ISQ.Widget.Query.enumTextQuerySource.api);

            // float mode: notifying float to enlarge itself
            if (ISQ.Widget.isFloat)
            {
                setTimeout(function ()
                {
                    ISQ.Widget.CDC.sendMessage("subject=userWrites");
                }, 0);
            }
            break;
        case "askById":
            if ((ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) === 0) break;
            var id = message["questionid"] || "";
            var sender = message["sender"] || "";
            if (id.length === 0) break;
            ISQ.Widget.userActive = true;
            ISQ.Widget.Query.clearQuestionTrail();
            ISQ.Widget.Query.getAnswerById(id);
            ISQ.Widget.Query.clearTextboxOnInteraction = true;

            // float mode: notifying float to enlarge itself
            if (ISQ.Widget.isFloat)
            {
                setTimeout(function ()
                {
                    ISQ.Widget.CDC.sendMessage("subject=userWrites");
                }, 0);
            }

            break;
        case "mobileOpenNewWindow":
            ISQ.Widget.HTML.Mobile.beforeOpeningWidget();
            break;
        case "closesession":
            _session().die();
            setTimeout(function ()
            {
                ISQ.Widget.CDC.sendMessage("subject=sessionclosed");
            }, 0);
            break;
        case "faqData":
            switch (ISQ.Widget.FAQ.scriptLoadState)
            {
                case ISQ.Widget.FAQ.initEnum.loaded:
                    ISQ.Widget.FAQ.dataReady(ISQ.Http.Cookies.decode64(message["data"]));
                    break;
                case ISQ.Widget.FAQ.initEnum.loading:
                case ISQ.Widget.FAQ.initEnum.none:
                    ISQ.Widget.FAQ.pendingFAQCallbackList.push(function ()
                    {
                        ISQ.Widget.FAQ.dataReady(ISQ.Http.Cookies.decode64(message["data"]));
                    });
                    break;
            }
            break;
        case "chatResumeApproved":
            ISQ.Widget.Chat.resumeChat(true);
            break;
        case "preventChatResuming":
            ISQ.Widget.Chat.preventChatResuming();
            break;
        case "chat":
            if (!ISQ.Widget.iChat.instance) return;
            ISQ.Widget.iChat.instance.handleCDCMessage(message);
            break;
        case "widgetLog":
            ISQ.Widget.Log.add(message.entry);
            break;
        case "visitorId":
            if (!ISQ.Widget.iChat.instance) return;
            ISQ.Widget.iChat.instance.setVisitorId(message["data"]);
            break;
        case "backImageClicked":
            //Expand widget after image click
            ISQ.Widget.Expand();
            break;
        case "startSpeechRecognition":
            ISQ.Widget.Cnf.SpeechRecognition.start();
            break;
        case "voiceEnabled":
            if (message['value'] == 'true') {
                ISQ.Widget.Cnf.SpeechRecognition.activate();
            } else {
                ISQ.Widget.Cnf.SpeechRecognition.deactivate();
            }
            break;
        case "setUiLanguage":
            ISQ.Widget.setUiLanguage(message['lang'])
            break;
        case "blurQueryField":
            document.activeElement.blur();
            break;


    }
};

ISQ.Widget.CDC.sendMessage = function (message, forceMessage)
{
    if (!ISQ.Widget.sendingCDCMessages) return;
    if (!message) return;

    // validating arguments
    forceMessage = forceMessage === true;

    // adding widget type to message
    message += "&widget=" + (ISQ.Widget.isFloat ? "float" : "embed");

    // if going to send same message twice
    if (ISQ.Widget.CDC.lastMessage === message && !forceMessage) return;

    var container, _iframe;
    switch (ISQ.Widget.cdcVersion)
    {
        case "1":
            // waiting for last message to pass OR current message equals last message --> setting as next message
            if (ISQ.Widget.CDC.waitingForFrameToLoad)
            {
                ISQ.Widget.CDC.nextMessage = message;
                return;
            }

            ISQ.Widget.CDC.waitingForFrameToLoad = true;
            ISQ.Widget.CDC.nextMessage = '';

            // removing old iframe
            container = _('iframeContainer');

            // creating an iframe
            _iframe = ISQ.Widget.CDC.createIFrame(container);

            // apparently can't add listener to iframe onload  in some versions of opera (we must explicitly set a handler)
            if (ISQ.Http.browser.app === 'opera')
                _iframe.onload = ISQ.Widget.CDC.frameOnload;
            else if (document.addEventListener)
                _iframe.addEventListener('load', ISQ.Widget.CDC.cdc1_frameLoad, true);
            else if (document.attachEvent)
                _iframe.attachEvent('onload', ISQ.Widget.CDC.cdc1_frameLoad);

            // setting source
            _iframe.src = ISQ.Widget.cdcFrame + "?" + message;

            // appending to container
            container.appendChild(_iframe);

            // removing previous iframe(s)
            var oldFrame;
            while (container.childNodes.length !== 1)
            {
                oldFrame = container.firstChild;
                if (ISQ.Http.browser.app === 'opera')
                    oldFrame.onload = null;
                else if (document.addEventListener)
                    oldFrame.removeEventListener('load', ISQ.Widget.CDC.cdc1_frameLoad, true);
                else if (document.attachEvent)
                    oldFrame.detachEvent('onload', ISQ.Widget.CDC.cdc1_frameLoad);
                container.removeChild(oldFrame);
            }

            // preventing memory leak
            container = null;

            // saving state
            ISQ.Widget.CDC.lastMessage = message;
            break;
        case "2":
            container = _('iframeContainer');

            // getting/creating the iframe
            _iframe = ISQ.Widget.CDC.createIFrame(container);
            if (ISQ.Http.browser.app === 'opera')
                _iframe.onload = ISQ.Widget.CDC.cdc2_frameLoad;
            else if (document.addEventListener)
                _iframe.addEventListener('load', ISQ.Widget.CDC.cdc2_frameLoad, true);
            else if (document.attachEvent)
                _iframe.attachEvent('onload', ISQ.Widget.CDC.cdc2_frameLoad);

            // setting source
            _iframe.src = ISQ.Widget.cdcFrame + "#" + message + "&ord=" + (++ISQ.Widget.CDC.messageOrdinal_cdc2);

            // appending child
            container.appendChild(_iframe);

            break;
        case "3":
            ISQ.Widget.CDC.user.sendMessage(message);
            break;
    }

};
ISQ.Widget.CDC.cdc2_frameLoad = function()
{
    var ifr = this;
    setTimeout(function()
    {
        // removing iframe
        if (ifr.parentNode) ifr.parentNode.removeChild(ifr);
    }, 1000);
};

ISQ.Widget.CDC.cdc1_frameLoad = function (event4ff)
{
    // iframe was loaded... sending next message
    ISQ.Widget.CDC.waitingForFrameToLoad = false;
    if (ISQ.Widget.CDC.nextMessage !== '') ISQ.Widget.CDC.sendMessage(ISQ.Widget.CDC.nextMessage);
};

ISQ.Widget.CDC.createIFrame = function (parentNode)
{
    var _iframe = createElement("iframe", null, "visibility:hidden;z-index:-1;border:0px;height:1px;width:1px;background:transparent;");
    _iframe.id = 'cdcFrame' + new Date().getTime();
    _iframe.setAttribute("allowTransparency", true);
    _iframe.setAttribute("frameBorder", false);
    return _iframe;
};

//#endregion

/********************************************************
//////////////////// [ CHAT ] ///////////////////////////
********************************************************/
//#region chat
ISQ.Widget.Chat = initializeNS('ISQ.Widget.Chat');

// enum indicates line type which will be sent to server
ISQ.Widget.Chat.enumChatLineType =
{
    user: 0,
    agent: 1,
    quickAnswer: 2
};

ISQ.Widget.Chat.intuitiveInput = null;
ISQ.Widget.Chat.chatStartAction = null; // stores the action that initiated the chat
ISQ.Widget.Chat.selectedLinksToAnswers = null;
ISQ.Widget.Chat.linksToAnswersBaseId = new Date().getTime();
ISQ.Widget.Chat.widgetFooterContent = null;
ISQ.Widget.Chat.mobileCss = "";
ISQ.Widget.Chat.chatConfig = {};

ISQ.Widget.Chat.loadProvider = (function() {
    var loadedProviders = {};
    return function(src, callback) {
        var provider = loadedProviders[src];
        if (!provider) {
            loadedProviders[src] = { callbacks: [], loaded: false };
            provider = loadedProviders[src];
            ISQ.Tools.FileLoader.load(src, function() {
                provider.loaded = true;
                for (var i = 0; i < provider.callbacks.length; i++) {
                    provider.callbacks[i]();
                }
            });
        }
        if (provider.loaded) {
            callback();
        } else {
            provider.callbacks.push(callback);
        }
    }
}());

ISQ.Widget.Chat.init = function (chatConfigRechanneling, dontCreateInstance,channelObj)
{
    //////////////////////////////////////////////////////////////////////////
    // init
    var chatConfig = chatConfigRechanneling || eval("(" + ISQ.Cnf.chatConfiguration + ")");
    ISQ.Widget.Chat.chatConfig = chatConfig;
    if (dontCreateInstance) return;

    switch (chatConfig.active)
    {
        case "nR":
            ISQ.Widget.Chat.settingUI();
            new ISQ.Widget.Chat.nR(
            {
                account: ISQ.Widget.account,
                config: chatConfig,
                hIncomingMessage: new ISQ.Handler(ISQ.Widget.Chat.incomingMessageHandler),
                hChatStarted: new ISQ.Handler(function(){ISQ.Widget.Chat.chatStartedHandler(channelObj)}),
                hChatEnded: new ISQ.Handler(ISQ.Widget.Chat.chatStoppedHandler),
                hAgentTyping: new ISQ.Handler(ISQ.Widget.Chat.agentTypingHandler),
                hResumingChat: new ISQ.Handler(ISQ.Widget.Chat.chatResumed),
                hChatRequested: new ISQ.Handler(ISQ.Widget.Chat.chatRequested),
                hChatAvailableChanged: new ISQ.Handler(ISQ.Widget.Chat.chatAvailableChanged),
                hConnectionError: new ISQ.Handler(ISQ.Widget.Chat.connectionError)
                ,isDefault: !chatConfigRechanneling
            });
            break;
        case "LP":
            ISQ.Widget.Chat.loadProvider("/widget/scripts/livePersonV3.js", function ()
            {
                ISQ.Widget.Chat.settingUI();
                new ISQ.Widget.Chat.LP(
                {
                    config: chatConfig,
                    hIncomingMessage: new ISQ.Handler(ISQ.Widget.Chat.incomingMessageHandler),
                    hChatStarted: new ISQ.Handler(function(){ISQ.Widget.Chat.chatStartedHandler(channelObj)}),
                    hChatEnded: new ISQ.Handler(ISQ.Widget.Chat.chatStoppedHandler),
                    hAgentTyping: new ISQ.Handler(ISQ.Widget.Chat.agentTypingHandler),
                    hResumingChat: new ISQ.Handler(ISQ.Widget.Chat.chatResumed),
                    hChatRequested: new ISQ.Handler(ISQ.Widget.Chat.chatRequested),
                    hChatAvailableChanged: new ISQ.Handler(ISQ.Widget.Chat.chatAvailableChanged),
                    hConnectionError: new ISQ.Handler(ISQ.Widget.Chat.connectionError),
                    hShowActionBar: new ISQ.Handler(ISQ.Widget.Query.showActionBar)
                    , isDefault: !chatConfigRechanneling
                });
            });

            break;
        case "LiveEngage":
            if (!chatConfig.LiveEngage) return;
            ISQ.Widget.Chat.loadProvider("/widget/scripts/liveengage.js", function ()
            {
                ISQ.Widget.Chat.settingUI();
                new ISQ.Widget.Chat.LiveEngage(
                {
                    config: chatConfig,
                    hChatRequested: new ISQ.Handler(function(requestChatStatus){ISQ.Widget.Chat.chatRequested(requestChatStatus,channelObj)})
                    , isDefault: !chatConfigRechanneling
                });
            });
            break;
        case "SalesForce":
            if (!chatConfig.SalesForce) return;
            ISQ.Widget.Chat.loadProvider("/widget/scripts/salesforce.js", function ()
            {
                ISQ.Widget.Chat.settingUI();
                new ISQ.Widget.Chat.SalesForce(
                {
                    config: chatConfig,
                    hChatRequested: new ISQ.Handler(function(requestChatStatus){ISQ.Widget.Chat.chatRequested(requestChatStatus,channelObj)})
                    , isDefault: !chatConfigRechanneling
                });
            });
            break;
        case "LiveChatInc":
            if (!chatConfig.LiveChatInc) return;
            ISQ.Widget.Chat.loadProvider("/widget/scripts/livechatinc.js", function ()
            {
                ISQ.Widget.Chat.settingUI();
                new ISQ.Widget.Chat.LiveChatInc(
                {
                    config: chatConfig,
                    hChatRequested: new ISQ.Handler(function(requestChatStatus){ISQ.Widget.Chat.chatRequested(requestChatStatus,channelObj)})
                    , isDefault: !chatConfigRechanneling
                });
            });
            break;
        case "SnapEngage":
            if (!chatConfig.SnapEngage) return;
            ISQ.Widget.Chat.loadProvider("/widget/scripts/snapengage.js", function ()
            {
                ISQ.Widget.Chat.settingUI();
                new ISQ.Widget.Chat.SnapEngage(
                {
                    config: chatConfig,
                    hChatRequested: new ISQ.Handler(function(requestChatStatus){ISQ.Widget.Chat.chatRequested(requestChatStatus,channelObj)})
                    , isDefault: !chatConfigRechanneling
                });
            });

            break;
        case "Zopim":
            if (!chatConfig.Zopim) return;
            ISQ.Widget.Chat.loadProvider("/widget/scripts/zopim.js", function ()
            {
                ISQ.Widget.Chat.settingUI();
                new ISQ.Widget.Chat.Zopim(
                {
                    config: chatConfig,
                    hChatRequested: new ISQ.Handler(function(requestChatStatus){ISQ.Widget.Chat.chatRequested(requestChatStatus,channelObj)})
                    , isDefault: !chatConfigRechanneling
                });
            });

            break;
        case "Olark":
            if (!chatConfig.Olark) return;
            ISQ.Widget.Chat.loadProvider("/widget/scripts/olark.js", function ()
            {
                ISQ.Widget.Chat.settingUI();
                new ISQ.Widget.Chat.Olark(
                {
                    config: chatConfig,
                    hChatRequested: new ISQ.Handler(function(requestChatStatus){ISQ.Widget.Chat.chatRequested(requestChatStatus,channelObj)})
                    , isDefault: !chatConfigRechanneling
                });
            });

            break;
        default:
            return;
    }
};

ISQ.Widget.Chat.updateCaptions = function ()
{
    ISQ.Data.autoEllipseText(ISQ.Widget.getStaticText('closeChat'), 69, _('closeChat'));
    _('btnSendChat').value = _('ancEmailChatSend').innerHTML = ISQ.Widget.getStaticText('sendChat');
    _('emailChatLink').innerHTML = ISQ.Widget.getStaticText('emailChat');
    _('ancEmailChatCancel').innerHTML = ISQ.Widget.getStaticText('cancel');
}

ISQ.Widget.Chat.settingUI = function ()
{
    //////////////////////////////////////////////////////////////////////////
    // MOBILE CSS
    ISQ.Widget.Chat.mobileCss = ISQ.Http.browser.isMobile ? " &.mobile" : "";

    // intuitive input
    ISQ.Widget.Chat.intuitiveInput = new ISQ.GUI.IntuitiveInput(
    {
        input: _('txtChatInput'),
        onTimeElapsedHandler: new ISQ.Handler(ISQ.Widget.Chat.chatInput_userTypes),
        enterKeyHandler: new ISQ.Handler(ISQ.Widget.Chat.chatInput_enterKeyup),
        onBeginWritingHandler: new ISQ.Handler(function ()
        {
            // indicating user is writing
            ISQ.Widget.iChat.instance.userTyping(true);
        })
    });

    // texts
    ISQ.Widget.Chat.updateCaptions();
}
ISQ.Widget.Chat.chatResumed = function ()
{
    // resuming chat
    ISQ.Widget.Log.add("resuming chat");

    // showing chat GUI
    ISQ.Widget.Chat.requestChat();
}

//////////////////////////////////////////////////////////////////////////
// requests the chat
ISQ.Widget.Chat.requestChat = function (chatStartAction)
{
    if ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) !== 0) return false; // already in chat mode

    if (!ISQ.Widget.iChat.instance.available())
    {
        this.chatAvailableChanged(false);
        return false;
    }
    else
    {
        ISQ.Widget.Chat.intuitiveInput.enable();
        // setting state
        ISQ.Widget.state = ISQ.Widget.enumState.chat;

        if (typeof (chatStartAction) === 'undefined') chatStartAction = ISQ.Widget.Query.chatEscalationAction || ISQ.Widget.enumChatEscalationActions.normal;
        ISQ.Widget.Chat.chatStartAction = chatStartAction;

        // hiding address bar in mobile
        ISQ.Widget.HTML.Mobile.hideAddressbar();

        return ISQ.Widget.iChat.instance.requestChat();
    }
}
ISQ.Widget.Chat.chatAvailableChanged = function (isAvailable)
{
    var inChat = ISQ.Widget.iChat.instance.inChat() || ISQ.Widget.iChat.instance.resumingChat();
    if (ISQ.Widget.state == ISQ.Widget.enumState.chat && !isAvailable && !inChat)
    {
        ISQ.Widget.Chat.endChat(false, true);
        //ISQ.Widget.Escalate.toEmail();
    }

    // fire event
    if (ISQ.Widget.reportEvents)
        ISQ.Widget.CDC.sendMessage("subject=event&type=chatavailable&value=" + isAvailable);
}
ISQ.Widget.Chat.perpareForIntegratedChat = function (resuming, chatStartAction)
{
    // updating gui for chat
    ISQ.Widget.HTML.searchWrapper.style.display = 'none';
    ISQ.Widget.Suggestions.hide(_('searchSuggestions'));
    ISQ.Widget.HTML.answerPane.style.display = 'none';
    ISQ.Widget.HTML.chatPane.style.display = 'block';

    if (ISQ.Widget.Chat.intuitiveInput) ISQ.Widget.Chat.intuitiveInput.resetValue();

    // send message in dynamic size mode
    ISQ.Widget.HTML.dynamicSize_sendMessage();

    // clearing chat pane
    if (!resuming) clearNode(ISQ.Widget.HTML.chatPane);
}

//////////////////////////////////////////////////////////////////////////
// starts the chat
ISQ.Widget.Chat.chatRequested = function (requestChatStatus,channelObj)
{
    switch (requestChatStatus)
    {
        case ISQ.Widget.iChat.enumRequestChatStatus.inChat:
            return;
            ////////////////// POPUP
        case ISQ.Widget.iChat.enumRequestChatStatus.popup:
            // updating link href (fooling popup blockers)
            _('repByChat').href = arguments[1];

            // hiding action bar
            // when it finished, returning to questions mode
            ISQ.Widget.HTML.hideActionBar(function ()
            {
                ISQ.Widget.state = ISQ.Widget.enumState.questions;
            });

            // updating the server about escalation
            ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.chat, ISQ.Widget.Chat.chatStartAction,null,channelObj ? channelObj.name : null);
            break;
        ////////////////// PRECHAT
        case ISQ.Widget.iChat.enumRequestChatStatus.preChat:
            // send message in float
            if (ISQ.Widget.isFloat) ISQ.Widget.CDC.sendMessage("subject=startChat");

            // hiding auto complete
            ISQ.Widget.Suggestions.hide(_('searchSuggestions'));
            // setting state
            ISQ.Widget.state = ISQ.Widget.enumState.chatSurvey;
            ISQ.Widget.HTML.actionBarQuery.style.display = 'none';
            ISQ.Widget.HTML.chatInputWrapper.style.display = 'none';
            ISQ.Widget.HTML.showActionBar();
            break;
        //////////////// REQUESTING CHAT
        case ISQ.Widget.iChat.enumRequestChatStatus.requestingChat:
            ISQ.Widget.Chat.perpareForIntegratedChat(ISQ.Widget.iChat.instance.resumingChat());

            ISQ.Widget.HTML.actionBarQuery.style.display = 'none';

            // setting state to handle case of after pre-chat survey
            ISQ.Widget.state = ISQ.Widget.enumState.chat;
            // show chat status
            ISQ.Widget.HTML.chatStatus.innerHTML = ISQ.Widget.HTML.chatStatus.originalText = (ISQ.Widget.Chat.chatConfig && ISQ.Widget.Chat.chatConfig.initialStatus) ? ISQ.Widget.Chat.chatConfig.initialStatus : ISQ.Widget.getStaticText('chatCallingStatus');

            // show chat status
            _('chatStatusWrapper').style.display = 'block';
            ISQ.Widget.HTML.Mobile.setScrollPaddingHeight(true);

            // show chat action bar & footer link
            ISQ.Widget.HTML.showActionBar();
            if (ISQ.Widget.iChat.instance.supportingEmailChat() && !ISQ.Widget.Chat.chatConfig.hideSendToEmail)
                _('emailChatLink').style.display = 'block';
            else
                _('emailChatLink').style.display = 'none';
            _('actionBarChat').style.display = 'block';

            //_('footerChatLink').style.display = 'block';
            if (ISQ.Cnf.customerBrandingLogo)
                _('customerLogo').style.display = 'none';
            if (ISQ.Cnf.customerBrandingText)
                _('customerBrandingText').style.display = 'none';

            // show chat input
            ISQ.Widget.HTML.chatInputWrapper.style.display = 'block';

            // IPHONE: working around a bug which click on the chat-input-box invoked footer links clicks
            if (ISQ.Http.browser.isIPhone)
                ++document.body.scrollTop;

            // send message in float
            if (ISQ.Widget.isFloat) ISQ.Widget.CDC.sendMessage("subject=startChat");

            // resize
            ISQ.Widget.HTML.resizeHandler();

            // sending the message in query input
            ISQ.Widget.iChat.instance.sendMessage(_query(true));

            // send message in dynamic size mode
            ISQ.Widget.HTML.dynamicSize_sendMessage();

            // event
            if (ISQ.Widget.reportEvents)
                ISQ.Widget.CDC.sendMessage("subject=event&type=requestChat");

            // appending user's line
            if (ISQ.Widget.iChat.instance.userActive())
            {
                clearNode(_('chatPane'));
                ISQ.Widget.Chat.appendMyLine(_query(true));
            }
            break;
        ////////////////// CHAT
        case ISQ.Widget.iChat.enumRequestChatStatus.newChat:

            break;
        case ISQ.Widget.iChat.enumRequestChatStatus.resumingChat:
            ISQ.Widget.CDC.sendMessage("subject=chatResumeRequest");
            break;
    }
}
ISQ.Widget.Chat.resumeChat = function (inResume)
{
    if (inResume)
    {
        var pendingMessages = ISQ.Widget.iChat.instance.pendingMessages();
        if (pendingMessages) _it(pendingMessages, function (messageObj)
        {
            ISQ.Widget.Chat.incomingMessageHandler(messageObj);
        });
    }
}
ISQ.Widget.Chat.preventChatResuming = function ()
{
    ISQ.Widget.iChat.instance.setChatNotActive();
    ISQ.Widget.Chat.endChat(false, true);
    return false;
}
ISQ.Widget.Chat.incomingMessageHandler = function (messageObj)
{
    var text = new Array();
    var div;
    var chatStatusSystem = _("chatStatusSystem");
    switch (messageObj.type)
    {
        // answer by id
        case ISQ.Widget.iChat.enumMessageType.visitor_id:
        case ISQ.Widget.iChat.enumMessageType.agent_id:
            ISQ.Widget.Chat.appendSuggestionsToGUI(messageObj);
            break;
        case ISQ.Widget.iChat.enumMessageType.visitor_text:
            // adding user line only if resuming chat
            if (messageObj.resuming)
                ISQ.Widget.Chat.appendMyLine(messageObj.text);
            // removing system alert line for arcade skin
            clearNode(chatStatusSystem);
            return;
        case ISQ.Widget.iChat.enumMessageType.agent_text:
            // removing system alert line for arcade skin
            clearNode(chatStatusSystem);
            var elementId = 'chatLine_' + Math.floor(Math.random() * 1000000);
            var chatLine = createDiv(null, '.chatLine');
            createDiv(chatLine, ".agentIcon");
            div = createDiv(chatLine, ".padded " + ISQ.Widget.Chat.mobileCss + " &.agent");
            div.id = elementId;
            text.push("<span class='chatAgentName'>");
            text.push(ISQ.Widget.iChat.instance.agentName());
            text.push(":</span> ");
            text.push(messageObj.text);
            div.innerHTML = text.join('');

            // adding agent text
            ISQ.Widget.Chat.appendLine(chatLine, elementId);

            // sending data to server
            //if (!ISQ.Widget.iChat.instance.inChat()) break;

            // sending to server
            //_session().sendChatLine(ISQ.Widget.Chat.enumChatLineType.agent, messageObj.text);

            break;
        case ISQ.Widget.iChat.enumMessageType.system:
            //return;
            var elementId = 'chatLine_' + Math.floor(Math.random() * 1000000);

            div = createDiv(null, ".padded chatSysMsg");
            div.id = elementId;
            div.innerHTML = messageObj.text;

            // adding system alert message to the status line
            chatStatusSystem.style.display = 'block';
            clearNode(chatStatusSystem);
            chatStatusSystem.appendChild(div);
            break;
    }

    // must resize because systemMessages may have been cleared
    ISQ.Widget.HTML.resizeHandler();
}
ISQ.Widget.Chat.chatStartedHandler = function (channelObj)
{
    // updating the server about escalation
    if (!ISQ.Widget.iChat.instance.resumingChat()) ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.chat, ISQ.Widget.Chat.chatStartAction,null,channelObj ? channelObj.name : null);

    // updating html
    ISQ.Widget.HTML.chatStatus.innerHTML = ISQ.Widget.HTML.chatStatus.originalText = ISQ.Widget.getStaticText('chattingNow') + '<span dir="ltr" class="chatStatusAgentName">' + ISQ.Widget.iChat.instance.agentName() + '</span>';

    // opera browser doesn't support body.onunload event.
    // thus, if session is logged, saving the cookie now.
    // If session isn't logged yet, saving the cookie on login.
    //if (ISQ.Http.browser.app === 'opera' && _session().state() === ISQ.Com.JsonP.Client.enumState.CONNECTED) ISQ.Widget.Chat.saveCookie();

    if (ISQ.Http.browser.isIE9) // #3168 - IE9 needs to be reminded of overflow definition otherwise scrollbars aren't shown
        ISQ.Widget.HTML.contentWrapper.style.overflow = 'auto';

    // scroll chat to bottom when resuming
    if (ISQ.Widget.iChat.instance.resumingChat()) ISQ.Widget.HTML.scrollContentToBottom();

    // open connection
    _session().keepAlive();
}
ISQ.Widget.Chat.agentTypingHandler = function (isTyping)
{
    if (!isTyping)
    {
        ISQ.Widget.HTML.chatStatus.className = 'agentTyping';
        ISQ.Widget.HTML.chatStatus.innerHTML = ISQ.Widget.getStaticText('chattingNow') + '<span dir="ltr" class="chatStatusAgentName">' + ISQ.Widget.iChat.instance.agentName() + '</span>';
    }
    else
    {
        ISQ.Widget.HTML.chatStatus.className = '';
        ISQ.Widget.HTML.chatStatus.innerHTML = ISQ.Widget.iChat.instance.agentName() + ISQ.Widget.getStaticText('chatTyping');
    }
}
ISQ.Widget.Chat.chatStoppedHandler = function (chatMoved)
{
    if ((ISQ.Widget.state & ISQ.Widget.enumState.allChat) === 0) return;

    if (chatMoved)
    {
        ISQ.Widget.Chat.endChat(false, true);
    }
    else
    {
        ISQ.Widget.state = ISQ.Widget.enumState.chatEnded;
        ISQ.Widget.HTML.chatStatus.innerHTML = ISQ.Widget.getStaticText('chatClosed');
        _('chatPane').innerHTML += ISQ.Widget.getStaticText('chatClosed') + ".<br/>";
        ISQ.Widget.Chat.intuitiveInput.disable();
        //ISQ.Http.Cookies._delete(ISQ.Widget.Chat.cookieName, "/widget", ISQ.Http.domain(false), false);
    }

    // stopping OC
    _session().stopKeepAlive();
}
ISQ.Widget.Chat.connectionError = function ()
{
    ISQ.Widget.HTML.chatStatus.innerHTML = ISQ.Widget.getStaticText('chatConnectionError');
    _('chatPane').innerHTML += ISQ.Widget.getStaticText('chatConnectionError') + ".<br/>";
}

// #region server suggestions
ISQ.Widget.Chat.ignoreSendingLineOnEnter = false;
ISQ.Widget.Chat.pendingSuggestions = null; // an array holding quick answers that wasn't sent to representative
ISQ.Widget.Chat.hideSuggestionDiv = function ()
{
    ISQ.Widget.Chat.ignoreSendingLineOnEnter = false;

    if (ISQ.Http.browser.isIE7 || ISQ.Http.browser.isIE6)
    {
        if (ISQ.Widget.isFloat)
            ISQ.Widget.HTML.footerWrapper.style.visibility = "visible";
        else if (ISQ.Widget.Chat.widgetFooterContent)
            ISQ.Widget.HTML.widgetFooter.innerHTML = ISQ.Widget.Chat.widgetFooterContent;
    }

    //
    //if (ISQ.Http.browser.isMobile)
    //ISQ.Widget.HTML.Mobile.setScrollPaddingHeight();
}
// #endregion

//#region chat messages / quick answers

ISQ.Widget.Chat.chatInput_userTypes = function (text, changed)
{
    // indicating user has stopped typing
    ISQ.Widget.iChat.instance.userTyping(false);

    // text wasn't changed
    if (!changed) return;
    if (!text)
    {
        ISQ.Widget.Suggestions.hide(_('chatSuggestions'));
        ISQ.Widget.Chat.hideSuggestionDiv(); // no text - hiding suggestions
        return;
    }


    ISQ.Widget.Suggestions.request(text,
    {
        container: _('chatSuggestions'),
        maxResults: 2,
        eventsHandler: function (type, id, title)
        {
            if (type !== 'click') return;

            // hiding suggestions
            ISQ.Widget.Chat.hideSuggestionDiv();

            // resetting user's text
            ISQ.Widget.Chat.intuitiveInput.resetValue();

            // requesting for answer
            _session().request(
            {
                url: "a.js",
                params:
                {
                    requestId: ++ISQ.Widget.Query.activeRequestId,
                    answerId: id,
                    "auto": false,
                    "src": "chat"
                },
                handler: ISQ.Widget.Chat.getAnswerById_response
            });

            // appending quick answer
            //ISQ.Widget.Chat.quickAnswerPicked({ id: id, title: title, body: summary, attachments: attachments });
        },
        documentEventsHandler: function (type, selectedResult)
        {
            if (type === "up" && selectedResult === -1)
                ISQ.Widget.Chat.ignoreSendingLineOnEnter = false;
            else if (type === "down")
                ISQ.Widget.Chat.ignoreSendingLineOnEnter = true;
        },
        onDrawHandler: function ()
        {
            // user probably sent the text. thus suggestions are irrelevant
            if (!ISQ.Widget.Chat.intuitiveInput.value()) ISQ.Widget.Chat.hideSuggestionDiv();

            //////////////////////////////////////////////////////////////////////////
            // Mobile: setting chat suggestions position to be higher than chat textbox
            if (ISQ.Http.browser.isMobile)
            {
                var h = ISQ.CSS.getElementHeight(_('chatSuggestions'), true);
                _('chatSuggestions').style.top = (-h) + "px";
            }

            // in lesser browsers, hide footer due to position relative bug (#3164)
            if (ISQ.Http.browser.isIE7 || ISQ.Http.browser.isIE6)
            {
                if (ISQ.Widget.isFloat)
                    ISQ.Widget.HTML.footerWrapper.style.visibility = "hidden";
                else
                {
                    ISQ.Widget.Chat.widgetFooterContent = ISQ.Widget.HTML.widgetFooter.innerHTML;
                    ISQ.Widget.HTML.widgetFooter.innerHTML = "";
                }
            }
        },
        verbose: true
    });
}
ISQ.Widget.Chat.chatInput_enterKeyup = function ()
{
    if (ISQ.Widget.Chat.ignoreSendingLineOnEnter) return false;
    ISQ.Widget.Chat.sendLine();
}

ISQ.Widget.Chat.quickAnswerPicked = function (messageObject)
{
    // appending answer
    ISQ.Widget.Chat.appendSuggestionsToGUI(messageObject);

    // sending answer
    ISQ.Widget.iChat.instance.sendAnswerId(messageObject);
}
ISQ.Widget.Chat.sendButtonClicked = function ()
{
    ISQ.Widget.Suggestions.hide(_('chatSuggestions'));
    ISQ.Widget.Chat.sendLine();
}

ISQ.Widget.Chat.sendLine = function ()
{
    ISQ.Widget.Chat.hideSuggestionDiv();

    // sending data
    var line = _('txtChatInput').value.Trim();
    if (!line) return;
    ISQ.Widget.Chat.intuitiveInput.resetValue();

    // block credit card numbers?
    if (ISQ.Cnf.blockCreditCardNumbers)
        line = ISQ.Data.blockCreditCardNumbers(line, ISQ.Widget.ContactForm.blockedCreditCardReplacement);

    // adding data to chat window
    ISQ.Widget.iChat.instance.sendMessage(line);
    ISQ.Widget.Chat.appendMyLine(line);
}

//////////////////////////////////////////////////////////////////////////
// appends a suggested nanoRep answer to the chat pane
ISQ.Widget.Chat.appendSuggestionsToGUI = function (messageObject)
{
    if (!messageObject.body) return;

    var txt = ISQ.Data.getDBAnswerAsHtml(messageObject.body, false, ISQ.Widget.Chat.appendLinksToNanoRepQuestions, null, null, ISQ.Widget.referer.normal).text;
    txt = txt.replaceAll(ISQ.Tools.pagerSeperator, '');

    var expIconWidth = "";
    var uniqueId = ISQ.Data.uniqueId();
    div = createDiv(null, ".quickAnswer");
    div.id = 'chatSDiv_' + uniqueId;

    var text = new Array();
    text.push("<div class='quickAnswerHeading'>");
    text.push(ISQ.Widget.getStaticText('quickAnswer'));
    text.push("</div> ");
    text.push("<div class='quickAnswerContainer'>");
    text.push("<table cellpadding='0' cellspacing='0'>");
    text.push("<tr valign='top' onclick='ISQ.Widget.Chat.toggleQuickAnswer(\"" + uniqueId + "\")' style='cursor:pointer'>");
    text.push("<td class='quickAnswerExpandIcon'><div class='quickAnswerExpand' id='quickAnswerExpand_" + uniqueId + "'></div></td>");
    text.push("<td class='quickAnswerTitle'>");
    text.push(messageObject.title);
    text.push("<td></tr></table>");
    text.push("<div class='quickAnswerBody' id='quickAnswerBody_" + uniqueId + "'>");
    text.push(txt);
    text.push("</div>");
    text.push("</div>");

    // appending attachments

    div.innerHTML = text.join('');
    if (messageObject.attachments) ISQ.Widget.Query.appendAttachments(messageObject.attachments, div);

    ISQ.Widget.Chat.appendLine(div, div.id);

    // collapse the quick answer
    ISQ.Widget.Chat.toggleQuickAnswer(uniqueId);
}

//////////////////////////////////////////////////////////////////////////
// appends a nanoRep question as a link which will be added to the chat when clicked
ISQ.Widget.Chat.appendLinksToNanoRepQuestions = function (stringBuilder, answerId, text)
{
    var id = "linkToAnswer_" + (ISQ.Widget.Chat.linksToAnswersBaseId++);
    stringBuilder.push("<a id='");
    stringBuilder.push(id);
    stringBuilder.push("' href='javascript:void(0)' onclick='ISQ.Widget.Chat.questionLinkClicked(this, \"");
    stringBuilder.push(answerId);
    stringBuilder.push("\")'>");
    stringBuilder.push(text);
    stringBuilder.push("</a>");
}
ISQ.Widget.Chat.questionLinkClicked = function (lnk, answerId)
{
    // making sure link isn't processed twice
    if (!ISQ.Widget.Chat.selectedLinksToAnswers) ISQ.Widget.Chat.selectedLinksToAnswers = new Array();
    if (ISQ.Widget.Chat.selectedLinksToAnswers[lnk.id] === true) return;
    ISQ.Widget.Chat.selectedLinksToAnswers[lnk.id] = true;

    // requesting for answer
    _session().request(
    {
        url: "a.js",
        params:
        {
            requestId: ++ISQ.Widget.Query.activeRequestId,
            answerId: answerId,
            "auto": false,
            "src": "chat_link"
        },
        handler: ISQ.Widget.Chat.getAnswerById_response
    });
}
ISQ.Widget.Chat.getAnswerById_response = function (status, jsonObject)
{
    // not in chat state, returning
    if ((ISQ.Widget.state & ISQ.Widget.enumState.chat) === 0) return;

    if (jsonObject.requestId != ISQ.Widget.Query.activeRequestId)
    {
        ////////////	Debug	//////////////////////
        ISQ.Widget.Log.add('Chat question link response: Request Id doesn\'t match. sent: ' + ISQ.Widget.Query.activeRequestId + ", received: " + requestId);
        return;
    }

    //
    jsonObject = jsonObject.answers[0];

    // quick answer was picked
    ISQ.Widget.Chat.quickAnswerPicked({ id: jsonObject.id, title: jsonObject.title, body: jsonObject.summary, attachments: jsonObject.attachments });
}
ISQ.Widget.Chat.appendMyLine = function (txt)
{
    if (!txt) return;

    var html = new Array();
    var uniqueId = Math.floor(Math.random() * 1000000);
    var elementId = 'chatLine_' + uniqueId;

    var chatLine = createDiv(null, '.chatLine');
    createDiv(chatLine, ".clientIcon");
    var div = createDiv(chatLine, ".padded " + ISQ.Widget.Chat.mobileCss + " &.client");
    div.id = elementId;
    div.uniqueId = uniqueId;

    html.push("<b class='chatMe'>");
    html.push(ISQ.Widget.Localize.array["me"]);
    html.push(":</b> ");
    html.push(txt);
    div.innerHTML = html.join('');

    // adding chat line
    ISQ.Widget.Chat.appendLine(chatLine, elementId);

    // sending to server
    //if (ISQ.Widget.iChat.instance.inChat()) _session().sendChatLine(ISQ.Widget.Chat.enumChatLineType.user, txt);

    return div;
}
ISQ.Widget.Chat.appendLine = function (elm, elementId)
{
    var chatDiv = _('chatPane');
    var wrapper = ISQ.Widget.HTML.contentWrapper;
    chatDiv.appendChild(elm);

    // fixing chat width for IE6,7
    ISQ.Widget.HTML.fixContentWidths();

    // performing auto scroll
    if (elementId)
    {
        // if float mobile
        if (ISQ.Http.browser.isMobile && (window.top === window || self === self.top || ISQ.Widget.isFullScreen))
        {
            var isFirefox = ISQ.Http.browser.app == "ff"; //#8611 (no body.scrollTop on FF)
            // getting element's top
            var pos = ISQ.Html.position(elementId);
            // getting visual viewport
            var screenSize = ISQ.Html.screenSize();
            screenSize.h -= (ISQ.Widget.HTML.Mobile.incrementedBottom + 50);
            var top = isFirefox ? document.documentElement.scrollTop : document.body.scrollTop;
            var btm = top + screenSize.h;

            if (pos.y < top || pos.y > btm)
            {
                if (isFirefox)
                    document.documentElement.scrollTop = pos.y;
                else
                    document.body.scrollTop = pos.y;
            }
        }
        // any other scenario
        else
        {
            // in android 3 embed widget if you scroll to the top of the chat
            // the messages will not jump to the place
            var scrollHeight = chatDiv.scrollHeight;
            var viewableHeight = wrapper.offsetHeight;
            if (scrollHeight > viewableHeight)
            {
                wrapper.scrollTop = _(elementId).offsetTop - chatDiv.offsetTop;
            }
        }
    }
}
ISQ.Widget.Chat.toggleQuickAnswer = function (suggestionId)
{
    var expandDiv = _('quickAnswerExpand_' + suggestionId);
    var bodyDiv = _('quickAnswerBody_' + suggestionId);

    if (bodyDiv.style.display === 'none')
    {
        bodyDiv.style.display = 'block';
        expandDiv.className = 'quickAnswerExpand';
    }
    else
    {
        bodyDiv.style.display = 'none';
        expandDiv.className = 'quickAnswerExpand quickAnswerCollapsed';
    }
}

//#endregion

//#region chat surveys
ISQ.Widget.Chat.prepereSurveyPane = function ()
{
    ISQ.Widget.state = ISQ.Widget.enumState.chatSurvey;
    ISQ.Widget.HTML.answerPane.style.display = 'none';
    ISQ.Widget.HTML.searchWrapper.style.display = "none";
    clearNode(ISQ.Widget.HTML.chatPane);
    ISQ.Widget.HTML.chatPane.style.display = 'block';
    ISQ.Widget.Suggestions.hide(_('chatSuggestions'));
    ISQ.Widget.HTML.actionBarQuery.style.display = 'none';
    ISQ.Widget.HTML.chatInputWrapper.style.display = 'none';
    ISQ.Widget.HTML.showActionBar();

}
//#endregion

//#region end chat

//////////////////////////////////////////////////////////////////////////
// ends the chat
ISQ.Widget.Chat.endChat = function (fromPreChatSurvey, dontShowConfirm)
{
    if (!dontShowConfirm && !fromPreChatSurvey && !confirm(ISQ.Widget.Localize.array["confirmEndChat"])) return;

    ISQ.Widget.iChat.instance.endChat();
    ISQ.Widget.Suggestions.hide(_('chatSuggestions'));

    // indicating chat was resumed
    var chatWasResumed = !fromPreChatSurvey && (!_query(true) || !ISQ.Widget.userActive);

    // resetting pending suggestions
    ISQ.Widget.Chat.pendingSuggestions = null;

    // hide chat status
    ISQ.Widget.HTML.searchWrapper.style.display = 'block';
    _('chatStatusWrapper').style.display = 'none';
    ISQ.Widget.HTML.Mobile.setScrollPaddingHeight(false);
    // setting focus to search bar
    try
    {
        ISQ.Widget.Query.setFocus();
    }
    catch (e) { }
    // if chat wasn't resumed showing last answers.
    if (!chatWasResumed) ISQ.Widget.HTML.answerPane.style.display = 'block';
    // hide chat area
    _('chatPane').style.display = 'none';

    // scroll up
    ISQ.Widget.HTML.contentWrapper.scrollTop = 0;

    // hide chat action bar and showing question action bar
    // only if input field is NOT empty (will be empty if chat resuming)
    if (!chatWasResumed && _query(true, false) && ISQ.Widget.userActive)
    {
        ISQ.Widget.HTML.showActionBar();
    }
    else
    {
        ISQ.Widget.HTML.hideActionBar(null, true);
    }

    ISQ.Widget.HTML.actionBarQuery.style.display = 'block';
    _('actionBarChat').style.display = 'none';
    _('footerChatLink').style.display = 'none';

    if (ISQ.Cnf.customerBrandingLogo)
        _('customerLogo').style.display = 'block';
    if (ISQ.Cnf.customerBrandingText)
        _('customerBrandingText').style.display = 'block';

    // hide chat input
    ISQ.Widget.HTML.chatInputWrapper.style.display = 'none';

    // restore paged answer scrolls
    if (ISQ.Widget.HTML.answerPane.restorePagerScroll)
        ISQ.Widget.HTML.answerPane.restorePagerScroll();

    // send message in float
    if (ISQ.Widget.isFloat) ISQ.Widget.CDC.sendMessage("subject=endChat");

    // resize
    ISQ.Widget.HTML.resizeHandler();

    // dynamic size
    ISQ.Widget.HTML.dynamicSize_sendMessage();

    // setting mode
    ISQ.Widget.state = ISQ.Widget.enumState.questions;

    // show faq if user wasn't active (eg chat opened via api)
    if (!ISQ.Widget.userActive && !ISQ.Widget.FAQ.shown) ISQ.Widget.FAQ.show(ISQ.Widget.FAQ.behavior.OnNoResuls);

    // stopping open connections
    //_session().stopOpenConnection();

    // hide send chat by email txt container
    ISQ.Widget.Chat.emailChat_txtToggle(false);

    // notifying server chat was ended
    //_session().chatEnded();
}

//////////////////////////////////////////////////////////////////////////
// page unload behaviour
ISQ.Widget.Chat.pageUnload = function ()
{
//    if (!ISQ.Widget.LP.inChat) return;
//    if (!_session().connected()) return;

//    // saving cookie for resuming the chat later
//    ISQ.Widget.Chat.saveCookie();
}

//#endregion

//#region email chat

//////////////////////////////////////////////////////////////////////////
// shows the email chat textbox
ISQ.Widget.Chat.emailChat_Show = function ()
{
    // set default text in textbox
    ISQ.Widget.HTML.txtEmailChat.defaultValue = ISQ.Widget.HTML.txtEmailChat.value = ISQ.Widget.Localize.array["enterEmail"];

    // show txt container
    ISQ.Widget.Chat.emailChat_txtToggle(true);
}

//////////////////////////////////////////////////////////////////////////
// hides the email chat textbox
ISQ.Widget.Chat.emailChat_Hide = function ()
{
    // show txt container
    ISQ.Widget.Chat.emailChat_txtToggle(false);
}

//////////////////////////////////////////////////////////////////////////
// focus on email chat txtbox
ISQ.Widget.Chat.emailChat_txtFocus = function ()
{
    if (ISQ.Widget.HTML.txtEmailChat.value == ISQ.Widget.HTML.txtEmailChat.defaultValue)
        ISQ.Widget.HTML.txtEmailChat.value = '';
}

//////////////////////////////////////////////////////////////////////////
// blur on email chat txtbox
ISQ.Widget.Chat.emailChat_txtBlur = function ()
{
    if (ISQ.Widget.HTML.txtEmailChat.value == '')
        ISQ.Widget.HTML.txtEmailChat.value = ISQ.Widget.HTML.txtEmailChat.defaultValue;
}

//////////////////////////////////////////////////////////////////////////
// toggles email chat textbox on/off
ISQ.Widget.Chat.emailChat_txtToggle = function (on)
{
    if (ISQ.Widget.Chat.chatConfig.hideSendToEmail)
    {
        _('emailChatLink').style.display = 'none';
        _('emailChatContainer').style.display = 'none';
    }
    else if (on)
    {
        _('emailChatLink').style.display = 'none';
        _('emailChatContainer').style.display = 'block';
    }
    else
    {
        _('emailChatLink').style.display = 'block';
        _('emailChatContainer').style.display = 'none';
    }
}

//////////////////////////////////////////////////////////////////////////
// email chat send button clicked
ISQ.Widget.Chat.emailChat_Send = function ()
{
    // disabled by configuration
    if (ISQ.Cnf.chatHideSendToMail) return;

    var email = ISQ.Widget.HTML.txtEmailChat.value;
    if (!email) return;
    if (!ISQ.Data.checkString(email, 'email'))
    {
        alert(ISQ.Widget.Localize.array["emailValidation"]);
        return;
    }

    ISQ.Widget.iChat.instance.emailChat(email);

    alert(ISQ.Widget.getStaticText('emailChatSent'));

    // hide txt container
    ISQ.Widget.Chat.emailChat_txtToggle(false);
}

//#endregion

//#endregion

/********************************************************
//////////////////// [ ENUMS ] //////////////////////////
********************************************************/
//#region Enums
ISQ.Widget.enumCustomLinkTarget =
{
    CurrentPage: 0,
    NewTab: 1,
    Popup: 2,
    Widget: 3
}
ISQ.Widget.enumShowChatConfiguration =
{
    always: 0,
    selectedAnswers: 1,
    selectedAnswers_and_noAnswers: 2
}
ISQ.Widget.enumChatEscalationActions =
{
    hide: 0,
    normal: 1,
    showChatOption: 2,
    inviteChat: 3,
    pushChat: 4
}
ISQ.Widget.enumCustomLinkStats =
{
    none: 0,
    countTicketEscalation: 1,
    countChatEscalation: 2
}
ISQ.Widget.enumKBCategoriesFlags =
{
    none: 0,
    visibleInWidget : 1,
    autoLearn : 2,

    all : 3 // 1+2
}
//#endregion


/********************************************************
//////////////////// [ API ] //////////////////////////
********************************************************/
// #region API
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!! DUPLICATED TO tools.js !!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!! ANY IMPLEMENTED FUNCTION !!!!!!!!!!!!!!!!!!!!!!!!
// !!!!!!!!!!!!!! SHOULD BE IMPLEMENTED IN tools.js ALSO !!!!!!!
// !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
ISQ.Widget.API = initializeNS('ISQ.Widget.API'); ;
ISQ.Widget.API.customParams = null;
ISQ.Widget.API.getCurrentURL = function ()
{
    return ISQ.Widget.referer.normal;
}
ISQ.Widget.API.getCustomParams = function ()
{
    return ISQ.Widget.API.customParams || {};
}
ISQ.Widget.API.openContactForm = function ()
{
    ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.email);
}
ISQ.Widget.API.updateContext = function (newContext, clearContext)
{
    var currentContexts = null;
    if (!clearContext) currentContexts = _session().contexts();

    // no current contexts or clearing current context,
    // setting newContext
    if (!currentContexts || clearContext === true)
    {
        currentContexts = newContext;
    }
    else // appending newContext to currentContext
    {
        for (var category in newContext)
            currentContexts[category.toLowerCase()] = newContext[category];
    }

    _session().setContext(currentContexts || []);
}
ISQ.Widget.API.reAsk = function ()
{
       ISQ.Widget.Query.timerElapsedHandler(_query(true), true)
}
/* !!! IMPORTANT FUNCTION - DO NOT DELETE !!! */
ISQ.Widget.API.runPageScript = function (str)
{
    // #7129
    if (!str) return;
    ISQ.Widget.CDC.sendMessage("subject=pagescript&data=" + ISQ.Tools.Base64.encodeString(str));
}
// #endregion

ISQ.Widget.FAQ = initializeNS('ISQ.Widget.FAQ');
ISQ.Widget.FAQ.shown = false;
ISQ.Widget.FAQ.show = function () { };
ISQ.Widget.FAQ.initEnum = { none: 0, loading: 1, loaded: 2 };
ISQ.Widget.FAQ.scriptLoadState = ISQ.Widget.FAQ.initEnum.none;
//ISQ.Widget.FAQ.pendingFAQCallback = null;
ISQ.Widget.FAQ.pendingFAQCallbackList = [];
ISQ.Widget.FAQ.pendingFAQCallback = function()
{
    var callbacksLength = ISQ.Widget.FAQ.pendingFAQCallbackList.length;
    if (callbacksLength)
    {
        for(var i = 0;i < callbacksLength;i++)
            ISQ.Widget.FAQ.pendingFAQCallbackList[i]();
    }
}

// include FAQ script statically instead of evaluating it from Cnf
/********************************************************
///////////////////// [ FAQ ] ///////////////////////////
********************************************************/
//#region FAQ

ISQ.Widget.FAQ.shown = false;
ISQ.Widget.FAQ.handleCnfData = function ()
{
    var data = ISQ.Cnf.faqData;
    if (!data || typeof (data) !== 'string') return;

    if (ISQ.Widget.isContained) return; // container (float or embed) will notify via postMesssge

    // request the data
    nanoRep.FAQ.requestFaqLists
        ({
            host: window.location.protocol + "//" + ISQ.Http.domain(true),
            account: ISQ.Widget.account,
            kb: ISQ.Http.hashArguments["kb"] || ISQ.Http.urlArguments["kb"],
            referer: ISQ.Widget.referer.normal,
            context: _session().contexts(),
            isFloat: ISQ.Widget.isFloat,
            faqData: data,
            callback: ISQ.Widget.FAQ.dataReady,
            disableContextCombine: true,
            configId: ISQ.Widget.configId
        });
}

ISQ.Widget.FAQ.dataReady = function (data)
{
    if (!data) return;

    // callback function may be saved in current object 
    var callback = ISQ.Cnf.faqData.callback;

    // eval and save into ISQ.Cnf.faqData
    if (typeof (data) === 'string') ISQ.Cnf.faqData = eval("(" + data + ")");
    else ISQ.Cnf.faqData = data;

    if (callback) callback();
}

ISQ.Widget.FAQ.show = function (when)
{
    var data = ISQ.Cnf.faqData;
    if (!data) return;
    if (typeof (data) === 'string')
    {
        // it's string when pending request for faqList
        ISQ.Cnf.faqData = { callback: function () { ISQ.Widget.FAQ.show(when); } };
        return;
    }

    var shown = [];
    var resizeWidget = false;
    for (var i in data)
    {
        // when to show
        if (data[i].behavior != null && ((data[i].behavior & when) == 0)) continue;
        if (!data[i].data.length || !data[i].data[0].data.length) continue;
        shown[0] = true;

        // title
        if (data[i].title)
        {
            createDiv(ISQ.Widget.HTML.answerPane, '.faqTitle').innerHTML = "<h2>" + data[i].title + "</h2>";

        }

        for (var j in data[i].data[0].data)
        {
            var faqObj = data[i].data[0].data[j];

            // don't show the same answer more than once
            if (shown[faqObj.objectId]) continue;
            shown[faqObj.objectId] = true;

            // answer obj
            var answerObject =
            {
                title: faqObj.label,
                id: faqObj.objectId,
                likes: faqObj.likes,
                summary: null,
                answerNum: j
            }

            ISQ.Widget.Query.appendSingleAnswer(
                    {
                        answerObject: answerObject,
                        footer: null,
                        visible: true,
                        collapsed: true,
                        isFAQ: true,
                        style: '.faq',
                        direction: ISQ.Translation.Infra.getLanguageDirection(ISQ.Widget.TranslationHelper.detectedLanguage || ISQ.Cnf.initialUiLanguage) // due to incorrect direction when translating, #8795
                    });
            switch (answerObject.externalSourceType)
            {
                case ISQ.enumContentProviders.worldManuals:
                    resizeWidget = true;
                    break;
            }
        }
    }

    if (resizeWidget && ISQ.Widget.isFloat)
    {
        var elements = ISQ.Html.getElementsByClassName(ISQ.Widget.HTML.widgetContainer, "hoverImagesClass");
        if (elements.length > 0)
            ISQ.Widget.CDC.sendMessage("subject=setSize&height=" + ISQ.Export.currentHeight + "&width=" + ISQ.Export.currentWidth);
        else
            ISQ.Widget.CDC.sendMessage("subject=widgetToExpand");
    }

    // showing only in correct state
    if (shown.length > 0 && (ISQ.Widget.state & ISQ.Widget.enumState.allQuestions) !== 0)
    {
        ISQ.Widget.FAQ.shown = true;
        ISQ.Widget.state = ISQ.Widget.enumState.questions;
        ISQ.Widget.Query.displayAnswers(_query(true).length === 0);
    }
};
// building feedback in the article format when opening the faq
ISQ.Widget.FAQ.BuildThumbsForFAQarticle = function (results, tbody, likeIcon)
{
    var summaryTr = tbody;

    var likeIconContainer = likeIcon.parentNode;
    var initialContainer = likeIconContainer.parentNode;
    // taking the tbody of the element so we can add a new row 
    while (tbody.nodeName != "TBODY" && tbody.parentNode)
    {
        tbody = tbody.parentNode;
    }
    var row = createRow(tbody);
    var td = createTd(row, '', '', '.likesDefaultPadding&.faqLikesPadding');
    // creating containers for the like and dislikes
    var likesContainer = createDiv(td, ".articlelikeContainer");
    var likeDiv = createDiv(likesContainer, ".iLike");
    var dislikeDiv = createDiv(likesContainer, ".iDontLike");

    // saving the data in the summaryTr for future use ( close and reopen the faq )
    summaryTr.likes = {};
    summaryTr.likes.results = results;
    summaryTr.likes.currentContainer = row;
    summaryTr.likes.likeContainer = likeDiv;
    summaryTr.likes.likeIcon = likeIcon;
    summaryTr.likes.initialContainer = initialContainer;

    likeDiv.appendChild(likeIconContainer);
    nanoRep.FAQ.Likes.buildThumbDownIcon(results[0].id, dislikeDiv, likeIcon, false, ISQ.Cnf.cacheVar, ISQ.Widget.account, ISQ.Cnf.kbId, ISQ.Widget.isPreview, null, ISQ.Widget.referer.normal);
}
// removing the feedback from the faq and bringing it back to the faq question 
ISQ.Widget.FAQ.removeThumbsForFAQarticle = function (tbody)
{
    if (tbody.likes)
    {
        var originalContainer = tbody.likes.initialContainer;
        originalContainer.appendChild(tbody.likes.likeContainer);
        tbody.likes.currentContainer.parentNode.removeChild(tbody.likes.currentContainer);
    }
}

// called by answer request callback
ISQ.Widget.FAQ.buildAnswer = function (results, titleTd, likeIcon, tbody)
{
    if (ISQ.Widget.HTML.searchAnim) ISQ.Widget.HTML.searchAnim.hide();

    // answer text
    var parsedSummary = ISQ.Data.getDBAnswerAsHtml(results[0].summary, false, ISQ.Widget.Query.appendQuestionTag, null, 'ISQ.Widget.Query.namedAnchorClick', ISQ.Widget.referer.normal);
    var replacerResult = ISQ.Widget.replacePlaceholders(parsedSummary.text, ISQ.Widget.API.getCustomParams(), "{{", "}}");

    if (replacerResult.success) parsedSummary.text = replacerResult.text;

    var answerScript = null;
    if (parsedSummary.script)
        answerScript = parsedSummary.script;

    var textDiv = createDiv(titleTd.summaryTd, '.faqText');
    var resizeToExternal = false;
    ISQ.Export.currentMaxHeight = 0;
    ISQ.Export.currentMaxWidth = 0;
    if (results[0].externalSourceType) // external source
    {
        resizeToExternal = true;
        var container = createDiv(textDiv);
        container.innerHTML = parsedSummary.text;
        ISQ.Export.parseExternalSourceSummary(container, results[0].externalSourceType, tbody.parentNode);
    }
    else // regular answer
        textDiv.innerHTML = parsedSummary.text;

    // quotes
    if (ISQ.Widget.Query.processQuotes) ISQ.Widget.Query.processQuotes(textDiv, results[0].id);

    // attachments
    ISQ.Widget.Query.appendAttachments(results[0].attachments, textDiv);

    titleTd.className = 'answerTitle expanded';
    titleTd.summaryTr.className = 'summaryRow expanded';

    // dislike icon
    if (likeIcon)
    {
        ISQ.Widget.FAQ.BuildThumbsForFAQarticle(results, titleTd.summaryTr, likeIcon);
    }

    // script
    if (answerScript) eval(answerScript);

    ISQ.Widget.Query.resizeSingleAnswerElements(textDiv, true, textDiv.offsetWidth);
    if (resizeToExternal)
    {
        var elements = ISQ.Html.getElementsByClassName(ISQ.Widget.HTML.widgetContainer, "hoverImagesClass");
        if (elements.length > 0)
            ISQ.Widget.CDC.sendMessage("subject=setSize&height=" + ISQ.Export.currentHeight + "&width=" + ISQ.Export.currentWidth);
        else
            ISQ.Widget.CDC.sendMessage("subject=widgetToExpand");
    }
    else
        ISQ.Widget.HTML.dynamicSize_sendMessage();
}

//#endregion
nanoRep.FAQ = initializeNS("nanoRep.FAQ");
nanoRep.FAQ.Texts =
{
    // english text
    "en":
    {
        'like': 'Good answer!',
        'likeActive': 'You like this',
        'dislike': 'Needs improvement',
        'dislikeActive': 'You dislike this',
        'ok': 'OK',
        'cancel': 'Cancel',
        'dislikeOptionsTitle': 'What\'s wrong with this answer?',
        'likeTexts': 
        {
            0: 'Like',
            2: 'Answer is incorrect or inaccurate',
            3: 'Missing important information',
            4: 'Answer irrelevant to the page',
            5: 'Didn\'t find what I was looking for',
            6: 'Missing or incorrect information'
        }
    },
	
    // Polish text
    "pl":
    {
        'like': 'Like',
        'likeActive': 'Chcesz tego',
        'dislike': 'Nie lubić',
        'dislikeActive': 'Nie lubić',
        'ok': 'OK',
        'cancel': 'Anuluj',
        'dislikeOptionsTitle': 'Jaki jest problem z odpowiedzią?',
        'likeTexts': 
        {
            0: 'Like',
            2: 'Odpowiedź jest niepoprawna bądź nieprecyzyjna',
            3: 'Brakuje ważnych informacji',
            4: 'Odpowiedź jest niezwiązana z tematem',
            5: 'Nie mogę znaleźć to, czego szukasz',
            6: 'Brak lub nieprawidłowe informacje'          
        }
    },
    
    // Danish text
    "da":
    {
        'like': 'Like',
        'likeActive': 'Du kan lide denne',
        'dislike': 'Dislike',
        'dislikeActive': 'Du kan ikke lide denne',
        'ok': 'OK',
        'cancel': 'Annuller',
        'dislikeOptionsTitle': 'Hvad er der galt med dette svar?',
        'likeTexts': 
        {
            0: 'Like',
            2: 'Svaret er forkert eller upræcist',
            3: 'Mangler vigtig information',
            4: 'Svaret er irrelevant',
            5: 'Jeg kunne ikke finde, hvad jeg ledte efter',
            6: 'Manglende eller forkerte oplysninger'  
        }
    },
	
    // Hungarian text
    "hu":
    {
        'like': 'Like',
        'likeActive': 'You like this',
        'dislike': 'Dislike',
        'dislikeActive': 'You dislike this',
        'ok': 'Rendben',
        'cancel': 'Mégse',
        'dislikeOptionsTitle': 'Mi a baj a válasszal?',
        'likeTexts': 
        {
            0: 'Like',
            2: 'A válasz helytelen vagy pontatlan',
            3: 'Fontos információ hiányzik belőle',
            4: 'A válasz nem releváns',
            5: 'Én nem találtam, amit kerestem',
            6: 'Hiányzó vagy helytelen információ'
        }
    },    
    
    // Turkish text
    "tr":
    {
        'like': 'Like',
        'likeActive': 'You like this',
        'dislike': 'Dislike',
        'dislikeActive': 'You dislike this',
        'ok': 'OK',
        'cancel': 'Cancel',
        'dislikeOptionsTitle': 'What\'s wrong with this answer?',
        'likeTexts': 
        {
            0: 'Like',
            2: 'Answer is incorrect or inaccurate',
            3: 'Missing important information',
            4: 'Answer irrelevant to the page',
            5: 'Didn\'t find what I was looking for',
            6: 'Missing or incorrect information'
        }
    },    
    
    // Swedish text
    "sv":
    {
        'like': 'Liksom',
        'likeActive': 'Du gillar det här inlägget',
        'dislike': 'Motvilja',
        'dislikeActive': 'Du gillar inte det här',
        'ok': 'OK',
        'cancel': 'Avbryt',
        'dislikeOptionsTitle': 'Vad är det för fel på detta svar?',
        'likeTexts': 
        {
            0: 'Liksom',
            2: 'Svaret är felaktigt eller oriktigt',
            3: 'Saknar viktig information',
            4: 'Svaret är irrelevant',
            5: 'Jag hittade inte det jag letade efter',
            6: 'Saknas eller felaktig information'
        }
    },

	// Deutch (german) text 
    "de":
    {
        'like': 'Gefällt mir',
        'likeActive': 'Sie mögen dieses',
        'dislike': 'Dislike',
        'dislikeActive': 'Sie mögen diese',
        'ok': 'OK',
        'cancel': 'Abbrechen',
        'dislikeOptionsTitle': 'Was ist falsch mit dieser Antwort?',
        'likeTexts': 
        {
            0: 'Gefällt mir',
            2: 'Antwort ist nicht richtig oder ungenau',
            3: 'Es fehlen wichtige Informationen',
            4: 'Die Antwort ist irrelevant',
            5: 'Ich fand nicht, was ich gesucht habe',
            6: 'Fehlende oder falsche Informationen'
        }
    },
	
	// Arabic text
    "ar":
	{
        'like': 'مثل',
        'likeActive': 'كنت مثل هذا',
        'dislike': 'كره',
        'dislikeActive': 'كنت تكره هذا',
        'ok': 'موافق',
        'cancel': 'إلغاء',
        'dislikeOptionsTitle': 'ما الخطأ في هذه الإجابة؟',
        'likeTexts': 
        {
            0: 'مثل',
            2: 'الإجابة غير صحيحة أو غير دقيقة',
            3: 'معلومات هامة ناقصة',
            4: 'الإجابة غير ذات صلة',
            5: 'لم أجد ما كنت أبحث عنه',
            6: 'المعلومات الناقصة أو غير صحيحة'
        }
    },
	
	// Chinese text
    "zh":
	{
        'like': 'Like',
        'likeActive': '你喜欢这个',
        'dislike': '反感',
        'dislikeActive': '你不喜欢',
        'ok': '确定',
        'cancel': '取消',
        'dislikeOptionsTitle': '这个答案有什么问题？',
        'likeTexts': 
        {
            0: 'Like',
            2: '答案错误或不准确',
            3: '遗漏了重要信息',
            4: '答案不切题',
            5: '我没有找到我要找的',
            6: '缺少或不正确的信息'
        }
    },
	
	// Russian text
    "ru":
	{
        'like': 'Like',
        'likeActive': 'Вам понравилось это',
        'dislike': 'не любить',
        'dislikeActive': 'Вы не понравилось',
        'ok': 'OK',
        'cancel': 'Отмена',
        'dislikeOptionsTitle': 'В чем проблема с этим ответом?',
        'likeTexts': 
        {
            0: 'Like',
            2: 'Ответ неверный или неточный',
            3: 'В нем отсутствует важная информация',
            4: 'Ответ не относится к делу',
            5: 'Мне не удалось найти то, что я искал',
            6: 'Отсутствие или неправильную информацию'
        }
    },
	
	// Japanese text
    "ja":
	{
        'like': 'Like',
        'likeActive': 'あなたはこれが好き',
        'dislike': '嫌い',
        'dislikeActive': 'あなたはこれを嫌い',
        'ok': 'OK',
        'cancel': 'キャンセル',
        'dislikeOptionsTitle': 'この回答の問題点は?',
        'likeTexts': 
        {
            0: 'Like',
            2: '回答が不正または不精確',
            3: '重要情報が欠けている',
            4: '回答内容が無関係',
            5: '私は私が探していたものを見つけることができませんでした',
            6: '情報の修正、不足はあります'
        }
    },
	
	// Korean text
    "ko":
	{
        'like': 'Like',
        'likeActive': '당신이 좋아',
        'dislike': '싫어',
        'dislikeActive': '당신이 싫어',
        'ok': '확인',
        'cancel': '취소',
        'dislikeOptionsTitle': '이 답의 무엇이 잘못되었나요?',
        'likeTexts': 
        {
            0: 'Like',
            2: '답이 잘못되었거나 정확하지 않습니다.',
            3: '중요한 정보가 빠졌습니다.',
            4: '답이 적절하지 않습니다.',
            5: '나는 내가 무엇을 찾고 찾을 수 없습니다',
            6: '누락 또는 잘못된 정보'
        }
    },
	
	// French text 
    "fr":
	{
        'like': 'J\'aime',
        'likeActive': 'Vous aimez ce',
        'dislike': 'Antipathie',
        'dislikeActive': 'Yous n\'aime pas ce',
        'ok': 'OK',
        'cancel': 'annuler',
        'dislikeOptionsTitle': 'Pourquoi cette réponse est-elle erronée ?',
        'likeTexts': 
        {
            0: 'J\'aime',
            2: 'La réponse est inexacte ou imprécise',
            3: 'Des informations importantes sont manquantes',
            4: 'La réponse est hors sujet',
            5: 'Je n\'ai pas trouvé ce que je cherchais',
            6: 'Information manquante ou incorrecte'
        }
    },
	
	// Italian text
    "it":
	{
        'like': 'Mi piace',
        'likeActive': 'Ti piace questo',
        'dislike': 'Antipatia',
        'dislikeActive': 'Non ti piace questo',
        'ok': 'OK',
        'cancel': 'Annulla',
        'dislikeOptionsTitle': 'Cosa c\'è di sbagliato in questa risposta?',
        'likeTexts': 
        {
            0: 'Mi piace',
            2: 'La risposta è errata o inaccurata',
            3: 'Mancano informazioni importanti',
            4: 'La risposta è irrilevante',
            5: 'Non ho trovato quello che cercavo',
            6: 'Informazioni mancanti o errate'
        }
    },
	
	// Netherland text
    "nl":
	{
        'like': 'Vind ik leuk',
        'likeActive': 'U houdt van dit',
        'dislike': 'Afkeer',
        'dislikeActive': 'Je vind dit niet leuk',
        'ok': 'OK',
        'cancel': 'Annuleren',
        'dislikeOptionsTitle': 'Wat klopt er niet aan dit antwoord?',
        'likeTexts': 
        {
            0: 'Vind ik leuk',
            2: 'Antwoord is onjuist of onnauwkeurig',
            3: 'Belangrijke informatie ontbreekt',
            4: 'Het antwoord doet niet ter zake',
            5: 'Heeft u niet gevonden wat ik zocht',
            6: 'Ontbrekende of onjuiste informatie'
        }
    },
	
	 // Portuguese text
    "pt":
	{
        'like': 'Gosto',
        'likeActive': 'Você gosta disso',
        'dislike': 'Antipatia',
        'dislikeActive': 'Você não gosta deste',
        'ok': 'OK',
        'cancel': 'Cancelar',
        'dislikeOptionsTitle': 'O que há de errado com esta resposta?',
        'likeTexts': 
        {
            0: 'Gosto',
            2: 'A resposta é incorreta ou inexata',
            3: 'Faltam informações importantes',
            4: 'A resposta é irrelevante',
            5: 'Não encontrou o que estava procurando',
            6: 'Informações ausentes ou incorretas'
        }
    },
	
	// Spain text
    "es":
	{
        'like': 'Me gusta',
        'likeActive': 'Si le gusta este',
        'dislike': 'No me gusta',
        'dislikeActive': 'No le gusta este',
        'ok': 'Aceptar',
        'cancel': 'Cancelar',
        'dislikeOptionsTitle': '¿Cuál es el problema con esta respuesta?',
        'likeTexts': 
        {
            0: 'Me gusta',
            2: 'La respuesta es incorrecta o inexacta',
            3: 'Falta información importante',
            4: 'La respuesta es irrelevante',
            5: 'No encontré lo que buscaba',
            6: 'Información faltante o incorrecta'
        }
    },
	
    // Hebrew text
    "iw":
    {
        'like': 'אהבתי',
        'likeActive': 'אהבת את זה',
        'dislike': 'לא אהבתי',
        'dislikeActive': 'לא אהבת את זה',
        'ok': 'אישור',
        'cancel': 'ביטול',
        'dislikeOptionsTitle': 'מה לא תקין בתשובה זו?',
        'likeTexts':
        {
            0: 'אהבתי',
            2: 'תשובה לא נכונה / לא מדוייקת',
            3: 'חסר מידע חשוב',
            4: 'התשובה אינה רלוונטית לעמוד',
            5: 'לא מצאתי את מה שחיפשתי',
            6: 'מידע חסר או לא מדוייק'
        }
    },

    // Norwegian text
    "no":
    {
        'like': 'Like',
        'likeActive': 'Du liker dette',
        'dislike': 'Dislike',
        'dislikeActive': 'Du liker ikke dette',
        'ok': 'OK',
        'cancel': 'Avbryt',
        'dislikeOptionsTitle': 'Hva er galt med dette svaret?',
        'likeTexts':
        {
            0: 'Like',
            2: 'Svaret er feil eller unøyaktig',
            3: 'Mangler viktig informasjon',
            4: 'Svaret er ikke relevant',
            5: 'Fant ikke det jeg var ute etter',
            6: 'Mangelfull eller feilaktig informasjon'
        }
    },

    // finnish text
    "fi":
    {
        'like': 'Tykkää',
        'likeActive': 'Pidät tästä',
        'dislike': 'En tykkää',
        'dislikeActive': 'Et pidä tämä',
        'ok': 'Ok',
        'cancel': 'Peruuta',
        'dislikeOptionsTitle': 'Miksi tämä vastaus ei ole riittävä?',
        'likeTexts': 
        {
            0: 'Tykkää',
            2: 'Vastaus on virheellisiä tai epätarkkoja',
            3: 'Puuttuu tärkeitä tietoja',
            4: 'Vastaus on epäolennainen',
            5: 'Etkö löytänyt mitä olin etsimässä',
            6: 'Puuttuva tai väärä tieto'
        }
    }
};
// Language codes for the different norwegian dialects
nanoRep.FAQ.Texts.nb = nanoRep.FAQ.Texts.no;
nanoRep.FAQ.Texts.nn = nanoRep.FAQ.Texts.no;
; // localization texts
ISQ.Widget = initializeNS("ISQ.Widget");

// widgetUI
ISQ.Widget.combineContext = function (contextAttributes, contextSource, customParams)
{
    if (!contextAttributes) return contextSource;

    // lower case contexts
    if (contextSource)
    {
        for (var key in contextSource)
        {
            var keyLC = key.toLowerCase();
            contextSource[keyLC] = contextSource[key];
            if (keyLC !== key) delete contextSource[key]; // removing non-LC contexts
        }
    }

    var result = null;
    if (contextSource || customParams)
    {
        for (var cat in contextAttributes)
        {
            if (contextSource && contextSource[cat.toLowerCase()]) continue; // api context is stronger than CNF

            for (var attrbNdx = 0; attrbNdx < contextAttributes[cat].length; ++attrbNdx)
            {
                var paramValue = null;
                if (customParams) paramValue = customParams[contextAttributes[cat][attrbNdx]];

                // skipping non-existing attributes
                if (!paramValue) continue;

                if (!result)
                {
                    result = [];

                    // we created a new context array. we MUST copy previous values
                    for (var tmpCat in contextSource)
                        result[tmpCat] = contextSource[tmpCat];
                }
                result[cat.toLowerCase()] = paramValue;
                break;
            }
        }
    }
    return result || contextSource;
}
; //ISQ.Widget.combineContext

if (typeof nanoRep.FAQ.Localization=='undefined')
nanoRep.FAQ.Localization = {};
//#region init

nanoRep.FAQ.init = function (lang, serverHost)
{
    nanoRep.FAQ.Localization = nanoRep.FAQ.Texts[lang] || nanoRep.FAQ.Texts['en'];
    nanoRep.FAQ.dynamicHost = serverHost;
}

//#endregion

// members
nanoRep.FAQ.dynamicHost = null;

nanoRep.FAQ.Likes = {};


// action see View.enumFeedback
nanoRep.FAQ.Likes.enumFeedback =
{
    positive: 1,
    wrongAnswer: 2,
    wrongContent: 4,
    wrongContext: 8
}
//#region likes / dislikes

// members
nanoRep.FAQ.Likes.mData = { div: null, options: [], pastActions: null, hasContext: false };

nanoRep.FAQ.Likes.buildThumbUpIcon = function (articleId, parent, likes, rtl, cacheVar, account, kb, preview, localization, referrer, mostPopularStandAlone)
{
    localization = localization || nanoRep.FAQ.Localization;
    // up
    var thumbUp = createDiv(null, '.nanoRepMP_likeIcon');

    thumbUp.onclick = function ()
    {
        nanoRep.FAQ.Likes.saveData(thumbUp, articleId, rtl, cacheVar, account, kb, preview, referrer);
        nanoRep.FAQ.Likes.sendThumbAction(nanoRep.FAQ.Likes.enumFeedback.positive, localization);
    }

    // highlight past action
    var lastAction = nanoRep.FAQ.Likes.getLastAction(articleId);
    nanoRep.FAQ.Likes.setThumbStyles(lastAction.action, thumbUp, null, false, localization);

    // like count - increment locally if cacheVar from last action is the same as server's, due to server caching!
    if (lastAction.action == 0 && lastAction.cacheVar == cacheVar) likes++;

    // if mostpopular standalone then act as before
    if (mostPopularStandAlone)
    {
        parent.appendChild(thumbUp);
        thumbUp.className += " nanoRepMP_likeIconStandAlone";
        thumbUp.innerHTML = likes ? ISQ.Tools.getPrettyNumber(likes, 0, false, true) : '0';
        thumbUp.likes = likes;
        return thumbUp;
    }

    var likesContainer = createDiv(parent, "white-space:nowrap;");
    var likesScore = createDiv(null, "white-space:nowrap;display:inline;");
    if (likes && likes > 999) likesScore.title = ISQ.Tools.getPrettyNumber(likes);

    var direction = (ISQ.Widget.HTML.dynamicRTLCssLoaded) ? "rtl" : "ltr";
    if (direction == "ltr")
    {
        likesContainer.appendChild(thumbUp);
        likesContainer.appendChild(likesScore);
        createDiv(likesScore, '.newLikesLeftEdge&display:inline-block;float:none;vertical-align:top;');
    }
    var countElement = createDiv(likesScore, '.newlikes&display:inline-block;float:none;vertical-align:top;cursor:default');
    if (direction == "rtl")
    {
        countElement.className += " newlikesRTL";
        createDiv(likesScore, '.newLikesRightEdge&display:inline-block;float:none;vertical-align:top;');
        likesScore.appendChild(countElement);
        likesContainer.appendChild(thumbUp);
        likesContainer.appendChild(likesScore);
    }

    countElement.innerHTML = likes ? ISQ.Tools.getPrettyNumber(likes, 0, false, true) : '0';
    thumbUp.likes = likes;
    thumbUp.countElement = countElement;
    thumbUp.countContainer = likesScore;

    return thumbUp;
}

nanoRep.FAQ.Likes.buildThumbDownIcon = function (articleId, parent, likeIcon, rtl, cacheVar, account, kb, preview, localization, referrer, mostPopularStandAlone, widgetAnswer)
{
    localization = localization || nanoRep.FAQ.Localization;

    var thumbDown = createDiv(parent, '.nanoRepMP_likeIcon &.nanoRepMP_dislikeIcon');
    thumbDown.widgetAnswer = widgetAnswer || false;
    likeIcon.thumbDown = thumbDown;
    thumbDown.onclick = function ()
    {
        nanoRep.FAQ.Likes.saveData(likeIcon, articleId, rtl, cacheVar, account, kb, preview, referrer);

        var lastAction = nanoRep.FAQ.Likes.getLastAction(articleId);
        if (lastAction.action > nanoRep.FAQ.Likes.enumFeedback.positive)
            nanoRep.FAQ.Likes.sendThumbAction(lastAction.action, localization); // undo last action
        else
            nanoRep.FAQ.Likes.toggleDislikeOptions(false, localization);
    }

    // highlight past action
    nanoRep.FAQ.Likes.setThumbStyles(nanoRep.FAQ.Likes.getLastAction(articleId).action, likeIcon, thumbDown, false, localization);

    return thumbDown;
}

nanoRep.FAQ.Likes.getLastAction = function (articleId)
{
    // get past actions
    var pastActions = nanoRep.FAQ.Likes.mData.pastActions;
    var lastAction = { action: null, cacheVar: null };
    if (!pastActions)
    {
        // format: {articleId: {action:x, cacheVar:y}, articleId: {action:x, cacheVar:y}}
        var currentVal = ISQ.Tools.Storage.get('faqActions');
        if (currentVal) pastActions = eval('(' + currentVal + ')');
    }
    
    if (!pastActions) pastActions = {};
    nanoRep.FAQ.Likes.mData.pastActions = pastActions;

    if (pastActions[articleId] && typeof (pastActions[articleId].action) !== 'undefined')
        lastAction = pastActions[articleId];

    return lastAction;
}

nanoRep.FAQ.Likes.saveData = function (thumbUp, articleId, rtl, cacheVar, account, kb, preview, referrer, callback, keywordsetId)
{
    // set pointers
    nanoRep.FAQ.Likes.mData.thumbUp = thumbUp;
    nanoRep.FAQ.Likes.mData.thumbDown = thumbUp.thumbDown || null;
    nanoRep.FAQ.Likes.mData.articleId = articleId;
    nanoRep.FAQ.Likes.mData.account = account;
    nanoRep.FAQ.Likes.mData.rtl = rtl || false;
    nanoRep.FAQ.Likes.mData.cacheVar = cacheVar;
    nanoRep.FAQ.Likes.mData.account = account;
    nanoRep.FAQ.Likes.mData.kb = kb;
    nanoRep.FAQ.Likes.mData.preview = preview;
    nanoRep.FAQ.Likes.mData.referrer = referrer;
    nanoRep.FAQ.Likes.mData.keywordsetId = keywordsetId || null;
    nanoRep.FAQ.Likes.mData.callback = callback || null;
}
nanoRep.FAQ.Likes.setThumbStyles = function (action, thumbUp, thumbDown, updateLikeCount, localization)
{
    localization = localization || nanoRep.FAQ.Localization;
    thumbUp = thumbUp || nanoRep.FAQ.Likes.mData.thumbUp;
    thumbDown = thumbDown || nanoRep.FAQ.Likes.mData.thumbDown;
    if (thumbUp)
    {
        if (action == nanoRep.FAQ.Likes.enumFeedback.positive)
        {
            ISQ.CSS.addClass(thumbUp, 'nanoRepMP_likeIconCurrent');
            thumbUp.title = localization['likeActive'];
        }
        else
        {
            ISQ.CSS.removeClass(thumbUp, 'nanoRepMP_likeIconCurrent');
            thumbUp.title = localization['like'];
        }
    }
    if (thumbDown)
    {
        if (action > nanoRep.FAQ.Likes.enumFeedback.positive)
        {
            ISQ.CSS.addClass(thumbDown, 'nanoRepMP_dislikeIconCurrent');
            thumbDown.title = localization['dislikeActive'];
        }
        else
        {
            ISQ.CSS.removeClass(thumbDown, 'nanoRepMP_dislikeIconCurrent');
            thumbDown.title = localization['dislike'];
        }
    }

    if (updateLikeCount) nanoRep.FAQ.Likes.updateLikeCount(thumbUp, action == nanoRep.FAQ.Likes.enumFeedback.positive);
}
nanoRep.FAQ.Likes.updateLikeCount = function (thumbUp, increment)
{
    thumbUp.likes = increment ? thumbUp.likes + 1 : thumbUp.likes - 1;
    if (thumbUp.countElement)
    {
        thumbUp.countElement.innerHTML = thumbUp.likes > 0 ? ISQ.Tools.getPrettyNumber(thumbUp.likes, 0, false, true) : '0';
        if (thumbUp.likes && thumbUp.likes > 999) thumbUp.countElement.parentNode.title = ISQ.Tools.getPrettyNumber(thumbUp.likes);
    }
    else
        thumbUp.innerHTML = thumbUp.likes > 0 ? ISQ.Tools.getPrettyNumber(thumbUp.likes, 0, false, true) : '0';
}
nanoRep.FAQ.Likes.toggleDislikeOptions = function (forceClose, localization)
{
    localization = localization || nanoRep.FAQ.Localization;

    // toggle dislike options popup
    if (typeof (nanoRep.FAQ.Likes.mData) == "undefined") return;
    var anc = nanoRep.FAQ.Likes.mData.thumbDown;
    if (!anc) return;
    if (!nanoRep.FAQ.Likes.mData.div) nanoRep.FAQ.Likes.buildDislikeOptions(anc);
    var div = nanoRep.FAQ.Likes.mData.div;

    if (div.style.display == 'block' || forceClose) // close it
    {
        div.style.display = 'none';
        anc.title = anc.oldTitle;
        ISQ.CSS.removeClass(anc, 'nanoRepMP_dislikeIconOpen');

        // if faq dislike popup has fader
        if (div.faqFader)
        {
            div.faqFader.parentNode.removeChild(div.faqFader)
            div.faqFader = null;
        }

        anc.removeChild(div);

        // unselect radios
        for (var i in nanoRep.FAQ.Likes.mData.options)
        {
            nanoRep.FAQ.Likes.mData.options[i].checked = false;
        }

        ISQ.Tools.addRemoveClickOutsideElementsListener("dislikeOptions", false);

        // dispose it, because next time we may need to rebuild due to #10831
        clearNode(nanoRep.FAQ.Likes.mData.div);
        nanoRep.FAQ.Likes.mData.div = null;
    }
    else // open it
    {
        anc.appendChild(div);


        anc.oldTitle = anc.title;
        anc.title = '';
        div.style.display = 'block';
        ISQ.CSS.addClass(anc, 'nanoRepMP_dislikeIconOpen');

        // popup position
        nanoRep.FAQ.Likes.setDislikeOptionsPosition();

        // setting position for dislike popup to the middle of the widget content area
        // if (div.parentNode && div.parentNode.newPosition)
        // {

        // }

        ISQ.Tools.addRemoveClickOutsideElementsListener("dislikeOptions", true, [div], new ISQ.Handler(function (event4ff)
        {
            if (ISQ.Html.getEventTarget(event4ff) == nanoRep.FAQ.Likes.mData.thumbDown) return;
            nanoRep.FAQ.Likes.toggleDislikeOptions(true, localization);
            if (nanoRep.FAQ.Likes.dislikeTimer)
                clearInterval(nanoRep.FAQ.Likes.dislikeTimer);
        }));
    }

    ISQ.Tools.blinkElement(div, 0, false, 'validationErr');
}

nanoRep.FAQ.Likes.dislikeTimer = null;
nanoRep.FAQ.Likes.setDislikeOptionsPosition = function ()
{
    var div = nanoRep.FAQ.Likes.mData.div;
    if (!div.parentNode) return;

    div.style.height = 'auto';
    // in case its a narrow widget, add css class
    if (ISQ.Widget.HTML && ISQ.Widget.HTML.contentWrapper && ISQ.Widget.HTML.contentWrapper.offsetWidth < 420)
    {
        div.className += " narrowWidget_dislikeOptions";
    }
    else
    {
        //console.log()
    }

    var h = "0";
    var pSize = ISQ.Html.pageSize(true);
    if (pSize.h > 400)
    {
        if (div.parentNode.offsetTop + 150 > pSize.h - 30)
            h = "-130";
        else
            h = "0";
    }

    div.style.bottom = 'auto';
    // floating widget or embed widget
    if (ISQ.Widget.HTML && ISQ.Widget.HTML.contentWrapper)
    {
        // adding fader to the widget
        var faqFader = createDiv(ISQ.Widget.HTML.widgetContainer, ".widgetFAQBlocker");
        div.faqFader = faqFader;
        div.faqFader.style.position = "fixed";
        // bug fix in iphone... iphone doesn't fire click event if element's onclick is not set #10754
        div.faqFader.onclick = function () { };

        // horizontal alignment to center
        var w = (ISQ.Widget.HTML.contentWrapper.offsetWidth - div.offsetWidth) / 2;
        div.style.left = w + 'px';

        var widgetHeight = ISQ.Widget.HTML.widgetContainer.offsetHeight;

        if (ISQ.Widget.isFloat)
        {
            var h = (ISQ.Widget.HTML.contentWrapper.offsetHeight - div.offsetHeight) / 2;
            h += ISQ.Widget.HTML.searchWrapper.offsetHeight + ISQ.Widget.HTML.titleWrapper.offsetHeight;
            div.style.top = h + 'px';

            // if is float and in mobile, should put the popup in the middle of the screen          
            if (ISQ.Http.browser.isMobile)
            {
                div.style.top = (screen.height - div.offsetHeight) / 2 + 'px';
            }
        }
        else
        {
            var clickedPos = div.parentNode.getBoundingClientRect();

            // in case its embed widget and height is huge

            div.style.top = clickedPos.top - (div.offsetHeight) / 2 + 'px';

            if (clickedPos.top + div.offsetHeight > widgetHeight)
                div.style.top = widgetHeight - div.offsetHeight - ISQ.Widget.HTML.footerWrapper.offsetHeight + "px";
        }

        if (ISQ.Http.browser.isMobile)
        {
            nanoRep.FAQ.Likes.dislikeTimer = setInterval(function ()
            {
                var w = (ISQ.Widget.HTML.contentWrapper.offsetWidth - div.offsetWidth) / 2;
                div.style.left = w + 'px';
            }, 250);
        }


    }
    else//mostpopular
    {
        if (nanoRep.FAQ.Likes.mData.rtl)
        {
            div.style.left = '20px';
        }
        else
        {
            div.style.right = '20px';
        }
    }

}

nanoRep.FAQ.Likes.buildDislikeOptions = function (anc, localization)
{
    localization = localization || nanoRep.FAQ.Localization;

    var mobileCss = ISQ.Http.browser.isMobile ? " &.mobile" : "";

    // popup div
    var div = nanoRep.FAQ.Likes.mData.div = createDiv(document.body, '.nanoRepMP_dislikeOptions' + mobileCss);
    div.onclick = function (e)
    {
        ISQ.Html.getDomEvent(e).cancel();
    }

    // close icon
    createLink(
    {
        parent: div,
        text: "x",
        style: '.closeIcon',
        onclick: function () { nanoRep.FAQ.Likes.toggleDislikeOptions(false, localization); }
    });

    // title
    createDiv(div, '.nanoRepMP_dislikeOptionsTitle').innerHTML = localization['dislikeOptionsTitle'];

    // prepare options based on logic from #10831
    var options = [];
    var hasContext = nanoRep.FAQ.Likes.mData.hasContext || (typeof (_session) === 'function' && _session().hasContext && _session().hasContext()); // page has context

    if (anc.widgetAnswer) // flag in anchor that indicates we're coming from widget answer
    {
        options = [6, 5];
        if (hasContext) options.push(4);
    }
    else // FAQ
    {
        if (hasContext) options = [6, 4];
        else options = [2, 3];
    }

    // mapping texts to View.enumFeedback
    var textToFeedback =
    {
        0: nanoRep.FAQ.Likes.enumFeedback.positive, // positive
        2: nanoRep.FAQ.Likes.enumFeedback.wrongContent, // wrong content
        3: nanoRep.FAQ.Likes.enumFeedback.wrongContent,
        4: nanoRep.FAQ.Likes.enumFeedback.wrongContext, // wrong context
        5: nanoRep.FAQ.Likes.enumFeedback.wrongAnswer, // wrong answer
        6: nanoRep.FAQ.Likes.enumFeedback.wrongContent
    }

    // build radios
    var textsEnum = localization['likeTexts'];
    for (var i = 0; i < options.length; i++)
    {
        var idx = options[i];
        var rb = createRadio(
        {
            type: 'radio',
            name: 'dislike',
            parent: div,
            text: textsEnum[idx],
            value: textToFeedback[idx],
            holderStyle: "padding-top:4px;",
            onclick: function ()
            {
                ISQ.Tools.blinkElement(div, 0, false, 'validationErr');
                // fixing bug in chrome where radio not clickable inside iframe ( fixed div ) when window itself is scrolled down
                if (ISQ.Http.isChrome())
                {
                    var oldPos = div.style.position;
                    div.style.position = 'static';
                    div.offsetHeight;
                    div.style.position = oldPos;
                }
            }
        });
        nanoRep.FAQ.Likes.mData.options.push(rb);
    }

    // cancel button
    var buttonsDiv = createDiv(div, '.nanoRepMP_dislikeOptionsBtns');
    // ok button
    var lnk = createLink(
    {
        parent: buttonsDiv,
        text: localization['ok'],
        style: '.button',
        onclick: function ()
        {
            var action = -1;
            for (var i in nanoRep.FAQ.Likes.mData.options)
            {
                if (nanoRep.FAQ.Likes.mData.options[i].checked) action = parseInt(nanoRep.FAQ.Likes.mData.options[i].value);
            }

            if (action == -1)
            {
                ISQ.Tools.blinkElement(div, 3, true, 'validationErr');
                return;
            }
            if (nanoRep.FAQ.Likes.mData.callback)
                nanoRep.FAQ.Likes.mData.callback(nanoRep.FAQ.Likes.mData.articleId, nanoRep.FAQ.Likes.mData.keywordsetId, action);
            else
                nanoRep.FAQ.Likes.sendThumbAction(action, localization);
            nanoRep.FAQ.Likes.toggleDislikeOptions(false, localization);
        }
    });
    lnk = createLink(
    {
        parent: buttonsDiv,
        text: localization['cancel'],
        style: '.button &.buttonLink',
        onclick: function () { nanoRep.FAQ.Likes.toggleDislikeOptions(false, localization); }
    });



    // reposition on resize - code removed as not relevant anymore - bug #10705
    //    ISQ.Html.ReSize.init(ISQ.Html.ReSize.enumListenTo.both, true);
    //    ISQ.Html.ReSize.Event.addHandler(function ()
    //    {
    //        nanoRep.FAQ.Likes.setDislikeOptionsPosition();
    //    });
}

// perform get request using image
nanoRep.FAQ.Likes.sendThumbAction = function (action, localization)
{
    localization = localization || nanoRep.FAQ.Localization;

    // set pointers
    var articleId = nanoRep.FAQ.Likes.mData.articleId;
    var pastActions = nanoRep.FAQ.Likes.mData.pastActions;
    var cacheVar = nanoRep.FAQ.Likes.mData.cacheVar;
    var account = nanoRep.FAQ.Likes.mData.account;
    var kb = nanoRep.FAQ.Likes.mData.kb;
    var preview = nanoRep.FAQ.Likes.mData.preview;
    var referrer = nanoRep.FAQ.Likes.mData.referrer;
    if (!articleId) throw ('articleId must be specified');

    // get past actions from local storage
    var undo = null;

    // undo previous action if needed
    if (typeof (pastActions[articleId]) !== 'undefined' && typeof (pastActions[articleId].action) !== 'undefined')
    {
        undo = pastActions[articleId].action;
        if (undo == action) action = null; // previous action is the same as current - undo it
    }

    // set new action
    if (action == null) delete pastActions[articleId];
    else
    {
        pastActions[articleId] = {};
        pastActions[articleId].action = action;
        // save current cachevar from server
        if (cacheVar) pastActions[articleId].cacheVar = cacheVar;
    }

    if (!preview)
    {
        ISQ.Tools.Storage.set('faqActions', ISQ.Data.jsonToString(pastActions));
        nanoRep.FAQ.Likes.mData.pastActions = pastActions;

        // build url
        var url = new Array();
        url.push(nanoRep.FAQ.dynamicHost);
        url.push('/~');
        url.push(account.toLowerCase());
        url.push('/widget/faqAction.gif?rnd=');
        url.push(Math.floor(Math.random() * 1000000));
        url.push('&account=');
        url.push(account);
        if (kb) url.push("&kb=" + kb);
        url.push('&id=');
        url.push(articleId);
        if (action != null) url.push('&action=' + action);
        if (undo != null) url.push("&undo=" + undo);
        if (referrer) url.push("&referer=" + escape(referrer));

        // send request
        var img = new Image();
        img.src = url.join('');
        img.style.width = '1px';
        img.style.height = '1px';
        img.style.display = 'none';
    }

    // set thumb styles
    nanoRep.FAQ.Likes.setThumbStyles(action, null, null, action == nanoRep.FAQ.Likes.enumFeedback.positive || undo == nanoRep.FAQ.Likes.enumFeedback.positive, localization);
}

//#endregion

//#region tools

// combines script context with customParams and formats it for request urls
nanoRep.FAQ.combineAndFormatContext = function (context, disableCombine)
{
    if (!context) context = {};
    var contexts;

    if (typeof (_nRepData) == 'undefined' || !_nRepData["customParams"])
        contexts = context;
    if (!disableCombine)
    {
        if (ISQ.Cnf_Float)
            contexts = ISQ.Widget.combineContext(ISQ.Cnf_Float.contextAttributes, context, _nRepData["customParams"]);
        else if (ISQ.Cnf_Embed)
            contexts = ISQ.Widget.combineContext(ISQ.Cnf_Embed.contextAttributes, context, _nRepData["customParams"]);
    }

    var hasContext = false;
    if (contexts)
    {
        for (var cat in contexts)
        {
            hasContext = true;
            break;
        }
    }
    if (hasContext)
    {
        nanoRep.FAQ.Likes.mData.hasContext = true;
        var replacingArr = [{ "from": ",", "to": " " }, { "from": ":", "to": " "}]
        var ctxARr = [];
        for (var cat in contexts)
        {
            if (!contexts[cat] || typeof (contexts[cat]) !== 'string') continue; // not a context
            if (ctxARr.length != 0) ctxARr.push(",");
            ctxARr.push(cat.replacer(replacingArr));
            ctxARr.push(":");
            ctxARr.push(contexts[cat].replacer(replacingArr));
        }
        return "&context=" + ISQ.Http.Cookies.encode64(ctxARr.join(''));
    }

    return "";
}

// if faq configuration contains context-dependent data, we must request the faq list from the server
//    1. if widget is contained (in float/embed):
//          - container calls requestFaqLists which requests faqList.js with context info
//          - server responds with data and data is sent to the widget using post message
//    2. if the widget is not contained (browsing to widget.html directly):
//          - widget calls requestFaqLists requests faqList.js with context info
//          - server responds with data and widget handles callback
nanoRep.FAQ.requestFaqLists = function (obj)
{
	// build url for request
    var url = new Array();
    var account = obj.account || _nRepData.account;
    url.push(obj.host);

    url.push('/~' + account.toLowerCase() + '/api/faq/v1/list.js');
    url.push('?account=');
    url.push(account);
    if (obj.isFloat) url.push("&isFloat=true");

    // kb
    if (obj.kb) url.push("&kb=" + obj.kb);

    // referer
    url.push("&referer=");
    if (obj.configId) url.push("!" + obj.configId);
    else if (window.location.href.contains("nanorep.com") && obj.referer)
        url.push(escape(obj.referer));
    else
        url.push(escape(window.location.href));

    // encoding
    if (obj.encoding) url.push("&encoding=" + obj.encoding);

    // context
    url.push(nanoRep.FAQ.combineAndFormatContext(obj.context, obj.disableContextCombine));

    // append script
    ISQ.Tools.appendScript(url.join(''), function ()
    {
        if (!nanoRep.FAQ.faqData) throw ('Invalid FAQ Data received');

        if (obj.callback)
        {
            obj.callback(nanoRep.FAQ.faqData);
        }
        else
        {
            // send message to widget with data
            nanoRep.FAQ.faqData = ISQ.Data.jsonToString(nanoRep.FAQ.faqData);
            var data = ISQ.Http.Cookies.encode64(nanoRep.FAQ.faqData);
            obj.cdcUser.sendMessage("subject=faqData&data=" + data);
        }

        delete nanoRep.FAQ.faqData;
    });
}

//#endregion
;;

ISQ.Widget.FAQ.initalize = function ()
{
    // if script was loaded, nothing to do here...
    if (ISQ.Widget.FAQ.scriptLoadState != ISQ.Widget.FAQ.initEnum.none) return;
    ISQ.Widget.FAQ.scriptLoadState = ISQ.Widget.FAQ.initEnum.loading;
    ISQ.Tools.FileLoader.load("/widget/scripts/faq-widgetui.js", new ISQ.Handler(function (tag)
    {
        ISQ.Widget.FAQ.scriptLoadState = ISQ.Widget.FAQ.initEnum.loaded;
        ISQ.Widget.FAQ.handleCnfData(); // loading cnf file (if needed && not contained)
        if (ISQ.Widget.FAQ.pendingFAQCallback) ISQ.Widget.FAQ.pendingFAQCallback(); // processing pending FAQ
        nanoRep.FAQ.init(ISQ.Cnf.initialUiLanguage, window.location.protocol + "//" + ISQ.Http.domain(true));
    }));
}


ISQ.Widget.FAQ.behavior =
{
    OnWidgetLoad: 1,
    OnNoResuls: 2,
    OnClearSearchField: 4
}
//////////////////////////////////////////////////////////////////////////
// NOTES:
//
// Resizing Answer elements (#2267):
// There are 3 scenarios which we want to initiate the resizing:
// 1. When widget stop resizing and we're not in teaser mode
// 2. When displaying answers. (We have a new answers = new content to resize)
// 3. When the user toggles between translated answers (since the hidden answer could not be processsed)
//

///////////////////////////////////////////////////////////////////////////
// Forms : get Contact forms by id.

ISQ.Widget.Forms = initializeNS('ISQ.Widget.Forms');

ISQ.Widget.Forms.getForms = function(answerContactForm)
{
    //get forms ids.
    var forms = []
    for(var j= 0; j < answerContactForm.length; j++)
        forms.push(answerContactForm[j].contactForms);

    var requestId = ISQ.Widget.Query.activeRequestId;

    _session().request(
        {
            url: "getForms.js",
            params:
            {
                contactFormId: forms.join(',')
            },
            handler: function (status, jsonObject)
            {
				// if request id dosen't match.
                if(requestId != ISQ.Widget.Query.activeRequestId)
                {
                    ISQ.Widget.Log.add('Chat question link response: Request Id doesn\'t match. sent: ' + ISQ.Widget.Query.activeRequestId + ", received: " + requestId);
                    return;
                }

                ISQ.Widget.Forms.parseResponse(status, jsonObject,forms,answerContactForm);
            }
        });
}

ISQ.Widget.Forms.parseResponse = function (status, data,requestedIds,answerContactForm)
{
    if (data.forms.length)
    {
		//iterate for each requested ids.
        for (var j = 0; j < requestedIds.length; j++)
        {
			//get placeholders for requested id. and add contact forms.
            var placeholders = document.querySelectorAll('.formId_' + requestedIds[j]);

            var channel = null;
            for(var k = 0;k < answerContactForm.length; k++)
                if(answerContactForm[k].contactForms === requestedIds[j])
            channel = answerContactForm[k];

            if(channel !== null)
            {
                for (var i = 0; i < placeholders.length; i++)
                {
                    var placeholder = placeholders[i];
                    placeholder.className = "contactForm";
                    ISQ.Widget.ContactForm.show(data.forms[j], null, placeholder,channel);
                }
            }
        }
    }
}
</script>
    <script type="text/javascript">ISQ.Widget.Query.suggestionsBlacklist = ['aryan',
'ass',
'asshole',
'bastard',
'bastards',
'bitch',
'bitches',
'bitching',
'bitchy',
'boob',
'boobie',
'booby',
'boobs',
'boobies',
'boobys',
'bullshit',
'bullshitter',
'bullshitters',
'bullshitting',
'chickenshit',
'chickenshits',
'clit',
'cock',
'cockhead',
'cocks',
'cocksuck',
'cocksucker',
'cocksucking',
'cum',
'cums',
'cumming',
'cunt',
'cuntree',
'cuntry',
'cunts',
'damn',
'dipshit',
'dipshits',
'dumbfuck',
'dumbfucks',
'dumbshit',
'dumbshits',
'fag',
'fags',
'faggy',
'faggot',
'faggots',
'fuck',
'fucks',
'fukk',
'fukka',
'fucka',
'fucke',
'fucker',
'fuckers',
'fucked',
'fuckin',
'fucken',
'fucking',
'fuckup',
'fuckups',
'fuckhead',
'fuckhed',
'fuckheads',
'fuckface',
'golem',
'goniff',
'hebe',
'hebes',
'heb',
'kike',
'kikes',
'kunt',
'kuntree',
'kuntry',
'kunts',
'motherfuck',
'motherfucker',
'motherfuckers',
'motherfucking',
'motherfuckin',
'motherfucken',
'nazi',
'nigger',
'niggers',
'nigga',
'niggas',
'niggaz',
'niggah',
'niggahs',
'niggard',
'niggardly',
'penis',
'piss',
'porn',
'porno',
'pussy',
'shit',
'shits',
'shitty',
'shitting',
'shitface',
'shitfaced',
'shithead',
'shithed',
'shitheads',
'slut',
'sluts',
'slutty',
'tit',
'tits',
'titty',
'titties',
'vagina',
'vaginal',
'whore',
'whores',
'whoring'];</script>
    <script type="text/javascript">ISQ.Widget = initializeNS("ISQ.Widget");

// widgetUI
ISQ.Widget.combineContext = function (contextAttributes, contextSource, customParams)
{
    if (!contextAttributes) return contextSource;

    // lower case contexts
    if (contextSource)
    {
        for (var key in contextSource)
        {
            var keyLC = key.toLowerCase();
            contextSource[keyLC] = contextSource[key];
            if (keyLC !== key) delete contextSource[key]; // removing non-LC contexts
        }
    }

    var result = null;
    if (contextSource || customParams)
    {
        for (var cat in contextAttributes)
        {
            if (contextSource && contextSource[cat.toLowerCase()]) continue; // api context is stronger than CNF

            for (var attrbNdx = 0; attrbNdx < contextAttributes[cat].length; ++attrbNdx)
            {
                var paramValue = null;
                if (customParams) paramValue = customParams[contextAttributes[cat][attrbNdx]];

                // skipping non-existing attributes
                if (!paramValue) continue;

                if (!result)
                {
                    result = [];

                    // we created a new context array. we MUST copy previous values
                    for (var tmpCat in contextSource)
                        result[tmpCat] = contextSource[tmpCat];
                }
                result[cat.toLowerCase()] = paramValue;
                break;
            }
        }
    }
    return result || contextSource;
}
</script>
    <style type="text/css">/* default widget css */
html, body {height:100%;margin: 0;padding:0;direction:ltr;overflow:hidden}
body, table, td, input, textarea {font-size:12px;font-family:Arial;}
input, textarea {outline:none; resize:none;}
img {border:0;}
h1,h2,h3,h4,h5,h6,tbody,div {margin:0;padding:0;}
a, a:hover, a:focus, a:active {outline:0;}
pre { white-space: pre-wrap; }

*{outline:0;}
select.contactform 
{
    margin:0;
    position:absolute;
    left:3px;
    left:3px\9;/*ie8*/
}
@media screen and (min-width:0\0) /*ie9+ select in contact form css fix*/
{
    select.contactform 
    {
        left:6px\9\0;
    }
}
@media \0screen /* IE8 hack */
{
    select.contactform  {left:1px;} 
}

/* cdc */
#iframeContainer {position:absolute;top:0px;left:0;z-index:-10;width:1px;height:1px;}

#txtSearch::-ms-clear {
    display: none;
}

.contextSelectionTitle
{
font-weight: bold;
  color: black;
  padding: 7px 0px;
}
.contextSelectors:last-child
{
  padding-bottom: 15px;
  overflow: hidden;
}
.contextSelectors>div
{
    height:30px;
    
}
.contextSelectors .contextLabel
{
    font-size:14px;
    color:#4a4949;
    margin-top:4px;
    float:left;
    clear:both;
    padding-right:10px;
}
.contextSelectors .contextSelect
{
  font-size:13px;
  float:left;margin-top:4px;
  min-width:150px;
  max-width:200px;  
}
.selectedContextElement
{

  height: 33px;
  /* float: right; */
  display: block;
  background-color: #D9D9D9;
  color:#516166;
  border: solid 1px #e1e1e1;
  padding: 6px 8px;
  line-height: 18px;
  margin-bottom: 5px;
  margin:5px 0px 10px 0px;
  width:100%;
}
.selectedContextElement span
{
   font-size: 12px;
   color:#516166;
  text-align: left;
  display: block;
  text-overflow: ellipsis;
  float: left;
  white-space: nowrap;
  width: 78%;
  box-sizing: border-box;
  overflow: hidden;
  height: 16px;
}

.clearSelectionLink
{
      font-size: 13px;
      cursor:pointer;
      font-weight:600;
      text-decoration:underline;
}

@media screen and (max-width:340px) 
{
    .selectedContextElement
    {
        width:270px;
    }
    .selectedContextElement span { 
        width: 75%;
    }
}

.selectedContextElementChangeButton
{

  padding-left: 5px;
  font-size: 12px;
  display: block;
  float: right;
  line-height: 17px;
  padding: 0px 5px;
  color: #516166;
  cursor: pointer;
  border-left:1px solid #ACBBBF;
  width: 47px;
  text-align: right;   
  text-decoration:underline;
}
#clearQuery
{
    z-index: 1;
    position: absolute;
    right: 8px;
    left: auto;
    top: 1px;
    color: #4a4949;
    padding: 2px 4px;
    font-size: 20px;
    display: none;
    cursor: pointer;
    opacity: 0;
    -webkit-transition: opacity 150ms ease-in-out;
    -moz-transition: opacity 150ms ease-in-out;
    -ms-transition: opacity 150ms ease-in-out;
    -o-transition: opacity 150ms ease-in-out;
    transition: opacity 150ms ease-in-out;
    text-decoration:none;
}

.hoverImagesClass
{
   -webkit-transition:top 1000ms ease, opacity 600ms ease-in-out;
    -moz-transition:top 1000ms ease,opacity 600ms ease-in-out;
    -ms-transition:top 1000ms ease,opacity 600ms ease-in-out;
    -o-transition:top 1000ms ease,opacity 600ms ease-in-out;
    transition:top 1000ms ease,opacity 600ms ease-in-out;
    opacity:0;
    position:absolute;
    z-index:1;top:150px;
    right:-600px;
    border: 1px solid rgb(223, 223, 223);
    border-radius: 11px;
    box-shadow: 2px 2px 10px gray;
    display:block;
    left:auto;
}

.opacity30
{
    opacity:0.3;
    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=30)";
    filter: alpha(opacity=30);
    -khtml-opacity: 0.30;
    -moz-opacity: 0.30;
    cursor:default;

}
.opacity20
{
        opacity:0.2;
    -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=20)";
    filter: alpha(opacity=20);
    -khtml-opacity: 0.20;
    -moz-opacity: 0.20;
    cursor:default;
}

/* classes */
.normal {font-size:12px;}
.large {font-size:13px;}
.bold {font-weight:bold;}
.borderBoxSizing {
  	-moz-box-sizing: border-box;
	-webkit-box-sizing: border-box;
	box-sizing: border-box;
}
.busy { 
	opacity:0.50;
	filter: alpha(opacity=50); /* ie5-7*/
	-ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=50)"; /*ie8*/	
}

/* elements */
#widgetContainer {
    display:none;
    width:100%;
}

.fullscreenMobile #widgetContainer {
	border:none;
	height: 100%;
	box-sizing:border-box;
}

/* body, html {height: 100%}*/

.fullscreenMobile {
	background: rgba(230,230,230,0.9);
}
.fullscreenMobile > iframe{
	border:none;
}

.fullscreenMobile #contentAreaWrapper {
	background: none;
}

.fullscreenMobile #widgetContainer {
	background: none;
}

	
	.fullscreenMobile #widgetTitleWrapper
	{
		display:none;
	}

	.fullscreenMobile #searchContainerWrapper 
	{
		height:50px;
	}
	.fullscreenMobile #txtSearch ,
	.fullscreenMobile #txtSearch.apple
	{
		height: 36px;
		font-size:16px;
		width: 88%;
	}
	.fullscreenMobile #txtSearch.initialText
	{
		font-size: 15px;
	}
	
	.fullscreenMobile #clearQuery 
	{
		top: 5px;
		right: 13px;
		font-size: 26px;
		padding-left: 10px;
		padding-right: 10px;
	}
	
	.fullscreenMobile.isRtl #clearQuery 
	{
		right: auto;
		left:15px;
		font-family: 'Open Sans',Arial !important;
	}
	
	
	.fullscreenMobile .contactForm 
	{
		width:100%;
		margin:0;
		border-radius: 0;
	}

#widgetLoading {
    margin:15px 0 0 15px;
    direction:ltr;
}

/* widget title */
#widgetTitleWrapper {
    position:relative;
    width:100%;
    height:25px;
    line-height:25px;
}


#widgetTitleDecoration {
    position:absolute;
	width:100%;
	height:2px;
	top:0;
	left:0;
	background:#fff;
	opacity:0.15;
	filter: alpha(opacity=15); /* ie5-7*/
	-ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=15)"; /*ie8*/	
	line-height:1px;
	font-size:0px;
}
#widgetTitleLeft {
    display:none;
    float:left;
    width:0;
    height:100%;
}
#widgetTitleRight {
    display:none;
    float:right;
    width:0;
    height:100%;
}
#widgetTitleText {
    float:left;
    width:85%;
    padding: 0 5px;
    font-size:17px;
    font-weight:bold;
    overflow:hidden;
    white-space:nowrap;
}
#minimizeButton {
    float:right;
    width:13px;
    height:14px;
    line-height:0;
    cursor:pointer;
    margin:0 0px 0;
    border-bottom: 4px solid #FFF;
    font-size:0;
}
#minimizeButtonWrapper
{
    float:right;
    margin:0 0px 0;
    padding:0 5px 0px 8px;
    width:15px;
}

/* search box */
#searchContainerWrapper {
	position:relative;
    text-align:center; 
    height:28px;
}
#searchContainerLeft {
    display:none;
    position:absolute;
    left:0;
    width:0;
    height:100%;
}
#searchContainerRight {
    display:none;
    position:absolute;
    right:0;
    width:0;
    height:100%;
}
#searchContainer {
	position:absolute;
    top:2px;
    bottom:2px;
    left:2px;
    right:2px;
    text-align:left;
    background-color: #FFF;
}
#searchContainer.error {
    border:solid 1px #8B0000;
}
*html #searchContainer {
    width:expression(document.getElementById('searchContainerWrapper').clientWidth-5);
    height:expression(document.getElementById('searchContainerWrapper').clientHeight-5);
}
#searchTextboxContainer {
	position:absolute;
    top:2px;
    bottom:2px;
    left:2px;
    right:25px;
}
*html #searchTextboxContainer {
    width:expression(document.getElementById('searchContainerWrapper').clientWidth-28);
    height:expression(document.getElementById('searchContainerWrapper').clientHeight-4);
}
#txtSearch {
    margin-top: 2px;
    padding-left: 5px;
	width:98%;
	height:17px;
    border:0;
    font-size:14px;
    vertical-align:middle;
}
input, input:focus, textarea, textarea:focus
{
	outline:0 none;
	outline-width:0;
	-webkit-tap-highlight-color: rgba(255, 255, 255, 0); 
	-webkit-user-modify: read-write; /* #8356 */
}
/* For iPad/iphone */
#txtSearch.apple
{
	margin-top: 1px;
	height:15px;
	border:0;
}

#txtSearch.initialText {
	font-size:13px;
	font-style:italic;
	color:#888;
}

/* search suggestions */
#searchSuggestions
{
    text-align:left;
    background-color: #fff;
    border-left:solid 1px #cdcdcd;
    border-right:solid 1px #cdcdcd;
    border-bottom:solid 1px #cdcdcd;
    display:none;
    margin:auto;
    overflow:hidden;
}
.autoCompleteDiv
{
    background-color:#ffffff;
    cursor:pointer;
    white-space: nowrap;
    padding:3px 7px;
    font-size:16px !important;
}
.autoCompleteDiv B
{
    color:#000;
}
.autoCompleteDiv_hover
{
    background:#eeeeee;
}


/* search animation */
DIV.searchAnim {
	float:right;
	margin:2px 0 0 5px;
	width:20px;
	height:18px;
	display:block;
	border:0px;
	background:transparent;
}
DIV.searchAnim DIV {
	float:left;    
	height:4px;
	width:4px;
	margin:7px 2px 0 0;
	background:#000;
	line-height:1px;
	font-size:1px;
}
/*
    opacity:0;

    -webkit-animation-duration: 300ms;
    -webkit-animation-timing-function: linear;

    -webkit-animation-iteration-count: infinite;
    -webkit-animation-direction: alternate;
    -webkit-animation-play-state: running;
    
    animation-duration: 300ms;
    animation-timing-function: linear;
    animation-iteration-count: infinite;
    animation-direction: alternate;
    animation-play-state: running;
    -webkit-animation-name: searchAnimFlow1;
    animation-name: searchAnimFlow1;
}
DIV.searchAnim DIV.block1
{
-webkit-animation-delay: 0ms; 
    animation-delay: 0ms;
}
DIV.searchAnim DIV.block2
{
  -webkit-animation-delay: 75ms; 
    animation-delay: 75ms;
}
DIV.searchAnim DIV.block3
{
 -webkit-animation-delay: 150ms; 
    animation-delay: 150ms;
}

@-webkit-keyframes searchAnimFlow1 {
    0%   {opacity:0}
    100% {opacity:1}
}

@keyframes searchAnimFlow1 {
    0%   {opacity:0}
    100% {opacity:1}
}
*/
DIV.searchAnimTranslating {
    padding:0 0 0 1px;
    height:19px;
	background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -68px;
}

/* content area */
#contentAreaWrapper {
    overflow:auto;
    overflow-x: hidden;
    overflow-y: auto;
    background-color:#FFFFFF;
    width:100%;
}
#contentAreaWrapper.empty {
    padding:0; /* used during minimizing/maximizing animations */
}
#contentArea {
    width:100%;
}

/* results hint */
#resultsHint {
    padding:2px 5px 0 5px;
    font-style:italic;
    display:none;
    overflow:hidden;
}

/* answers */
#answerPane {
	padding-top:10px;
	padding-bottom:10px;
	padding-left:7px;
	padding-right:7px;
	display:none;
}
.answerTable {
    width:100%;
    margin:0 0 20px 0;
    table-layout:fixed;
    position:relative;
}
.answerTable TR {
    vertical-align:top;
}
.pointer[data-image-url],
.answerTable TD A, .answerBackLinkContainer A {
    color:#e9682d;    
}
.answerIcon {
    text-align:right;
    width:50px;
}

.answerTitle, .answerTitle h3 {
    font-size:13px;
    font-weight:bold;
    line-height:19px;
}
.answerTitle h3
{
    padding-bottom:2px;
}
.summaryRow.expanded {
    display:table-row;
}
.summaryRow.collapsed {
    display:none;
}

.answerContextContainer
{
	margin-top:2px;
}
.answerContext
{
	font-size:11px;
	font-weight:normal;
	color:#aaa;
	margin-right:5px;
}
.answerBody {
    padding:0px;
}

TD.autoLink
{
    padding: 0 0 15px 0;
}

TD.autoLink .progressBar,
TD.autoLink .cancel
{
    display: block;
    float: left;
    clear: none;
    height: 40px;
    border-radius: 2px;
}

TD.autoLink .progressBar
{
    min-width: 100px;
    padding: 0;
    overflow: hidden;
    cursor: pointer;
    text-decoration: none;
}

TD.autoLink .progressBar .progressBarHover
{
    z-index: 10;
    position: relative;
    top: -40px;
    width: 100%;
    height: 40px;
    background-color: black;
    opacity: 0;
    filter: alpha(opacity=0);
}

TD.autoLink .progressBar:hover .progressBarHover
{
    opacity: 0.4;
    filter: alpha(opacity=40);
}

TD.autoLink .progressBar .progressBarBG
{
    z-index: 11;
    position: relative;
    top: -43px;
    margin: 0;
    padding: 0;
    width: 0;
    height: 3px;
    background-color: black;
    opacity: 0.5;
    filter: alpha(opacity=50);
}

TD.autoLink .progressBar .progressBarText
{
    z-index: 12;
    position: relative;
    margin: 0 20px;
    line-height: 40px;
    overflow: hidden;
    text-overflow: clip;
    white-space: nowrap;
    color: white;
}

TD.autoLink .cancel
{
    padding: 0 10px;
    margin: 0 5px;
    line-height: 40px;
    text-decoration: none;
    font-size: 12px;
    color: #333;
    background-color: #f8f8f8;
}

TD.autoLink .cancel:hover
{
    background-color: #eee;
}

A.thumbUp {
    float:left;
    display:block;
    width:22px; 
    height:21px; 
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -244px;    
    margin-top:-1px;
    text-decoration:none;
}
A.thumbUpApplied {
    float:left;
    display:block;
    width:22px; 
    height:21px;
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -265px;
    margin-top:-1px;
    text-decoration:none;
}
A.thumbDown {
    float:left;
    display:block;
    width:22px; 
    height:21px; 
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -286px;    
    margin-top:-1px;
    text-decoration:none;
}
A.thumbDownApplied {
    float:left;
    display:block;
    width:22px; 
    height:21px;
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -310px;
    margin-top:-1px;
    text-decoration:none;
}


A.translationIcon {
    float:left;
    display:block;
    width: 19px;
    height:19px;
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -45px;
    text-decoration:none;
}
A.translationIconOff {
    float:left;
    display:block;
    width: 19px;
    height:19px;
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -68px;
    text-decoration:none;
}
.nanoRepMP_likeIcon  { 
    width:21px; 
    height:21px; 
    line-height:19px; 
    /*float:right; 
    padding:0 0 0 26px; */
    font-size:11px; 
    text-align:left;
    cursor:pointer; 
    background: url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 2px -244px; 
    display:inline-block;
}
.answerIcon .nanoRepMP_likeIcon  { 
    width:21px; 
    height:21px; 
    background: url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 2px -597px; 
}
.answerIcon .nanoRepMP_likeIconCurrent,
.nanoRepMP_likeIconCurrent 
{ 
    color: #479503; 
    font-weight:bold; 
    background: url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 2px -265px; 
}
.nanoRepCSStransition
{
    -webkit-transition:background-color 300ms ease-in-out,width 300ms ease-in-out, height 300ms ease-in-out, top 300ms ease-in-out , left 300ms ease-in-out, bottom 300ms ease-in-out, right 300ms ease-in-out;
    -moz-transition:background-color 300ms ease-in-out,width 300ms ease-in-out, height 300ms ease-in-out, top 300ms ease-in-out , left 300ms ease-in-out, bottom 300ms ease-in-out, right 300ms ease-in-out;
    -ms-transition:background-color 300ms ease-in-out,width 300ms ease-in-out, height 300ms ease-in-out, top 300ms ease-in-out , left 300ms ease-in-out, bottom 300ms ease-in-out, right 300ms ease-in-out;
    -o-transition:background-color 300ms ease-in-out,width 300ms ease-in-out, height 300ms ease-in-out, top 300ms ease-in-out , left 300ms ease-in-out, bottom 300ms ease-in-out, right 300ms ease-in-out;
    transition:background-color 300ms ease-in-out,width 300ms ease-in-out, height 300ms ease-in-out, top 300ms ease-in-out , left 300ms ease-in-out, bottom 300ms ease-in-out, right 300ms ease-in-out;
}


.nanoRepMP_dislikeIcon  { background: url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 1px -287px; }
.nanoRepMP_dislikeIconCurrent  { background: url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 1px -310px; }
.nanoRepMP_dislikeIconOpen  { background-position: 1px -287px; }

.nanoRepMP_dislikeOptions
{
    box-shadow: 0 4px 8px #8B8B8B; -moz-box-shadow: 0 4px 8px #8B8B8B; cursor:default; z-index:2;
     display:none;position:fixed;
    top:0px;
    -moz-border-radius: 6px;
	-webkit-border-radius: 6px;
	border-radius: 6px;
	font-family: 'Open Sans', Arial;
	padding:15px;
	width:359px;
	height:214px;
	border:6px solid #c3c3c3;
	background-color:white;
	color:#333;
}
.nanoRepMP_dislikeOptions table td:first-child
{
    width:24px;
}

.nanoRepMP_dislikeOptionsTitle
{
    font-weight: 400;
    padding: 18px 0 15px;
    font-size: 20px;
    text-align: center;
}
.nanoRepMP_dislikeOptions table 
{ 
    margin:12px auto;
    width: 83%;                              
}
.nanoRepMP_dislikeOptions table label
{
    font-size:15px;
}

.nanoRepMP_dislikeOptions table tr { height:20px; }
.nanoRepMP_dislikeOptions input{font-size:13px;}
.nanoRepMP_dislikeOptions input[type="radio"]
{
    cursor:pointer;
    position: static;                                          
}
.nanoRepMP_dislikeOptionsBtns
{
    width: 166px;
    height: 44px;
    margin: 0px auto;
}

.nanoRepMP_dislikeOptions.validationErr table td:first-child { background-color:#aa0000; color:#fff; }
.nanoRepMP_dislikeOptions table tr td:last-child { font-size:13px; color: #333; padding:0 10px;}


.nanoRepMP_dislikeOptions .button 
{
     display: block;
    width: 75px;
    float: left;
    padding: 0px;
    margin-top: 10px;
    height: 32px;
    line-height: 32px;
    color: #FFF;
    text-decoration: none;
    background-color: #1b0476;
    font-size: 16px;
    text-align: center;  
    text-indent:0px !important;
}
.nanoRepMP_dislikeOptionsBtns a.buttonLink
{
    margin-left:15px;
    background-color:#e7e5e6;
    color:#333 !important;
    
}
.nanoRepMP_dislikeOptions .closeIcon
{
    width:10px;
    height:10px;
    position:absolute;
    top:7px;
    right:7px;
    text-decoration:none;
    color:#cbcbcb;
    font-family:arial;
    font-weight:bold;
    font-size:14px;
    display:block;
    display:none;
}

.narrowWidget_dislikeOptions
{
    width:282px;
    height:174px;
    padding:6px;
}
.narrowWidget_dislikeOptions .nanoRepMP_dislikeOptionsTitle 
{
    font-size:16px;
    padding:13px 0 6px;
}
.narrowWidget_dislikeOptions table
{
    margin: 7px auto;
    width: 87%;
}
.narrowWidget_dislikeOptions table label
{
    font-size:13px;
    line-height:18px;
    color:#333;
    font-weight:normal;
}
.narrowWidget_dislikeOptions .nanoRepMP_dislikeOptionsBtns
{
    width:100%;
    text-align: center;
}
.narrowWidget_dislikeOptions .button
{
 min-width:63px;
 height:30px;
 line-height:29px;
 font-size:14px;
 display:inline-block;
 float:none;
 
    
}


.answerIcon .likes 
{
    float:left;
    text-align:left;
    font-size:11px;
    margin-top:1px;
}

.newlikes 
{
    float: left;
    text-align: center;
    font-size: 11px;
    margin-top: 5px;
    border: 1px solid #aaaaaa;
    border-left: 0px;
    height: 16px;
    line-height: 16px;
    color: #666666;
    padding: 0px 4px 0px 3px;
    min-width:24px;
}

.articlelikeContainer
{
    box-sizing: border-box;
    float: left;
    width: 100%;
    height: 37px;
    border-top: solid 1px #F2F2F2;
    padding-top: 8px;
    margin-top:5px;
}
.articlelikeContainer>.iLike
{
    text-align:center;float:left;height:25px;border-radius:0px 0px 4px 0px;padding-right:5px;
}
.articlelikeContainer>.iDontLike
{
    float:left;width:20px;height:25px;border-radius:0px 0px 0px 4px;padding-left:2px;padding-top:3px;
    margin-top:3px;
}

.newLikesLeftEdge
{
    background: url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0px -558px;
    width:5px;
    height:18px;
    float:left;
    margin-left:3px;
    margin-top:5px;
}
.answerIcon .newLikesLeftEdge
{
    background: url(/widget/skins/sprites.png?cv=8d19a47a95f9b9c) no-repeat 0px -558px;
    width: 5px;
    height: 16px;
    float: left;
    margin-left: 3px;
    margin-top: 4px;
}
.answerIcon .newlikes {
    height: 14px;
    min-width: 20px;
    margin-top: 4px;
    line-height:14px;
    color:#A6A6A6;
}

.newlikesRTL
{
    float: right;
    border-left: 1px solid #aaaaaa;
    border-right:0px;
    padding: 0px 4px 0px 3px;
}
.newLikesRightEdge
{
    background: url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0px -577px;
    width:5px;
    height:16px;
    float:right;
    margin-left:0px;
     margin-right:3px;
    margin-top:6px;
}


.answerFooter {
    padding:15px 0 0 0;
}
.answerBackLinkContainer {
    padding:0 0 4px 0;
}
.chatInviteDiv {
    width:100%;
    text-align:center;
    cursor:pointer;
}
.answerPeek {
    position:fixed;
    background-color:#777;
    color:#FFF;
    padding:5px;
    font-weight:bold;
    font-size:13px;
    cursor:pointer;
    opacity: 0.9;
    -ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=90)"; /*ie8*/
}
.pagedContainer {
    overflow:hidden;
}
.answerTable .pager .pagerLink,
.answerTable .pager .pagerCurrent {
    font-size:15px;
    margin-right:6px;
}
.answerTable .pager .pagerCurrent {
    font-weight:bold;
    padding:2px 6px 2px 0;
}
.answerTable .pager .pagerMiddle {
    font-size:15px;
    padding-right:6px;
}
.answerTable .pagerLink.next, 
.answerTable .pagerLink.prev {
    background-color:#e9682d;
    padding: 1px 5px;
    font-size:14px;
    text-decoration:none;
}
.answerTable .pagerLink.next {
    margin:0 10px;
}
.noResults {
    padding: 0 0 10px 0;
    clear:both;
}

/* faq */
.faqTitle, .faqTitle h2 {
    font-size:15px;
    font-weight:bold;
    margin:10px 0 10px 0;
}
.faqTitle h2
{
    margin:0px;
}
.answerTable.faq {
    padding:6px 0 ;	
	margin:0px;
	line-height: 100%;
    border-bottom:solid 1px #E5E5E5;
}
.answerTable.faq .answerTitle {
    line-height:normal;
    cursor:pointer;
}
.answerTable.faq:hover {
    background-color:#E5E5E5;
}
.answerTable.faq .titleText, .answerTable.faq .titleText h3 {
    color: #00005A;
    font-weight:normal;
    padding:0 0 0 34px;
}
.answerTable.faq .titleText h3
{
    font-size: 12px;
    padding: 0;
    display:table-cell;
    line-height:14px;
}
.answerTable.faq .titleText:before {
    content: '?';
    float:left;
    background-color: #A9A9A9;
    width:17px;
    height:17px;
    line-height:17px;
    margin:0px 12px 0 -27px;
    padding:0;
    color:#FFF;
    font-size:12px;
    font-weight:bold;
    text-align:center;
}
.answerTable.faq .answerTitle.expanded>DIV.titleText:before {
    background-color: #333333;
}
.answerTable.faq .faqText,
.answerTable.faq[dir=ltr] .faqText { /* when translating #8959 */
    clear:both;
    width:80%;
    margin:10px 0 5px 37px;
    line-height:140%;
}

@media screen and (max-width:480px) 
{
    .answerTable.faq .faqText,
    .answerTable.faq[dir=ltr] .faqText { 
        width:79%;
    }
}

/* contact form */
.contactForm .contactFormField
{
	background-color: White;
}

/* action bar */
#actionBarWrapper {
    width:100%;
    display:none;
    height:27px;
    font-weight:bold;
    font-size:13px;
    background-color:#FFF;
}
#actionBarContainer {
    height:100%;
    background-color: inherit; /* for ie fade animation */
}
.actionBar {
	padding-top:5px;
	padding-right: 5px;
	padding-left: 5px;
}
.actionBar A,
.actionBar A:visited {
    text-decoration:none;
}
.actionBarText {
    float:left;
    margin-right:15px;

}
.actionBarSep {
    padding:0px 10px;
    text-align:center;
    float:left;
    display:none;
}

#actionBarContainer {
    direction:ltr;
}

#actionBarQuery A,
#actionBarChat A {
    display:none;
    float:left;
}
A#ancEmailChatSend,A#ancEmailChatCancel
{
    display:inherit;
}
.repByEmail, .customLink {
    text-align:right;
	background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -111px;
	padding:0 0 0 24px;
}
.noActionBarIcon {
    background:none;
}
.repByChat, .customChat {
    text-align:right;
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -128px;
    padding:0 0 0 24px;
}
.repByVoice {
    text-align:right;
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -627px;
    padding:0 0 0 22px;
}
#chatPane .clientIcon, #chatPane .agentIcon
{
    display:none;
}
/* widget footer */
#widgetFooterWrapper {
    position:relative;
    width:100%;
}
.widgetFooterDecoration {
	background:#fff;
	height:2px;
	opacity:0.25;
	filter: alpha(opacity=25); /* ie5-7*/
	-ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=25)"; /*ie8*/
	width:100%;
	position:absolute;
	bottom:0;
	left:0;	
	font-size:0px;
	line-height:1px;
}
#widgetFooter {
    height:20px;
    padding:0 5px;
    line-height:19px;   /* if set to 20px causes a redundant scroll */
    font-size:11px;
    vertical-align:middle;
}
#widgetMinimizedFooter {
    display:none;
    height:4px;
    font-size:0;
    position:relative;
}
#widgetFooter A,
#widgetFooter A:visited {
    text-decoration:none;
}
#customerLogo,
#customerBrandingText {
    display:none;
    float:left;
}
#footerChatLink {
    display:none;
    float:left;
    cursor:default;
}
#footerNanoRepLink {
    float:right;
    margin-right:-5px;
}

/* chat */
#chatStatusWrapper {
    display:none;
    width:100%;
}
#chatStatusSystem
{
    display:none;
    line-height:20px;
    clear:both;
    width:70%;
    margin:0 25px;
}
#chatStatusContainer {
    min-height:37px;
    font-size:12px;
    padding:0 0 0 10px;
    line-height:37px;
}
#chatStatus {
    float:left;
    width:70%;
    white-space:nowrap;
    overflow:hidden;
}
#chatStatusIcon {
    float:left;
    height:18px;
    width:22px;
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0px -128px;
    margin:11px 3px 0 0;
}
#chatStatusContainer.chatStatusContainerMinimized {
    height:28px;
    line-height:28px;
}
#chatStatusContainer.chatStatusContainerMinimized #chatStatusIcon {
    margin-top:6px;
}
#chatStatusContainer.chatStatusContainerMinimized #chatStatus {
    width:80%;
}
.chatStatusAgentName {
    font-weight:bold;
}
#closeChat {
    float:right;
    width:69px;
    white-space:nowrap;
    overflow:hidden;    
    font-size:12px;
}
#chatPane {
    display:none;
    line-height:150%;
    font-size:13px;
	padding:5px 10px 10px;
}

#actionBarChat,
#actionBarChatSurvey {
    display:none;
}
#chatInputWrapper {
    position:relative;
    display:none;
    height:52px;
    padding-top:3px;
}
#chatInputContainer {
    height:46px;    
    padding:3px 0 0 0; 
    margin:0 3px 0;
    background-color:#FFF;
}
#txtChatInput {
    width:70%;
    height:40px;
    float:left;
    border:none;
    resize: none;
    overflow: auto;
    font-size:13px;
    margin:0 0 0 5px;
    border:0;
}
#btnSendChat {
    height:30px;
    float:right;
    margin:6px 3px 0 0;
    -webkit-appearance: none;
}
#chatPane .padded {
    padding: 0 0 5px 0;
    word-wrap:break-word;
}
#chatPane .chatSysMsg 
{
	font-style:italic;
	color:#aaa;
}
#chatPane .chatAgentName {
    font-weight:bold;
    color:#13469F;
}
#emailChatContainer {
    width:100%;
    margin-top:-2px;
    display:none;
}
#txtEmailChat {
    float:left;
    width:130px;
    height:15px;
}
#ancEmailChatSend,
#ancEmailChatCancel {
    display:block;
    float:left;
    margin: 2px 0 0 7px;	
}

/* chat suggestions */
#chatSuggestions {
    display:none;
    position:absolute;
    width:98%;
    top:54px;
    left:3px;
    overflow:hidden;
    z-index:10; 
    opacity:0.95;
	filter: alpha(opacity=95); /* ie5-7*/
	-ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=95)"; /*ie8*/
}
.chatSuggestion {
    overflow:hidden;
    padding:3px 5px 2px;
    cursor:pointer;
}

/* chat quick answers */
.quickAnswerHeading {
    font-style:italic;
	padding:2px 0 4px 0px;
}
.quickAnswerTitle {
    font-weight:bold;
    padding:0 0 2px 5px;
	font-size: 13px;
}
.quickAnswerExpand {
    width:12px;
    height:12px;
    margin:4px 0 0 0;
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -183px;
}
.quickAnswerCollapsed {
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -149px;
}
.quickAnswerBody {
    padding:0 0 0 15px;
    margin:0 0 0 6px;
    border-left: solid 1px;
}

/* translation tooltip */
.translationTooltip {
    position:absolute;
    top:0;
    left:0;
    padding:3px;
    font-size:11px;
    visibility:hidden;
}
.translationTooltip P {
    margin:0;
}

/* external answer sources */
.answerSourceIcon {
    display:block;
    width:21px;
    height:15px;
    background-repeat:no-repeat;
}
.twitterSourceIcon {
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -92px;
}
#customLink { display:none; }

/* attachments */
ul.attachments  {
    margin:0;
    padding: 10px 0 0 10px;
}
ul.attachments li {
    list-style:none;
    min-height:18px;
    margin:4px 0 0 0;
}
ul.attachments li:before {
    float:left;
    width:23px;
    height:18px;
    content:'';
    background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -222px;
}

/* logo in collapsed mode */
#logoInCollapsedMode { display:none; }

/* nanoRep link colors */
.link_nano { color:#346a7a; }
.link_nano_img
{
    background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADEAAAAKCAYAAAAdIbZyAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAxhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDM0MiwgMjAxMC8wMS8xMC0xODowNjo0MyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDowRkFENDRDRkY3N0QxMUUzQjAwQThCOEJEMjZCNjZFNyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDowRkFENDREMEY3N0QxMUUzQjAwQThCOEJEMjZCNjZFNyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjBGQUQ0NENERjc3RDExRTNCMDBBOEI4QkQyNkI2NkU3IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjBGQUQ0NENFRjc3RDExRTNCMDBBOEI4QkQyNkI2NkU3Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+WLmBvAAAAvxJREFUeNrUldtvy2EYx3+HdoatmIh1dHMYLS6IkIgYF4Q4lAvRxCGIQ+J0gTl1CTckJMIFhguHmyHBZMFMZBLEFnHBhZhlGTaqkQXdWtp1v7Y/3ye+Td41+wc8yafv7/Q873N8q2uatgr8AAvAeNAE7oNf2j9xgZVgPvgOboEPYBiffQFzgAe8BC9AnLrDwVK+7wS3Qcjr9Wp+vz8vEomsxf0+8A7sBeUgCKaDMLgEboIMMMASfj8NfARnwEMTP6/BZjACpMEmMBs0UvEa2Aa6+XwneEXDz8BGMBkUg11gDHgOhlB3O79dDNYYhtHk8/m63G53ZTKZrMaz36COe0mCimi/iH5ZoFl0QQ3IB2/ABPry3kHHa8EWZm8WuA42gCSYAlbTkMgNcAxU0TlxYCtIgeXgMhNQwowt46bi1B1d16ssyzqJAPbgusG27XVMkFR/NB2TbigDF+lXM1fpBD9oBWO5d1CCiNKxrEhpH4BFvK+XaJX35xikly1ylQGIPAKPGXQhuKvoSntegOMHTNOch+sC7tPN7JaCPrACrAcJ8Jnvpc0msfKttBfKBpethKU4aTDDUmYbjKNDPXwvzg8Fedworug6ea8rug5W1OTMpZH9OIJJch+RXuol2OdtbG+ZqXbayWcgxazIIDAVdBn8eLDWX9x0qIbtdJYDugOcpkFxdNQAuiVcpb8rwAkwF+wGh5xOZ63L5QrRmQJFr5p2g5yzSg6xJCvCSlawCw6De2Ch6DnYi2HFWJo9LME9BUdoWNooxpYZCb6CJ5IJRVcy+5aZb+Ts7OfpZnPQz6MKM0BdJpNpwaopQUuFDzJhP8EVrhOZ1G88BU/xRD0qM6jToajSUjqNmXQ6w+yWsqU6GGCEVYgqM6HzSNYU3XIOoXzf4vF4rEAgkBeLxQpTqdQfBNGbU8kyVjjGvSQhM+UoBQ3gONtMWu+T+O1gpKrYnAdVwjnVSuSsqm5PzrN2okrfAPtmpZOooist3JGrYGj/h0T5R9rGQPrJXwEGAA8b5+lRZh6uAAAAAElFTkSuQmCC);
    background-repeat:no-repeat;
    background-position:0px 6px;
    width:57px;
    height:17px;
    display:block;
    padding-top:1px;
    line-height:17px;
}
.link_go_response {
    background-image : url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADUAAAASCAYAAAGMSKZoAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMDE0IDc5LjE1Njc5NywgMjAxNC8wOC8yMC0wOTo1MzowMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpmY2FhYzMzZC04MGFhLTY0NDQtOGVjZC1hNzFmZDA3OTA4MTMiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6QkY5M0E0NDAwRDI4MTFFNUE0NUFGMjc2NTZEMzAwOUYiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6QkY5M0E0M0YwRDI4MTFFNUE0NUFGMjc2NTZEMzAwOUYiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTQgKFdpbmRvd3MpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6ZmNhYWMzM2QtODBhYS02NDQ0LThlY2QtYTcxZmQwNzkwODEzIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOmZjYWFjMzNkLTgwYWEtNjQ0NC04ZWNkLWE3MWZkMDc5MDgxMyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pmb6KhAAAARdSURBVHjaYvz//z8DLsDi7+8Pou2YmZlDgHTe379/FYD0cyAuYcSnEyCA8EqyBAQENAIV6AONrQXyTYDGzgfSUkBsjVcnQAAx+vn5MQB1cQDZzEBdOkC6C8i3hykAiqFo2LhxI8RKqOR2IHUPiOcCNV0B0plAvBaIfwOxKchQIH4GxBJAn4PYfwECCK9zCDmTG6iZ8d+/fx5A9hpkBdicyQJUxAqUWA7k+4IMgcptBeKvQHwQiNmAmBuIQU5qBTrRjwmoAeR2kL8EoBpmA/FhIK4CYiMg7gfivUAM8q8MEJ8gy08AAQT2EwHQB/RCES5JdD+jA1hUgQATiAAa5gnE/2GYkZExAOp3kFw3kIok4CAxLGJqGMkRKW14A3EoEH8D4nYgFoeqSYDy5YA4CYgXQsUFgfgqEDcAMTsQg3xfBkqUUD1vgPgWMKIygPQWIP4OC0YrIPYE4lQgXgDVmAfEG4D4BQMFADkYAQKIrIgmB+BLHKDgbQbGVyU+A4hNHEwwAaCBvKAcxsTEJAjKOEChz0DMCzSIiRo+gqXAeUDqExB/Aaa+u0DDn0HjKgcoFw2kRfGYIYVDXBFb0FkC8SogLgdiWyAGpRhGoCWzgHQaVO1cYHwuBDqEE5SSoEWCKNBRbVA1oGLjJzRV3gbip0DsCM35M2DBchyID0At/ABN6iDAi+SoI0BLEqFJ+BAQr4Qm5cvQFAsqf48CsTAQnwNibSDmAcYRyKJJyOEP0mwAxBagcgcqlg3NP6CaxBiI3wMxJ1ROHVhaFgDpydD8dBIaEruAOBZq1nFgfgL5VhMUdCCXhAPxTCCeDy3gQAXiMiBeQ2kigKU6uuUjgADdljsoxWEYxqOjDEI6iRTlUlIni5QyGBRlo9gZlAyGw8CkDEixKIYzmSwoO5EMLpEJJbcMEg6TW/I89VN/OuUyIP96+t+/9/u+932f5/mxQD95fEY5Eh3W5UbhSsgSatQNS98Z6CNy+QqlvhENOMLVXyuMmCdozTu6JFUZ7VZRV9Kiiyh7WHjQv7d/KVOhwHVcE9/Wuc88Izrwu2Zc0qgWFGFB9yiiN8K8My5cCk/CmLD5Qcw8c5RiTSvGI89sgRx7KPCd3dgz8p8EfF9Kwx/4IzFDsrL1rHOObgvMfaFAGZzhnwaElHcTqQpcdwpHXPcLC8Jg4H0YK1AvFGEjXZprWAGT7pgWZL82C6HH4NgSqsP2LIq3a2Fjo4xvutw1pwrtWlAHzwuFOnN26N3k91ltLzuaxo4dM5kDZScW6IO7BPIUg68XMEmm0lO4+BrfvCVMaZxinSNku0xowvN4IyqwNsMIRyOt4DEy0IEOZaiBOSwz/9NEwt3GbmfihF1ydv0rLjFNJD2Q3VYEY47AzkwX6tSDCT4RduhRH6vcT8lIFNDDcZ5PkuVyMjeBKFUL58K8uUG4IIbN9o0wo4ztMW6+2S+P9GZTv3aM69RtsK5fHaUHyqW3NoTD3ySFROz3L3XqBdvBaDBJrnH7AAAAAElFTkSuQmCC) !important;
    margin-top: -8px !important;
    padding-top: 8px !important;
    padding-left: 4px;
}
.link_nano_img.padding
{
    padding-right:53px;
    background-position:60px 6px;
}
*+html .link_nano_img.padding{padding-right:0px;width:107px;}
.link_rep { color:#315552; }

/* widget blocker */
#widgetBlocker {
    display:none;  
    position:absolute;
    left:0;
    top:0;
    width:100%;
    height:100%;     
}
.widgetFAQBlocker,
#blockerOverlay {    
    position:fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
	background:#000;
	opacity:0.4;
	z-index:1;
	filter: alpha(opacity=40);
	-ms-filter:"progid:DXImageTransform.Microsoft.Alpha(Opacity=40)";    
}
.overlay{position:fixed;z-index:2;display:none;}
.widgetFAQBlocker
{
    background-color:#555;
}

#blockerContent {    
    position:absolute;
    left:50%;
    top:50%;
    width:121px;
    height:20px;      
    padding:10px;       
    margin:-59px 0 0 -60px;
    color:#000;
    background-color:#c0c0c0;
    text-align:center;
    direction:ltr;
    z-index:1;
    border-radius:5px 5px 5px 5px;
    -moz-border-radius:5px 5px 5px 5px;
}

/* voice escalation overlay */
#phoneNumberOverlay
{
    padding: 10px 20px;
    background:#fff;
    width:290px;
    min-height: 205px;
    border:3px solid #bbb;
    
    text-align:center;
}
#phoneNumberOverlay A.phoneNumber
{
    margin-top: 20px;
    font-size:27px;
    color: #0099c8;
    max-width: 250px;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
    direction: ltr;
    
    display:inline-block;
}
#phoneNumberOverlay A.phoneNumber:before
{
    content:'';
    float:left;
    width:24px;
    height:32px;
    background: url(/widget/skins/phone_big.png?cv=8d23815d6de1171) no-repeat 0 0;
    margin-right:12px;
    margin-top:5px;
    background-clip:content-box;
    
    display:inline-block;
}
#phoneNumberOverlay div.phoneDetails
{
    float:left;
    width: 90%;
    font-size:14px;
    text-align:center;
    padding:15px 5%;
    color:#252525;
    max-height: 100px;
    overflow: auto;
    
    display:inline-block;
}
#phoneNumberOverlay div.buttonWrapper
{
    display:block;
    position:absolute;
    bottom:4px;
    text-align:center;
    width:290px;
    background: #fff;
    padding: 9px 0;
}
#phoneNumberOverlay A.button
{
    height:26px;
    line-height:26px;
    background-color:#0099c8;
    color:#FFF;
    font-size:14px;
    font-family:Arial;
    text-align:center;
    padding: 2px 24px;
    text-decoration:none;
    
    display:inline-block;
}

/* chat survey */
.surveyContainer 
{
}
.surveyLoading {
    position:absolute;
    left:50%;
    top:50%;
    width:142px;
    height:20px;  
    margin:10px 0 0 -58px;
    font-size:16px;
}
#blockerContent .surveyLoading
{
    margin-top: -11px;
}
.surveyLoading .searchAnim {
    float:left;
    margin:-1px 0 0 5px;
}
.surveyLoading .searchAnim DIV {
	float:left;    
	height:13px;
	width:4px;
	margin:5px 2px 0 0;
	background:#000;
	line-height:1px;
	font-size:1px;
}

#actionBarChatSurvey {
    width:100%;
    padding-top:7px;
}
INPUT.inputTxt, TEXTAREA.inputTxt {
    border: solid 1px #c0c0c0;
    width: 155px;
}
SELECT.surveySelect {
    width: 155px;
}
.mandatory { 
    color: #AA0000; 
    font-size:15px; 
} 
.surveryHeading {
    font-size:13px;
    font-weight:bold;
    margin:0 0 10px 0;
}
TD.question {
    width:155px;
    font-weight:bold;
    vertical-align:top;
}
#chatSurveySubmitButton {
	border-radius: 5px;
	-moz-border-radius: 5px;
	padding: 3px 22px 3px 20px;
	margin: 0px 0px 0px 0px;
	background: #1A85D5;
	color: white;
}
#chatSurveyCloseButton {
	border-radius: 5px;
	-moz-border-radius: 5px;
	padding: 3px 15px;
	margin: 0px 0px 0px 0px;
	background: #777;
	color: white;
	margin-right: 15px;
}
.validationError TR TD {
    background-color:#aa0000;
    color:#fff;
}
.validationError .mandatory {color:#fff;}

/*** mobile back **/
A#mobileBackBtn
{
	background: none repeat scroll 0 0 #FFFFFF;
    border: 1px solid #BBBBBB;
    border-radius: 4px;
    color: #000000;
    font-size: 12px;
    opacity: 0.6;
    padding: 3px 3px 1px 3px;
    text-decoration: none;
}
A#mobileLink
{
	display:none;
	text-decoration:none;
	position:absolute;
	top:0;
	left:0;
	z-index:1;
}
#mobileScrollPadding
{
	width:100%;
	display:none;	
}



/*** debug popup ***/
#debugPopup
{
    position:absolute;
    top:0px;
    left:0px;
    width:130px;
    border:1px solid #aaa;
    background:#f8f8f8;
    display:none;
    padding:2px;
    direction: ltr;
    text-align:left;
    z-index:5;
}
#debugPopup A
{
    color:#0077cc;
    padding:1px;
    text-decoration:none;
    font-size:10px;
    display:block;
}
/* olark hide chat */
.olrk-state-expanded
{
    display:none !important;
}
/* snapengage disable*/
#SnapABug_Button,#SnapABug_W,#SnapABug_WP
{
    display:none;
}


.likesDefaultPadding
{
    padding:0px 15px;
}


.answerTable.faq .faqLikesPadding
{
    padding:0px 34px;    
}

/* blockquote */
blockquote.enabled 
{
    padding:20px 25px 20px 35px;
    margin:0;
    color:#eb7600 !important; 
    cursor:pointer;
    background-color:#fff9e6;
    position:relative;
}
blockquote.enabled * {color:#eb7600 !important;}
blockquote.enabled *:first-child{margin-top:15px !important;}
blockquote.enabled p:last-child{margin-bottom:0 !important; padding-bottom:0 !important;}
blockquote.enabled *:last-child{margin-bottom:15px !important; padding-bottom:0 !important;}
blockquote.enabled::before
{
    content: "";
    background-image: url(/widget/skins/sprites.png?cv=8d2b6984435acaa);
    background-position: 0px -677px;
    background-color:#fff9e6;
    background-repeat: no-repeat;
    
    width:16px;
    height:16px;
    position:absolute;
    right:auto;
    left:10px;
    top:10px;
    
    /*
    margin-left: -30px;
    padding-right: 30px;
    float: left;
    width: 16px;
    height: 16px;
    width: 100%;
    padding-left: 0px;
    margin-right: 0px;
    */
}
blockquote.enabled::after
{
    content: "";
    background-repeat: no-repeat;
    background-image:url(/widget/skins/sprites.png?cv=8d2b6984435acaa);
    background-position: 0px -699px;
    background-color:#fff9e6;
    
    width:16px;
    height:16px;
    position:absolute;
    left:auto;
    right:10px;
    bottom:10px;
    /*
    padding-left: 0px;
    margin-right: -10px;
    float: right;
    width: 16px;
    height: 16px;
    margin-bottom: 20px;
    margin-left: 0px;
    padding-right: 0px;
    */
}

blockquote.enabled:hover::before{background-position:0px -721px;background-color:#ffe2b3;}
blockquote.enabled:hover::after{background-position:0px -743px;background-color:#ffe2b3;}
blockquote.enabled:hover{background-color:#ffe2b3;}
blockquote.enabled:hover * {color:#ad3700 !important;}
blockquote.enabled:hover {color:#ad3700 !important;}


/* resolving bug #10771 (changing LP img position */
@-moz-document url-prefix() { 	body > img{position:fixed;top:-500px;} } 


/* Speech Button*/
#speechButton {
	width: 28px;
	height: 28px;
	position: absolute;
	right: 16px;
	top: 9px;
	cursor: pointer;
	display: none;
}

.fullscreenMobile.isRtl #speechButton {
	left: 18px;
	right:auto;
}

 #speechButton .speech_microphone {
	width: 28px;
	height: 28px;
	background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -870px;
	position: absolute;
	z-index: 2;
}

#speechButton.active .speech_microphone {
	background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -906px;
}

#speechButton.active .speech_ring {
	display: block;
}

#speechButton .speech_ring {
	display: none;
	position: absolute;
	top: 0;
	left: 0px;
	width: 20px;
    height: 20px;
	border: 4px solid #aaa;
	-webkit-border-radius: 30px;
	-webkit-animation: pulsate 1s ease-out;
	-webkit-animation-iteration-count: infinite; 
	opacity: 0.0
	
}

#speechButton.command-mode .speech_ring {
	border: 4px solid orange;
}

@-webkit-keyframes pulsate {
	0% {-webkit-transform: scale(0.1, 0.1); opacity: 0.0;}
	30% {opacity: 1.0;}
	50% {opacity: 1.0;}
	100% {-webkit-transform: scale(1.1, 1.1); opacity: 0.0;}
}

</style>
<style type="text/css">@import url(//fonts.googleapis.com/css?family=Open+Sans:400,600);html.widgetskin_css_file{direction:rtl}
*{font-family:'Open Sans',Arial}body,table,td,input,textarea,div,span,p{font-family:'Open Sans',Arial;font-size:14px}
.contactForm .CF_listDivItem input[type="checkbox"],.contactForm .CF_listRadioDiv .CF_listDivItem input{margin-top:4px}
.contactForm{background-color:#f9f9f9}#widgetContainer{background-color:#e6e6e6;border:solid 1px #009fd4;border-top-width:1px;border-bottom-width:1px;-moz-border-radius:5px 5px 5px 5px;-webkit-border-radius:5px 5px 5px 5px;border-radius:5px 5px 5px 5px;overflow:hidden;*border:0}
#widgetContainer.fullScreen{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0}
.widgetBGcolor{background-color:#009fd4}.widgetBGColorAsText{color:#009fd4}
.widgetTextColor{color:#fff}#widgetTitleWrapper{background-color:#009fd4;height:36px;line-height:35px}
h1#widgetTitleText{color:#FFF;padding:0 12px;width:80%;font-size:15px;font-weight:normal}
@media screen and (min-device-width:480px){#minimizeButtonWrapper{padding-right:12px}
}#minimizeButton{border-bottom:0;margin-top:11px;width:14px;height:14px}#minimizeButton.widgetActive{background:url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -384px}
#searchContainerWrapper{background-color:#fff;height:34px;border-bottom:solid 1px #ccc;text-align:left}
#searchContainer{left:0;right:0;height:31px;line-height:31px}#searchTextboxContainer{left:0;bottom:3px;right:0}
#txtSearch{color:#4a4949;width:90%;padding:4px 0;font-size:15px;margin-top:1px;margin-left:12px;height:20px}
DIV.searchAnim{margin:5px 5px 0}@media screen and (-webkit-min-device-pixel-ratio:0){::i-block-chrome,#txtSearch.initialText{font-style:normal}
}.nanoRepMP_likeIcon{margin-top:0;background-position:0 -243px}.nanoRepMP_likeIconCurrent{background-position:0 -265px}
.nanoRepMP_likeIcon.noCount{padding-top:0;margin-top:5px;margin-bottom:5px;height:20px}
.nanoRepMP_likeIcon SPAN{background-color:#fff;width:18px;height:13px;line-height:12px;display:block;text-align:center;font-size:10px}
.nanoRepMP_likeIcon.noCount SPAN{display:none}.answerTable.faq .titleText h3{color:#444;font-size:15px;padding:0}
#contentArea{width:100%}#contentAreaWrapper{color:#5F6061;width:auto;background-color:#eee}
@-moz-document url-prefix(http://),url-prefix(https://){scrollbar{-moz-appearance:none!important;background:#ccc!important}
thumb,scrollbarbutton{-moz-appearance:none!important;background-color:#fff!important}
scrollbar[orient="vertical"]{min-width:8px!important}
}#contentAreaWrapper::-webkit-scrollbar-track,#phoneNumberOverlay div.phoneDetails::-webkit-scrollbar-track{background-color:#ccc}
#contentAreaWrapper::-webkit-scrollbar-thumb,#phoneNumberOverlay div.phoneDetails::-webkit-scrollbar-thumb{background-color:#fff;border-left:solid 1px #ccc}
#contentAreaWrapper::-webkit-scrollbar-thumb:hover,#phoneNumberOverlay div.phoneDetails::-webkit-scrollbar-thumb:hover{background-color:#fff}
#contentAreaWrapper::-webkit-scrollbar,#phoneNumberOverlay div.phoneDetails::-webkit-scrollbar{width:9px}
#contentAreaWrapper::-webkit-scrollbar-button:vertical,#phoneNumberOverlay div.phoneDetails::-webkit-scrollbar-button:vertical{height:10px;width:6px;background:#ccc}
#answerPane{margin:0;padding:5px}.answerTable{padding:8px;background-color:#fff;-moz-border-radius:4px 4px 4px 4px;-webkit-border-radius:4px 4px 4px 4px;border-radius:4px 4px 4px 4px;border:solid 1px #e1e1e1;margin-bottom:7px;line-height:22px}
.answerTable .answerBody{*padding:0 8px 8px}.answerTable .TRanswerOnMouseout,.answerTable .TRanswerOnMouseover{*padding:8px 8px 0}
A.thumbUp{background-position:3px -243px}A.thumbUpApplied{background-position:3px -265px}
.noActionBarIcon{line-height:30px;padding-left:5px}#resultsHint{color:#b5b5b5}
.answerIcon{width:23px}.answerIcon .likes{float:left;width:100%;text-align:center}
A.translationIcon{float:right}.answerTitle,.answerTitle h3{color:#000;font-size:16px;font-weight:400}
.answerTitle h3{padding-bottom:14px}.answerBody{font-size:14px;color:#666}
.answerBody p{margin-top:0}.noResults{font-size:13px;padding-left:7px;padding-right:7px}
.faqTitle,.faqTitle h2{color:#666;margin-left:8px;font-weight:normal}.faqTitle h2{margin:0}
.answerTable.faq{margin-bottom:4px;padding:9px 0}.answerTable.faq:hover{background-color:#fff}
.nanoRepMP_dislikeIcon{background-position:1px -286px;margin-right:10px;margin-left:0}
.nanoRepMP_dislikeIconCurrent{background-position:1px -310px}.nanoRepMP_dislikeIconOpen{background-color:#fff;border:0;box-shadow:none;-moz-box-shadow:none}
.answerTable.faq .titleText{font-size:15px;color:#444;position:relative;*position:inherit}
.answerTable.faq .titleText h3{line-height:19px}.answerTable.faq .answerTitle>DIV.titleText:before{position:absolute;top:10%;bottom:6%}
.answerTable.faq .titleText:before{width:9px;height:9px;content:'';background:#009fd4 url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 0;margin-top:auto;margin-bottom:auto;margin-left:-22px;border:solid 1px #FFF;background-clip:content-box}
.answerTable.faq .answerTitle.expanded>DIV.titleText:before{background:#009fd4 url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -10px;height:8px;border:solid 1px #FFF;background-clip:content-box}
.answerTable.faq .faqText,.answerTable.faq[dir=ltr] .faqText{clear:none;float:left;margin:0 0 5px 34px}
.answerTable.faq .answerIcon{padding-right:10px;vertical-align:middle}#actionBarWrapper{position:absolute;width:70%;color:#5F6061;background-color:#f0f0f0;border-top:solid 1px #ccc;z-index:1;font-weight:normal}
#emailChatContainer{margin-top:1px;padding-top:4px}.actionBar A,.actionBar A:visited{color:#727070}
.actionBar{padding-top:0;min-width:160px}#actionBarChatSurvey{padding-top:4px}
#chatSurveyCloseButton{border-radius:3px;-moz-border-radius:3px;padding:1px 15px 3px;margin:0;background:#999;color:white;margin-right:15px}
#chatSurveySubmitButton{border-radius:3px;-moz-border-radius:3px;padding:1px 22px 3px 20px;margin:0;background:#1899F9;color:white}
#widgetFooterWrapper{color:#959595}#widgetFooter{height:22px;border-top:solid 1px #ccc;padding-top:8px;background-color:#f0f0f0!important}
#widgetFooter A,#widgetFooter A:visited,#widgetFooter A .link_nano,#widgetFooter A .link_rep{color:#959595}
#footerNanoRepLink{margin-right:0}#footerNanoRepLink i{font-style:normal;font-size:10px}
#footerNanoRepLink .bold{font-weight:normal;font-size:10px}#widgetMinimizedFooter{background-color:#009fd4;-moz-border-radius:0 0 2px 2px;-webkit-border-radius:0 0 2px 2px;border-radius:0 0 2px 2px;height:0;display:none}
.widgetFooterDecoration{height:0}#actionBarText,#actionBarSep,#widgetTitleDecoration,#widgetFooterDecoration,.actionBarSep{display:none!important}
.repByEmail,.repByChat,.customChat,.customLink,.repByVoice{background:0;height:30px;line-height:29px;border-right:solid 1px #ccc;padding:0 12px 0 7px;text-align:left}
.repByEmail:before,.repByChat:before,.customChat:before,.repByVoice:before{content:'';float:left;width:20px;height:15px;background:#009fd4 url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -340px;margin-right:4px;margin-top:6px;border:solid 1px #F0F0F0;background-clip:content-box}
.repByChat,.customChat:before{margin-left:5px}.repByChat:before,.customChat:before{background-position:0 -359px;height:17px;margin-top:5px}
.repByVoice:before{background-position:0 -650px;height:17px;margin-top:5px}
#customerLogo{visibility:hidden}#chatStatusContainer.chatStatusContainerMinimized{min-height:34px;line-height:29px}
#closeChat{color:#5F6061;text-decoration:none}#chatInputWrapper{background-color:#F0F0F0;padding:0;height:46px}
#chatInputContainer{border:solid 1px #D8D6D6;margin:0;padding:0}#txtEmailChat{color:#666;border:1px solid #D8D6D6}
#btnSendChat{background-color:#009fd4;border:0;color:#fff;-moz-border-radius:3px 3px 3px 3px;-webkit-border-radius:3px 3px 3px 3px;border-radius:3px 3px 3px 3px;margin:7px 8px 0 0;padding:0 14px;font-size:15px;line-height:32px;height:32px;-webkit-appearance:none}
#chatSuggestions{border:1px solid #D8D6D6;background:#fff;top:24px;left:0;width:83%}
.chatSuggestionHover{background:#DCE6F4}#chatStatusContainer{background-color:#f6f6f6;border-bottom:solid 1px #e8e8e8;color:#5F6061}
#chatStatusSystem{padding:0 5px}#chatStatusIcon{background:#009fd4 url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat -1px -516px;width:25px;border:solid 1px #F6F6F6;background-clip:content-box;margin-top:9px}
#txtChatInput{margin-top:2px;padding-left:8px}.chatMe{display:none}.chatAgentName{display:none}
#chatPane{width:100%;min-height:42px}#chatPane:after{content:" ";display:block;height:0;clear:both}
.surveyLoading{top:36%}.quickAnswer{float:left;width:100%}#chatPane .padded,.quickAnswer .quickAnswerContainer{background-color:#fff;margin-top:10px;padding:15px;-moz-border-radius:4px 4px 4px 4px;-webkit-border-radius:4px 4px 4px 4px;border-radius:4px 4px 4px 4px;width:75%;border:solid 1px #e8e8e8}
.quickAnswer .quickAnswerContainer{width:auto;margin-top:0}.quickAnswer .quickAnswerContainer TD.quickAnswerExpandIcon{width:16px}
.quickAnswer TABLE{width:100%}#chatPane .padded.agent{float:left}#chatPane .padded.client{float:right}
.quickAnswerHeading{font-style:normal;font-size:12px;color:#9f9f9f;clear:both}
.quickAnswer .quickAnswerTitle,.quickAnswer .quickAnswerBody{color:#222;font-weight:normal;border:0;margin:0}
.quickAnswer .quickAnswerBody{padding:0 0 0 22px}.quickAnswerExpand{background:#009fd4 url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat 0 -10px;height:8px;width:9px;margin-top:4px;border:solid 1px #FFF;background-clip:content-box}
.quickAnswerExpand.quickAnswerCollapsed{background-position:0 0;height:9px}
#chatPane .chatLine{width:100%;clear:both}#chatPane .chatLine:after{clear:both;content:'';height:0;display:block}
#chatPane .clientIcon,#chatPane .agentIcon{margin-top:12px;width:34px;float:right;height:34px;margin-top:9px;background:#009fd4 url(/widget/skins/sprites.png?cv=8d2b6984435acaa) no-repeat -3px -473px;margin-left:9px;display:block;overflow:hidden;border:solid 1px #EEE;background-clip:content-box}
#chatPane .agentIcon{float:left;margin-right:10px;margin-left:0;background-position:-3px -431px;margin-top:10px}
.quickAnswer{color:#2D3F87}.translationTooltip{border:solid 1px #c0c0c0;background-color:#f3f4f8}
#logoInCollapsedMode{position:absolute;top:46px;right:3px;left:auto}#logoInCollapsedMode A{cursor:default;font-weight:normal;font-size:16px;text-decoration:none;font-family:Times New Roman}
#logoInCollapsedMode a.link_nano{color:#5d8292;font-family:Times New Roman}
#logoInCollapsedMode .link_rep{color:#476462;font-family:Times New Roman}
#searchSuggestions{background-color:transparent;border-left:none;border-right:0;position:relative}
.autoCompleteDiv{padding:3px 9px 3px 13px;font-size:13px}#chatPane .padded.mobile{width:70%}
.nanoRepMP_dislikeOptions.mobile{width:250px}#mobileScrollPadding{float:left}
.nanoRepMP_dislikeOptions.mobile table label{font-size:11px}</style><style type="text/css">htmlCustomCSS{"visibility:visible;"}	 div#widgetTitleWrapper, .widgetBGcolor{	 background-color: #5FA503;}	.widgetBGColorAsText{	 color: #5FA503;}	 div#widgetFooterWrapper {	 background-color: #5FA503;}	 div#widgetMinimizedFooter {	 background-color: #5FA503;}	.answerTable.faq .titleText:before, .answerTable.faq .answerTitle.expanded>DIV.titleText:before, .quickAnswerExpand {	 background-color: #5FA503;}	.repByEmail:before, .repByChat:before, .repByVoice:before{	 background-color: #5FA503;}	#widgetContainer{	 border-color: #5FA503;}	#btnSendChat{	 background-color: #5FA503;}	A#closeChat{	 color: #5FA503;}	#chatPane .clientIcon, #chatPane .agentIcon{	 background-color: #5FA503;}	#chatStatusIcon{	 background-color: #5FA503;}	.nanoRepMP_dislikeOptionsBtns .button{	 background-color: #5FA503;}	.nanoRepMP_dislikeOptionsTitle{	 color: #5FA503;}	.nanoRepMP_dislikeOptionsBtns a.buttonLink{	 color: #5FA503;}#repByEmail{display: none; visibility:hidden;}  #chatSurveySubmitButton { background: #5FA503;} a#repByChat {color: black; font-size: 14px; } #repByEmail{display:none;}  #customChat {background:#ffff00; }</style><script async="" defer="defer" id="testing" charset="utf-8" type="text/javascript">ISQ.Widget.Chat=initializeNS("ISQ.Widget.Chat");ISQ.Widget.Chat.Zopim=ISQ.Widget.iChat.extend({name:"ISQ.Widget.Chat.Zopim"});ISQ.Widget.Chat.Zopim.DEFAULT_SERVER="//v2.zopim.com/";ISQ.Widget.Chat.Zopim.Instance;ISQ.Widget.Chat.Zopim.prototype.ctor=function(b){this.mConfig.Zopim.server=ISQ.Widget.Chat.Zopim.DEFAULT_SERVER;var a=this;ISQ.Widget.Chat.Zopim.Instance=this;if(ISQ.Widget.sendingCDCMessages){ISQ.Widget.CDC.sendMessage("subject=loadChat&config="+ISQ.Data.jsonToString(this.mConfig))}else{ISQ.Widget.Proxy.Chat.Zopim.load(this.mConfig,this)}};ISQ.Widget.Chat.Zopim.prototype.dtor=function(){};ISQ.Widget.Chat.Zopim.prototype.handleCDCMessage=function(a){var b;switch(a.type){case"available":if(a.data==="true"){this.mState|=ISQ.Widget.iChat.enumState.available;if(ISQ.Widget.HTML.chatProviderChanged){ISQ.Widget.HTML.showRechannelingChatButton()}}else{this.mState&=~ISQ.Widget.iChat.enumState.available}break}};ISQ.Widget.Chat.Zopim.prototype.onRequestChat=function(){if(ISQ.Widget.sendingCDCMessages){ISQ.Widget.CDC.sendMessage("subject=startCustomChat&config="+ISQ.Data.jsonToString(this.mConfig))}else{$zopim.livechat.window.show()}this.hChatRequested.handle(ISQ.Widget.iChat.enumRequestChatStatus.popup);return false};ISQ.Widget.Chat.Zopim.prototype.mChatInstance=null;ISQ.Widget.Chat.Zopim.prototype.mAgentFilter={};ISQ.Widget.Chat.Zopim.prototype.mResumeRetries=0;</script></head>
<body onload="ISQ.Widget.init()" onunload="" onblur="ISQ.Widget.onBlurHandler()"><div id="ellipsisDiv" style="position: fixed; white-space: nowrap; top: 0px; left: 0px; z-index: -5; visibility: hidden; font-size: 12px; font-weight: 400; font-family: Arial; font-style: normal; text-decoration: underline;" class="">End chat</div>
    <!-- widget container -->
    <div style="display: block;" id="widgetContainer" class="borderBoxSizing" tabindex="1">
        <!-- widget title -->
        <div style="cursor: pointer;" id="widgetTitleWrapper">
            <div id="widgetTitleDecoration"></div>
            <div id="widgetTitleLeft"></div>
            <div><h1 id="widgetTitleText" tabindex="2">Have a Question?</h1></div>
            <div id="widgetTitleRight"></div>
            <div style="display: none;" id="minimizeButtonWrapper" onclick="ISQ.Widget.HTML.minimizeBtnClicked();">
                <div id="minimizeButton">&nbsp;</div>
            </div>
        </div>
        <!-- /widget title -->

        <!-- chat status -->
        <div id="chatStatusWrapper">
            <div id="chatStatusContainer">
                <div id="chatStatusIcon"></div>
                <div id="chatStatus"></div>
                <a id="closeChat" onclick="ISQ.Widget.Chat.endChat();return false;" href="javascript:void(0);">End chat</a> 
                <div id="chatStatusSystem"></div>
            </div>
        </div>
        <!-- /chat status -->

        <!-- search -->
        <div id="searchContainerWrapper">
            <a style="opacity: 0; display: none;" id="clearQuery">×</a>
            <div id="searchContainerLeft"></div>
            <div id="searchContainer"></div>
            <div id="searchTextboxContainer">
                <input arial-lable="Type your question here" class=" initialText" tabindex="3" id="txtSearch" maxlength="250" value="Type your question here" onkeyup="ISQ.Widget.Query.keyUpHandler(event)" onkeypress="ISQ.Widget.Query.keyPressHandler(event)" onfocus="ISQ.Widget.Query.onFocusHandler(event)" onblur="ISQ.Widget.Query.onBlurHandler(event)" onclick="ISQ.Widget.Query.onclickHandler(event, true)" onkeydown="ISQ.Widget.Query.keyDownHandler(event)" onpaste="ISQ.Widget.Query.pasteHandler(event)" type="text">
            <a id="ipadFocusOut" href="javascript:void(0);" style="display:block"></a></div>
            <div id="searchContainerRight"></div>
			

        </div>
        <!-- /search -->

        <div style="font-size: 14px; font-weight: 400; font-family: Arial; font-style: normal; text-decoration: none;" id="searchSuggestions" tabindex="4"></div> <!-- search suggestions -->

        <!-- content area -->
        <div style="height: 17px;" id="contentAreaWrapper" class="empty">
            <div id="contentArea" aria-live="polite">
                <div style="display: none;" id="answerPane"></div>
                <div id="chatPane" class="borderBoxSizing"></div>
                <div id="contactForm"></div>                
            </div>
            <div id="mobileScrollPadding"></div>
        </div>
        <!-- /content area -->

        <!-- chat input -->
        <div id="chatInputWrapper" class="borderBoxSizing">
            <div id="chatInputContainer">
                <textarea id="txtChatInput" rows="2" maxlength="1000"></textarea>
                <input value="Send" id="btnSendChat" onclick="ISQ.Widget.Chat.sendButtonClicked()" type="button">
            </div>
            <div id="chatSuggestions"></div>
        </div>
        <!-- /chat input -->

        <!-- action bar -->
        <div style="display: none;" id="actionBarWrapper">
            <div style="display: none;" id="actionBarContainer">
                <!-- query -->
                <div id="actionBarQuery" class="actionBar">
                    <div class="actionBarText" id="actionBarText"></div>
                    <a class="customLink" id="customLink" href="javascript:void(0)" onclick="return ISQ.Widget.HTML.customLink_onclick();"></a>
                    <a class="noActionBarIcon" id="repByEmail" href="javascript:void(0)" onclick="return ISQ.Widget.Escalate.send(ISQ.Widget.Escalate.enumType.email);"></a>
                    <div class="actionBarSep" id="actionBarSep">|</div>
                    <a class="customChat" id="customChat" href="javascript:void(0)" onclick="return ISQ.Widget.HTML.customChat_onclick();"></a>
                    <a class="repByChat" id="repByChat" onclick="return ISQ.Widget.Chat.requestChat();" href="javascript:void(0);"></a>
                </div>
                <!-- chat -->
                <div id="actionBarChat" class="actionBar">
                    <!--<a href="javascript:void(0);">Print chat</a> 
                        <div class="actionBarSep" id='actionBarSep'>|</div>-->
                    <a id="emailChatLink" class="repByEmail" onclick="ISQ.Widget.Chat.emailChat_Show()" href="javascript:void(0);">Email this chat transcript</a>
                    <div id="emailChatContainer">
                        <input id="txtEmailChat" maxlength="60" onfocus="ISQ.Widget.Chat.emailChat_txtFocus()" onblur="ISQ.Widget.Chat.emailChat_txtBlur()" type="text">
                        <a id="ancEmailChatSend" onclick="ISQ.Widget.Chat.emailChat_Send()" href="javascript:void(0);">Send</a>
                        <a id="ancEmailChatCancel" onclick="ISQ.Widget.Chat.emailChat_Hide()" href="javascript:void(0);">Cancel</a>
                    </div>                    
                </div>
                <!-- chat survey -->
                <div id="actionBarChatSurvey" class="actionBar">
                    <table align="center" cellpadding="0" cellspacing="0">
                    <tbody><tr>
                        <td><a id="chatSurveyCloseButton" onclick="ISQ.Widget.iChat.closeSurvey()" href="javascript:void(0)"></a></td>
                        <td><a id="chatSurveySubmitButton" onclick="ISQ.Widget.iChat.submitSurvey()" href="javascript:void(0)"></a></td>
                    </tr>
                    </tbody></table>
                </div>
            </div>
        </div>
        <!-- /action bar -->
	
        <!-- widget footer -->
        <div style="display: none;" id="widgetFooterWrapper">
            <div class="widgetFooterDecoration"></div>
            <div id="widgetFooter">
                <img src="widget_data/logo.png" id="customerLogo" alt="">
                <div id="customerBrandingText"></div>
                <a class="link_nano_img padding" href="http://www.nanorep.com/?s=poweredBy&amp;aid=etoro&amp;utm_source=etoro.com&amp;utm_medium=widget&amp;utm_content=float" id="footerNanoRepLink" target="_blank"><i>powered by</i><!--[if IE 7]> nanoRep<![endif]--></a>
                <a id="footerChatLink" target="_blank" href="javascript:void(0);">Chat by <span class="normal bold">LivePerson</span></a>
            </div>
        </div>
        <div style="display: block;" id="widgetMinimizedFooter">
            <div class="widgetFooterDecoration"></div>
        </div>
        <!-- /widget footer -->

        <!-- blocker -->
        <div id="widgetBlocker">
            <div id="blockerOverlay"></div>
            <div id="blockerContent"></div>
        </div>
        <!-- /blocker -->

        <!-- overlays -->
        <div id="phoneNumberOverlay" class="overlay">
            <a class="phoneNumber"></a>
            <div class="phoneDetails"></div>
            <div class="buttonWrapper"><a class="button" href="javascript:void(0)" onclick="ISQ.Widget.HTML.hideOverlay(_('phoneNumberOverlay'));">OK</a></div>
        </div>
        <!-- /blocker -->

    </div>
    <!-- widget container -->

    <!-- logo in collapsed mode -->
    <div style="display: none;" id="logoInCollapsedMode"></div>

    <!-- loading div -->
    <div style="display: none;" id="widgetLoading">
    </div>

    <!-- debug popup -->
    <div id="debugPopup">
        <a href="javascript:void(0)" onclick="ISQ.Widget.Log.openPopup()">Open Log</a>
        <a href="javascript:void(0)" onclick="ISQ.Widget.Debug.closeSession()">Close session</a>
    </div>

    <!-- cdc iframe container -->
    <div id="iframeContainer"></div>


</body></html>